# è®¡ç®—æœºåŸºç¡€

å‰è¨€

> è¿™ç¯‡ç¬”è®°æ—¨åœ¨å°†å·¥ä½œä¸­ã€å­¦ä¹ ä¸­é‡åˆ°çš„çŸ¥è¯†ç‚¹éƒ½è¯¦ç»†çš„è®°å½•ä¸‹æ¥ã€‚æ…¢æ…¢å·©å›ºåŸºç¡€ï¼ŒæŒæ¡äº†æ‰å®çš„åŸºç¡€ï¼Œæ‰èƒ½åœ¨å·¥ä½œã€é¢è¯•ä¸­æ¸¸åˆƒæœ‰ä½™ã€‚

[TOC]

## æ“ä½œç³»ç»Ÿ

### è¿›ç¨‹ vs çº¿ç¨‹

ä¸åŒç‚¹ï¼š

ä»èŒƒå›´ä¸Šè®²ï¼Œçº¿ç¨‹æ˜¯æ¯”è¿›ç¨‹æ›´å°æ›´ç»†çš„è¿è¡Œå•ä½ã€‚ä¸€ä¸ªç¨‹åºæœ‰å¤šä¸ªè¿›ç¨‹ï¼Œä¸€ä¸ªè¿›ç¨‹åˆåŒ…å«äº†å¤šä¸ªçº¿ç¨‹ã€‚ä½†æ˜¯çœŸæ­£æ‰§è¡Œä½“è¿˜æ˜¯çº¿ç¨‹ã€‚

ä»é€šä¿¡ä¸Šè®²ï¼Œçº¿ç¨‹ä¹‹é—´å¯ä»¥å…±äº«å†…å­˜ï¼Œç›¸äº’é€šä¿¡ï¼Œè€Œè¿›ç¨‹ä¹‹é—´å†…å­˜ç‹¬ç«‹ã€‚

ä»è¿è¡Œæ—¶çš„å†…å­˜å ç”¨ä¸Šè®²ï¼Œçº¿ç¨‹ä¸ä¼šå ç”¨ç³»ç»Ÿèµ„æºï¼Œæ²¡æœ‰è‡ªå·±ç‹¬ç«‹åœ°å€ç©ºé—´ï¼Œåªéœ€è¦è¿è¡Œå †æ ˆï¼Œæ¥å­˜æ”¾ä¸´æ—¶å˜é‡å’Œç¨‹åºè®¡æ•°å™¨ç­‰ä¿¡æ¯ã€‚è€Œè¿›ç¨‹æ˜¯éœ€è¦åˆ†é…ç‹¬ç«‹å†…å­˜ã€‚



### å­˜å‚¨

#### CPUç¼“å­˜æ¨¡å‹

ç°ä»£CPUä¸ºäº†æé«˜è¿è¡Œé€Ÿåº¦ï¼Œå‡å°‘ä»å†…å­˜ä¸­è¯»å–æ•°æ®çš„æ¬¡æ•°ï¼Œå¤§å¤šè®¾è®¡äº†3å±‚ç¼“å­˜æœºåˆ¶ã€‚æ•´ä½“æ¶æ„å¦‚ä¸‹ï¼š

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-31-221627.png" alt="image-20191101061626611" style="zoom:40%;" />

CPUä¸€èˆ¬éƒ½æ˜¯å¤šæ ¸CPUï¼Œæ¯ä¸€ä¸ªCPUå†…æ ¸é‡Œéƒ½æœ‰ä¸€ä¸ªå¯„å­˜å™¨ï¼Œå¯„å­˜å™¨ä¸»è¦ç”¨æ¥å­˜æ”¾å½“å‰CPUçš„æ“ä½œç¬¦ã€è®¡ç®—ç»“æœç­‰ä¿¡æ¯ã€‚

å¤šä¸ªCPUå†…æ ¸é€šè¿‡æ€»çº¿æ¥ä¼ é€’ã€å…±äº«æ•°æ®ã€‚

#### 3çº§ç¼“å­˜

> https://www.jb51.net/hardware/cpu/610074.html

CPUé«˜é€Ÿç¼“å­˜çš„å‡ºç°ä¸»è¦æ˜¯ä¸ºäº†è§£å†³==CPUè¿ç®—é€Ÿåº¦==ä¸==å†…å­˜è¯»å†™é€Ÿåº¦==ä¸åŒ¹é…çš„çŸ›ç›¾ã€‚å†…å­˜çš„è¯»å–å¤ªæ…¢ï¼Œå¯¼è‡´CPUç»å¸¸éœ€è¦ç­‰å¾…ï¼Œæ— æ³•å‘æŒ¥CPUçš„é«˜é€Ÿæ•ˆæœã€‚

é€šå¸¸CPUéƒ½ä¼šè®¾è®¡3çº§ç¼“å­˜ï¼Œæ¯ä¸ªç¼“å­˜çš„å‘½ä¸­ç‡å¤§æ¦‚åœ¨80%å·¦å³ï¼Œå³80%çš„æ•°æ®å¯ä»¥ä»L1ç¼“å­˜ä¸­è¯»å–ï¼Œ20%çš„æ•°æ®åœ¨L2ç¼“å­˜é‡Œè¯»ï¼Œä¾æ¬¡ç±»æ¨ã€‚

L1çš„ç¼“å­˜å¤§å°ä¼š å°äº L2 å°äº L3ã€‚L1åˆ†2å—åŒºåŸŸï¼šL1iç”¨æ¥ç¼“å­˜æŒ‡ä»¤ï¼ŒL1dç”¨æ¥ç¼“å­˜æ•°æ®ã€‚

L3æ˜¯æ‰€æœ‰CPUå†…æ ¸å…±äº«çš„



#### MESIåè®®

> https://juejin.im/post/5da33288518825646c50f18c

å¤šæ ¸cpuçš„ç¼“å­˜ä¼šå­˜åœ¨ç¼“å­˜ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œæƒ³è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæœ€å¥½çš„æ–¹æ³•å°±æ˜¯åŠ é”ï¼Œä¿è¯æ¯æ¬¡åªæœ‰ä¸€ä¸ªcpuçš„ç¼“å­˜åœ¨è¢«è¯»å–ã€‚

æ—©æœŸçš„åŠ é”ç­–ç•¥æ˜¯æŠŠæ•´ä¸ªå†…å­˜æ€»çº¿é”å®šäº†èµ·æ¥ï¼Œè¿™æ ·é”å®šæœŸé—´ï¼Œæ‰€æœ‰å…¶ä»–çš„CPUæ— æ³•å»ä¿®æ”¹å†…å­˜ä¸­çš„åœ°å€ï¼Œä½†æ˜¯é€ æˆçš„é—®é¢˜å°±æ˜¯æ€§èƒ½å¾ˆæ…¢ã€‚

ç°åœ¨çš„æ–¹æ¡ˆéƒ½æ˜¯é€šè¿‡MESIåè®®æ¥è§£å†³ã€‚

MESIåè®®æ•´ä½“æ¶æ„å¦‚ä¸‹ï¼š

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-31-225407.png" alt="image-20191101065406793" style="zoom:40%;" />



MESIå®šä¹‰äº†**ç¼“å­˜è¡Œ**çš„4ç§ç¼“å­˜çŠ¶æ€ï¼š

> ç¼“å­˜è¡Œï¼šç¼“å­˜çš„åŸºæœ¬æ•°æ®å•ä½ï¼Œåœ¨Intelçš„CPUä¸Šä¸€èˆ¬æ˜¯64å­—èŠ‚

| çŠ¶æ€           | æè¿°                                    |
| -------------- | --------------------------------------- |
| Mï¼ˆModifiedï¼‰  | å½“å‰ç¼“å­˜æœ‰æ•ˆï¼Œä¸”å€¼è¢«ä¿®æ”¹äº†              |
| Eï¼ˆExculsiveï¼‰ | å½“å‰ç¼“å­˜æœ‰æ•ˆï¼Œåªå­˜åœ¨å½“å‰CPUå†…æ ¸çš„ç¼“å­˜é‡Œ |
| Sï¼ˆSharedï¼‰    | å½“å‰ç¼“å­˜æœ‰æ•ˆï¼Œå­˜åœ¨äºå¤šä¸ªCPUçš„ç¼“å­˜ä¸­     |
| Iï¼ˆInvalidï¼‰   | å½“å‰å­˜å‚¨æ— æ•ˆ                            |

**è¯»å–è§„åˆ™**ï¼š

æ¯ä¸ªCPUä¸Šé¢éƒ½ç»´æŠ¤äº†æŸä¸€ä¸ªæ•°æ®çš„ç¼“å­˜çŠ¶æ€ã€‚

å¤„äºMçŠ¶æ€çš„ç¼“å­˜è¡Œï¼Œå¿…é¡»åœ¨å…¶ä»–CPUè¯»å– è¯¥ç¼“å­˜è¡Œå¯¹åº”çš„å†…å­˜åœ°å€ä¹‹å‰ï¼Œå°†ä¿®æ”¹çš„å€¼å†™å›ç¼“å­˜ã€‚

å¤„äºSçŠ¶æ€çš„ç¼“å­˜è¡Œï¼Œå¿…é¡»ç›‘å¬ç€è®©è¯¥ç¼“å­˜è¡Œæ— æ•ˆ æˆ– ç‹¬äº«è¯¥ç¼“å­˜è¡Œ çš„è¯·æ±‚ï¼Œå¦‚æœç›‘å¬åˆ°ä»¥åï¼ŒæŠŠç¼“å­˜è¡ŒçŠ¶æ€è®¾ç½®ä¸ºIã€‚

å¤„äºEçŠ¶æ€çš„ç¼“å­˜è¡Œï¼Œå¦‚æœç›‘å¬åˆ°å…¶ä»–è¯»å–è¯¥ç¼“å­˜è¡Œå¯¹åº”çš„å†…å­˜åœ°å€çš„æ“ä½œï¼Œéœ€è¦æŠŠè¯¥ç¼“å­˜è¡ŒçŠ¶æ€è®¾ç½®ä¸ºSã€‚

å¦‚æœç¼“å­˜è¡Œçš„ç¼“å­˜çŠ¶æ€æ˜¯Iï¼Œéœ€è¦å­˜å†…å­˜ä¸­é‡æ–°è¯»å–ï¼Œç„¶åæŠŠçŠ¶æ€æ”¹ä¸ºSã€‚



 **çŠ¶æ€æœº**

MESIåè®®å®é™…ä¸Šæ˜¯ä¸€ç§æœ‰é™çŠ¶æ€æœºï¼Œç¼“å­˜çŠ¶æ€ä¼šæ ¹æ®äº‹ä»¶è¿›è¡Œç›¸åº”çŠ¶æ€çš„æ”¹å˜ã€‚äº‹ä»¶åˆ†æˆ2ç±»ï¼Œ

`cpuå¯¹cacheçš„è¯·æ±‚äº‹ä»¶`ï¼Œ`æ€»çº¿å¯¹cacheè¯·æ±‚äº‹ä»¶`ã€‚æ‰€æœ‰çš„äº‹ä»¶éƒ½è¢«`æ€»çº¿å—…æ¢å™¨`ç›‘å¬ã€‚

cpuå¯¹cacheçš„è¯·æ±‚äº‹ä»¶ï¼š

1. PrRd: å¤„ç†å™¨è¯·æ±‚**è¯»**ä¸€ä¸ªç¼“å­˜å—
2. PrWr: å¤„ç†å™¨è¯·æ±‚**å†™**ä¸€ä¸ªç¼“å­˜å—

æ€»çº¿å¯¹cacheçš„è¯·æ±‚äº‹ä»¶:

1. BusRdï¼šæ¢å™¨ç›‘å¬åˆ° è¿™å—ç¼“å­˜å—è¢«å…¶ä»–cpuè¯»äº†
2. BusRdXï¼šå—…æ¢å™¨ç›‘å¬åˆ° è¯¥ç¼“å­˜å—è¢«åˆ«çš„cpuæ”¹äº†
3. Flushï¼šå—…æ¢å™¨é€šçŸ¥ å›å†™æ•´ä¸ªç¼“å­˜åˆ°ä¸»å†…å­˜

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-01-144011.png" alt="image-20191101224011364" style="zoom:50%;" />



### å¯»å€ç©ºé—´

> [è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜çš„è”ç³»ä¸åŒºåˆ«](https://blog.csdn.net/lvyibin890/article/details/82217193)

ğŸ‘†è¿™ç¯‡æ–‡ç« å¾ˆå¥½çš„è§£é‡Šäº†è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜çš„å…³ç³»ï¼›



å¯»å€æ­¥éª¤ï¼š

<img src="/Users/keyang/Library/Application Support/typora-user-images/image-20191221214204303.png" alt="image-20191221214204303" style="zoom:30%;" />

è¿™é‡Œçš„é€»è¾‘å†…å­˜æŒ‡çš„æ˜¯è™šæ‹Ÿåœ°å€!!!;ç¨‹åºæ—¶ä½¿ç”¨çš„åœ°å€ç§°ä¸º**è™šæ‹Ÿåœ°å€æˆ–é€»è¾‘åœ°å€**ï¼›

è€Œè®¡ç®—æœºç‰©ç†å†…å­˜çš„è®¿é—®åœ°å€åˆ™ç§°ä¸º**å®åœ°å€æˆ–ç‰©ç†åœ°å€**ï¼›



å‡è®¾ä¸€æ®µç¨‹åºä¸ºï¼š`int n = *p; ` ç¼–è¯‘ä¸ºæ±‡ç¼–æŒ‡ä»¤åä¸ºï¼š`mov eax,[ebx] `ã€‚å°†ebxåœ°å€é‡Œçš„æ•°æ®è¯»å–å‡ºæ¥ï¼Œæ”¾åˆ°eaxè¿™ä¸ªå¯„å­˜å™¨é‡Œã€‚

è®¡ç®—æœºå¯»å€å°±æ˜¯å»é€»è¾‘å†…å­˜ï¼ˆ**è™šæ‹Ÿåœ°å€**ï¼‰é‡Œé¢å¯»æ‰¾**ebx**è¿™ä¸ªåœ°å€çš„å€¼ã€‚

æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½åˆ†é…æœ‰ä¸€ä¸ªå›ºå®šå¤§å°çš„**è™šæ‹Ÿåœ°å€**ï¼Œè¿™ä¸ªå¤§å°å’Œæ“ä½œç³»ç»Ÿæœ‰å…³ï¼Œæ¯”å¦‚4gã€‚ä½†æ˜¯è¿™ä¸ªå¤§å°å¯¹åº”çš„ç‰©ç†å†…å­˜å¯èƒ½å¾ˆå°ã€‚

CPUåœ¨æ‰§è¡ŒæŒ‡ä»¤æ—¶éœ€è¦å…ˆå°†æŒ‡ä»¤çš„é€»è¾‘åœ°å€å˜æ¢ä¸ºç‰©ç†åœ°å€ï¼Œæ‰èƒ½å¯¹ç›¸åº”çš„å­˜å‚¨å•å…ƒè¿›è¡Œæ•°æ®çš„è¯»å–æˆ–è€…å†™å…¥ã€‚

ä½†é€»è¾‘åœ°å€çš„å€¼å¹¶ä¸ä¸€å®šä¼šå’Œç‰©ç†å†…å­˜ä¸€ä¸€å¯¹åº”ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒå¯èƒ½ä¸å­˜åœ¨ç‰©ç†å†…å­˜é‡Œã€‚

å¦‚æœä¸å­˜åœ¨ç‰©ç†å†…å­˜ä¸Šï¼Œå°±ä¼šé€šè¿‡åˆ†é¡µï¼Œå’Œåšäº¤æ¢å¤„ç†ã€‚ ï¼ˆ==è¿™ä¸€å—çš„åŸç†è¿˜ä¸æ˜¯å¾ˆç†è§£==ï¼‰

![img](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-12-21-144509.jpg)













## è®¡ç®—æœºç½‘ç»œ

ç½‘ç»œ7å±‚æ¶æ„çš„ç”±æ¥

### TCPåè®® - æ»‘åŠ¨çª—å£æ–¹æ¡ˆ

> è§£å†³çš„é—®é¢˜

å› ä¸ºç½‘ç»œä¼ è¾“çš„æ˜¯ä¸å¯é çš„ï¼Œä¸ºäº†é¿å…ä¸¢åŒ…ï¼Œå‘é€æ–¹å’Œæ¥æ”¶æ–¹å‘é€çš„æ•°æ®éœ€è¦è¿›è¡Œç›¸äº’ç¡®è®¤çš„ï¼›

ä½†å¦‚æœæ¯æ¬¡å‘é€ä¸€ä¸ªåŒ…ï¼Œå°±å¾—ç­‰å¾…ç¡®è®¤å†å‘ä¸‹ä¸€ä¸ªåŒ…ï¼Œå°±ä¼šå‡ºç°æ•ˆç‡å¾ˆä½ã€ååé‡å¾ˆå°çš„é—®é¢˜ã€‚

æ‰€ä»¥éœ€è¦å¹¶è¡Œå‘é€ï¼Œç”±æ­¤å¼•å…¥äº†æ»‘åŠ¨çª—å£çš„æ¦‚å¿µã€‚



> æ»‘åŠ¨çª—å£åŸºæœ¬æ¦‚å¿µ

å‘é€æ–¹å’Œæ¥æ”¶æ–¹å„è‡ªç»´æŠ¤äº†è‡ªå·±çš„ç¼“å†²åŒºã€‚

åŒå‘ç¡®å®šäº†`å‘é€`å’Œ`æ¥æ”¶ack`çš„åè®®ï¼›

åŒå‘ç¡®å®šäº†åŒæ—¶å‘é€çš„æœ€å¤§æ•°é‡ï¼›

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-12-22-052227.png" alt="image-20191222132226882" style="zoom: 33%;" />

â¬†ï¸å›¾æ‰€ç¤ºï¼Œçª—å£é‡Œå§‹ç»ˆåªæœ‰7ä¸ªåŒ…çš„å¤§å°ã€‚åªæœ‰æ•°æ®åŒ…ç»è¿‡å‘é€ç¡®è®¤åï¼Œçª—å£æ‰å¯ä»¥æ»‘åŠ¨åˆ°ä¸‹ä¸€ä½ã€‚



> ä¸¢åŒ…çš„è§£å†³åŠæ³•



<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-12-22-044751.png" alt="image-20191222124749673" style="zoom:33%;" />





## JVM

> https://www.processon.com/view/5c749debe4b0f9fba6921d15?fromnew=1

### JDKã€JREã€JVMçš„åŒºåˆ«

JDKåŒ…å«JREï¼ŒJREåŒ…å«JVMã€‚

JDKæ˜¯Javaå¼€å‘çš„å·¥å…·åŒ…ï¼ˆJava Develop Kitï¼‰

JREæä¾›äº†Javaè¿è¡Œçš„ç¯å¢ƒï¼ˆJava Runtime Enviorment)

JVMåˆ™æ˜¯ä¸€å°è™šæ‹Ÿæœºï¼Œä»–ä»è½¯ä»¶çš„å±‚é¢ä¸Šï¼Œåœ¨è™šæ‹Ÿæœºå†…éƒ¨å¸®æˆ‘ä»¬æŠŠJDKç¼–è¯‘å‡ºæ¥çš„classæ–‡ä»¶ï¼Œè½¬æ¢ä¸ºå¯ä»¥è¢«å½“å‰æ“ä½œç³»ç»Ÿè¯†åˆ«çš„æœºå™¨ç ã€‚æ¢å¥è¯è¯´ï¼Œä»–å†…éƒ¨å¸®åŠ©æˆ‘ä»¬å±è”½äº†ä¸€äº›æ“ä½œç³»ç»Ÿå±‚é¢ä¸Šçš„åŒºåˆ«ï¼Œè®©æˆ‘ä»¬çš„ç¨‹åºèƒ½å¤Ÿ**è·¨å¹³å°è¿è¡Œ**ã€‚

JVMåŒ…å«äº†3ä¸ªéƒ¨åˆ†ï¼šç±»åŠ è½½å™¨å­ç³»ç»Ÿã€è¿è¡Œæ—¶æ•°æ®åŒºã€æ‰§è¡Œå¼•æ“ã€‚

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-26-071216.png" alt="image-20191026151216502" style="zoom:50%;" />

### JVMå†…å­˜åŒºåŸŸ

è¿è¡Œæ—¶æ•°æ®åŒºæ˜¯JVMçš„æ ¸å¿ƒï¼Œæ•´ä½“çš„ç»“æ„å¦‚ä¸‹ï¼š

![image-20191106180725123](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-06-100726.png)

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-26-042632.png" alt="image-20191026122631783" style="zoom:50%;" />

**Javaæ ˆ**ï¼ˆè™šæ‹Ÿæœºæ ˆï¼‰ï¼šJavaä¼šç»™æ¯ä¸€ä¸ªè¿è¡Œçš„çº¿ç¨‹åˆ†é…ä¸€ä¸ªæ ˆï¼Œè¿™ä¸ªæ ˆæ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚

â€‹	**æ ˆé’ˆ**ï¼šåœ¨æ ˆé‡Œé¢ï¼Œå­˜æ”¾æœ‰å¾ˆå¤šæ ˆå¸§ï¼Œæ¯ä¸ªæ–¹æ³•è¿è¡Œæ—¶éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ ˆå¸§å…¥æ ˆï¼Œä¿è¯æ¯ä¸ªæ–¹æ³•æœ‰è‡ªå·±ç‹¬ç«‹çš„ä½œç”¨åŸŸï¼›æ ˆå¸§é‡Œå¯ä»¥å­˜å‚¨äº†javaæ–¹æ³•è¿è¡Œæ—¶çš„ç›¸å…³ä¿¡æ¯ï¼ˆå±€éƒ¨å˜é‡è¡¨ï¼Œæ“ä½œæ•°æ ˆï¼ŒåŠ¨æ€é“¾æ¥ï¼Œæ–¹æ³•å‡ºå£ç­‰ï¼‰

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-26-063421.png" alt="image-20191026143421183" style="zoom:50%;" />



â€‹	**å±€éƒ¨å˜é‡è¡¨**ï¼šä¿å­˜æ–¹æ³•å†…éƒ¨çš„ä¸´æ—¶å˜é‡ï¼Œæ¯”å¦‚ï¼ša=1;b=2;c=new Math()`ç­‰

â€‹	**æ“ä½œæ•°æ ˆ**ï¼šjvmæ‰§è¡Œå¼•æ“ä¼šç”¨åˆ°ï¼Œå­˜æ”¾ä¸€äº›æ“ä½œç¬¦è¿ç®—ï¼›

**æœ¬åœ°æ–¹æ³•æ ˆ**ï¼šå’ŒJavaæ ˆçš„æ¦‚å¿µç±»ä¼¼ï¼Œä¹Ÿæ˜¯æ¯ä¸ªçº¿ç¨‹ç§æœ‰ã€‚ä½†æ˜¯å®ƒé‡Œé¢å­˜æ”¾çš„éƒ½æ˜¯ä¸€äº›nativeçš„æ–¹æ³•ä¿¡æ¯ã€‚

**ç¨‹åºè®¡æ•°å™¨ï¼š**ä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰ï¼Œä½œç”¨ä¸»è¦æ˜¯ä¸ºäº†è®°å½•å½“å‰çº¿ç¨‹è¿è¡Œåˆ°å“ªä¸€è¡Œä»£ç ã€‚å› ä¸ºæ¯ä¸ªçº¿ç¨‹çš„æ‰§è¡Œéƒ½ä¾èµ–äºCPUçš„è°ƒåº¦ï¼Œæ˜¯éœ€è¦æŠ¢å CPUèµ„æºçš„ï¼Œæ‰€ä»¥çº¿ç¨‹ç»å¸¸ä¼šå› ä¸ºå¤±å»CPUèµ„æºè€Œè¢«æŒ‚èµ·ã€‚å½“çº¿ç¨‹é‡å¯è·å–åˆ°è¿è¡Œèµ„æºæ—¶ï¼Œå°±è¦æ ¹æ®ç¨‹åºè®¡æ•°å™¨æ¥ç»§ç»­æ‰§è¡Œã€‚

**æ–¹æ³•åŒº**ï¼šæ–¹æ³•åŒºé‡Œå­˜æ”¾çš„æ˜¯ç±»å…ƒä¿¡æ¯ã€é™æ€å˜é‡ã€å¸¸é‡ç­‰ã€‚

â€‹	é™æ€å˜é‡

â€‹	å¸¸é‡ï¼š static finalçš„

â€‹	ç±»å…ƒä¿¡æ¯ï¼šä¸€ä¸ªç±»çš„ç»„æˆä¿¡æ¯ã€‚ï¼ˆç±»åã€ç±»ä¿®é¥°ç¬¦ã€æ–¹æ³•åç­‰ï¼‰

**å †**: å †å†…å­˜æ˜¯çº¿ç¨‹å…±äº«çš„ï¼Œç”¨æ¥å­˜æ”¾javaè¿è¡Œæ—¶åˆ›å»ºå‡ºæ¥çš„å¯¹è±¡ï¼Œå¯¹è±¡çš„â€œå†…å­˜åœ°å€â€å­˜æ”¾åœ¨æ ˆå±€éƒ¨å˜é‡è¡¨é‡Œé¢ã€‚

â€‹	å †å†…å­˜ç»“æ„åŒ…æ‹¬ï¼šæ–°ç”Ÿä»£ã€formã€toã€æ°¸ä¹…ä»£ï¼›

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-26-084454.png" alt="image-20191026164453593" style="zoom:60%;" />





å †æº¢å‡º

æ ˆæº¢å‡º

å†…å­˜æº¢å‡ºä¸å†…å­˜æ³„éœ²çš„åŒºåˆ«



### GCåƒåœ¾å›æ”¶æœºåˆ¶

Javaåƒåœ¾å›æ”¶åˆ†ä¸ºminorå›æ”¶å’Œmajorå›æ”¶ï¼Œä¸¤ç§å›æ”¶çš„æœºåˆ¶ä¸åŒï¼Œå›æ”¶çš„å¯¹è±¡ä¸»ä½“åœ¨å †å†…å­˜æ¨¡å‹ä¸­ä¹Ÿä¸ä¸€æ ·ã€‚

ğŸ‘†Javaå †å†…å­˜æ¨¡å‹åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼š

æ–°ç”Ÿä»£å¤§æ¦‚å å †å†…å­˜çš„1/3ï¼Œè€å¹´ä»£å å†…å­˜çš„2/3ã€‚

**æ–°ç”Ÿä»£**ï¼š

ç”±Edenå’ŒSurvior Spaceç»„æˆã€‚åˆå§‹å¤§å°ç”±-Xmnå‚æ•°è®¾å®šã€‚

å·¥ä½œæœºåˆ¶ï¼š

EdenåŒºå¤§çº¦å æ–°ç”Ÿä»£å†…å­˜ç©ºé—´çš„8/10ï¼Œjava newå‡ºæ¥çš„å¯¹è±¡éƒ½ä¼šå…ˆæ”¾å…¥åˆ°EdenåŒºï¼›å½“Edenå†…å­˜ä¸å¤Ÿæ—¶ï¼Œjvmä¼šå¯åŠ¨ä¸€æ¬¡minor gcã€‚Minor GCä¼šæŠŠé‚£äº›å†…å­˜ä¸­ä¸å†æœ‰å¼•ç”¨çš„å¯¹è±¡éƒ½å›æ”¶ï¼ˆå›æ”¶ç®—æ³•ä¸‹é¢ä¼šè®²åˆ°ï¼‰ï¼Œè€Œé‚£äº›æœ‰ç”¨çš„å¯¹è±¡ä¼šè¢«å…¨éƒ¨ç§»åŠ¨åˆ°`S0 Space`ã€‚ç¬¬äºŒæ¬¡gcçš„æ—¶å€™ï¼Œä¼šæŠŠEdenåŒºå’ŒS0 Spaceé‡Œå­˜æ´»çš„å¯¹è±¡ä¸€èµ·ç§»åŠ¨åˆ°S1 Spaceã€‚

å¯¹è±¡åœ¨s0 spaceå’Œs1 spaceæ¥å›ç§»åŠ¨ï¼Œæ¯æ¬¡è½¬ç§»æ—¶ï¼Œè¿™äº›å¯¹è±¡éƒ½ä¼šæ›´æ–°gcçš„å¹´é¾„æ ‡å¿—ã€‚å½“gcå¹´é¾„è¾¾åˆ°15æ—¶ï¼Œä¼šå°†è¯¥å¯¹è±¡ç§»åŠ¨åˆ°è€å¹´ä»£ã€‚

å¦‚æœs0å’Œs1çš„å†…å­˜åŒºåŸŸæ”¾ä¸ä¸‹å­˜æ´»çš„å¯¹è±¡æ—¶ï¼Œä¼šå»è€å¹´ä»£å†…å­˜ä¸­å€Ÿç”¨å†…å­˜ï¼Œç­‰ä¸‹ä¸€æ¬¡gcåå†è¿˜ç»™è€å¹´ä»£ã€‚è€Œè€å¹´ä»£ä¹Ÿä¼šä¸ºäº†ç¡®ä¿minor gcæ“ä½œèƒ½å®Œæˆï¼Œé¢„ç•™äº†ä¸€éƒ¨åˆ†å†…å­˜ä½œä¸ºä¿ç•™åŒºåŸŸã€‚è¿™ç§è¡Œä¸ºæˆä¸ºï¼š`æ–°ç”Ÿä»£æœé›†æ‹…ä¿`ã€‚å¦‚æœé¢„ç•™æ“ä½œæ— æ³•å®Œæˆï¼Œä¹Ÿä¼šè§¦å‘Major GCã€‚

**è€å¹´ä»£**ï¼š

è€å¹´ä»£åŒºåŸŸä¸­çš„å¯¹è±¡å­˜æ´»ç‡å¾ˆé«˜ï¼Œä¸€èˆ¬å›æ”¶çš„å‘¨æœŸå¾ˆé•¿ã€‚

Major GCå› ä¸ºè¦å¯¹æ‰€æœ‰çš„å¯¹è±¡è¿›è¡Œå›æ”¶ï¼Œå¾ˆæ¶ˆè€—æ—¶é—´ï¼Œæ‰€ä»¥è¦å°½é‡é¿å…Major GCã€‚jvmè°ƒä¼˜çš„è¿‡ç¨‹ä¸­ï¼Œå¾ˆå¤§ä¸€éƒ¨åˆ†å·¥ä½œå°±æ˜¯å‡å°‘Full GCçš„æ¬¡æ•°ã€‚



### GCå›æ”¶åˆ¤æ–­

#### ~~å¼•ç”¨è®¡æ•°æ³•~~

#### å¯è¾¾æ€§åˆ†æ

#### GC Rootsæ ¹

javaçš„åƒåœ¾å›æ”¶æœºåˆ¶ä¸­ï¼Œåˆ¤æ–­1ä¸ªå¯¹è±¡æ˜¯å¦å¯è¢«å›æ”¶ï¼Œå¹¶ä¸æ˜¯çœ‹æœ‰æ²¡æœ‰å¯¹è±¡å¯¹å…¶å¼•ç”¨ï¼Œè€Œæ˜¯é€šè¿‡`å¯è¾¾æ€§åˆ†æ`ï¼Œçœ‹è¿™ä¸ªå¯¹è±¡æœ‰æ²¡æœ‰åˆ°GC Rootçš„å¼•ç”¨é“¾ç›¸è¿ã€‚

æ€ä¹ˆç†è§£è¿™æ®µè¯ï¼Ÿå°±æ˜¯è¯´ï¼Œä»GC Rootsæ ¹å‘ä¸‹æ‰¾ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½æ‰¾åˆ°ä¸€æ¡è·¯ï¼Œè¾¾åˆ°è¿™ä¸ªå¯¹è±¡ã€‚å¦‚æœæ‰¾åˆ°äº†ï¼Œè¯´æ˜æ˜¯æœ‰å¼•ç”¨é“¾ç›¸è¿çš„ã€‚

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-26-132038.png" alt="Ã¨Â¿Ã©Ã¥Ã¥Â¾Ã§Ã¦Ã¨Â¿Â°" style="zoom:50%;" />

å¯ä»¥ä½œä¸ºGC Rootsæ ¹çš„å¯¹è±¡ï¼š

- è™šæ‹Ÿæœºæ ˆï¼ˆæ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡è¡¨ï¼‰ä¸­å¼•ç”¨çš„å¯¹è±¡ï¼›ä»»æ„æ–¹æ³•é‡ŒC c = new C();
- æ–¹æ³•åŒºä¸­é™æ€å˜é‡å¼•ç”¨çš„å¯¹è±¡ï¼›static B b = new B();
- æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡ï¼› static final A a = new A();
- Nativeæ–¹æ³•å¼•ç”¨çš„å¯¹è±¡ï¼›



#### å¼•ç”¨å…³ç³»

> https://blog.csdn.net/luzhensmart/article/details/81431212

â‘´å¼ºå¼•ç”¨ï¼ˆStrongReferenceï¼‰

```
A a = new A()
```

å¼ºå¼•ç”¨æ˜¯ä½¿ç”¨æœ€æ™®éçš„å¼•ç”¨ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡å…·æœ‰å¼ºå¼•ç”¨ï¼Œé‚£åƒåœ¾å›æ”¶å™¨ç»ä¸ä¼šå›æ”¶å®ƒã€‚å½“å†…å­˜ç©ºé—´ä¸è¶³ï¼ŒJavaè™šæ‹Ÿæœºå®æ„¿æŠ›å‡ºOutOfMemoryErroré”™è¯¯ï¼Œä½¿ç¨‹åºå¼‚å¸¸ç»ˆæ­¢ï¼Œä¹Ÿä¸ä¼šé éšæ„å›æ”¶å…·æœ‰å¼ºå¼•ç”¨çš„å¯¹è±¡æ¥è§£å†³å†…å­˜ä¸è¶³çš„é—®é¢˜ã€‚

â‘µè½¯å¼•ç”¨ï¼ˆSoftReferenceï¼‰

```java
SoftReference<String> sr = new SoftReference<String>(new String("hello"));
```

å¦‚æœä¸€ä¸ªå¯¹è±¡åªå…·æœ‰è½¯å¼•ç”¨ï¼Œåˆ™å†…å­˜ç©ºé—´è¶³å¤Ÿï¼Œåƒåœ¾å›æ”¶å™¨å°±ä¸ä¼šå›æ”¶å®ƒï¼›å¦‚æœå†…å­˜ç©ºé—´ä¸è¶³äº†ï¼Œå°±ä¼šå›æ”¶è¿™äº›å¯¹è±¡çš„å†…å­˜ã€‚åªè¦åƒåœ¾å›æ”¶å™¨æ²¡æœ‰å›æ”¶å®ƒï¼Œè¯¥å¯¹è±¡å°±å¯ä»¥è¢«ç¨‹åºä½¿ç”¨ã€‚

åº”ç”¨åœºæ™¯ï¼šè½¯å¼•ç”¨å¯ç”¨æ¥æ­é…ç¼“å­˜æ¥åšï¼ŒåŒæ—¶é¿å…å†…å­˜æº¢å‡ºã€‚

â‘¶å¼±å¼•ç”¨ï¼ˆWeakReferenceï¼‰

```java
WeakReference<String> sr = new WeakReference<String>(new String("hello"));
```

å¼±å¼•ç”¨ä¸è½¯å¼•ç”¨çš„åŒºåˆ«åœ¨äºï¼šåªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡æ‹¥æœ‰æ›´çŸ­æš‚çš„ç”Ÿå‘½å‘¨æœŸã€‚åœ¨åƒåœ¾å›æ”¶å™¨çº¿ç¨‹æ‰«æå®ƒæ‰€ç®¡è¾–çš„å†…å­˜åŒºåŸŸçš„è¿‡ç¨‹ä¸­ï¼Œä¸€æ—¦å‘ç°äº†åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ï¼Œä¸ç®¡å½“å‰å†…å­˜ç©ºé—´è¶³å¤Ÿä¸å¦ï¼Œéƒ½ä¼šå›æ”¶å®ƒçš„å†…å­˜ã€‚ä¸è¿‡ï¼Œç”±äºåƒåœ¾å›æ”¶å™¨æ˜¯ä¸€ä¸ªä¼˜å…ˆçº§å¾ˆä½çš„çº¿ç¨‹ï¼Œå› æ­¤ä¸ä¸€å®šä¼šå¾ˆå¿«å‘ç°é‚£äº›åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ã€‚


#### finalizeæŠ¢æ•‘

![img](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-26-132358.png)

#### GC logåˆ†æ

å…è´¹çš„GCæ—¥å¿—å›¾å½¢åˆ†æå·¥å…·æ¨èä¸‹é¢2ä¸ªï¼š

- [GCViewer](https://juejin.im/post/[https://github.com/chewiebug/GCViewer](https://github.com/chewiebug/GCViewer))ï¼Œä¸‹è½½jaråŒ…ç›´æ¥è¿è¡Œ
- [gceasy](https://gceasy.io/)ï¼Œwebå·¥å…·ï¼Œä¸Šä¼ GCæ—¥å¿—åœ¨çº¿ä½¿ç”¨



## JMMâ€”â€”Javaå†…å­˜æ¨¡å‹



### JMMæ¶æ„è§„èŒƒ

JMMæ˜¯ä¸€ç§æ¶æ„ï¼Œä¹Ÿæ˜¯ä¸€å¥—è§„èŒƒã€‚å®ƒå±è”½äº†ä¸åŒCPUå†…æ ¸çš„æ¶æ„é—®é¢˜ï¼Œé€šè¿‡å®ç°MESIåè®®ï¼Œè§£å†³äº†ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ï¼ŒåŒæ—¶ä¹Ÿè§£å†³äº†å¤šå¹¶å‘ç¼–ç¨‹çš„å¯è§æ€§é—®é¢˜ã€‚

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-31-225946.png" alt="image-20191101065946596" style="zoom:45%;" />



ä»ä¸Šå›¾é‡Œå¯ä»¥çœ‹åˆ°ï¼Œå¤šçº¿ç¨‹è¯»å†™ä¸»å†…å­˜å˜é‡ç»è¿‡äº†ä¸€ç³»åˆ—æ“ä½œã€‚è¿™äº›æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ï¼Œæ˜¯JMMå°è£…çš„åŸå­æ€§æŒ‡ä»¤ï¼Œä¸»è¦å°±æ˜¯ç”¨æ¥è§£å†³å†…å­˜åŒæ­¥ã€‚

**è¯»æ“ä½œ**

readæ“ä½œï¼šä»ä¸»å†…å­˜ä¸­è¯»å–å˜é‡

loadæ“ä½œï¼šå°†è¯»å–çš„å€¼å¤åˆ¶å¹¶åŠ è½½åˆ°ç¼“å­˜ä¸­

useï¼šçº¿ç¨‹ä½¿ç”¨ç¼“å­˜ä¸­çš„å˜é‡ï¼›



**å†™æ“ä½œ**

assignï¼šä¿®æ”¹ç¼“å­˜ä¸­å˜é‡

storeï¼šå°†ä¿®æ”¹çš„å€¼ä¿å­˜åˆ°ç¼“å­˜ä¸­ï¼›

writeï¼šå°†ç¼“å­˜é‡Œé¢ä¿®æ”¹è¿‡çš„å€¼å†™å›ä¸»å†…å­˜é‡Œï¼›



**lockå’Œunlockæ“ä½œ**

lockï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼Œä½œç”¨æ˜¯æŠŠä¸€ä¸ªå…±äº«å˜é‡æ ‡è¯†ä¸ºä¸€ä¸ªçº¿ç¨‹ç‹¬å çŠ¶æ€ã€‚

unlockï¼šä½œç”¨äºä¸»å†…å­˜å˜é‡ï¼Œä½œç”¨æ˜¯æŠŠä¸€ä¸ªå¤„äºé”å®šçŠ¶æ€çš„å˜é‡é‡Šæ”¾ï¼Œç„¶åå¯ä»¥è¢«å…¶ä»–çº¿ç¨‹é”å®š

JMMä¸­é”çš„éƒ½æ˜¯ç¼“å­˜è¡Œã€‚



volatileå…³é”®åº•å±‚çš„åŸç†å°±æ˜¯é€šè¿‡ä¸Šé¢çš„æŒ‡ä»¤æ¥é€šçŸ¥çº¿ç¨‹æ›´æ–°ç¼“å­˜ã€‚



### å¹¶å‘çš„ä¸‰å¤§ç‰¹æ€§â€”â€”åŸå­æ€§ã€å¯è§æ€§ã€ä¸€è‡´æ€§



#### æœ‰åºæ€§

åœ¨Javaå†…å­˜æ¨¡å‹ä¸­ï¼Œå…è®¸ç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¯¹æŒ‡ä»¤è¿›è¡Œ**é‡æ’åº**ï¼Œä½†æ˜¯é‡æ’åºè¿‡ç¨‹ä¸ä¼šå½±å“åˆ°å•çº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œï¼Œå´ä¼šå½±å“åˆ°å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„æ­£ç¡®æ€§ã€‚

##### é‡æ’åº

> https://blog.csdn.net/liuguangqiang/article/details/52153096

![image-20191101102800175](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-01-022800.png)



è™½ç„¶JMMå…è®¸ç¼–è¯‘å™¨è¿›è¡Œé‡æ’åºï¼Œä½†æ˜¯ä¹Ÿéœ€è¦éµå¾ªå¯¹åº”çš„è§„åˆ™ï¼šhappens-beforeè§„åˆ™ã€‚

```java
1ï¼‰ç¨‹åºé¡ºåºè§„åˆ™ï¼šä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ¯ä¸ªæ“ä½œï¼Œhappens-beforeäºè¯¥çº¿ç¨‹ä¸­çš„ä»»æ„åç»­æ“ä½œã€‚
2ï¼‰ç›‘è§†å™¨é”è§„åˆ™ï¼šå¯¹ä¸€ä¸ªé”çš„è§£é”ï¼Œhappens-beforeäºéšåå¯¹è¿™ä¸ªé”çš„åŠ é”ã€‚
3ï¼‰volatileå˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ªvolatileåŸŸçš„å†™ï¼Œhappens-beforeäºä»»æ„åç»­å¯¹è¿™ä¸ªvolatileåŸŸçš„è¯»ã€‚
4ï¼‰ä¼ é€’æ€§ï¼šå¦‚æœA happens-before Bï¼Œä¸”B happens-before Cï¼Œé‚£ä¹ˆA happens-before Cã€‚
5ï¼‰start()è§„åˆ™ï¼šå¦‚æœçº¿ç¨‹Aæ‰§è¡Œæ“ä½œThreadB.start()ï¼ˆå¯åŠ¨çº¿ç¨‹Bï¼‰ï¼Œé‚£ä¹ˆAçº¿ç¨‹çš„ThreadB.start()æ“ä½œhappens-beforeäºçº¿ç¨‹Bä¸­çš„ä»»æ„æ“ä½œã€‚
6ï¼‰join()è§„åˆ™ï¼šå¦‚æœçº¿ç¨‹Aæ‰§è¡Œæ“ä½œThreadB.join()å¹¶æˆåŠŸè¿”å›ï¼Œé‚£ä¹ˆçº¿ç¨‹Bä¸­çš„ä»»æ„æ“ä½œhappens-beforeäºçº¿ç¨‹Aä»ThreadB.join()æ“ä½œæˆåŠŸè¿”å›ã€‚1ï¼‰ç¨‹åºé¡ºåºè§„åˆ™ï¼šä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ¯ä¸ªæ“ä½œï¼Œhappens-beforeäºè¯¥çº¿ç¨‹ä¸­çš„ä»»æ„åç»­æ“ä½œã€‚

```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼š

1ï¼‰å¦‚æœä¸€ä¸ªæ“ä½œhappens-beforeå¦ä¸€ä¸ªæ“ä½œï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œç»“æœå°†å¯¹ç¬¬äºŒä¸ªæ“ä½œå¯è§ï¼Œè€Œä¸”ç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œé¡ºåºæ’åœ¨ç¬¬äºŒä¸ªæ“ä½œä¹‹å‰ã€‚
2ï¼‰ä¸¤ä¸ªæ“ä½œä¹‹é—´å­˜åœ¨happens-beforeå…³ç³»ï¼Œå¹¶ä¸æ„å‘³ç€Javaå¹³å°çš„å…·ä½“å®ç°å¿…é¡»è¦æŒ‰ç…§happens-beforeå…³ç³»æŒ‡å®šçš„é¡ºåºæ¥æ‰§è¡Œã€‚==å¦‚æœé‡æ’åºä¹‹åçš„æ‰§è¡Œç»“æœï¼Œä¸æŒ‰happens-beforeå…³ç³»æ¥æ‰§è¡Œçš„ç»“æœä¸€è‡´ï¼Œé‚£ä¹ˆè¿™ç§é‡æ’åºå¹¶ä¸éæ³•ã€‚==

æ‰€ä»¥ï¼š

ä»å•ä¸ªçº¿ç¨‹çš„è§’åº¦çœ‹ï¼Œæ˜¯å¯ä»¥ä¿è¯æœ‰åºçš„ã€‚ä½†æ˜¯å¦‚æœè§‚å¯Ÿå¤šçº¿ç¨‹ï¼Œæ•´ä¸ªç¨‹åºå°±æ— æ³•ä¿è¯æœ‰åºã€‚

`volatile`å…³é”®å­—å¯ä»¥ä¿è¯ä¸€å®šçš„â€œæœ‰åºæ€§â€ï¼Œå› ä¸º`volatile`å…³é”®å­—ä¼šç¦æ­¢æŒ‡ä»¤é‡æ’ã€‚

`synchronized`å’Œ`lock`å…³é”®å­—ä¿è¯åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€æ¡çº¿ç¨‹æ“ä½œï¼Œä»è€Œä¹Ÿä¿è¯äº†æœ‰åºæ€§ã€‚





## [å¤šçº¿ç¨‹](./æœåŠ¡çŸ¥è¯†æ€»ç»“ - å¤šçº¿ç¨‹)

## CPUå¯†é›†å‹ vs IOå¯†é›†å‹

æˆ‘ä»¬å¯ä»¥æŠŠä»»åŠ¡åˆ†ä¸ºè®¡ç®—å¯†é›†å‹å’ŒIOå¯†é›†å‹ã€‚

è®¡ç®—å¯†é›†å‹ä»»åŠ¡çš„ç‰¹ç‚¹æ˜¯è¦è¿›è¡Œå¤§é‡çš„è®¡ç®—ï¼Œæ¶ˆè€—CPUèµ„æºï¼Œæ¯”å¦‚è®¡ç®—åœ†å‘¨ç‡ã€å¯¹è§†é¢‘è¿›è¡Œé«˜æ¸…è§£ç ç­‰ç­‰ï¼Œå…¨é CPUçš„è¿ç®—èƒ½åŠ›ã€‚è¿™ç§è®¡ç®—å¯†é›†å‹ä»»åŠ¡è™½ç„¶ä¹Ÿå¯ä»¥ç”¨å¤šä»»åŠ¡å®Œæˆï¼Œä½†æ˜¯ä»»åŠ¡è¶Šå¤šï¼ŒèŠ±åœ¨ä»»åŠ¡åˆ‡æ¢çš„æ—¶é—´å°±è¶Šå¤šï¼ŒCPUæ‰§è¡Œä»»åŠ¡çš„æ•ˆç‡å°±è¶Šä½ï¼Œæ‰€ä»¥ï¼Œè¦æœ€é«˜æ•ˆåœ°åˆ©ç”¨CPUï¼Œè®¡ç®—å¯†é›†å‹ä»»åŠ¡åŒæ—¶è¿›è¡Œçš„æ•°é‡åº”å½“ç­‰äºCPUçš„æ ¸å¿ƒæ•°ã€‚

è®¡ç®—å¯†é›†å‹ä»»åŠ¡ç”±äºä¸»è¦æ¶ˆè€—CPUèµ„æºï¼Œå› æ­¤ï¼Œä»£ç è¿è¡Œæ•ˆç‡è‡³å…³é‡è¦ã€‚Pythonè¿™æ ·çš„è„šæœ¬è¯­è¨€è¿è¡Œæ•ˆç‡å¾ˆä½ï¼Œå®Œå…¨ä¸é€‚åˆè®¡ç®—å¯†é›†å‹ä»»åŠ¡ã€‚å¯¹äºè®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Œæœ€å¥½ç”¨Cè¯­è¨€ç¼–å†™ã€‚

ç¬¬äºŒç§ä»»åŠ¡çš„ç±»å‹æ˜¯IOå¯†é›†å‹ï¼Œæ¶‰åŠåˆ°ç½‘ç»œã€ç£ç›˜IOçš„ä»»åŠ¡éƒ½æ˜¯IOå¯†é›†å‹ä»»åŠ¡ï¼Œè¿™ç±»ä»»åŠ¡çš„ç‰¹ç‚¹æ˜¯CPUæ¶ˆè€—å¾ˆå°‘ï¼Œä»»åŠ¡çš„å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨ç­‰å¾…IOæ“ä½œå®Œæˆï¼ˆå› ä¸ºIOçš„é€Ÿåº¦è¿œè¿œä½äºCPUå’Œå†…å­˜çš„é€Ÿåº¦ï¼‰ã€‚å¯¹äºIOå¯†é›†å‹ä»»åŠ¡ï¼Œä»»åŠ¡è¶Šå¤šï¼ŒCPUæ•ˆç‡è¶Šé«˜ï¼Œä½†ä¹Ÿæœ‰ä¸€ä¸ªé™åº¦ã€‚å¸¸è§çš„å¤§éƒ¨åˆ†ä»»åŠ¡éƒ½æ˜¯IOå¯†é›†å‹ä»»åŠ¡ï¼Œæ¯”å¦‚Webåº”ç”¨ã€‚

#### CPUå¯†é›†å‹ï¼ˆCPU-boundï¼‰

CPUå¯†é›†å‹ä¹Ÿå«è®¡ç®—å¯†é›†å‹ï¼ŒæŒ‡çš„æ˜¯ç³»ç»Ÿçš„ç¡¬ç›˜ã€å†…å­˜æ€§èƒ½ç›¸å¯¹CPUè¦å¥½å¾ˆå¤šï¼Œæ­¤æ—¶ï¼Œç³»ç»Ÿè¿ä½œå¤§éƒ¨åˆ†çš„çŠ¶å†µæ˜¯CPU Loading 100%ï¼ŒCPUè¦è¯»/å†™I/O(ç¡¬ç›˜/å†…å­˜)ï¼ŒI/Oåœ¨å¾ˆçŸ­çš„æ—¶é—´å°±å¯ä»¥å®Œæˆï¼Œè€ŒCPUè¿˜æœ‰è®¸å¤šè¿ç®—è¦å¤„ç†ï¼ŒCPU Loadingå¾ˆé«˜ã€‚

åœ¨å¤šé‡ç¨‹åºç³»ç»Ÿä¸­ï¼Œå¤§éƒ¨ä»½æ—¶é—´ç”¨æ¥åšè®¡ç®—ã€é€»è¾‘åˆ¤æ–­ç­‰CPUåŠ¨ä½œçš„ç¨‹åºç§°ä¹‹CPU boundã€‚ä¾‹å¦‚ä¸€ä¸ªè®¡ç®—åœ†å‘¨ç‡è‡³å°æ•°ç‚¹ä¸€åƒä½ä»¥ä¸‹çš„ç¨‹åºï¼Œåœ¨æ‰§è¡Œçš„è¿‡ç¨‹å½“ä¸­ç»å¤§éƒ¨ä»½æ—¶é—´ç”¨åœ¨ä¸‰è§’å‡½æ•°å’Œå¼€æ ¹å·çš„è®¡ç®—ï¼Œä¾¿æ˜¯å±äºCPU boundçš„ç¨‹åºã€‚

CPU boundçš„ç¨‹åºä¸€èˆ¬è€Œè¨€CPUå ç”¨ç‡ç›¸å½“é«˜ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºä»»åŠ¡æœ¬èº«ä¸å¤ªéœ€è¦è®¿é—®I/Oè®¾å¤‡ï¼Œä¹Ÿå¯èƒ½æ˜¯å› ä¸ºç¨‹åºæ˜¯å¤šçº¿ç¨‹å®ç°å› æ­¤å±è”½æ‰äº†ç­‰å¾…I/Oçš„æ—¶é—´ã€‚

#### IOå¯†é›†å‹ï¼ˆI/O boundï¼‰

IOå¯†é›†å‹æŒ‡çš„æ˜¯ç³»ç»Ÿçš„CPUæ€§èƒ½ç›¸å¯¹ç¡¬ç›˜ã€å†…å­˜è¦å¥½å¾ˆå¤šï¼Œæ­¤æ—¶ï¼Œç³»ç»Ÿè¿ä½œï¼Œå¤§éƒ¨åˆ†çš„çŠ¶å†µæ˜¯CPUåœ¨ç­‰I/O (ç¡¬ç›˜/å†…å­˜) çš„è¯»/å†™æ“ä½œï¼Œæ­¤æ—¶CPU Loadingå¹¶ä¸é«˜ã€‚

I/O boundçš„ç¨‹åºä¸€èˆ¬åœ¨è¾¾åˆ°æ€§èƒ½æé™æ—¶ï¼ŒCPUå ç”¨ç‡ä»ç„¶è¾ƒä½ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºä»»åŠ¡æœ¬èº«éœ€è¦å¤§é‡I/Oæ“ä½œï¼Œè€Œpipelineåšå¾—ä¸æ˜¯å¾ˆå¥½ï¼Œæ²¡æœ‰å……åˆ†åˆ©ç”¨å¤„ç†å™¨èƒ½åŠ›ã€‚





# æ–‡ä»¶å¥æŸ„

ä»€ä¹ˆæ˜¯æ–‡ä»¶å¥æŸ„ï¼Ÿ



# æ³¨è§£

1.æ³¨è§£æ¦‚è¿°

2.è‡ªå®šä¹‰æ³¨è§£

3.ä½¿ç”¨æ³¨è§£å®ç°ORMæ¡†æ¶(å¯¹è±¡å…³ç³»æ˜ å°„)



# [è®¾è®¡æ¨¡å¼](../è®¾è®¡æ¨¡å¼.md)



# ç½‘ç»œç¼–ç¨‹

> https://gitee.com/dendi.ke/thread-demo/tree/master/src/main/java/com/gs/example/udp



## 1.ç½‘ç»œç¼–ç¨‹æ¦‚è¿°

ç½‘ç»œç¼–ç¨‹åº•å±‚å°±æ˜¯å­—èŠ‚çš„ä¼ è¾“

### **åŸºç¡€æ•°æ®ç»“æ„**

`byte`æ˜¯ç½‘ç»œä¼ è¾“ä¸­æœ€åŸºæœ¬çš„æ•°æ®ç±»å‹

1byteå `8ä½`2è¿›åˆ¶æ•°ï¼Œå¤§å°èŒƒå›´æ˜¯ -127 ~ 127.  (2^7 -1)  



charå’Œbyteå¯ä»¥ç›¸å…³è½¬æ¢

1short = 2byte

boolean=1byte

int = 4byte

long = 8byte

float = 4byte

double=8byte

stringå­—ç¬¦é•¿åº¦å¯å˜



### æºç ã€è¡¥ç ã€åç 

> http://ckjava.com/2018/05/03/java-byte-0XFF/

åœ¨ç½‘ç»œç¼–ç¨‹çš„è¿‡ç¨‹ä¸­ï¼Œå‡ºç°äº†ä¸€äº›`ä½æ“ä½œ`ï¼Œè¿˜åŒ…æ‹¬äº†ä¸€äº›ä¸ã€æˆ–æ“ä½œï¼Œæ‰€ä»¥åœ¨è¿™é‡Œåšä¸€äº›ç¬”è®°ã€‚

#### 1. åŸç 

åŸç å°±æ˜¯ç¬¦å·ä½åŠ ä¸ŠçœŸå€¼çš„ç»å¯¹å€¼, å³ç”¨ç¬¬ä¸€ä½è¡¨ç¤ºç¬¦å·, å…¶ä½™ä½è¡¨ç¤ºå€¼. æ¯”å¦‚å¦‚æœæ˜¯8ä½äºŒè¿›åˆ¶:

```
[+1]åŸ = 0000 0001
[-1]åŸ = 1000 0001
```

ç¬¬ä¸€ä½æ˜¯ç¬¦å·ä½. å› ä¸ºç¬¬ä¸€ä½æ˜¯ç¬¦å·ä½, æ‰€ä»¥8ä½äºŒè¿›åˆ¶æ•°çš„å–å€¼èŒƒå›´å°±æ˜¯:

```
[1111 1111 , 0111 1111]
```

å³

```
[-127 , 127]
```

#### 2. åç 

åç çš„è¡¨ç¤ºæ–¹æ³•æ˜¯:

æ­£æ•°çš„åç æ˜¯å…¶æœ¬èº«

è´Ÿæ•°çš„åç æ˜¯åœ¨å…¶åŸç çš„åŸºç¡€ä¸Š, ç¬¦å·ä½ä¸å˜ï¼Œå…¶ä½™å„ä¸ªä½å–å.

```
[+1] = [00000001]åŸ = [00000001]å
[-1] = [10000001]åŸ = [11111110]å
```

å¯è§å¦‚æœä¸€ä¸ªåç è¡¨ç¤ºçš„æ˜¯è´Ÿæ•°, äººè„‘æ— æ³•ç›´è§‚çš„çœ‹å‡ºæ¥å®ƒçš„æ•°å€¼. é€šå¸¸è¦å°†å…¶è½¬æ¢æˆåŸç å†è®¡ç®—.

#### 3. è¡¥ç 

è¡¥ç çš„è¡¨ç¤ºæ–¹æ³•æ˜¯:

æ­£æ•°çš„è¡¥ç å°±æ˜¯å…¶æœ¬èº«

è´Ÿæ•°çš„è¡¥ç æ˜¯åœ¨å…¶åŸç çš„åŸºç¡€ä¸Š, ç¬¦å·ä½ä¸å˜, å…¶ä½™å„ä½å–å, æœ€å+1. (å³åœ¨åç çš„åŸºç¡€ä¸Š+1)

è¡¥ç è½¬æ¢ä¸ºåŸç ï¼šç¬¦å·ä½ä¸å˜ï¼Œæ•°å€¼ä½æŒ‰ä½å–å,æœ«ä½å†åŠ 1ã€‚(è¡¥ç çš„è¡¥ç å°±æ˜¯æºç )

```
[+1] = [00000001]åŸ = [00000001]å = [00000001]è¡¥
[-1] = [10000001]åŸ = [11111110]å = [11111111]è¡¥
```

ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°, å¯¹äºæ­£æ•°: åŸç , åç , è¡¥ç éƒ½æ˜¯ä¸€æ ·çš„, å¯¹äºè´Ÿæ•°:åŸç , åç , è¡¥ç éƒ½ä¸ä¸€æ ·.



#### ä¸ºä½•è¦ä½¿ç”¨åŸç , åç å’Œè¡¥ç 

é¦–å…ˆ, å› ä¸ºäººè„‘å¯ä»¥çŸ¥é“ç¬¬ä¸€ä½æ˜¯ç¬¦å·ä½, åœ¨è®¡ç®—çš„æ—¶å€™æˆ‘ä»¬ä¼šæ ¹æ®ç¬¦å·ä½, é€‰æ‹©å¯¹çœŸå€¼åŒºåŸŸçš„åŠ å‡.

 ä½†æ˜¯å¯¹äºè®¡ç®—æœº, åŠ å‡ä¹˜æ•°å·²ç»æ˜¯æœ€åŸºç¡€çš„è¿ç®—, è¦è®¾è®¡çš„å°½é‡ç®€å•. è®¡ç®—æœºè¾¨åˆ«"ç¬¦å·ä½"æ˜¾ç„¶ä¼šè®©è®¡ç®—æœºçš„åŸºç¡€ç”µè·¯è®¾è®¡å˜å¾—ååˆ†å¤æ‚! 

äºæ˜¯äººä»¬æƒ³å‡ºäº†å°†ç¬¦å·ä½ä¹Ÿå‚ä¸è¿ç®—çš„æ–¹æ³•. æˆ‘ä»¬çŸ¥é“, æ ¹æ®è¿ç®—æ³•åˆ™å‡å»ä¸€ä¸ªæ­£æ•°ç­‰äºåŠ ä¸Šä¸€ä¸ªè´Ÿæ•°, å³: 1-1 = 1 + (-1) = 0 , æ‰€ä»¥æœºå™¨å¯ä»¥åªæœ‰åŠ æ³•è€Œæ²¡æœ‰å‡æ³•, è¿™æ ·è®¡ç®—æœºè¿ç®—çš„è®¾è®¡å°±æ›´ç®€å•äº†.

äºæ˜¯äººä»¬å¼€å§‹æ¢ç´¢ å°†ç¬¦å·ä½å‚ä¸è¿ç®—, å¹¶ä¸”åªä¿ç•™åŠ æ³•çš„æ–¹æ³•. é¦–å…ˆæ¥çœ‹åŸç :

è®¡ç®—åè¿›åˆ¶çš„è¡¨è¾¾å¼: 1-1=0

> 1 - 1 = 1 + (-1) = [00000001]åŸ + [10000001]åŸ = [10000010]åŸ = -2

å¦‚æœç”¨åŸç è¡¨ç¤º, è®©ç¬¦å·ä½ä¹Ÿå‚ä¸è®¡ç®—, æ˜¾ç„¶å¯¹äºå‡æ³•æ¥è¯´, ç»“æœæ˜¯ä¸æ­£ç¡®çš„.è¿™ä¹Ÿå°±æ˜¯ä¸ºä½•è®¡ç®—æœºå†…éƒ¨ä¸ä½¿ç”¨åŸç è¡¨ç¤ºä¸€ä¸ªæ•°.

ä¸ºäº†è§£å†³åŸç åšå‡æ³•çš„é—®é¢˜, å‡ºç°äº†åç :

è®¡ç®—åè¿›åˆ¶çš„è¡¨è¾¾å¼: 1-1=0

> 1 - 1 = 1 + (-1) = [0000 0001]åŸ + [1000 0001]åŸ= [0000 0001]å + [1111 1110]å = [1111 1111]å = [1000 0000]åŸ = -0

å‘ç°ç”¨åç è®¡ç®—å‡æ³•, ç»“æœçš„çœŸå€¼éƒ¨åˆ†æ˜¯æ­£ç¡®çš„. è€Œå”¯ä¸€çš„é—®é¢˜å…¶å®å°±å‡ºç°åœ¨"0"è¿™ä¸ªç‰¹æ®Šçš„æ•°å€¼ä¸Š. è™½ç„¶äººä»¬ç†è§£ä¸Š+0å’Œ-0æ˜¯ä¸€æ ·çš„, ä½†æ˜¯0å¸¦ç¬¦å·æ˜¯æ²¡æœ‰ä»»ä½•æ„ä¹‰çš„. è€Œä¸”ä¼šæœ‰[0000 0000]åŸå’Œ[1000 0000]åŸä¸¤ä¸ªç¼–ç è¡¨ç¤º0.

äºæ˜¯è¡¥ç çš„å‡ºç°, è§£å†³äº†0çš„ç¬¦å·ä»¥åŠä¸¤ä¸ªç¼–ç çš„é—®é¢˜:

> 1-1 = 1 + (-1) = [0000 0001]åŸ + [1000 0001]åŸ = [0000 0001]è¡¥ + [1111 1111]è¡¥ = [0000 0000]è¡¥=[0000 0000]åŸ

è¿™æ ·0ç”¨[0000 0000]è¡¨ç¤º, è€Œä»¥å‰å‡ºç°é—®é¢˜çš„-0åˆ™ä¸å­˜åœ¨äº†.è€Œä¸”å¯ä»¥ç”¨[1000 0000]è¡¨ç¤º-128:

> (-1) + (-127) = [1000 0001]åŸ + [1111 1111]åŸ = [1111 1111]è¡¥ + [1000 0001]è¡¥ = [1000 0000]è¡¥

-1-127çš„ç»“æœåº”è¯¥æ˜¯-128, åœ¨ç”¨è¡¥ç è¿ç®—çš„ç»“æœä¸­, [1000 0000]è¡¥ å°±æ˜¯-128. ä½†æ˜¯æ³¨æ„å› ä¸ºå®é™…ä¸Šæ˜¯ä½¿ç”¨ä»¥å‰çš„-0çš„è¡¥ç æ¥è¡¨ç¤º-128, æ‰€ä»¥-128å¹¶æ²¡æœ‰åŸç å’Œåç è¡¨ç¤º.(å¯¹-128çš„è¡¥ç è¡¨ç¤º[1000 0000]è¡¥ç®—å‡ºæ¥çš„åŸç æ˜¯[0000 0000]åŸ, è¿™æ˜¯**ä¸æ­£ç¡®**çš„)

ä½¿ç”¨è¡¥ç , ä¸ä»…ä»…ä¿®å¤äº†0çš„ç¬¦å·ä»¥åŠå­˜åœ¨ä¸¤ä¸ªç¼–ç çš„é—®é¢˜, è€Œä¸”è¿˜èƒ½å¤Ÿå¤šè¡¨ç¤ºä¸€ä¸ªæœ€ä½æ•°. è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ8ä½äºŒè¿›åˆ¶, ä½¿ç”¨åŸç æˆ–åç è¡¨ç¤ºçš„èŒƒå›´ä¸º[-127, +127], è€Œä½¿ç”¨è¡¥ç è¡¨ç¤ºçš„èŒƒå›´ä¸º[-128, 127].

å› ä¸ºæœºå™¨ä½¿ç”¨è¡¥ç , æ‰€ä»¥å¯¹äºç¼–ç¨‹ä¸­å¸¸ç”¨åˆ°çš„32ä½intç±»å‹, å¯ä»¥è¡¨ç¤ºèŒƒå›´æ˜¯: [-2^31, 2^31-1] å› ä¸ºç¬¬ä¸€ä½è¡¨ç¤ºçš„æ˜¯ç¬¦å·ä½.è€Œä½¿ç”¨è¡¥ç è¡¨ç¤ºæ—¶åˆå¯ä»¥å¤šä¿å­˜ä¸€ä¸ªæœ€å°å€¼.



### å…³äº`&ä¸`è¿ç®—

`&`è¿ç®—æ˜¯äºŒè¿›åˆ¶æ•°æ®çš„è®¡ç®—æ–¹å¼, ä¸¤ä¸ªæ“ä½œä½éƒ½ä¸º1ï¼Œç»“æœæ‰ä¸º1ï¼Œå¦åˆ™ç»“æœä¸º0. 

**ä¸ºä½•è¦ & 0xffï¼Ÿ**

å…¶æœ¬è´¨åŸå› å°±æ˜¯æƒ³ä¿æŒäºŒè¿›åˆ¶è¡¥ç çš„ä¸€è‡´æ€§ã€‚

åœ¨è®¡ç®—æœºä¸­ï¼Œæ•°æ®éƒ½æ˜¯ä»¥è¡¥ç çš„æ–¹å¼ä¿å­˜çš„ã€‚byteæœ‰8ä½ï¼Œè€Œintæœ‰32ä½ã€‚å½“byteè½¬æ¢ä¸ºintçš„æ—¶å€™ï¼Œè®¡ç®—æœºä¼šè‡ªåŠ¨è¿›è¡Œè¡¥ä½ã€‚ 

å¦‚æœæ˜¯è´Ÿæ•°ï¼Œé«˜ä½éƒ½ä¼šè¡¥1ï¼Œå¦‚æœæ˜¯æ­£æ•°ï¼Œé«˜ä½éƒ½ä¼šè¡¥0ï¼›

ä¸¾ä¸ªä¾‹å­ï¼š

> å½“å°†-127èµ‹å€¼ç»™a[0]æ—¶å€™ï¼Œa[0]ä½œä¸ºä¸€ä¸ªbyteç±»å‹ï¼Œå…¶è®¡ç®—æœºå­˜å‚¨çš„è¡¥ç æ˜¯10000001ï¼ˆ8ä½ï¼‰ã€‚

> å°†a[0] ä½œä¸ºintç±»å‹å‘æ§åˆ¶å°è¾“å‡ºçš„æ—¶å€™ï¼Œè®¡ç®—æœºåšäº†ä¸€ä¸ªè¡¥ä½çš„å¤„ç†ï¼Œå› ä¸ºintç±»å‹æ˜¯32ä½æ‰€ä»¥è¡¥ä½åçš„è¡¥ç å°±æ˜¯11111111 11111111 11111111 10000001ï¼ˆ32ä½ï¼‰ï¼Œè¿™ä¸ª32ä½äºŒè¿›åˆ¶è¡¥ç è¡¨ç¤ºçš„ä¹Ÿæ˜¯-127.

è™½ç„¶byte->intè®¡ç®—æœºèƒŒåå­˜å‚¨çš„äºŒè¿›åˆ¶è¡¥ç ç”±10000001ï¼ˆ8ä½ï¼‰è½¬åŒ–æˆäº†11111111 11111111 11111111 10000001ï¼ˆ32ä½ï¼‰å¾ˆæ˜¾ç„¶è¿™ä¸¤ä¸ªè¡¥ç è¡¨ç¤ºçš„åè¿›åˆ¶æ•°å­—ä¾ç„¶æ˜¯ç›¸åŒçš„ã€‚

ä½†æ˜¯è®¡ç®—æœºçš„äºŒè¿›åˆ¶ä¸ä»…ä»…åªç”¨æ¥è¡¨ç¤ºåè¿›åˆ¶æ•°ï¼Œåè¿›åˆ¶æ•°åªæ˜¯å®ƒçš„æ•°å€¼ï¼ŒäºŒè¿›åˆ¶æ‰ä»£è¡¨äº†è®¡ç®—æœºçœŸæ­£çš„æ•°æ®æ€§ã€‚

æˆ‘ä»¬å‘ç°ï¼Œå¦‚æœbyteè½¬æ¢ä¸ºintï¼Œè®¡ç®—æœºä¼šæ”¹å˜å®ƒçš„æ•°æ®æ€§ï¼Œå¯¼è‡´æ•°æ®å‘ç”Ÿäº†å˜åŒ–ã€‚é‚£ä¸ºäº†ä¿è¯äº†äºŒè¿›åˆ¶æ•°æ®æ€§ï¼Œæˆ‘ä»¬éœ€è¦å°†é«˜ä½è¡¥0ï¼Œä½8ä½ä¿æŒä¸å˜ã€‚æ‰€ä»¥éœ€è¦&0xffã€‚

å…¶å®å¦‚æœbyteæ˜¯æ­£æ•°é‚£ä¹ˆæ˜¯å¦è¿›è¡Œ&0xffç»“æœéƒ½ä¸€æ ·ï¼›å¦‚æœæ˜¯è´Ÿæ•°å°±ä¸€å®šéœ€è¦&0xffã€‚



å¦‚æœb[0]ä¸º `-10`, é‚£ä¹ˆå…¶åŸç è¡¨ç¤ºä¸º

> 00000000 00000000 00000000 10001010

åç ä¸º

> 11111111 11111111 11111111 11110101

è¡¥ç ä¸º ï¼ˆè®¡ç®—æœºå­˜å‚¨çš„æ•°å€¼ï¼‰

> 11111111 11111111 11111111 11110110 

è¿™ä¸ªæ—¶å€™å¦‚æœåšä½è¿ç®—ï¼Œæ•°æ®ä¼šé”™ä¹±ã€‚æ¯”å¦‚å³ç§»>>ï¼Œå¹³ç™½å¤šå‡ºäº†å¾ˆå¤š1.

`0XFF` è¡¨ç¤º16è¿›åˆ¶çš„æ•°æ®255, åŸç , åç , è¡¥ç éƒ½æ˜¯ä¸€æ ·çš„, å…¶äºŒè¿›åˆ¶æ•°æ®ä¸º

> 00000000 00000000 00000000 11111111

`0XFF` å’Œ `-10 `è¿›è¡Œ`&`è¿ç®—åç»“æœä¸ºï¼šï¼ˆè¡¥ç è¿›è¡Œè¿ç®—ï¼‰

> 11111111 11111111 11111111 11110110 & 00000000 00000000 00000000 11111111 = 00000000 00000000 00000000 11110110

è¿™æ ·å°±å¯ä»¥ä¿è¯äºŒè¿›åˆ¶æ•°æ®ä¸å˜ã€‚





### å…³äºä½ç§»è¿ç®—

**è®¡ç®—æœºä¸­å­˜çš„éƒ½æ˜¯æ•°çš„è¡¥ç **ï¼Œæ‰€ä»¥ä½ç§»è¿ç®—éƒ½æ˜¯å¯¹è¡¥ç è€Œè¨€çš„ã€‚

**<< å·¦ç§» ä½ä½è¡¥0**

**>> å³ç§» é«˜ä½è¡¥ç¬¦å·ä½ï¼Œå³ï¼šå¦‚æœç¬¦å·ä½æ˜¯1 å°±è¡¥1ï¼Œå¦‚æœç¬¦å·ä½æ˜¯0 å°±è¡¥0**

**>>>æ— ç¬¦å·å³ç§» ï¼Œé«˜ä½ç»Ÿä¸€è¡¥0**







## 2.TCPä¸UDPåŒºåˆ«

TCPåè®®æ˜¯==é¢å‘è¿æ¥==çš„é€šè®¯åè®®ï¼›å‘é€æ¶ˆæ¯æ—¶å¿…é¡»å»ºç«‹äº†è¿æ¥ï¼ˆ3æ¬¡æ¡æ‰‹ï¼‰ï¼Œé€šè®¯å®Œæˆæ—¶éœ€è¦æ–­å¼€è¿æ¥ï¼ˆ4æ¬¡æŒ¥æ‰‹ï¼‰ï¼›

TCPæ˜¯å¯é çš„ï¼ŒåŸºäºå­—èŠ‚æµçš„ä¼ è¾“åè®®ã€‚

è€ŒUDPåè®®æ˜¯é¢å‘æ— è¿æ¥çš„é€šè®¯åè®®ï¼Œæ²¡æœ‰severã€clientä¹‹åˆ†ï¼Œåªéœ€è¦çŸ¥é“å¯¹æ–¹çš„ipåœ°å€å’Œç«¯å£å·ï¼›

åŸºäºæ•°å­—æ•°æ®æŠ¥ä¼ è¾“ï¼›

UDPå¯ä»¥å®ç°å•æ’­ã€å¹¿æ’­ã€å¤šæ’­ï¼›

## 3.UDPå‘é€æ¶ˆæ¯

UDPæ²¡æœ‰severã€clientä¹‹åˆ†ï¼Œåœ¨javaå®ç°é‡Œï¼Œé€šè¿‡`DatagramSocket`ç±»å®ç°ã€‚

### å‘é€æ¶ˆæ¯çš„æ­¥éª¤

```mermaid
graph TD
a[å£°æ˜DatagramSocketå®ä¾‹]--> b[å£°æ˜æ¥å—æ¶ˆæ¯DatagramPacketå®ä¾‹]
b --> c[ç­‰å¾…æ¶ˆæ¯ ä¼šé˜»å¡]
c --> d[æ¥æ”¶åˆ°æ¶ˆæ¯ æ‹¿åˆ°å¯¹æ–¹ipå’Œç«¯å£å·]
d --> e[å›æŠ¥æ¶ˆæ¯]

```

ä»£ç å®ä¾‹ï¼šUdpProviderç›‘å¬åœ¨2000ç«¯å£æ¥å—æ¶ˆæ¯ï¼Œæ‰“å°æ¶ˆæ¯ï¼Œå›æŠ¥æ¶ˆæ¯ï¼›UdpSearchå‘Providerå‘é€æ¶ˆæ¯ï¼Œæ‰“å°å›æŠ¥æ¶ˆæ¯ï¼›

```java
/**
 * @author keyang
 */
public class UdpProvider {
	
	public static void main(String[] args) throws IOException {
		System.out.println("UdpProvideræœåŠ¡å¯åŠ¨æˆåŠŸ");
		
		DatagramSocket datagramSocket = new DatagramSocket(2000);
		byte[] bytes = new byte[512];
		DatagramPacket datagramPacket = new DatagramPacket(bytes, bytes.length);
		
		// This method blocks until a datagram is received
		datagramSocket.receive(datagramPacket);
		byte[] receivedBytes = datagramPacket.getData();
		String message = new String(receivedBytes, 0, datagramPacket.getLength(), "utf-8");
		System.out.println("UdpProvideræ¥å—åˆ°æ¶ˆæ¯ï¼š" + message + ", å­—èŠ‚é•¿åº¦ï¼š" + datagramPacket.getLength() + "ï¼Œç«¯å£å·ï¼š" + datagramPacket.getPort());
		// å›å†™æ¶ˆæ¯ï¼›
		InetAddress inetAddress = datagramPacket.getAddress();
		int port = datagramPacket.getPort();
		String responseMsg = "response from udp";
		DatagramPacket responsePack = new DatagramPacket(responseMsg.getBytes(), responseMsg.getBytes().length);
		responsePack.setAddress(inetAddress);
		responsePack.setPort(port);
		datagramSocket.send(responsePack);
		
		System.out.println("UdpProvideræœåŠ¡å…³é—­");
		
	}
}

/**
 * @author keyang
 */
public class UdpSearcher {
	
	public static void main(String[] args) throws IOException {
		System.out.println("UdpSearcheræœåŠ¡å¯åŠ¨æˆåŠŸ");
		// æœç´¢æ–¹å¯ä»¥ç»‘å®šä»»æ„ç«¯å£
		DatagramSocket datagramSocket = new DatagramSocket();
		String sendMsg = "ä½ å¥½ï¼ŒUDP";
		DatagramPacket sendPack = new DatagramPacket(sendMsg.getBytes(), sendMsg.getBytes().length);
		sendPack.setAddress(InetAddress.getLocalHost());
		sendPack.setPort(2000);
		datagramSocket.send(sendPack);
		
		// This method blocks until a datagram is received
		byte[] bytes = new byte[512];
		DatagramPacket receiverPack = new DatagramPacket(bytes, bytes.length);
		datagramSocket.receive(receiverPack);
		byte[] receivedBytes = receiverPack.getData();
		String message = new String(receivedBytes, 0, receiverPack.getLength(), "utf-8");
		System.out.println("UdpSearcheræ¥å—åˆ°æ¶ˆæ¯ï¼š" + message + ", å­—èŠ‚é•¿åº¦ï¼š" + receiverPack.getLength() + "ï¼Œç«¯å£å·ï¼š" + receiverPack.getPort());
		
		System.out.println("UdpSearcheræœåŠ¡å…³é—­");
		
	}
}

```



### UDPå¹¿æ’­æœç´¢

udpæœ€å¤§çš„ä¼˜ç‚¹æ˜¯å¯ä»¥å¹¿æ’­ä¿¡æ¯ï¼Œåªéœ€è¦å‘å±€åŸŸç½‘å¯¹åº”çš„å¹¿æ’­åœ°å€ä¼ è¾“ä¿¡æ¯å³å¯ã€‚å¹¿æ’­åœ°å€ä¸€èˆ¬æ ¹æ®ç½‘æ®µåœ°å€å’Œé»˜è®¤ç½‘å…³è®¡ç®—å‡ºæ¥ï¼Œå¤§éƒ¨åˆ†çš„å¹¿æ’­åœ°å€æ˜¯`255.255.255.255`;

**ä»£ç å®ä¾‹**ï¼šhttps://gitee.com/dendi.ke/thread-demo/blob/master/src/main/java/com/gs/example/udp/UdpProvider.java

udpSearchå‘å¹¿æ’­åœ°å€å‘é€2000ç«¯å£çš„æ¶ˆæ¯ï¼ŒudpProviderç›‘å¬2000ç«¯å£çš„ä¿¡æ¯ï¼Œæ¥æ”¶åˆ°æ¶ˆæ¯åå›æŠ¥ç»™udpSearchè‡ªèº«çš„ä¿¡æ¯ã€‚

```java
public class UdpProvider {
	
	public static void main(String[] args) throws IOException {
		System.out.println("UdpProvideræœåŠ¡å¯åŠ¨æˆåŠŸ");
		String sn = UUID.randomUUID().toString();
		ProviderThread providerThread = new ProviderThread(sn);
		providerThread.start();
		System.in.read();
		providerThread.close();
		System.out.println("UdpProvideræœåŠ¡å…³é—­");
	}
	
	private static class ProviderThread extends Thread {
		private boolean done;
		private final String sn;
		public ProviderThread(String sn) {
			super();
			this.sn = sn;
			this.done = false;
		}
		
		@Override
		public void run() {
			super.run();
			while (!done) {
				DatagramSocket datagramSocket = null;
				try {
					datagramSocket = new DatagramSocket(2000);
					byte[] bytes = new byte[512];
					DatagramPacket datagramPacket = new DatagramPacket(bytes, bytes.length);
					// This method blocks until a datagram is received
					datagramSocket.receive(datagramPacket);
					byte[] receivedBytes = datagramPacket.getData();
					String message = new String(receivedBytes, 0, datagramPacket.getLength(), "utf-8");
					System.out.println("UdpProvideræ¥å—åˆ°æ¶ˆæ¯ï¼š" + message + ", å­—èŠ‚é•¿åº¦ï¼š" + datagramPacket.getLength() + "ï¼Œç«¯å£å·ï¼š" + datagramPacket.getPort());
					// å›å†™æ¶ˆæ¯ï¼›
					InetAddress inetAddress = datagramPacket.getAddress();
					int port = MessageFactory.parsePort(message);
					String responseMsg = MessageFactory.generateString(sn);
					DatagramPacket responsePack = new DatagramPacket(responseMsg.getBytes(), responseMsg.getBytes().length);
					responsePack.setAddress(inetAddress);
					responsePack.setPort(port);
					datagramSocket.send(responsePack);
				} catch (SocketException e) {
					e.printStackTrace();
				} catch (UnsupportedEncodingException e) {
					e.printStackTrace();
				} catch (IOException e) {
					e.printStackTrace();
				} finally {
					datagramSocket.close();
				}
			}
		}
		
		void close() {
			done = true;
		}
	}
  
  public class UdpSearcher {
	
	private static int PORT = 3000;
	
	public static void main(String[] args) throws IOException, InterruptedException {
		System.out.println("UdpSearcheræœåŠ¡å¯åŠ¨æˆåŠŸ");
		SeacherThread listener = listen();
		search();
		// é˜»å¡ä¸»çº¿ç¨‹
		System.in.read();
		List<String> sns = listener.getSns();
		System.out.println("ç»„ç»‡è§£æ•£äº†ï¼Œç‰¹å·¥ä¸€å…±æœ‰ï¼š" + Arrays.toString(sns.toArray()));
		listener.close();
		System.out.println("UdpSearcheræœåŠ¡å…³é—­");
		
	}
	
	private static SeacherThread listen() throws InterruptedException {
		CountDownLatch countDownLatch = new CountDownLatch(1);
		SeacherThread seacherThread = new SeacherThread(countDownLatch);
		seacherThread.start();
		// ç­‰å¾…ç›‘å¬æœåŠ¡å¯åŠ¨å¥½
		countDownLatch.await();
		return seacherThread;
	}
	
	private static void search() throws IOException {
		// æœç´¢æ–¹å¯ä»¥ç»‘å®šä»»æ„ç«¯å£
		System.out.println("UDPSearcher sendBroadcast started.");
		DatagramSocket datagramSocket = new DatagramSocket();
		String sendMsg = MessageFactory.generatePort(PORT);
		DatagramPacket sendPack = new DatagramPacket(sendMsg.getBytes(), sendMsg.getBytes().length);
		sendPack.setAddress(InetAddress.getByName("255.255.255.255"));
		sendPack.setPort(2000);
		datagramSocket.send(sendPack);
		datagramSocket.close();
		System.out.println("UDPSearcher sendBroadcast end.");
	}
	
	private static class SeacherThread extends Thread {
		
		private boolean done;
		private final List<String> sns = new ArrayList<>();
		private final CountDownLatch countDownLatch;
		private DatagramSocket datagramSocket = null;
		
		public SeacherThread(CountDownLatch countDownLatch) {
			super();
			this.countDownLatch = countDownLatch;
			this.done = false;
		}
		
		@Override
		public void run() {
			System.out.println("UdpSearcher ç›‘å¬æœåŠ¡å¯åŠ¨æˆåŠŸ");
			countDownLatch.countDown();
			try {
				datagramSocket = new DatagramSocket(PORT);
				while (!done) {
					// This method blocks until a datagram is received
					byte[] bytes = new byte[512];
					DatagramPacket receiverPack = new DatagramPacket(bytes, bytes.length);
					datagramSocket.receive(receiverPack);
					byte[] receivedBytes = receiverPack.getData();
					String message = new String(receivedBytes, 0, receiverPack.getLength(), "utf-8");
					System.out.println("UdpSearcheræ¥å—åˆ°æ¶ˆæ¯ï¼š" + message + ", å­—èŠ‚é•¿åº¦ï¼š" + receiverPack.getLength() + "ï¼Œç«¯å£å·ï¼š" + receiverPack.getPort());
					String sn = MessageFactory.parseSn(message);
					if (sn != null) {
						sns.add(sn);
					}
				}
				System.out.println("UdpSearcher ç›‘å¬æœåŠ¡åœæ­¢");
			} catch (Exception ignored) {
			} finally {
				close();
			}
		}
		void close() {
			done = true;
			if (datagramSocket != null) {
				datagramSocket.close();
				datagramSocket = null;
			}
		}
		public List<String> getSns() {
			return sns;
		}
	}
  
```





## 4.TCP ï¼ˆTransmission Control Protocolï¼‰

**æ¦‚å¿µ**ï¼šåŸºäºè¿æ¥çš„ã€å¯é çš„ä¼ è¾“æ§åˆ¶åè®®ã€‚

**åº”ç”¨åœºæ™¯**ï¼š

- æ¶ˆæ¯ä¼ è¾“ã€æ¨é€ï¼›
- å•äººè¯­éŸ³ã€è§†é¢‘æ¶ˆæ¯ï¼›

- ä½†å¯ä»¥å®ç°udpæ‰€æœ‰çš„åŠŸèƒ½ï¼Œä½†æ˜¯æ— æ³•è¿›è¡Œå¹¿æ’­ã€å¤šæ’­ï¼›

### ä¸‰æ¬¡æ¡æ‰‹

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-05-134119.png" alt="image-20191105214118317" style="zoom:30%;" />

### å››æ¬¡æŒ¥æ‰‹

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-05-140334.png" alt="image-20191105220334062" style="zoom:30%;" />

ACKï¼šç¡®è®¤åºå·æœ‰æ•ˆã€‚ 

SYNï¼šå‘èµ·ä¸€ä¸ªæ–°è¿æ¥ã€‚

 FINï¼šé‡Šæ”¾ä¸€ä¸ªè¿æ¥ã€‚









### TCPå‘é€æ¶ˆæ¯ ï¼ˆå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ï¼‰

```mermaid
graph TD
subgraph å®¢æˆ·ç«¯
1[åˆ›å»ºsocket] --> 2[ç»‘å®šæœ¬åœ°ç«¯å£]
2 --> 3[connectè¿æ¥è¿œç¨‹å¥—æ¥å­—]
3 --> 31[send å‘é€æ¶ˆæ¯]
31 --> 32[receive æ¥æ”¶å›æŠ¥æ¶ˆæ¯]
32 --> 33[close å…³é—­è¿æ¥]
end
subgraph æœåŠ¡ç«¯
3 --> 6
31 --> 7
8 --> 32
4[åˆ›å»ºæœåŠ¡socket] --> 5[ç»‘å®šç›‘å¬ç«¯å£]
5 --> 6[Acceptç­‰å¾…æ¶ˆæ¯]
6 --> 7[Receiveæ¥æ”¶æ¶ˆæ¯]
7 --> 8[sendå›æŠ¥æ¶ˆæ¯]
end
```

TCP**çš„è¿æ¥å¯é æ€§åŸç†**

- 3æ¬¡æ¡æ‰‹â€”â€”ä¸ºä»€ä¹ˆæ˜¯3æ¬¡æ¡æ‰‹ï¼Ÿ

  ä¸‰æ¬¡æ¡æ‰‹ä¸»è¦æ˜¯ä¿è¯å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½èƒ½ç¡®è®¤ **è‡ªå·±çš„æ¶ˆæ¯èƒ½è¢«å¯¹æ–¹æ¥å—ï¼Œå¹¶ä¸”åˆ«äººçš„æ¶ˆæ¯èƒ½è¢«å¯¹æ–¹æ¥å—**ï¼›

  

- 4æ¬¡æŒ¥æ‰‹â€”â€”ä¸ºä»€ä¹ˆæ˜¯4æ¬¡æŒ¥æ‰‹ï¼Ÿ

  

  å››æ¬¡æŒ¥æ‰‹çš„ç¬¬äºŒæ¬¡å’Œç¬¬ä¸‰æ¬¡ä¹‹æ‰€ä»¥åˆ†å¼€ï¼Œå…¶å®æ˜¯å› ä¸ºæœ‰å¯èƒ½æœåŠ¡ç«¯æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„FINè¯·æ±‚æ—¶ï¼ŒæœåŠ¡ç«¯æ•°æ®å¹¶æ²¡æœ‰å‘é€å®Œï¼Œæˆ–è€…è¯´ä¸èƒ½é©¬ä¸Šå‘é€æœªå®Œæˆçš„æ•°æ®ã€‚è¿™ä¸ªæ—¶å€™å¹¶ä¸èƒ½ä¿è¯æœåŠ¡ç«¯èƒ½ç«‹é©¬å›å¤å®¢æˆ·ç«¯çš„FINä¿¡å·ï¼Œå› æ­¤æ¥æ”¶æ–¹çš„`ACKæ¶ˆæ¯`å’Œ`FINæ¶ˆæ¯`ä¸€èˆ¬åˆ†å¼€å‘é€ï¼Œæ‰€ä»¥æ˜¯4æ¬¡æŒ¥æ‰‹ã€‚

  > 2019.12.1 æ—¥è¡¥å……ï¼š

  TCPæ˜¯å…¨åŒå·¥æ¨¡å¼ï¼Œæ„å‘³ç€å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„å‘é€ã€æ¥æ”¶æ˜¯åˆ†å¼€çš„ï¼Œå› æ­¤æ¯ä¸ªæ–¹å‘çš„è¿æ¥éƒ½å¿…é¡»å•ç‹¬è¿›è¡Œå…³é—­ã€‚å®¢æˆ·ç«¯å‘èµ·ä¸»åŠ¨å…³é—­åï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯ä¸å†æœ‰æ•°æ®éœ€è¦å‘é€ï¼Œä½†æ˜¯å®¢æˆ·ç«¯ä»ç„¶å¯ä»¥æ¥æ”¶æœåŠ¡ç«¯çš„æ¶ˆæ¯ï¼›

  





- ä¸ºä»€ä¹ˆTIME_WAITçŠ¶æ€éœ€è¦ç»è¿‡2MSL(æœ€å¤§æŠ¥æ–‡æ®µç”Ÿå­˜æ—¶é—´)æ‰èƒ½è¿”å›åˆ°CLOSEçŠ¶æ€ï¼Ÿ

  ç­”ï¼šå› ä¸ºClientæœ€åçš„ACKå¯èƒ½ä¼šè¢«ä¸¢å¤±ï¼ŒServerå¦‚æœæ²¡æœ‰æ”¶åˆ°ACKï¼Œå°†ä¸æ–­é‡å¤å‘é€FINç‰‡æ®µã€‚æ‰€ä»¥Clientä¸èƒ½ç«‹å³å…³é—­ï¼Œå®ƒå¿…é¡»ç¡®è®¤Serveræ¥æ”¶åˆ°äº†è¯¥ACKã€‚

  æ‰€ä»¥TIME_WAITçŠ¶æ€å°±æ˜¯ç”¨æ¥é‡å‘å¯èƒ½ä¸¢å¤±çš„ACKæŠ¥æ–‡ã€‚

  Clientä¼šè®¾ç½®ä¸€ä¸ªè®¡æ—¶å™¨ï¼Œç­‰å¾…2MSLçš„æ—¶é—´ã€‚å¦‚æœåœ¨è¯¥æ—¶é—´å†…å†æ¬¡æ”¶åˆ°FINï¼Œé‚£ä¹ˆClientä¼šé‡å‘ACKå¹¶å†æ¬¡ç­‰å¾…2MSLã€‚æ‰€è°“çš„2MSLæ˜¯ä¸¤å€çš„MSL(Maximum Segment Lifetime)ã€‚MSLæŒ‡ä¸€ä¸ªç‰‡æ®µåœ¨ç½‘ç»œä¸­æœ€å¤§çš„å­˜æ´»æ—¶é—´ï¼Œ2MSLå°±æ˜¯ä¸€ä¸ªå‘é€å’Œä¸€ä¸ªå›å¤æ‰€éœ€çš„æœ€å¤§æ—¶é—´ã€‚å¦‚æœç›´åˆ°2MSLï¼ŒClientéƒ½æ²¡æœ‰å†æ¬¡æ”¶åˆ°FINï¼Œé‚£ä¹ˆClientæ¨æ–­ACKå·²ç»è¢«æˆåŠŸæ¥æ”¶ï¼Œåˆ™ç»“æŸTCPè¿æ¥ã€‚

  

TCP**çš„ä¼ è¾“å¯é æ€§åŸç†**

- æ’åºã€é¡ºåºå‘é€ã€é¡ºåºç»„è£…

  æ•°æ®åŒ…ä¼šè¢«åˆ†ç‰‡ï¼Œæ¥æ”¶æ–¹æ¥å—çš„é¡ºåºå¯èƒ½å’Œå‘é€é¡ºåºä¸åŒï¼Œæ‰€ä»¥æ¥å—ç«¯ä¼šå¯¹æ¥å—åˆ°çš„æ¶ˆæ¯é‡æ–°æ’åºï¼›

- ä¸¢å¼ƒã€è¶…æ—¶

  å½“æ•°æ®åŒ…å‡ºç°äº†ä¸¢åŒ…ï¼Œæˆ–è€…è¿æ¥è¢«æ–­å¼€çš„æƒ…å†µï¼Œtcpä¼šç»è¿‡ä¸€å®šçš„æ—¶é—´è¿›è¡Œé‡å‘ï¼›

- å®šæ—¶é‡å‘

  linuxçš„åˆ¤æ–­æ—¶é—´30sï¼Œå¦‚æœè¶…è¿‡30sæ²¡æœ‰å¾—åˆ°å›åº”ï¼Œå‘é€ç«¯ä¼šè®¤ä¸ºæ•°æ®ä¸¢å¤±äº†ï¼Œé‡æ–°å‘é€ï¼›

  



**ä½¿ç”¨ByteBufferæ¥å‘é€å„ç§ç±»å‹çš„æ¶ˆæ¯**

**TCPæ¡ˆä¾‹**

```java
// server
public class MySocketServer {
	public static final int PORT = 20000;
	public static void main(String[] args) throws UnknownHostException {
		try {
			ServerSocket server = new ServerSocket();
			initSocketServer(server);
			server.bind(new InetSocketAddress(InetAddress.getLocalHost(),PORT));
			System.out.println("æœåŠ¡ç«¯å¯åŠ¨å°±ç»ªï¼Œç­‰å¾…è¿æ¥");
			while(true) {
				Socket client = server.accept();
				ClientHandleThread clientHandleThread = new ClientHandleThread(client);
				clientHandleThread.start();
			}
		} catch (IOException e) {
			e.printStackTrace();
		}
	}
	
	private static void initSocketServer(ServerSocket server) throws SocketException {
			server.setSoTimeout(60 * 1000);
			server.setReuseAddress(true);
			// bufferSize: é»˜è®¤æ˜¯8kbyte = 8*1024
			server.setReceiveBufferSize(64 * 1024 * 1024);
	}
	
	private static class ClientHandleThread extends Thread{
		private final Socket client;
		public ClientHandleThread(Socket client) {
			this.client = client;
		}
		@Override
		public void run() {
			super.run();
			System.out.println("å®¢æˆ·ç«¯è¿æ¥æˆåŠŸ");
			
			InputStream inputStream = null;
			try {
				inputStream = client.getInputStream();
				byte[] buffer = new byte[256];
				int size = inputStream.read(buffer);
				ByteBuffer byteBuffer = ByteBuffer.wrap(buffer);
				// æŒ‰é¡ºåºè·å–æ•°æ®
				byte byteMsg = byteBuffer.get();
				char charMsg = byteBuffer.getChar();
				short shortMsg = byteBuffer.getShort();
				int intMsg = byteBuffer.getInt();
				long longMsg = byteBuffer.getLong();
				String stringMsg = new String(buffer, byteBuffer.position(), size - byteBuffer.position() - 1);
				System.out.println("æœåŠ¡ç«¯æ¥æ”¶åˆ°ï¼š" + byteMsg);
				System.out.println("æœåŠ¡ç«¯æ¥æ”¶åˆ°ï¼š" + charMsg);
				System.out.println("æœåŠ¡ç«¯æ¥æ”¶åˆ°ï¼š" + shortMsg);
				System.out.println("æœåŠ¡ç«¯æ¥æ”¶åˆ°ï¼š" + intMsg);
				System.out.println("æœåŠ¡ç«¯æ¥æ”¶åˆ°ï¼š" + longMsg);
				System.out.println("æœåŠ¡ç«¯æ¥æ”¶åˆ°ï¼š" + stringMsg);
				
			} catch (IOException e) {
				e.printStackTrace();
			} finally {
				if (inputStream != null) {
					try {
						inputStream.close();
					} catch (IOException e) {
						e.printStackTrace();
					}
				}
			}
			System.out.println("å®¢æˆ·ç«¯è¿æ¥æ–­å¼€");
		}
	}
}

// client
public class MySocketClient {
	private static final int CLIENT_PORT = 20001;
	
	public static void main(String[] args) throws IOException {
		Socket socket = new Socket();
		
		initClientSocket(socket);
		socket.connect(new InetSocketAddress(InetAddress.getLocalHost(), MySocketServer.PORT));
		System.out.println("å®¢æˆ·ç«¯è¿æ¥æˆåŠŸ");
		try {
			sendMessage(socket);
			// é‡Šæ”¾èµ„æº
			socket.close();
			System.out.println("å®¢æˆ·ç«¯å·²é€€å‡ºï½");
		} catch (Exception e) {
			e.printStackTrace();
			System.out.println("å®¢æˆ·ç«¯å¼‚å¸¸é€€å‡ºï½");
		}
	}
	
	private static void sendMessage(Socket socket) throws IOException {
		// å‘æœåŠ¡å™¨å‘é€æ•°æ®
		byte[] buffer = new byte[256];
		OutputStream outputStream = socket.getOutputStream();
		// ä½¿ç”¨ByteBuffer
		ByteBuffer byteBuffer = ByteBuffer.wrap(buffer);
		byte byteMsg = 125;
		char charMsg = 'a';
		short shortMsg = 4343;
		int intMsg = 34343243;
		long longMsg = 3234827524L;
		byteBuffer.put(byteMsg);
		byteBuffer.putChar(charMsg);
		byteBuffer.putShort(shortMsg);
		byteBuffer.putInt(intMsg);
		byteBuffer.putLong(longMsg);
		String msg = "ä½ å¥½ï¼ŒæœåŠ¡ç«¯";
		byteBuffer.put(msg.getBytes());
		outputStream.write(buffer, 0, byteBuffer.position() + 1);
	
		// æ¥æ”¶æœåŠ¡å™¨è¿”å›
		InputStream inputStream = socket.getInputStream();
		int read = inputStream.read(buffer);
		System.out.println("æ”¶åˆ°æ•°é‡ï¼š" + read);
		inputStream.close();
		outputStream.close();
	}
	
	private static void initClientSocket(Socket socket) throws IOException {
		socket.setKeepAlive(true);
		socket.setSoTimeout(5000);
//		socket.setSendBufferSize(64*1024*1024);
		socket.bind(new InetSocketAddress(InetAddress.getLocalHost(), CLIENT_PORT));	
	}
}
```



## 5.UDPè¾…åŠ©TCPè¿›è¡ŒæœåŠ¡å‘ç°

**å®ç°æ–¹æ¡ˆ**ï¼š

1. é¦–å…ˆï¼ŒæœåŠ¡ç«¯å®šä¹‰ç»Ÿä¸€çš„æœåŠ¡å‘ç°ç«¯å£ï¼š`PROVIDER_PORT`. æ¯”å¦‚è¯´æ˜¯ 30010ã€‚

2. æœåŠ¡ç«¯å¯åŠ¨server-socketæœåŠ¡ã€‚ç„¶åå¯åŠ¨UDP-DatagramSocketï¼Œç›‘å¬åœ¨`PROVIDER_PORT`ç«¯å£ä¸Š, å½“ç›‘å¬åˆ°å®¢æˆ·ç«¯å‘è¿™ä¸ªç«¯å£å¹¿æ’­çš„æ¶ˆæ¯ï¼Œå›é€æœåŠ¡ç«¯server-socketåœ°å€ï¼›
3. å®¢æˆ·ç«¯searcheré€šè¿‡udpå¹¿æ’­æ¥æœç´¢æœåŠ¡ã€‚å®ƒå‘å½“å‰å±€åŸŸç½‘å¹¿æ’­åœ°å€çš„30010ç«¯å£ä¸Šå¹¿æ’­æ¶ˆæ¯ï¼›
4. æœåŠ¡ç«¯æ¥å—åˆ°å¹¿æ’­æ¶ˆæ¯åï¼Œè§£ææ¶ˆæ¯ä½“ã€‚å¦‚æœæ˜¯ä¹‹å‰çº¦å®šå¥½çš„æ¶ˆæ¯æ ¼å¼ï¼Œé‚£ä¹ˆå°±é€šè¿‡udpåè®®ï¼Œå‘å‘é€è€…å›é€ä¸€æ¡æ¶ˆæ¯ï¼Œä¼ é€è‡ªå·±çš„tcpæœåŠ¡åœ°å€å’Œç«¯å£ï¼›
5. æœåŠ¡Searcheræ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œè§£æå‡ºæœåŠ¡åœ°å€å’Œç«¯å£ï¼Œé€šè¿‡æœ¬åœ°tcpå®¢æˆ·ç«¯å»è¿›è¡Œè¿æ¥ï¼Œä¿æŒé€šä¿¡ï¼›

**ä»£ç ç¤ºä¾‹**ï¼š

https://gitee.com/dendi.ke/thread-demo/tree/2795f1429ab5431f5b05c88268b41c033a58450b/src/main/java/com/gs/example/servicefind	

**æ€»ç»“**ï¼š

â€‹	udpçš„DatagramSocketè¯»å–å’Œå‘é€éƒ½æ˜¯é€šè¿‡DatagramPacketçš„å¯¹è±¡æ¥è¿›è¡Œï¼ŒPacketå¾—åˆ°çš„æ•°æ®éƒ½æ˜¯byte[], å¯ä»¥ç”¨ByteBufferåŒ…è£…ä¸€å±‚ã€‚

â€‹	socketçš„æ•°æ®è¯»å–å¯ä»¥é€šè¿‡BufferReaderæ¥åŒ…è£…socketçš„outputStreamï¼›

â€‹	socketçš„æ•°æ®å‘é€ï¼Œå¯ä»¥é€šè¿‡PrintStreamæ¥åŒ…è£…socketçš„inputStream;



- #### ä¼˜åŒ–æ”¹è¿›ï¼šä½¿ç”¨å¤šçº¿ç¨‹ï¼Œæ¥åŒæ—¶å¤„ç†æœåŠ¡ç«¯çš„å‘é€å’Œä¿¡æ¯è¯»å–

å®ç°æ–¹æ¡ˆï¼š

```mermaid
graph TD
1[æœåŠ¡ç«¯å¯åŠ¨socketSeverå&nbspä¸»çº¿ç¨‹é˜»å¡ç­‰å¾…å‘½ä»¤è¡Œè¾“å…¥] --> 2[å¯åŠ¨ç›‘å¬çº¿ç¨‹&nbspç›‘å¬å®¢æˆ·ç«¯è¿æ¥]
2 --> 3[å®¢æˆ·ç«¯æ¥å…¥&nbspåˆ›å»ºclientHandler]
subgraph ReadThread
3 --> 4[clientHandlerå¯åŠ¨readThread]
4 --> 4.1[è¯»å–ä¿¡æ¯å¹¶æ‰“å°æ¶ˆæ¯]
4.1 --> 6{readlineæ˜¯å¦ä¸ºnull}
6 -->|æ˜¯|8[è‡ªå·±é€€å‡º]
6 -->|å¦|4.1
end
subgraph WriteThread é€šè¿‡çº¿ç¨‹æ± æ¥è¾“å‡º
3 --> 5[clientHandlerå¯åŠ¨writeThread&nbspå‘é€å‘½ä»¤è¡Œè¾“å…¥æ¶ˆæ¯]
5 --> 7{æ¶ˆæ¯æ˜¯å¦ä¸ºexit}
7 -->|å¦|7.1[OutputStreamå‘é€æ¶ˆæ¯]
7 -->|æ˜¯|7.2[é€€å‡º]
end

```



**ä»£ç è·¯å¾„**ï¼šhttps://gitee.com/dendi.ke/thread-demo/commit/1c8b87ab45b6ce38956d27bd3e32738023b11228





## 6.BIOä¸NIO

> èƒŒæ™¯ï¼šæœåŠ¡ç«¯å½±å“æ€§èƒ½çš„æœ€å¤§ç“¶é¢ˆåœ¨äºIOçš„å¤„ç†ã€‚å•çº¯çš„ä½¿ç”¨çº¿ç¨‹å¹¶å‘å¤„ç†ï¼Œå½“å®¢æˆ·ç«¯è¿æ¥è¿‡å¤šæ—¶ï¼Œåˆ›å»ºçš„çº¿ç¨‹æ•°é‡è¿‡å¤šï¼Œå¯¼è‡´cpué¢‘ç¹è°ƒåº¦çº¿ç¨‹ï¼ŒåŒæ ·ä¼šå½±å“æ€§èƒ½ã€‚

### **ç½‘ç»œæ¨¡å‹**ï¼š**BIO**

åŸºäºæµçš„ä¼ è¾“

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-10-120806.png" alt="image-20191110200805834" style="zoom:40%;" />

1.æœåŠ¡ç«¯å¯åŠ¨ç›‘å¬çº¿ç¨‹ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ï¼›

2.å®¢æˆ·ç«¯å‘é€è¿æ¥è¯·æ±‚ã€‚

3.å®¢æˆ·ç«¯é€šè¿‡åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼ï¼Œå¤„ç†å®¢æˆ·ç«¯çš„è¯»ã€å†™æ“ä½œï¼›

4.æœåŠ¡ç«¯çº¿ç¨‹ä¸æ–­ç­‰å¾…å®¢æˆ·ç«¯çš„æ¶ˆæ¯ï¼›

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-10-120843.png" alt="image-20191110200842632" style="zoom:50%;" />

**ç¼ºç‚¹**ï¼šBIOæœ€å¤§çš„é—®é¢˜åœ¨äºï¼Œå½“å®¢æˆ·ç«¯è¿æ¥è¿‡å¤šæ—¶ï¼ŒæœåŠ¡ç«¯ä¼šå»ºç«‹è¿‡å¤šçš„çº¿ç¨‹ï¼Œå¯¼è‡´æœåŠ¡å™¨ç«¯æ— æ³•æ‰¿å—å‹åŠ›è€Œå´©æºƒã€‚ï¼›



### **ç½‘ç»œæ¨¡å‹ï¼šNIO**

NIOæ˜¯é¢å‘bufferçš„ä¼ è¾“ï¼›

NIOæ ¸å¿ƒæ€æƒ³ï¼šNIOæä¾›å•çº¿ç¨‹çš„selectorï¼Œå¤šè·¯å¤ç”¨ï¼Œç”¨æ¥æ³¨å†Œäº‹ä»¶å’Œç›‘å¬äº‹ä»¶ï¼›selectorå¾ªç¯æ£€æµ‹ï¼Œå½“æ³¨å†Œçš„channelçŠ¶æ€å˜åŒ–æ—¶ï¼Œå†é€šçŸ¥å„ä¸ªchannelè¿›è¡Œå¯¹åº”å¤„ç†ï¼›

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-10-123127.png" alt="image-20191110203126332" style="zoom:50%;" />

1.é¦–å…ˆåœ¨selectorä¸Šæ³¨å†Œç›‘å¬å®¢æˆ·ç«¯è¿æ¥äº‹ä»¶ï¼›

2.å®¢æˆ·ç«¯å‘é€è¿æ¥è¯·æ±‚ï¼›

3.selectoré€šçŸ¥å¯åŠ¨çº¿ç¨‹ï¼Œå¤„ç†å®¢æˆ·ç«¯è¿æ¥ï¼Œå¹¶ä¸”å»ºç«‹ä¸å®¢æˆ·ç«¯çš„è¿æ¥ï¼›

4.åŒæ—¶å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯è¿æ¥çš„socketå‘selectoræ³¨å†Œç›‘å¬â€œsocketå¯è¯»â€äº‹ä»¶

5.å®¢æˆ·ç«¯å‘é€æ•°æ®ï¼Œselectoré€šçŸ¥äº‹ä»¶ï¼Œå¯åŠ¨çº¿ç¨‹ï¼ˆæ¯”å¦‚æ˜¯çº¿ç¨‹æ± ï¼‰ï¼Œå¤„ç†å®¢æˆ·ç«¯çš„è¯»å†™æ“ä½œï¼Œå“åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼›

6.æœ€åï¼Œè¿™ä¸ªçº¿ç¨‹ä¹Ÿä¼šå‘selectoræ³¨å†Œâ€œsokcetå¯å†™â€äº‹ä»¶ï¼›



**NIOçš„ä¼˜ç‚¹**ï¼šæ‰€æœ‰çš„é˜»å¡æ“ä½œéƒ½æ˜¯é›†ä¸­åœ¨selectorä¸Šã€‚å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„å¤„ç†çº¿ç¨‹éƒ½å‡ ä¹æ˜¯éé˜»å¡çš„ï¼Œä¸éœ€è¦å»ç­‰å¾…è¿æ¥ï¼Œç­‰å¾…è¯»å–ã€‚å¤§å¤§å‡å°‘äº†æœåŠ¡ç«¯çš„çº¿ç¨‹æ•°é‡ï¼›





### NIOçš„ç›¸å…³æ¦‚å¿µ

#### Selector

> Selectoræ˜¯Java NIOæ ¸å¿ƒç»„ä»¶ä¸­çš„ä¸€ä¸ªï¼Œç”¨äºæ£€æŸ¥ä¸€ä¸ªæˆ–å¤šä¸ªNIO Channelçš„çŠ¶æ€æ˜¯å¦å¤„äºå¯è¯»ã€å¯å†™ï¼›

**SelectionKey**

- Connect, è¿æ¥äº‹ä»¶(TCP è¿æ¥), å¯¹åº”äºSelectionKey.OP_CONNECT

- Accept, ç¡®è®¤äº‹ä»¶, å¯¹åº”äºSelectionKey.OP_ACCEPT

- Read, è¯»äº‹ä»¶, å¯¹åº”äºSelectionKey.OP_READã€‚

  - å½“ä¸€ä¸ª`channel`**å‡†å¤‡**å¥½å¯ä»¥è¢«è¯»å–(æ¯”å¦‚socketå·²ç»è¯»åˆ°äº†æ–°çš„å­—èŠ‚ï¼Œå…¶Read Bufferæœ‰å°šæœªè¢«åº”ç”¨è¯»å–çš„æ•°æ®ï¼Œå¯é€šçŸ¥åº”ç”¨ç¨‹åºä»è¯»å–ç¼“å†²åŒºè¿›è¡Œè¯»å–ï¼‰ï¼›

  - å·²ç»åˆ°è¾¾æ•°æ®æµçš„ç»“å°¾

  - è¿œç¨‹å¦ä¸€ç«¯å·²ç»å…³é—­æˆ–è€…å‘ç”Ÿé”™è¯¯æ—¶ï¼Œéƒ½ä¼šå°†è¯¥äº‹ä»¶åŠ å…¥åˆ°è¯¥`key`çš„`ready set`ä¸­ï¼Œå¹¶å°†è¯¥`key`åŠ å…¥åˆ°`selected-key set`ä¸­ã€‚

- Write, å†™äº‹ä»¶, å¯¹åº”äºSelectionKey.OP_WRITEã€‚

  - å½“ä¸€ä¸ª`channel` **å‡†å¤‡**å¥½è¿›è¡Œå†™å…¥æ“ä½œï¼ˆæ¯”å¦‚åŸå…ˆsocketå†™å…¥ç¼“å†²å·²æ»¡ï¼Œç°åœ¨å·²ç»å‘é€äº†éƒ¨åˆ†æ•°æ®ï¼Œå†™å…¥ç¼“å†²è…¾å‡ºäº†ä¸€äº›ç©ºé—´ï¼Œå°±ä¼šé€šçŸ¥åº”ç”¨ç¨‹åºè¿›è¡Œå†™å…¥ï¼‰
  - è¿œç¨‹å¦ä¸€ç«¯å·²ç»å…³é—­æˆ–è€…å‘ç”Ÿé”™è¯¯æ—¶ï¼Œéƒ½ä¼šå°†è¯¥äº‹ä»¶åŠ å…¥åˆ°è¯¥`key`çš„`ready set`ä¸­ï¼Œå¹¶å°†è¯¥`key`åŠ å…¥åˆ°`selected-key set`ä¸­ã€‚ 

  

**ç›¸å…³æ“ä½œ**

openï¼š åˆ›å»ºä¸€ä¸ªselectorï¼Œselectorç”±ç³»ç»Ÿå±‚é¢çš„æ–¹æ³•è°ƒç”¨ï¼›

wakeup: å¯ä»¥ä»éselectè°ƒç”¨çš„çº¿ç¨‹å»å”¤é†’é˜»å¡åœ¨selectè°ƒç”¨ä¸Šçš„çº¿ç¨‹

selectï¼šå½“æ³¨å†Œçš„äº‹ä»¶åˆ°è¾¾æ—¶ï¼Œè¿”å›ã€‚å¦åˆ™ï¼Œä¼šä¸€ç›´é˜»å¡ï¼›



#### SelectionKey

`interesté›†åˆ`: keyå…³è”çš„channelæ‰€é€‰æ‹©çš„æ„Ÿå…´è¶£çš„äº‹ä»¶é›†åˆã€‚å¯ä»¥é€šè¿‡SelectionKeyè¯»å†™interesté›†åˆã€‚

`readyé›†åˆ`ï¼šé€šé“å·²ç»å‡†å¤‡å°±ç»ªçš„æ“ä½œçš„é›†åˆã€‚åœ¨ä¸€æ¬¡é€‰æ‹©(Selection)ä¹‹åï¼Œä½ ä¼šé¦–å…ˆè®¿é—®è¿™ä¸ªready setã€‚

#### Channel

ServerSocketChannel: æœåŠ¡ç«¯socket channelã€‚ä¸€èˆ¬åªæ³¨å†ŒAcceptäº‹ä»¶ï¼›

SocketChannelï¼šå®¢æˆ·ç«¯socket channelã€‚ä¸€èˆ¬è¿æ¥åï¼Œæ³¨å†Œconnectäº‹ä»¶ã€‚



**æ³¨æ„**ï¼š

æ³¨å†Œäº‹ä»¶åªæ˜¯å‘Šè¯‰`selector`åœ¨æ£€æµ‹åˆ°å„ç§äº‹ä»¶å‡†å¤‡å¥½å¯ä»¥æ‰§è¡Œæ—¶å‘Šè¯‰åº”ç”¨ï¼Œåº”ç”¨å¯ä»¥æ‰§è¡Œç›¸åº”çš„äº‹ä»¶ï¼Œä½†æ˜¯æ³¨å†Œæ„Ÿå…´è¶£çš„äº‹ä»¶**å¹¶ä¸æ˜¯å¿…é¡»çš„**ï¼ï¼æ²¡æœ‰æ³¨å†Œäº‹ä»¶ä¾ç„¶å¯ä»¥è¿›è¡Œè¯»å–ã€å†™å…¥æ“ä½œã€‚

æ¯”å¦‚è¯»å–æ“ä½œï¼Œå¦‚æœä¸æ³¨å†Œ`OP_READ`äº‹ä»¶ï¼Œåº”ç”¨ç¨‹åºä¾ç„¶å¯ä»¥éšæ—¶å°è¯•ä»`channel`ä¸­è¯»å–æ•°æ®ï¼Œä½†æ˜¯å¹¶ä¸èƒ½ä¿è¯è¯»å–æˆåŠŸï¼Œå› ä¸ºå¯èƒ½`socket`è¯»å–ç¼“å†²åŒºä¸­å¯èƒ½å¹¶ä¸å­˜åœ¨æ•°æ®ã€‚ä½†æ˜¯å¦‚æœæ³¨å†Œäº†`OP_READ`äº‹ä»¶ï¼Œåœ¨`selector`æ£€æµ‹åˆ°è¯¥äº‹ä»¶å‡†å¤‡å¥½äº†å†å»è¯»å–ï¼Œåˆ™å¯ä»¥æœ€å¤§ç¨‹åº¦ä¸Šçš„ä¿è¯å¯ä»¥è¯»åˆ°æ•°æ®ã€‚

å†™å…¥ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ï¼Œä¸æ³¨å†Œ`OP_WRITE`åº”ç”¨ç¨‹åºä¹Ÿå¯ä»¥éšæ—¶è¿›è¡Œå†™å…¥ï¼Œåªæ˜¯å¯èƒ½å› ä¸ºç¼“å†²åŒºæ»¡è€Œå†™å…¥å¤±è´¥ã€‚æ³¨å†Œ`OP_WRITE`äº‹ä»¶ï¼Œåœ¨`selector`æ£€æµ‹åˆ°è¯¥äº‹ä»¶æ—¶å†è¿›è¡Œå†™å…¥ï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦ä¸Šä¿è¯å†™å…¥æˆåŠŸã€‚





#### Buffer

> Bufferæ˜¯å”¯ä¸€æ“ä½œchannelçš„æ–¹å¼ï¼Œæ˜¯ç”¨æˆ·æ•°æ®å¤„ç†çš„åŸºç¡€å•å…ƒã€‚
>
> http://blog.ztgreat.cn/article/43

4ä¸ªå…³é”®å±æ€§ï¼š

- capacity å®¹é‡
- position å½“å‰ä½ç½®
- limit é™åˆ¶
- mark æ ‡è®°ä½ç½®

è¯»å†™åˆ‡æ¢æ—¶ï¼špositionä¼šé‡ç½®ä¸º0ï¼Œlimitä¼šåˆ‡æ¢ä¸ºå†™çš„ä½ç½®ï¼›

è¯»æ¨¡å¼ï¼šæ¯æ¬¡getåï¼Œpositionéƒ½ä¼šåç§»ä¸€ä½ï¼›

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-13-131220.png" alt="image-20191113211219895" style="zoom:50%;" />

å†™æ¨¡å¼ï¼š

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-13-131233.png" alt="image-20191113211233163" style="zoom:50%;" />

flipæ“ä½œï¼šflipä¼šè¿›è¡Œç¿»è½¬ï¼ŒæŠŠlimitè®¾ç½®ä¸ºå½“å‰positionä½ç½®ï¼ŒæŠŠpositionå˜ä¸º0ï¼Œå¯ä»¥ä»åˆå§‹ä½ç½®å¼€å§‹è¿›è¡Œè¯»æ“ä½œï¼›

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-13-131422.png" alt="image-20191113211421721" style="zoom:50%;" />



resetæ“ä½œï¼šå¯ä»¥ç”¨markæ–¹æ³•å¯ä»¥å½“å‰æ ‡è®°ä½ç½®ï¼Œresetåå›åˆ°æ ‡è®°ä½ç½®ï¼›



#### Zero-Copy

> https://mp.weixin.qq.com/s?__biz=MzU0MzQ5MDA0Mw==&mid=2247483913&idx=1&sn=2da53737b8e8908cf3efdae9621c9698&chksm=fb0be89dcc7c618b0d5a1ba8ac654295454cfc2fa81fbae5a6de49bf0a91a305ca707e9864fc&scene=21#wechat_redirect

æ¦‚è¿°ï¼š

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-11-232613.png" alt="image-20191112072612350" style="zoom:40%;" />

ä¼ ç»Ÿçš„IOè¯»å†™ä¸­ï¼Œç³»ç»Ÿè¯»å†™æ–‡ä»¶æ—¶ï¼Œç»å†äº†ä»¥ä¸‹æ­¥éª¤ï¼š

1.ä»IOè®¾å¤‡æ‹·è´åˆ°kernel spaceã€‚

2.ä»kernel space copy åˆ° user space

3.æ¥ä¸‹æ¥ï¼Œå¦‚æœç³»ç»Ÿéœ€è¦å¯¹æ–‡ä»¶è¿›è¡Œwriteæ“ä½œï¼Œç³»ç»Ÿä¼šå†æŠŠuser spaceçš„å†…å®¹æ‹·è´åˆ°kernel spaceä¸­ï¼Œæœ€åå†å¾€å¯¹æ–¹çš„sockå‘é€è¿™äº›æ•°æ®ã€‚

æ•´ä¸ªè¿‡ç¨‹æ€»å…±å‘ç”Ÿäº†å››æ¬¡æ‹·è´ã€‚å¹¶ä¸”å‘ç”Ÿäº†å››æ¬¡çš„ç”¨æˆ·æ€å’Œå†…æ ¸æ€åˆ‡æ¢ã€‚

ä½†æ˜¯æˆ‘ä»¬å¯ä»¥å‘ç°ä¸€ä¸ªé—®é¢˜

*ä¸ºä»€ä¹ˆIOéœ€è¦å°†æ•°æ®ä»kernelï¼ˆç³»ç»Ÿå†…æ ¸æ€ï¼‰æ‹·è´åˆ°userï¼ˆç”¨æˆ·æ€ï¼‰ï¼Œå†æ‹·è´å›kernelæ€ï¼Ÿ*

å¸¦ç€è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æå‡ºä»¥ä¸‹æ”¹è¿›



æ”¹è¿›1ï¼šå¯ä»¥å¾ˆå®¹æ˜“çš„å‘ç°ï¼Œ2ï¼Œ3çš„copyæ“ä½œå®é™…ä¸Šæ˜¯æµªè´¹èµ„æºï¼Œå¯ä»¥çœç•¥ã€‚

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-11-233840.png" alt="image-20191112073839594" style="zoom:40%;" />

1. é¦–å…ˆï¼ˆé€šè¿‡DMAï¼‰å°†æ•°æ®ä»ç£ç›˜è¯»å–åˆ°kernel bufferä¸­ï¼›
2. ç„¶åå°†kernel bufferæ‹·è´åˆ°socket bufferä¸­ï¼›
3. æœ€åå°†socket bufferä¸­çš„æ•°æ®copyåˆ°ç½‘å¡è®¾å¤‡ï¼ˆprotocol engineï¼‰ä¸­å‘é€

ä½†è¿™å¹¶ä¸æ˜¯`zero-copy`ï¼Œå› ä¸ºç¬¬2æ­¥çš„copyå…¶å®ä¹Ÿæ˜¯æ²¡æœ‰å¿…è¦çš„ã€‚



æ”¹è¿›2ï¼š

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-11-234408.png" alt="image-20191112074407565" style="zoom:40%;" />

1. å°†æ–‡ä»¶æ‹·è´åˆ°kernel bufferä¸­ï¼›
2. å‘socket bufferä¸­è¿½åŠ å½“å‰è¦å‘ç”Ÿçš„æ•°æ®åœ¨kernel bufferä¸­çš„ä½ç½®å’Œåç§»é‡ï¼›
3. æ ¹æ®socket bufferä¸­çš„ä½ç½®å’Œåç§»é‡ç›´æ¥å°†kernel bufferçš„æ•°æ®copyåˆ°ç½‘å¡è®¾å¤‡ï¼ˆprotocol engineï¼‰ä¸­ï¼›

å®é™…ä¸Šï¼Œä¸Šé¢çš„æ“ä½œå°±æ˜¯çœŸæ­£çš„NIOåŸç†



### NIOçš„ç›¸å…³æ“ä½œ

#### 1.è¯»å–SocketChannel

```java
ByteBuffer buf = ByteBuffer.allocate(48);

int bytesRead = socketChannel.read(buf);
```

1. åˆ†é…bufferï¼Œç”¨æ¥ä¿å­˜socketchannelè¯»å–åˆ°çš„æ•°æ®
2. è°ƒç”¨readæ–¹æ³•ï¼Œå°† `SocketChannel`çš„æ•°æ®è¯»å–åˆ° `Buffer`ã€‚è¿”å›çš„`int`å€¼å‘Šè¯‰æˆ‘ä»¬æœ‰å¤šå°‘å­—èŠ‚å†™åˆ°äº†Bufferé‡Œï¼Œå¦‚æœè¿”å›äº†-1ï¼Œè¡¨ç¤ºå·²ç»è¿æ¥å·²å…³é—­ï¼Œåˆ°äº†æ•°æ®æµç»“å°¾

#### 2. å†™å…¥SocketChannel

```java
String newData = "New String to write to file..." + System.currentTimeMillis();

ByteBuffer buf = ByteBuffer.allocate(48);
buf.clear();
buf.put(newData.getBytes());

buf.flip();

while(buf.hasRemaining()) {
    channel.write(buf);
}
```

æ³¨æ„ `SocketChannel.write()` æ–¹æ³•æ˜¯åœ¨å¾ªç¯é‡Œè¢«è°ƒç”¨çš„ã€‚ç”±äºæ— æ³•ä¿è¯æ¯æ¬¡æœ‰å¤šå°‘æ•°æ®è¢«è¯»å–åˆ°äº†SocketChannelé‡Œï¼Œå› æ­¤éœ€è¦é‡å¤è°ƒç”¨write()æ–¹æ³•ç›´åˆ°`Buffer`é‡Œä¸å†æœ‰å­—èŠ‚è¾“å‡ºã€‚





**è¸©å‘è®°å½•**1ï¼š

åˆå­¦çš„æ—¶å€™ï¼Œç»å¸¸å‚»ä¹ä¹çš„åœ¨å»ºç«‹è¿æ¥åé©¬ä¸Šæ³¨å†ŒWriteç­‰äº‹ä»¶ï¼ŒæœŸå¾…ç­‰å†™äº‹ä»¶é€šçŸ¥åˆ°å†å»å‘é€æ•°æ®ã€‚å®é™…ä¸Šå¯¹è¿™äº›ç‰¹åˆ«ä¸ç†è§£ï¼›

å†™æ“ä½œçš„å°±ç»ªæ¡ä»¶ä¸ºåº•å±‚ç¼“å†²åŒºæœ‰ç©ºé—²ç©ºé—´ï¼Œè€Œå†™ç¼“å†²åŒºç»å¤§éƒ¨åˆ†æ—¶é—´éƒ½æ˜¯æœ‰ç©ºé—²ç©ºé—´çš„ï¼Œæ‰€ä»¥å½“ä½ æ³¨å†Œå†™äº‹ä»¶åï¼Œå†™æ“ä½œä¸€ç›´æ˜¯å°±ç»ªçš„ï¼Œé€‰æ‹©å¤„ç†çº¿ç¨‹å…¨å ç”¨æ•´ä¸ªCPUèµ„æºã€‚

æœ€å¥½çš„æ–¹æ³•æ˜¯ï¼Œå½“ä½ ç¡®å®æœ‰æ•°æ®è¦å†™æ—¶ï¼Œå†æ³¨å†Œå†™æ“ä½œï¼Œå¹¶åœ¨å†™å®Œä»¥åé©¬ä¸Šå–æ¶ˆæ³¨å†Œã€‚



æˆ–è€…**ä¸å»æ³¨å†Œå†™äº‹ä»¶**ï¼Œæœ‰è¦å†™çš„æ•°æ®åˆ™ç›´æ¥å†™æ•°æ®è‡³`Channel`å³å¯ï¼Œå†™å…¥å¤±è´¥åˆ™è¡¨ç¤º`Channel`æš‚æ—¶æ²¡æœ‰å‡†å¤‡å¥½è¢«å†™å…¥ï¼Œæ­¤æ—¶åº”ç”¨å¯ä»¥å‘`Channel`æ³¨å†Œå†™äº‹ä»¶ï¼Œè®©`Channel`åœ¨å‡†å¤‡å¥½æ¥æ”¶å†™äº‹ä»¶æ—¶å‘Šè¯‰åº”ç”¨ï¼Œä½†æ˜¯ä¸€æ—¦åº”ç”¨å†™å®Œæ‰€æœ‰çš„æ•°æ®ï¼Œåˆ™ä¸€èˆ¬ä¼šå–æ¶ˆæ³¨å†Œçš„å†™äº‹ä»¶ï¼Œå› ä¸ºå¦‚æœæ•°æ®å†™å®Œäº†ï¼Œä½†æ˜¯æ²¡æœ‰å–æ¶ˆæ³¨å†Œçš„å†™äº‹ä»¶ï¼Œ`Selector.select`æ–¹æ³•å¯èƒ½ä¼šç»å¸¸å› ä¸ºæœ‰å†™äº‹ä»¶å‡†å¤‡å®Œæ¯•è€Œè¿”å›ï¼Œä½†æ˜¯åº”ç”¨å´æ— æ•°æ®éœ€è¦å†™ã€‚



**è¸©å‘è®°å½•**2ï¼š

èµ·åˆå¯¹`OP_CONNECT`äº‹ä»¶è¿˜æœ‰`finishConnect`ä¸ç†è§£ï¼Œ`OP_CONNECT`äº‹ä»¶ä½•æ—¶è§¦å‘ï¼Œç‰¹åˆ«æ˜¯ä¸ºä»€ä¹ˆè¦åœ¨`key.isConnectable()`åˆ†æ”¯é‡Œè°ƒç”¨`finishConnect`æ–¹æ³•åæ‰èƒ½è¿›è¡Œè¯»å†™æ“ä½œã€‚

é¦–å…ˆï¼Œåœ¨`non-blocking`æ¨¡å¼ä¸‹è°ƒç”¨`socketChannel.connect(new InetSocketAddress("127.0.0.1",8080));`è¿æ¥è¿œç¨‹ä¸»æœºï¼Œå¦‚æœè¿æ¥èƒ½ç«‹å³å»ºç«‹å°±åƒæœ¬åœ°è¿æ¥ä¸€æ ·ï¼Œè¯¥æ–¹æ³•ä¼šç«‹å³è¿”å›`true`ï¼Œå¦åˆ™è¯¥æ–¹æ³•ä¼šç«‹å³è¿”å›`false`,ç„¶åç³»ç»Ÿåº•å±‚è¿›è¡Œä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥ã€‚è¿æ¥æœ‰ä¸¤ç§ç»“æœï¼Œä¸€ç§æ˜¯æˆåŠŸè¿æ¥ï¼Œç¬¬äºŒç§æ˜¯å¼‚å¸¸ï¼Œä½†æ˜¯`connect`æ–¹æ³•å·²ç»è¿”å›ï¼Œæ— æ³•é€šè¿‡è¯¥æ–¹æ³•çš„è¿”å›å€¼æˆ–è€…æ˜¯å¼‚å¸¸æ¥é€šçŸ¥ç”¨æˆ·ç¨‹åºå»ºç«‹è¿æ¥çš„æƒ…å†µï¼Œæ‰€ä»¥ç”±`OP_CONNECT`äº‹ä»¶å’Œ`finishConnect`æ–¹æ³•æ¥é€šçŸ¥ç”¨æˆ·ç¨‹åºã€‚ä¸ç®¡ç³»ç»Ÿåº•å±‚ä¸‰æ¬¡è¿æ¥æ˜¯å¦æˆåŠŸï¼Œ`selector`éƒ½ä¼šè¢«å”¤é†’ç»§è€Œè§¦å‘`OP_CONNECT`äº‹ä»¶ï¼Œå¦‚æœæ¡æ‰‹æˆåŠŸï¼Œå¹¶ä¸”è¯¥è¿æ¥æœªè¢«å…¶ä»–çº¿ç¨‹å…³é—­ï¼Œ`finishConnect`ä¼šè¿”å›`true`ï¼Œç„¶åå°±å¯ä»¥é¡ºåˆ©çš„è¿›è¡Œ`channle`è¯»å†™ã€‚å¦‚æœç½‘ç»œæ•…éšœï¼Œæˆ–è€…è¿œç¨‹ä¸»æœºæ•…éšœï¼Œæ¡æ‰‹ä¸æˆåŠŸï¼Œç”¨æˆ·ç¨‹åºå¯ä»¥é€šè¿‡`finishConnect`æ–¹æ³•è·å¾—åº•å±‚çš„å¼‚å¸¸é€šçŸ¥ï¼Œè¿›è€Œå¤„ç†å¼‚å¸¸ã€‚



**è¸©å‘è®°å½•3ï¼šå¤„ç†OP_WRITE**
OP_WRITEå¤„ç†ä¸å½“å¾ˆå®¹æ˜“å¯¼è‡´CPU 100%
**OP_WRITEè§¦å‘æ¡ä»¶**ï¼š
  å‰æ: interestäº†OP_WRITE
  **è§¦å‘æ¡ä»¶**:

-  socketå‘é€ç¼“å†²åŒºå¯å†™    

-  è¿œç«¯å…³é—­
-  æœ‰é”™è¯¯å‘ç”Ÿ

**æ­£ç¡®çš„å¤„ç†æ–¹å¼**ï¼š

-   ä»…åœ¨å·²ç»è¿æ¥çš„channelä¸Šæ³¨å†Œ
-   ä»…åœ¨æœ‰æ•°æ®å¯å†™çš„æ—¶å€™æ‰æ³¨å†Œ
-   è§¦å‘ä¹‹åç«‹å³å–æ¶ˆæ³¨å†Œï¼Œå¦åˆ™ä¼šç»§ç»­è§¦å‘å¯¼è‡´å¾ªç¯
-   å¤„ç†å®Œæˆåè§†æƒ…å†µå†³å®šæ˜¯å¦ç»§ç»­æ³¨å†Œï¼Œ
    å¦‚æœæ²¡æœ‰å®Œå…¨å†™å…¥ï¼Œç»§ç»­æ³¨å†Œ
    å¦‚æœå…¨éƒ¨å†™å…¥ï¼Œæ— éœ€æ³¨å†Œ



eg: æœ‰å†™æ•°æ®éœ€æ±‚æ—¶è®¢é˜…OP_WRITEäº‹ä»¶,æ•°æ®å‘é€å®Œæˆå–æ¶ˆè®¢é˜….

[https://tech.fenxiangz.com/topic/77/nio-%E5%90%84%E7%A7%8D%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E7%82%B9](https://tech.fenxiangz.com/topic/77/nio-å„ç§ä½¿ç”¨æ³¨æ„ç‚¹)





## 7.NIOå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯

### NIOå®ç°CSæ¨¡å‹çš„æµç¨‹

#### æœåŠ¡ç«¯

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-19-221145.png" alt="image-20191120061144474" style="zoom:50%;" />

#### å®¢æˆ·ç«¯

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-19-221910.png" alt="image-20191120061909011" style="zoom:50%;" />

#### ä»£ç å®ä¾‹

ç›‘å¬å®¢æˆ·ç«¯çš„åˆ°è¾¾ï¼›

```java
Selector selector = Selector.open();
ServerSocketChannel serverChannel = ServerSocketChannel.open();
serverChannel.configureBlocking(false);
serverChannel.bind(new InetSocketAddress(InetAddress.getLocalHost(), 8000));
// ç›‘å¬
serverChannel.register(selector, SelectionKey.OP_ACCEPT);
System.out.println("æœåŠ¡ç«¯åœ°å€:" + serverChannel.getLocalAddress());

while(true) {
  int length = selector.select();
  if (length >= 0) {
    Set<SelectionKey> selectionKeys = selector.selectedKeys();
    Iterator<SelectionKey> selectionKeyIterator = selectionKeys.iterator();
    while (selectionKeyIterator.hasNext()) {
      SelectionKey selectionKey = selectionKeyIterator.next();
      // ç§»é™¤key
      selectionKeyIterator.remove();
      if (selectionKey.isAcceptable()) {
        ServerSocketChannel serverSocketChannel = (ServerSocketChannel) selectionKey.channel();
        // ä¸€å®šå¯ä»¥æ‹¿åˆ°å®¢æˆ·ç«¯
        SocketChannel clientChannel = serverSocketChannel.accept();
        clientChannel.configureBlocking(false);
        new ClientHandler(clientChannel).start();
      }
    }
  }
}
```



æ¥å—å®¢æˆ·ç«¯æ•°æ®ï¼š

```java
readSelector = Selector.open();
				socketChannel.register(readSelector, SelectionKey.OP_READ);
				while(true) {
					int readCount = readSelector.select();
					if (readCount > 0) {
						Set<SelectionKey> selectionKeys = readSelector.selectedKeys();
						Iterator<SelectionKey> selectionKeyIterator = selectionKeys.iterator();
						while (selectionKeyIterator.hasNext()) {
							SelectionKey selectionKey = selectionKeyIterator.next();
							// ç§»é™¤key
							selectionKeyIterator.remove();
							if (selectionKey.isReadable()) {
								SocketChannel socketChannel = (SocketChannel) selectionKey.channel();
								ByteBuffer byteBuffer = ByteBuffer.allocate(256);
								socketChannel.read(byteBuffer);
								String receiveData = new String(byteBuffer.array(), 0, byteBuffer.position());
//							String receiveData= Charset.forName("UTF-8").decode(byteBuffer).toString();
								System.out.println("æœåŠ¡ç«¯æ¥æ”¶åˆ°æ•°æ®ï¼š" + receiveData);
								// å›é€å®¢æˆ·ç«¯æ•°æ®
                writeBuffer.clear();
								writeBuffer.put(("æœåŠ¡ç«¯æ¥æ”¶åˆ°æ•°æ®ï¼š" + receiveData).getBytes());
								writeBuffer.flip();
								while(writeBuffer.hasRemaining()){
									int len = socketChannel.write(writeBuffer);
									if (len > 0) {
										System.out.println("å†™å…¥æ•°æ®:" + len);
									} else {
										System.out.println("å®¢æˆ·ç«¯å·²æ— æ³•å‘é€æ•°æ®ï¼");
										break;
									}
								}
							}
						}
					}
				}
```



å®¢æˆ·ç«¯ç›‘å¬è¿æ¥æˆåŠŸï¼š

```java
Selector selector = Selector.open();
			SocketChannel socketChannel = SocketChannel.open();
			socketChannel.configureBlocking(false);
			boolean connected = socketChannel.connect(new InetSocketAddress(InetAddress.getLocalHost(), 2000));
			if (connected) {
				socketChannel.register(selector, SelectionKey.OP_READ);
				byte[] req = "ä½ å¥½ï¼ŒnioæœåŠ¡ç«¯342".getBytes();
				//ä¸ºå­—èŠ‚ç¼“å†²åŒºåˆ†é…æŒ‡å®šå­—èŠ‚å¤§å°çš„å®¹é‡
				ByteBuffer writeBuffer = ByteBuffer.allocate(req.length);
				//å°†å†…å®¹å†™å…¥ç¼“å†²åŒº
				writeBuffer.put(req);
				//åè½¬ç¼“å†²åŒº
				writeBuffer.flip();
				//è¾“å‡ºæ‰“å°ç¼“å†²åŒºçš„å¯è¯»å¤§å°
				System.out.println(writeBuffer.remaining());
				//å°†å†…å®¹å†™å…¥ç®¡é“ä¸­
				socketChannel.write(writeBuffer);
				if (!writeBuffer.hasRemaining()) {
					System.out.println("Send 2 server succeed.");
				}
			} else {
				socketChannel.register(selector, SelectionKey.OP_CONNECT);
			}
			System.out.println("å®¢æˆ·ç«¯å¯åŠ¨æˆåŠŸ");
			System.out.println("æœåŠ¡å™¨ä¿¡æ¯ï¼š" + socketChannel.getRemoteAddress().toString());
			// æ‹¿åˆ°å®¢æˆ·ç«¯æ•°æ®
			while (true) {
				int length = selector.select();
				if (length > 0) {
					Set<SelectionKey> selectionKeys = selector.selectedKeys();
					Iterator<SelectionKey> selectionKeyIterator = selectionKeys.iterator();
					while (selectionKeyIterator.hasNext()) {
						SelectionKey selectionKey = selectionKeyIterator.next();
						selectionKeyIterator.remove();
						if (selectionKey.isConnectable()) {
							SocketChannel channel = (SocketChannel) selectionKey.channel();
							if (channel.finishConnect()) {
								channel.register(selector, SelectionKey.OP_READ);
								ByteBuffer byteBuffer = ByteBuffer.allocate(256);
								byteBuffer.clear();
								byteBuffer.put("ä½ å¥½ï¼ŒnioæœåŠ¡ç«¯23432".getBytes());
								byteBuffer.flip();
								while (byteBuffer.hasRemaining()) {
									int len = channel.write(byteBuffer);
									if (len >= 0) {
										System.out.println("å†™å…¥æ•°æ®:" + len);
									} else {
										System.out.println("å®¢æˆ·ç«¯å·²æ— æ³•å‘é€æ•°æ®ï¼");
										break;
									}
								}
							}
						}
						if (selectionKey.isReadable()) {
							selectionKey.interestOps(selectionKey.interestOps() | ~SelectionKey.OP_READ);
							SocketChannel channel = (SocketChannel) selectionKey.channel();
							ByteBuffer buffer = ByteBuffer.allocate(256);
							buffer.clear();
							channel.read(buffer);
							buffer.flip();
							String msg = Charset.forName("utf-8").decode(buffer).toString();
							System.out.println("å®¢æˆ·ç«¯æ¥æ”¶åˆ°è¿”å›æ•°æ®[" + msg + "]");
						}
					}
				}
			}
```



### æ¶ˆæ¯åˆ°è¾¾é‡å¤è§¦å‘äº‹ä»¶

selecotrç›‘å¬åˆ°readäº‹ä»¶åï¼Œéœ€è¦å–æ¶ˆç»§ç»­å¯¹keyOpsçš„ç›‘å¬ã€‚

![image-20191120072613024](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-19-232613.png)

å¦åˆ™ï¼Œselectorä¸‹æ¬¡selectçš„æ—¶å€™ï¼Œä¾ç„¶èƒ½å¤ŸæŸ¥è¯¢åˆ°æœ‰selection-key



## 8.ç²˜åŒ…ä¸æ‹†åŒ…

### 8.1åŸºæœ¬æ¦‚å¿µ

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-16-131559.jpg" alt="img" style="zoom: 67%;" />

tcpæ˜¯é¢å‘è¿æ¥ã€ä¾é å­—èŠ‚æµä¼ è¾“çš„åè®®ã€‚

tcpæœ¬èº«åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œæ˜¯æœ‰åºçš„ä¸”å¯é çš„ã€‚

tcpåœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¸å­˜åœ¨ç²˜åŒ…æˆ–æ‹†åŒ…çš„è¯´æ³•ã€‚ç²˜åŒ…å’Œæ‹†åˆ†ä¸»è¦æ˜¯ç«™åœ¨ä¸Šå±‚ï¼ˆåº”ç”¨åœºæ™¯ã€ä¸šåŠ¡é€»è¾‘ï¼‰çš„è§’åº¦æ¥è¯´çš„ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-16-131714.jpg" alt="img" style="zoom:50%;" />

å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯ä¼ è¾“2ä¸ªæ•°æ®åŒ…ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼ŒæœåŠ¡ç«¯æ¥å—åˆ°çš„ä¹Ÿæ˜¯2ä¸ªæ•°æ®åŒ…ã€‚

ä½†æ˜¯å®¢æˆ·ç«¯åœ¨å‘é€è¿‡ç¨‹ä¸­ï¼Œç”±äºç¼“å­˜çš„åŸå› ï¼Œä¸¤ä¸ªæ•°æ®åŒ…åŒæ—¶åˆ°è¾¾ã€‚é‚£ä¹ˆæœåŠ¡ç«¯æ¥å—çš„æƒ…å†µå°±å˜æˆäº†ï¼š

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-16-131849.jpg" alt="img" style="zoom:53%;" />



è¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œç”±äºæœåŠ¡ç«¯çš„æ¥æ”¶ç¼“å­˜æ¯”è¾ƒå°ï¼Œè™½ç„¶å®¢æˆ·ç«¯å‘é€äº†1ä¸ªæ•°æ®åŒ…ï¼Œä½†æ˜¯æœåŠ¡ç«¯å¿…é¡»é€šè¿‡ä¸¤æ¬¡æ¥æ¥æ”¶ï¼Œè¿™æ ·å°±å¿…é¡»æ‹†åŒ…ï¼š

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-16-132611.png" alt="image-20191116212610271" style="zoom: 25%;" />



### 8.2è§£å†³æ–¹æ¡ˆ

ç”±äºç²˜åŒ…å’Œæ‹†åŒ…çš„ç°è±¡äº§ç”Ÿï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„æ•°æ®ä¼ è¾“ä¼šå‡ºç°ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š

a.ä¼ è¾“å­—ç¬¦ä¸²æ—¶ï¼Œå­—ç¬¦ä¸²è‡ªåŠ¨æ‹¼æ¥åœ¨ä¸€èµ·ï¼Œé€ æˆè§£æé”™è¯¯ï¼›ï¼ˆç²˜åŒ…é—®é¢˜ï¼‰

b.ä¼ é€’é•¿å­—ç¬¦ä¸²æ—¶ï¼Œè‡ªåŠ¨æ‹†åˆ†æˆäº†å¤šä¸ªå°çš„å­—ç¬¦ä¸²ï¼Œç”šè‡³è¿˜ä¼šè‡ªåŠ¨ä¸¢å¼ƒä¸­é—´çš„å­—ç¬¦ä¸²ã€‚ï¼ˆæ‹†åŒ…é—®é¢˜ï¼‰

ä¸€èˆ¬è§£å†³æ–¹æ¡ˆæœ‰ä»¥ä¸‹å‡ ç§ï¼š

a.åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ ‡è®°å¼€å§‹å’Œç»“æŸä½ç½®ï¼Œæ¯”å¦‚é€šè¿‡æ¢è¡Œç¬¦æ¥åˆ¤æ–­æ˜¯å¦ç»“æŸï¼›

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-20-131030.png" alt="image-20191120211029655" style="zoom:15%;" />

b.æ•°æ®ä¼ è¾“æ—¶ï¼Œä½¿ç”¨å›ºå®šçš„å¤´éƒ¨ï¼Œåœ¨æ¶ˆæ¯å¤´ä¸­æŒ‡æ˜æ¶ˆæ¯çš„é•¿åº¦ï¼›

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-20-131100.png" alt="image-20191120211100306" style="zoom:15%;" />

c.æ··åˆæ¨¡å¼ï¼šé€šè¿‡å›ºå®šå¤´éƒ¨ä¿¡æ¯ï¼Œå¹¶ä¸”åŠ ä¸Šæ•°æ®æè¿°ï¼Œæœ€åå¯¹æ•°æ®è¿›è¡ŒåŠ å¯†ï¼›



### 8.3ä»£ç å®ä¾‹

é¦–å…ˆæ¥çœ‹ä¸€ä¸‹å¼‚å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„æ¶ˆæ¯æ˜¯æ€ä¹ˆæ ·çš„ä¸€ä¸ªå½¢å¼ã€‚

> ç²˜åŒ…æƒ…å†µ

æˆ‘ä»¬å…ˆè¿ç»­å‘é€å¤šä¸ªæ¶ˆæ¯

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-20-125648.png" alt="image-20191120205648416" style="zoom:50%;" />

ç»“æœæ§åˆ¶å°æ‰“å°çš„æ¶ˆæ¯ä¸ºï¼šæœåŠ¡ç«¯æ¥æ”¶åˆ°æ•°æ®:test1test2test3test4



> **æ‹†åŒ…æƒ…å†µ**

æˆ‘ä»¬å°†è¯»å–çš„bufferè®¾ç½®ä¸º4ï¼Œç„¶åçœ‹æœåŠ¡ç«¯æ¥æ”¶çš„æƒ…å†µã€‚

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-20-125855.png" alt="image-20191120205854860" style="zoom:50%;" />

å¯ä»¥çœ‹å‡ºï¼ŒæœåŠ¡ç«¯æ¥å—åˆ°çš„æ•°æ®æ—¶æ‹†åˆ†å¼€çš„ï¼Œå¯¼è‡´æ•°æ®é”™ä¹±äº†ã€‚



> æ–¹æ¡ˆä»‹ç»

é‚£ä¹ˆå¦‚ä½•å¯¹æ•°æ®è¿›è¡Œå°åŒ…å’Œæ‹†åŒ…å‘¢ï¼Ÿ

**1**.é¦–å…ˆå®šä¹‰ä¸€ä¸ªpacketçš„è§„åˆ™

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-12-17-023554.png" alt="image-20191217103552727" style="zoom:33%;" />

packetåˆ†ä¸º2ç§æƒ…å†µã€‚å¦‚æœæ˜¯é¦–åŒ…ï¼Œæˆ‘ä»¬ä¼šç”¨å‰é¢4ä½æ¥å­˜å‚¨è¿™æ¬¡packetçš„å¤§å°ä¿¡æ¯ï¼Œåé¢æ‰€æœ‰çš„éƒ½ç”¨æ¥å­˜æ”¾åŒ…ä½“ä¿¡æ¯ï¼Œç›´åˆ°æ¶ˆæ¯å‘é€å®Œæˆï¼›



**2**.å®šä¹‰packetç±»ã€‚è¿™é‡Œå…ˆå®šä¹‰`StringSendPacket`å’Œ`StringReceivePacket`çš„ç»“æ„ã€‚

```java
public class StringReceivePacket extends ReceivePacket<ByteArrayOutputStream> {
	
	private String string;
	
	/**
	 * æ„é€ æ–¹æ³•
	 * @param len æ¥æ”¶çš„packeté•¿åº¦ï¼Œæ ¹æ®packetçš„å¤´éƒ¨ä¿¡æ¯è·å–
	 */
	public StringReceivePacket(int len) {
		this.length = len;
	}
	
	@Override
	protected ByteArrayOutputStream createStream() {
		return new ByteArrayOutputStream(length);
	}
	
	@Override
	protected void closeStream(ByteArrayOutputStream stream) throws IOException {
		super.closeStream(stream);
		this.string = new String(stream.toByteArray());
	}
	
	public String string() {
		return string;
	}
}

// å­—ç¬¦ä¸²å‘é€Packet
public class StringSendPacket extends SendPacket<ByteArrayInputStream> {
	// å‘é€çš„å­—ç¬¦ä¸² - å­—èŠ‚æ•°ç»„
	private byte[] buffer;
	
	public StringSendPacket(String msg) {
		this.buffer = msg.getBytes();
		this.length = buffer.length;
	}
	
	@Override
	public void close() throws IOException {
	}
	
	@Override
	protected ByteArrayInputStream createStream() {
		return new ByteArrayInputStream(buffer);
	}
}
```



**3**.å®ç°æœåŠ¡ç«¯æ¥æ”¶packetã€ä»¥åŠå®¢æˆ·ç«¯å‘é€packetçš„é€»è¾‘

ç±»å›¾

 https://www.processon.com/diagraming/5dcbff07e4b0754822a4b47b

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-12-17-084541.png" alt="image-20191217164541349" style="zoom:50%;" />

å‘é€é€»è¾‘

![image-20191217120611730](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-12-17-040612.png)

å…ˆå°†stringè½¬åŒ–ä¸ºInputStreamï¼Œé€šè¿‡ReadableByteChannelä¼ è¾“åˆ°bufferï¼Œæœ€åé€šè¿‡socketChannelå†™å‡ºå»ã€‚

æ˜ å°„åˆ°ä»£ç ä¸Šé¢ï¼š

i. TCPClientå‘é€ä¸€ä¸ªå­—ç¬¦ä¸²

ii. é€šè¿‡SendPacketæ„é€ æ–¹æ³•åŒ…è£…æˆpacketï¼Œç„¶åè°ƒç”¨senderDispatcheræ¥å‘é€

iii. ç¬¬ä¸‰æ­¥æ¯”è¾ƒå¤æ‚ï¼Œdispatcherçš„`send(SendPacket packet)`æ–¹æ³•å®é™…ä¸Šæ˜¯å°†packetåŠ å…¥åˆ°å‘é€é˜Ÿåˆ—é‡Œé¢ï¼Œ

ç„¶åå¯åŠ¨å‘é€çº¿ç¨‹ã€‚å‘é€çº¿ç¨‹ä¸æ–­çš„å–å‡ºpacketï¼Œå¹¶ä¸”åˆ¤æ–­packetæ˜¯å¦ä¸ºnullï¼Œå­˜å…¥ä¸´æ—¶å˜é‡ä¸­ï¼Œç­‰å¾…è¢«socketChannelè¯»å–ã€‚

ç„¶åè°ƒç”¨senderçš„sendAsyncæ–¹æ³•ã€‚

iv.  senderçš„sendAsyncæ–¹æ³•å…¶å®å°±æ˜¯å‘socketChannelæ³¨å†Œä¸€ä¸ªsocket writeableäº‹ä»¶ã€‚è¿™ä¸ªè¿‡ç¨‹é€šè¿‡IoProviderçš„registOutputæ–¹æ³•æ¥å®ç°ã€‚å½“äº‹ä»¶è§¦å‘åï¼Œæ‰§è¡Œå›è°ƒBaseHandleOutputCallbackæ–¹æ³•ã€‚

vi. åœ¨callbackæ–¹æ³•é‡Œï¼Œé€šè¿‡`IOArgsProcessor`çš„`provideIoArgs`æ¥å¾—åˆ°`ioargs`å®ä¾‹ã€‚ `provideIoArgs` çš„å®ç°æ–¹æ³•ä¸–çºªä¸Šä¹Ÿæ˜¯åœ¨åœ¨`AsyncSendDispatcher`é‡Œã€‚å®ƒå®é™…ä¸Šï¼Œæ˜¯æ‹¿åˆ°å‘é€çº¿ç¨‹å–å‡ºçš„packetï¼Œå°†packetè¯»å–åˆ°ioArgsçš„bufferé‡Œï¼Œç„¶åå°†ioArgsçš„bufferå†™å…¥åˆ°socketChannelé‡Œï¼Œå®Œæˆå‘é€æµç¨‹ã€‚



æ¥æ”¶é€»è¾‘

å’Œå‘é€é€»è¾‘ç›¸å



**ä»£ç åœ°å€**

> https://gitee.com/dendi.ke/thread-demo/tree/master/socket-packet



## 9.åˆ†ç‰‡æ•°æ®å‘é€

ä¹‹å‰å‘é€æ•°æ®æ—¶ï¼Œæ— è®ºæ˜¯å­—ç¬¦ä¸²æˆ–è€…æ˜¯æ–‡ä»¶ï¼Œéƒ½æ˜¯å…ˆè¯»å–åˆ°å†…å­˜ä¸­ï¼Œä»¥byte[]æ•°ç»„çš„å½¢å¼å­˜å‚¨ã€‚å½“éœ€è¦å‘é€æ—¶ï¼Œå†å°†byte[]å†™å…¥ByteBufferé‡Œï¼Œäº¤ç»™channelå‘é€å‡ºå»ã€‚

ä½†æ˜¯å¦‚æœå‘é€çš„æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤§çš„æ–‡ä»¶ï¼Œè¯»å–åˆ°å†…å­˜ä¸­å»å°±ä¼šå ç”¨å¤ªå¤šå†…å­˜ï¼Œå¾ˆå¯èƒ½é€ æˆå†…å­˜æº¢å‡ºã€‚æ‰€ä»¥éœ€è¦é‡‡å–æ–‡ä»¶åˆ†ç‰‡å‘é€çš„æ–¹æ¡ˆï¼Œå°†ä¸€ä¸ªæ–‡ä»¶åˆ†æˆå¤šä¸ªæ•°æ®åŒ…åˆ†å¼€å‘é€ã€‚

### 9.1 åŸºæœ¬æ–¹æ¡ˆ

> å®šä¹‰åŸºæœ¬Frameç±»å‹

å’ŒPacketç±»ä¼¼ï¼Œæˆ‘ä»¬ä¹Ÿå®šä¹‰äº†Frameçš„è§„åˆ™ã€‚

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-12-17-122721.png" alt="image-20191217202720359" style="zoom:33%;" />

> é¦–å¸§é€»è¾‘

ä½†æ˜¯å’ŒPacketä¸åŒçš„æ˜¯ï¼Œframeçš„å‘é€åˆ†ä¸º`é¦–å¸§`å’Œ`bodyå¸§`ã€‚

é¦–å¸§å¸§å¤´é‡Œçš„ä¿¡æ¯åŒ…å«ï¼š

æ•´ä¸ªéœ€è¦å‘é€æ–‡ä»¶çš„å¤§å°ï¼Œå‘é€ç±»å‹ï¼Œå”¯ä¸€æ ‡è¯†ï¼Œæ ‡å‡†ï¼Œå…¶ä»–ä¿¡æ¯ã€‚

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-12-17-121947.png" alt="image-20191217201947178" style="zoom:33%;" />



é¦–å¸§çš„å¸§ä½“é‡Œå­˜æ”¾çš„ä¿¡æ¯å…¶å®å°±æ˜¯packetçš„ä¿¡æ¯ï¼Œè¿™é‡Œæˆ‘ä»¬ä¿®æ”¹äº†ä¸€ä¸‹packetçš„è§„åˆ™ã€‚

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-12-17-122958.png" alt="image-20191217202958133" style="zoom:33%;" />

å¦‚æœæ˜¯é¦–åŒ…çš„è¯ï¼Œæˆ‘ä»¬ç”¨å‰é¢5ä½ç”¨æ¥è®°å½•åŒ…ä½“çš„å¤§å°ï¼Œç¬¬6ä½è®°å½•åŒ…çš„ç±»å‹ï¼Œæ˜¯æ–‡ä»¶è¿˜æ˜¯å­—ç¬¦ä¸²æˆ–è€…å…¶ä»–çš„ã€‚ä»ç¬¬7ä½å¼€å§‹éƒ½æ˜¯å®é™…çš„åŒ…ä½“ä¿¡æ¯ã€‚

æ‰€ä»¥å¤´å¸§çš„å¸§ä½“å¤§å°æ˜¯ä¸€èˆ¬æ˜¯å›ºå®šçš„6ä½ï¼Œåªéœ€è¦å‘Šè¯‰ä¸€ä¸‹å‘é€çš„packetçš„æ•´ä¸ªå¤§å°å’Œç±»å‹å³å¯ã€‚

> å¸§é€»è¾‘











## 10.Socketå¹¶å‘

### å®¢æˆ·ç«¯æœåŠ¡å™¨è¿æ¥æ•°é‡é™åˆ¶

49152 ~ 65535 ç«¯å£å·æ˜¯ä¸å…è®¸è¢«å ç”¨çš„ï¼Œæ˜¯åŠ¨æ€åˆ†é…çš„ã€‚

ç³»ç»Ÿå•è¿›ç¨‹â€œ**[æ–‡ä»¶å¥æŸ„](#æ–‡ä»¶å¥æŸ„)**â€æœ€å¤§é™åˆ¶



### 







## HTTP

httpæ˜¯å¦‚æœè¯†åˆ«è¯·æ±‚çš„ï¼Ÿ

httpæ˜¯å¦‚æœæ¥å—æ•°æ®åŒ…çš„ï¼Ÿ

httpæ˜¯å¦‚ä½•åˆ¤æ–­è¯·æ±‚æ•°æ®æ¥æ”¶åˆ°åº•çš„ï¼Ÿ



1.xå’Œ2.xçš„åŒºåˆ«





# Nettyæ¡†æ¶ (æ¸¸æˆæœåŠ¡å™¨)

NetttyæœåŠ¡ç«¯

Nettyå®¢æˆ·ç«¯



é•¿è¿æ¥ä¸çŸ­è¿æ¥åŒºåˆ«

æ¶ˆæ¯åºåˆ—åŒ–







## æ•°æ®åº“

mysqlå®‰è£…

> https://www.jianshu.com/p/4fc53d7d7620



mysqlæ¦‚è¿°

mysqlä¼˜åŒ–æ–¹æ¡ˆ

æ•°æ®åº“ä¸‰å¤§èŒƒå¼

åˆ†åº“åˆ†è¡¨

æ°´å¹³åˆ†å‰²å–æ¨¡ç®—æ³•

ç´¢å¼•æ¦‚è¿°

ç´¢å¼•åº•å±‚å®ç°åŸç†

æ™®é€šç´¢å¼•&å”¯ä¸€ç´¢å¼•åŒºåˆ«

sqlè¯­å¥ä¼˜åŒ–

mysqlé«˜å¯ç”¨

mysqlä¸»ä»å¤åˆ¶åŸç†

mysqlè¯»å†™åˆ†ç¦»æ¦‚è¿°

mycatè¯»å†™åˆ†ç¦»



## äº‹ç‰©

äº‹ç‰©æ¦‚è¿°

äº‹ç‰©åº•å±‚åŸç†

äº‹ç‰©ä¼ æ’­è¡Œä¸º

åˆ†å¸ƒå¼äº‹ç‰©



# Redis

## Redis-Desktop-Managerå®‰è£…

> https://github.com/qishibo/AnotherRedisDesktopManager



### Redis5ç§åŸºæœ¬ç±»å‹

> String, Hash, List, Set,  ZSet

#### String

é‡è¦ç”¨æ³•1ï¼š**`Expire Key`**

> **åº”ç”¨åœºæ™¯**

1ã€é™æ—¶çš„ä¼˜æƒ æ´»åŠ¨ä¿¡æ¯

2ã€ç½‘ç«™æ•°æ®ç¼“å­˜ï¼ˆå¯¹äºä¸€äº›éœ€è¦å®šæ—¶æ›´æ–°çš„æ•°æ®ï¼Œä¾‹å¦‚ï¼šç§¯åˆ†æ’è¡Œæ¦œï¼‰

3ã€æ‰‹æœºéªŒè¯ç 

4ã€é™åˆ¶ç½‘ç«™è®¿å®¢è®¿é—®é¢‘ç‡ï¼ˆä¾‹å¦‚ï¼š1åˆ†é’Ÿæœ€å¤šè®¿é—®10æ¬¡ï¼‰  



é‡è¦ç”¨æ³•2ï¼š**`SETNX key value` **

> **åº”ç”¨åœºæ™¯**

1ã€åˆ†å¸ƒå¼é”



é‡è¦ç”¨æ³•3ï¼š**`INCR KEY_Name`**

> **åº”ç”¨åœºæ™¯**

1.è®¡æ•°å™¨

å‡å¦‚ï¼Œåœ¨æŸç§åœºæ™¯ä¸‹æœ‰3ä¸ªå®¢æˆ·ç«¯åŒæ—¶è¯»å–äº†mynumçš„å€¼ï¼ˆå€¼ä¸º2ï¼‰ï¼Œç„¶åå¯¹å…¶åŒæ—¶è¿›è¡Œäº†åŠ 1çš„æ“ä½œï¼Œé‚£ä¹ˆï¼Œæœ€åmynumçš„å€¼ä¸€å®šæ˜¯5ã€‚



**Keyçš„å‘½åå»ºè®®**

> rediså•ä¸ªkey å­˜å…¥512Må¤§å°

1.keyä¸è¦å¤ªé•¿ï¼Œå°½é‡ä¸è¦è¶…è¿‡1024å­—èŠ‚ï¼Œè¿™ä¸ä»…æ¶ˆè€—å†…å­˜ï¼Œè€Œä¸”ä¼šé™ä½æŸ¥æ‰¾çš„æ•ˆç‡ï¼›

 2.keyä¹Ÿä¸è¦å¤ªçŸ­ï¼Œå¤ªçŸ­çš„è¯ï¼Œkeyçš„å¯è¯»æ€§ä¼šé™ä½ï¼› 

3.åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œkeyæœ€å¥½ä½¿ç”¨ç»Ÿä¸€çš„å‘½åæ¨¡å¼ï¼Œä¾‹å¦‚user:123:password; 

4.keyåç§°åŒºåˆ†å¤§å°å†™



#### Hash

> åº”ç”¨åœºæ™¯

1ã€å­˜å‚¨ä¸€ä¸ªå¯¹è±¡

hashå­˜å‚¨å¯¹è±¡å’Œstringå­˜å‚¨çš„åŒºåˆ«

- stirngå­˜å‚¨ä¸»è¦æœ‰2ç§æ–¹æ¡ˆï¼šä¸€ç§æ˜¯ç”¨å¯¹è±¡çš„idä½œä¸ºkeyï¼Œç”¨å¯¹è±¡çš„jsonåºåˆ—åŒ–ä½œä¸ºvalueã€‚è¿˜æœ‰ä¸€ç§æ˜¯ç”¨å¯¹è±¡çš„id+å±æ€§åä½œä¸ºkeyï¼Œç”¨å¯¹è±¡å±æ€§å€¼ä½œä¸ºvalueã€‚

  ç¬¬ä¸€ç§çš„ç¼ºç‚¹æ˜¯æ¯æ¬¡ä¿®æ”¹å±æ€§ä¸æ–¹ä¾¿ï¼Œå¿…é¡»å°†å¯¹è±¡ååºåˆ—åŒ–å‡ºæ¥å†æ’å…¥è¿›å»ã€‚è€Œä¸”éœ€è¦è€ƒè™‘å¹¶å‘é—®é¢˜ï¼›

  ç¬¬äºŒç§ç¡®å®šæ˜¯keyå¤ªå¤šï¼Œé€ æˆå­˜å‚¨ç©ºé—´è¿‡å¤§ï¼›

- Redisæä¾›çš„Hashå¾ˆå¥½çš„è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼ŒRedisçš„Hashå®é™…æ˜¯å†…éƒ¨å­˜å‚¨çš„Valueä¸ºä¸€ä¸ªHashMapï¼Œå¹¶æä¾›äº†ç›´æ¥å­˜å–è¿™ä¸ªMapæˆå‘˜çš„æ¥å£



#### List

> åº”ç”¨åœºæ™¯

1ã€å®ç°é˜Ÿåˆ— lpush rpop 

2ã€å®ç°å †æ ˆ lpush lpop

3ã€å®ç°åˆ†é¡µ lrange start stop

â€‹		å¤§æ•°æ®é‡çš„åˆ†é¡µ

4ã€å¯¹å¤§æ•°æ®è¿›è¡Œåˆ å‡ã€æ˜¾ç¤º

â€‹		å¦‚ï¼šå…³æ³¨åˆ—è¡¨ã€ç²‰ä¸åˆ—è¡¨ã€ç•™è¨€è¯„ä»·ç­‰;

5ã€ä»»åŠ¡é˜Ÿåˆ—



#### Set

> åº”ç”¨åœºæ™¯

1ã€å¸¸ç”¨äºå¯¹ä¸¤ä¸ªé›†åˆé—´çš„æ•°æ®åšäº¤é›†ã€å¹¶é›†ã€å·®é›†è¿ç®—ï¼š

â€‹	æ¯”å¦‚å¾®ä¿¡æŸ¥çœ‹2ä¸ªäººçš„å…±åŒå¥½å‹ï¼›

â€‹	æ¯”å¦‚å¾®åšæŸ¥çœ‹å…±åŒå…³æ³¨çš„äººï¼›

â€‹	å†é«˜çº§ä¸€ç‚¹ï¼Œæ¨èä½ å…³æ³¨çš„äººå…³æ³¨äº†è°ï¼›	

2ã€åˆ©ç”¨å”¯ä¸€æ€§ï¼Œç»Ÿè®¡ç½‘ç«™çš„è®¿é—®IPï¼›



#### ZSet

> åº”ç”¨åœºæ™¯

1ã€æ’è¡Œæ¦œï¼Œå¦‚æŸ¥çœ‹æ’åå‰10çš„äººï¼Œæˆ–è€…æŸ¥çœ‹æ‰€æœ‰äººçš„æ’åï¼Œæˆ–è€…æŸ¥çœ‹æŸä¸€ä¸ªåˆ†æ•°æ®µçš„äººï¼›

```java
System.out.println("       å…¨éƒ¨ç©å®¶æ’è¡Œæ¦œ                    ");
		Set<ZSetOperations.TypedTuple<String>> allPlayerList = redisTemplate.opsForZSet().reverseRangeWithScores(key, 0, -1);
		Iterator<ZSetOperations.TypedTuple<String>> iterator = allPlayerList.iterator();
		while(iterator.hasNext()) {
			ZSetOperations.TypedTuple<String> item = iterator.next();
			System.out.println("ç©å®¶IDï¼š"+item.getValue()+"ï¼Œ ç©å®¶å¾—åˆ†:"+Double.valueOf(item.getScore()).intValue());
		}

// reverseRangeWithScores
// reverseRangeByScoreWithScores
```



### Rediså®ç°åˆ†å¸ƒå¼é”

æ–¹æ¡ˆ1ï¼šé€šè¿‡setnxè¿™ä¸ªå‘½ä»¤ï¼Œåœ¨æ¯æ¬¡è¦æ‰§è¡Œredisæ“ä½œæ—¶åŠ ä¸€ä¸ªé”ï¼›å¦‚æœèƒ½æ‹¿åˆ°è¿™ä¸ªé”ï¼Œå°±ç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™ç­‰å¾…ã€‚

```java
String lockKey = "product_100_stock";
String stockStr = stringRedisTemplate.opsForValue().get("stock");
// å®ç°å…³é”®æ˜¯ç”¨åˆ°äº†setnxè¿™ä¸ªå‘½ä»¤
boolean result = stringRedisTemplate.opsForValue().setIfAbsent(lockKey, "20");
if (!result) {
  return "locked";
}
int stock = Integer.parseInt(stockStr);
if (stock > 0) {
  stock--;
  stringRedisTemplate.opsForValue().set("stock", String.valueOf(stock));
} else {
  return "error";
}
stringRedisTemplate.delete(lockKey);
return "success";
```

å¸¸è§çš„å‘ï¼š

1.å¦‚æœç¨‹åºè¿è¡Œä¸­æ­»æœºäº†æ€ä¹ˆå¤„ç†ï¼Ÿ

- åœ¨ä»£ç å—ä¸­åŠ try finallyï¼Œåˆ é™¤é”
- å¢åŠ é”çš„è¶…æ—¶æ—¶é—´ï¼Œé¿å…ç¨‹åºå¼‚å¸¸æ— æ³•é‡Šæ”¾é”ï¼›

2.è¶…æ—¶æ—¶é—´æ€ä¹ˆå»å®šæ¯”è¾ƒåˆç†ï¼Ÿä¸ä¼šæå‰æ¸…é™¤é”ï¼Œä»è€Œé€ æˆ`åˆ†å¸ƒå¼é”`é‡Šæ”¾é”™è¯¯ã€‚

- è€ƒè™‘åœ¨ä¸»çº¿ç¨‹é‡Œï¼Œå¼€å¯ä¸€ä¸ªå­çº¿ç¨‹ï¼Œå»ä¸æ–­çš„å®šæ—¶è½®è¯¢å»¶è¿Ÿé”çš„æ—¶é—´ã€‚ä¸»çº¿ç¨‹ç»“æŸåï¼Œç»“æŸå­çº¿ç¨‹ï¼›

3.å¦‚ä½•é¿å…è¯¯åˆ é”ï¼Ÿå¤šä¸ªçº¿ç¨‹å¤„ç†ï¼Œå¾ˆæœ‰å¯èƒ½ä¸€ä¸ªçº¿ç¨‹åˆ é™¤äº†å¦ä¸€ä¸ªçº¿ç¨‹çš„é”ï¼›

â€‹	line4:åœ¨è®¾ç½®é”çš„valueçš„æ—¶å€™ï¼Œè®¾ç½®ä¸€ä¸ªéšæœºå€¼ï¼Œä¿è¯ä¸åŒçš„æœºå™¨å¤„ç†çš„é”åä¸ç›¸åŒï¼›

â€‹	åˆ é™¤é”æ—¶ï¼Œå…ˆæ¯”è¾ƒå€¼ï¼Œå†å»åˆ é™¤é”ï¼› 



æ–¹æ¡ˆ2ï¼šredissionæ¡†æ¶äº†æä¾›äº†ä¸€ä¸ªåˆ†å¸ƒå¼é”çš„è§£å†³æ–¹æ¡ˆ

```
RLock rLock = redisson.getLock(lockKey);
```

1.å¦‚æœæ˜¯master-slaveræ¨¡å¼çš„redisæ¶æ„ï¼Œä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Ÿ

- redissionå†™æ˜¯ç”¨masterï¼Œè¯»æ˜¯ç”¨slaverã€‚å¦‚æœå†™çš„æ—¶å€™ï¼ŒmasteræŒ‚æ‰ï¼Œè¯»å–çš„slaverä¾ç„¶å¯ä»¥ç”¨ï¼Œä¼šå¯¼è‡´é”ä¸€ç›´æ— æ³•é‡Šæ”¾ï¼Œä»è€Œå¯¼è‡´æ­»é”ã€‚ 

2.redisåˆ†å¸ƒå¼é”æ€ä¹ˆæ”¯æŒé«˜å¹¶å‘ï¼Ÿ

**Redlockç®—æ³•ï¼š**

å‡è®¾æœ‰Nä¸ªç›¸åŒçš„redisèŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„redisæ¨¡å¼ä¸€æ ·ï¼Œä½†æ˜¯äº’ä¸å…³è”ã€‚

1.è®°å½•æ—¶é—´æˆ³ï¼›

2.ä¸ºæ¯ä¸ªredisèŠ‚ç‚¹è®¾ç½®çš„è¶…æ—¶æ—¶é—´ï¼Œä»¥åŠé”è¿‡æœŸæ—¶é—´ã€‚ é¿å…æœåŠ¡å™¨æŒ‚æ‰åï¼Œå®¢æˆ·ç«¯ä»ç„¶å»ç­‰å¾…æœåŠ¡å™¨å“åº”ï¼›(æ¯”å¦‚5ms)

3.å½“è®¾ç½®é”æ—¶ï¼Œå‘æ¯ä¸ªredisèŠ‚ç‚¹ä¸Šéƒ½è®¾ç½®ä¸€æ¬¡ï¼›

4.è®°å½•æˆåŠŸçš„èŠ‚ç‚¹æ•°ï¼Œä»¥åŠç´¯è®¡çš„ç”¨æ—¶æ—¶é—´ï¼›

5.å¦‚æœç´¯è®¡æ—¶é—´ä¸è¶…è¿‡é”è¿‡æœŸæ—¶é—´ï¼Œå¹¶ä¸”æˆåŠŸèŠ‚ç‚¹æ•°å¤§äºæ€»ç»“ç‚¹æ•°çš„ä¸€åŠæ•°é‡ï¼›

6.å¦‚æœç´¯è®¡æ—¶é—´è¶…è¿‡äº†é”çš„è¿‡æœŸæ—¶é—´ï¼Œé‚£ä¹ˆé”å¯èƒ½å·²ç»å¤±æ•ˆäº†ã€‚æˆ–è€…è·å–äº†å°äº3ä¸ªé”ï¼Œå¿…é¡»é‡Šæ”¾ï¼Œå¦åˆ™å½±å“å…¶ä»–clientè·å–é”ã€‚



```mermaid
graph TD
A(è®°å½•å¼€å§‹æ—¶é—´)-->B(ä¾æ¬¡è®¾ç½®redisèŠ‚ç‚¹é”Næ¬¡)
B-->C(è®°å½•è®¾ç½®æ—¶é—´)
B-->D(è®°å½•æˆåŠŸè®¾ç½®redisé”çš„èŠ‚ç‚¹æ•° R)
D-->E{R > N/2+1?}
C-->F{é”æœ‰æ•ˆæœŸ > è®¾ç½®æ—¶é—´}
F-->|æ˜¯|H
F-->|å¦|G
E-->|æ˜¯|H(è·å–é”æˆåŠŸ)
E-->|å¦|G(è·å–é”å¤±è´¥ )

```





### Redisäº‹ç‰©

#### ä¸¤ç±»é”™è¯¯

- è¯­æ³•é”™è¯¯

  å›æ»šæ“ä½œâ€”â€”discard

- æ‰§è¡Œé”™è¯¯

  è·³è¿‡é”™è¯¯ç»§ç»­æ‰§è¡Œ

  

redisTemplateæ‰§è¡Œ

```java
SessionCallback sessionCallback = new SessionCallback() {
  @Override
  public Object execute(RedisOperations redisOperations) throws DataAccessException {
    redisOperations.multi();
    redisTemplate.opsForValue().set(key, "1");
    redisTemplate.opsForValue().decrement(key);
    redisTemplate.opsForValue().set(key, "2");
    redisTemplate.opsForValue().set(key, "6");
    return redisOperations.exec();
  }
};
redisTemplate.execute(sessionCallback);
```





### Redisç¼“å­˜ä¸€è‡´æ€§

1.å¼ºä¸€è‡´æ€§â€”â€”å®æ—¶åŒæ­¥

æŸ¥è¯¢ç¼“å­˜ï¼Œç¼“å­˜ä¸å­˜åœ¨æŸ¥è¯¢DBï¼Œä¿å­˜åˆ°ç¼“å­˜ã€‚

æ›´æ–°ç¼“å­˜æ—¶ï¼Œå…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†å°†ç¼“å­˜çš„æ•°æ®è®¾ç½®ä¸ºè¿‡æœŸï¼›

æ³¨æ„ç‚¹ï¼š

**ç¼“å­˜ç©¿é€**

> æ¯æ¬¡æŸ¥è¯¢çš„æ—¶å€™ï¼Œæ•°æ®åº“éƒ½è¿”å›ç©ºï¼Œæ¯æ¬¡éƒ½æ²¡ç¼“å­˜æ•°æ®ï¼Œç»“æœæ¯æ¬¡éƒ½ä»æ•°æ®åº“ä¸­æŸ¥è¯¢

è§£å†³æ–¹æ¡ˆ
ä»ç¼“å­˜å–ä¸åˆ°çš„æ•°æ®ï¼Œåœ¨æ•°æ®åº“ä¸­ä¹Ÿæ²¡æœ‰å–åˆ°ï¼Œè¿™æ—¶ä¹Ÿå¯ä»¥å°†key-valueå¯¹å†™ä¸ºkey-nullï¼Œç¼“å­˜æœ‰æ•ˆæ—¶é—´å¯ä»¥è®¾ç½®çŸ­ç‚¹ï¼Œå¦‚30ç§’ï¼ˆè®¾ç½®å¤ªé•¿ä¼šå¯¼è‡´æ­£å¸¸æƒ…å†µä¹Ÿæ²¡æ³•ä½¿ç”¨ï¼‰ã€‚è¿™æ ·å¯ä»¥é˜²æ­¢æ”»å‡»ç”¨æˆ·åå¤ç”¨åŒä¸€ä¸ªidæš´åŠ›æ”»å‡»

**ç¼“å­˜å‡»ç©¿**

> æŸä¸€ä¸ªçƒ­ç‚¹Keyï¼Œåœ¨æŸä¸€ä¸ªæ—¶é—´é‡Œï¼Œç¼“å­˜å¤±æ•ˆäº†ã€‚è¿™æ—¶ç”±äºå¹¶å‘ç”¨æˆ·ç‰¹åˆ«å¤šï¼ŒåŒæ—¶è¯»ç¼“å­˜æ²¡è¯»åˆ°æ•°æ®ï¼ŒåˆåŒæ—¶å»æ•°æ®åº“å»å–æ•°æ®ï¼Œå¼•èµ·æ•°æ®åº“å‹åŠ›ç¬é—´å¢å¤§ï¼Œé€ æˆè¿‡å¤§å‹åŠ›

è§£å†³æ–¹æ¡ˆ

1. è®¾ç½®çƒ­ç‚¹æ•°æ®æ°¸è¿œä¸è¿‡æœŸï¼›
2. åŠ äº’æ–¥é”ï¼Œåªæœ‰1ä¸ªå»æ•°æ®åº“æŸ¥è¯¢ï¼›

**ç¼“å­˜é›ªå´©**

> ç¼“å­˜ä¸­æ•°æ®å¤§æ‰¹é‡åˆ°è¿‡æœŸæ—¶é—´ï¼Œè€ŒæŸ¥è¯¢æ•°æ®é‡å·¨å¤§ï¼Œå¼•èµ·æ•°æ®åº“å‹åŠ›è¿‡å¤§ç”šè‡³downæœºã€‚å’Œç¼“å­˜å‡»ç©¿ä¸åŒçš„æ˜¯ï¼Œç¼“å­˜å‡»ç©¿æŒ‡å¹¶å‘æŸ¥åŒä¸€æ¡æ•°æ®ï¼Œç¼“å­˜é›ªå´©æ˜¯ä¸åŒæ•°æ®éƒ½è¿‡æœŸäº†ï¼Œå¾ˆå¤šæ•°æ®éƒ½æŸ¥ä¸åˆ°ä»è€ŒæŸ¥æ•°æ®åº“ã€‚

è§£å†³æ–¹æ¡ˆï¼š

1.è®¾ç½®ä¸åŒçš„è¿‡æœŸæ—¶é—´ï¼›

2.çƒ­ç‚¹è®¾ç½®ä¸è¿‡æœŸ



### Redisä¸»ä»å¤åˆ¶

masterä¸»èŠ‚ç‚¹ç”¨æ¥å†™å…¥æ•°æ®ï¼Œslaverå­èŠ‚ç‚¹ç”¨æ¥è¯»å–æ•°æ®ï¼Œ`ä¸»èŠ‚ç‚¹`å®šæœŸæŠŠæ•°æ®åŒæ­¥åˆ°`ä»èŠ‚ç‚¹`æ¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚

#### ä¸»ä»å¤åˆ¶æ¶æ„

**a)  ä¸€ä¸»ä¸€ä»**ï¼šå½“`ä¸»èŠ‚ç‚¹`çš„â€œå†™â€å‘½ä»¤å¹¶å‘é«˜ä¸”éœ€è¦æŒä¹…åŒ–æ—¶ï¼Œå¯ä»¥åªåœ¨`ä»èŠ‚ç‚¹`å¼€å¯AOFï¼ˆä¸»èŠ‚ç‚¹ä¸éœ€è¦ï¼‰ã€‚

 <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-031252.png" width="150" align="center"/>



**b) ä¸€ä¸»å¤šä»**ï¼šå½“å¯¹"è¯»"çš„è¦æ±‚æ¯”è¾ƒå¤§æ—¶ï¼Œè¿™ç§ç»“æ„æ¯”è¾ƒåˆé€‚ã€‚ä¸»èŠ‚ç‚¹åªè´Ÿè´£å†™å…¥ï¼Œç„¶ååŒæ­¥åˆ°ä»èŠ‚ç‚¹ã€‚ä½†æ˜¯å¯¹ä¸»èŠ‚ç‚¹çš„å½±å“æ¯”è¾ƒå¤§ï¼Œå› ä¸º`ä¸»èŠ‚ç‚¹`ä¼šåŒæ­¥åˆ°å¤šä¸ª`ä»èŠ‚ç‚¹`ï¼Œä¼šæ¶ˆè€—å¸¦å®½å’Œå†…å­˜ã€‚

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-032919.png" width="450" />



c) **æ ‘å½¢ç»“æ„**ï¼šå¯ä»¥è§£å†³ä¸Šé¢ä¸€ä¸»å¤šä»ï¼Œä¸»èŠ‚ç‚¹å‹åŠ›è¿‡å¤§çš„é—®é¢˜ï¼›



#### æ•°æ®åŒæ­¥

a) å…¨é‡å¤åˆ¶ï¼šä¸€èˆ¬ç”¨äºåˆæ¬¡å¤åˆ¶åœºæ™¯ï¼ˆç¬¬ä¸€æ¬¡å»ºç«‹SLAVEåå…¨é‡ï¼‰
b) éƒ¨åˆ†å¤åˆ¶ï¼šç½‘ç»œå‡ºç°é—®é¢˜ï¼Œä»èŠ‚ç‚¹å†æ¬¡è¿æ¥ä¸»èŠ‚ç‚¹æ—¶ï¼Œä¸»èŠ‚ç‚¹è¡¥å‘ç¼ºå°‘çš„æ•°æ®ï¼Œæ¯æ¬¡æ•°æ®å¢é‡åŒæ­¥
c) å¿ƒè·³ï¼šä¸»ä»æœ‰é•¿è¿æ¥å¿ƒè·³ï¼Œä¸»èŠ‚ç‚¹é»˜è®¤æ¯10Så‘ä»èŠ‚ç‚¹å‘pingå‘½ä»¤ï¼Œrepl-ping-slave-periodæ§åˆ¶å‘é€é¢‘ç‡

#### ä¸»ä»çš„ç¼ºç‚¹

**a)** è‹¥ä¸»èŠ‚ç‚¹å‡ºç°é—®é¢˜ï¼Œåˆ™ä¸èƒ½æä¾›æœåŠ¡ï¼Œéœ€è¦äººå·¥ä¿®æ”¹é…ç½®å°†ä»å˜ä¸»ã€‚
**b)** `ä¸»èŠ‚ç‚¹`çš„å†™èƒ½åŠ›å•æœºï¼Œèƒ½åŠ›æœ‰é™
**c)** å•æœºèŠ‚ç‚¹çš„å­˜å‚¨èƒ½åŠ›ä¹Ÿæœ‰é™



### å“¨å…µæœºåˆ¶(Sentinel)

> ä¸»è¦æ˜¯ä¸ºäº†è§£å†³ä¸»ä»å¤åˆ¶çš„ç¼ºç‚¹ï¼Œè‡ªåŠ¨å¯¹èŠ‚ç‚¹è¿›è¡Œç›‘æ§ã€‚å½“ä¸»èŠ‚ç‚¹ä¸å¯ç”¨æ—¶ï¼Œè‡ªåŠ¨å°†ä¸»èŠ‚ç‚¹çš„å­èŠ‚ç‚¹è½¬æ¢ä¸ºä¸»èŠ‚ç‚¹ï¼Œå¹¶ä¸”é€šçŸ¥å®¢æˆ·ç«¯ã€‚

#### 1.**é«˜å¯ç”¨**

å½“ä¸»èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶ï¼Œç”±sentinelè‡ªåŠ¨å®Œæˆæ•…éšœå‘ç°å’Œè½¬ç§»ï¼Œå¹¶ä¸”é€šçŸ¥åº”ç”¨ã€‚

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-065139.png" width="300"/>



**ç›‘æ§åŸç†**ï¼š

1ï¼šæ¯10sé’Ÿï¼Œå“¨å…µå‘masterèŠ‚ç‚¹è·å–ä¸€ä¸‹ä¿¡æ¯ï¼Œæ¥ç¡®è®¤ä¸»ä»èŠ‚ç‚¹çš„æ‹“æ‰‘å…³ç³»ï¼›

![1227483-20180201113518031-1426392070](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-081111.png)

2ï¼šæ¯2sé’Ÿï¼Œæ¯ä¸ªå“¨å…µä¼šå‘masterèŠ‚ç‚¹çš„å›ºå®šé¢‘é“ä¸Šå‘é€ä¸»æ¨æ¶ˆæ¯(å“¨å…µå¯¹masterèŠ‚ç‚¹çš„åˆ¤æ–­ã€å“¨å…µè·å–åˆ°çš„èŠ‚ç‚¹ä¿¡æ¯)ã€‚åŒæ—¶ï¼Œæ¯ä¸ªå“¨å…µä¹Ÿä¼šå»è®¢é˜…è¿™ä¸ªå›ºå®šé¢‘é“ï¼Œäº†è§£å…¶ä»–å“¨å…µå¯¹è¿™ä¸ªèŠ‚ç‚¹çš„åˆ¤æ–­ã€‚

![1227483-20180201113623921-1930278582](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-081103.png)

3ï¼šæ¯sé’Ÿï¼Œæ¯ä¸ªå“¨å…µä¹Ÿä¼šå‘å…¶ä»–å“¨å…µä»¥åŠä¸»ã€ä»èŠ‚ç‚¹å‘é€pingå‘½ä»¤ï¼›ç”¨æ¥ç¡®å®šèŠ‚ç‚¹æ˜¯å¦æ­£å¸¸ï¼›

![1227483-20180201115230609-828804435](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-081055.png)



**ä¸‹çº¿çŠ¶æ€**

1.ä¸»è§‚ä¸‹çº¿ï¼š

å“¨å…µæ¯éš”1så‘å…¶ä»–èŠ‚ç‚¹å‘é€pingå‘½ä»¤ï¼Œåœ¨down-after-millisecondsæœ‰æ•ˆæœŸå†…ï¼Œå¦‚æœæ²¡æœ‰å“åº”ï¼Œå°±ä¼šä¸»è§‚çš„å°†è¿™ä¸ªèŠ‚ç‚¹ä¸‹çº¿ï¼›å¹¶ä¸”å‘å…¶ä»–èŠ‚ç‚¹ç¡®è®¤æ˜¯å¦éƒ½æ˜¯ä¸»è§‚ä¸‹çº¿çš„ã€‚![1227483-20180201121656031-220411144](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-102223.png)

2.å®¢è§‚ä¸‹çº¿ï¼š

å½“ä¸»è§‚ä¸‹çº¿çš„å®¢æˆ·æ•°é‡è¶…è¿‡quorumï¼ˆquorum = (èŠ‚ç‚¹æ•°é‡/2) + 1ï¼‰æ—¶ï¼Œåˆ™è®¤ä¸ºèŠ‚ç‚¹æ˜¯å®¢è§‚ä¸‹çº¿çŠ¶æ€ã€‚

å½“èŠ‚ç‚¹è¢«å“¨å…µå®¢è§‚ä¸‹çº¿ä»¥åï¼Œå“¨å…µä¼šé€šè¿‡é€‰ä¸¾ç®—æ³•ï¼Œé€‰å‡ºä¸€ä¸ªå“¨å…µæ¥è´Ÿè´£è¿›è¡Œæ•…éšœè½¬ç§»ã€‚ æ¯ä¸ªå‘ç°èŠ‚ç‚¹å®¢è§‚ä¸‹çº¿çš„å“¨å…µéƒ½æœ‰æƒé™ç”³è¯·æˆä¸ºæ•…éšœè½¬ç§»çš„å“¨å…µï¼›é€‰ä¸¾å…ˆåˆ°å…ˆå¾—ï¼Œæˆä¸ºæ•…éšœè½¬ç§»çš„å“¨å…µä¼šé€‰æ‹©ä¸€ä¸ªä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ä½œä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼›

![1227483-20180201115626875-1938202974](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-102151.png)



**æ•…éšœè½¬ç§»æµç¨‹**

1.é€‰ä¸¾æ–°çš„ä¸»èŠ‚ç‚¹

```mermaid
graph TD
A(ç½‘ç»œè¿æ¥æ­£å¸¸)-->B(5ç§’å†…å›å¤è¿‡INFOå‘½ä»¤)
B --> C(10*down-after-millsecondså†…æœ‰è¿æ¥è¿‡ä¸»æœº)
C --> D(æœåŠ¡å™¨ä¼˜å…ˆçº§)
D --> E(å¤åˆ¶åç§»é‡å¤§çš„)
E --> F(è¿è¡Œidè¾ƒå°)
F --> G(æ–°çš„master)

```

2.å°†å…¶ä»–èŠ‚ç‚¹è®¾ç½®ä¸º`æ–°ä¸»èŠ‚ç‚¹`çš„ä»èŠ‚ç‚¹

![1227483-20180201121911671-2038984859](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-102239.png)

3ã€é€šçŸ¥å®¢æˆ·ç«¯ï¼Œæ–°çš„ä¸»èŠ‚ç‚¹çš„ipã€portç­‰ä¿¡æ¯ï¼›



### RedisæŒä¹…åŒ–

#### RDBå­˜å‚¨

> é»˜è®¤æŒä¹…åŒ–æœºåˆ¶

rdbç›¸å½“äºå¿«ç…§ï¼Œå°†å†…å­˜ä¸­çš„æ•°æ®ä»¥å¿«ç…§çš„æ–¹å¼ä¿å­˜åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œé»˜è®¤æ–‡ä»¶åä¸ºdump.rdb;

ä¼˜ç‚¹ï¼š

â€‹	ä¿å­˜å¿«ï¼Œè¯»å–æ¢å¤å¿«ï¼›

ç¼ºç‚¹ï¼š

â€‹	åšå¿«ç…§çš„æ—¶å€™ï¼Œå ç”¨å†…å­˜é«˜ï¼›	

#### AOF

> Append of fileï¼Œå°†redisçš„**å†™å…¥å‘½ä»¤**è¿½åŠ åˆ°æ–‡ä»¶ä¸­ï¼›

ä¸‰ç§aofæ–¹å¼ï¼š

- â€‹	æ¯æ¬¡å†™å…¥è¿½åŠ æ–‡ä»¶ appendfsync always 

ç¼ºç‚¹ï¼šæœ‰æ—¶æˆ‘ä»¬åªå…³æ³¨ç»“æœï¼Œå¹¶ä¸æƒ³å…³æ³¨æ¯æ¬¡å†™å…¥çš„è¿‡ç¨‹ï¼›

- â€‹	æ¯ç§’é’Ÿè¿½åŠ æ–‡ä»¶ appendfsync everysec

ç¼ºç‚¹ï¼šé¢‘ç‡å¤ªé«˜ï¼Œå®¹æ˜“å ç”¨ç£ç›˜å¤ªå¤šï¼›

- â€‹	æ°¸è¿œä¸è¿½åŠ  appendfsync no

ç¼ºç‚¹: å®¹æ˜“ä¸¢å¤±ï¼›





## Nginx

```nginx
server {
    listen 80;
    server_name ~^(manage|om|broker|risk|sms)\.pre\.gsoms\.top$;

    #æ ¹æ®regex(æ­£åˆ™è¡¨è¾¾å¼)æ¥åŒ¹é…å†…å®¹è·³è½¬åˆ°replacement

    if ($http_host ~ ^(.*)) {
        set $domain $1;
       rewrite ^(.*) https://$domain break; #å°†æ‰€æœ‰è¯·æ±‚éƒ½é‡å®šå‘åˆ°https
  }
}
```





nginxå®‰å…¨ä½“ç³»æ¶æ„

nginxæ­å»ºé›†ç¾¤

nginxè´Ÿè½½å‡è¡¡ç­–ç•¥

æœåŠ¡å™¨å®•æœºå®¹é”™æœºåˆ¶

nginxæ­å»ºä¼ä¸šAPIæ¥å£



åˆ†å¸ƒå¼ä¸é›†ç¾¤çš„åŒºåˆ«

Keepalivedé«˜å¯ç”¨æ¦‚å¿µ

nginx+keepalivedé«˜å¯ç”¨

sessionå…±äº«è§£å†³æ–¹æ¡ˆ

é«˜å¹¶å‘è§£å†³æ–¹æ¡ˆ



# [MQæ¶ˆæ¯ä¸­é—´ä»¶](./MQæ¶ˆæ¯ä¸­é—´ä»¶)



## ä»»åŠ¡è°ƒåº¦

ä»»åŠ¡è°ƒåº¦æ¦‚è¿°

ä½¿ç”¨Quartzå®ç°

åˆ†å¸ƒå¼ä»»åŠ¡å¦‚ä½•è§£å†³"å¹‚ç­‰æ€§"

XX-JOBç¯å¢ƒ

åˆ†å¸ƒå¼ä»»åŠ¡å¹³å°æ‰§è¡ŒåŸç†

ä»»åŠ¡è°ƒåº¦å¹³å°æ‰§è¡Œå™¨è¿è¡Œ

ä»»åŠ¡è°ƒåº¦å¹³å°è·¯ç”±ç­–ç•¥



## åˆ†å¸ƒå¼äº‹ç‰©

åˆ†å¸ƒå¼äº‹ç‰©äº§ç”ŸåŸå› 

åˆ†å¸ƒå¼äº‹ç‰©è§£å†³æ–¹æ¡ˆ

CPAä¸Baseç†è®º

2PC-ä¸¤æ®µæäº¤åè®®

ä½¿ç”¨MQè§£å†³åˆ†å¸ƒå¼äº‹ç‰©

LCNæ¡†æ¶æ¦‚è¿°

LCNæ¡†æ¶åŸç†

LCNæ¡†æ¶æµç¨‹

å¯åŠ¨tx-mananger

æ¼”ç¤ºåˆ†å¸ƒå¼äº‹ç‰©äº§æ™¯

ä½¿ç”¨LCNæ¡†æ¶è§£å†³åˆ†å¸ƒå¼äº‹ç‰©



## åˆ†å¸ƒå¼æ¡†æ¶1

SpringCloudæ¦‚è¿°

æœåŠ¡æ³¨å†Œä¸æœåŠ¡å‘ç°

æ­å»ºEurekaæ³¨å†Œä¸­å¿ƒ(æœåŠ¡å‘ç°)

å‘å¸ƒæœåŠ¡ä¼šå‘˜æä¾›è€…

æ¶ˆè´¹ä¼šå‘˜æœåŠ¡

springcloudè°ƒç”¨æœåŠ¡åŸç†

springcloudæœåŠ¡è´Ÿè½½å‡è¡¡å®ç°åŸç†

ä½¿ç”¨Ribbonæ­å»ºå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨

ä»€ä¹ˆæ˜¯æ¥å£ç½‘å…³

ä½¿ç”¨Zuulæ­å»ºæœåŠ¡æ¥å£ç½‘å…³ (æ™ºèƒ½è·¯ç”±)

ä½¿ç”¨Zuulç½‘å…³æ‹¦æˆªå‚æ•°

åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒæ¦‚è¿°

ä½¿ç”¨feginå®¢æˆ·ç«¯

æœåŠ¡é›ªå´©æ•ˆåº”äº§ç”ŸåŸå› 

é›ªå´©æ•ˆåº”è§£å†³æ–¹æ¡ˆ

ä½¿ç”¨hystrixå®ç°æœåŠ¡é™çº§

ä½¿ç”¨hystrixè§£å†³æœåŠ¡é›ªå´©åŸå› 



## åˆ†å¸ƒå¼æ¡†æ¶2

Dubboæ¶æ„åŸç†

Dubboåº”ç”¨åœºæ™¯

Dubboåˆ›å»ºé¡¹ç›®æ¶æ„æ¨¡å¼

å‘å¸ƒä¼šå‘˜æœåŠ¡

è®¢å•æ¶ˆè´¹æœåŠ¡

Dubbo-Admin

Dubboå®ç°è´Ÿè½½å‡è¡¡ã€å®¹é”™

Dubbxä½¿ç”¨



## Zookeeper

Zookeeperæ¦‚è¿°

Zookeeperåº”ç”¨åœºæ™¯

Zookeeperä¸´æ—¶èŠ‚ç‚¹

Watcheräº‹ä»¶é€šçŸ¥

Zookeeperå®ç°åˆ†å¸ƒå¼é”

è§£å†³ç”Ÿäº§è®¢å•å·çº¿ç¨‹å®‰å…¨é—®é¢˜

Zookeeperå®ç°åˆ†å¸ƒå¼é”è§£å†³æ–¹æ¡ˆ

Zookeeperå®ç°è´Ÿè½½å‡è¡¡åŸç†

å¦‚ä½•å®ç°è´Ÿè½½å‡è¡¡ç­–ç•¥

å¦‚ä½•å®ç°è´Ÿè½½å‡è¡¡è½®è®­ç®—æ³•

å¦‚ä½•ä½¿ç”¨Zookeeperå®ç°é€‰ä¸¾ç­–ç•¥



# ç§»åŠ¨ç«¯è§£å†³æ–¹æ¡ˆ

ç§»åŠ¨APPç™»å½•

ä½¿ç”¨Tokenç™»å½•

ä½¿ç”¨tokenæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯



ç§»åŠ¨ç«¯æ¸²æŸ“

å‡å°‘CPUã€GPUçš„è®¡ç®—æ—¶é—´ã€‚

å‡å°‘é‡ç»˜æ—¶é—´ã€æ¸²æŸ“æ¬¡æ•°

è¾ƒå°‘IOä¼ è¾“æ—¶é—´ï¼Œå¢åŠ ç¼“å­˜å†…å­˜ï¼›





# UMLç±»å›¾

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-02-001939.png" alt="image-20191102081938225" style="zoom:50%;" />



**å…³è”å…³ç³»**æè¿°çš„æ˜¯**ä¸åŒç±»çš„å¯¹è±¡**ä¹‹é—´çš„**ç»“æ„**å…³ç³»ã€‚è¿™ç§å…³ç³»æ˜¯ä¸€ç§==å¼ºå…³è”==å…³ç³»ï¼Œæ¯”å¦‚ `ä¹˜å®¢ - è½¦ç¥¨`ä¹‹é—´çš„å…³ç³»ï¼Œ`è€å¸ˆ - å­¦ç”Ÿ` ä¹‹é—´çš„å…³ç³»ã€‚å…³è”å…³ç³»é»˜è®¤ä¸å¼ºè°ƒæ–¹å‘ï¼Œè¡¨ç¤ºå¯¹è±¡ä¹‹é—´ç›¸äº’çŸ¥é“ã€‚å¦‚æœéœ€è¦å¼ºè°ƒå…³ç³»ï¼Œæ¯”å¦‚AçŸ¥é“Bï¼ŒBä¸çŸ¥é“Aï¼Œé‚£ä¹ˆç”¨ A -> Bæ¥è¡¨ç¤ºã€‚

**ä¾èµ–å…³ç³»**æè¿°çš„æ˜¯ä¸€ç§==ä¸´æ—¶æ€§==çš„å…³ç³»ï¼Œå®ƒä¼šåœ¨è¿è¡ŒæœŸé—´å‘ç”Ÿï¼Œéšç€è¿è¡Œæ—¶çš„å˜åŒ–ï¼Œå¯èƒ½ä¹Ÿå‘ç”Ÿå˜åŒ–ã€‚æ¯”å¦‚ç”¨æˆ·ç™»å½•ç³»ç»Ÿã€‚LoginServiceå°±æ˜¯ä¾èµ–Userå¯¹è±¡ï¼Œä½†è¿™ç§å…³ç³»æ˜¯ä¸éœ€è¦ä¿å­˜çš„ã€‚

åˆ¤æ–­åˆ°åº•æ˜¯å…³è”å…³ç³»è¿˜æ˜¯ä¾èµ–å…³ç³»ï¼Œä¸€èˆ¬å°±æ˜¯å…ˆçœ‹çœ‹æ˜¯ä¸æ˜¯å­˜åœ¨å…³è”å…³ç³»ï¼Œä¸æ˜¯çš„è¯å°±æ˜¯ä¾èµ–å…³ç³»ã€‚

åœ¨ä»£ç é‡Œï¼Œä¾èµ–å…³ç³»ä½“ç°ä¸º**ç±»æ„é€ æ–¹æ³•**åŠ**ç±»æ–¹æ³•çš„å…¥å‚**ï¼Œç®­å¤´çš„æ–¹å‘è¡¨ç¤ºäº†è°ƒç”¨å…³ç³»ã€‚ æ¯”å¦‚ A --> B ï¼Œè¡¨ç¤ºäº†Aè°ƒç”¨çš„Bçš„æ–¹æ³•æˆ–è€…å±æ€§ã€‚ é€šå¸¸æˆ‘ä»¬è¦**é¿å…åŒå‘ä¾èµ–å…³ç³»**çš„å‡ºç°ã€‚



# æ’®åˆç³»ç»Ÿ

## è®¢å•æ¨¡å—

ç”¨æˆ·è®¢å•é€šè¿‡ç½‘å…³è¿›å…¥åˆ°ç³»ç»Ÿï¼›

ç³»ç»Ÿæ¥æ”¶åˆ°è®¢å•åï¼Œç”Ÿæˆè®¢å•ç¼–å·ï¼ŒåŠ å…¥åˆ°å‘é€é˜Ÿåˆ—ä¸­ï¼›

å‘é€è€…å•ç‹¬å¯åŠ¨çº¿ç¨‹ï¼Œå‘mqé˜Ÿåˆ—ä¸­å‘é€æ¶ˆæ¯ï¼›

mqæ¶ˆè´¹è€…ç›‘å¬é˜Ÿåˆ—æ¶ˆæ¯ï¼Œä¸€éƒ¨åˆ†æ¶ˆè´¹è€…å°†è®¢å•è½åº“ï¼Œè¿˜æœ‰ä¸€éƒ¨åˆ†æ¶ˆè´¹è€…æŒ‰symbolæ¥è®¢é˜…è®¢å•ï¼›

è®¢å•ç³»ç»Ÿä¸»è¦å·¥ä½œå®Œæˆï¼›

## æ’®åˆæ¨¡å—

æ’®åˆæ¨¡å—é‡Œæœ‰2å—æœåŠ¡ï¼Œ1ä¸ªæœåŠ¡ç›‘å¬mqçš„é˜Ÿåˆ—ï¼Œç”¨æ’®åˆç®—æ³•è¿›è¡Œè®¡ç®—ï¼Œè®¡ç®—å®Œä»¥åï¼ŒæŒ‰å¸å¯¹ã€æ’åºåä¿å­˜åˆ°å†…å­˜ä¸­ï¼›

å¦‚æœ

æ’®åˆé€»è¾‘ï¼š

æœ‰ä¸€ç¬”æ–°çš„è®¢å•è¿›å…¥ç³»ç»Ÿï¼Œåˆ¤æ–­è®¢å•æ˜¯å¦æ˜¯æ’¤å•ï¼Ÿå¦‚æœæ˜¯æ’¤å•ï¼Œå°†è®¢å•ä»å†…å­˜ä¸­åˆ é™¤ã€‚

å¦åˆ™çš„è¯å…ˆåˆ¤æ–­ä¹°å–æ–¹å‘

å†åˆ¤æ–­è®¢å•ç±»å‹

å¦‚æœæ˜¯ä¹°å•ï¼Œå…ˆå–å–å•çš„ç¬¬ä¸€ä¸ªè®¢å•ï¼Œæ¯”è¾ƒä»·æ ¼ï¼Œå¦‚æœä¹°å•ä»·æ ¼å¤§äºç­‰äºå–å•ä»·æ ¼ï¼Œæˆäº¤ä¸¤ä¸ªè®¢å•ä¸­è¾ƒå°çš„ä¸€ä¸ªã€‚

ç”Ÿæˆå¹¶æ¨é€æˆäº¤ä¿¡æ¯åˆ°mqé‡Œã€‚

åˆ é™¤å†…å­˜é˜Ÿåˆ—é‡Œçš„è®¢å•

ç„¶ååˆ¤æ–­è¿™æ¯”ä¹°å•æ˜¯å¦å®Œæˆï¼Œå¦‚æœæ²¡æœ‰å®Œæˆï¼Œç»§ç»­å–ä¸‹ä¸€ä¸ªè®¢å•ã€‚

 **é˜Ÿåˆ—è‚¯å®šè¦åŠ é”ï¼Œé˜²æ­¢åˆ é™¤é”™è¯¯ï¼Œæˆ–è€…è¯»å–è„æ•°æ®**

å¦‚æœåˆ¤æ–­ä¸æ»¡è¶³æ¡ä»¶ï¼Œå‘ä¹°æ–¹é˜Ÿåˆ—é‡ŒåŠ å…¥è®¢å•ï¼Œå¹¶ä¸”é‡æ–°æ’åºã€‚



## æ•°æ®è¡¨è®¾è®¡

### è®¢å•ç±»å‹

é™ä»·å•

å¸‚ä»·å•

æ­¢ç›ˆæ­¢æŸ

### è®¢å•é˜Ÿåˆ—

è®¢å•é˜Ÿåˆ—æ’åº

ä»·æ ¼ä¼˜å…ˆ: ä¹°å•ä»é«˜å¾€ä½ï¼Œå–å•ä»ä½å¾€é«˜

åŒç­‰ä»·æ ¼æ—¶é—´ä¼˜å…ˆ

æ’®åˆé¡ºåºï¼š



### è‡ªåŠ¨æˆäº¤

æ’®åˆè®¢å•

ç”Ÿæˆäº¤æ˜“è®°å½•



### æ’®åˆç®—æ³•

å…¬å¹³æ€§ã€

é«˜æ•ˆæ€§

æ‰©å±•æ€§



éš¾ç‚¹:

1. åˆ†å¸ƒå¼å…¨å±€å”¯ä¸€idã€‚æ¯ä¸ªè®¢å•åº”è¯¥æœ‰ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„å®šåºçš„idï¼Œä¸èƒ½ç”¨æ—¶é—´æˆ³ï¼Œä¸æ–¹ä¾¿é˜…è¯»ï¼Œè€Œä¸”å¯èƒ½å­˜åœ¨å¤šä¸ªç›¸åŒçš„ã€‚







