# 1.配置gitlab钩子



**1.打开`Settings/Intergrations`，准备配置url和token。**

![image-20200311095509685](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-11-015510.png)





**2.获取url和token**

​	打开jenkins，找到job，点击配置



​	勾选下面的触发器选项![image-20200311100128281](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-11-020128.png)



​	点击生成secert token

![image-20200311100207832](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-11-020207.png)



​	复制生成得到的secret token以及上面出现的url，到第一步的位置

![image-20200311100556367](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-11-020556.png)



保存



配置完成





# 2.CICD流程

```
#image: gunner6/hello-ngnx

# 理解为阶段，相同阶段，并行执行；不同阶段，按先后顺序执行
stages:
  - pre_build
  - test
  - build
  - deploy

before_script:
  stage: pre_build
  script:
    - yarn install

lint:
  stage: test
  script:
  - npm run lint

build_dev:
  stage: build
  only: # 此job匹配哪个branch或者tag或者trigger
    - develop #只匹配develop分支
  script:
    - echo "done"

publish_build:
  stage: deploy
  script:
    - npm run build
    - docker build -t dva-demo .
```





1.创建`feature/bhop`分支

2.push分支

3.触发pipeline流水线 (最后一个)

![image-20200423151758431](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-04-23-071759.png)

4.流水线分三个stage

- build
- docker-build
- deploy

4.1 build操作时将从git上clone分支，然后运行 npm install && npm run build

4.2 docker-build：

- 先登录docker用户
- 然后拉取nginx镜像
- 将build生成的目录copy到/bh/www目录
- 暴露端口 80和443
- copy nginx配置文件
- 打包成image

4.3 deploy 将image发布到pod上。 // 这个还要研究下在干嘛

