<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>了解kubernetes | Coda的博客</title>
    <meta name="generator" content="VuePress 1.5.1">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="闲着无聊？那就读书吧">
    <link rel="preload" href="/assets/css/0.styles.c3659042.css" as="style"><link rel="preload" href="/assets/js/app.ee7e9306.js" as="script"><link rel="preload" href="/assets/js/2.c5c14eb8.js" as="script"><link rel="preload" href="/assets/js/10.18134ce1.js" as="script"><link rel="prefetch" href="/assets/js/11.bded85d3.js"><link rel="prefetch" href="/assets/js/12.bde1e69c.js"><link rel="prefetch" href="/assets/js/13.20f0daa8.js"><link rel="prefetch" href="/assets/js/14.e71fe2b7.js"><link rel="prefetch" href="/assets/js/15.973e36e2.js"><link rel="prefetch" href="/assets/js/16.48ea97ee.js"><link rel="prefetch" href="/assets/js/17.44165697.js"><link rel="prefetch" href="/assets/js/18.7656306f.js"><link rel="prefetch" href="/assets/js/19.3b73be2d.js"><link rel="prefetch" href="/assets/js/20.74c7944b.js"><link rel="prefetch" href="/assets/js/21.b42b7490.js"><link rel="prefetch" href="/assets/js/22.106ca3e0.js"><link rel="prefetch" href="/assets/js/23.37778393.js"><link rel="prefetch" href="/assets/js/24.139f505b.js"><link rel="prefetch" href="/assets/js/25.0ec9d512.js"><link rel="prefetch" href="/assets/js/26.14149d9d.js"><link rel="prefetch" href="/assets/js/27.d57592e1.js"><link rel="prefetch" href="/assets/js/28.3ff82e9d.js"><link rel="prefetch" href="/assets/js/29.97176bda.js"><link rel="prefetch" href="/assets/js/3.5c69924f.js"><link rel="prefetch" href="/assets/js/30.a378177d.js"><link rel="prefetch" href="/assets/js/31.43afb959.js"><link rel="prefetch" href="/assets/js/32.f60c48f3.js"><link rel="prefetch" href="/assets/js/33.29b7618e.js"><link rel="prefetch" href="/assets/js/34.50a3f818.js"><link rel="prefetch" href="/assets/js/35.3b1066cf.js"><link rel="prefetch" href="/assets/js/36.8e145340.js"><link rel="prefetch" href="/assets/js/37.c729ab18.js"><link rel="prefetch" href="/assets/js/38.b725d03a.js"><link rel="prefetch" href="/assets/js/39.417c26f6.js"><link rel="prefetch" href="/assets/js/4.c4955446.js"><link rel="prefetch" href="/assets/js/40.e50f245f.js"><link rel="prefetch" href="/assets/js/41.3fad6327.js"><link rel="prefetch" href="/assets/js/42.f6fd031d.js"><link rel="prefetch" href="/assets/js/43.bee5be46.js"><link rel="prefetch" href="/assets/js/44.38a9e0ae.js"><link rel="prefetch" href="/assets/js/45.b327da2c.js"><link rel="prefetch" href="/assets/js/46.fa32de5e.js"><link rel="prefetch" href="/assets/js/47.321c2a7d.js"><link rel="prefetch" href="/assets/js/48.ffd0f672.js"><link rel="prefetch" href="/assets/js/49.98c5d965.js"><link rel="prefetch" href="/assets/js/5.790d3fc0.js"><link rel="prefetch" href="/assets/js/50.d6cc7cea.js"><link rel="prefetch" href="/assets/js/51.35899890.js"><link rel="prefetch" href="/assets/js/52.56671b7a.js"><link rel="prefetch" href="/assets/js/53.93f7bd4c.js"><link rel="prefetch" href="/assets/js/54.355cbda6.js"><link rel="prefetch" href="/assets/js/55.0a9d4a28.js"><link rel="prefetch" href="/assets/js/56.91a6f7fb.js"><link rel="prefetch" href="/assets/js/57.30883235.js"><link rel="prefetch" href="/assets/js/58.03b57c8f.js"><link rel="prefetch" href="/assets/js/59.6049e24a.js"><link rel="prefetch" href="/assets/js/6.720e350f.js"><link rel="prefetch" href="/assets/js/60.4cb9a361.js"><link rel="prefetch" href="/assets/js/61.da950d0a.js"><link rel="prefetch" href="/assets/js/62.f9ee5059.js"><link rel="prefetch" href="/assets/js/63.0a05daa5.js"><link rel="prefetch" href="/assets/js/64.37951038.js"><link rel="prefetch" href="/assets/js/65.457e8917.js"><link rel="prefetch" href="/assets/js/66.d00a221f.js"><link rel="prefetch" href="/assets/js/67.9be23755.js"><link rel="prefetch" href="/assets/js/68.07f1f234.js"><link rel="prefetch" href="/assets/js/69.66fa7ec4.js"><link rel="prefetch" href="/assets/js/7.9f6e7a1c.js"><link rel="prefetch" href="/assets/js/70.47ce7932.js"><link rel="prefetch" href="/assets/js/71.0e10b798.js"><link rel="prefetch" href="/assets/js/72.fcbd2010.js"><link rel="prefetch" href="/assets/js/73.203164da.js"><link rel="prefetch" href="/assets/js/74.0991c52c.js"><link rel="prefetch" href="/assets/js/75.465d555b.js"><link rel="prefetch" href="/assets/js/76.8e4b5977.js"><link rel="prefetch" href="/assets/js/77.79b44f01.js"><link rel="prefetch" href="/assets/js/78.fb8d4e0d.js"><link rel="prefetch" href="/assets/js/79.7a2d46e1.js"><link rel="prefetch" href="/assets/js/8.c6c4c9d5.js"><link rel="prefetch" href="/assets/js/80.b8b3c540.js"><link rel="prefetch" href="/assets/js/81.e5263336.js"><link rel="prefetch" href="/assets/js/82.56d2b801.js"><link rel="prefetch" href="/assets/js/83.ad196b09.js"><link rel="prefetch" href="/assets/js/84.5962f519.js"><link rel="prefetch" href="/assets/js/85.78bda40f.js"><link rel="prefetch" href="/assets/js/86.350a2dcc.js"><link rel="prefetch" href="/assets/js/87.e90a517b.js"><link rel="prefetch" href="/assets/js/88.32101107.js"><link rel="prefetch" href="/assets/js/9.75d01cd2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c3659042.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Coda的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/服务端/" class="nav-link">
  服务端
</a></div><div class="nav-item"><a href="/前端/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/android/" class="nav-link">
  android
</a></div><div class="nav-item"><a href="/DevOps/" class="nav-link router-link-active">
  devOps
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/服务端/" class="nav-link">
  服务端
</a></div><div class="nav-item"><a href="/前端/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/android/" class="nav-link">
  android
</a></div><div class="nav-item"><a href="/DevOps/" class="nav-link router-link-active">
  devOps
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>了解kubernetes</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/DevOps/Kubernetes.html#基础概念" class="sidebar-link">基础概念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#什么是容器编排系统？" class="sidebar-link">什么是容器编排系统？</a></li><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#架构图" class="sidebar-link">架构图</a></li><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#kubernetes网络" class="sidebar-link">Kubernetes网络</a></li><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#scheduler-调度" class="sidebar-link">Scheduler 调度</a></li><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#kubernetes服务发现" class="sidebar-link">Kubernetes服务发现</a></li><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#_1-minikube" class="sidebar-link">1.minikube</a></li><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#_2-aws服务集群" class="sidebar-link">2.AWS服务集群</a></li></ul></li><li><a href="/DevOps/Kubernetes.html#操作命令" class="sidebar-link">操作命令</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/DevOps/Kubernetes.html#node-节点" class="sidebar-link">Node 节点</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/DevOps/Kubernetes.html#pod-容器组" class="sidebar-link">POD 容器组</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#查看pod的状态" class="sidebar-link">查看pod的状态</a></li><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#创建一个pod" class="sidebar-link">创建一个pod</a></li><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#为pod分配内存资源" class="sidebar-link">为pod分配内存资源</a></li><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#思考：如何让外界去访问这个pod的nginx服务？" class="sidebar-link">思考：如何让外界去访问这个pod的nginx服务？</a></li></ul></li><li><a href="/DevOps/Kubernetes.html#resource" class="sidebar-link">Resource</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#replicationcontroller" class="sidebar-link">ReplicationController</a></li><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#replicaset" class="sidebar-link">ReplicaSet</a></li></ul></li><li><a href="/DevOps/Kubernetes.html#deployment" class="sidebar-link">Deployment</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#创建管理deployment" class="sidebar-link">创建管理deployment</a></li></ul></li><li><a href="/DevOps/Kubernetes.html#externalname" class="sidebar-link">ExternalName</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/DevOps/Kubernetes.html#命名空间" class="sidebar-link">命名空间</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/DevOps/Kubernetes.html#services" class="sidebar-link">Services</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/DevOps/Kubernetes.html#labels" class="sidebar-link">Labels</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/DevOps/Kubernetes.html#nginx-ingress-教程" class="sidebar-link">Nginx Ingress 教程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#ing的配置文件" class="sidebar-link">ing的配置文件</a></li><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#查看目前的ingress服务" class="sidebar-link">查看目前的ingress服务</a></li><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#查看ingress的配置" class="sidebar-link">查看ingress的配置</a></li></ul></li><li><a href="/DevOps/Kubernetes.html#常用命令" class="sidebar-link">常用命令</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/DevOps/Kubernetes.html#查看网页界面" class="sidebar-link">查看网页界面</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/DevOps/Kubernetes.html#切换k8s的上下文" class="sidebar-link">切换k8s的上下文</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/DevOps/Kubernetes.html#查看k8s上的namespace" class="sidebar-link">查看k8s上的namespace</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/DevOps/Kubernetes.html#查看服务上的日志" class="sidebar-link">查看服务上的日志</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#第一种方式：通过dashboard-ui来查看" class="sidebar-link">第一种方式：通过dashboard ui来查看</a></li><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#第二种方式：进入查看" class="sidebar-link">第二种方式：进入查看</a></li><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#第三种方式：通过logs命令" class="sidebar-link">第三种方式：通过logs命令</a></li><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#第四种方式：describe-pod-查看-events" class="sidebar-link">第四种方式：describe pod 查看 events</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="了解kubernetes"><a href="#了解kubernetes" class="header-anchor">#</a> 了解kubernetes</h1> <p>https://kubernetes.io/zh/docs/concepts/</p> <h2 id="基础概念"><a href="#基础概念" class="header-anchor">#</a> 基础概念</h2> <p>https://www.kubernetes.org.cn/6986.html?from=singlemessage&amp;isappinstalled=0</p> <h3 id="什么是容器编排系统？"><a href="#什么是容器编排系统？" class="header-anchor">#</a> 什么是容器编排系统？</h3> <p>我们先反过来思考。假设我们有了一个编排系统，应该有哪些东西？</p> <p>第一，这个系统，肯定有一些服务是用来运行这个编排系统的，剩下的服务，用来运行业务容器。</p> <p>我们把运行编排系统的服务叫==master节点==，剩下的称为==worker节点==。</p> <ul><li>master节点负责管理服务器集群。</li></ul> <ol><li>==对外需要提供api接口，用来对接集群进行管理==。</li> <li>对内，woker节点通过api接口要，定时上报运行状态，接收管理。</li></ol> <p>master 上提供管理接口的组件称为 kube apiserver，对应的还需要两个用于和 api server 交互的客户端：</p> <ol><li><p>一个是提供给集群的运维管理员使用的，我们称为 ==kubectl==；</p></li> <li><p>一个是提供给 worker 节点使用的，我们称为 ==kubelet==。</p></li></ol> <p>==master对worker的管理调度组件，都是通过 kube scheduler来进行。==</p> <p>除此之外，master节点上，还应该有一个控制管理器，我们称之为kube-controller-manager，用来管理容器的运行状态。</p> <p>然后，因为master一般也是分布式的，所以需要一个etcd进行分布式存储。</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-28-005400.png" alt="architecture"></p> <p>综上我们可以知道，k8s大致包含有以下组件</p> <ul><li>Master 组件：kube-apiserver、kube-scheduler、etcd、kube-controller-manager；</li> <li>Node 组件：kubelet、kube-proxy；</li> <li>插件：DNS、用户界面 Web UI、容器资源监控、集群日志。</li></ul> <p>他们的关系如下：</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-28-010707.png" alt="4.png"></p> <h3 id="架构图"><a href="#架构图" class="header-anchor">#</a> 架构图</h3> <p>//todo</p> <h3 id="kubernetes网络"><a href="#kubernetes网络" class="header-anchor">#</a> Kubernetes网络</h3> <h4 id="pod网络"><a href="#pod网络" class="header-anchor">#</a> pod网络</h4> <p>集群内互通</p> <h4 id="pod通讯"><a href="#pod通讯" class="header-anchor">#</a> Pod通讯</h4> <h3 id="scheduler-调度"><a href="#scheduler-调度" class="header-anchor">#</a> Scheduler 调度</h3> <h4 id="preselect-预选规则"><a href="#preselect-预选规则" class="header-anchor">#</a> preselect 预选规则</h4> <p>NodiskConflict</p> <p>CheckNodeMemoryPressure</p> <p>NodeSelector</p> <p>FitResource</p> <p>Affinity</p> <h4 id="optimize-select-优选策略"><a href="#optimize-select-优选策略" class="header-anchor">#</a> Optimize-Select 优选策略</h4> <p>SelectorSpreadPriority</p> <p>LeastRequestedPriority</p> <p>AffinityPriority</p> <h3 id="kubernetes服务发现"><a href="#kubernetes服务发现" class="header-anchor">#</a> Kubernetes服务发现</h3> <p>kube-proxy(clusterIP)</p> <p>Kube-proxy(nodePort)</p> <p>Kube-dns</p> <h1 id="搭建kubernetes"><a href="#搭建kubernetes" class="header-anchor">#</a> 搭建kubernetes</h1> <blockquote><p>选择正确的解决方案</p></blockquote> <p>如果你只是想试一试Kubernetes，我们==推荐基于Docker的本地方案==。</p> <p>基于Docker的本地方案是众多能够完成快速搭建的本地集群方案中的一种，但是局限于单台机器。</p> <p>当你准备好扩展到多台机器和更高可用性时，托管解决方案是最容易搭建和维护的。</p> <p>全套云端方案 只需要少数几个命令就可以在更多的云服务提供商搭建Kubernetes。</p> <p>定制方案 需要花费更多的精力，但是覆盖了从零开始搭建Kubernetes集群的通用建议到分步骤的细节指引。</p> <h3 id="_1-minikube"><a href="#_1-minikube" class="header-anchor">#</a> 1.minikube</h3> <blockquote><p>https://github.com/kubernetes/minikube</p></blockquote> <p>Minikube 是一种可以让您在本地轻松运行 Kubernetes 的工具。Minikube 在笔记本电脑上的虚拟机（VM）中运行单节点 Kubernetes 集群，供那些希望尝试 Kubernetes 或进行日常开发的用户使用。</p> <ul><li>首先需要在mac 安装<a href="https://github.com/kubernetes/minikube" target="_blank" rel="noopener noreferrer">minikube<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>brew <span class="token function">install</span> minikube
</code></pre></div><ul><li>然后安装<a href="https://github.com/kubernetes/kubernetes" target="_blank" rel="noopener noreferrer">kubectl<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>kubectl是本地的cli命令，可以检查集群资源；创建，删除和更新组件。</p> <div class="language-shell extra-class"><pre class="language-shell"><code> brew <span class="token function">install</span> kubectl
</code></pre></div><ul><li>启动minikube</li></ul> <p><code>minukube start</code></p> <p>不过上面的命令，国内安装基本上都会失败, ==所以需要用下面的带了更多参数的命令==</p> <div class="language-shell extra-class"><pre class="language-shell"><code>minikube start <span class="token punctuation">\</span>
--vm-driver<span class="token operator">=</span>virtualbox <span class="token punctuation">\</span>
--image-mirror-country<span class="token operator">=</span>cn <span class="token punctuation">\</span>
--registry-mirror<span class="token operator">=</span><span class="token string">'https://alzgoonw.mirror.aliyuncs.com'</span> <span class="token punctuation">\</span>
--image-repository<span class="token operator">=</span><span class="token string">'registry.cn-hangzhou.aliyuncs.com/google_containers'</span> <span class="token punctuation">\</span>

</code></pre></div><ul><li>这个命令创建一个名为 <code>minikube</code> 的 <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#-em-set-context-em-" target="_blank" rel="noopener noreferrer">kubectl 上下文<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。 此上下文包含与 Minikube 集群通信的配置。</li></ul> <p>==kubectl连k8s的控制台，需要指定context。==</p> <p>Minikube 会自动将此上下文设置为默认值，也可以运行</p> <div class="language- extra-class"><pre class="language-text"><code>kubectl config use-context minikube
</code></pre></div><ul><li>要访问 <a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/" target="_blank" rel="noopener noreferrer">Kubernetes Dashboard<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，请在启动 Minikube 后在 shell 中运行此命令以获取地址：</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>minikube dashboard
</code></pre></div><p>可以看到k8s的控制界面</p> <p>http://127.0.0.1:59860/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/#/overview?namespace=default</p> <ul><li>查看集群配置信息</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl config view <span class="token comment"># 查看kubeconfig的配置信息</span>
kubectl cluster-info <span class="token comment"># 看当前k8s集群的情况</span>
</code></pre></div><ul><li>minikube的远程连接</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>minikube <span class="token function">ssh</span> <span class="token comment"># 连接到一个kube上</span>
</code></pre></div><h3 id="_2-aws服务集群"><a href="#_2-aws服务集群" class="header-anchor">#</a> 2.AWS服务集群</h3> <p>一般企业里会用到，购买服务后， 通过本地kube的配置文件<code>~/.kube</code>，进行远程连接。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl config view <span class="token comment"># 显示合并的 kubeconfig 配置。</span>

<span class="token comment"># 同时使用多个 kubeconfig 文件。 并查看合并的配置</span>
<span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span>~/.kube/config:~/.kube/kubconfig2

<span class="token comment"># 获取 e2e 用户的密码</span>
kubectl config view -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">'{.users[?(@.name == &quot;e2e&quot;)].user.password}'</span>

kubectl config current-context              <span class="token comment"># 展示当前所处的上下文</span>
kubectl config use-context my-cluster-name  <span class="token comment"># 设置默认的上下文为 my-cluster-name</span>
</code></pre></div><h1 id="使用kubernetes"><a href="#使用kubernetes" class="header-anchor">#</a> 使用kubernetes</h1> <h2 id="操作命令"><a href="#操作命令" class="header-anchor">#</a> 操作命令</h2> <div class="language-shell extra-class"><pre class="language-shell"><code>➜ kubectl
kubectl controls the Kubernetes cluster manager.

 Find <span class="token function">more</span> information at: https://kubernetes.io/docs/reference/kubectl/overview/

Basic Commands <span class="token punctuation">(</span>Beginner<span class="token punctuation">)</span>:
  create         Create a resource from a <span class="token function">file</span> or from stdin.
  expose         使用 replication controller, service, deployment 或者 pod
并暴露它作为一个 新的 Kubernetes Service
  run            在集群中运行一个指定的镜像
  <span class="token builtin class-name">set</span>            为 objects 设置一个指定的特征

Basic Commands <span class="token punctuation">(</span>Intermediate<span class="token punctuation">)</span>:
  explain        查看资源的文档
  get            显示一个或更多 resources
  edit           在服务器上编辑一个资源
  delete         Delete resources by filenames, stdin, resources and names, or by resources and
label selector

Deploy Commands:
  rollout        Manage the rollout of a resource
  scale          Set a new size <span class="token keyword">for</span> a Deployment, ReplicaSet or Replication Controller
  autoscale      自动调整一个 Deployment, ReplicaSet, 或者 ReplicationController
的副本数量

Cluster Management Commands:
  certificate    修改 certificate 资源.
  cluster-info   显示集群信息
  <span class="token function">top</span>            Display Resource <span class="token punctuation">(</span>CPU/Memory/Storage<span class="token punctuation">)</span> usage.
  cordon         标记 node 为 unschedulable
  uncordon       标记 node 为 schedulable
  drain          Drain node <span class="token keyword">in</span> preparation <span class="token keyword">for</span> maintenance
  taint          更新一个或者多个 node 上的 taints

Troubleshooting and Debugging Commands:
  describe       显示一个指定 resource 或者 group 的 resources 详情
  logs           输出容器在 pod 中的日志
  attach         Attach 到一个运行中的 container
  <span class="token builtin class-name">exec</span>           在一个 container 中执行一个命令
  port-forward   Forward one or <span class="token function">more</span> <span class="token builtin class-name">local</span> ports to a pod
  proxy          运行一个 proxy 到 Kubernetes API server
  <span class="token function">cp</span>             复制 files 和 directories 到 containers 和从容器中复制 files 和
directories.
  auth           Inspect authorization

Advanced Commands:
  <span class="token function">diff</span>           Diff live version against would-be applied version
  apply          通过文件名或标准输入流<span class="token punctuation">(</span>stdin<span class="token punctuation">)</span>对资源进行配置
  patch          使用 strategic merge patch 更新一个资源的 field<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
  replace        通过 filename 或者 stdin替换一个资源
  <span class="token function">wait</span>           Experimental: Wait <span class="token keyword">for</span> a specific condition on one or many resources.
  convert        在不同的 API versions 转换配置文件
  kustomize      Build a kustomization target from a directory or a remote url.


</code></pre></div><blockquote><p>Kubernetes  节点(node)：一个节点是一个运行Kubernetes中的主机。
Kubernetes  容器组：一个Pod对应于由若干容器组成的一个容器组，同个组内的容器共享一个存储卷(volume)。
Kubernetes  容器组生命周期：包含所有容器状态集合，包括容器组状态类型，容器组生命周期，事件，重启策略，以及replication controllers。
Kubernetes  Replication Controllers：主要负责指定数量的pod在同一时间一起运行。
Kubernetes  服务：一个Kubernetes服务是容器组逻辑的高级抽象，同时也对外提供访问容器组的策略。
Kubernetes  卷：一个卷就是一个目录，容器对其有访问权限。
Kubernetes  标签：标签是用来连接一组对象的，比如容器组。标签可以被用来组织和选择子对象。
Kubernetes  接口权限：端口，ip地址和代理的防火墙规则。
Kubernetes  web界面：用户可以通过web界面操作Kubernetes。
Kubernetes  命令行操作： kubecfg 命令。</p></blockquote> <h2 id="node-节点"><a href="#node-节点" class="header-anchor">#</a> Node 节点</h2> <p>一个Node对应一个运行kubernete集群中的节点</p> <p>查看当前context下的node</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl get node
</code></pre></div><p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-28-000045.png" alt="image-20200328080044652"></p> <h2 id="pod-容器组"><a href="#pod-容器组" class="header-anchor">#</a> POD 容器组</h2> <p>一个pod使用相同的docker容器并且共享volume</p> <p>pod是k8s里最小的单位，它用来运行容器。</p> <p>一般通过yml文件对pod进行创建、删除操作</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 通过pod.json文件中指定的资源类型和名称删除一个pod</span>
$ kubectl create -f ./pod.yml
$ kubectl delete -f ./pod.yml
</code></pre></div><h3 id="查看pod的状态"><a href="#查看pod的状态" class="header-anchor">#</a> 查看pod的状态</h3> <div class="language- extra-class"><pre class="language-text"><code>➜  ~ kubectl describe pod broker-api -n dev-margin
</code></pre></div><h3 id="创建一个pod"><a href="#创建一个pod" class="header-anchor">#</a> 创建一个pod</h3> <p>我们通过yml文件创建并且启动一个nginx pod</p> <p>1.创建一个<code>pod-nginx.yml</code></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre></div><p>2.验证pod创建成功</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl cversion <span class="token comment">#先确认kubectl连接上了</span>
$ kubectl create -f pod-nginx.yml <span class="token comment"># 根据yml文件创建pod</span>
$ kubectl get pods -o wide <span class="token comment"># 查看pod详细信息</span>
</code></pre></div><p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-27-121551.png" alt="image-20200327201551379"></p> <p>3.如果需要进入一个pod里，运行 <code>--it</code>命令</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl <span class="token builtin class-name">exec</span> -it nginx <span class="token function">sh</span> <span class="token comment"># 可以进入某一个pod的容器里</span>
</code></pre></div><h3 id="为pod分配内存资源"><a href="#为pod分配内存资源" class="header-anchor">#</a> 为pod分配内存资源</h3> <p><a href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/assign-memory-resource/#%E8%B6%85%E8%BF%87%E5%AE%B9%E5%99%A8%E9%99%90%E5%88%B6%E7%9A%84%E5%86%85%E5%AD%98" target="_blank" rel="noopener noreferrer">官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="思考：如何让外界去访问这个pod的nginx服务？"><a href="#思考：如何让外界去访问这个pod的nginx服务？" class="header-anchor">#</a> <strong>思考：如何让外界去访问这个pod的nginx服务？</strong></h3> <p>方案1：可以将nginx服务映射到minikube机器的ip上</p> <p>通过port-forward命令，将本地端口映射到pod端口上</p> <div class="language-js extra-class"><pre class="language-js"><code>Examples<span class="token operator">:</span>
  # Listen on ports <span class="token number">5000</span> and <span class="token number">6000</span> locally<span class="token punctuation">,</span> forwarding data to<span class="token operator">/</span><span class="token keyword">from</span> ports <span class="token number">5000</span> and <span class="token number">6000</span> <span class="token keyword">in</span> the pod
  kubectl port<span class="token operator">-</span>forward pod<span class="token operator">/</span>mypod <span class="token number">5000</span> <span class="token number">6000</span>

  # Listen on ports <span class="token number">5000</span> and <span class="token number">6000</span> locally<span class="token punctuation">,</span> forwarding data to<span class="token operator">/</span><span class="token keyword">from</span> ports <span class="token number">5000</span> and <span class="token number">6000</span> <span class="token keyword">in</span> a pod selected by the
deployment
  kubectl port<span class="token operator">-</span>forward deployment<span class="token operator">/</span>mydeployment <span class="token number">5000</span> <span class="token number">6000</span>

  # Listen on ports <span class="token number">5000</span> and <span class="token number">6000</span> locally<span class="token punctuation">,</span> forwarding data to<span class="token operator">/</span><span class="token keyword">from</span> ports <span class="token number">5000</span> and <span class="token number">6000</span> <span class="token keyword">in</span> a pod selected by the service
  kubectl port<span class="token operator">-</span>forward service<span class="token operator">/</span>myservice <span class="token number">5000</span> <span class="token number">6000</span>

  # Listen on port <span class="token number">8888</span> locally<span class="token punctuation">,</span> forwarding to <span class="token number">5000</span> <span class="token keyword">in</span> the pod
  kubectl port<span class="token operator">-</span>forward pod<span class="token operator">/</span>mypod <span class="token number">8888</span><span class="token operator">:</span><span class="token number">5000</span>

  # Listen on port <span class="token number">8888</span> on all addresses<span class="token punctuation">,</span> forwarding to <span class="token number">5000</span> <span class="token keyword">in</span> the pod
  kubectl port<span class="token operator">-</span>forward <span class="token operator">--</span>address <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span> pod<span class="token operator">/</span>mypod <span class="token number">8888</span><span class="token operator">:</span><span class="token number">5000</span>

  # Listen on port <span class="token number">8888</span> on localhost and selected <span class="token constant">IP</span><span class="token punctuation">,</span> forwarding to <span class="token number">5000</span> <span class="token keyword">in</span> the pod
  kubectl port<span class="token operator">-</span>forward <span class="token operator">--</span>address localhost<span class="token punctuation">,</span><span class="token number">10.19</span><span class="token number">.21</span><span class="token number">.23</span> pod<span class="token operator">/</span>mypod <span class="token number">8888</span><span class="token operator">:</span><span class="token number">5000</span>

  # Listen on a random port locally<span class="token punctuation">,</span> forwarding to <span class="token number">5000</span> <span class="token keyword">in</span> the pod
  kubectl port<span class="token operator">-</span>forward pod<span class="token operator">/</span>mypod <span class="token operator">:</span><span class="token number">5000</span>
</code></pre></div><h2 id="resource"><a href="#resource" class="header-anchor">#</a> Resource</h2> <h3 id="replicationcontroller"><a href="#replicationcontroller" class="header-anchor">#</a> ReplicationController</h3> <p>ReplicationController 类似于进程管理器，但是 ReplicationController 不是监控单个节点上的单个进程，而是监控跨多个节点的多个 pod。</p> <h4 id="yml格式"><a href="#yml格式" class="header-anchor">#</a> yml格式</h4> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicationController
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment">#指定同时运行多少个pod</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment">#标签选择器，管理所有与之匹配的pod</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment">#必须字段</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment">#必须和.spec.selector相同，否则被api拒绝。</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre></div><h4 id="创建rc"><a href="#创建rc" class="header-anchor">#</a> 创建rc</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl create -f replication.yml
</code></pre></div><h4 id="扩容缩容"><a href="#扩容缩容" class="header-anchor">#</a> 扩容缩容</h4> <p>通过简单地更新 <code>replicas</code> 字段，ReplicationController 可以方便地横向扩容或缩容副本的数量，或手动或通过自动缩放控制代理</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl scale --replicas<span class="token operator">=</span><span class="token number">1</span> rc/nginx
</code></pre></div><p>这样可以手动把nginx 缩放到1个pod</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-29-015054.png" alt="image-20200329095054336"></p> <h4 id="删除rc以及对应的pod"><a href="#删除rc以及对应的pod" class="header-anchor">#</a> <strong>删除rc以及对应的pod</strong></h4> <p>要删除一个 ReplicationController 以及它的 Pod，使用 <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#delete" target="_blank" rel="noopener noreferrer"><code>kubectl delete</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。 kubectl 将 ReplicationController 缩放为 0 并等待以便在删除 ReplicationController 本身之前删除每个 Pod。</p> <div class="language- extra-class"><pre class="language-text"><code>kubectl delete -f replication.yml
</code></pre></div><p>总结一下，步骤为：</p> <p>1.缩放副本为 0、</p> <p>2.等待 Pod 删除，之后删除 ReplicationController 资源</p> <h3 id="replicaset"><a href="#replicaset" class="header-anchor">#</a> ReplicaSet</h3> <p>ReplicaSet是replication controller的升级版。</p> <p>*<code>Replication Controller</code>*只支持基于等式的selector（env=dev或environment!=qa），但ReplicaSet还支持基于集合的selector。比如：version in (v1.0, v2.0)或 env notin (dev, qa)</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicaSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> frontend
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> guestbook
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
    <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># 表达式</span>
      <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token key atrule">key</span><span class="token punctuation">:</span> tier<span class="token punctuation">,</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> In<span class="token punctuation">,</span> <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>frontend<span class="token punctuation">]</span><span class="token punctuation">}</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> guestbook
        <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>redis
        <span class="token key atrule">image</span><span class="token punctuation">:</span> gcr.io/google_samples/gb<span class="token punctuation">-</span>frontend<span class="token punctuation">:</span>v3
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>

</code></pre></div><p>创建rs后，我们看一下rs的信息：</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-29-060644.png" alt="image-20200329140643726"></p> <h2 id="deployment"><a href="#deployment" class="header-anchor">#</a> Deployment</h2> <p>提供一个声明式的更新</p> <p>可以声明需要更新的版本</p> <h3 id="创建管理deployment"><a href="#创建管理deployment" class="header-anchor">#</a> 创建管理deployment</h3> <p>1.定义一个yml文件</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 通过selector声明pods</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre></div><p>2.创建deployment</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl create -f ./deployment_nginx.yml
</code></pre></div><p>3.查看deployment</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl get deployment -o wide
</code></pre></div><p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-27-233517.png" alt="image-20200328073517412"></p> <p>4.查看replicaSet 和 pods</p> <p>所以创建deployment的时候，也会创建rs资源。</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-27-233610.png" alt="image-20200328073609314"></p> <p>5.通过deployment来更新image</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl <span class="token builtin class-name">set</span> image deployment nginx-deployment <span class="token assign-left variable">nginx</span><span class="token operator">=</span>nginx:1.13
</code></pre></div><p>等待一会儿，就可以看到，deployment被更新了</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-27-234255.png" alt="image-20200328074254196"></p> <p>6.如果需要回滚，或者查看历史。</p> <p>通过rollout undo、rollout history来进行操作</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl rollout undo deployment nginx-deployment
$ kubectl rollout <span class="token function">history</span> deployment nginx-deployment
</code></pre></div><p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-27-234558.png" alt="image-20200328074558262"></p> <h2 id="externalname"><a href="#externalname" class="header-anchor">#</a> ExternalName</h2> <div class="language- extra-class"><pre class="language-text"><code>kubectl create svc externalname -n test-bhop prerender --external-name prerender.broker.svc.cluster.local
</code></pre></div><h2 id="命名空间"><a href="#命名空间" class="header-anchor">#</a> 命名空间</h2> <div class="language- extra-class"><pre class="language-text"><code>kubectl get namespace
</code></pre></div><h2 id="services"><a href="#services" class="header-anchor">#</a> Services</h2> <div class="language- extra-class"><pre class="language-text"><code>kubectl get services                          # 列出当前命名空间下的所有 services
</code></pre></div><p>第一种方式：通过expose命令</p> <p>将pod expose为一个service, 类型为NodePort</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl expose pods nginx-pod --type<span class="token operator">=</span>NodePort
</code></pre></div><p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-28-023332.png" alt="image-20200328103332201"></p> <p>可以通过32685这个端口去访问pod的服务</p> <p>第二种：通过yml文件去创建</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>service
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># 也可以指定pod的port name: 比如nginx-port</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
</code></pre></div><p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-28-023829.png" alt="image-20200328103829227"></p> <h2 id="labels"><a href="#labels" class="header-anchor">#</a> Labels</h2> <p>k8s里几乎所有资源都可以设置label，做个试验</p> <p>先创建一个pods</p> <div class="language- extra-class"><pre class="language-text"><code>apiVersion: v1
kind: Pod
metadata:
  name: nginx-pod
  labels:
    app: nginx
spec:
  containers:
  - name: nginx-pod
    image: nginx
    ports:
    - containerPort: 80
</code></pre></div><p>expose service</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-28-012122.png" alt="image-20200328092121258"></p> <blockquote><p>--type=:   ClusterIP, NodePort, LoadBalancer, or ExternalName. Default is 'ClusterIP'.</p></blockquote> <p>通过ip + 端口 可以访问</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-28-012419.png" alt="image-20200328092419233"></p> <p>显示node的labels</p> <div class="language- extra-class"><pre class="language-text"><code>$ kubectl get node --show-labels
</code></pre></div><p>设置node的labels</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl label node <span class="token variable">${node_name}</span> <span class="token assign-left variable">key</span><span class="token operator">=</span>value <span class="token comment"># 设置node的label</span>
</code></pre></div><p>显示pods的labels</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-28-013043.png" alt="image-20200328093042661"></p> <h1 id="其他待了解"><a href="#其他待了解" class="header-anchor">#</a> 其他待了解</h1> <h2 id="nginx-ingress-教程"><a href="#nginx-ingress-教程" class="header-anchor">#</a> Nginx Ingress 教程</h2> <h3 id="ing的配置文件"><a href="#ing的配置文件" class="header-anchor">#</a> ing的配置文件</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># Please edit the object below. Lines beginning with a '#' will be ignored,</span>
<span class="token comment"># and an empty file will abort the edit. If an error occurs while saving this file will be</span>
<span class="token comment"># reopened with the relevant failures.</span>
<span class="token comment">#</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">alb.ingress.kubernetes.io/actions.ssl-redirect</span><span class="token punctuation">:</span> '<span class="token punctuation">{</span><span class="token key atrule">&quot;Type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;redirect&quot;</span><span class="token punctuation">,</span> <span class="token key atrule">&quot;RedirectConfig&quot;</span><span class="token punctuation">:</span>
      <span class="token punctuation">{</span> <span class="token key atrule">&quot;Protocol&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;HTTPS&quot;</span><span class="token punctuation">,</span> <span class="token key atrule">&quot;Port&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;443&quot;</span><span class="token punctuation">,</span> <span class="token key atrule">&quot;StatusCode&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;HTTP_301&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>'
    <span class="token key atrule">alb.ingress.kubernetes.io/certificate-arn</span><span class="token punctuation">:</span> arn<span class="token punctuation">:</span>aws<span class="token punctuation">:</span>acm<span class="token punctuation">:</span>ap<span class="token punctuation">-</span>northeast<span class="token punctuation">-</span>1<span class="token punctuation">:</span>667164967571<span class="token punctuation">:</span>certificate/83d8ae8f<span class="token punctuation">-</span>1c13<span class="token punctuation">-</span>405b<span class="token punctuation">-</span>a0ca<span class="token punctuation">-</span>6d50f3d1cacf
    <span class="token key atrule">alb.ingress.kubernetes.io/listen-ports</span><span class="token punctuation">:</span> <span class="token string">'[{&quot;HTTP&quot;: 80}, {&quot;HTTPS&quot;: 443}]'</span>
    <span class="token key atrule">alb.ingress.kubernetes.io/load-balancer-attributes</span><span class="token punctuation">:</span> routing.http2.enabled=true
    <span class="token key atrule">alb.ingress.kubernetes.io/scheme</span><span class="token punctuation">:</span> internal
    <span class="token key atrule">alb.ingress.kubernetes.io/security-groups</span><span class="token punctuation">:</span> sg<span class="token punctuation">-</span>06482acc94d50f475
    <span class="token key atrule">alb.ingress.kubernetes.io/subnets</span><span class="token punctuation">:</span> subnet<span class="token punctuation">-</span>0c204e2d858a90fea<span class="token punctuation">,</span>subnet<span class="token punctuation">-</span>05c4eed2a1a5a94ea
    <span class="token key atrule">alb.ingress.kubernetes.io/success-codes</span><span class="token punctuation">:</span> 200<span class="token punctuation">-</span><span class="token number">404</span>
    <span class="token key atrule">alb.ingress.kubernetes.io/target-type</span><span class="token punctuation">:</span> ip
    <span class="token key atrule">kubernetes.io/ingress.class</span><span class="token punctuation">:</span> alb
<span class="token comment"># Please edit the object below. Lines beginning with a '#' will be ignored,</span>
<span class="token comment"># and an empty file will abort the edit. If an error occurs while saving this file will be</span>
<span class="token comment"># reopened with the relevant failures.</span>
<span class="token comment">#</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">alb.ingress.kubernetes.io/actions.ssl-redirect</span><span class="token punctuation">:</span> '<span class="token punctuation">{</span><span class="token key atrule">&quot;Type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;redirect&quot;</span><span class="token punctuation">,</span> <span class="token key atrule">&quot;RedirectConfig&quot;</span><span class="token punctuation">:</span>
      <span class="token punctuation">{</span> <span class="token key atrule">&quot;Protocol&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;HTTPS&quot;</span><span class="token punctuation">,</span> <span class="token key atrule">&quot;Port&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;443&quot;</span><span class="token punctuation">,</span> <span class="token key atrule">&quot;StatusCode&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;HTTP_301&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>'
    <span class="token key atrule">alb.ingress.kubernetes.io/certificate-arn</span><span class="token punctuation">:</span> arn<span class="token punctuation">:</span>aws<span class="token punctuation">:</span>acm<span class="token punctuation">:</span>ap<span class="token punctuation">-</span>northeast<span class="token punctuation">-</span>1<span class="token punctuation">:</span>667164967571<span class="token punctuation">:</span>certificate/83d8ae8f<span class="token punctuation">-</span>1c13<span class="token punctuation">-</span>405b<span class="token punctuation">-</span>a0ca<span class="token punctuation">-</span>6d50f3d1cacf
    <span class="token key atrule">alb.ingress.kubernetes.io/listen-ports</span><span class="token punctuation">:</span> <span class="token string">'[{&quot;HTTP&quot;: 80}, {&quot;HTTPS&quot;: 443}]'</span>
    <span class="token key atrule">alb.ingress.kubernetes.io/load-balancer-attributes</span><span class="token punctuation">:</span> routing.http2.enabled=true
    <span class="token key atrule">alb.ingress.kubernetes.io/scheme</span><span class="token punctuation">:</span> internal
    <span class="token key atrule">alb.ingress.kubernetes.io/security-groups</span><span class="token punctuation">:</span> sg<span class="token punctuation">-</span>06482acc94d50f475
    <span class="token key atrule">alb.ingress.kubernetes.io/subnets</span><span class="token punctuation">:</span> subnet<span class="token punctuation">-</span>0c204e2d858a90fea<span class="token punctuation">,</span>subnet<span class="token punctuation">-</span>05c4eed2a1a5a94ea
    <span class="token key atrule">alb.ingress.kubernetes.io/success-codes</span><span class="token punctuation">:</span> 200<span class="token punctuation">-</span><span class="token number">404</span>
    <span class="token key atrule">alb.ingress.kubernetes.io/target-type</span><span class="token punctuation">:</span> ip
    <span class="token key atrule">kubernetes.io/ingress.class</span><span class="token punctuation">:</span> alb
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">&quot;2020-06-10T07:11:48Z&quot;</span>
  <span class="token key atrule">generation</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> www<span class="token punctuation">-</span>bhex<span class="token punctuation">-</span>us
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>margin
  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">&quot;89033678&quot;</span>
  <span class="token key atrule">selfLink</span><span class="token punctuation">:</span> /apis/extensions/v1beta1/namespaces/test<span class="token punctuation">-</span>margin/ingresses/www<span class="token punctuation">-</span>bhex<span class="token punctuation">-</span>us
  <span class="token key atrule">uid</span><span class="token punctuation">:</span> a638d960<span class="token punctuation">-</span>aae9<span class="token punctuation">-</span>11ea<span class="token punctuation">-</span>9c16<span class="token punctuation">-</span>06b6d63a90fc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>margin<span class="token punctuation">-</span>www.bhex.us
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token key atrule">-backend</span><span class="token punctuation">:</span>
      		<span class="token key atrule">serviceName</span><span class="token punctuation">:</span> activity<span class="token punctuation">-</span>web
        	<span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /activity/*
      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> exchange<span class="token punctuation">-</span>h5
          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /m/*
      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> quote<span class="token punctuation">-</span>server
          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">7124</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /api/quote/*
      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> broker<span class="token punctuation">-</span>api
          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">7120</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /api/*
<span class="token key atrule">status</span><span class="token punctuation">:</span>
	<span class="token key atrule">loadBalance</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><h3 id="查看目前的ingress服务"><a href="#查看目前的ingress服务" class="header-anchor">#</a> 查看目前的ingress服务</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>➜  ~ kubectl get ingress -n test-margin // -n 可以指定namespace
</code></pre></div><h3 id="查看ingress的配置"><a href="#查看ingress的配置" class="header-anchor">#</a> 查看ingress的配置</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>➜ kubectl get ing -n test-margin // 获取ingress的配置
➜ kubectl edit ing www-bhex-us -n test-margin // 修改ingress的配置
</code></pre></div><h1 id="备忘录"><a href="#备忘录" class="header-anchor">#</a> 备忘录</h1> <h2 id="常用命令"><a href="#常用命令" class="header-anchor">#</a> <a href="https://kubernetes.io/zh/docs/reference/kubectl/cheatsheet/#%E4%B8%8E%E8%BF%90%E8%A1%8C%E4%B8%AD%E7%9A%84-pods-%E8%BF%9B%E8%A1%8C%E4%BA%A4%E4%BA%92" target="_blank" rel="noopener noreferrer">常用命令<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></h2> <h2 id="查看网页界面"><a href="#查看网页界面" class="header-anchor">#</a> 查看网页界面</h2> <p>需要先本地启动一个命令行代理，可以使用 kubectl 命令行工具来启动</p> <div class="language- extra-class"><pre class="language-text"><code>kubectl proxy
</code></pre></div><p>启动成功后可以让本地通过<a href="http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/" target="_blank" rel="noopener noreferrer">这个地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>来访问</p> <p>如果命名空间错误的话，查看一下k8s上面的dashboard的服务名称，然后替换掉。</p> <p>比如这个kube-system名字不对，那就去查看一下pods的名称</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-04-23-091043.png" alt="image-20200423171043037"></p> <p>查看命令：</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-06-16-023402.png" alt="image-20200616103401302"></p> <p>替换后的dashboard地址是：http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/</p> <h2 id="切换k8s的上下文"><a href="#切换k8s的上下文" class="header-anchor">#</a> 切换k8s的上下文</h2> <p>如果有多个k8s环境可以连接的话，可以通过切换context的方式，来指定连接到某个context上。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl config current-context  <span class="token comment"># 展示当前所处的上下文</span>
$ kubectl config get-contexts <span class="token comment"># 显示一个或多个contexts</span>
$ kubectl config use-context <span class="token comment"># 切换上下文</span>
</code></pre></div><p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-27-235902.png" alt="image-20200328075902219"></p> <h2 id="查看k8s上的namespace"><a href="#查看k8s上的namespace" class="header-anchor">#</a> 查看k8s上的namespace</h2> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get namespace
</code></pre></div><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-06-16-031907.png" alt="image-20200616111906986" style="zoom:43%;"> <h2 id="查看服务上的日志"><a href="#查看服务上的日志" class="header-anchor">#</a> 查看服务上的日志</h2> <p>查看日志有两种方式。</p> <h3 id="第一种方式：通过dashboard-ui来查看"><a href="#第一种方式：通过dashboard-ui来查看" class="header-anchor">#</a> 第一种方式：通过dashboard ui来查看</h3> <p>Step1 选择namespace</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-06-16-025140.png" alt="image-20200616105140465" style="zoom:35%;"> <p>Step2 选择pods</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-06-16-025224.png" alt="image-20200616105224187"></p> <p>Step3 点击查看日志</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-06-16-030029.png" alt="image-20200616110029315"></p> <h3 id="第二种方式：进入查看"><a href="#第二种方式：进入查看" class="header-anchor">#</a> 第二种方式：进入查看</h3> <p>Step1. 选择context(参考切换上下文)</p> <p>Step2. 选择好namespace</p> <p>Step3. 获取pods名称</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-06-16-032034.png" alt="image-20200616112033993"></p> <p>Step4. 进入pods里面</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-06-16-032509.png" alt="image-20200616112508807"></p> <h3 id="第三种方式：通过logs命令"><a href="#第三种方式：通过logs命令" class="header-anchor">#</a> 第三种方式：通过logs命令</h3> <p>如果pods的状态不正常，无法直接通过exec -it进入pod里面，就可以直接使用kubectl logs的命令。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl logs pod
</code></pre></div><p><img src="/Users/keyang/notes/docs/DevOps/image-20200628120435457.png" alt="image-20200628120435457"></p> <h3 id="第四种方式：describe-pod-查看-events"><a href="#第四种方式：describe-pod-查看-events" class="header-anchor">#</a> 第四种方式：describe pod 查看 events</h3> <div class="language- extra-class"><pre class="language-text"><code>kubectl describe pod exchange-h5-67586ffc48-vj4td -n cloud
</code></pre></div><p><img src="/Users/keyang/notes/docs/DevOps/image-20200628150320225.png" alt="image-20200628150320225"></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.ee7e9306.js" defer></script><script src="/assets/js/2.c5c14eb8.js" defer></script><script src="/assets/js/10.18134ce1.js" defer></script>
  </body>
</html>
