<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>kubernetes | Coda的博客</title>
    <meta name="generator" content="VuePress 1.5.1">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="闲着无聊？那就读书吧">
    <link rel="preload" href="/assets/css/0.styles.c3659042.css" as="style"><link rel="preload" href="/assets/js/app.48fc24b4.js" as="script"><link rel="preload" href="/assets/js/2.c5c14eb8.js" as="script"><link rel="preload" href="/assets/js/10.53889524.js" as="script"><link rel="prefetch" href="/assets/js/11.bded85d3.js"><link rel="prefetch" href="/assets/js/12.bde1e69c.js"><link rel="prefetch" href="/assets/js/13.216bacd3.js"><link rel="prefetch" href="/assets/js/14.2a3abe69.js"><link rel="prefetch" href="/assets/js/15.3d9c6b68.js"><link rel="prefetch" href="/assets/js/16.18276b87.js"><link rel="prefetch" href="/assets/js/17.14218967.js"><link rel="prefetch" href="/assets/js/18.998f2171.js"><link rel="prefetch" href="/assets/js/19.2012aed8.js"><link rel="prefetch" href="/assets/js/20.6509a17b.js"><link rel="prefetch" href="/assets/js/21.72f41dcc.js"><link rel="prefetch" href="/assets/js/22.782c04f8.js"><link rel="prefetch" href="/assets/js/23.181ee4bf.js"><link rel="prefetch" href="/assets/js/24.8eb0e750.js"><link rel="prefetch" href="/assets/js/25.56707f9a.js"><link rel="prefetch" href="/assets/js/26.79ed2911.js"><link rel="prefetch" href="/assets/js/27.ebdf41d9.js"><link rel="prefetch" href="/assets/js/28.2b290d01.js"><link rel="prefetch" href="/assets/js/29.f80d4218.js"><link rel="prefetch" href="/assets/js/3.528f2ac2.js"><link rel="prefetch" href="/assets/js/30.e73c5725.js"><link rel="prefetch" href="/assets/js/31.dc6433d0.js"><link rel="prefetch" href="/assets/js/32.864042c4.js"><link rel="prefetch" href="/assets/js/33.3edc8ef9.js"><link rel="prefetch" href="/assets/js/34.ad325ab1.js"><link rel="prefetch" href="/assets/js/35.b1002ebc.js"><link rel="prefetch" href="/assets/js/36.f2521692.js"><link rel="prefetch" href="/assets/js/37.b6426d8e.js"><link rel="prefetch" href="/assets/js/38.d0a0ee87.js"><link rel="prefetch" href="/assets/js/39.a74c60d6.js"><link rel="prefetch" href="/assets/js/4.c4955446.js"><link rel="prefetch" href="/assets/js/40.b342667c.js"><link rel="prefetch" href="/assets/js/41.81de64ab.js"><link rel="prefetch" href="/assets/js/42.80b27fdb.js"><link rel="prefetch" href="/assets/js/43.4370c74d.js"><link rel="prefetch" href="/assets/js/44.9715bcb9.js"><link rel="prefetch" href="/assets/js/45.68d22b79.js"><link rel="prefetch" href="/assets/js/46.9e4a3272.js"><link rel="prefetch" href="/assets/js/47.ad2a26dc.js"><link rel="prefetch" href="/assets/js/48.cabec895.js"><link rel="prefetch" href="/assets/js/49.1456c681.js"><link rel="prefetch" href="/assets/js/5.790d3fc0.js"><link rel="prefetch" href="/assets/js/50.5471688c.js"><link rel="prefetch" href="/assets/js/51.b85b96b7.js"><link rel="prefetch" href="/assets/js/52.8037c738.js"><link rel="prefetch" href="/assets/js/53.8f37ed7c.js"><link rel="prefetch" href="/assets/js/54.c675ea74.js"><link rel="prefetch" href="/assets/js/55.b13ad2ca.js"><link rel="prefetch" href="/assets/js/56.80434b26.js"><link rel="prefetch" href="/assets/js/57.2652e0b8.js"><link rel="prefetch" href="/assets/js/58.f74654e5.js"><link rel="prefetch" href="/assets/js/59.3821503e.js"><link rel="prefetch" href="/assets/js/6.720e350f.js"><link rel="prefetch" href="/assets/js/60.7829eef7.js"><link rel="prefetch" href="/assets/js/61.8a4a7e14.js"><link rel="prefetch" href="/assets/js/62.17c73d58.js"><link rel="prefetch" href="/assets/js/63.df83aa76.js"><link rel="prefetch" href="/assets/js/64.1320b1b5.js"><link rel="prefetch" href="/assets/js/65.bcaaba1e.js"><link rel="prefetch" href="/assets/js/66.9dd699b9.js"><link rel="prefetch" href="/assets/js/67.50ec1687.js"><link rel="prefetch" href="/assets/js/68.67274a5d.js"><link rel="prefetch" href="/assets/js/69.f80bf654.js"><link rel="prefetch" href="/assets/js/7.9f6e7a1c.js"><link rel="prefetch" href="/assets/js/70.46b023a6.js"><link rel="prefetch" href="/assets/js/71.82dc4fbb.js"><link rel="prefetch" href="/assets/js/72.e042b91f.js"><link rel="prefetch" href="/assets/js/73.30812e11.js"><link rel="prefetch" href="/assets/js/74.f4fa1f77.js"><link rel="prefetch" href="/assets/js/75.afa162b8.js"><link rel="prefetch" href="/assets/js/76.98828728.js"><link rel="prefetch" href="/assets/js/77.2739103a.js"><link rel="prefetch" href="/assets/js/78.5c7ecb4e.js"><link rel="prefetch" href="/assets/js/79.a9b54f8a.js"><link rel="prefetch" href="/assets/js/8.c6c4c9d5.js"><link rel="prefetch" href="/assets/js/9.75d01cd2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c3659042.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Coda的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/服务端/" class="nav-link">
  服务端
</a></div><div class="nav-item"><a href="/前端/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/android/" class="nav-link">
  android
</a></div><div class="nav-item"><a href="/DevOps/" class="nav-link router-link-active">
  devOps
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/服务端/" class="nav-link">
  服务端
</a></div><div class="nav-item"><a href="/前端/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/android/" class="nav-link">
  android
</a></div><div class="nav-item"><a href="/DevOps/" class="nav-link router-link-active">
  devOps
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>kubernetes</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/DevOps/Kubernetes.html#概念" class="sidebar-link">概念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#什么是容器编排系统？" class="sidebar-link">什么是容器编排系统？</a></li><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#概述" class="sidebar-link">概述</a></li></ul></li><li><a href="/DevOps/Kubernetes.html#搭建环境" class="sidebar-link">搭建环境</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#选择正确的解决方案" class="sidebar-link">选择正确的解决方案</a></li><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#_1-minikube" class="sidebar-link">1.minikube</a></li></ul></li><li><a href="/DevOps/Kubernetes.html#pod" class="sidebar-link">POD</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#eg-实际案例" class="sidebar-link">Eg.实际案例</a></li></ul></li><li><a href="/DevOps/Kubernetes.html#node" class="sidebar-link">Node</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/DevOps/Kubernetes.html#resource" class="sidebar-link">Resource</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#replicationcontroller" class="sidebar-link">ReplicationController</a></li><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#replicaset" class="sidebar-link">ReplicaSet</a></li></ul></li><li><a href="/DevOps/Kubernetes.html#deployment" class="sidebar-link">Deployment</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#创建管理deployment" class="sidebar-link">创建管理deployment</a></li></ul></li><li><a href="/DevOps/Kubernetes.html#externalname" class="sidebar-link">ExternalName</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/DevOps/Kubernetes.html#命名空间" class="sidebar-link">命名空间</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/DevOps/Kubernetes.html#nginx-ingress-教程" class="sidebar-link">Nginx Ingress 教程</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/DevOps/Kubernetes.html#查看网页界面" class="sidebar-link">查看网页界面</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#安装dashboard-ui" class="sidebar-link">安装Dashboard UI</a></li><li class="sidebar-sub-header"><a href="/DevOps/Kubernetes.html#命令行代理" class="sidebar-link">命令行代理</a></li></ul></li><li><a href="/DevOps/Kubernetes.html#切换k8s的上下文" class="sidebar-link">切换k8s的上下文</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/DevOps/Kubernetes.html#node-2" class="sidebar-link">Node</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/DevOps/Kubernetes.html#service" class="sidebar-link">Service</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/DevOps/Kubernetes.html#labels" class="sidebar-link">Labels</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="kubernetes"><a href="#kubernetes" class="header-anchor">#</a> kubernetes</h1> <p>https://kubernetes.io/zh/docs/concepts/</p> <h2 id="概念"><a href="#概念" class="header-anchor">#</a> 概念</h2> <p>https://www.kubernetes.org.cn/6986.html?from=singlemessage&amp;isappinstalled=0</p> <h3 id="什么是容器编排系统？"><a href="#什么是容器编排系统？" class="header-anchor">#</a> 什么是容器编排系统？</h3> <p>假设我们有了一个编排系统，那么肯定有一些服务是用来运行这个编排系统的，剩下的机器用来运行业务容器。</p> <p>我们把运行编排系统的服务器叫==master节点==，剩下的称为==worker节点==。</p> <p>master节点负责管理服务器集群。</p> <ol><li>==对外需要提供api接口，用来对接集群进行管理==。</li> <li>对内，woker节点通过api接口要，定时上报运行状态，接收管理。</li></ol> <p>master 上提供管理接口的组件称为 kube apiserver，对应的还需要两个用于和 api server 交互的客户端：</p> <ul><li>一个是提供给集群的运维管理员使用的，我们称为 ==kubectl==；</li> <li>一个是提供给 worker 节点使用的，我们称为 ==kubelet==。</li></ul> <p>master对worker的管理调度组件，都是通过 kube scheduler来进行。</p> <p>除此之外，master节点上，还有一个叫kube-controller-manager的控制管理器。</p> <p>然后，因为master一般也是分布式的，所以需要一个etcd进行分布式存储。</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-28-005400.png" alt="architecture"></p> <h3 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h3> <p>综上我们可以知道，k8s大致包含有以下组件</p> <ul><li>Master 组件：kube-apiserver、kube-scheduler、etcd、kube-controller-manager；</li> <li>Node 组件：kubelet、kube-proxy；</li> <li>插件：DNS、用户界面 Web UI、容器资源监控、集群日志。</li></ul> <p>他们的关系如下：</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-28-010707.png" alt="4.png"></p> <h2 id="搭建环境"><a href="#搭建环境" class="header-anchor">#</a> 搭建环境</h2> <h3 id="选择正确的解决方案"><a href="#选择正确的解决方案" class="header-anchor">#</a> 选择正确的解决方案</h3> <p>如果你只是想试一试Kubernetes，我们==推荐基于Docker的本地方案==。</p> <p>基于Docker的本地方案是众多能够完成快速搭建的本地集群方案中的一种，但是局限于单台机器。</p> <p>当你准备好扩展到多台机器和更高可用性时，托管解决方案是最容易搭建和维护的。</p> <p>全套云端方案 只需要少数几个命令就可以在更多的云服务提供商搭建Kubernetes。</p> <p>定制方案 需要花费更多的精力，但是覆盖了从零开始搭建Kubernetes集群的通用建议到分步骤的细节指引。</p> <h3 id="_1-minikube"><a href="#_1-minikube" class="header-anchor">#</a> 1.minikube</h3> <blockquote><p>https://github.com/kubernetes/minikube</p></blockquote> <p>Minikube 是一种可以让您在本地轻松运行 Kubernetes 的工具。Minikube 在笔记本电脑上的虚拟机（VM）中运行单节点 Kubernetes 集群，供那些希望尝试 Kubernetes 或进行日常开发的用户使用。</p> <p>首先需要在mac 安装<a href="https://github.com/kubernetes/minikube" target="_blank" rel="noopener noreferrer">minikube<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-shell extra-class"><pre class="language-shell"><code>brew <span class="token function">install</span> minikube
</code></pre></div><p>然后安装<a href="https://github.com/kubernetes/kubernetes" target="_blank" rel="noopener noreferrer">kubectl<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>kubectl是本地的cli命令，可以检查集群资源；创建，删除和更新组件。</p> <div class="language- extra-class"><pre class="language-text"><code> brew install kubectl
</code></pre></div><p>启动minikube</p> <p><code>minukube start</code></p> <p>不过上面的命令，国内安装基本上都会失败</p> <div class="language-shell extra-class"><pre class="language-shell"><code>minikube start <span class="token punctuation">\</span>
--vm-driver<span class="token operator">=</span>virtualbox <span class="token punctuation">\</span>
--image-mirror-country<span class="token operator">=</span>cn <span class="token punctuation">\</span>
--registry-mirror<span class="token operator">=</span><span class="token string">'https://alzgoonw.mirror.aliyuncs.com'</span> <span class="token punctuation">\</span>
--image-repository<span class="token operator">=</span><span class="token string">'registry.cn-hangzhou.aliyuncs.com/google_containers'</span> <span class="token punctuation">\</span>
</code></pre></div><p>这个命令创建一个名为 <code>minikube</code> 的 <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#-em-set-context-em-" target="_blank" rel="noopener noreferrer">kubectl 上下文<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。 此上下文包含与 Minikube 集群通信的配置。</p> <p>Minikube 会自动将此上下文设置为默认值，也可以运行：</p> <div class="language- extra-class"><pre class="language-text"><code>kubectl config use-context minikube
</code></pre></div><p>要访问 <a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/" target="_blank" rel="noopener noreferrer">Kubernetes Dashboard<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，请在启动 Minikube 后在 shell 中运行此命令以获取地址：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>minikube dashboard
</code></pre></div><p>可以看到k8s的控制界面</p> <p>http://127.0.0.1:59860/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/#/overview?namespace=default</p> <p>kubectl连k8s的控制台，需要配置一个context。</p> <p>查看</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl config view <span class="token comment"># 查看kubeconfig 配置</span>
kubectl cluster-info <span class="token comment"># 看当前k8s集群的情况</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>minikube <span class="token function">ssh</span> <span class="token comment"># 连接到一个kube上</span>
</code></pre></div><h2 id="pod"><a href="#pod" class="header-anchor">#</a> POD</h2> <p>pod是k8s里最小的单位，他用来运行容器。</p> <p>一般通过yml文件对pod进行创建、删除操作。命令如下：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 通过pod.json文件中指定的资源类型和名称删除一个pod</span>
$ kubectl create -f ./pod.yml
$ kubectl delete -f ./pod.yml
</code></pre></div><h3 id="eg-实际案例"><a href="#eg-实际案例" class="header-anchor">#</a> Eg.实际案例</h3> <p>我们通过yml文件创建并且启动一个nginx pod</p> <p>1.创建一个<code>pod-nginx.yml</code></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre></div><p>2.验证pod创建成功</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl cversion <span class="token comment">#先确认kubectl连接上了</span>
$ kubectl create -f pod-nginx.yml <span class="token comment"># 根据yml文件创建pod</span>
$ kubectl get pods -o wide <span class="token comment"># 查看pod详细信息</span>
</code></pre></div><p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-27-121551.png" alt="image-20200327201551379"></p> <p>3.如果需要进入一个pod里，运行 <code>--it</code>命令</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl <span class="token builtin class-name">exec</span> -it nginx <span class="token function">sh</span> <span class="token comment"># 可以进入某一个pod的容器里</span>
</code></pre></div><h4 id="思考：如何让外界去访问这个pod的nginx服务？"><a href="#思考：如何让外界去访问这个pod的nginx服务？" class="header-anchor">#</a> <strong>思考：如何让外界去访问这个pod的nginx服务？</strong></h4> <p>方案1：可以将nginx服务映射到minikube机器的ip上</p> <p>通过port-forward命令，将本地端口映射到pod端口上</p> <div class="language-js extra-class"><pre class="language-js"><code>Examples<span class="token operator">:</span>
  # Listen on ports <span class="token number">5000</span> and <span class="token number">6000</span> locally<span class="token punctuation">,</span> forwarding data to<span class="token operator">/</span><span class="token keyword">from</span> ports <span class="token number">5000</span> and <span class="token number">6000</span> <span class="token keyword">in</span> the pod
  kubectl port<span class="token operator">-</span>forward pod<span class="token operator">/</span>mypod <span class="token number">5000</span> <span class="token number">6000</span>

  # Listen on ports <span class="token number">5000</span> and <span class="token number">6000</span> locally<span class="token punctuation">,</span> forwarding data to<span class="token operator">/</span><span class="token keyword">from</span> ports <span class="token number">5000</span> and <span class="token number">6000</span> <span class="token keyword">in</span> a pod selected by the
deployment
  kubectl port<span class="token operator">-</span>forward deployment<span class="token operator">/</span>mydeployment <span class="token number">5000</span> <span class="token number">6000</span>

  # Listen on ports <span class="token number">5000</span> and <span class="token number">6000</span> locally<span class="token punctuation">,</span> forwarding data to<span class="token operator">/</span><span class="token keyword">from</span> ports <span class="token number">5000</span> and <span class="token number">6000</span> <span class="token keyword">in</span> a pod selected by the service
  kubectl port<span class="token operator">-</span>forward service<span class="token operator">/</span>myservice <span class="token number">5000</span> <span class="token number">6000</span>

  # Listen on port <span class="token number">8888</span> locally<span class="token punctuation">,</span> forwarding to <span class="token number">5000</span> <span class="token keyword">in</span> the pod
  kubectl port<span class="token operator">-</span>forward pod<span class="token operator">/</span>mypod <span class="token number">8888</span><span class="token operator">:</span><span class="token number">5000</span>

  # Listen on port <span class="token number">8888</span> on all addresses<span class="token punctuation">,</span> forwarding to <span class="token number">5000</span> <span class="token keyword">in</span> the pod
  kubectl port<span class="token operator">-</span>forward <span class="token operator">--</span>address <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span> pod<span class="token operator">/</span>mypod <span class="token number">8888</span><span class="token operator">:</span><span class="token number">5000</span>

  # Listen on port <span class="token number">8888</span> on localhost and selected <span class="token constant">IP</span><span class="token punctuation">,</span> forwarding to <span class="token number">5000</span> <span class="token keyword">in</span> the pod
  kubectl port<span class="token operator">-</span>forward <span class="token operator">--</span>address localhost<span class="token punctuation">,</span><span class="token number">10.19</span><span class="token number">.21</span><span class="token number">.23</span> pod<span class="token operator">/</span>mypod <span class="token number">8888</span><span class="token operator">:</span><span class="token number">5000</span>

  # Listen on a random port locally<span class="token punctuation">,</span> forwarding to <span class="token number">5000</span> <span class="token keyword">in</span> the pod
  kubectl port<span class="token operator">-</span>forward pod<span class="token operator">/</span>mypod <span class="token operator">:</span><span class="token number">5000</span>
</code></pre></div><h2 id="node"><a href="#node" class="header-anchor">#</a> Node</h2> <p>什么是node？</p> <h2 id="resource"><a href="#resource" class="header-anchor">#</a> Resource</h2> <h3 id="replicationcontroller"><a href="#replicationcontroller" class="header-anchor">#</a> ReplicationController</h3> <p>ReplicationController 类似于进程管理器，但是 ReplicationController 不是监控单个节点上的单个进程，而是监控跨多个节点的多个 pod。</p> <h4 id="yml格式"><a href="#yml格式" class="header-anchor">#</a> yml格式</h4> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicationController
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment">#指定同时运行多少个pod</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment">#标签选择器，管理所有与之匹配的pod</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment">#必须字段</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment">#必须和.spec.selector相同，否则被api拒绝。</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre></div><h4 id="创建rc"><a href="#创建rc" class="header-anchor">#</a> 创建rc</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl create -f replication.yml
</code></pre></div><h4 id="扩容缩容"><a href="#扩容缩容" class="header-anchor">#</a> 扩容缩容</h4> <p>通过简单地更新 <code>replicas</code> 字段，ReplicationController 可以方便地横向扩容或缩容副本的数量，或手动或通过自动缩放控制代理</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl scale --replicas<span class="token operator">=</span><span class="token number">1</span> rc/nginx
</code></pre></div><p>这样可以手动把nginx 缩放到1个pod</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-29-015054.png" alt="image-20200329095054336"></p> <h4 id="删除rc以及对应的pod"><a href="#删除rc以及对应的pod" class="header-anchor">#</a> <strong>删除rc以及对应的pod</strong></h4> <p>要删除一个 ReplicationController 以及它的 Pod，使用 <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#delete" target="_blank" rel="noopener noreferrer"><code>kubectl delete</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。 kubectl 将 ReplicationController 缩放为 0 并等待以便在删除 ReplicationController 本身之前删除每个 Pod。</p> <div class="language- extra-class"><pre class="language-text"><code>kubectl delete -f replication.yml
</code></pre></div><p>总结一下，步骤为：</p> <p>1.缩放副本为 0、</p> <p>2.等待 Pod 删除，之后删除 ReplicationController 资源</p> <h3 id="replicaset"><a href="#replicaset" class="header-anchor">#</a> ReplicaSet</h3> <p>ReplicaSet是replication controller的升级版。</p> <p>*<code>Replication Controller</code>*只支持基于等式的selector（env=dev或environment!=qa），但ReplicaSet还支持基于集合的selector。比如：version in (v1.0, v2.0)或 env notin (dev, qa)</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicaSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> frontend
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> guestbook
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
    <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># 表达式</span>
      <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token key atrule">key</span><span class="token punctuation">:</span> tier<span class="token punctuation">,</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> In<span class="token punctuation">,</span> <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>frontend<span class="token punctuation">]</span><span class="token punctuation">}</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> guestbook
        <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>redis
        <span class="token key atrule">image</span><span class="token punctuation">:</span> gcr.io/google_samples/gb<span class="token punctuation">-</span>frontend<span class="token punctuation">:</span>v3
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>

</code></pre></div><p>创建rs后，我们看一下rs的信息：</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-29-060644.png" alt="image-20200329140643726"></p> <h2 id="deployment"><a href="#deployment" class="header-anchor">#</a> Deployment</h2> <p>提供一个声明式的更新</p> <p>可以声明需要更新的版本</p> <h3 id="创建管理deployment"><a href="#创建管理deployment" class="header-anchor">#</a> 创建管理deployment</h3> <p>1.定义一个yml文件</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 通过selector声明pods</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre></div><p>2.创建deployment</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl create -f ./deployment_nginx.yml
</code></pre></div><p>3.查看deployment</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl get deployment -o wide
</code></pre></div><p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-27-233517.png" alt="image-20200328073517412"></p> <p>4.查看replicaSet 和 pods</p> <p>所以创建deployment的时候，也会创建rs资源。</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-27-233610.png" alt="image-20200328073609314"></p> <p>5.通过deployment来更新image</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl <span class="token builtin class-name">set</span> image deployment nginx-deployment <span class="token assign-left variable">nginx</span><span class="token operator">=</span>nginx:1.13
</code></pre></div><p>等待一会儿，就可以看到，deployment被更新了</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-27-234255.png" alt="image-20200328074254196"></p> <p>6.如果需要回滚，或者查看历史。</p> <p>通过rollout undo、rollout history来进行操作</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl rollout undo deployment nginx-deployment
$ kubectl rollout <span class="token function">history</span> deployment nginx-deployment
</code></pre></div><p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-27-234558.png" alt="image-20200328074558262"></p> <h2 id="externalname"><a href="#externalname" class="header-anchor">#</a> ExternalName</h2> <div class="language- extra-class"><pre class="language-text"><code>kubectl create svc externalname -n test-bhop prerender --external-name prerender.broker.svc.cluster.local
</code></pre></div><h2 id="命名空间"><a href="#命名空间" class="header-anchor">#</a> 命名空间</h2> <div class="language- extra-class"><pre class="language-text"><code>kubectl get namespace
</code></pre></div><h1 id="其他待了解"><a href="#其他待了解" class="header-anchor">#</a> 其他待了解</h1> <h2 id="nginx-ingress-教程"><a href="#nginx-ingress-教程" class="header-anchor">#</a> Nginx Ingress 教程</h2> <h1 id="常用东西"><a href="#常用东西" class="header-anchor">#</a> 常用东西</h1> <h2 id="查看网页界面"><a href="#查看网页界面" class="header-anchor">#</a> 查看网页界面</h2> <h3 id="安装dashboard-ui"><a href="#安装dashboard-ui" class="header-anchor">#</a> 安装Dashboard UI</h3> <h3 id="命令行代理"><a href="#命令行代理" class="header-anchor">#</a> 命令行代理</h3> <p>您可以使用 kubectl 命令行工具访问 Dashboard，命令如下：</p> <div class="language- extra-class"><pre class="language-text"><code>kubectl proxy
</code></pre></div><p>这个命令可以让本地通过<a href="http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/" target="_blank" rel="noopener noreferrer">这个地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>来访问</p> <p>如果命名空间错误的话，</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-04-23-091043.png" alt="image-20200423171043037"></p> <p>查看一下k8s上面的dashboard的服务名称，然后替换掉。</p> <h2 id="切换k8s的上下文"><a href="#切换k8s的上下文" class="header-anchor">#</a> 切换k8s的上下文</h2> <p>如果有多个k8s环境可以连接的话，可以通过切换context的方式，来指定连接到某个context上。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl config current-context  <span class="token comment"># 展示当前所处的上下文</span>
$ kubectl config get-contexts <span class="token comment"># 显示一个或多个contexts</span>
$ kubectl config use-context <span class="token comment"># 切换上下文</span>
</code></pre></div><p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-27-235902.png" alt="image-20200328075902219"></p> <h2 id="node-2"><a href="#node-2" class="header-anchor">#</a> Node</h2> <p>查看当前context下的node</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl get node
</code></pre></div><p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-28-000045.png" alt="image-20200328080044652"></p> <h2 id="service"><a href="#service" class="header-anchor">#</a> Service</h2> <p>第一种方式：通过expose命令</p> <p>将pod expose为一个service, 类型为NodePort</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl expose pods nginx-pod --type<span class="token operator">=</span>NodePort
</code></pre></div><p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-28-023332.png" alt="image-20200328103332201"></p> <p>可以通过32685这个端口去访问pod的服务</p> <p>第二种：通过yml文件去创建</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>service
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># 也可以指定pod的port name: 比如nginx-port</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
</code></pre></div><p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-28-023829.png" alt="image-20200328103829227"></p> <h2 id="labels"><a href="#labels" class="header-anchor">#</a> Labels</h2> <p>k8s里几乎所有资源都可以设置label，做个试验</p> <p>先创建一个pods</p> <div class="language- extra-class"><pre class="language-text"><code>apiVersion: v1
kind: Pod
metadata:
  name: nginx-pod
  labels:
    app: nginx
spec:
  containers:
  - name: nginx-pod
    image: nginx
    ports:
    - containerPort: 80
</code></pre></div><p>expose service</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-28-012122.png" alt="image-20200328092121258"></p> <blockquote><p>--type=:   ClusterIP, NodePort, LoadBalancer, or ExternalName. Default is 'ClusterIP'.</p></blockquote> <p>通过ip + 端口 可以访问</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-28-012419.png" alt="image-20200328092419233"></p> <p>显示node的labels</p> <div class="language- extra-class"><pre class="language-text"><code>$ kubectl get node --show-labels
</code></pre></div><p>设置node的labels</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl label node <span class="token variable">${node_name}</span> <span class="token assign-left variable">key</span><span class="token operator">=</span>value <span class="token comment"># 设置node的label</span>
</code></pre></div><p>显示pods的labels</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-28-013043.png" alt="image-20200328093042661"></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.48fc24b4.js" defer></script><script src="/assets/js/2.c5c14eb8.js" defer></script><script src="/assets/js/10.53889524.js" defer></script>
  </body>
</html>
