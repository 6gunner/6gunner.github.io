<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>多线程 | Coda的博客</title>
    <meta name="generator" content="VuePress 1.5.1">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="闲着无聊？那就读书吧">
    <link rel="preload" href="/assets/css/0.styles.c3659042.css" as="style"><link rel="preload" href="/assets/js/app.b78fad8d.js" as="script"><link rel="preload" href="/assets/js/2.c5c14eb8.js" as="script"><link rel="preload" href="/assets/js/87.8fee21f9.js" as="script"><link rel="prefetch" href="/assets/js/10.18134ce1.js"><link rel="prefetch" href="/assets/js/11.bded85d3.js"><link rel="prefetch" href="/assets/js/12.bde1e69c.js"><link rel="prefetch" href="/assets/js/13.20f0daa8.js"><link rel="prefetch" href="/assets/js/14.e71fe2b7.js"><link rel="prefetch" href="/assets/js/15.973e36e2.js"><link rel="prefetch" href="/assets/js/16.48ea97ee.js"><link rel="prefetch" href="/assets/js/17.44165697.js"><link rel="prefetch" href="/assets/js/18.7656306f.js"><link rel="prefetch" href="/assets/js/19.3b73be2d.js"><link rel="prefetch" href="/assets/js/20.74c7944b.js"><link rel="prefetch" href="/assets/js/21.9d2dc4ed.js"><link rel="prefetch" href="/assets/js/22.106ca3e0.js"><link rel="prefetch" href="/assets/js/23.37778393.js"><link rel="prefetch" href="/assets/js/24.99018c24.js"><link rel="prefetch" href="/assets/js/25.53e9b0e1.js"><link rel="prefetch" href="/assets/js/26.14149d9d.js"><link rel="prefetch" href="/assets/js/27.a3cf3771.js"><link rel="prefetch" href="/assets/js/28.3ff82e9d.js"><link rel="prefetch" href="/assets/js/29.97176bda.js"><link rel="prefetch" href="/assets/js/3.fa094ce6.js"><link rel="prefetch" href="/assets/js/30.af0093ba.js"><link rel="prefetch" href="/assets/js/31.de3e66ba.js"><link rel="prefetch" href="/assets/js/32.f60c48f3.js"><link rel="prefetch" href="/assets/js/33.29b7618e.js"><link rel="prefetch" href="/assets/js/34.48f66e88.js"><link rel="prefetch" href="/assets/js/35.5f4be1fa.js"><link rel="prefetch" href="/assets/js/36.19af2b2e.js"><link rel="prefetch" href="/assets/js/37.2ab3aae2.js"><link rel="prefetch" href="/assets/js/38.eda38496.js"><link rel="prefetch" href="/assets/js/39.a8f5d337.js"><link rel="prefetch" href="/assets/js/4.c4955446.js"><link rel="prefetch" href="/assets/js/40.0ea63d1a.js"><link rel="prefetch" href="/assets/js/41.a35ed445.js"><link rel="prefetch" href="/assets/js/42.9007e5d9.js"><link rel="prefetch" href="/assets/js/43.2a3911a7.js"><link rel="prefetch" href="/assets/js/44.70b4aeb3.js"><link rel="prefetch" href="/assets/js/45.ec9e0c11.js"><link rel="prefetch" href="/assets/js/46.1d7951de.js"><link rel="prefetch" href="/assets/js/47.3d8c4875.js"><link rel="prefetch" href="/assets/js/48.ecbab1fd.js"><link rel="prefetch" href="/assets/js/49.5cd94100.js"><link rel="prefetch" href="/assets/js/5.790d3fc0.js"><link rel="prefetch" href="/assets/js/50.3e4cab0a.js"><link rel="prefetch" href="/assets/js/51.a0c06659.js"><link rel="prefetch" href="/assets/js/52.bf75b706.js"><link rel="prefetch" href="/assets/js/53.b341aad9.js"><link rel="prefetch" href="/assets/js/54.ec68212a.js"><link rel="prefetch" href="/assets/js/55.8ed13d89.js"><link rel="prefetch" href="/assets/js/56.7d71c065.js"><link rel="prefetch" href="/assets/js/57.f7fe56fd.js"><link rel="prefetch" href="/assets/js/58.b2c94053.js"><link rel="prefetch" href="/assets/js/59.a496b593.js"><link rel="prefetch" href="/assets/js/6.bf536f2f.js"><link rel="prefetch" href="/assets/js/60.1f09eb53.js"><link rel="prefetch" href="/assets/js/61.0f293602.js"><link rel="prefetch" href="/assets/js/62.eb44a088.js"><link rel="prefetch" href="/assets/js/63.07f23f76.js"><link rel="prefetch" href="/assets/js/64.623df496.js"><link rel="prefetch" href="/assets/js/65.1f868299.js"><link rel="prefetch" href="/assets/js/66.570a283c.js"><link rel="prefetch" href="/assets/js/67.489e53b5.js"><link rel="prefetch" href="/assets/js/68.56b0e15a.js"><link rel="prefetch" href="/assets/js/69.6ce43b2a.js"><link rel="prefetch" href="/assets/js/7.2fa27e95.js"><link rel="prefetch" href="/assets/js/70.2da33802.js"><link rel="prefetch" href="/assets/js/71.a74a8687.js"><link rel="prefetch" href="/assets/js/72.807ab97f.js"><link rel="prefetch" href="/assets/js/73.addd6f15.js"><link rel="prefetch" href="/assets/js/74.091df892.js"><link rel="prefetch" href="/assets/js/75.3e1f424b.js"><link rel="prefetch" href="/assets/js/76.920d105e.js"><link rel="prefetch" href="/assets/js/77.34997081.js"><link rel="prefetch" href="/assets/js/78.210d889f.js"><link rel="prefetch" href="/assets/js/79.a90bbb85.js"><link rel="prefetch" href="/assets/js/8.c6c4c9d5.js"><link rel="prefetch" href="/assets/js/80.61caa2ae.js"><link rel="prefetch" href="/assets/js/81.219dbc3d.js"><link rel="prefetch" href="/assets/js/82.62813a3f.js"><link rel="prefetch" href="/assets/js/83.441cb7c8.js"><link rel="prefetch" href="/assets/js/84.09fd0482.js"><link rel="prefetch" href="/assets/js/85.d317f43e.js"><link rel="prefetch" href="/assets/js/86.3c82b3b6.js"><link rel="prefetch" href="/assets/js/88.50d012fc.js"><link rel="prefetch" href="/assets/js/89.5a2924d9.js"><link rel="prefetch" href="/assets/js/9.75d01cd2.js"><link rel="prefetch" href="/assets/js/90.b6fc102e.js"><link rel="prefetch" href="/assets/js/91.5ba08167.js"><link rel="prefetch" href="/assets/js/92.24afbd10.js"><link rel="prefetch" href="/assets/js/93.00a147b5.js"><link rel="prefetch" href="/assets/js/94.c3d4bf5a.js"><link rel="prefetch" href="/assets/js/95.c950cd4a.js"><link rel="prefetch" href="/assets/js/96.2bcdbbfe.js"><link rel="prefetch" href="/assets/js/97.be9ab7f8.js"><link rel="prefetch" href="/assets/js/98.bf2d3fc8.js"><link rel="prefetch" href="/assets/js/99.ef050278.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c3659042.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Coda的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/服务端/" class="nav-link">
  服务端
</a></div><div class="nav-item"><a href="/前端/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/android/" class="nav-link">
  android
</a></div><div class="nav-item"><a href="/DevOps/" class="nav-link">
  devOps
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/服务端/" class="nav-link">
  服务端
</a></div><div class="nav-item"><a href="/前端/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/android/" class="nav-link">
  android
</a></div><div class="nav-item"><a href="/DevOps/" class="nav-link">
  devOps
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>多线程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20-%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.html#多线程安全问题" class="sidebar-link">多线程安全问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20-%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.html#synchronized关键字" class="sidebar-link">Synchronized关键字</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20-%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.html#reentralock-可重入锁" class="sidebar-link">ReentraLock 可重入锁</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20-%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.html#" class="sidebar-link"></a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20-%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.html#synchronized和reentralock的区别" class="sidebar-link">Synchronized和ReentraLock的区别</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20-%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.html#多线程死锁" class="sidebar-link">多线程死锁</a></li></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20-%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.html#容器的并发" class="sidebar-link">容器的并发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20-%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.html#map" class="sidebar-link">Map</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20-%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.html#list" class="sidebar-link">List</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20-%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.html#blockingqueue" class="sidebar-link">BlockingQueue</a></li></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20-%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.html#线程池" class="sidebar-link">线程池</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20-%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.html#_1-线程池概述" class="sidebar-link">1.线程池概述</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20-%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.html#_2-创建线程池的方式" class="sidebar-link">2.创建线程池的方式</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20-%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.html#_3-线程池原理分析" class="sidebar-link">3.线程池原理分析</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20-%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.html#_4-线程池合理数量配置" class="sidebar-link">4.线程池合理数量配置</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20-%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.html#_5-executorservice解析" class="sidebar-link">5.ExecutorService解析</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20-%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.html#_6-executors" class="sidebar-link">6.Executors</a></li></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20-%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.html#线程锁" class="sidebar-link">线程锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20-%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.html#synchronized-和-lock的区别" class="sidebar-link">Synchronized  和 lock的区别</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20-%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.html#悲观锁-乐观锁" class="sidebar-link">悲观锁&amp;乐观锁</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20-%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.html#cas无锁机制" class="sidebar-link">CAS无锁机制</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20-%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.html#自旋锁" class="sidebar-link">自旋锁</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20-%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.html#可重入锁" class="sidebar-link">可重入锁</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20-%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.html#可中断锁" class="sidebar-link">可中断锁</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20-%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.html#读写锁" class="sidebar-link">读写锁</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="多线程"><a href="#多线程" class="header-anchor">#</a> 多线程</h1> <h3 id="多线程应用场景"><a href="#多线程应用场景" class="header-anchor">#</a> 多线程应用场景</h3> <h3 id="守护线程与非守护线程"><a href="#守护线程与非守护线程" class="header-anchor">#</a> 守护线程与非守护线程</h3> <h3 id="多线程的几种状态"><a href="#多线程的几种状态" class="header-anchor">#</a> 多线程的几种状态</h3> <p>多线程的生命周期：</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-19-023655.png" alt="thread_status" style="zoom:50%;"> <h3 id="保证线程的执行顺序"><a href="#保证线程的执行顺序" class="header-anchor">#</a> 保证线程的执行顺序</h3> <h3 id="使用多线程分批处理信息"><a href="#使用多线程分批处理信息" class="header-anchor">#</a> 使用多线程分批处理信息</h3> <h3 id="多线程通信方式"><a href="#多线程通信方式" class="header-anchor">#</a> 多线程通信方式</h3> <ul><li><h4 id="wait-notify"><a href="#wait-notify" class="header-anchor">#</a> wait &amp; notify</h4></li></ul> <p><strong>使用场景</strong>：现在有A、B两个线程互斥，我们希望线程B运行到某一个状态通知线程A运行。如果线程A执行时，还没有达到预期的状态，先让线程A等待，等线程B到达这个状态后再通知线程A运行。</p> <p>如图所示：</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-19-022618.png" alt="wait" style="zoom:30%;"> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-19-023209.png" alt="notify" style="zoom:30%;"> <p>==注==：1.notify唤醒的线程不会在调用notify的一瞬间就执行，因为那个时候，线程的锁还没有被释放，其他线程还没有办法获取该实例的锁。</p> <p>2.只有拥有锁的线程才能调用notify方法来唤醒其他线程；</p> <ul><li><h4 id="countdownlatch-计数门闩"><a href="#countdownlatch-计数门闩" class="header-anchor">#</a> CountDownLatch 计数门闩</h4></li></ul> <p><strong>应用场景</strong>：CountDownLatch内部就是1个计数器。当线程A需要等待其他n个线程完成任务之后才能执行时，可以通过CountDownLatch来实现。</p> <p><strong>使用介绍</strong>：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
* 构造方法：参数count为计数值
*/</span>
<span class="token keyword">public</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
* 调用await()方法的线程会被挂起，它会等待直到count值为0才继续执行
*/</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
* 可以等待一定的时间，如果count依然没变成0，还是会继续执行
*/</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">await</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> 

<span class="token comment">/**
* 每次调用都会将count值减1
*/</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment">//</span>
</code></pre></div><p><strong>实际使用</strong>：</p> <blockquote><p>启动2个线程，线程1不断的add，线程2去监听容器的size，当size值=5时，终止线程2.</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程2开始&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程2结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;t2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程1开始&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      myContainer<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;容器增加：&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="怎么停止线程"><a href="#怎么停止线程" class="header-anchor">#</a> 怎么停止线程</h3> <h3 id="线程变量threadlocal"><a href="#线程变量threadlocal" class="header-anchor">#</a> 线程变量ThreadLocal</h3> <blockquote><p>参考文章：https://www.jianshu.com/p/22be9653df3f</p></blockquote> <h4 id="作用"><a href="#作用" class="header-anchor">#</a> 作用</h4> <p>为每一个线程开辟一个单独的内存空间，用来存放线程独享的资源</p> <h4 id="使用场景"><a href="#使用场景" class="header-anchor">#</a> 使用场景</h4> <p>线程需要存放变量，但是又不希望别的线程来修改自己的变量时，可以用ThreadLocal来存储变量的值；</p> <h4 id="使用方式"><a href="#使用方式" class="header-anchor">#</a> 使用方式</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyRunnable</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建线程变量      </span>
  <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> threadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            threadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">&quot;的ThreadLocal变量&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Runnable</span> runnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>runnable<span class="token punctuation">,</span> <span class="token string">&quot;线程1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>runnable<span class="token punctuation">,</span> <span class="token string">&quot;线程2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="原理"><a href="#原理" class="header-anchor">#</a> 原理</h4> <p>每个线程实例都会有一个threadLocals的变量，用来存放当前线程的ThreadLocalMap；</p> <p>而当ThreadLocal创建时，会创建好ThreadLocalMap的实例，然后关联到线程t的threadLocals变量上；</p> <p>每个ThreadLocalMap的key = 当前ThreadLocal对象本身，value是一个任意的值；</p> <p>所以当ThreadLocal设置值时，当前线程会先拿到ThreadLocalMap，然后为这个map上设置值；</p> <p>Debug记录</p> <p>线程1：ThreadLocal@948</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-18-082533.png" alt="image-20191018075648324"></p> <p>线程1：ThreadLocalMap@961</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-18-82534.png" alt="image-20191018075918341"></p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-18-082534.png" alt="image-20191018080048039"></p> <p>线程2：可以看到ThreadLocal的变量是同一个，但是map会创建新的；</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-18-082535.png" alt="image-20191018075622915"></p> <h2 id="多线程安全问题"><a href="#多线程安全问题" class="header-anchor">#</a> 多线程安全问题</h2> <p>先看问题：假设有10000张票，启动10个线程，每个线程都去买票；打印每个线程购买票的情况.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 场景：假设有10000张火车票
 * 启动10个线程，每个线程都去买票；打印购买情况
 *
 * @author keyang
 * 比较一下ArrayList、Vector、ConcurrentLinkedQueue区别
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentQueue1</span> <span class="token punctuation">{</span>
	
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 注解1</span>
<span class="token comment">//		List&lt;String&gt; tickets = new ArrayList&lt;&gt;();</span>
    <span class="token comment">// 注解2</span>
<span class="token comment">//		Vector&lt;String&gt; tickets = new Vector&lt;String&gt;();</span>
    <span class="token comment">// 注解3</span>
		<span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> tickets <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			tickets<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;火车票&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>tickets<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">//				synchronized (tickets) {</span>
				<span class="token keyword">while</span> <span class="token punctuation">(</span>tickets<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">try</span> <span class="token punctuation">{</span>
						<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
<span class="token comment">//						System.out.println(Thread.currentThread().getId() + &quot;——&quot; + tickets.remove(0));</span>
					<span class="token class-name">String</span> ticket <span class="token operator">=</span> tickets<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>ticket <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token keyword">break</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;——&quot;</span> <span class="token operator">+</span> ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
<span class="token comment">//				}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>注解1：假设用ArrayList来存放队列，那么程序会出现越界的问题。而且还可能会卖出空票。</p> <div class="language-verilog extra-class"><pre class="language-verilog"><code><span class="token number">21</span>——<span class="token keyword">null</span>
<span class="token number">19</span>——<span class="token keyword">null</span>
<span class="token number">17</span>——<span class="token keyword">null</span>
<span class="token number">18</span>——<span class="token keyword">null</span>
Exception in thread <span class="token string">&quot;Thread-0&quot;</span> Exception in thread <span class="token string">&quot;Thread-9&quot;</span> Exception in thread <span class="token string">&quot;Thread-3&quot;</span> Exception in thread <span class="token string">&quot;Thread-7&quot;</span> Exception in thread <span class="token string">&quot;Thread-4&quot;</span> Exception in thread <span class="token string">&quot;Thread-1&quot;</span> Exception in thread <span class="token string">&quot;Thread-6&quot;</span> Exception in thread <span class="token string">&quot;Thread-8&quot;</span> Exception in thread <span class="token string">&quot;Thread-2&quot;</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>IndexOutOfBoundsException<span class="token punctuation">:</span> Index <span class="token number">0</span> out of bounds <span class="token keyword">for</span> length <span class="token number">0</span>
	at java<span class="token punctuation">.</span>base<span class="token operator">/</span>jdk<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Preconditions<span class="token punctuation">.</span><span class="token function">outOfBounds</span><span class="token punctuation">(</span>Preconditions<span class="token punctuation">.</span>java<span class="token punctuation">:</span><span class="token number">64</span><span class="token punctuation">)</span>
	at java<span class="token punctuation">.</span>base<span class="token operator">/</span>jdk<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Preconditions<span class="token punctuation">.</span><span class="token function">outOfBoundsCheckIndex</span><span class="token punctuation">(</span>Preconditions<span class="token punctuation">.</span>java<span class="token punctuation">:</span><span class="token number">70</span><span class="token punctuation">)</span>
	at java<span class="token punctuation">.</span>base<span class="token operator">/</span>jdk<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Preconditions<span class="token punctuation">.</span><span class="token function">checkIndex</span><span class="token punctuation">(</span>Preconditions<span class="token punctuation">.</span>java<span class="token punctuation">:</span><span class="token number">248</span><span class="token punctuation">)</span>
	at java<span class="token punctuation">.</span>base<span class="token operator">/</span>java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Objects<span class="token punctuation">.</span><span class="token function">checkIndex</span><span class="token punctuation">(</span>Objects<span class="token punctuation">.</span>java<span class="token punctuation">:</span><span class="token number">372</span><span class="token punctuation">)</span>
	at java<span class="token punctuation">.</span>base<span class="token operator">/</span>java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ArrayList<span class="token punctuation">.</span>java<span class="token punctuation">:</span><span class="token number">535</span><span class="token punctuation">)</span>
	at com<span class="token punctuation">.</span>gs<span class="token punctuation">.</span>example<span class="token punctuation">.</span>concurrentdemo<span class="token punctuation">.</span>ConcurrentQueue1<span class="token punctuation">.</span>lambda$main$<span class="token function">0</span><span class="token punctuation">(</span>ConcurrentQueue1<span class="token punctuation">.</span>java<span class="token punctuation">:</span><span class="token number">36</span><span class="token punctuation">)</span>
	at java<span class="token punctuation">.</span>base<span class="token operator">/</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span>java<span class="token punctuation">:</span><span class="token number">834</span><span class="token punctuation">)</span>
</code></pre></div><p>因为ArrayList的<code>remove()</code>方法本身就没有原子性.</p> <p>注解2：假设更换容器为Vector。Vector本身是线程安全的，<code>remove</code>方法是可以保证原子性的。但是程序中<code>size</code>判断和<code>remove</code>方法两个操作之间是无法保证不被打断的，所以系统也会判断错误，出现同样的越界问题。</p> <p>注解3：ArrayList和Vector容器只能通过使用synchronize锁来保证线程安全,，者使用并发容器：<code>ConcurrentLinkedList</code>.</p> <h3 id="synchronized关键字"><a href="#synchronized关键字" class="header-anchor">#</a> Synchronized关键字</h3> <ul><li><h4 id="作用-2"><a href="#作用-2" class="header-anchor">#</a> 作用</h4></li></ul> <p>保证同一时刻，只有1个线程能执行被Synchronize修饰的方法或代码块；</p> <ul><li><h4 id="使用场景-2"><a href="#使用场景-2" class="header-anchor">#</a> 使用场景</h4></li></ul> <p>保证线程安全，通过互斥锁、阻塞的形式解决并发问题；</p> <ul><li><h4 id="使用介绍"><a href="#使用介绍" class="header-anchor">#</a> 使用介绍</h4></li></ul> <p><strong>修饰代码块</strong>:  需要传入一个被锁的对象。每个线程执行代码块时，需要获取到这个对象的锁。java的所有对象都有1个互斥锁，synchronize方法结束或者抛出异常时会自动释放锁。</p> <p><strong>修饰实例方法</strong>：锁的是当前调用方法的实例对象。每个实例对象拥有一把锁，线程调用方法时，必须获取该实例对象的锁。—— 和synchronize(this)的效果一样</p> <p><strong>修饰类的静态方法</strong>：锁的是Class类的对象。所以该Class的实例对象在调用该静态方法时，共用同一把锁。因为类只有1个，静态方法在内存中也只有1个</p> <p><strong>不同锁之间的区别：</strong></p> <table><thead><tr><th>类型</th> <th>锁的对象</th> <th>锁的数量</th> <th>表现形式</th></tr></thead> <tbody><tr><td>对象锁</td> <td>实例对象</td> <td>多个（1个类可以有多个实例）</td> <td>普通方法</td></tr> <tr><td>类锁</td> <td>Class对象</td> <td>1个（因为1个类只有1个类对象）</td> <td>静态方法</td></tr></tbody></table> <p><strong>Demo</strong>：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span><span class="token punctuation">{</span> 
    <span class="token comment">// 对象锁：形式1(方法锁) </span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token class-name">Method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;我是对象锁也是方法锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">try</span><span class="token punctuation">{</span> 
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span> 
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span> 
 
    <span class="token comment">// 对象锁：形式2（代码块形式） </span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">Method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;我是对象锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token keyword">try</span><span class="token punctuation">{</span> 
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span> 
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span> 
      
      <span class="token comment">// 类锁：形式1 ：锁静态方法</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token class-name">Method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;我是类锁一号&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">try</span><span class="token punctuation">{</span> 
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span> 
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span> 
 ｝
</code></pre></div><h3 id="reentralock-可重入锁"><a href="#reentralock-可重入锁" class="header-anchor">#</a> ReentraLock 可重入锁</h3> <h4 id="使用场景-3"><a href="#使用场景-3" class="header-anchor">#</a> <strong>使用场景</strong></h4> <p>1.替代synchronize的锁的方法；通过lock和unlock来实现synchronize的功能；</p> <p>2.可以使用trylock尝试获取锁。当没有获取到锁时，不进行业务逻辑处理；</p> <p>3.可以使用lockInterruptibly方法来响应线程的interrupt方法，避免线程因为无法获取锁而无法被打断；</p> <p>4.通过绑定condition，可以实现对某一类线程的定向通知。</p> <h4 id="使用介绍-2"><a href="#使用介绍-2" class="header-anchor">#</a> 使用介绍</h4> <p><strong>lock()</strong>:  lock方法会获取锁，如果没有获取到就一直等待；</p> <p><strong>tryLock()</strong>:  tryLock不会等待，而是即返回获取锁的结果。获取到锁返回true，没有会返回false。</p> <p><strong>lockInterruptibly()</strong>:  这个方法也会一直等待锁的获取，和lock不同的是，我们可以通过thread.interrupt方法时，让线程响应中断，不再继续等待。</p> <p><strong>unLock</strong>():  释放锁，==使用lock一定要注意手动释放锁==</p> <p><strong>newCondition</strong>():  可以创建多个condition对象，实现await和signal组合。</p> <h4 id="condition"><a href="#condition" class="header-anchor">#</a> Condition</h4> <p><strong>作用</strong>：condition存在的意义是为了实现类似 object.wait()和object.notify()的功能。wiat和notify方法可以让线程等待、被唤醒。condition也一样，但是它可以更加有针对性的去让某一类线程被唤醒。</p> <p><strong>使用介绍</strong>：</p> <p>await():  让当前线程进入condition的等待队列</p> <p>signal()：唤醒condition队列上的某一个线程</p> <p>signalAll(): 唤醒condition队列上的所有线程；</p> <h4 id="demo"><a href="#demo" class="header-anchor">#</a> Demo</h4> <p>1.实现公平锁</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ReentrantLock</span> reentrantLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 公平锁</span>
<span class="token class-name">Runnable</span> runnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      reentrantLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程&quot;</span>  <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;获取锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>reentrantLock<span class="token punctuation">.</span><span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          reentrantLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//						System.out.println(&quot;线程&quot; + Thread.currentThread().getName() + &quot;释放锁&quot;);</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>runnable<span class="token punctuation">,</span> <span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>runnable<span class="token punctuation">,</span> <span class="token string">&quot;t2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果ReentrantLock构造函数传入的是true，那么使用的是公平锁，打印结果会呈现线程1和线程2交替获取到锁的样子；</p> <h3 id=""><a href="#" class="header-anchor">#</a></h3> <p>2.ReentraLock实现阻塞队列的模式：</p> <blockquote><p>https://gitee.com/dendi.ke/thread-demo/blob/master/src/main/java/com/gs/example/producerandconsumer/ProducerAndConsumerDemo2.java</p></blockquote> <h3 id="synchronized和reentralock的区别"><a href="#synchronized和reentralock的区别" class="header-anchor">#</a> Synchronized和ReentraLock的区别</h3> <p>Synchronized的锁升级是不可逆的，因此一旦升级为重锁，就会造成每次都次并发锁都是重锁。</p> <h3 id="多线程死锁"><a href="#多线程死锁" class="header-anchor">#</a> 多线程死锁</h3> <p><strong>死锁的原因</strong></p> <p>主要是因为线程锁的等待：比如有2个线程，都需要获取2把锁才能执行。线程1获取了锁A，线程2获取到了锁B。那么线程1不断的在等锁B，线程2不断的在等锁A，就会导致死锁。</p> <p>模拟的多线程死锁Demo：</p> <p>atomicInteger原子类</p> <p>线程通信</p> <h2 id="容器的并发"><a href="#容器的并发" class="header-anchor">#</a> 容器的并发</h2> <blockquote><p>https://juejin.im/post/5aeebd02518825672f19c546</p></blockquote> <h3 id="map"><a href="#map" class="header-anchor">#</a> Map</h3> <p>首先确定一点，HashMap是线程不安全的，原因可以参考另一篇HashMap的原理分析；</p> <p>ConcurrentMap</p> <p>ConcurrentSkipListMap</p> <p>几个java常见容器的比较</p> <p>Map：</p> <p>LinkedHashMap：继承于HashMap，主要为了解决HashMap读取顺序不能和插入顺序一致的问题。</p> <p>HashMap</p> <h3 id="list"><a href="#list" class="header-anchor">#</a> List</h3> <p>ArrayList/ LinkedList的区别</p> <p>ArrayList是线程不安全的，多个线程同步add，会出现添加丢失的问题；</p> <p>因为ArrayList的add方法不是原子操作, 可能会出现数组越界或者数据重复放在一个位置上问题；</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">ensureCapacityInternal</span><span class="token punctuation">(</span>size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  elementData<span class="token punctuation">[</span>size<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>怎么去解决线程安全的问题？</p> <p>Vector是线程安全的；</p> <p>ConcurrentLinkedQueue：是线程安全队列</p> <p>add() 和 offer() 的区别：</p> <p>add()和offer()都是向队列中添加一个元素。如果一个queue是有大小限制的，调用add方法会抛出异常，而调用offer方法会返回false；</p> <h4 id="concurrentskiplistset：是排序的队列；"><a href="#concurrentskiplistset：是排序的队列；" class="header-anchor">#</a> ConcurrentSkipListSet：是排序的队列；</h4> <h3 id="blockingqueue"><a href="#blockingqueue" class="header-anchor">#</a> BlockingQueue</h3> <p><strong>LinkedBlockingQueue</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 需求：使用blockQueue，模拟生产者和消费者
 * @author keyang
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LinkedBlockQueue</span> <span class="token punctuation">{</span>
	
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
				<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">try</span> <span class="token punctuation">{</span>
						queue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;p&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
				<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">try</span> <span class="token punctuation">{</span>
						<span class="token comment">// 如果queue空了，会自动阻塞等待</span>
						<span class="token class-name">String</span> str <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消费者取出了&quot;</span> <span class="token operator">+</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;c&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>ArrayBlockingQueue</strong></p> <blockquote><p>ArrayBlockingQueue是可以设定界限的</p></blockquote> <p><strong>方法区别</strong>：</p> <p>put会在队列满的时候，阻塞队列的加入。</p> <p>add会在队列满的时候抛出异常</p> <p>offer会返回到底是加入成功或者失败；</p> <p><strong>DelayQueue</strong></p> <p>应用场景： 处理一些定时任务。比如电商系统中的超时订单自动关闭；</p> <p>使用介绍：DelayQueue队列里添加的item需要实现Delayed接口，实现2个方法：getDelay、compareTo</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DelayQueueDemo</span> <span class="token punctuation">{</span>
	<span class="token keyword">static</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MyTask</span><span class="token punctuation">&gt;</span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DelayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyTask</span> <span class="token keyword">implements</span> <span class="token class-name">Delayed</span> <span class="token punctuation">{</span>
		<span class="token keyword">private</span> <span class="token keyword">long</span> time<span class="token punctuation">;</span>
		<span class="token comment">/**
		 * 返回当前的延迟时间, long类型
		 * @param timeUnit
		 * @return
		 */</span>
		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getDelay</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> timeUnit<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>time <span class="token operator">-</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">/**
		 * 比较两个task的超时时间
		 * @param delayed
		 * @return
		 */</span>
		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token class-name">Delayed</span> delayed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDelay</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span> <span class="token operator">-</span> delayed<span class="token punctuation">.</span><span class="token function">getDelay</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">public</span> <span class="token class-name">MyTask</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>time <span class="token operator">=</span> time<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> time <span class="token operator">+</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>DelayQueue是一个存放实现Delayed接口的数据的无界阻塞队列，只有当数据对象的延时时间达到时才能插入到队列进行存储。如果当前所有的数据都还没有达到创建时所指定的延时期，则队列没有队头，并且线程通过poll等方法获取数据元素则返回null。</p> <blockquote><p>附：其他的定时任务解决方案；</p> <ol><li>使用数据库定时任务，每隔几秒扫描订单表，找出超时订单后关闭。</li> <li>使用spring的@Scheduled注解启动定时任务或者使用Quartz任务管理器，定时触发任务，处理超时订单。</li> <li>使用消息中间件，通过mq提供的延迟消息队列，下单后往延迟消息队列中发消息，超时后，消费端会接收到一条延迟的订单消息，并做相应处理。</li> <li>按需处理。在用户查询的时候，检测订单是否超时，若超时，则关闭订单</li></ol></blockquote> <p><strong>LinkedTransferQueue</strong></p> <p>transfer方法必须直接传递给消费者，否则方法会阻塞住。</p> <p>take方法如果没有取出数据也会被阻塞。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">TransferQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedTransferQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>queue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token comment">//			boolean a = queue.tryTransfer(&quot;transfer demo&quot;, 2, TimeUnit.SECONDS);</span>
			queue<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token string">&quot;transfer demo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre></div><p><strong>SynchronousQueue</strong></p> <blockquote><p>这个阻塞队列的容量是0；需要先启动消费者，</p> <p>take方法会阻塞;</p> <p>put方法需要马上被拿走，否则进入阻塞状态。底层也是用TransferQueue来实现的;</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SynchronousQueueDemo</span> <span class="token punctuation">{</span>
	
	<span class="token keyword">static</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>queue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token comment">//			queue.put(&quot;SynchronousQueue&quot;);</span>
			<span class="token keyword">boolean</span> offered <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token string">&quot;SynchronousQueue&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>offered<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="线程池"><a href="#线程池" class="header-anchor">#</a> 线程池</h2> <h3 id="_1-线程池概述"><a href="#_1-线程池概述" class="header-anchor">#</a> 1.线程池概述</h3> <p><strong>线程池作用</strong>：可以避免线程的频繁的创建回收，减少系统的开销；</p> <p><strong>API介绍</strong>：ThreadPoolExecutor</p> <p><strong>核心参数</strong>：</p> <table><thead><tr><th>参数</th> <th>意义</th> <th>说明</th></tr></thead> <tbody><tr><td>corePoolSize</td> <td>核心线程数量</td> <td>默认情况下，主线程一直存在</td></tr> <tr><td>maximumPoolSize</td> <td>最大线程数量</td> <td>当线程达到最大数量后，后续任务会被阻塞</td></tr> <tr><td>keepAliveTime</td> <td>线程空闲时间</td> <td>超过这个时间，非主线程会被回收</td></tr> <tr><td>unit</td> <td>空闲时间单位</td> <td></td></tr> <tr><td>workQueue</td> <td>任务队列</td> <td>用来存储execute传入的任务</td></tr> <tr><td>threadFactory</td> <td>线程工厂</td> <td>用来创建线程任务，可以指定线程名</td></tr> <tr><td>rejectHandler</td> <td>RejectedExecutionHandler</td> <td>当线程被拒绝时，放入的队列；</td></tr></tbody></table> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 线程池管理器
 * @author keyang
 *
 */</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolManager</span> <span class="token punctuation">{</span>
 
 <span class="token keyword">static</span> <span class="token class-name">ThreadPoolManager</span> threadPoolManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> CORE_POOL_SIZE <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
 <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX_POOL_SIZE <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
 <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> KEEP_ALIVE_TIME <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
 <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SIZE_WORK_QUEUE <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
 
 
 <span class="token keyword">private</span> <span class="token class-name">ThreadPoolManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">}</span>
 
 <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ThreadPoolManager</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> threadPoolManager<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 
 <span class="token comment">/**
  * 用来存放排队的任务
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> mTaskQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RejectedExecutionHandler</span> myRejectHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rejectedExecution</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">ThreadPoolExecutor</span> executor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   mTaskQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">;</span>
 
 <span class="token keyword">private</span> <span class="token class-name">ScheduledExecutorService</span> scheduledThreadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token comment">/**
  * 定时从排队任务队列中获取任务
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> scheduledFuture <span class="token operator">=</span> scheduledThreadPool<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mTaskQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    threadPoolExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>mTaskQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token class-name">ThreadFactory</span> namedThreadFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Ky线程-%d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ThreadPoolExecutor</span> threadPoolExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>CORE_POOL_SIZE<span class="token punctuation">,</span> MAX_POOL_SIZE<span class="token punctuation">,</span> KEEP_ALIVE_TIME<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>SIZE_WORK_QUEUE<span class="token punctuation">)</span><span class="token punctuation">,</span>
  namedThreadFactory<span class="token punctuation">,</span> myRejectHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addExecuteTask</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>threadPoolExecutor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   threadPoolExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 
 <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">getPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> threadPoolExecutor<span class="token punctuation">.</span><span class="token function">getPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  mTaskQueue<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  scheduledThreadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  threadPoolExecutor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-创建线程池的方式"><a href="#_2-创建线程池的方式" class="header-anchor">#</a> 2.创建线程池的方式</h3> <p>JDK提供了很多种创建线程池的方式, 都是通过Executors的静态方法来实现。</p> <h4 id="fixedthreadpool"><a href="#fixedthreadpool" class="header-anchor">#</a> FixedThreadPool</h4> <p>特点：只有核心线程数量，线程不会被回收，线程数量是固定的，任务队列没有大小限制</p> <p>使用场景：控制线程的并发量</p> <h4 id="scheduledthreadpool"><a href="#scheduledthreadpool" class="header-anchor">#</a> ScheduledThreadPool</h4> <p>特点：核心线程数量固定，非核心线程数量无限制</p> <p>使用场景：执行定期的任务</p> <p>内部队列是DelayedWorkQueue</p> <h4 id="cachedthreadpool"><a href="#cachedthreadpool" class="header-anchor">#</a> CachedThreadPool</h4> <p>特点：线程池内只有非核心线程，线程最大数量没有限制，线程超过空闲时间后会因为闲置被回收。任务队列采用的是SynchronousQueue，加入的任务会马上被执行。</p> <p>使用场景：执行大量、耗时少的任务</p> <h4 id="singlethreadpool"><a href="#singlethreadpool" class="header-anchor">#</a> SingleThreadPool</h4> <p>特点：只有一个核心线程，保证线程任务按照顺序执行。任务队列采用的是LinkedBlockingQueue，又只有1个核心线程处理，所以无需处理线程同步问题；</p> <p>使用场景：多个任务按顺序执行。</p> <p>这4种线程池底层的原理都是通过ThreadPoolExecutor类来实现的；</p> <p>另外还有一些特殊的线程池：</p> <h4 id="forkjoinpool"><a href="#forkjoinpool" class="header-anchor">#</a> ForkJoinPool</h4> <p>特点：他的核心理念是分而治之，他的作用就是将一个大任务通过多线程来拆分成多子任务；</p> <p>使用场景：适合做1个大数的计算；</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ForkJoinPoolDemo</span> <span class="token punctuation">{</span>

	<span class="token keyword">static</span> <span class="token keyword">int</span> MAX <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">;</span>
	
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyTask</span> <span class="token keyword">extends</span> <span class="token class-name">RecursiveAction</span> <span class="token punctuation">{</span>
		<span class="token keyword">private</span> <span class="token keyword">int</span> start<span class="token punctuation">;</span>
		<span class="token keyword">private</span> <span class="token keyword">int</span> end<span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token class-name">MyTask</span><span class="token punctuation">(</span><span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> start<span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">=</span> end<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">&lt;</span> MAX<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;从&quot;</span> <span class="token operator">+</span> start <span class="token operator">+</span> <span class="token string">&quot;到&quot;</span> <span class="token operator">+</span> end <span class="token operator">+</span> <span class="token string">&quot; = &quot;</span> <span class="token operator">+</span> <span class="token function">getSum</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token class-name">MyTask</span> task1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyTask</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> <span class="token punctuation">(</span>end <span class="token operator">+</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">MyTask</span> task2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyTask</span><span class="token punctuation">(</span><span class="token punctuation">(</span>end <span class="token operator">+</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//				task1.fork();</span>
<span class="token comment">//				task2.fork();</span>
				<span class="token function">invokeAll</span><span class="token punctuation">(</span>task1<span class="token punctuation">,</span> task2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行给定的任务</span>
				
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyRecursiveTask</span> <span class="token keyword">extends</span> <span class="token class-name">RecursiveTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
		
		<span class="token keyword">private</span> <span class="token keyword">int</span> start<span class="token punctuation">;</span>
		<span class="token keyword">private</span> <span class="token keyword">int</span> end<span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token class-name">MyRecursiveTask</span><span class="token punctuation">(</span><span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> start<span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">=</span> end<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">protected</span> <span class="token class-name">Integer</span> <span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">&lt;</span> MAX<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token function">getSum</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token class-name">MyRecursiveTask</span> task1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyRecursiveTask</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> <span class="token punctuation">(</span>end <span class="token operator">+</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">MyRecursiveTask</span> task2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyRecursiveTask</span><span class="token punctuation">(</span><span class="token punctuation">(</span>end <span class="token operator">+</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
				task1<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				task2<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> task1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> task2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">getSum</span><span class="token punctuation">(</span><span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			sum <span class="token operator">+=</span> i<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> sum<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">getSum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token class-name">ForkJoinPool</span> forkJoinPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//		MyTask myTask = new MyTask(0, 100000);</span>
<span class="token comment">//		forkJoinPool.execute(myTask);</span>
		
		<span class="token class-name">MyRecursiveTask</span> myRecursiveTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyRecursiveTask</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> forkJoinPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>myRecursiveTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;多线程执行结果：&quot;</span><span class="token operator">+</span>future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">InterruptedException</span> <span class="token operator">|</span> <span class="token class-name">ExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>使用介绍</strong>：ForkJoinPool实例有两种方法：submit和execute，传入的参数类型都是ForkJoinTask；</p> <p>但是execute方法无返回值，而submit方法会返回一个Future类的实例。</p> <p>ForkJoinTask是一个抽象类，它有2个子类，特点也是和submit和execute方法对应。</p> <p>RecursiveAction 的compute方法是无返回值的</p> <p>RecursiveTask 的compute方法有返回值</p> <p><strong>高级使用</strong>：</p> <p>使用ForkJoin的思想来实现一个快速排序</p> <p>https://gitee.com/dendi.ke/thread-demo/blob/master/src/main/java/com/gs/example/threadpool/ForkJoinPoolDemo2.java</p> <p>​</p> <h3 id="_3-线程池原理分析"><a href="#_3-线程池原理分析" class="header-anchor">#</a> 3.线程池原理分析</h3> <p><strong>线程池逻辑</strong></p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-18-082656.png" alt="utf-8' '944365-90cfd4951a587ebd"></p> <p>先判断<code>线程数量</code>是否达到<code>核心线程池数量</code>最大限制；</p> <p>再判断线程的<code>任务队列数量</code>是否已满</p> <p>最后再判断<code>线程数量</code>是否满足<code>最大线程数量</code>限制</p> <p><strong>任务丢弃策略</strong>
handler：表示当拒绝处理任务时的策略，有以下四种取值：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">.</span><span class="token class-name">AbortPolicy</span><span class="token operator">:</span> 丢弃任务并抛出<span class="token class-name">RejectedExecutionException</span>异常。 
<span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">.</span><span class="token class-name">DiscardPolicy</span>： 会默默丢弃掉任务，但是不抛出异常。 
<span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">.</span><span class="token class-name">DiscardOldestPolicy</span>：丢弃队列最先进来的任务，然后重新尝试执行任务（重复此过程） 
<span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">.</span><span class="token class-name">CallerRunsPolicy</span>：由创建任务的线程来去处理该任务。 这个会影响任务的创建
</code></pre></div><p><strong>线程池容量的动态调整</strong>
ThreadPoolExecutor提供了动态调整线程池容量大小的方法：setCorePoolSize()和setMaximumPoolSize()，
setCorePoolSize：设置核心池大小
setMaximumPoolSize：设置线程池最大能创建的线程数目大小
当上述参数从小变大时，ThreadPoolExecutor进行线程赋值，还可能立即创建新的线程来执行任务。</p> <p><strong>线程池关闭原理</strong>：</p> <p>a. 遍历线程池中的所有工作线程
b. 逐个调用线程的interrupt() 中断线程（注：无法响应中断的任务可能永远无法终止）</p> <p><strong>关闭线程池方法</strong>：</p> <ul><li><p>shutdown（）</p></li> <li><p>shutdownNow（）</p></li></ul> <p><strong>二者区别</strong>：</p> <ul><li><p>shutdown：设置 线程池的状态 为 SHUTDOWN，然后<strong>中断</strong>所有没有正在执行任务的线程。它不会立即终止线程池，但是再也不会接受新的任务</p></li> <li><p>shutdownNow：设置 线程池的状态 为 STOP，然后尝试<strong>打断</strong>所有的正在执行或暂停任务的线程，并且清空任务缓存队列，<strong>返回等待执行任务的列表</strong>。</p></li></ul> <p><strong>使用建议</strong>：</p> <p>一般调用shutdown，正常的关闭线程池，</p> <p>若任务不一定要执行完，则调用shutdownNow()</p> <p>要设定线程工程的名称，这样可以创建线程时指定名称。</p> <h3 id="_4-线程池合理数量配置"><a href="#_4-线程池合理数量配置" class="header-anchor">#</a> 4.线程池合理数量配置</h3> <p>遵循两原则：</p> <p>1、如果是<a href="#CPU%E5%AF%86%E9%9B%86%E5%9E%8B%EF%BC%88CPU-bound%EF%BC%89">CPU密集型任务</a>，就需要尽量压榨CPU，参考值可以设为 NCPU+1
2、如果是[IO密集型任务](#IO密集型（I/O bound）)，参考值可以设置为2*NCPU</p> <p>当然，这只是一个参考值，具体的设置还需要根据实际情况进行调整，比如可以先将线程池大小设置为参考值，再观察任务运行情况和系统负载、资源利用率来进行适当调整。</p> <h3 id="_5-executorservice解析"><a href="#_5-executorservice解析" class="header-anchor">#</a> 5.ExecutorService解析</h3> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-18-082659.png" alt="ScheduledThreadPoolExecutor类的UML图.png"></p> <h4 id="executor接口"><a href="#executor接口" class="header-anchor">#</a> Executor接口</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Executor</span> <span class="token punctuation">{</span>
  <span class="token comment">// 执行任务</span>
  <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>顶层接口，可以调用execute(Runnable r)的方法。</p> <h4 id="executorservice接口"><a href="#executorservice接口" class="header-anchor">#</a> ExecutorService接口</h4> <h4 id="callable接口"><a href="#callable接口" class="header-anchor">#</a> Callable接口</h4> <p>类似于Runnable接口，区别是Callable里面是call() 方法，返回一个泛型。Runnable里面试run()方法，没有返回。</p> <h3 id="_6-executors"><a href="#_6-executors" class="header-anchor">#</a> 6.Executors</h3> <p>Executors 是一个Java中的工具类。提供工厂方法来创建不同类型的线程池。</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-18-082658.jpg" alt="img">￼</p> <p>从上图中也可以看出，Executors的创建线程池的方法，创建出来的线程池都实现了ExecutorService接口。常用方法有以下几个：</p> <p><code>newFiexedThreadPool(int Threads)</code>：创建固定数目线程的线程池。</p> <p><code>newCachedThreadPool()</code>：创建一个可缓存的线程池，调用execute 将重用以前构造的线程（如果线程可用）。如果没有可用的线程，则创建一个新线程并添加到池中。终止并从缓存中移除那些已有 60 秒钟未被使用的线程。</p> <p><code>newSingleThreadExecutor()</code>创建一个单线程化的Executor。</p> <p><code>newScheduledThreadPool(int corePoolSize)</code>创建一个支持定时及周期性的任务执行的线程池，多数情况下可用来替代Timer类。</p> <p>类看起来功能还是比较强大的，又用到了工厂模式、又有比较强的扩展性，重要的是用起来还比较方便，如：</p> <div class="language-text extra-class"><pre class="language-text"><code>ExecutorService executor = Executors.newFixedThreadPool(nThreads) ;
</code></pre></div><p>即可创建一个固定大小的线程池。</p> <p>但是Alibaba禁止使用Executors来创建线程池；</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-12-11-035540.jpg" alt="img" style="zoom:25%;"> <p>可以看到，手册中提到Executors创建的线程池会造成OOM（Out of Memory）。</p> <p>为什么会造成OOM呢？为了理解这个文档，写了个例子：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent</span><span class="token punctuation">.</span><span class="token class-name">ExecutorService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent</span><span class="token punctuation">.</span><span class="token class-name">Executors</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;AlibabaThreadPoolCreation&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OOMDemo</span> <span class="token punctuation">{</span>
  <span class="token comment">// LinkedBlockingQueue</span>
  <span class="token keyword">private</span> <span class="token class-name">ExecutorService</span> executorService1 <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// LinkedBlockingQueue</span>
  <span class="token keyword">private</span> <span class="token class-name">ExecutorService</span> executorService2 <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// SynchronousQueue</span>
  <span class="token keyword">private</span> <span class="token class-name">ExecutorService</span> executorService3 <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// DelayedWorkQueue</span>
  <span class="token keyword">private</span> <span class="token class-name">ExecutorService</span> executorService4 <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">new</span> <span class="token class-name">OOMDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      executorService1<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>运行时设置jvm参数：-Xmx8m -Xms8m</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-18-82660.png" alt="image-20191211135706201"></p> <h2 id="线程锁"><a href="#线程锁" class="header-anchor">#</a> 线程锁</h2> <blockquote><p>参考：https://zhuanlan.zhihu.com/p/71156910?utm_source=wechat_session&amp;utm_medium=social&amp;utm_oi=722156590005776384</p></blockquote> <p>java里面锁主要的作用就是解决多线程的安全性问题；java里有2种加锁的方式：</p> <p>1.synchronize关键字。这种方式写代码很简单，但相对的，它使用锁的级别也很高；如果对性能没有要求，那么一般都会用synchronize关键来加锁</p> <p>2.Lock实现类。另一种方式就是用java的<code>Lock</code>。Lock是一个接口，她的实现类在代码层面实现了锁的功能。常用的实现类如下：</p> <p>ReentrantLock类，ReadLock类，WriteLock类；</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-18-082657.jpg" alt="v2-ddb71ab0b68d65ae70244bfdeb0d6704_hd"></p> <h3 id="synchronized-和-lock的区别"><a href="#synchronized-和-lock的区别" class="header-anchor">#</a> Synchronized  和 lock的区别</h3> <p>synchronize是java的关键字，可以用来修饰方法、代码块等。主要目的是保证方法或者方法块是线程安全的。</p> <p>lock是java提供的一个接口，他有很多实现类、常用到的比如ReentantLock、ReentraReadWriteLock等。它们可以灵活的使用，主要也是保证线程安全。</p> <p>手动使用lock需要注意几点：</p> <p>1.lock必须手动释放unlock，而synchronize会自动释放锁；</p> <p>2.lock可以实现公平锁，而synchronize是非公平的</p> <p>3.lock的获取可以灵活判断，synchronize的锁获取只能一直等待。</p> <h3 id="悲观锁-乐观锁"><a href="#悲观锁-乐观锁" class="header-anchor">#</a> 悲观锁&amp;乐观锁</h3> <p>锁的一种宏观分类方式。是指在并发的情况下，两种策略；</p> <p><strong>悲观锁</strong>：当多个线程有竞争关系时，我们总是认为某个共享数据会被其他线程修改（<strong>很悲观</strong>）；所以需要用到共享数据的线程就去把数据加一把锁，这样别的线程就只能等待当前线程释放锁后才能使用；</p> <p><strong>乐观锁</strong>：当线程修改某一个数据时，总认为当前数据不会被别的线程修改，所以不会去加锁（<strong>很乐观</strong>）。如果线程需要更新数据，会去检查从数据读取到更新这段时间类，数据有没有发生修改。如果这期间数据没有变化，那么就执行更新操作；否则回滚操作，重新读取更新一遍，并重复上次检查；</p> <p><strong>使用场景比较</strong>：</p> <p>乐观锁一般适用于<strong>写比较少</strong>的情况下，这样线程冲突真的很少发生，可以省去加锁的开销；</p> <p>悲观锁则比较适合冲突较多的情况；</p> <h3 id="cas无锁机制"><a href="#cas无锁机制" class="header-anchor">#</a> CAS无锁机制</h3> <p>乐观锁的底层机制就是CAS机制：<strong>Compare and Set</strong></p> <ol><li>首先比较值。比如读取到一个值为A，如果在将A更新为B的过程中，检查A是否发生了变化。</li> <li>如果相同，那么执行set操作，将值更新为B；否则不执行操作，重新读取值；</li></ol> <p>上面两步是原子性的，在CPU看来是一步操作；</p> <p>乐观锁的机制就是CAS的重试算法，整个过程没有“加锁”和“解锁”操作，所以乐观锁策略也被称为<strong>无锁编程</strong>。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 伪代码</span>
	<span class="token keyword">public</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> current <span class="token operator">=</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> next <span class="token operator">=</span> current <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token comment">// CAS操作</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> current<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndDecrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> current <span class="token operator">=</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> next <span class="token operator">=</span> current <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> current<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="自旋锁"><a href="#自旋锁" class="header-anchor">#</a> 自旋锁</h3> <p>当线程占用某一个锁时，其他的线程会一直不断的循环获取锁；怎么理解这个概念？需要先了解一下java的synchronize锁升级机制：</p> <h4 id="synchronized锁升级：偏向锁-→-轻量级锁-→-重量级锁"><a href="#synchronized锁升级：偏向锁-→-轻量级锁-→-重量级锁" class="header-anchor">#</a> synchronized锁升级：偏向锁 → 轻量级锁 → 重量级锁</h4> <p>初次执行到synchronize代码块时，使用的是偏向锁。</p> <p>当其他线程也进入到synchronize代码块时，如果获取不到锁，就会进入等待状态。锁会升级为轻量级锁，也就是<code>自旋锁</code></p> <p>自旋锁也有限制，因为线程不断的空循环也会消耗性能。所以当线程循环的次数超过一定次数，线程会进入挂起状态等待被唤醒，自旋锁会升级为重量级锁。后面的线程当发现锁级别是重量级锁时，直接挂起。</p> <h3 id="可重入锁"><a href="#可重入锁" class="header-anchor">#</a> 可重入锁</h3> <blockquote><p>可以重复获取的锁；</p></blockquote> <p>synchronize是可重入锁。当1个线程执行某一个synchronize代码块时，它会先获取到对象的锁。如果在这个代码块中还调用了另一个synchronize的方法，该线程就需要再次申请这个对象的锁。java里是允许连续两次申请synchronize锁，释放锁时也是依次释放；</p> <p>Java还提供了一个ReerantLock的实现类：<code>java.util.concurrent.locks.ReentrantLock</code></p> <h3 id="可中断锁"><a href="#可中断锁" class="header-anchor">#</a> 可中断锁</h3> <h3 id="读写锁"><a href="#读写锁" class="header-anchor">#</a> 读写锁</h3> <p>读写锁是一对儿锁。一个<code>读锁</code>和一个<code>写锁</code></p> <p><strong>读锁</strong>：共享锁；</p> <p><strong>写锁</strong>：互斥锁；</p> <p>线程读取数据时候，知道自己是需要做==更新操作==还是做==只读操作==。当需要更新时，加写锁，这样别的线程<strong>无论是读取还是写入都会阻塞</strong>。当需要读取时，加读锁，其他线程如果也要加读锁，不需要等待，可以直接获取，但是<strong>读锁计数器要+1</strong>。</p> <p>多线程框架</p> <p>aqs</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.b78fad8d.js" defer></script><script src="/assets/js/2.c5c14eb8.js" defer></script><script src="/assets/js/87.8fee21f9.js" defer></script>
  </body>
</html>
