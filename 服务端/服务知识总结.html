<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>计算机基础 | Coda的博客</title>
    <meta name="generator" content="VuePress 1.5.1">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="闲着无聊？那就读书吧">
    <link rel="preload" href="/assets/css/0.styles.c3659042.css" as="style"><link rel="preload" href="/assets/js/app.ab51adc0.js" as="script"><link rel="preload" href="/assets/js/2.c5c14eb8.js" as="script"><link rel="preload" href="/assets/js/81.1009b854.js" as="script"><link rel="prefetch" href="/assets/js/10.18134ce1.js"><link rel="prefetch" href="/assets/js/11.bded85d3.js"><link rel="prefetch" href="/assets/js/12.bde1e69c.js"><link rel="prefetch" href="/assets/js/13.20f0daa8.js"><link rel="prefetch" href="/assets/js/14.e71fe2b7.js"><link rel="prefetch" href="/assets/js/15.973e36e2.js"><link rel="prefetch" href="/assets/js/16.48ea97ee.js"><link rel="prefetch" href="/assets/js/17.44165697.js"><link rel="prefetch" href="/assets/js/18.7656306f.js"><link rel="prefetch" href="/assets/js/19.3b73be2d.js"><link rel="prefetch" href="/assets/js/20.74c7944b.js"><link rel="prefetch" href="/assets/js/21.b42b7490.js"><link rel="prefetch" href="/assets/js/22.106ca3e0.js"><link rel="prefetch" href="/assets/js/23.37778393.js"><link rel="prefetch" href="/assets/js/24.3199fbc3.js"><link rel="prefetch" href="/assets/js/25.53e9b0e1.js"><link rel="prefetch" href="/assets/js/26.14149d9d.js"><link rel="prefetch" href="/assets/js/27.d57592e1.js"><link rel="prefetch" href="/assets/js/28.3ff82e9d.js"><link rel="prefetch" href="/assets/js/29.97176bda.js"><link rel="prefetch" href="/assets/js/3.c5d8af3d.js"><link rel="prefetch" href="/assets/js/30.a378177d.js"><link rel="prefetch" href="/assets/js/31.43afb959.js"><link rel="prefetch" href="/assets/js/32.f60c48f3.js"><link rel="prefetch" href="/assets/js/33.29b7618e.js"><link rel="prefetch" href="/assets/js/34.50a3f818.js"><link rel="prefetch" href="/assets/js/35.3b1066cf.js"><link rel="prefetch" href="/assets/js/36.8e145340.js"><link rel="prefetch" href="/assets/js/37.c729ab18.js"><link rel="prefetch" href="/assets/js/38.b725d03a.js"><link rel="prefetch" href="/assets/js/39.417c26f6.js"><link rel="prefetch" href="/assets/js/4.c4955446.js"><link rel="prefetch" href="/assets/js/40.e50f245f.js"><link rel="prefetch" href="/assets/js/41.3fad6327.js"><link rel="prefetch" href="/assets/js/42.785c6d7c.js"><link rel="prefetch" href="/assets/js/43.ddd6d541.js"><link rel="prefetch" href="/assets/js/44.38a9e0ae.js"><link rel="prefetch" href="/assets/js/45.b327da2c.js"><link rel="prefetch" href="/assets/js/46.fa32de5e.js"><link rel="prefetch" href="/assets/js/47.321c2a7d.js"><link rel="prefetch" href="/assets/js/48.ffd0f672.js"><link rel="prefetch" href="/assets/js/49.98c5d965.js"><link rel="prefetch" href="/assets/js/5.790d3fc0.js"><link rel="prefetch" href="/assets/js/50.d6cc7cea.js"><link rel="prefetch" href="/assets/js/51.35899890.js"><link rel="prefetch" href="/assets/js/52.56671b7a.js"><link rel="prefetch" href="/assets/js/53.93f7bd4c.js"><link rel="prefetch" href="/assets/js/54.fc47b235.js"><link rel="prefetch" href="/assets/js/55.21e6c2e4.js"><link rel="prefetch" href="/assets/js/56.91a6f7fb.js"><link rel="prefetch" href="/assets/js/57.5d0cc641.js"><link rel="prefetch" href="/assets/js/58.e0559e3e.js"><link rel="prefetch" href="/assets/js/59.0193154f.js"><link rel="prefetch" href="/assets/js/6.720e350f.js"><link rel="prefetch" href="/assets/js/60.1a07d581.js"><link rel="prefetch" href="/assets/js/61.da950d0a.js"><link rel="prefetch" href="/assets/js/62.695e2262.js"><link rel="prefetch" href="/assets/js/63.053c1fc3.js"><link rel="prefetch" href="/assets/js/64.37951038.js"><link rel="prefetch" href="/assets/js/65.457e8917.js"><link rel="prefetch" href="/assets/js/66.d00a221f.js"><link rel="prefetch" href="/assets/js/67.9be23755.js"><link rel="prefetch" href="/assets/js/68.07f1f234.js"><link rel="prefetch" href="/assets/js/69.66fa7ec4.js"><link rel="prefetch" href="/assets/js/7.9f6e7a1c.js"><link rel="prefetch" href="/assets/js/70.47ce7932.js"><link rel="prefetch" href="/assets/js/71.0e10b798.js"><link rel="prefetch" href="/assets/js/72.fcbd2010.js"><link rel="prefetch" href="/assets/js/73.203164da.js"><link rel="prefetch" href="/assets/js/74.0991c52c.js"><link rel="prefetch" href="/assets/js/75.465d555b.js"><link rel="prefetch" href="/assets/js/76.8e4b5977.js"><link rel="prefetch" href="/assets/js/77.79b44f01.js"><link rel="prefetch" href="/assets/js/78.fb8d4e0d.js"><link rel="prefetch" href="/assets/js/79.2add2ade.js"><link rel="prefetch" href="/assets/js/8.c6c4c9d5.js"><link rel="prefetch" href="/assets/js/80.64001ccd.js"><link rel="prefetch" href="/assets/js/82.c82ca639.js"><link rel="prefetch" href="/assets/js/83.ad196b09.js"><link rel="prefetch" href="/assets/js/84.1375ac66.js"><link rel="prefetch" href="/assets/js/85.037f1214.js"><link rel="prefetch" href="/assets/js/86.51b4df55.js"><link rel="prefetch" href="/assets/js/87.d3940b43.js"><link rel="prefetch" href="/assets/js/88.b7ccfc1a.js"><link rel="prefetch" href="/assets/js/89.67e3013e.js"><link rel="prefetch" href="/assets/js/9.75d01cd2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c3659042.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Coda的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/服务端/" class="nav-link">
  服务端
</a></div><div class="nav-item"><a href="/前端/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/android/" class="nav-link">
  android
</a></div><div class="nav-item"><a href="/DevOps/" class="nav-link">
  devOps
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/服务端/" class="nav-link">
  服务端
</a></div><div class="nav-item"><a href="/前端/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/android/" class="nav-link">
  android
</a></div><div class="nav-item"><a href="/DevOps/" class="nav-link">
  devOps
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>计算机基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#操作系统" class="sidebar-link">操作系统</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#进程-vs-线程" class="sidebar-link">进程 vs 线程</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#存储" class="sidebar-link">存储</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#寻址空间" class="sidebar-link">寻址空间</a></li></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#计算机网络" class="sidebar-link">计算机网络</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#tcp协议-滑动窗口方案" class="sidebar-link">TCP协议 - 滑动窗口方案</a></li></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#jvm" class="sidebar-link">JVM</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#jdk、jre、jvm的区别" class="sidebar-link">JDK、JRE、JVM的区别</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#jvm内存区域" class="sidebar-link">JVM内存区域</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#gc垃圾回收机制" class="sidebar-link">GC垃圾回收机制</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#gc回收判断" class="sidebar-link">GC回收判断</a></li></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#jmm-java内存模型" class="sidebar-link">JMM——Java内存模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#jmm架构规范" class="sidebar-link">JMM架构规范</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#并发的三大特性-原子性、可见性、一致性" class="sidebar-link">并发的三大特性——原子性、可见性、一致性</a></li></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#多线程-服务知识总结-多线程" class="sidebar-link">多线程</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#cpu密集型-vs-io密集型" class="sidebar-link">CPU密集型 vs IO密集型</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#_1-网络编程概述" class="sidebar-link">1.网络编程概述</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#基础数据结构" class="sidebar-link">基础数据结构</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#源码、补码、反码" class="sidebar-link">源码、补码、反码</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#关于-与运算" class="sidebar-link">关于&amp;与运算</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#关于位移运算" class="sidebar-link">关于位移运算</a></li></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#_2-tcp与udp区别" class="sidebar-link">2.TCP与UDP区别</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#_3-udp发送消息" class="sidebar-link">3.UDP发送消息</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#发送消息的步骤" class="sidebar-link">发送消息的步骤</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#udp广播搜索" class="sidebar-link">UDP广播搜索</a></li></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#_4-tcp-（transmission-control-protocol）" class="sidebar-link">4.TCP （Transmission Control Protocol）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#三次握手" class="sidebar-link">三次握手</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#四次挥手" class="sidebar-link">四次挥手</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#tcp发送消息-（客户端与服务端）" class="sidebar-link">TCP发送消息 （客户端与服务端）</a></li></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#_5-udp辅助tcp进行服务发现" class="sidebar-link">5.UDP辅助TCP进行服务发现</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#_6-bio与nio" class="sidebar-link">6.BIO与NIO</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#网络模型：bio" class="sidebar-link">网络模型：BIO</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#网络模型：nio" class="sidebar-link">网络模型：NIO</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#nio的相关概念" class="sidebar-link">NIO的相关概念</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#nio的相关操作" class="sidebar-link">NIO的相关操作</a></li></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#_7-nio客户端与服务端" class="sidebar-link">7.NIO客户端与服务端</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#nio实现cs模型的流程" class="sidebar-link">NIO实现CS模型的流程</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#消息到达重复触发事件" class="sidebar-link">消息到达重复触发事件</a></li></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#_8-粘包与拆包" class="sidebar-link">8.粘包与拆包</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#_8-1基本概念" class="sidebar-link">8.1基本概念</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#_8-2解决方案" class="sidebar-link">8.2解决方案</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#_8-3代码实例" class="sidebar-link">8.3代码实例</a></li></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#_9-分片数据发送" class="sidebar-link">9.分片数据发送</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#_9-1-基本方案" class="sidebar-link">9.1 基本方案</a></li></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#_10-socket并发" class="sidebar-link">10.Socket并发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#客户端服务器连接数量限制" class="sidebar-link">客户端服务器连接数量限制</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#" class="sidebar-link"></a></li></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#http" class="sidebar-link">HTTP</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#数据库" class="sidebar-link">数据库</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#事物" class="sidebar-link">事物</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#redis-desktop-manager安装" class="sidebar-link">Redis-Desktop-Manager安装</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#redis5种基本类型" class="sidebar-link">Redis5种基本类型</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#redis实现分布式锁" class="sidebar-link">Redis实现分布式锁</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#redis事物" class="sidebar-link">Redis事物</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#redis缓存一致性" class="sidebar-link">Redis缓存一致性</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#redis主从复制" class="sidebar-link">Redis主从复制</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#哨兵机制-sentinel" class="sidebar-link">哨兵机制(Sentinel)</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#redis持久化" class="sidebar-link">Redis持久化</a></li></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#nginx" class="sidebar-link">Nginx</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#任务调度" class="sidebar-link">任务调度</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#分布式事物" class="sidebar-link">分布式事物</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#分布式框架1" class="sidebar-link">分布式框架1</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#分布式框架2" class="sidebar-link">分布式框架2</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#zookeeper" class="sidebar-link">Zookeeper</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#订单模块" class="sidebar-link">订单模块</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#撮合模块" class="sidebar-link">撮合模块</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#数据表设计" class="sidebar-link">数据表设计</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#订单类型" class="sidebar-link">订单类型</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#订单队列" class="sidebar-link">订单队列</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#自动成交" class="sidebar-link">自动成交</a></li><li class="sidebar-sub-header"><a href="/%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E6%9C%8D%E5%8A%A1%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.html#撮合算法" class="sidebar-link">撮合算法</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="计算机基础"><a href="#计算机基础" class="header-anchor">#</a> 计算机基础</h1> <p>前言</p> <blockquote><p>这篇笔记旨在将工作中、学习中遇到的知识点都详细的记录下来。慢慢巩固基础，掌握了扎实的基础，才能在工作、面试中游刃有余。</p></blockquote> <p>[TOC]</p> <h2 id="操作系统"><a href="#操作系统" class="header-anchor">#</a> 操作系统</h2> <h3 id="进程-vs-线程"><a href="#进程-vs-线程" class="header-anchor">#</a> 进程 vs 线程</h3> <p>不同点：</p> <p>从范围上讲，线程是比进程更小更细的运行单位。一个程序有多个进程，一个进程又包含了多个线程。但是真正执行体还是线程。</p> <p>从通信上讲，线程之间可以共享内存，相互通信，而进程之间内存独立。</p> <p>从运行时的内存占用上讲，线程不会占用系统资源，没有自己独立地址空间，只需要运行堆栈，来存放临时变量和程序计数器等信息。而进程是需要分配独立内存。</p> <h3 id="存储"><a href="#存储" class="header-anchor">#</a> 存储</h3> <h4 id="cpu缓存模型"><a href="#cpu缓存模型" class="header-anchor">#</a> CPU缓存模型</h4> <p>现代CPU为了提高运行速度，减少从内存中读取数据的次数，大多设计了3层缓存机制。整体架构如下：</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-31-221627.png" alt="image-20191101061626611" style="zoom:40%;"> <p>CPU一般都是多核CPU，每一个CPU内核里都有一个寄存器，寄存器主要用来存放当前CPU的操作符、计算结果等信息。</p> <p>多个CPU内核通过总线来传递、共享数据。</p> <h4 id="_3级缓存"><a href="#_3级缓存" class="header-anchor">#</a> 3级缓存</h4> <blockquote><p>https://www.jb51.net/hardware/cpu/610074.html</p></blockquote> <p>CPU高速缓存的出现主要是为了解决==CPU运算速度==与==内存读写速度==不匹配的矛盾。内存的读取太慢，导致CPU经常需要等待，无法发挥CPU的高速效果。</p> <p>通常CPU都会设计3级缓存，每个缓存的命中率大概在80%左右，即80%的数据可以从L1缓存中读取，20%的数据在L2缓存里读，依次类推。</p> <p>L1的缓存大小会 小于 L2 小于 L3。L1分2块区域：L1i用来缓存指令，L1d用来缓存数据。</p> <p>L3是所有CPU内核共享的</p> <h4 id="mesi协议"><a href="#mesi协议" class="header-anchor">#</a> MESI协议</h4> <blockquote><p>https://juejin.im/post/5da33288518825646c50f18c</p></blockquote> <p>多核cpu的缓存会存在缓存不一致的问题，想要解决这个问题，最好的方法就是加锁，保证每次只有一个cpu的缓存在被读取。</p> <p>早期的加锁策略是把整个内存总线锁定了起来，这样锁定期间，所有其他的CPU无法去修改内存中的地址，但是造成的问题就是性能很慢。</p> <p>现在的方案都是通过MESI协议来解决。</p> <p>MESI协议整体架构如下：</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-31-225407.png" alt="image-20191101065406793" style="zoom:40%;"> <p>MESI定义了<strong>缓存行</strong>的4种缓存状态：</p> <blockquote><p>缓存行：缓存的基本数据单位，在Intel的CPU上一般是64字节</p></blockquote> <table><thead><tr><th>状态</th> <th>描述</th></tr></thead> <tbody><tr><td>M（Modified）</td> <td>当前缓存有效，且值被修改了</td></tr> <tr><td>E（Exculsive）</td> <td>当前缓存有效，只存在当前CPU内核的缓存里</td></tr> <tr><td>S（Shared）</td> <td>当前缓存有效，存在于多个CPU的缓存中</td></tr> <tr><td>I（Invalid）</td> <td>当前存储无效</td></tr></tbody></table> <p><strong>读取规则</strong>：</p> <p>每个CPU上面都维护了某一个数据的缓存状态。</p> <p>处于M状态的缓存行，必须在其他CPU读取 该缓存行对应的内存地址之前，将修改的值写回缓存。</p> <p>处于S状态的缓存行，必须监听着让该缓存行无效 或 独享该缓存行 的请求，如果监听到以后，把缓存行状态设置为I。</p> <p>处于E状态的缓存行，如果监听到其他读取该缓存行对应的内存地址的操作，需要把该缓存行状态设置为S。</p> <p>如果缓存行的缓存状态是I，需要存内存中重新读取，然后把状态改为S。</p> <p><strong>状态机</strong></p> <p>MESI协议实际上是一种有限状态机，缓存状态会根据事件进行相应状态的改变。事件分成2类，</p> <p><code>cpu对cache的请求事件</code>，<code>总线对cache请求事件</code>。所有的事件都被<code>总线嗅探器</code>监听。</p> <p>cpu对cache的请求事件：</p> <ol><li>PrRd: 处理器请求<strong>读</strong>一个缓存块</li> <li>PrWr: 处理器请求<strong>写</strong>一个缓存块</li></ol> <p>总线对cache的请求事件:</p> <ol><li>BusRd：探器监听到 这块缓存块被其他cpu读了</li> <li>BusRdX：嗅探器监听到 该缓存块被别的cpu改了</li> <li>Flush：嗅探器通知 回写整个缓存到主内存</li></ol> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-01-144011.png" alt="image-20191101224011364" style="zoom:50%;"> <h3 id="寻址空间"><a href="#寻址空间" class="header-anchor">#</a> 寻址空间</h3> <blockquote><p><a href="https://blog.csdn.net/lvyibin890/article/details/82217193" target="_blank" rel="noopener noreferrer">虚拟内存与物理内存的联系与区别<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>👆这篇文章很好的解释了虚拟内存和物理内存的关系；</p> <p>寻址步骤：</p> <img src="/Users/keyang/Library/Application Support/typora-user-images/image-20191221214204303.png" alt="image-20191221214204303" style="zoom:30%;"> <p>这里的逻辑内存指的是虚拟地址!!!;程序时使用的地址称为<strong>虚拟地址或逻辑地址</strong>；</p> <p>而计算机物理内存的访问地址则称为<strong>实地址或物理地址</strong>；</p> <p>假设一段程序为：<code>int n = *p;</code> 编译为汇编指令后为：<code>mov eax,[ebx]</code>。将ebx地址里的数据读取出来，放到eax这个寄存器里。</p> <p>计算机寻址就是去逻辑内存（<strong>虚拟地址</strong>）里面寻找<strong>ebx</strong>这个地址的值。</p> <p>每一个进程都分配有一个固定大小的<strong>虚拟地址</strong>，这个大小和操作系统有关，比如4g。但是这个大小对应的物理内存可能很小。</p> <p>CPU在执行指令时需要先将指令的逻辑地址变换为物理地址，才能对相应的存储单元进行数据的读取或者写入。</p> <p>但逻辑地址的值并不一定会和物理内存一一对应，也就是说它可能不存在物理内存里。</p> <p>如果不存在物理内存上，就会通过分页，和做交换处理。 （==这一块的原理还不是很理解==）</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-12-21-144509.jpg" alt="img"></p> <h2 id="计算机网络"><a href="#计算机网络" class="header-anchor">#</a> 计算机网络</h2> <p>网络7层架构的由来</p> <h3 id="tcp协议-滑动窗口方案"><a href="#tcp协议-滑动窗口方案" class="header-anchor">#</a> TCP协议 - 滑动窗口方案</h3> <blockquote><p>解决的问题</p></blockquote> <p>因为网络传输的是不可靠的，为了避免丢包，发送方和接收方发送的数据需要进行相互确认的；</p> <p>但如果每次发送一个包，就得等待确认再发下一个包，就会出现效率很低、吞吐量很小的问题。</p> <p>所以需要并行发送，由此引入了滑动窗口的概念。</p> <blockquote><p>滑动窗口基本概念</p></blockquote> <p>发送方和接收方各自维护了自己的缓冲区。</p> <p>双发确定了<code>发送</code>和<code>接收ack</code>的协议；</p> <p>双发确定了同时发送的最大数量；</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-12-22-052227.png" alt="image-20191222132226882" style="zoom:33%;"> <p>⬆️图所示，窗口里始终只有7个包的大小。只有数据包经过发送确认后，窗口才可以滑动到下一位。</p> <blockquote><p>丢包的解决办法</p></blockquote> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-12-22-044751.png" alt="image-20191222124749673" style="zoom:33%;"> <h2 id="jvm"><a href="#jvm" class="header-anchor">#</a> JVM</h2> <blockquote><p>https://www.processon.com/view/5c749debe4b0f9fba6921d15?fromnew=1</p></blockquote> <h3 id="jdk、jre、jvm的区别"><a href="#jdk、jre、jvm的区别" class="header-anchor">#</a> JDK、JRE、JVM的区别</h3> <p>JDK包含JRE，JRE包含JVM。</p> <p>JDK是Java开发的工具包（Java Develop Kit）</p> <p>JRE提供了Java运行的环境（Java Runtime Enviorment)</p> <p>JVM则是一台虚拟机，他从软件的层面上，在虚拟机内部帮我们把JDK编译出来的class文件，转换为可以被当前操作系统识别的机器码。换句话说，他内部帮助我们屏蔽了一些操作系统层面上的区别，让我们的程序能够<strong>跨平台运行</strong>。</p> <p>JVM包含了3个部分：类加载器子系统、运行时数据区、执行引擎。</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-26-071216.png" alt="image-20191026151216502" style="zoom:50%;"> <h3 id="jvm内存区域"><a href="#jvm内存区域" class="header-anchor">#</a> JVM内存区域</h3> <p>运行时数据区是JVM的核心，整体的结构如下：</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-06-100726.png" alt="image-20191106180725123"></p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-26-042632.png" alt="image-20191026122631783" style="zoom:50%;"> <p><strong>Java栈</strong>（虚拟机栈）：Java会给每一个运行的线程分配一个栈，这个栈是线程私有的。</p> <p><strong>栈针</strong>：在栈里面，存放有很多栈帧，每个方法运行时都会产生一个栈帧入栈，保证每个方法有自己独立的作用域；栈帧里可以存储了java方法运行时的相关信息（局部变量表，操作数栈，动态链接，方法出口等）</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-26-063421.png" alt="image-20191026143421183" style="zoom:50%;"> <p><strong>局部变量表</strong>：保存方法内部的临时变量，比如：a=1;b=2;c=new Math()`等</p> <p><strong>操作数栈</strong>：jvm执行引擎会用到，存放一些操作符运算；</p> <p><strong>本地方法栈</strong>：和Java栈的概念类似，也是每个线程私有。但是它里面存放的都是一些native的方法信息。</p> <p>**程序计数器：**也是线程私有，作用主要是为了记录当前线程运行到哪一行代码。因为每个线程的执行都依赖于CPU的调度，是需要抢占CPU资源的，所以线程经常会因为失去CPU资源而被挂起。当线程重启获取到运行资源时，就要根据程序计数器来继续执行。</p> <p><strong>方法区</strong>：方法区里存放的是类元信息、静态变量、常量等。</p> <p>​	静态变量</p> <p>​	常量： static final的</p> <p>​	类元信息：一个类的组成信息。（类名、类修饰符、方法名等）</p> <p><strong>堆</strong>: 堆内存是线程共享的，用来存放java运行时创建出来的对象，对象的“内存地址”存放在栈局部变量表里面。</p> <p>​	堆内存结构包括：新生代、form、to、永久代；</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-26-084454.png" alt="image-20191026164453593" style="zoom:60%;"> <p>堆溢出</p> <p>栈溢出</p> <p>内存溢出与内存泄露的区别</p> <h3 id="gc垃圾回收机制"><a href="#gc垃圾回收机制" class="header-anchor">#</a> GC垃圾回收机制</h3> <p>Java垃圾回收分为minor回收和major回收，两种回收的机制不同，回收的对象主体在堆内存模型中也不一样。</p> <p>👆Java堆内存模型分为新生代和老年代：</p> <p>新生代大概占堆内存的1/3，老年代占内存的2/3。</p> <p><strong>新生代</strong>：</p> <p>由Eden和Survior Space组成。初始大小由-Xmn参数设定。</p> <p>工作机制：</p> <p>Eden区大约占新生代内存空间的8/10，java new出来的对象都会先放入到Eden区；当Eden内存不够时，jvm会启动一次minor gc。Minor GC会把那些内存中不再有引用的对象都回收（回收算法下面会讲到），而那些有用的对象会被全部移动到<code>S0 Space</code>。第二次gc的时候，会把Eden区和S0 Space里存活的对象一起移动到S1 Space。</p> <p>对象在s0 space和s1 space来回移动，每次转移时，这些对象都会更新gc的年龄标志。当gc年龄达到15时，会将该对象移动到老年代。</p> <p>如果s0和s1的内存区域放不下存活的对象时，会去老年代内存中借用内存，等下一次gc后再还给老年代。而老年代也会为了确保minor gc操作能完成，预留了一部分内存作为保留区域。这种行为成为：<code>新生代搜集担保</code>。如果预留操作无法完成，也会触发Major GC。</p> <p><strong>老年代</strong>：</p> <p>老年代区域中的对象存活率很高，一般回收的周期很长。</p> <p>Major GC因为要对所有的对象进行回收，很消耗时间，所以要尽量避免Major GC。jvm调优的过程中，很大一部分工作就是减少Full GC的次数。</p> <h3 id="gc回收判断"><a href="#gc回收判断" class="header-anchor">#</a> GC回收判断</h3> <h4 id="引用计数法"><a href="#引用计数法" class="header-anchor">#</a> <s>引用计数法</s></h4> <h4 id="可达性分析"><a href="#可达性分析" class="header-anchor">#</a> 可达性分析</h4> <h4 id="gc-roots根"><a href="#gc-roots根" class="header-anchor">#</a> GC Roots根</h4> <p>java的垃圾回收机制中，判断1个对象是否可被回收，并不是看有没有对象对其引用，而是通过<code>可达性分析</code>，看这个对象有没有到GC Root的引用链相连。</p> <p>怎么理解这段话？就是说，从GC Roots根向下找，看看能不能找到一条路，达到这个对象。如果找到了，说明是有引用链相连的。</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-26-132038.png" alt="è¿éåå¾çæè¿°" style="zoom:50%;"> <p>可以作为GC Roots根的对象：</p> <ul><li>虚拟机栈（栈帧中的本地变量表）中引用的对象；任意方法里C c = new C();</li> <li>方法区中静态变量引用的对象；static B b = new B();</li> <li>方法区中常量引用的对象； static final A a = new A();</li> <li>Native方法引用的对象；</li></ul> <h4 id="引用关系"><a href="#引用关系" class="header-anchor">#</a> 引用关系</h4> <blockquote><p>https://blog.csdn.net/luzhensmart/article/details/81431212</p></blockquote> <p>⑴强引用（StrongReference）</p> <div class="language- extra-class"><pre class="language-text"><code>A a = new A()
</code></pre></div><p>强引用是使用最普遍的引用。如果一个对象具有强引用，那垃圾回收器绝不会回收它。当内存空间不足，Java虚拟机宁愿抛出OutOfMemoryError错误，使程序异常终止，也不会靠随意回收具有强引用的对象来解决内存不足的问题。</p> <p>⑵软引用（SoftReference）</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">SoftReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> sr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoftReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果一个对象只具有软引用，则内存空间足够，垃圾回收器就不会回收它；如果内存空间不足了，就会回收这些对象的内存。只要垃圾回收器没有回收它，该对象就可以被程序使用。</p> <p>应用场景：软引用可用来搭配缓存来做，同时避免内存溢出。</p> <p>⑶弱引用（WeakReference）</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> sr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>弱引用与软引用的区别在于：只具有弱引用的对象拥有更短暂的生命周期。在垃圾回收器线程扫描它所管辖的内存区域的过程中，一旦发现了只具有弱引用的对象，不管当前内存空间足够与否，都会回收它的内存。不过，由于垃圾回收器是一个优先级很低的线程，因此不一定会很快发现那些只具有弱引用的对象。</p> <h4 id="finalize抢救"><a href="#finalize抢救" class="header-anchor">#</a> finalize抢救</h4> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-26-132358.png" alt="img"></p> <h4 id="gc-log分析"><a href="#gc-log分析" class="header-anchor">#</a> GC log分析</h4> <p>免费的GC日志图形分析工具推荐下面2个：</p> <ul><li><a href="https://juejin.im/post/%5Bhttps://github.com/chewiebug/GCViewer%5D(https://github.com/chewiebug/GCViewer)" target="_blank" rel="noopener noreferrer">GCViewer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，下载jar包直接运行</li> <li><a href="https://gceasy.io/" target="_blank" rel="noopener noreferrer">gceasy<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，web工具，上传GC日志在线使用</li></ul> <h2 id="jmm-java内存模型"><a href="#jmm-java内存模型" class="header-anchor">#</a> JMM——Java内存模型</h2> <h3 id="jmm架构规范"><a href="#jmm架构规范" class="header-anchor">#</a> JMM架构规范</h3> <p>JMM是一种架构，也是一套规范。它屏蔽了不同CPU内核的架构问题，通过实现MESI协议，解决了缓存一致性问题，同时也解决了多并发编程的可见性问题。</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-31-225946.png" alt="image-20191101065946596" style="zoom:45%;"> <p>从上图里可以看到，多线程读写主内存变量经过了一系列操作。这些操作都是原子性的，是JMM封装的原子性指令，主要就是用来解决内存同步。</p> <p><strong>读操作</strong></p> <p>read操作：从主内存中读取变量</p> <p>load操作：将读取的值复制并加载到缓存中</p> <p>use：线程使用缓存中的变量；</p> <p><strong>写操作</strong></p> <p>assign：修改缓存中变量</p> <p>store：将修改的值保存到缓存中；</p> <p>write：将缓存里面修改过的值写回主内存里；</p> <p><strong>lock和unlock操作</strong></p> <p>lock：作用于主内存的变量，作用是把一个共享变量标识为一个线程独占状态。</p> <p>unlock：作用于主内存变量，作用是把一个处于锁定状态的变量释放，然后可以被其他线程锁定</p> <p>JMM中锁的都是缓存行。</p> <p>volatile关键底层的原理就是通过上面的指令来通知线程更新缓存。</p> <h3 id="并发的三大特性-原子性、可见性、一致性"><a href="#并发的三大特性-原子性、可见性、一致性" class="header-anchor">#</a> 并发的三大特性——原子性、可见性、一致性</h3> <h4 id="有序性"><a href="#有序性" class="header-anchor">#</a> 有序性</h4> <p>在Java内存模型中，允许编译器和处理器对指令进行<strong>重排序</strong>，但是重排序过程不会影响到单线程程序的执行，却会影响到多线程并发执行的正确性。</p> <h5 id="重排序"><a href="#重排序" class="header-anchor">#</a> 重排序</h5> <blockquote><p>https://blog.csdn.net/liuguangqiang/article/details/52153096</p></blockquote> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-01-022800.png" alt="image-20191101102800175"></p> <p>虽然JMM允许编译器进行重排序，但是也需要遵循对应的规则：happens-before规则。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">1</span>）程序顺序规则：一个线程中的每个操作，happens<span class="token operator">-</span>before于该线程中的任意后续操作。
<span class="token number">2</span>）监视器锁规则：对一个锁的解锁，happens<span class="token operator">-</span>before于随后对这个锁的加锁。
<span class="token number">3</span>）<span class="token keyword">volatile</span>变量规则：对一个<span class="token keyword">volatile</span>域的写，happens<span class="token operator">-</span>before于任意后续对这个<span class="token keyword">volatile</span>域的读。
<span class="token number">4</span>）传递性：如果<span class="token class-name">A</span> happens<span class="token operator">-</span>before <span class="token class-name">B</span>，且<span class="token class-name">B</span> happens<span class="token operator">-</span>before <span class="token class-name">C</span>，那么<span class="token class-name">A</span> happens<span class="token operator">-</span>before <span class="token class-name">C</span>。
<span class="token number">5</span>）<span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>规则：如果线程<span class="token class-name">A</span>执行操作<span class="token class-name">ThreadB</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>（启动线程<span class="token class-name">B</span>），那么<span class="token class-name">A</span>线程的<span class="token class-name">ThreadB</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>操作happens<span class="token operator">-</span>before于线程<span class="token class-name">B</span>中的任意操作。
<span class="token number">6</span>）<span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>规则：如果线程<span class="token class-name">A</span>执行操作<span class="token class-name">ThreadB</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>并成功返回，那么线程<span class="token class-name">B</span>中的任意操作happens<span class="token operator">-</span>before于线程<span class="token class-name">A</span>从<span class="token class-name">ThreadB</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>操作成功返回。<span class="token number">1</span>）程序顺序规则：一个线程中的每个操作，happens<span class="token operator">-</span>before于该线程中的任意后续操作。

</code></pre></div><p>需要注意的是：</p> <p>1）如果一个操作happens-before另一个操作，那么第一个操作的执行结果将对第二个操作可见，而且第一个操作的执行顺序排在第二个操作之前。
2）两个操作之间存在happens-before关系，并不意味着Java平台的具体实现必须要按照happens-before关系指定的顺序来执行。==如果重排序之后的执行结果，与按happens-before关系来执行的结果一致，那么这种重排序并不非法。==</p> <p>所以：</p> <p>从单个线程的角度看，是可以保证有序的。但是如果观察多线程，整个程序就无法保证有序。</p> <p><code>volatile</code>关键字可以保证一定的“有序性”，因为<code>volatile</code>关键字会禁止指令重排。</p> <p><code>synchronized</code>和<code>lock</code>关键字保证同一时刻只允许一条线程操作，从而也保证了有序性。</p> <h2 id="多线程-服务知识总结-多线程"><a href="#多线程-服务知识总结-多线程" class="header-anchor">#</a> [多线程](./服务知识总结 - 多线程)</h2> <h2 id="cpu密集型-vs-io密集型"><a href="#cpu密集型-vs-io密集型" class="header-anchor">#</a> CPU密集型 vs IO密集型</h2> <p>我们可以把任务分为计算密集型和IO密集型。</p> <p>计算密集型任务的特点是要进行大量的计算，消耗CPU资源，比如计算圆周率、对视频进行高清解码等等，全靠CPU的运算能力。这种计算密集型任务虽然也可以用多任务完成，但是任务越多，花在任务切换的时间就越多，CPU执行任务的效率就越低，所以，要最高效地利用CPU，计算密集型任务同时进行的数量应当等于CPU的核心数。</p> <p>计算密集型任务由于主要消耗CPU资源，因此，代码运行效率至关重要。Python这样的脚本语言运行效率很低，完全不适合计算密集型任务。对于计算密集型任务，最好用C语言编写。</p> <p>第二种任务的类型是IO密集型，涉及到网络、磁盘IO的任务都是IO密集型任务，这类任务的特点是CPU消耗很少，任务的大部分时间都在等待IO操作完成（因为IO的速度远远低于CPU和内存的速度）。对于IO密集型任务，任务越多，CPU效率越高，但也有一个限度。常见的大部分任务都是IO密集型任务，比如Web应用。</p> <h4 id="cpu密集型（cpu-bound）"><a href="#cpu密集型（cpu-bound）" class="header-anchor">#</a> CPU密集型（CPU-bound）</h4> <p>CPU密集型也叫计算密集型，指的是系统的硬盘、内存性能相对CPU要好很多，此时，系统运作大部分的状况是CPU Loading 100%，CPU要读/写I/O(硬盘/内存)，I/O在很短的时间就可以完成，而CPU还有许多运算要处理，CPU Loading很高。</p> <p>在多重程序系统中，大部份时间用来做计算、逻辑判断等CPU动作的程序称之CPU bound。例如一个计算圆周率至小数点一千位以下的程序，在执行的过程当中绝大部份时间用在三角函数和开根号的计算，便是属于CPU bound的程序。</p> <p>CPU bound的程序一般而言CPU占用率相当高。这可能是因为任务本身不太需要访问I/O设备，也可能是因为程序是多线程实现因此屏蔽掉了等待I/O的时间。</p> <h4 id="io密集型（i-o-bound）"><a href="#io密集型（i-o-bound）" class="header-anchor">#</a> IO密集型（I/O bound）</h4> <p>IO密集型指的是系统的CPU性能相对硬盘、内存要好很多，此时，系统运作，大部分的状况是CPU在等I/O (硬盘/内存) 的读/写操作，此时CPU Loading并不高。</p> <p>I/O bound的程序一般在达到性能极限时，CPU占用率仍然较低。这可能是因为任务本身需要大量I/O操作，而pipeline做得不是很好，没有充分利用处理器能力。</p> <h1 id="文件句柄"><a href="#文件句柄" class="header-anchor">#</a> 文件句柄</h1> <p>什么是文件句柄？</p> <h1 id="注解"><a href="#注解" class="header-anchor">#</a> 注解</h1> <p>1.注解概述</p> <p>2.自定义注解</p> <p>3.使用注解实现ORM框架(对象关系映射)</p> <h1 id="设计模式"><a href="#设计模式" class="header-anchor">#</a> <a href="/设计模式.html">设计模式</a></h1> <h1 id="网络编程"><a href="#网络编程" class="header-anchor">#</a> 网络编程</h1> <blockquote><p>https://gitee.com/dendi.ke/thread-demo/tree/master/src/main/java/com/gs/example/udp</p></blockquote> <h2 id="_1-网络编程概述"><a href="#_1-网络编程概述" class="header-anchor">#</a> 1.网络编程概述</h2> <p>网络编程底层就是字节的传输</p> <h3 id="基础数据结构"><a href="#基础数据结构" class="header-anchor">#</a> <strong>基础数据结构</strong></h3> <p><code>byte</code>是网络传输中最基本的数据类型</p> <p>1byte占<code>8位</code>2进制数，大小范围是 -127 ~ 127.  (2^7 -1)</p> <p>char和byte可以相关转换</p> <p>1short = 2byte</p> <p>boolean=1byte</p> <p>int = 4byte</p> <p>long = 8byte</p> <p>float = 4byte</p> <p>double=8byte</p> <p>string字符长度可变</p> <h3 id="源码、补码、反码"><a href="#源码、补码、反码" class="header-anchor">#</a> 源码、补码、反码</h3> <blockquote><p>http://ckjava.com/2018/05/03/java-byte-0XFF/</p></blockquote> <p>在网络编程的过程中，出现了一些<code>位操作</code>，还包括了一些与、或操作，所以在这里做一些笔记。</p> <h4 id="_1-原码"><a href="#_1-原码" class="header-anchor">#</a> 1. 原码</h4> <p>原码就是符号位加上真值的绝对值, 即用第一位表示符号, 其余位表示值. 比如如果是8位二进制:</p> <div class="language- extra-class"><pre class="language-text"><code>[+1]原 = 0000 0001
[-1]原 = 1000 0001
</code></pre></div><p>第一位是符号位. 因为第一位是符号位, 所以8位二进制数的取值范围就是:</p> <div class="language- extra-class"><pre class="language-text"><code>[1111 1111 , 0111 1111]
</code></pre></div><p>即</p> <div class="language- extra-class"><pre class="language-text"><code>[-127 , 127]
</code></pre></div><h4 id="_2-反码"><a href="#_2-反码" class="header-anchor">#</a> 2. 反码</h4> <p>反码的表示方法是:</p> <p>正数的反码是其本身</p> <p>负数的反码是在其原码的基础上, 符号位不变，其余各个位取反.</p> <div class="language- extra-class"><pre class="language-text"><code>[+1] = [00000001]原 = [00000001]反
[-1] = [10000001]原 = [11111110]反
</code></pre></div><p>可见如果一个反码表示的是负数, 人脑无法直观的看出来它的数值. 通常要将其转换成原码再计算.</p> <h4 id="_3-补码"><a href="#_3-补码" class="header-anchor">#</a> 3. 补码</h4> <p>补码的表示方法是:</p> <p>正数的补码就是其本身</p> <p>负数的补码是在其原码的基础上, 符号位不变, 其余各位取反, 最后+1. (即在反码的基础上+1)</p> <p>补码转换为原码：符号位不变，数值位按位取反,末位再加1。(补码的补码就是源码)</p> <div class="language- extra-class"><pre class="language-text"><code>[+1] = [00000001]原 = [00000001]反 = [00000001]补
[-1] = [10000001]原 = [11111110]反 = [11111111]补
</code></pre></div><p>从上面可以看到, 对于正数: 原码, 反码, 补码都是一样的, 对于负数:原码, 反码, 补码都不一样.</p> <h4 id="为何要使用原码-反码和补码"><a href="#为何要使用原码-反码和补码" class="header-anchor">#</a> 为何要使用原码, 反码和补码</h4> <p>首先, 因为人脑可以知道第一位是符号位, 在计算的时候我们会根据符号位, 选择对真值区域的加减.</p> <p>但是对于计算机, 加减乘数已经是最基础的运算, 要设计的尽量简单. 计算机辨别&quot;符号位&quot;显然会让计算机的基础电路设计变得十分复杂!</p> <p>于是人们想出了将符号位也参与运算的方法. 我们知道, 根据运算法则减去一个正数等于加上一个负数, 即: 1-1 = 1 + (-1) = 0 , 所以机器可以只有加法而没有减法, 这样计算机运算的设计就更简单了.</p> <p>于是人们开始探索 将符号位参与运算, 并且只保留加法的方法. 首先来看原码:</p> <p>计算十进制的表达式: 1-1=0</p> <blockquote><p>1 - 1 = 1 + (-1) = [00000001]原 + [10000001]原 = [10000010]原 = -2</p></blockquote> <p>如果用原码表示, 让符号位也参与计算, 显然对于减法来说, 结果是不正确的.这也就是为何计算机内部不使用原码表示一个数.</p> <p>为了解决原码做减法的问题, 出现了反码:</p> <p>计算十进制的表达式: 1-1=0</p> <blockquote><p>1 - 1 = 1 + (-1) = [0000 0001]原 + [1000 0001]原= [0000 0001]反 + [1111 1110]反 = [1111 1111]反 = [1000 0000]原 = -0</p></blockquote> <p>发现用反码计算减法, 结果的真值部分是正确的. 而唯一的问题其实就出现在&quot;0&quot;这个特殊的数值上. 虽然人们理解上+0和-0是一样的, 但是0带符号是没有任何意义的. 而且会有[0000 0000]原和[1000 0000]原两个编码表示0.</p> <p>于是补码的出现, 解决了0的符号以及两个编码的问题:</p> <blockquote><p>1-1 = 1 + (-1) = [0000 0001]原 + [1000 0001]原 = [0000 0001]补 + [1111 1111]补 = [0000 0000]补=[0000 0000]原</p></blockquote> <p>这样0用[0000 0000]表示, 而以前出现问题的-0则不存在了.而且可以用[1000 0000]表示-128:</p> <blockquote><p>(-1) + (-127) = [1000 0001]原 + [1111 1111]原 = [1111 1111]补 + [1000 0001]补 = [1000 0000]补</p></blockquote> <p>-1-127的结果应该是-128, 在用补码运算的结果中, [1000 0000]补 就是-128. 但是注意因为实际上是使用以前的-0的补码来表示-128, 所以-128并没有原码和反码表示.(对-128的补码表示[1000 0000]补算出来的原码是[0000 0000]原, 这是<strong>不正确</strong>的)</p> <p>使用补码, 不仅仅修复了0的符号以及存在两个编码的问题, 而且还能够多表示一个最低数. 这就是为什么8位二进制, 使用原码或反码表示的范围为[-127, +127], 而使用补码表示的范围为[-128, 127].</p> <p>因为机器使用补码, 所以对于编程中常用到的32位int类型, 可以表示范围是: [-2^31, 2^31-1] 因为第一位表示的是符号位.而使用补码表示时又可以多保存一个最小值.</p> <h3 id="关于-与运算"><a href="#关于-与运算" class="header-anchor">#</a> 关于<code>&amp;与</code>运算</h3> <p><code>&amp;</code>运算是二进制数据的计算方式, 两个操作位都为1，结果才为1，否则结果为0.</p> <p><strong>为何要 &amp; 0xff？</strong></p> <p>其本质原因就是想保持二进制补码的一致性。</p> <p>在计算机中，数据都是以补码的方式保存的。byte有8位，而int有32位。当byte转换为int的时候，计算机会自动进行补位。</p> <p>如果是负数，高位都会补1，如果是正数，高位都会补0；</p> <p>举个例子：</p> <blockquote><p>当将-127赋值给a[0]时候，a[0]作为一个byte类型，其计算机存储的补码是10000001（8位）。</p></blockquote> <blockquote><p>将a[0] 作为int类型向控制台输出的时候，计算机做了一个补位的处理，因为int类型是32位所以补位后的补码就是11111111 11111111 11111111 10000001（32位），这个32位二进制补码表示的也是-127.</p></blockquote> <p>虽然byte-&gt;int计算机背后存储的二进制补码由10000001（8位）转化成了11111111 11111111 11111111 10000001（32位）很显然这两个补码表示的十进制数字依然是相同的。</p> <p>但是计算机的二进制不仅仅只用来表示十进制数，十进制数只是它的数值，二进制才代表了计算机真正的数据性。</p> <p>我们发现，如果byte转换为int，计算机会改变它的数据性，导致数据发生了变化。那为了保证了二进制数据性，我们需要将高位补0，低8位保持不变。所以需要&amp;0xff。</p> <p>其实如果byte是正数那么是否进行&amp;0xff结果都一样；如果是负数就一定需要&amp;0xff。</p> <p>如果b[0]为 <code>-10</code>, 那么其原码表示为</p> <blockquote><p>00000000 00000000 00000000 10001010</p></blockquote> <p>反码为</p> <blockquote><p>11111111 11111111 11111111 11110101</p></blockquote> <p>补码为 （计算机存储的数值）</p> <blockquote><p>11111111 11111111 11111111 11110110</p></blockquote> <p>这个时候如果做位运算，数据会错乱。比如右移&gt;&gt;，平白多出了很多1.</p> <p><code>0XFF</code> 表示16进制的数据255, 原码, 反码, 补码都是一样的, 其二进制数据为</p> <blockquote><p>00000000 00000000 00000000 11111111</p></blockquote> <p><code>0XFF</code> 和 <code>-10</code>进行<code>&amp;</code>运算后结果为：（补码进行运算）</p> <blockquote><p>11111111 11111111 11111111 11110110 &amp; 00000000 00000000 00000000 11111111 = 00000000 00000000 00000000 11110110</p></blockquote> <p>这样就可以保证二进制数据不变。</p> <h3 id="关于位移运算"><a href="#关于位移运算" class="header-anchor">#</a> 关于位移运算</h3> <p><strong>计算机中存的都是数的补码</strong>，所以位移运算都是对补码而言的。</p> <p><strong>&lt;&lt; 左移 低位补0</strong></p> <p><strong>&gt;&gt; 右移 高位补符号位，即：如果符号位是1 就补1，如果符号位是0 就补0</strong></p> <p><strong>&gt;&gt;&gt;无符号右移 ，高位统一补0</strong></p> <h2 id="_2-tcp与udp区别"><a href="#_2-tcp与udp区别" class="header-anchor">#</a> 2.TCP与UDP区别</h2> <p>TCP协议是==面向连接==的通讯协议；发送消息时必须建立了连接（3次握手），通讯完成时需要断开连接（4次挥手）；</p> <p>TCP是可靠的，基于字节流的传输协议。</p> <p>而UDP协议是面向无连接的通讯协议，没有sever、client之分，只需要知道对方的ip地址和端口号；</p> <p>基于数字数据报传输；</p> <p>UDP可以实现单播、广播、多播；</p> <h2 id="_3-udp发送消息"><a href="#_3-udp发送消息" class="header-anchor">#</a> 3.UDP发送消息</h2> <p>UDP没有sever、client之分，在java实现里，通过<code>DatagramSocket</code>类实现。</p> <h3 id="发送消息的步骤"><a href="#发送消息的步骤" class="header-anchor">#</a> 发送消息的步骤</h3> <div class="language-mermaid extra-class"><pre class="language-text"><code>graph TD
a[声明DatagramSocket实例]--&gt; b[声明接受消息DatagramPacket实例]
b --&gt; c[等待消息 会阻塞]
c --&gt; d[接收到消息 拿到对方ip和端口号]
d --&gt; e[回报消息]

</code></pre></div><p>代码实例：UdpProvider监听在2000端口接受消息，打印消息，回报消息；UdpSearch向Provider发送消息，打印回报消息；</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * @author keyang
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UdpProvider</span> <span class="token punctuation">{</span>
	
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;UdpProvider服务启动成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token class-name">DatagramSocket</span> datagramSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DatagramSocket</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token class-name">DatagramPacket</span> datagramPacket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DatagramPacket</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> bytes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">// This method blocks until a datagram is received</span>
		datagramSocket<span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span>datagramPacket<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> receivedBytes <span class="token operator">=</span> datagramPacket<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>receivedBytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> datagramPacket<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;UdpProvider接受到消息：&quot;</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">&quot;, 字节长度：&quot;</span> <span class="token operator">+</span> datagramPacket<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;，端口号：&quot;</span> <span class="token operator">+</span> datagramPacket<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 回写消息；</span>
		<span class="token class-name">InetAddress</span> inetAddress <span class="token operator">=</span> datagramPacket<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> port <span class="token operator">=</span> datagramPacket<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> responseMsg <span class="token operator">=</span> <span class="token string">&quot;response from udp&quot;</span><span class="token punctuation">;</span>
		<span class="token class-name">DatagramPacket</span> responsePack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DatagramPacket</span><span class="token punctuation">(</span>responseMsg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> responseMsg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
		responsePack<span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span>inetAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
		responsePack<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
		datagramSocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>responsePack<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;UdpProvider服务关闭&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * @author keyang
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UdpSearcher</span> <span class="token punctuation">{</span>
	
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;UdpSearcher服务启动成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 搜索方可以绑定任意端口</span>
		<span class="token class-name">DatagramSocket</span> datagramSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DatagramSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> sendMsg <span class="token operator">=</span> <span class="token string">&quot;你好，UDP&quot;</span><span class="token punctuation">;</span>
		<span class="token class-name">DatagramPacket</span> sendPack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DatagramPacket</span><span class="token punctuation">(</span>sendMsg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sendMsg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
		sendPack<span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getLocalHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		sendPack<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		datagramSocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>sendPack<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">// This method blocks until a datagram is received</span>
		<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token class-name">DatagramPacket</span> receiverPack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DatagramPacket</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> bytes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
		datagramSocket<span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span>receiverPack<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> receivedBytes <span class="token operator">=</span> receiverPack<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>receivedBytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> receiverPack<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;UdpSearcher接受到消息：&quot;</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">&quot;, 字节长度：&quot;</span> <span class="token operator">+</span> receiverPack<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;，端口号：&quot;</span> <span class="token operator">+</span> receiverPack<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;UdpSearcher服务关闭&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="udp广播搜索"><a href="#udp广播搜索" class="header-anchor">#</a> UDP广播搜索</h3> <p>udp最大的优点是可以广播信息，只需要向局域网对应的广播地址传输信息即可。广播地址一般根据网段地址和默认网关计算出来，大部分的广播地址是<code>255.255.255.255</code>;</p> <p><strong>代码实例</strong>：https://gitee.com/dendi.ke/thread-demo/blob/master/src/main/java/com/gs/example/udp/UdpProvider.java</p> <p>udpSearch向广播地址发送2000端口的消息，udpProvider监听2000端口的信息，接收到消息后回报给udpSearch自身的信息。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UdpProvider</span> <span class="token punctuation">{</span>
	
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;UdpProvider服务启动成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> sn <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">ProviderThread</span> providerThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProviderThread</span><span class="token punctuation">(</span>sn<span class="token punctuation">)</span><span class="token punctuation">;</span>
		providerThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		providerThread<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;UdpProvider服务关闭&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ProviderThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
		<span class="token keyword">private</span> <span class="token keyword">boolean</span> done<span class="token punctuation">;</span>
		<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> sn<span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token class-name">ProviderThread</span><span class="token punctuation">(</span><span class="token class-name">String</span> sn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>sn <span class="token operator">=</span> sn<span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>done <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">DatagramSocket</span> datagramSocket <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
				<span class="token keyword">try</span> <span class="token punctuation">{</span>
					datagramSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DatagramSocket</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
					<span class="token class-name">DatagramPacket</span> datagramPacket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DatagramPacket</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> bytes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token comment">// This method blocks until a datagram is received</span>
					datagramSocket<span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span>datagramPacket<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> receivedBytes <span class="token operator">=</span> datagramPacket<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>receivedBytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> datagramPacket<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;UdpProvider接受到消息：&quot;</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">&quot;, 字节长度：&quot;</span> <span class="token operator">+</span> datagramPacket<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;，端口号：&quot;</span> <span class="token operator">+</span> datagramPacket<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token comment">// 回写消息；</span>
					<span class="token class-name">InetAddress</span> inetAddress <span class="token operator">=</span> datagramPacket<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token class-name">MessageFactory</span><span class="token punctuation">.</span><span class="token function">parsePort</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token class-name">String</span> responseMsg <span class="token operator">=</span> <span class="token class-name">MessageFactory</span><span class="token punctuation">.</span><span class="token function">generateString</span><span class="token punctuation">(</span>sn<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token class-name">DatagramPacket</span> responsePack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DatagramPacket</span><span class="token punctuation">(</span>responseMsg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> responseMsg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
					responsePack<span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span>inetAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
					responsePack<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
					datagramSocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>responsePack<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SocketException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedEncodingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
					datagramSocket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		
		<span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
  
  <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UdpSearcher</span> <span class="token punctuation">{</span>
	
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> PORT <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">;</span>
	
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;UdpSearcher服务启动成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">SeacherThread</span> listener <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 阻塞主线程</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> sns <span class="token operator">=</span> listener<span class="token punctuation">.</span><span class="token function">getSns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;组织解散了，特工一共有：&quot;</span> <span class="token operator">+</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>sns<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		listener<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;UdpSearcher服务关闭&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
	<span class="token punctuation">}</span>
	
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">SeacherThread</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
		<span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">SeacherThread</span> seacherThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SeacherThread</span><span class="token punctuation">(</span>countDownLatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
		seacherThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 等待监听服务启动好</span>
		countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> seacherThread<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
		<span class="token comment">// 搜索方可以绑定任意端口</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;UDPSearcher sendBroadcast started.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">DatagramSocket</span> datagramSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DatagramSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> sendMsg <span class="token operator">=</span> <span class="token class-name">MessageFactory</span><span class="token punctuation">.</span><span class="token function">generatePort</span><span class="token punctuation">(</span>PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">DatagramPacket</span> sendPack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DatagramPacket</span><span class="token punctuation">(</span>sendMsg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sendMsg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
		sendPack<span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span><span class="token string">&quot;255.255.255.255&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		sendPack<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		datagramSocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>sendPack<span class="token punctuation">)</span><span class="token punctuation">;</span>
		datagramSocket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;UDPSearcher sendBroadcast end.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SeacherThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
		
		<span class="token keyword">private</span> <span class="token keyword">boolean</span> done<span class="token punctuation">;</span>
		<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> sns <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> countDownLatch<span class="token punctuation">;</span>
		<span class="token keyword">private</span> <span class="token class-name">DatagramSocket</span> datagramSocket <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		
		<span class="token keyword">public</span> <span class="token class-name">SeacherThread</span><span class="token punctuation">(</span><span class="token class-name">CountDownLatch</span> countDownLatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>countDownLatch <span class="token operator">=</span> countDownLatch<span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>done <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;UdpSearcher 监听服务启动成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
				datagramSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DatagramSocket</span><span class="token punctuation">(</span>PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// This method blocks until a datagram is received</span>
					<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
					<span class="token class-name">DatagramPacket</span> receiverPack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DatagramPacket</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> bytes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
					datagramSocket<span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span>receiverPack<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> receivedBytes <span class="token operator">=</span> receiverPack<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>receivedBytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> receiverPack<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;UdpSearcher接受到消息：&quot;</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">&quot;, 字节长度：&quot;</span> <span class="token operator">+</span> receiverPack<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;，端口号：&quot;</span> <span class="token operator">+</span> receiverPack<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token class-name">String</span> sn <span class="token operator">=</span> <span class="token class-name">MessageFactory</span><span class="token punctuation">.</span><span class="token function">parseSn</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>sn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						sns<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sn<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;UdpSearcher 监听服务停止&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
				<span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>datagramSocket <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				datagramSocket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				datagramSocket <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSns</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> sns<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
  
</code></pre></div><h2 id="_4-tcp-（transmission-control-protocol）"><a href="#_4-tcp-（transmission-control-protocol）" class="header-anchor">#</a> 4.TCP （Transmission Control Protocol）</h2> <p><strong>概念</strong>：基于连接的、可靠的传输控制协议。</p> <p><strong>应用场景</strong>：</p> <ul><li><p>消息传输、推送；</p></li> <li><p>单人语音、视频消息；</p></li> <li><p>但可以实现udp所有的功能，但是无法进行广播、多播；</p></li></ul> <h3 id="三次握手"><a href="#三次握手" class="header-anchor">#</a> 三次握手</h3> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-05-134119.png" alt="image-20191105214118317" style="zoom:30%;"> <h3 id="四次挥手"><a href="#四次挥手" class="header-anchor">#</a> 四次挥手</h3> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-05-140334.png" alt="image-20191105220334062" style="zoom:30%;"> <p>ACK：确认序号有效。</p> <p>SYN：发起一个新连接。</p> <p>FIN：释放一个连接。</p> <h3 id="tcp发送消息-（客户端与服务端）"><a href="#tcp发送消息-（客户端与服务端）" class="header-anchor">#</a> TCP发送消息 （客户端与服务端）</h3> <div class="language-mermaid extra-class"><pre class="language-text"><code>graph TD
subgraph 客户端
1[创建socket] --&gt; 2[绑定本地端口]
2 --&gt; 3[connect连接远程套接字]
3 --&gt; 31[send 发送消息]
31 --&gt; 32[receive 接收回报消息]
32 --&gt; 33[close 关闭连接]
end
subgraph 服务端
3 --&gt; 6
31 --&gt; 7
8 --&gt; 32
4[创建服务socket] --&gt; 5[绑定监听端口]
5 --&gt; 6[Accept等待消息]
6 --&gt; 7[Receive接收消息]
7 --&gt; 8[send回报消息]
end
</code></pre></div><p>TCP<strong>的连接可靠性原理</strong></p> <ul><li><p>3次握手——为什么是3次握手？</p> <p>三次握手主要是保证客户端和服务端都能确认 <strong>自己的消息能被对方接受，并且别人的消息能被对方接受</strong>；</p></li> <li><p>4次挥手——为什么是4次挥手？</p> <p>四次挥手的第二次和第三次之所以分开，其实是因为有可能服务端接收到客户端的FIN请求时，服务端数据并没有发送完，或者说不能马上发送未完成的数据。这个时候并不能保证服务端能立马回复客户端的FIN信号，因此接收方的<code>ACK消息</code>和<code>FIN消息</code>一般分开发送，所以是4次挥手。</p> <blockquote><p>2019.12.1 日补充：</p></blockquote> <p>TCP是全双工模式，意味着客户端和服务端的发送、接收是分开的，因此每个方向的连接都必须单独进行关闭。客户端发起主动关闭后，表示客户端不再有数据需要发送，但是客户端仍然可以接收服务端的消息；</p></li> <li><p>为什么TIME_WAIT状态需要经过2MSL(最大报文段生存时间)才能返回到CLOSE状态？</p> <p>答：因为Client最后的ACK可能会被丢失，Server如果没有收到ACK，将不断重复发送FIN片段。所以Client不能立即关闭，它必须确认Server接收到了该ACK。</p> <p>所以TIME_WAIT状态就是用来重发可能丢失的ACK报文。</p> <p>Client会设置一个计时器，等待2MSL的时间。如果在该时间内再次收到FIN，那么Client会重发ACK并再次等待2MSL。所谓的2MSL是两倍的MSL(Maximum Segment Lifetime)。MSL指一个片段在网络中最大的存活时间，2MSL就是一个发送和一个回复所需的最大时间。如果直到2MSL，Client都没有再次收到FIN，那么Client推断ACK已经被成功接收，则结束TCP连接。</p></li></ul> <p>TCP<strong>的传输可靠性原理</strong></p> <ul><li><p>排序、顺序发送、顺序组装</p> <p>数据包会被分片，接收方接受的顺序可能和发送顺序不同，所以接受端会对接受到的消息重新排序；</p></li> <li><p>丢弃、超时</p> <p>当数据包出现了丢包，或者连接被断开的情况，tcp会经过一定的时间进行重发；</p></li> <li><p>定时重发</p> <p>linux的判断时间30s，如果超过30s没有得到回应，发送端会认为数据丢失了，重新发送；</p></li></ul> <p><strong>使用ByteBuffer来发送各种类型的消息</strong></p> <p><strong>TCP案例</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// server</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySocketServer</span> <span class="token punctuation">{</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> PORT <span class="token operator">=</span> <span class="token number">20000</span><span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnknownHostException</span> <span class="token punctuation">{</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token class-name">ServerSocket</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">initSocketServer</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
			server<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getLocalHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>PORT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;服务端启动就绪，等待连接&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">Socket</span> client <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">ClientHandleThread</span> clientHandleThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClientHandleThread</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
				clientHandleThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initSocketServer</span><span class="token punctuation">(</span><span class="token class-name">ServerSocket</span> server<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SocketException</span> <span class="token punctuation">{</span>
			server<span class="token punctuation">.</span><span class="token function">setSoTimeout</span><span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			server<span class="token punctuation">.</span><span class="token function">setReuseAddress</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// bufferSize: 默认是8kbyte = 8*1024</span>
			server<span class="token punctuation">.</span><span class="token function">setReceiveBufferSize</span><span class="token punctuation">(</span><span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ClientHandleThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">{</span>
		<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Socket</span> client<span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token class-name">ClientHandleThread</span><span class="token punctuation">(</span><span class="token class-name">Socket</span> client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>client <span class="token operator">=</span> client<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;客户端连接成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			
			<span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
				inputStream <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token keyword">int</span> size <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">// 按顺序获取数据</span>
				<span class="token keyword">byte</span> byteMsg <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">char</span> charMsg <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getChar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">short</span> shortMsg <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getShort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">int</span> intMsg <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">long</span> longMsg <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">String</span> stringMsg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> size <span class="token operator">-</span> byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;服务端接收到：&quot;</span> <span class="token operator">+</span> byteMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;服务端接收到：&quot;</span> <span class="token operator">+</span> charMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;服务端接收到：&quot;</span> <span class="token operator">+</span> shortMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;服务端接收到：&quot;</span> <span class="token operator">+</span> intMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;服务端接收到：&quot;</span> <span class="token operator">+</span> longMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;服务端接收到：&quot;</span> <span class="token operator">+</span> stringMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
				
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>inputStream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">try</span> <span class="token punctuation">{</span>
						inputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;客户端连接断开&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// client</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySocketClient</span> <span class="token punctuation">{</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> CLIENT_PORT <span class="token operator">=</span> <span class="token number">20001</span><span class="token punctuation">;</span>
	
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
		<span class="token class-name">Socket</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token function">initClientSocket</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
		socket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getLocalHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">MySocketServer</span><span class="token punctuation">.</span>PORT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;客户端连接成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token function">sendMessage</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 释放资源</span>
			socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;客户端已退出～&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;客户端异常退出～&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">Socket</span> socket<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
		<span class="token comment">// 向服务器发送数据</span>
		<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token class-name">OutputStream</span> outputStream <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 使用ByteBuffer</span>
		<span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">byte</span> byteMsg <span class="token operator">=</span> <span class="token number">125</span><span class="token punctuation">;</span>
		<span class="token keyword">char</span> charMsg <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
		<span class="token keyword">short</span> shortMsg <span class="token operator">=</span> <span class="token number">4343</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> intMsg <span class="token operator">=</span> <span class="token number">34343243</span><span class="token punctuation">;</span>
		<span class="token keyword">long</span> longMsg <span class="token operator">=</span> <span class="token number">3234827524L</span><span class="token punctuation">;</span>
		byteBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>byteMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		byteBuffer<span class="token punctuation">.</span><span class="token function">putChar</span><span class="token punctuation">(</span>charMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		byteBuffer<span class="token punctuation">.</span><span class="token function">putShort</span><span class="token punctuation">(</span>shortMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		byteBuffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>intMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		byteBuffer<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>longMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">&quot;你好，服务端&quot;</span><span class="token punctuation">;</span>
		byteBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		outputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
		<span class="token comment">// 接收服务器返回</span>
		<span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> read <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;收到数量：&quot;</span> <span class="token operator">+</span> read<span class="token punctuation">)</span><span class="token punctuation">;</span>
		inputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		outputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initClientSocket</span><span class="token punctuation">(</span><span class="token class-name">Socket</span> socket<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
		socket<span class="token punctuation">.</span><span class="token function">setKeepAlive</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		socket<span class="token punctuation">.</span><span class="token function">setSoTimeout</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//		socket.setSendBufferSize(64*1024*1024);</span>
		socket<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getLocalHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CLIENT_PORT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_5-udp辅助tcp进行服务发现"><a href="#_5-udp辅助tcp进行服务发现" class="header-anchor">#</a> 5.UDP辅助TCP进行服务发现</h2> <p><strong>实现方案</strong>：</p> <ol><li><p>首先，服务端定义统一的服务发现端口：<code>PROVIDER_PORT</code>. 比如说是 30010。</p></li> <li><p>服务端启动server-socket服务。然后启动UDP-DatagramSocket，监听在<code>PROVIDER_PORT</code>端口上, 当监听到客户端向这个端口广播的消息，回送服务端server-socket地址；</p></li> <li><p>客户端searcher通过udp广播来搜索服务。它向当前局域网广播地址的30010端口上广播消息；</p></li> <li><p>服务端接受到广播消息后，解析消息体。如果是之前约定好的消息格式，那么就通过udp协议，向发送者回送一条消息，传送自己的tcp服务地址和端口；</p></li> <li><p>服务Searcher接收到消息后，解析出服务地址和端口，通过本地tcp客户端去进行连接，保持通信；</p></li></ol> <p><strong>代码示例</strong>：</p> <p>https://gitee.com/dendi.ke/thread-demo/tree/2795f1429ab5431f5b05c88268b41c033a58450b/src/main/java/com/gs/example/servicefind</p> <p><strong>总结</strong>：</p> <p>​	udp的DatagramSocket读取和发送都是通过DatagramPacket的对象来进行，Packet得到的数据都是byte[], 可以用ByteBuffer包装一层。</p> <p>​	socket的数据读取可以通过BufferReader来包装socket的outputStream；</p> <p>​	socket的数据发送，可以通过PrintStream来包装socket的inputStream;</p> <ul><li><h4 id="优化改进：使用多线程，来同时处理服务端的发送和信息读取"><a href="#优化改进：使用多线程，来同时处理服务端的发送和信息读取" class="header-anchor">#</a> 优化改进：使用多线程，来同时处理服务端的发送和信息读取</h4></li></ul> <p>实现方案：</p> <div class="language-mermaid extra-class"><pre class="language-text"><code>graph TD
1[服务端启动socketSever后&amp;nbsp主线程阻塞等待命令行输入] --&gt; 2[启动监听线程&amp;nbsp监听客户端连接]
2 --&gt; 3[客户端接入&amp;nbsp创建clientHandler]
subgraph ReadThread
3 --&gt; 4[clientHandler启动readThread]
4 --&gt; 4.1[读取信息并打印消息]
4.1 --&gt; 6{readline是否为null}
6 --&gt;|是|8[自己退出]
6 --&gt;|否|4.1
end
subgraph WriteThread 通过线程池来输出
3 --&gt; 5[clientHandler启动writeThread&amp;nbsp发送命令行输入消息]
5 --&gt; 7{消息是否为exit}
7 --&gt;|否|7.1[OutputStream发送消息]
7 --&gt;|是|7.2[退出]
end

</code></pre></div><p><strong>代码路径</strong>：https://gitee.com/dendi.ke/thread-demo/commit/1c8b87ab45b6ce38956d27bd3e32738023b11228</p> <h2 id="_6-bio与nio"><a href="#_6-bio与nio" class="header-anchor">#</a> 6.BIO与NIO</h2> <blockquote><p>背景：服务端影响性能的最大瓶颈在于IO的处理。单纯的使用线程并发处理，当客户端连接过多时，创建的线程数量过多，导致cpu频繁调度线程，同样会影响性能。</p></blockquote> <h3 id="网络模型：bio"><a href="#网络模型：bio" class="header-anchor">#</a> <strong>网络模型</strong>：<strong>BIO</strong></h3> <p>基于流的传输</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-10-120806.png" alt="image-20191110200805834" style="zoom:40%;"> <p>1.服务端启动监听线程，等待客户端连接；</p> <p>2.客户端发送连接请求。</p> <p>3.客户端通过创建线程的方式，处理客户端的读、写操作；</p> <p>4.服务端线程不断等待客户端的消息；</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-10-120843.png" alt="image-20191110200842632" style="zoom:50%;"> <p><strong>缺点</strong>：BIO最大的问题在于，当客户端连接过多时，服务端会建立过多的线程，导致服务器端无法承受压力而崩溃。；</p> <h3 id="网络模型：nio"><a href="#网络模型：nio" class="header-anchor">#</a> <strong>网络模型：NIO</strong></h3> <p>NIO是面向buffer的传输；</p> <p>NIO核心思想：NIO提供单线程的selector，多路复用，用来注册事件和监听事件；selector循环检测，当注册的channel状态变化时，再通知各个channel进行对应处理；</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-10-123127.png" alt="image-20191110203126332" style="zoom:50%;"> <p>1.首先在selector上注册监听客户端连接事件；</p> <p>2.客户端发送连接请求；</p> <p>3.selector通知启动线程，处理客户端连接，并且建立与客户端的连接；</p> <p>4.同时客户端与服务端连接的socket向selector注册监听“socket可读”事件</p> <p>5.客户端发送数据，selector通知事件，启动线程（比如是线程池），处理客户端的读写操作，响应客户端的请求；</p> <p>6.最后，这个线程也会向selector注册“sokcet可写”事件；</p> <p><strong>NIO的优点</strong>：所有的阻塞操作都是集中在selector上。客户端与服务端的处理线程都几乎是非阻塞的，不需要去等待连接，等待读取。大大减少了服务端的线程数量；</p> <h3 id="nio的相关概念"><a href="#nio的相关概念" class="header-anchor">#</a> NIO的相关概念</h3> <h4 id="selector"><a href="#selector" class="header-anchor">#</a> Selector</h4> <blockquote><p>Selector是Java NIO核心组件中的一个，用于检查一个或多个NIO Channel的状态是否处于可读、可写；</p></blockquote> <p><strong>SelectionKey</strong></p> <ul><li><p>Connect, 连接事件(TCP 连接), 对应于SelectionKey.OP_CONNECT</p></li> <li><p>Accept, 确认事件, 对应于SelectionKey.OP_ACCEPT</p></li> <li><p>Read, 读事件, 对应于SelectionKey.OP_READ。</p> <ul><li><p>当一个<code>channel</code><strong>准备</strong>好可以被读取(比如socket已经读到了新的字节，其Read Buffer有尚未被应用读取的数据，可通知应用程序从读取缓冲区进行读取）；</p></li> <li><p>已经到达数据流的结尾</p></li> <li><p>远程另一端已经关闭或者发生错误时，都会将该事件加入到该<code>key</code>的<code>ready set</code>中，并将该<code>key</code>加入到<code>selected-key set</code>中。</p></li></ul></li> <li><p>Write, 写事件, 对应于SelectionKey.OP_WRITE。</p> <ul><li>当一个<code>channel</code> <strong>准备</strong>好进行写入操作（比如原先socket写入缓冲已满，现在已经发送了部分数据，写入缓冲腾出了一些空间，就会通知应用程序进行写入）</li> <li>远程另一端已经关闭或者发生错误时，都会将该事件加入到该<code>key</code>的<code>ready set</code>中，并将该<code>key</code>加入到<code>selected-key set</code>中。</li></ul></li></ul> <p><strong>相关操作</strong></p> <p>open： 创建一个selector，selector由系统层面的方法调用；</p> <p>wakeup: 可以从非select调用的线程去唤醒阻塞在select调用上的线程</p> <p>select：当注册的事件到达时，返回。否则，会一直阻塞；</p> <h4 id="selectionkey"><a href="#selectionkey" class="header-anchor">#</a> SelectionKey</h4> <p><code>interest集合</code>: key关联的channel所选择的感兴趣的事件集合。可以通过SelectionKey读写interest集合。</p> <p><code>ready集合</code>：通道已经准备就绪的操作的集合。在一次选择(Selection)之后，你会首先访问这个ready set。</p> <h4 id="channel"><a href="#channel" class="header-anchor">#</a> Channel</h4> <p>ServerSocketChannel: 服务端socket channel。一般只注册Accept事件；</p> <p>SocketChannel：客户端socket channel。一般连接后，注册connect事件。</p> <p><strong>注意</strong>：</p> <p>注册事件只是告诉<code>selector</code>在检测到各种事件准备好可以执行时告诉应用，应用可以执行相应的事件，但是注册感兴趣的事件<strong>并不是必须的</strong>！！没有注册事件依然可以进行读取、写入操作。</p> <p>比如读取操作，如果不注册<code>OP_READ</code>事件，应用程序依然可以随时尝试从<code>channel</code>中读取数据，但是并不能保证读取成功，因为可能<code>socket</code>读取缓冲区中可能并不存在数据。但是如果注册了<code>OP_READ</code>事件，在<code>selector</code>检测到该事件准备好了再去读取，则可以最大程度上的保证可以读到数据。</p> <p>写入也是一样的道理，不注册<code>OP_WRITE</code>应用程序也可以随时进行写入，只是可能因为缓冲区满而写入失败。注册<code>OP_WRITE</code>事件，在<code>selector</code>检测到该事件时再进行写入，可以最大程度上保证写入成功。</p> <h4 id="buffer"><a href="#buffer" class="header-anchor">#</a> Buffer</h4> <blockquote><p>Buffer是唯一操作channel的方式，是用户数据处理的基础单元。</p> <p>http://blog.ztgreat.cn/article/43</p></blockquote> <p>4个关键属性：</p> <ul><li>capacity 容量</li> <li>position 当前位置</li> <li>limit 限制</li> <li>mark 标记位置</li></ul> <p>读写切换时：position会重置为0，limit会切换为写的位置；</p> <p>读模式：每次get后，position都会后移一位；</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-13-131220.png" alt="image-20191113211219895" style="zoom:50%;"> <p>写模式：</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-13-131233.png" alt="image-20191113211233163" style="zoom:50%;"> <p>flip操作：flip会进行翻转，把limit设置为当前position位置，把position变为0，可以从初始位置开始进行读操作；</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-13-131422.png" alt="image-20191113211421721" style="zoom:50%;"> <p>reset操作：可以用mark方法可以当前标记位置，reset后回到标记位置；</p> <h4 id="zero-copy"><a href="#zero-copy" class="header-anchor">#</a> Zero-Copy</h4> <blockquote><p>https://mp.weixin.qq.com/s?__biz=MzU0MzQ5MDA0Mw==&amp;mid=2247483913&amp;idx=1&amp;sn=2da53737b8e8908cf3efdae9621c9698&amp;chksm=fb0be89dcc7c618b0d5a1ba8ac654295454cfc2fa81fbae5a6de49bf0a91a305ca707e9864fc&amp;scene=21#wechat_redirect</p></blockquote> <p>概述：</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-11-232613.png" alt="image-20191112072612350" style="zoom:40%;"> <p>传统的IO读写中，系统读写文件时，经历了以下步骤：</p> <p>1.从IO设备拷贝到kernel space。</p> <p>2.从kernel space copy 到 user space</p> <p>3.接下来，如果系统需要对文件进行write操作，系统会再把user space的内容拷贝到kernel space中，最后再往对方的sock发送这些数据。</p> <p>整个过程总共发生了四次拷贝。并且发生了四次的用户态和内核态切换。</p> <p>但是我们可以发现一个问题</p> <p><em>为什么IO需要将数据从kernel（系统内核态）拷贝到user（用户态），再拷贝回kernel态？</em></p> <p>带着这个问题，我们可以提出以下改进</p> <p>改进1：可以很容易的发现，2，3的copy操作实际上是浪费资源，可以省略。</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-11-233840.png" alt="image-20191112073839594" style="zoom:40%;"> <ol><li>首先（通过DMA）将数据从磁盘读取到kernel buffer中；</li> <li>然后将kernel buffer拷贝到socket buffer中；</li> <li>最后将socket buffer中的数据copy到网卡设备（protocol engine）中发送</li></ol> <p>但这并不是<code>zero-copy</code>，因为第2步的copy其实也是没有必要的。</p> <p>改进2：</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-11-234408.png" alt="image-20191112074407565" style="zoom:40%;"> <ol><li>将文件拷贝到kernel buffer中；</li> <li>向socket buffer中追加当前要发生的数据在kernel buffer中的位置和偏移量；</li> <li>根据socket buffer中的位置和偏移量直接将kernel buffer的数据copy到网卡设备（protocol engine）中；</li></ol> <p>实际上，上面的操作就是真正的NIO原理</p> <h3 id="nio的相关操作"><a href="#nio的相关操作" class="header-anchor">#</a> NIO的相关操作</h3> <h4 id="_1-读取socketchannel"><a href="#_1-读取socketchannel" class="header-anchor">#</a> 1.读取SocketChannel</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ByteBuffer</span> buf <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> bytesRead <span class="token operator">=</span> socketChannel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol><li>分配buffer，用来保存socketchannel读取到的数据</li> <li>调用read方法，将 <code>SocketChannel</code>的数据读取到 <code>Buffer</code>。返回的<code>int</code>值告诉我们有多少字节写到了Buffer里，如果返回了-1，表示已经连接已关闭，到了数据流结尾</li></ol> <h4 id="_2-写入socketchannel"><a href="#_2-写入socketchannel" class="header-anchor">#</a> 2. 写入SocketChannel</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> newData <span class="token operator">=</span> <span class="token string">&quot;New String to write to file...&quot;</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ByteBuffer</span> buf <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
buf<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
buf<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>newData<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

buf<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">while</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    channel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注意 <code>SocketChannel.write()</code> 方法是在循环里被调用的。由于无法保证每次有多少数据被读取到了SocketChannel里，因此需要重复调用write()方法直到<code>Buffer</code>里不再有字节输出。</p> <p><strong>踩坑记录</strong>1：</p> <p>初学的时候，经常傻乎乎的在建立连接后马上注册Write等事件，期待等写事件通知到再去发送数据。实际上对这些特别不理解；</p> <p>写操作的就绪条件为底层缓冲区有空闲空间，而写缓冲区绝大部分时间都是有空闲空间的，所以当你注册写事件后，写操作一直是就绪的，选择处理线程全占用整个CPU资源。</p> <p>最好的方法是，当你确实有数据要写时，再注册写操作，并在写完以后马上取消注册。</p> <p>或者<strong>不去注册写事件</strong>，有要写的数据则直接写数据至<code>Channel</code>即可，写入失败则表示<code>Channel</code>暂时没有准备好被写入，此时应用可以向<code>Channel</code>注册写事件，让<code>Channel</code>在准备好接收写事件时告诉应用，但是一旦应用写完所有的数据，则一般会取消注册的写事件，因为如果数据写完了，但是没有取消注册的写事件，<code>Selector.select</code>方法可能会经常因为有写事件准备完毕而返回，但是应用却无数据需要写。</p> <p><strong>踩坑记录</strong>2：</p> <p>起初对<code>OP_CONNECT</code>事件还有<code>finishConnect</code>不理解，<code>OP_CONNECT</code>事件何时触发，特别是为什么要在<code>key.isConnectable()</code>分支里调用<code>finishConnect</code>方法后才能进行读写操作。</p> <p>首先，在<code>non-blocking</code>模式下调用<code>socketChannel.connect(new InetSocketAddress(&quot;127.0.0.1&quot;,8080));</code>连接远程主机，如果连接能立即建立就像本地连接一样，该方法会立即返回<code>true</code>，否则该方法会立即返回<code>false</code>,然后系统底层进行三次握手建立连接。连接有两种结果，一种是成功连接，第二种是异常，但是<code>connect</code>方法已经返回，无法通过该方法的返回值或者是异常来通知用户程序建立连接的情况，所以由<code>OP_CONNECT</code>事件和<code>finishConnect</code>方法来通知用户程序。不管系统底层三次连接是否成功，<code>selector</code>都会被唤醒继而触发<code>OP_CONNECT</code>事件，如果握手成功，并且该连接未被其他线程关闭，<code>finishConnect</code>会返回<code>true</code>，然后就可以顺利的进行<code>channle</code>读写。如果网络故障，或者远程主机故障，握手不成功，用户程序可以通过<code>finishConnect</code>方法获得底层的异常通知，进而处理异常。</p> <p><strong>踩坑记录3：处理OP_WRITE</strong>
OP_WRITE处理不当很容易导致CPU 100%
<strong>OP_WRITE触发条件</strong>：
前提: interest了OP_WRITE
<strong>触发条件</strong>:</p> <ul><li><p>socket发送缓冲区可写</p></li> <li><p>远端关闭</p></li> <li><p>有错误发生</p></li></ul> <p><strong>正确的处理方式</strong>：</p> <ul><li>仅在已经连接的channel上注册</li> <li>仅在有数据可写的时候才注册</li> <li>触发之后立即取消注册，否则会继续触发导致循环</li> <li>处理完成后视情况决定是否继续注册，
如果没有完全写入，继续注册
如果全部写入，无需注册</li></ul> <p>eg: 有写数据需求时订阅OP_WRITE事件,数据发送完成取消订阅.</p> <p><a href="https://tech.fenxiangz.com/topic/77/nio-%E5%90%84%E7%A7%8D%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E7%82%B9" target="_blank" rel="noopener noreferrer">https://tech.fenxiangz.com/topic/77/nio-%E5%90%84%E7%A7%8D%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E7%82%B9<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="_7-nio客户端与服务端"><a href="#_7-nio客户端与服务端" class="header-anchor">#</a> 7.NIO客户端与服务端</h2> <h3 id="nio实现cs模型的流程"><a href="#nio实现cs模型的流程" class="header-anchor">#</a> NIO实现CS模型的流程</h3> <h4 id="服务端"><a href="#服务端" class="header-anchor">#</a> 服务端</h4> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-19-221145.png" alt="image-20191120061144474" style="zoom:50%;"> <h4 id="客户端"><a href="#客户端" class="header-anchor">#</a> 客户端</h4> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-19-221910.png" alt="image-20191120061909011" style="zoom:50%;"> <h4 id="代码实例"><a href="#代码实例" class="header-anchor">#</a> 代码实例</h4> <p>监听客户端的到达；</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Selector</span> selector <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ServerSocketChannel</span> serverChannel <span class="token operator">=</span> <span class="token class-name">ServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
serverChannel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
serverChannel<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getLocalHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 监听</span>
serverChannel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span>OP_ACCEPT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;服务端地址:&quot;</span> <span class="token operator">+</span> serverChannel<span class="token punctuation">.</span><span class="token function">getLocalAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> length <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> selectionKeys <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> selectionKeyIterator <span class="token operator">=</span> selectionKeys<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>selectionKeyIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">SelectionKey</span> selectionKey <span class="token operator">=</span> selectionKeyIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 移除key</span>
      selectionKeyIterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>selectionKey<span class="token punctuation">.</span><span class="token function">isAcceptable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServerSocketChannel</span> serverSocketChannel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServerSocketChannel</span><span class="token punctuation">)</span> selectionKey<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 一定可以拿到客户端</span>
        <span class="token class-name">SocketChannel</span> clientChannel <span class="token operator">=</span> serverSocketChannel<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        clientChannel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">ClientHandler</span><span class="token punctuation">(</span>clientChannel<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接受客户端数据：</p> <div class="language-java extra-class"><pre class="language-java"><code>readSelector <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				socketChannel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>readSelector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span>OP_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">int</span> readCount <span class="token operator">=</span> readSelector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>readCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> selectionKeys <span class="token operator">=</span> readSelector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> selectionKeyIterator <span class="token operator">=</span> selectionKeys<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">while</span> <span class="token punctuation">(</span>selectionKeyIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token class-name">SelectionKey</span> selectionKey <span class="token operator">=</span> selectionKeyIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token comment">// 移除key</span>
							selectionKeyIterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token keyword">if</span> <span class="token punctuation">(</span>selectionKey<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
								<span class="token class-name">SocketChannel</span> socketChannel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span><span class="token punctuation">)</span> selectionKey<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
								<span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
								socketChannel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
								<span class="token class-name">String</span> receiveData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//							String receiveData= Charset.forName(&quot;UTF-8&quot;).decode(byteBuffer).toString();</span>
								<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;服务端接收到数据：&quot;</span> <span class="token operator">+</span> receiveData<span class="token punctuation">)</span><span class="token punctuation">;</span>
								<span class="token comment">// 回送客户端数据</span>
                writeBuffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
								writeBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;服务端接收到数据：&quot;</span> <span class="token operator">+</span> receiveData<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
								writeBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
								<span class="token keyword">while</span><span class="token punctuation">(</span>writeBuffer<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
									<span class="token keyword">int</span> len <span class="token operator">=</span> socketChannel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>writeBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
									<span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
										<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;写入数据:&quot;</span> <span class="token operator">+</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
									<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
										<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;客户端已无法发送数据！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
										<span class="token keyword">break</span><span class="token punctuation">;</span>
									<span class="token punctuation">}</span>
								<span class="token punctuation">}</span>
							<span class="token punctuation">}</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
</code></pre></div><p>客户端监听连接成功：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Selector</span> selector <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">SocketChannel</span> socketChannel <span class="token operator">=</span> <span class="token class-name">SocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			socketChannel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">boolean</span> connected <span class="token operator">=</span> socketChannel<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getLocalHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>connected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				socketChannel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span>OP_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> req <span class="token operator">=</span> <span class="token string">&quot;你好，nio服务端342&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">//为字节缓冲区分配指定字节大小的容量</span>
				<span class="token class-name">ByteBuffer</span> writeBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">//将内容写入缓冲区</span>
				writeBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">//反转缓冲区</span>
				writeBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">//输出打印缓冲区的可读大小</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>writeBuffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">//将内容写入管道中</span>
				socketChannel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>writeBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>writeBuffer<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Send 2 server succeed.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				socketChannel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span>OP_CONNECT<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;客户端启动成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;服务器信息：&quot;</span> <span class="token operator">+</span> socketChannel<span class="token punctuation">.</span><span class="token function">getRemoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 拿到客户端数据</span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">int</span> length <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> selectionKeys <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> selectionKeyIterator <span class="token operator">=</span> selectionKeys<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">while</span> <span class="token punctuation">(</span>selectionKeyIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token class-name">SelectionKey</span> selectionKey <span class="token operator">=</span> selectionKeyIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						selectionKeyIterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>selectionKey<span class="token punctuation">.</span><span class="token function">isConnectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token class-name">SocketChannel</span> channel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span><span class="token punctuation">)</span> selectionKey<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">finishConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
								channel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span>OP_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>
								<span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
								byteBuffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
								byteBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;你好，nio服务端23432&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
								byteBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
								<span class="token keyword">while</span> <span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
									<span class="token keyword">int</span> len <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
									<span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
										<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;写入数据:&quot;</span> <span class="token operator">+</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
									<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
										<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;客户端已无法发送数据！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
										<span class="token keyword">break</span><span class="token punctuation">;</span>
									<span class="token punctuation">}</span>
								<span class="token punctuation">}</span>
							<span class="token punctuation">}</span>
						<span class="token punctuation">}</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>selectionKey<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							selectionKey<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span>selectionKey<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token operator">~</span><span class="token class-name">SelectionKey</span><span class="token punctuation">.</span>OP_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token class-name">SocketChannel</span> channel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span><span class="token punctuation">)</span> selectionKey<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
							buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;客户端接收到返回数据[&quot;</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
</code></pre></div><h3 id="消息到达重复触发事件"><a href="#消息到达重复触发事件" class="header-anchor">#</a> 消息到达重复触发事件</h3> <p>selecotr监听到read事件后，需要取消继续对keyOps的监听。</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-19-232613.png" alt="image-20191120072613024"></p> <p>否则，selector下次select的时候，依然能够查询到有selection-key</p> <h2 id="_8-粘包与拆包"><a href="#_8-粘包与拆包" class="header-anchor">#</a> 8.粘包与拆包</h2> <h3 id="_8-1基本概念"><a href="#_8-1基本概念" class="header-anchor">#</a> 8.1基本概念</h3> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-16-131559.jpg" alt="img" style="zoom:67%;"> <p>tcp是面向连接、依靠字节流传输的协议。</p> <p>tcp本身在传输过程中，是有序的且可靠的。</p> <p>tcp在传输过程中不存在粘包或拆包的说法。粘包和拆分主要是站在上层（应用场景、业务逻辑）的角度来说的。</p> <p>举个例子：</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-16-131714.jpg" alt="img" style="zoom:50%;"> <p>客户端向服务端传输2个数据包，正常情况下，服务端接受到的也是2个数据包。</p> <p>但是客户端在发送过程中，由于缓存的原因，两个数据包同时到达。那么服务端接受的情况就变成了：</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-16-131849.jpg" alt="img" style="zoom:53%;"> <p>还有一种情况，由于服务端的接收缓存比较小，虽然客户端发送了1个数据包，但是服务端必须通过两次来接收，这样就必须拆包：</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-16-132611.png" alt="image-20191116212610271" style="zoom:25%;"> <h3 id="_8-2解决方案"><a href="#_8-2解决方案" class="header-anchor">#</a> 8.2解决方案</h3> <p>由于粘包和拆包的现象产生，客户端与服务端的数据传输会出现以下几个问题：</p> <p>a.传输字符串时，字符串自动拼接在一起，造成解析错误；（粘包问题）</p> <p>b.传递长字符串时，自动拆分成了多个小的字符串，甚至还会自动丢弃中间的字符串。（拆包问题）</p> <p>一般解决方案有以下几种：</p> <p>a.在传输过程中标记开始和结束位置，比如通过换行符来判断是否结束；</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-20-131030.png" alt="image-20191120211029655" style="zoom:15%;"> <p>b.数据传输时，使用固定的头部，在消息头中指明消息的长度；</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-20-131100.png" alt="image-20191120211100306" style="zoom:15%;"> <p>c.混合模式：通过固定头部信息，并且加上数据描述，最后对数据进行加密；</p> <h3 id="_8-3代码实例"><a href="#_8-3代码实例" class="header-anchor">#</a> 8.3代码实例</h3> <p>首先来看一下异常情况下，我们的消息是怎么样的一个形式。</p> <blockquote><p>粘包情况</p></blockquote> <p>我们先连续发送多个消息</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-20-125648.png" alt="image-20191120205648416" style="zoom:50%;"> <p>结果控制台打印的消息为：服务端接收到数据:test1test2test3test4</p> <blockquote><p><strong>拆包情况</strong></p></blockquote> <p>我们将读取的buffer设置为4，然后看服务端接收的情况。</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-20-125855.png" alt="image-20191120205854860" style="zoom:50%;"> <p>可以看出，服务端接受到的数据时拆分开的，导致数据错乱了。</p> <blockquote><p>方案介绍</p></blockquote> <p>那么如何对数据进行封包和拆包呢？</p> <p><strong>1</strong>.首先定义一个packet的规则</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-12-17-023554.png" alt="image-20191217103552727" style="zoom:33%;"> <p>packet分为2种情况。如果是首包，我们会用前面4位来存储这次packet的大小信息，后面所有的都用来存放包体信息，直到消息发送完成；</p> <p><strong>2</strong>.定义packet类。这里先定义<code>StringSendPacket</code>和<code>StringReceivePacket</code>的结构。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StringReceivePacket</span> <span class="token keyword">extends</span> <span class="token class-name">ReceivePacket</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
	
	<span class="token keyword">private</span> <span class="token class-name">String</span> string<span class="token punctuation">;</span>
	
	<span class="token comment">/**
	 * 构造方法
	 * @param len 接收的packet长度，根据packet的头部信息获取
	 */</span>
	<span class="token keyword">public</span> <span class="token class-name">StringReceivePacket</span><span class="token punctuation">(</span><span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> len<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">protected</span> <span class="token class-name">ByteArrayOutputStream</span> <span class="token function">createStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">closeStream</span><span class="token punctuation">(</span><span class="token class-name">ByteArrayOutputStream</span> stream<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
		<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">closeStream</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>string <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>stream<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> string<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 字符串发送Packet</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StringSendPacket</span> <span class="token keyword">extends</span> <span class="token class-name">SendPacket</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
	<span class="token comment">// 发送的字符串 - 字节数组</span>
	<span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer<span class="token punctuation">;</span>
	
	<span class="token keyword">public</span> <span class="token class-name">StringSendPacket</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>buffer <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> buffer<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
	
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">protected</span> <span class="token class-name">ByteArrayInputStream</span> <span class="token function">createStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>3</strong>.实现服务端接收packet、以及客户端发送packet的逻辑</p> <p>类图</p> <p>https://www.processon.com/diagraming/5dcbff07e4b0754822a4b47b</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-12-17-084541.png" alt="image-20191217164541349" style="zoom:50%;"> <p>发送逻辑</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-12-17-040612.png" alt="image-20191217120611730"></p> <p>先将string转化为InputStream，通过ReadableByteChannel传输到buffer，最后通过socketChannel写出去。</p> <p>映射到代码上面：</p> <p>i. TCPClient发送一个字符串</p> <p>ii. 通过SendPacket构造方法包装成packet，然后调用senderDispatcher来发送</p> <p>iii. 第三步比较复杂，dispatcher的<code>send(SendPacket packet)</code>方法实际上是将packet加入到发送队列里面，</p> <p>然后启动发送线程。发送线程不断的取出packet，并且判断packet是否为null，存入临时变量中，等待被socketChannel读取。</p> <p>然后调用sender的sendAsync方法。</p> <p>iv.  sender的sendAsync方法其实就是向socketChannel注册一个socket writeable事件。这个过程通过IoProvider的registOutput方法来实现。当事件触发后，执行回调BaseHandleOutputCallback方法。</p> <p>vi. 在callback方法里，通过<code>IOArgsProcessor</code>的<code>provideIoArgs</code>来得到<code>ioargs</code>实例。 <code>provideIoArgs</code> 的实现方法世纪上也是在在<code>AsyncSendDispatcher</code>里。它实际上，是拿到发送线程取出的packet，将packet读取到ioArgs的buffer里，然后将ioArgs的buffer写入到socketChannel里，完成发送流程。</p> <p>接收逻辑</p> <p>和发送逻辑相反</p> <p><strong>代码地址</strong></p> <blockquote><p>https://gitee.com/dendi.ke/thread-demo/tree/master/socket-packet</p></blockquote> <h2 id="_9-分片数据发送"><a href="#_9-分片数据发送" class="header-anchor">#</a> 9.分片数据发送</h2> <p>之前发送数据时，无论是字符串或者是文件，都是先读取到内存中，以byte[]数组的形式存储。当需要发送时，再将byte[]写入ByteBuffer里，交给channel发送出去。</p> <p>但是如果发送的是一个比较大的文件，读取到内存中去就会占用太多内存，很可能造成内存溢出。所以需要采取文件分片发送的方案，将一个文件分成多个数据包分开发送。</p> <h3 id="_9-1-基本方案"><a href="#_9-1-基本方案" class="header-anchor">#</a> 9.1 基本方案</h3> <blockquote><p>定义基本Frame类型</p></blockquote> <p>和Packet类似，我们也定义了Frame的规则。</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-12-17-122721.png" alt="image-20191217202720359" style="zoom:33%;"> <blockquote><p>首帧逻辑</p></blockquote> <p>但是和Packet不同的是，frame的发送分为<code>首帧</code>和<code>body帧</code>。</p> <p>首帧帧头里的信息包含：</p> <p>整个需要发送文件的大小，发送类型，唯一标识，标准，其他信息。</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-12-17-121947.png" alt="image-20191217201947178" style="zoom:33%;"> <p>首帧的帧体里存放的信息其实就是packet的信息，这里我们修改了一下packet的规则。</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-12-17-122958.png" alt="image-20191217202958133" style="zoom:33%;"> <p>如果是首包的话，我们用前面5位用来记录包体的大小，第6位记录包的类型，是文件还是字符串或者其他的。从第7位开始都是实际的包体信息。</p> <p>所以头帧的帧体大小是一般是固定的6位，只需要告诉一下发送的packet的整个大小和类型即可。</p> <blockquote><p>帧逻辑</p></blockquote> <h2 id="_10-socket并发"><a href="#_10-socket并发" class="header-anchor">#</a> 10.Socket并发</h2> <h3 id="客户端服务器连接数量限制"><a href="#客户端服务器连接数量限制" class="header-anchor">#</a> 客户端服务器连接数量限制</h3> <p>49152 ~ 65535 端口号是不允许被占用的，是动态分配的。</p> <p>系统单进程“<strong><a href="#%E6%96%87%E4%BB%B6%E5%8F%A5%E6%9F%84">文件句柄</a></strong>”最大限制</p> <h3 id=""><a href="#" class="header-anchor">#</a></h3> <h2 id="http"><a href="#http" class="header-anchor">#</a> HTTP</h2> <p>http是如果识别请求的？</p> <p>http是如果接受数据包的？</p> <p>http是如何判断请求数据接收到底的？</p> <p>1.x和2.x的区别</p> <h1 id="netty框架-游戏服务器"><a href="#netty框架-游戏服务器" class="header-anchor">#</a> Netty框架 (游戏服务器)</h1> <p>Nettty服务端</p> <p>Netty客户端</p> <p>长连接与短连接区别</p> <p>消息序列化</p> <h2 id="数据库"><a href="#数据库" class="header-anchor">#</a> 数据库</h2> <p>mysql安装</p> <blockquote><p>https://www.jianshu.com/p/4fc53d7d7620</p></blockquote> <p>mysql概述</p> <p>mysql优化方案</p> <p>数据库三大范式</p> <p>分库分表</p> <p>水平分割取模算法</p> <p>索引概述</p> <p>索引底层实现原理</p> <p>普通索引&amp;唯一索引区别</p> <p>sql语句优化</p> <p>mysql高可用</p> <p>mysql主从复制原理</p> <p>mysql读写分离概述</p> <p>mycat读写分离</p> <h2 id="事物"><a href="#事物" class="header-anchor">#</a> 事物</h2> <p>事物概述</p> <p>事物底层原理</p> <p>事物传播行为</p> <p>分布式事物</p> <h1 id="redis"><a href="#redis" class="header-anchor">#</a> Redis</h1> <h2 id="redis-desktop-manager安装"><a href="#redis-desktop-manager安装" class="header-anchor">#</a> Redis-Desktop-Manager安装</h2> <blockquote><p>https://github.com/qishibo/AnotherRedisDesktopManager</p></blockquote> <h3 id="redis5种基本类型"><a href="#redis5种基本类型" class="header-anchor">#</a> Redis5种基本类型</h3> <blockquote><p>String, Hash, List, Set,  ZSet</p></blockquote> <h4 id="string"><a href="#string" class="header-anchor">#</a> String</h4> <p>重要用法1：<strong><code>Expire Key</code></strong></p> <blockquote><p><strong>应用场景</strong></p></blockquote> <p>1、限时的优惠活动信息</p> <p>2、网站数据缓存（对于一些需要定时更新的数据，例如：积分排行榜）</p> <p>3、手机验证码</p> <p>4、限制网站访客访问频率（例如：1分钟最多访问10次）</p> <p>重要用法2：**<code>SETNX key value</code> **</p> <blockquote><p><strong>应用场景</strong></p></blockquote> <p>1、分布式锁</p> <p>重要用法3：<strong><code>INCR KEY_Name</code></strong></p> <blockquote><p><strong>应用场景</strong></p></blockquote> <p>1.计数器</p> <p>假如，在某种场景下有3个客户端同时读取了mynum的值（值为2），然后对其同时进行了加1的操作，那么，最后mynum的值一定是5。</p> <p><strong>Key的命名建议</strong></p> <blockquote><p>redis单个key 存入512M大小</p></blockquote> <p>1.key不要太长，尽量不要超过1024字节，这不仅消耗内存，而且会降低查找的效率；</p> <p>2.key也不要太短，太短的话，key的可读性会降低；</p> <p>3.在一个项目中，key最好使用统一的命名模式，例如user:123:password;</p> <p>4.key名称区分大小写</p> <h4 id="hash"><a href="#hash" class="header-anchor">#</a> Hash</h4> <blockquote><p>应用场景</p></blockquote> <p>1、存储一个对象</p> <p>hash存储对象和string存储的区别</p> <ul><li><p>stirng存储主要有2种方案：一种是用对象的id作为key，用对象的json序列化作为value。还有一种是用对象的id+属性名作为key，用对象属性值作为value。</p> <p>第一种的缺点是每次修改属性不方便，必须将对象反序列化出来再插入进去。而且需要考虑并发问题；</p> <p>第二种确定是key太多，造成存储空间过大；</p></li> <li><p>Redis提供的Hash很好的解决了这个问题，Redis的Hash实际是内部存储的Value为一个HashMap，并提供了直接存取这个Map成员的接口</p></li></ul> <h4 id="list"><a href="#list" class="header-anchor">#</a> List</h4> <blockquote><p>应用场景</p></blockquote> <p>1、实现队列 lpush rpop</p> <p>2、实现堆栈 lpush lpop</p> <p>3、实现分页 lrange start stop</p> <p>​		大数据量的分页</p> <p>4、对大数据进行删减、显示</p> <p>​		如：关注列表、粉丝列表、留言评价等;</p> <p>5、任务队列</p> <h4 id="set"><a href="#set" class="header-anchor">#</a> Set</h4> <blockquote><p>应用场景</p></blockquote> <p>1、常用于对两个集合间的数据做交集、并集、差集运算：</p> <p>​	比如微信查看2个人的共同好友；</p> <p>​	比如微博查看共同关注的人；</p> <p>​	再高级一点，推荐你关注的人关注了谁；</p> <p>2、利用唯一性，统计网站的访问IP；</p> <h4 id="zset"><a href="#zset" class="header-anchor">#</a> ZSet</h4> <blockquote><p>应用场景</p></blockquote> <p>1、排行榜，如查看排名前10的人，或者查看所有人的排名，或者查看某一个分数段的人；</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;       全部玩家排行榜                    &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ZSetOperations</span><span class="token punctuation">.</span><span class="token class-name">TypedTuple</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> allPlayerList <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reverseRangeWithScores</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ZSetOperations</span><span class="token punctuation">.</span><span class="token class-name">TypedTuple</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> allPlayerList<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">ZSetOperations</span><span class="token punctuation">.</span><span class="token class-name">TypedTuple</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> item <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;玩家ID：&quot;</span><span class="token operator">+</span>item<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;， 玩家得分:&quot;</span><span class="token operator">+</span><span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

<span class="token comment">// reverseRangeWithScores</span>
<span class="token comment">// reverseRangeByScoreWithScores</span>
</code></pre></div><h3 id="redis实现分布式锁"><a href="#redis实现分布式锁" class="header-anchor">#</a> Redis实现分布式锁</h3> <p>方案1：通过setnx这个命令，在每次要执行redis操作时加一个锁；如果能拿到这个锁，就继续执行，否则等待。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> lockKey <span class="token operator">=</span> <span class="token string">&quot;product_100_stock&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> stockStr <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 实现关键是用到了setnx这个命令</span>
<span class="token keyword">boolean</span> result <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">,</span> <span class="token string">&quot;20&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">&quot;locked&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> stock <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>stockStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>stock <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  stock<span class="token operator">--</span><span class="token punctuation">;</span>
  stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">;</span>
</code></pre></div><p>常见的坑：</p> <p>1.如果程序运行中死机了怎么处理？</p> <ul><li>在代码块中加try finally，删除锁</li> <li>增加锁的超时时间，避免程序异常无法释放锁；</li></ul> <p>2.超时时间怎么去定比较合理？不会提前清除锁，从而造成<code>分布式锁</code>释放错误。</p> <ul><li>考虑在主线程里，开启一个子线程，去不断的定时轮询延迟锁的时间。主线程结束后，结束子线程；</li></ul> <p>3.如何避免误删锁？多个线程处理，很有可能一个线程删除了另一个线程的锁；</p> <p>​	line4:在设置锁的value的时候，设置一个随机值，保证不同的机器处理的锁名不相同；</p> <p>​	删除锁时，先比较值，再去删除锁；</p> <p>方案2：redission框架了提供了一个分布式锁的解决方案</p> <div class="language- extra-class"><pre class="language-text"><code>RLock rLock = redisson.getLock(lockKey);
</code></pre></div><p>1.如果是master-slaver模式的redis架构，会出现什么问题？</p> <ul><li>redission写是用master，读是用slaver。如果写的时候，master挂掉，读取的slaver依然可以用，会导致锁一直无法释放，从而导致死锁。</li></ul> <p>2.redis分布式锁怎么支持高并发？</p> <p><strong>Redlock算法：</strong></p> <p>假设有N个相同的redis节点，每个节点上的redis模式一样，但是互不关联。</p> <p>1.记录时间戳；</p> <p>2.为每个redis节点设置的超时时间，以及锁过期时间。 避免服务器挂掉后，客户端仍然去等待服务器响应；(比如5ms)</p> <p>3.当设置锁时，向每个redis节点上都设置一次；</p> <p>4.记录成功的节点数，以及累计的用时时间；</p> <p>5.如果累计时间不超过锁过期时间，并且成功节点数大于总结点数的一半数量；</p> <p>6.如果累计时间超过了锁的过期时间，那么锁可能已经失效了。或者获取了小于3个锁，必须释放，否则影响其他client获取锁。</p> <div class="language-mermaid extra-class"><pre class="language-text"><code>graph TD
A(记录开始时间)--&gt;B(依次设置redis节点锁N次)
B--&gt;C(记录设置时间)
B--&gt;D(记录成功设置redis锁的节点数 R)
D--&gt;E{R &gt; N/2+1?}
C--&gt;F{锁有效期 &gt; 设置时间}
F--&gt;|是|H
F--&gt;|否|G
E--&gt;|是|H(获取锁成功)
E--&gt;|否|G(获取锁失败 )

</code></pre></div><h3 id="redis事物"><a href="#redis事物" class="header-anchor">#</a> Redis事物</h3> <h4 id="两类错误"><a href="#两类错误" class="header-anchor">#</a> 两类错误</h4> <ul><li><p>语法错误</p> <p>回滚操作——discard</p></li> <li><p>执行错误</p> <p>跳过错误继续执行</p></li></ul> <p>redisTemplate执行</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">SessionCallback</span> sessionCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SessionCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">RedisOperations</span> redisOperations<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DataAccessException</span> <span class="token punctuation">{</span>
    redisOperations<span class="token punctuation">.</span><span class="token function">multi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decrement</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> redisOperations<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>sessionCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="redis缓存一致性"><a href="#redis缓存一致性" class="header-anchor">#</a> Redis缓存一致性</h3> <p>1.强一致性——实时同步</p> <p>查询缓存，缓存不存在查询DB，保存到缓存。</p> <p>更新缓存时，先更新数据库，再将缓存的数据设置为过期；</p> <p>注意点：</p> <p><strong>缓存穿透</strong></p> <blockquote><p>每次查询的时候，数据库都返回空，每次都没缓存数据，结果每次都从数据库中查询</p></blockquote> <p>解决方案
从缓存取不到的数据，在数据库中也没有取到，这时也可以将key-value对写为key-null，缓存有效时间可以设置短点，如30秒（设置太长会导致正常情况也没法使用）。这样可以防止攻击用户反复用同一个id暴力攻击</p> <p><strong>缓存击穿</strong></p> <blockquote><p>某一个热点Key，在某一个时间里，缓存失效了。这时由于并发用户特别多，同时读缓存没读到数据，又同时去数据库去取数据，引起数据库压力瞬间增大，造成过大压力</p></blockquote> <p>解决方案</p> <ol><li>设置热点数据永远不过期；</li> <li>加互斥锁，只有1个去数据库查询；</li></ol> <p><strong>缓存雪崩</strong></p> <blockquote><p>缓存中数据大批量到过期时间，而查询数据量巨大，引起数据库压力过大甚至down机。和缓存击穿不同的是，缓存击穿指并发查同一条数据，缓存雪崩是不同数据都过期了，很多数据都查不到从而查数据库。</p></blockquote> <p>解决方案：</p> <p>1.设置不同的过期时间；</p> <p>2.热点设置不过期</p> <h3 id="redis主从复制"><a href="#redis主从复制" class="header-anchor">#</a> Redis主从复制</h3> <p>master主节点用来写入数据，slaver子节点用来读取数据，<code>主节点</code>定期把数据同步到<code>从节点</code>来保证数据的一致性。</p> <h4 id="主从复制架构"><a href="#主从复制架构" class="header-anchor">#</a> 主从复制架构</h4> <p><strong>a)  一主一从</strong>：当<code>主节点</code>的“写”命令并发高且需要持久化时，可以只在<code>从节点</code>开启AOF（主节点不需要）。</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-031252.png" width="150" align="center"> <p><strong>b) 一主多从</strong>：当对&quot;读&quot;的要求比较大时，这种结构比较合适。主节点只负责写入，然后同步到从节点。但是对主节点的影响比较大，因为<code>主节点</code>会同步到多个<code>从节点</code>，会消耗带宽和内存。</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-032919.png" width="450"> <p>c) <strong>树形结构</strong>：可以解决上面一主多从，主节点压力过大的问题；</p> <h4 id="数据同步"><a href="#数据同步" class="header-anchor">#</a> 数据同步</h4> <p>a) 全量复制：一般用于初次复制场景（第一次建立SLAVE后全量）
b) 部分复制：网络出现问题，从节点再次连接主节点时，主节点补发缺少的数据，每次数据增量同步
c) 心跳：主从有长连接心跳，主节点默认每10S向从节点发ping命令，repl-ping-slave-period控制发送频率</p> <h4 id="主从的缺点"><a href="#主从的缺点" class="header-anchor">#</a> 主从的缺点</h4> <p><strong>a)</strong> 若主节点出现问题，则不能提供服务，需要人工修改配置将从变主。
<strong>b)</strong> <code>主节点</code>的写能力单机，能力有限
<strong>c)</strong> 单机节点的存储能力也有限</p> <h3 id="哨兵机制-sentinel"><a href="#哨兵机制-sentinel" class="header-anchor">#</a> 哨兵机制(Sentinel)</h3> <blockquote><p>主要是为了解决主从复制的缺点，自动对节点进行监控。当主节点不可用时，自动将主节点的子节点转换为主节点，并且通知客户端。</p></blockquote> <h4 id="_1-高可用"><a href="#_1-高可用" class="header-anchor">#</a> 1.<strong>高可用</strong></h4> <p>当主节点出现故障时，由sentinel自动完成故障发现和转移，并且通知应用。</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-065139.png" width="300"> <p><strong>监控原理</strong>：</p> <p>1：每10s钟，哨兵向master节点获取一下信息，来确认主从节点的拓扑关系；</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-081111.png" alt="1227483-20180201113518031-1426392070"></p> <p>2：每2s钟，每个哨兵会向master节点的固定频道上发送主推消息(哨兵对master节点的判断、哨兵获取到的节点信息)。同时，每个哨兵也会去订阅这个固定频道，了解其他哨兵对这个节点的判断。</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-081103.png" alt="1227483-20180201113623921-1930278582"></p> <p>3：每s钟，每个哨兵也会向其他哨兵以及主、从节点发送ping命令；用来确定节点是否正常；</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-081055.png" alt="1227483-20180201115230609-828804435"></p> <p><strong>下线状态</strong></p> <p>1.主观下线：</p> <p>哨兵每隔1s向其他节点发送ping命令，在down-after-milliseconds有效期内，如果没有响应，就会主观的将这个节点下线；并且向其他节点确认是否都是主观下线的。<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-102223.png" alt="1227483-20180201121656031-220411144"></p> <p>2.客观下线：</p> <p>当主观下线的客户数量超过quorum（quorum = (节点数量/2) + 1）时，则认为节点是客观下线状态。</p> <p>当节点被哨兵客观下线以后，哨兵会通过选举算法，选出一个哨兵来负责进行故障转移。 每个发现节点客观下线的哨兵都有权限申请成为故障转移的哨兵；选举先到先得，成为故障转移的哨兵会选择一个主节点的从节点作为新的主节点；</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-102151.png" alt="1227483-20180201115626875-1938202974"></p> <p><strong>故障转移流程</strong></p> <p>1.选举新的主节点</p> <div class="language-mermaid extra-class"><pre class="language-text"><code>graph TD
A(网络连接正常)--&gt;B(5秒内回复过INFO命令)
B --&gt; C(10*down-after-millseconds内有连接过主机)
C --&gt; D(服务器优先级)
D --&gt; E(复制偏移量大的)
E --&gt; F(运行id较小)
F --&gt; G(新的master)

</code></pre></div><p>2.将其他节点设置为<code>新主节点</code>的从节点</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-102239.png" alt="1227483-20180201121911671-2038984859"></p> <p>3、通知客户端，新的主节点的ip、port等信息；</p> <h3 id="redis持久化"><a href="#redis持久化" class="header-anchor">#</a> Redis持久化</h3> <h4 id="rdb存储"><a href="#rdb存储" class="header-anchor">#</a> RDB存储</h4> <blockquote><p>默认持久化机制</p></blockquote> <p>rdb相当于快照，将内存中的数据以快照的方式保存到二进制文件中，默认文件名为dump.rdb;</p> <p>优点：</p> <p>​	保存快，读取恢复快；</p> <p>缺点：</p> <p>​	做快照的时候，占用内存高；</p> <h4 id="aof"><a href="#aof" class="header-anchor">#</a> AOF</h4> <blockquote><p>Append of file，将redis的<strong>写入命令</strong>追加到文件中；</p></blockquote> <p>三种aof方式：</p> <ul><li>​	每次写入追加文件 appendfsync always</li></ul> <p>缺点：有时我们只关注结果，并不想关注每次写入的过程；</p> <ul><li>​	每秒钟追加文件 appendfsync everysec</li></ul> <p>缺点：频率太高，容易占用磁盘太多；</p> <ul><li>​	永远不追加 appendfsync no</li></ul> <p>缺点: 容易丢失；</p> <h2 id="nginx"><a href="#nginx" class="header-anchor">#</a> Nginx</h2> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
    <span class="token keyword">server_name</span> <span class="token operator">~</span><span class="token operator">^</span><span class="token punctuation">(</span>manage<span class="token operator">|</span>om<span class="token operator">|</span>broker<span class="token operator">|</span>risk<span class="token operator">|</span>sms<span class="token punctuation">)</span>\<span class="token punctuation">.</span>pre\<span class="token punctuation">.</span>gsoms\<span class="token punctuation">.</span>top$<span class="token punctuation">;</span>

    <span class="token comment">#根据regex(正则表达式)来匹配内容跳转到replacement</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_host</span> <span class="token operator">~</span> <span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">set</span> <span class="token variable">$domain</span> $<span class="token number">1</span><span class="token punctuation">;</span>
       <span class="token keyword">rewrite</span> <span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">https</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token variable">$domain</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">#将所有请求都重定向到https</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>nginx安全体系架构</p> <p>nginx搭建集群</p> <p>nginx负载均衡策略</p> <p>服务器宕机容错机制</p> <p>nginx搭建企业API接口</p> <p>分布式与集群的区别</p> <p>Keepalived高可用概念</p> <p>nginx+keepalived高可用</p> <p>session共享解决方案</p> <p>高并发解决方案</p> <h1 id="mq消息中间件"><a href="#mq消息中间件" class="header-anchor">#</a> <a href="./MQ%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6">MQ消息中间件</a></h1> <h2 id="任务调度"><a href="#任务调度" class="header-anchor">#</a> 任务调度</h2> <p>任务调度概述</p> <p>使用Quartz实现</p> <p>分布式任务如何解决&quot;幂等性&quot;</p> <p>XX-JOB环境</p> <p>分布式任务平台执行原理</p> <p>任务调度平台执行器运行</p> <p>任务调度平台路由策略</p> <h2 id="分布式事物"><a href="#分布式事物" class="header-anchor">#</a> 分布式事物</h2> <p>分布式事物产生原因</p> <p>分布式事物解决方案</p> <p>CPA与Base理论</p> <p>2PC-两段提交协议</p> <p>使用MQ解决分布式事物</p> <p>LCN框架概述</p> <p>LCN框架原理</p> <p>LCN框架流程</p> <p>启动tx-mananger</p> <p>演示分布式事物产景</p> <p>使用LCN框架解决分布式事物</p> <h2 id="分布式框架1"><a href="#分布式框架1" class="header-anchor">#</a> 分布式框架1</h2> <p>SpringCloud概述</p> <p>服务注册与服务发现</p> <p>搭建Eureka注册中心(服务发现)</p> <p>发布服务会员提供者</p> <p>消费会员服务</p> <p>springcloud调用服务原理</p> <p>springcloud服务负载均衡实现原理</p> <p>使用Ribbon搭建客户端负载均衡器</p> <p>什么是接口网关</p> <p>使用Zuul搭建服务接口网关 (智能路由)</p> <p>使用Zuul网关拦截参数</p> <p>分布式配置中心概述</p> <p>使用fegin客户端</p> <p>服务雪崩效应产生原因</p> <p>雪崩效应解决方案</p> <p>使用hystrix实现服务降级</p> <p>使用hystrix解决服务雪崩原因</p> <h2 id="分布式框架2"><a href="#分布式框架2" class="header-anchor">#</a> 分布式框架2</h2> <p>Dubbo架构原理</p> <p>Dubbo应用场景</p> <p>Dubbo创建项目架构模式</p> <p>发布会员服务</p> <p>订单消费服务</p> <p>Dubbo-Admin</p> <p>Dubbo实现负载均衡、容错</p> <p>Dubbx使用</p> <h2 id="zookeeper"><a href="#zookeeper" class="header-anchor">#</a> Zookeeper</h2> <p>Zookeeper概述</p> <p>Zookeeper应用场景</p> <p>Zookeeper临时节点</p> <p>Watcher事件通知</p> <p>Zookeeper实现分布式锁</p> <p>解决生产订单号线程安全问题</p> <p>Zookeeper实现分布式锁解决方案</p> <p>Zookeeper实现负载均衡原理</p> <p>如何实现负载均衡策略</p> <p>如何实现负载均衡轮训算法</p> <p>如何使用Zookeeper实现选举策略</p> <h1 id="移动端解决方案"><a href="#移动端解决方案" class="header-anchor">#</a> 移动端解决方案</h1> <p>移动APP登录</p> <p>使用Token登录</p> <p>使用token查询用户信息</p> <p>移动端渲染</p> <p>减少CPU、GPU的计算时间。</p> <p>减少重绘时间、渲染次数</p> <p>较少IO传输时间，增加缓存内存；</p> <h1 id="uml类图"><a href="#uml类图" class="header-anchor">#</a> UML类图</h1> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-02-001939.png" alt="image-20191102081938225" style="zoom:50%;"> <p><strong>关联关系</strong>描述的是<strong>不同类的对象</strong>之间的<strong>结构</strong>关系。这种关系是一种==强关联==关系，比如 <code>乘客 - 车票</code>之间的关系，<code>老师 - 学生</code> 之间的关系。关联关系默认不强调方向，表示对象之间相互知道。如果需要强调关系，比如A知道B，B不知道A，那么用 A -&gt; B来表示。</p> <p><strong>依赖关系</strong>描述的是一种==临时性==的关系，它会在运行期间发生，随着运行时的变化，可能也发生变化。比如用户登录系统。LoginService就是依赖User对象，但这种关系是不需要保存的。</p> <p>判断到底是关联关系还是依赖关系，一般就是先看看是不是存在关联关系，不是的话就是依赖关系。</p> <p>在代码里，依赖关系体现为<strong>类构造方法</strong>及<strong>类方法的入参</strong>，箭头的方向表示了调用关系。 比如 A --&gt; B ，表示了A调用的B的方法或者属性。 通常我们要<strong>避免双向依赖关系</strong>的出现。</p> <h1 id="撮合系统"><a href="#撮合系统" class="header-anchor">#</a> 撮合系统</h1> <h2 id="订单模块"><a href="#订单模块" class="header-anchor">#</a> 订单模块</h2> <p>用户订单通过网关进入到系统；</p> <p>系统接收到订单后，生成订单编号，加入到发送队列中；</p> <p>发送者单独启动线程，向mq队列中发送消息；</p> <p>mq消费者监听队列消息，一部分消费者将订单落库，还有一部分消费者按symbol来订阅订单；</p> <p>订单系统主要工作完成；</p> <h2 id="撮合模块"><a href="#撮合模块" class="header-anchor">#</a> 撮合模块</h2> <p>撮合模块里有2块服务，1个服务监听mq的队列，用撮合算法进行计算，计算完以后，按币对、排序后保存到内存中；</p> <p>如果</p> <p>撮合逻辑：</p> <p>有一笔新的订单进入系统，判断订单是否是撤单？如果是撤单，将订单从内存中删除。</p> <p>否则的话先判断买卖方向</p> <p>再判断订单类型</p> <p>如果是买单，先取卖单的第一个订单，比较价格，如果买单价格大于等于卖单价格，成交两个订单中较小的一个。</p> <p>生成并推送成交信息到mq里。</p> <p>删除内存队列里的订单</p> <p>然后判断这比买单是否完成，如果没有完成，继续取下一个订单。</p> <p><strong>队列肯定要加锁，防止删除错误，或者读取脏数据</strong></p> <p>如果判断不满足条件，向买方队列里加入订单，并且重新排序。</p> <h2 id="数据表设计"><a href="#数据表设计" class="header-anchor">#</a> 数据表设计</h2> <h3 id="订单类型"><a href="#订单类型" class="header-anchor">#</a> 订单类型</h3> <p>限价单</p> <p>市价单</p> <p>止盈止损</p> <h3 id="订单队列"><a href="#订单队列" class="header-anchor">#</a> 订单队列</h3> <p>订单队列排序</p> <p>价格优先: 买单从高往低，卖单从低往高</p> <p>同等价格时间优先</p> <p>撮合顺序：</p> <h3 id="自动成交"><a href="#自动成交" class="header-anchor">#</a> 自动成交</h3> <p>撮合订单</p> <p>生成交易记录</p> <h3 id="撮合算法"><a href="#撮合算法" class="header-anchor">#</a> 撮合算法</h3> <p>公平性、</p> <p>高效性</p> <p>扩展性</p> <p>难点:</p> <ol><li>分布式全局唯一id。每个订单应该有一个全局唯一的定序的id，不能用时间戳，不方便阅读，而且可能存在多个相同的。</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.ab51adc0.js" defer></script><script src="/assets/js/2.c5c14eb8.js" defer></script><script src="/assets/js/81.1009b854.js" defer></script>
  </body>
</html>
