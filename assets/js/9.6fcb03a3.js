(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{371:function(a,s,e){"use strict";e.r(s);var r=e(25),t=Object(r.a)({},(function(){var a=this,s=a.$createElement,e=a._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[e("h1",{attrs:{id:"容器编排-swarm"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#容器编排-swarm"}},[a._v("#")]),a._v(" 容器编排 Swarm")]),a._v(" "),e("p",[a._v("之前的都是本地docker-cli去连接1台docker服务")]),a._v(" "),e("p",[a._v("但是生产环境一般都是很多的容器，需要在集群里去部署")]),a._v(" "),e("p",[a._v("怎么去管理容器？")]),a._v(" "),e("p",[a._v("怎么水平扩展")]),a._v(" "),e("p",[a._v("怎么自动恢复容器")]),a._v(" "),e("p",[a._v("怎么去更新容器")]),a._v(" "),e("p",[a._v("怎么监控容器")]),a._v(" "),e("p",[a._v("调度容器")]),a._v(" "),e("p",[a._v("保护隐私数据")]),a._v(" "),e("h2",{attrs:{id:"swarm架构"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#swarm架构"}},[a._v("#")]),a._v(" Swarm架构")]),a._v(" "),e("p",[a._v("主从模式")]),a._v(" "),e("p",[a._v("manager 主节点 用来管理子节点")]),a._v(" "),e("p",[a._v("worker 子节点用来部署service")]),a._v(" "),e("p",[a._v("manager的服务创建调度流程")]),a._v(" "),e("p",[a._v("swarm manager接收api命令")]),a._v(" "),e("p",[a._v("循环创建service的任务")]),a._v(" "),e("p",[a._v("为任务分配ip地址")]),a._v(" "),e("p",[a._v("将任务分配给子节点")]),a._v(" "),e("p",[a._v("调度一个worker去执行任务")]),a._v(" "),e("p",[a._v("调度之前，我们并不知道哪些子节点会用来部署service，而是由manager自动分配子节点的。")]),a._v(" "),e("p",[e("img",{attrs:{src:"https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-24-233715.png",alt:"img"}})]),a._v(" "),e("h2",{attrs:{id:"service"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#service"}},[a._v("#")]),a._v(" Service")]),a._v(" "),e("p",[a._v("一个service是一个container")]),a._v(" "),e("p",[a._v("相关命令")]),a._v(" "),e("blockquote",[e("p",[a._v("创建service")])]),a._v(" "),e("p",[e("code",[a._v("docker service create --name ${name} ${image_name}")])]),a._v(" "),e("p",[e("img",{attrs:{src:"https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-25-140131.png",alt:"image-20200325220130874"}})]),a._v(" "),e("blockquote",[e("p",[a._v("Replicas")])]),a._v(" "),e("h1",{attrs:{id:"创建docker-manager-和-worker"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#创建docker-manager-和-worker"}},[a._v("#")]),a._v(" 创建docker manager 和 worker")]),a._v(" "),e("p",[e("strong",[a._v("1.通过docker-machine创建3台装了docker的虚拟机.")])]),a._v(" "),e("p",[e("code",[a._v("docker-machine create swarm-manager")])]),a._v(" "),e("p",[e("code",[a._v("docker-machine create swarm-worker1")])]),a._v(" "),e("p",[e("code",[a._v("docker-machine create swarm-worker2")])]),a._v(" "),e("p",[e("strong",[a._v("2.创建manager节点")])]),a._v(" "),e("p",[e("strong",[e("code",[a._v("docker swarm init --advertise-addr manager地址")])])]),a._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[a._v("$ docker swarm init --advertise-addr "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".99.102\nSwarm initialized: current node "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("um80rij7oxdf0aah5w3rxqwui"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" is now a manager.\n\nTo "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("add")]),a._v(" a worker to this swarm, run the following command:\n\n    docker swarm "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("join")]),a._v(" --token SWMTKN-1-0070gxx0qgp7x8464wazp072naygyszoebrqndbpx06r3xpcuh-bg1t8dcc5zidwxtwd9ofsrk63 "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".99.102:2377\n\nTo "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("add")]),a._v(" a manager to this swarm, run "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v("'docker swarm join-token manager'")]),a._v(" and follow the instructions.\n")])])]),e("p",[a._v("在子节点上，去执行"),e("code",[a._v("docker swarm join")]),a._v("的命令;")]),a._v(" "),e("p",[a._v("3."),e("strong",[a._v("查看swarm的状态")])]),a._v(" "),e("p",[e("img",{attrs:{src:"https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-24-135100.png",alt:"image-20200324215100372"}})]),a._v(" "),e("p",[e("strong",[a._v("4.查看集群信息")])]),a._v(" "),e("p",[a._v("进入管理节点，执行：docker info 可以查看当前集群的信息。")]),a._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[a._v("$ docker info\n")])])]),e("p",[e("img",{attrs:{src:"https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-24-234004.png",alt:"image-20200325074004340"}})]),a._v(" "),e("p",[a._v("可以知道当前运行的集群中，有三个节点，其中有一个是管理节点。")]),a._v(" "),e("p",[a._v("5."),e("strong",[a._v("部署服务到集群里")])]),a._v(" "),e("p",[a._v("任何和集群相关的操作，都是在manager节点上进行")]),a._v(" "),e("p",[e("code",[a._v("docker service create --replicas 1 --name helloworld alpine ping docker.com")])]),a._v(" "),e("p",[a._v("6."),e("strong",[a._v("查看服务")])]),a._v(" "),e("p",[e("img",{attrs:{src:"https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-24-234715.png",alt:"image-20200325074715238"}})]),a._v(" "),e("p",[a._v("7."),e("strong",[a._v("水平扩展services")])]),a._v(" "),e("p",[e("img",{attrs:{src:"https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-24-235001.png",alt:"image-20200325075000990"}})]),a._v(" "),e("p",[a._v("8.删除服务")]),a._v(" "),e("p",[e("img",{attrs:{src:"https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-24-235215.png",alt:"image-20200325075215363"}})]),a._v(" "),e("p",[a._v("9.更新服务")]),a._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[a._v("docker "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" create --replicas "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(" --name redis redis:3.0.6\ndocker "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" update --image redis:3.0.7 redis\n")])])]),e("p",[e("img",{attrs:{src:"https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-24-235756.png",alt:"image-20200325075755485"}})]),a._v(" "),e("p",[a._v("10.更新节点状态")]),a._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[a._v("$ docker node "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("ls")]),a._v("  "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看所有节点")]),a._v("\n$ docker node update --avaliability drain swarm-worker1\n$ docker node update --availability active swarm-worker1\n")])])]),e("h2",{attrs:{id:"实例应用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#实例应用"}},[a._v("#")]),a._v(" 实例应用")]),a._v(" "),e("p",[a._v("利用swarm搭建word press")]),a._v(" "),e("p",[a._v("1.创建network")]),a._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[a._v("$ docker network create -d overlay demo \n$ docker network "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("ls")]),a._v("\n")])])]),e("p",[a._v("2.创建mysql服务")]),a._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[a._v("$ docker "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" create --name mysql --env "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MYSQL_ROOT_PASSWORD")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("root --env "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MYSQL_DATABASE")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("wordpress --network demo --mount "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("type")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("volume,source"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("mysql-data,destination"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/var/lib/mysql mysql\n")])])]),e("p",[a._v("3.创建wordpress")]),a._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[a._v("$ docker "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" create --name wordpress -p "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("80")]),a._v(":80 -e "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("WORDPRESS_DB_HOST")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("mysql -e "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("WORDPRESS_DB_PASSWORD")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("root --network demo wordpress\n")])])]),e("h1",{attrs:{id:"routing-mesh"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#routing-mesh"}},[a._v("#")]),a._v(" Routing Mesh")]),a._v(" "),e("ul",[e("li",[a._v("Internal")])]),a._v(" "),e("p",[a._v("Container之间的访问，通过overlay网络进行访问。 service之间的ping，返回的是vip.")]),a._v(" "),e("p",[a._v("Vitural IP")]),a._v(" "),e("p",[a._v("swarm会给service分配虚拟ip，因为会横线扩展，ip是不断变化的。所以ping service都是虚拟ip。")]),a._v(" "),e("p",[a._v("Nslookup tasks.whoami 可以查看真实的ip地址")])])}),[],!1,null,null,null);s.default=t.exports}}]);