<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>解决方案 | Coda的博客</title>
    <meta name="generator" content="VuePress 1.5.1">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="闲着无聊？那就读书吧">
    <link rel="preload" href="/assets/css/0.styles.c3659042.css" as="style"><link rel="preload" href="/assets/js/app.ab75ed54.js" as="script"><link rel="preload" href="/assets/js/2.7c7b516a.js" as="script"><link rel="preload" href="/assets/js/87.8ec3d92c.js" as="script"><link rel="prefetch" href="/assets/js/10.27624e2e.js"><link rel="prefetch" href="/assets/js/100.c7488e59.js"><link rel="prefetch" href="/assets/js/101.21e1cfe3.js"><link rel="prefetch" href="/assets/js/102.82f628ea.js"><link rel="prefetch" href="/assets/js/103.b136c3a8.js"><link rel="prefetch" href="/assets/js/104.b2335111.js"><link rel="prefetch" href="/assets/js/105.f7f33196.js"><link rel="prefetch" href="/assets/js/106.33afd343.js"><link rel="prefetch" href="/assets/js/107.0c0ba6c6.js"><link rel="prefetch" href="/assets/js/108.e77b8489.js"><link rel="prefetch" href="/assets/js/109.5a80c9eb.js"><link rel="prefetch" href="/assets/js/11.0b45a4d2.js"><link rel="prefetch" href="/assets/js/110.4553f0ef.js"><link rel="prefetch" href="/assets/js/111.300c43c0.js"><link rel="prefetch" href="/assets/js/112.a7d89c35.js"><link rel="prefetch" href="/assets/js/113.171ab8f3.js"><link rel="prefetch" href="/assets/js/114.f58c358c.js"><link rel="prefetch" href="/assets/js/115.60c95b56.js"><link rel="prefetch" href="/assets/js/116.ef3bc3fd.js"><link rel="prefetch" href="/assets/js/117.40c2d400.js"><link rel="prefetch" href="/assets/js/118.d4e567f7.js"><link rel="prefetch" href="/assets/js/119.508b4b0d.js"><link rel="prefetch" href="/assets/js/12.92c6e45c.js"><link rel="prefetch" href="/assets/js/120.08d59e01.js"><link rel="prefetch" href="/assets/js/121.68121824.js"><link rel="prefetch" href="/assets/js/122.92162ee7.js"><link rel="prefetch" href="/assets/js/13.f01235bf.js"><link rel="prefetch" href="/assets/js/14.6f36b30a.js"><link rel="prefetch" href="/assets/js/15.6c792851.js"><link rel="prefetch" href="/assets/js/16.c610593a.js"><link rel="prefetch" href="/assets/js/17.d424583c.js"><link rel="prefetch" href="/assets/js/18.f2df71d6.js"><link rel="prefetch" href="/assets/js/19.5fc8cebd.js"><link rel="prefetch" href="/assets/js/20.8995b21e.js"><link rel="prefetch" href="/assets/js/21.86b9bfb1.js"><link rel="prefetch" href="/assets/js/22.a0f9800b.js"><link rel="prefetch" href="/assets/js/23.c600b58d.js"><link rel="prefetch" href="/assets/js/24.48ac403d.js"><link rel="prefetch" href="/assets/js/25.27aa9981.js"><link rel="prefetch" href="/assets/js/26.603bdaff.js"><link rel="prefetch" href="/assets/js/27.6f56182a.js"><link rel="prefetch" href="/assets/js/28.3305a0e9.js"><link rel="prefetch" href="/assets/js/29.5b741a1f.js"><link rel="prefetch" href="/assets/js/3.2a5c0790.js"><link rel="prefetch" href="/assets/js/30.b049a0bc.js"><link rel="prefetch" href="/assets/js/31.2777fef6.js"><link rel="prefetch" href="/assets/js/32.c6876688.js"><link rel="prefetch" href="/assets/js/33.5912b1cb.js"><link rel="prefetch" href="/assets/js/34.d88222ad.js"><link rel="prefetch" href="/assets/js/35.c0a73a14.js"><link rel="prefetch" href="/assets/js/36.00d0b5f6.js"><link rel="prefetch" href="/assets/js/37.621e3465.js"><link rel="prefetch" href="/assets/js/38.ce8a9a3d.js"><link rel="prefetch" href="/assets/js/39.367987fd.js"><link rel="prefetch" href="/assets/js/4.84f6746f.js"><link rel="prefetch" href="/assets/js/40.396176aa.js"><link rel="prefetch" href="/assets/js/41.c39f7b41.js"><link rel="prefetch" href="/assets/js/42.d39ba6fd.js"><link rel="prefetch" href="/assets/js/43.c553abd8.js"><link rel="prefetch" href="/assets/js/44.e1d01935.js"><link rel="prefetch" href="/assets/js/45.85eda8e6.js"><link rel="prefetch" href="/assets/js/46.5d171ed6.js"><link rel="prefetch" href="/assets/js/47.9f8d9eff.js"><link rel="prefetch" href="/assets/js/48.0b28deb0.js"><link rel="prefetch" href="/assets/js/49.37a0c336.js"><link rel="prefetch" href="/assets/js/5.5858b048.js"><link rel="prefetch" href="/assets/js/50.d050f9b1.js"><link rel="prefetch" href="/assets/js/51.3845482b.js"><link rel="prefetch" href="/assets/js/52.dc113850.js"><link rel="prefetch" href="/assets/js/53.b4035495.js"><link rel="prefetch" href="/assets/js/54.42ccfbed.js"><link rel="prefetch" href="/assets/js/55.5f7dbe20.js"><link rel="prefetch" href="/assets/js/56.d4791533.js"><link rel="prefetch" href="/assets/js/57.96e328e6.js"><link rel="prefetch" href="/assets/js/58.02080a48.js"><link rel="prefetch" href="/assets/js/59.7a4597c0.js"><link rel="prefetch" href="/assets/js/6.f73da795.js"><link rel="prefetch" href="/assets/js/60.9393a4a6.js"><link rel="prefetch" href="/assets/js/61.5a6ab329.js"><link rel="prefetch" href="/assets/js/62.d6412e9e.js"><link rel="prefetch" href="/assets/js/63.b5a7f34a.js"><link rel="prefetch" href="/assets/js/64.c9cddcd7.js"><link rel="prefetch" href="/assets/js/65.ad0c82f1.js"><link rel="prefetch" href="/assets/js/66.28cb91ad.js"><link rel="prefetch" href="/assets/js/67.66f91193.js"><link rel="prefetch" href="/assets/js/68.47cacb29.js"><link rel="prefetch" href="/assets/js/69.12c0d723.js"><link rel="prefetch" href="/assets/js/7.1751b963.js"><link rel="prefetch" href="/assets/js/70.ad0e27cf.js"><link rel="prefetch" href="/assets/js/71.394f01dc.js"><link rel="prefetch" href="/assets/js/72.3066f882.js"><link rel="prefetch" href="/assets/js/73.92298092.js"><link rel="prefetch" href="/assets/js/74.08fe9c75.js"><link rel="prefetch" href="/assets/js/75.1bb7461b.js"><link rel="prefetch" href="/assets/js/76.3368f834.js"><link rel="prefetch" href="/assets/js/77.e22703eb.js"><link rel="prefetch" href="/assets/js/78.5b3d1387.js"><link rel="prefetch" href="/assets/js/79.ffc3b486.js"><link rel="prefetch" href="/assets/js/8.33554b33.js"><link rel="prefetch" href="/assets/js/80.fce952ae.js"><link rel="prefetch" href="/assets/js/81.95d2b0e1.js"><link rel="prefetch" href="/assets/js/82.67a901f7.js"><link rel="prefetch" href="/assets/js/83.5b344c15.js"><link rel="prefetch" href="/assets/js/84.d8e80971.js"><link rel="prefetch" href="/assets/js/85.ca443067.js"><link rel="prefetch" href="/assets/js/86.47cb11f1.js"><link rel="prefetch" href="/assets/js/88.69df527b.js"><link rel="prefetch" href="/assets/js/89.8366e9e2.js"><link rel="prefetch" href="/assets/js/9.6fcb03a3.js"><link rel="prefetch" href="/assets/js/90.d2173910.js"><link rel="prefetch" href="/assets/js/91.bd7a3846.js"><link rel="prefetch" href="/assets/js/92.749da7f0.js"><link rel="prefetch" href="/assets/js/93.c95cc763.js"><link rel="prefetch" href="/assets/js/94.88f60507.js"><link rel="prefetch" href="/assets/js/95.149f6f91.js"><link rel="prefetch" href="/assets/js/96.8805afd4.js"><link rel="prefetch" href="/assets/js/97.db0e9b92.js"><link rel="prefetch" href="/assets/js/98.ca169aa3.js"><link rel="prefetch" href="/assets/js/99.3637ec5b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c3659042.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Coda的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/服务端/" class="nav-link">
  服务端
</a></div><div class="nav-item"><a href="/前端/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/android/" class="nav-link">
  android
</a></div><div class="nav-item"><a href="/DevOps/" class="nav-link">
  devOps
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/服务端/" class="nav-link">
  服务端
</a></div><div class="nav-item"><a href="/前端/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/android/" class="nav-link">
  android
</a></div><div class="nav-item"><a href="/DevOps/" class="nav-link">
  devOps
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>解决方案</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/web/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_1-前端可配置化logo的设计方案" class="sidebar-link">1.前端可配置化logo的设计方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#需求背景" class="sidebar-link">需求背景</a></li><li class="sidebar-sub-header"><a href="/web/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#解决方案-2" class="sidebar-link">解决方案</a></li></ul></li><li><a href="/web/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_2-nodejs进行服务的转发代理" class="sidebar-link">2.nodejs进行服务的转发代理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#需求背景-2" class="sidebar-link">需求背景</a></li><li class="sidebar-sub-header"><a href="/web/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#方案" class="sidebar-link">方案</a></li></ul></li><li><a href="/web/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_3-实现一个大文件上传" class="sidebar-link">3.实现一个大文件上传</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#需求背景-3" class="sidebar-link">需求背景</a></li><li class="sidebar-sub-header"><a href="/web/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#解决方案-3" class="sidebar-link">解决方案</a></li></ul></li><li><a href="/web/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_4-前端excel导出数据功能" class="sidebar-link">4.前端Excel导出数据功能</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/web/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_5-前端实现文件下载的几种方案" class="sidebar-link">5.前端实现文件下载的几种方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#a标签下载" class="sidebar-link">a标签下载</a></li><li class="sidebar-sub-header"><a href="/web/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#form表单提交" class="sidebar-link">form表单提交</a></li><li class="sidebar-sub-header"><a href="/web/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#利用blob下载" class="sidebar-link">利用blob下载</a></li><li class="sidebar-sub-header"><a href="/web/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#blob方案实现大文件下载" class="sidebar-link">blob方案实现大文件下载</a></li></ul></li><li><a href="/web/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_6-利用puppeteer来实现预渲染" class="sidebar-link">6.利用puppeteer来实现预渲染</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#需求背景-4" class="sidebar-link">需求背景</a></li><li class="sidebar-sub-header"><a href="/web/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#解决方案-4" class="sidebar-link">解决方案</a></li></ul></li><li><a href="/web/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_7-前端防止用户刷单" class="sidebar-link">7.前端防止用户刷单</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/web/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_8-管理端控制菜单权限-功能权限" class="sidebar-link">8.管理端控制菜单权限/功能权限</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="解决方案"><a href="#解决方案" class="header-anchor">#</a> 解决方案</h1> <h2 id="_1-前端可配置化logo的设计方案"><a href="#_1-前端可配置化logo的设计方案" class="header-anchor">#</a> 1.前端可配置化logo的设计方案</h2> <blockquote><p>这个方案是在工作当中运用到的最小化、最简易版的设计方案</p></blockquote> <h3 id="需求背景"><a href="#需求背景" class="header-anchor">#</a> 需求背景</h3> <p>给公司做了一个基于sass服务的运营——管理端界面。因为是给客户使用的，有一些客户希望能用自己的公司的logo、海报背景等等。相当于个性化定制。</p> <p>所以需要把一些配置提炼出来，作为可配置化的功能。</p> <h3 id="解决方案-2"><a href="#解决方案-2" class="header-anchor">#</a> 解决方案</h3> <blockquote><p>一、方案思路</p></blockquote> <p>首先定义一个配置文件，可以是.json的后缀，也可以是.js的后缀。配置的内容主要就是需要配置的各种logo、title等信息。</p> <p>通过后台的相关接口，知道引入哪一个配置文件。</p> <p>根据接口，引入这个配置文件，可以是通过ajax来请求这个json，又或者是动态import这个js文件，取决于你的文件格式。</p> <blockquote><p>二、关键代码</p></blockquote> <p><strong>配置文件格式</strong></p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;default&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;loginBg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/static/img/default/login-bg.png&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;footerLogo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/static/img/default/footer-logo.png&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;logo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/static/img/default/logo.png&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;welcome&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/static/img/default/welcome-bg.png&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;favicon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/static/img/default/favicon.ico&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>这里就简单举个例子，“default”就是配置的唯一id，不同的配置会分配一个id给他。</p> <p>default下面的key就是配置项。</p> <p><strong>设置为全局变量</strong></p> <div class="language-html extra-class"><pre class="language-html"><code> &lt;% if (process.env.NODE_ENV === 'production') { %&gt;
      window.__config = {
        #if ($third_type)
          thirdType: '&lt;%= &quot;$!third_type&quot; %&gt;',
        #else
          thirdType: 'default',
        #end
        #if ($title)
          title: '&lt;%= &quot;$!title&quot; %&gt;',
        #else
          title: '管理平台',
        #end
      }
   &lt;% } %&gt;
</code></pre></div><p>这里其实用到了模板语言，<code>&lt;% if (process.env.NODE_ENV === 'production') { %&gt;</code>是ejs的语法。node打包编译完成后，需要将它放到服务端，从服务端直接那边返回页面。</p> <p>这段话的意思是，从服务端渲染的时候，读取third_type的变量信息，然后直接设置为全局window.__config.thirdType这个变量。 这个变量的意思就是具体需要用到哪个配置文件的意思。</p> <p><strong>view使用</strong></p> <p>先读取配置信息</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> images <span class="token keyword">from</span> <span class="token string">'../assets/img/images.json'</span><span class="token punctuation">;</span>
<span class="token comment">// 中间省略</span>
<span class="token operator">...</span>
<span class="token comment">// vue的data对象</span>
<span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
		images<span class="token operator">:</span> images<span class="token punctuation">[</span>window<span class="token punctuation">.</span>__config<span class="token punctuation">.</span>thirdType<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>再在用到的地方，使用data变量来替换。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>header-logo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  用到图片的地方
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">:src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>images.logo<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>header-logo-img<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
 </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span></code></pre></div><blockquote><p>三、方案的优缺点</p></blockquote> <p><strong>优点</strong>：</p> <ol><li>最小化的解决了个性化配置的问题。只需要后台配合域名或者机构号，来设置好thirdType参数，再返回给前端即可。</li> <li>从页面渲染加载时，就可以确认thirdType，不会出现闪屏的问题；</li></ol> <p><strong>缺点</strong>：</p> <ol><li>配置不灵活，需要手动写配置文件，而且替换图片也需要开发人员进行打包升级，不能做到立即生效；</li></ol> <blockquote><p>四、待改进点</p></blockquote> <ol><li>因为我们产品以及后台都没有规划好这块的功能设计，所以其实最大的改进就是将这些配置本身就做成功能。</li> <li>其次，import json文件，实际上会把json代码打包到整个代码里面去，导致文件臃肿。最好是从服务端加载。</li> <li>图片都是本地图片，最好也可以从远端读取图片，减少打包的大小；</li></ol> <blockquote><p>五、源码地址</p></blockquote> <h2 id="_2-nodejs进行服务的转发代理"><a href="#_2-nodejs进行服务的转发代理" class="header-anchor">#</a> 2.nodejs进行服务的转发代理</h2> <h3 id="需求背景-2"><a href="#需求背景-2" class="header-anchor">#</a> 需求背景</h3> <p>这个之前项目里想到用这个方案做一些请求的透传，改变host和cookie，达到跨域的效果。</p> <h3 id="方案"><a href="#方案" class="header-anchor">#</a> 方案</h3> <p>开发时，前端如果需要proxy进行代理请求，webpackDevServer提供了一个很好的API。</p> <p>生产环境如果也需要做中间件透传，那么可以去参考webpackDevServer去做。</p> <h2 id="_3-实现一个大文件上传"><a href="#_3-实现一个大文件上传" class="header-anchor">#</a> 3.实现一个大文件上传</h2> <h3 id="需求背景-3"><a href="#需求背景-3" class="header-anchor">#</a> 需求背景</h3> <p>本来是在做一个运维工具，用来测试我们对外的user api接口。由于是nodejs写的，而node对FormData的支持不是很好，所以提交文件就很麻烦。</p> <p>后面衍生出了两种问题：</p> <p>1、怎么用nodejs去模拟浏览器的request去上传文件</p> <p>2、怎么进行大文件上传</p> <h3 id="解决方案-3"><a href="#解决方案-3" class="header-anchor">#</a> 解决方案</h3> <blockquote><p>问题分析</p></blockquote> <p>首先，在http请求里，如果是普通的form表单提交，会以<code>application/x-www-form-urlencoded</code>的形式传输. 但如果是传输文件的格式,需要设置header为是<code>multipart/form-data</code>.</p> <p>来看一个文件上传的http报文：</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token request-line"><span class="token property">POST</span> /file/v1/upload HTTP/1.1</span>
<span class="token header-name keyword">Host:</span> localhost:8081
<span class="token header-name keyword">Content-Length:</span> 100460
<span class="token header-name keyword">Content-Type:</span> multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

----WebKitFormBoundary7MA4YWxkTrZu0gW
<span class="token header-name keyword">Content-Disposition:</span> form-data; name=&quot;file&quot;; filename=&quot;v2-f7139f8763b996ebfa28486e160f6378_r.jpg&quot;
<span class="token header-name keyword">Content-Type:</span> image/jpeg

(data)
----WebKitFormBoundary7MA4YWxkTrZu0gW--

</code></pre></div><p>上面4行是request的headers</p> <p>中间有一行空行，空行下面是FormData</p> <p>可以看出来：FormData是以<code>----WebKitFormBoundary${random_str}</code>开始，以<code>----WebKitFormBoundary${random_str}--</code>结尾。并且这个值和headers里面Content-Type的boundary一致。</p> <p>所以第一个问题很好解决，只需要模拟这种请求的格式，应该就能发送一个文件到服务端。</p> <blockquote><p>实现代码：</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> boundary <span class="token operator">=</span> <span class="token string">'001373272605314343826714'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> filePath <span class="token operator">=</span> <span class="token string">'/Users/keyang/Desktop/v2-f7139f8763b996ebfa28486e160f6378_r.jpg'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token string">'method'</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
	<span class="token string">'hostname'</span><span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
	<span class="token string">'port'</span><span class="token operator">:</span> <span class="token number">61470</span><span class="token punctuation">,</span>
	<span class="token string">'path'</span><span class="token operator">:</span> <span class="token string">'/file/v1/upload'</span><span class="token punctuation">,</span>
	<span class="token string">'headers'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'multipart/form-data; boundary=------------------------WebKitFormBoundary7MA4YWxkTrZu0gW'</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">const</span> req <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> chunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">var</span> body <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>chunks<span class="token punctuation">)</span><span class="token punctuation">;</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> postData <span class="token operator">=</span> <span class="token string">'------------------------'</span> <span class="token operator">+</span> boundary <span class="token operator">+</span> <span class="token string">'\r\n'</span>
	<span class="token operator">+</span> <span class="token string">'Content-Disposition:form-data; name=&quot;file&quot;; filename=&quot;v2-f7139f8763b996ebfa28486e160f6378_r.jpg&quot;\r\n'</span>
	<span class="token operator">+</span> <span class="token string">'Content-Type: image/jpeg\r\n\r\n'</span>
<span class="token keyword">const</span> endData <span class="token operator">=</span> <span class="token string">'\r\n------------------------'</span> <span class="token operator">+</span> boundary <span class="token operator">+</span> <span class="token string">'--\r\n'</span><span class="token punctuation">;</span>


fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	req<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'multipart/form-data; boundary=------------------------'</span> <span class="token operator">+</span> boundary<span class="token punctuation">)</span><span class="token punctuation">;</span>
	req<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Length'</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">byteLength</span><span class="token punctuation">(</span>postData<span class="token punctuation">)</span> <span class="token operator">+</span> Buffer<span class="token punctuation">.</span><span class="token function">byteLength</span><span class="token punctuation">(</span>endData<span class="token punctuation">)</span> <span class="token operator">+</span> stats<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	req<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>postData<span class="token punctuation">)</span><span class="token punctuation">;</span>
	req<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span>
	req<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>endData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>第二部分上传大文件的思路：</p> <p>1.客户端分片；使用Blob.prototype.slice方法。将大文件分成小的文件，确保每个文件不会超过1048576字节的大小。</p> <p>2.服务端合并：先接受客户端传输的分片文件，按顺序保存。上传完成后，利用对分片传输的文件进行合并。</p> <p>分片文件的发送大致如下：</p> <div class="language-html extra-class"><pre class="language-html"><code>POST /test.html HTTP/1.1
Host: example.org
Content-Type: multipart/form-data;boundary=&quot;boundary&quot;

--boundary
Content-Disposition: form-data; name=&quot;chunk&quot;; filename=&quot;blob&quot;
Content-Type: application/octet-stream

(binary)
--boundary
Content-Disposition: form-data; name=&quot;hash&quot;

value1
--boundary
Content-Disposition: form-data; name=&quot;filename&quot;

value2
--boundary--
</code></pre></div><p>利用hash值来标识文件顺序，利用chunk来传输文件</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-18-030935.png" alt="image-20200113154533606"></p> <blockquote><p>代码实现</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code># interview<span class="token operator">-</span>learn
<span class="token comment">//https://juejin.im/post/5dff8a26e51d4558105420ed?utm_source=gold_browser_extension#heading-13</span>
</code></pre></div><h2 id="_4-前端excel导出数据功能"><a href="#_4-前端excel导出数据功能" class="header-anchor">#</a> 4.前端Excel导出数据功能</h2> <p>有一些报表的数据，客户希望通过导出成为excel的方式去查看。而这些数据都已经通过后台接口返回回来了，那么单纯的通过前端就可以进行excel导出功能。</p> <blockquote><p>使用说明</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 声明导出excel的header名称</span>
<span class="token keyword">const</span> tHeader <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.initDate'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.coName'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.pdName'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.assetAccoName'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.exchgroupName'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.exchName'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.currencyPair'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.orderDir'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.strikeAVGPrice'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.strikeQty'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.strikeAmount'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.fee'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 处理数据</span>
<span class="token keyword">const</span> filterVal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'init_date'</span><span class="token punctuation">,</span> <span class="token string">'co_name'</span><span class="token punctuation">,</span> <span class="token string">'pd_name'</span><span class="token punctuation">,</span> <span class="token string">'asset_acco_name'</span><span class="token punctuation">,</span> <span class="token string">'exch_group_name'</span><span class="token punctuation">,</span> <span class="token string">'exch_name'</span><span class="token punctuation">,</span> <span class="token string">'stock_name'</span><span class="token punctuation">,</span> <span class="token string">'order_dir'</span><span class="token punctuation">,</span> <span class="token string">'strike_aver_price'</span><span class="token punctuation">,</span> <span class="token string">'bs_crncy_strike_qty'</span><span class="token punctuation">,</span> <span class="token string">'qt_crncy_strike_qty'</span><span class="token punctuation">,</span> <span class="token string">'strike_fee'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tableData<span class="token punctuation">;</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> filterVal<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'strike_aver_price'</span> <span class="token operator">||</span> key <span class="token operator">===</span> <span class="token string">'bs_crncy_strike_qty'</span> <span class="token operator">||</span> key <span class="token operator">===</span> <span class="token string">'qt_crncy_strike_qty'</span> <span class="token operator">||</span> key <span class="token operator">===</span> <span class="token string">'strike_fee'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'number'</span><span class="token punctuation">,</span> <span class="token string">'$0'</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'order_dir'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">translateDict</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> item<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> item<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> currentDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> excelName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.exchgroupStrike'</span><span class="token punctuation">)</span> <span class="token operator">+</span> currentDate<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'yyyyMMdd'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> excelSheetName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.exchgroupStrike'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 交给工具方法去导出数据</span>
<span class="token function">export_json_to_excel</span><span class="token punctuation">(</span>tHeader<span class="token punctuation">,</span> data<span class="token punctuation">,</span> excelSheetName<span class="token punctuation">,</span> excelName<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_5-前端实现文件下载的几种方案"><a href="#_5-前端实现文件下载的几种方案" class="header-anchor">#</a> 5.前端实现文件下载的几种方案</h2> <h3 id="a标签下载"><a href="#a标签下载" class="header-anchor">#</a> a标签下载</h3> <p>a标签下载是最简单的方式。</p> <p>但是有一个很不好的地方是，如果下载的文件是浏览器能够直接打开的类型，比如png，pdf。那么浏览器就会直接预览这个文件，而不是下载。</p> <p>这种方式和<code>window.open(url, '_blank')</code>方式是一样的。</p> <div class="language- extra-class"><pre class="language-text"><code>href: 文件的绝对/相对地址
download: 文件名（可省略，省略后浏览器自动识别源文件名）
&lt;a href='xxx.jpg' download='file.jpg'&gt;下载jpg图片&lt;/a&gt;
</code></pre></div><h3 id="form表单提交"><a href="#form表单提交" class="header-anchor">#</a> form表单提交</h3> <p>利用form的submit直接向后台提交请求，后台返回文件流后，浏览器会直接处理并且保存文件。</p> <div class="language- extra-class"><pre class="language-text"><code> const $form = document.createElement(&quot;form&quot;);
    $form.method = &quot;GET&quot;;
    $form.action = urls[&quot;download_invite_record&quot;];
    document.body.appendChild($form);
    $form.submit();
    document.body.removeChild($form);
</code></pre></div><h3 id="利用blob下载"><a href="#利用blob下载" class="header-anchor">#</a> 利用blob下载</h3> <div class="language- extra-class"><pre class="language-text"><code>return fetch(`${url}`, options)
    .then(checkStatus)
    .then(function (resp) {
      filename = resp.headers.get(&quot;content-disposition&quot;);
      filename = filename.split(&quot;=&quot;)[1];
      return resp.blob();
    })
    .then(function (blob) {
      const url = window.URL.createObjectURL(blob);
      const $link = document.createElement(&quot;a&quot;);
      $link.href = url;
      $link.download = filename;
      document.body.appendChild($link);
      $link.click();
      document.body.removeChild($link);
      URL.revokeObjectURL(url);
    });
</code></pre></div><h3 id="blob方案实现大文件下载"><a href="#blob方案实现大文件下载" class="header-anchor">#</a> blob方案实现大文件下载</h3> <p>火币项目里，有一个导出数据的需求。数据量特别大，按照传统做法，会很卡顿。后台如果是把所有数据查询回来在一次性返回，压力也很大。</p> <p>和后台商定，采用文件流的传输模式。后台直接以stream的形式传输数据，前端采用stream模式下载。</p> <p>来分析一下这个response headers:</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-18-035546.png" alt="image-20200318115358676"></p> <p><strong>第一点</strong>：<code>content-type: application/octet-stream</code></p> <p><code>content-type</code>是<code>application/otcet-stream</code>，查看MDN的文档可以知道:</p> <p>这是应用程序文件的默认值。意思是 *未知的应用程序文件 ，*浏览器一般不会自动执行或询问执行。浏览器会像对待 设置了HTTP头<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Disposition" target="_blank" rel="noopener noreferrer"><code>Content-Disposition</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 值为 <code>attachment</code> 的文件一样来对待这类文件。</p> <p><strong>第二点：</strong><code>content-disposition</code></p> <p><code>attachment</code>（意味着消息体应该被下载到本地；大多数浏览器会呈现一个“保存为”的对话框，将<code>filename</code>的值预填为下载后的文件名，假如它存在的话）。</p> <p>前端核心代码，主要是处理的逻辑：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 核心代码</span>
axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
	data<span class="token operator">:</span> params<span class="token punctuation">,</span>
	responseType<span class="token operator">:</span> <span class="token string">'arraybuffer'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">resp</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> contentDisposition <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'content-disposition'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> fileName <span class="token operator">=</span> contentDisposition<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token comment">// 创建一个虚拟click标签，触发下载。</span>
	<span class="token keyword">const</span> $link <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> url <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>resp<span class="token punctuation">.</span>data<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
		type<span class="token operator">:</span> <span class="token string">'application/openxmlformats-officedocument.spreadsheetml.sheet;charset=utf-8'</span><span class="token comment">//文件类型,这里是csv</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  $link<span class="token punctuation">.</span>href <span class="token operator">=</span> url<span class="token punctuation">;</span>
	$link<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token string">'_blank'</span><span class="token punctuation">;</span>
	$link<span class="token punctuation">.</span>download <span class="token operator">=</span> fileName<span class="token punctuation">;</span>
	document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>$link<span class="token punctuation">)</span><span class="token punctuation">;</span>
	$link<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>$link<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">revokeObjectURL</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="_6-利用puppeteer来实现预渲染"><a href="#_6-利用puppeteer来实现预渲染" class="header-anchor">#</a> 6.利用puppeteer来实现预渲染</h2> <h3 id="需求背景-4"><a href="#需求背景-4" class="header-anchor">#</a> 需求背景</h3> <p>之前做了一个官网项目，本来是用nuxt来实现的，服务端渲染也可以直接利用nuxt。</p> <p>但是后面部署的时候，因为种种原因，部署成了静态页面（只用了nginx服务器）</p> <p>所以页面的SEO是没法做的，查看网站的源码时，展示如下。</p> <p><img src="image-20200803153557179.png" alt="image-20200803153557179"></p> <h3 id="解决方案-4"><a href="#解决方案-4" class="header-anchor">#</a> 解决方案</h3> <p>用egg + puppeteer来实现 ssr预渲染</p> <ul><li>调试步骤：</li></ul> <p>1.打开dev参数，通过curl命令，来打开无头浏览器，看一下错误日志。</p> <p><img src="image-20200803204558296.png" alt="image-20200803204558296"></p> <p>2.输入curl命令，浏览器会自动打开Chromium</p> <div class="language- extra-class"><pre class="language-text"><code>curl http://127.0.0.1:7002/\?url\=https://www.baidu.com
</code></pre></div><p><img src="image-20200803204826454.png" alt="image-20200803204826454"></p> <ul><li>测试验证步骤：</li></ul> <p>通过curl命令行，指定user-agent来访问页面地址，看服务器的返回是否经过了puppeteer服务器</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">curl</span> -H <span class="token string">&quot;user-agent: Mozilla/5.0 (Linux; Android 6.0.1; Nexus 5X Build/MMB29P) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.92 Mobile Safari/537.36 (compatible; Googlebot/2.1; +http://www.google.com/bot.html&quot;</span>  https://www.hbtc.com
</code></pre></div><p>或者修改浏览器UA</p> <p><img src="image-20200803175435339.png" alt="image-20200803175435339"></p> <h2 id="_7-前端防止用户刷单"><a href="#_7-前端防止用户刷单" class="header-anchor">#</a> 7.前端防止用户刷单</h2> <p>1、验证码 比如后台的验证码、极验等</p> <p>2、增加用户权限要求</p> <p>3、调用核心接口防止参数暴露</p> <h2 id="_8-管理端控制菜单权限-功能权限"><a href="#_8-管理端控制菜单权限-功能权限" class="header-anchor">#</a> 8.管理端控制菜单权限/功能权限</h2> <p>1、后台控制菜单级别权限</p> <p>2、后台返回可访问菜单权限id</p> <p>3、前端路由里配置好对应菜单权限id。</p> <p>4、菜单权限id匹配上，则允许访问</p> <p>5、调用菜单下的接口时，带上菜单权限id。如果某用户没有这个菜单权限，即使调用接口也没用。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.ab75ed54.js" defer></script><script src="/assets/js/2.7c7b516a.js" defer></script><script src="/assets/js/87.8ec3d92c.js" defer></script>
  </body>
</html>
