# æ¶æ„å­¦ä¹ 

[TOC]

## JVM

> https://www.processon.com/view/5c749debe4b0f9fba6921d15?fromnew=1

### JDKã€JREã€JVMçš„åŒºåˆ«

JDKåŒ…å«JREï¼ŒJREåŒ…å«JVMã€‚

JDKæ˜¯Javaå¼€å‘çš„å·¥å…·åŒ…ï¼ˆJava Develop Kitï¼‰

JREæä¾›äº†Javaè¿è¡Œçš„ç¯å¢ƒï¼ˆJava Runtime Enviorment)

JVMåˆ™æ˜¯ä¸€å°è™šæ‹Ÿæœºï¼Œä»–ä»è½¯ä»¶çš„å±‚é¢ä¸Šï¼Œåœ¨è™šæ‹Ÿæœºå†…éƒ¨å¸®æˆ‘ä»¬æŠŠJDKç¼–è¯‘å‡ºæ¥çš„classæ–‡ä»¶ï¼Œè½¬æ¢ä¸ºå¯ä»¥è¢«å½“å‰æ“ä½œç³»ç»Ÿè¯†åˆ«çš„æœºå™¨ç ã€‚æ¢å¥è¯è¯´ï¼Œä»–å†…éƒ¨å¸®åŠ©æˆ‘ä»¬å±è”½äº†ä¸€äº›æ“ä½œç³»ç»Ÿå±‚é¢ä¸Šçš„åŒºåˆ«ï¼Œè®©æˆ‘ä»¬çš„ç¨‹åºèƒ½å¤Ÿ**è·¨å¹³å°è¿è¡Œ**ã€‚

JVMåŒ…å«äº†3ä¸ªéƒ¨åˆ†ï¼šç±»åŠ è½½å™¨å­ç³»ç»Ÿã€è¿è¡Œæ—¶æ•°æ®åŒºã€æ‰§è¡Œå¼•æ“ã€‚

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-26-071216.png" alt="image-20191026151216502" style="zoom:50%;" />

### JVMå†…å­˜åŒºåŸŸ

è¿è¡Œæ—¶æ•°æ®åŒºæ˜¯JVMçš„æ ¸å¿ƒï¼Œæ•´ä½“çš„ç»“æ„å¦‚ä¸‹ï¼š

![image-20191106180725123](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-06-100726.png)

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-26-042632.png" alt="image-20191026122631783" style="zoom:50%;" />

**Javaæ ˆ**ï¼ˆè™šæ‹Ÿæœºæ ˆï¼‰ï¼šJavaä¼šç»™æ¯ä¸€ä¸ªè¿è¡Œçš„çº¿ç¨‹åˆ†é…ä¸€ä¸ªæ ˆï¼Œè¿™ä¸ªæ ˆæ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚

â€‹	**æ ˆé’ˆ**ï¼šåœ¨æ ˆé‡Œé¢ï¼Œå­˜æ”¾æœ‰å¾ˆå¤šæ ˆå¸§ï¼Œæ¯ä¸ªæ–¹æ³•è¿è¡Œæ—¶éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ ˆå¸§å…¥æ ˆï¼Œä¿è¯æ¯ä¸ªæ–¹æ³•æœ‰è‡ªå·±ç‹¬ç«‹çš„ä½œç”¨åŸŸï¼›æ ˆå¸§é‡Œå¯ä»¥å­˜å‚¨äº†javaæ–¹æ³•è¿è¡Œæ—¶çš„ç›¸å…³ä¿¡æ¯ï¼ˆå±€éƒ¨å˜é‡è¡¨ï¼Œæ“ä½œæ•°æ ˆï¼ŒåŠ¨æ€é“¾æ¥ï¼Œæ–¹æ³•å‡ºå£ç­‰ï¼‰

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-26-063421.png" alt="image-20191026143421183" style="zoom:50%;" />



â€‹	**å±€éƒ¨å˜é‡è¡¨**ï¼šä¿å­˜æ–¹æ³•å†…éƒ¨çš„ä¸´æ—¶å˜é‡ï¼Œæ¯”å¦‚ï¼ša=1;b=2;c=new Math()`ç­‰

â€‹	**æ“ä½œæ•°æ ˆ**ï¼šjvmæ‰§è¡Œå¼•æ“ä¼šç”¨åˆ°ï¼Œå­˜æ”¾ä¸€äº›æ“ä½œç¬¦è¿ç®—ï¼›

**æœ¬åœ°æ–¹æ³•æ ˆ**ï¼šå’ŒJavaæ ˆçš„æ¦‚å¿µç±»ä¼¼ï¼Œä¹Ÿæ˜¯æ¯ä¸ªçº¿ç¨‹ç§æœ‰ã€‚ä½†æ˜¯å®ƒé‡Œé¢å­˜æ”¾çš„éƒ½æ˜¯ä¸€äº›nativeçš„æ–¹æ³•ä¿¡æ¯ã€‚

**ç¨‹åºè®¡æ•°å™¨ï¼š**ä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰ï¼Œä½œç”¨ä¸»è¦æ˜¯ä¸ºäº†è®°å½•å½“å‰çº¿ç¨‹è¿è¡Œåˆ°å“ªä¸€è¡Œä»£ç ã€‚å› ä¸ºæ¯ä¸ªçº¿ç¨‹çš„æ‰§è¡Œéƒ½ä¾èµ–äºCPUçš„è°ƒåº¦ï¼Œæ˜¯éœ€è¦æŠ¢å CPUèµ„æºçš„ï¼Œæ‰€ä»¥çº¿ç¨‹ç»å¸¸ä¼šå› ä¸ºå¤±å»CPUèµ„æºè€Œè¢«æŒ‚èµ·ã€‚å½“çº¿ç¨‹é‡å¯è·å–åˆ°è¿è¡Œèµ„æºæ—¶ï¼Œå°±è¦æ ¹æ®ç¨‹åºè®¡æ•°å™¨æ¥ç»§ç»­æ‰§è¡Œã€‚

**æ–¹æ³•åŒº**ï¼šæ–¹æ³•åŒºé‡Œå­˜æ”¾çš„æ˜¯ç±»å…ƒä¿¡æ¯ã€é™æ€å˜é‡ã€å¸¸é‡ç­‰ã€‚

â€‹	é™æ€å˜é‡

â€‹	å¸¸é‡ï¼š static finalçš„

â€‹	ç±»å…ƒä¿¡æ¯ï¼šä¸€ä¸ªç±»çš„ç»„æˆä¿¡æ¯ã€‚ï¼ˆç±»åã€ç±»ä¿®é¥°ç¬¦ã€æ–¹æ³•åç­‰ï¼‰

**å †**: å †å†…å­˜æ˜¯çº¿ç¨‹å…±äº«çš„ï¼Œç”¨æ¥å­˜æ”¾javaè¿è¡Œæ—¶åˆ›å»ºå‡ºæ¥çš„å¯¹è±¡ï¼Œå¯¹è±¡çš„â€œå†…å­˜åœ°å€â€å­˜æ”¾åœ¨æ ˆå±€éƒ¨å˜é‡è¡¨é‡Œé¢ã€‚

â€‹	å †å†…å­˜ç»“æ„åŒ…æ‹¬ï¼šæ–°ç”Ÿä»£ã€formã€toã€æ°¸ä¹…ä»£ï¼›

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-26-084454.png" alt="image-20191026164453593" style="zoom:60%;" />





å †æº¢å‡º

æ ˆæº¢å‡º

å†…å­˜æº¢å‡ºä¸å†…å­˜æ³„éœ²çš„åŒºåˆ«



### GCåƒåœ¾å›æ”¶æœºåˆ¶

Javaåƒåœ¾å›æ”¶åˆ†ä¸ºminorå›æ”¶å’Œmajorå›æ”¶ï¼Œä¸¤ç§å›æ”¶çš„æœºåˆ¶ä¸åŒï¼Œå›æ”¶çš„å¯¹è±¡ä¸»ä½“åœ¨å †å†…å­˜æ¨¡å‹ä¸­ä¹Ÿä¸ä¸€æ ·ã€‚

ğŸ‘†Javaå †å†…å­˜æ¨¡å‹åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼š

æ–°ç”Ÿä»£å¤§æ¦‚å å †å†…å­˜çš„1/3ï¼Œè€å¹´ä»£å å†…å­˜çš„2/3ã€‚

**æ–°ç”Ÿä»£**ï¼š

ç”±Edenå’ŒSurvior Spaceç»„æˆã€‚åˆå§‹å¤§å°ç”±-Xmnå‚æ•°è®¾å®šã€‚

å·¥ä½œæœºåˆ¶ï¼š

EdenåŒºå¤§çº¦å æ–°ç”Ÿä»£å†…å­˜ç©ºé—´çš„8/10ï¼Œjava newå‡ºæ¥çš„å¯¹è±¡éƒ½ä¼šå…ˆæ”¾å…¥åˆ°EdenåŒºï¼›å½“Edenå†…å­˜ä¸å¤Ÿæ—¶ï¼Œjvmä¼šå¯åŠ¨ä¸€æ¬¡minor gcã€‚Minor GCä¼šæŠŠé‚£äº›å†…å­˜ä¸­ä¸å†æœ‰å¼•ç”¨çš„å¯¹è±¡éƒ½å›æ”¶ï¼ˆå›æ”¶ç®—æ³•ä¸‹é¢ä¼šè®²åˆ°ï¼‰ï¼Œè€Œé‚£äº›æœ‰ç”¨çš„å¯¹è±¡ä¼šè¢«å…¨éƒ¨ç§»åŠ¨åˆ°`S0 Space`ã€‚ç¬¬äºŒæ¬¡gcçš„æ—¶å€™ï¼Œä¼šæŠŠEdenåŒºå’ŒS0 Spaceé‡Œå­˜æ´»çš„å¯¹è±¡ä¸€èµ·ç§»åŠ¨åˆ°S1 Spaceã€‚

å¯¹è±¡åœ¨s0 spaceå’Œs1 spaceæ¥å›ç§»åŠ¨ï¼Œæ¯æ¬¡è½¬ç§»æ—¶ï¼Œè¿™äº›å¯¹è±¡éƒ½ä¼šæ›´æ–°gcçš„å¹´é¾„æ ‡å¿—ã€‚å½“gcå¹´é¾„è¾¾åˆ°15æ—¶ï¼Œä¼šå°†è¯¥å¯¹è±¡ç§»åŠ¨åˆ°è€å¹´ä»£ã€‚

å¦‚æœs0å’Œs1çš„å†…å­˜åŒºåŸŸæ”¾ä¸ä¸‹å­˜æ´»çš„å¯¹è±¡æ—¶ï¼Œä¼šå»è€å¹´ä»£å†…å­˜ä¸­å€Ÿç”¨å†…å­˜ï¼Œç­‰ä¸‹ä¸€æ¬¡gcåå†è¿˜ç»™è€å¹´ä»£ã€‚è€Œè€å¹´ä»£ä¹Ÿä¼šä¸ºäº†ç¡®ä¿minor gcæ“ä½œèƒ½å®Œæˆï¼Œé¢„ç•™äº†ä¸€éƒ¨åˆ†å†…å­˜ä½œä¸ºä¿ç•™åŒºåŸŸã€‚è¿™ç§è¡Œä¸ºæˆä¸ºï¼š`æ–°ç”Ÿä»£æœé›†æ‹…ä¿`ã€‚å¦‚æœé¢„ç•™æ“ä½œæ— æ³•å®Œæˆï¼Œä¹Ÿä¼šè§¦å‘Major GCã€‚

**è€å¹´ä»£**ï¼š

è€å¹´ä»£åŒºåŸŸä¸­çš„å¯¹è±¡å­˜æ´»ç‡å¾ˆé«˜ï¼Œä¸€èˆ¬å›æ”¶çš„å‘¨æœŸå¾ˆé•¿ã€‚

Major GCå› ä¸ºè¦å¯¹æ‰€æœ‰çš„å¯¹è±¡è¿›è¡Œå›æ”¶ï¼Œå¾ˆæ¶ˆè€—æ—¶é—´ï¼Œæ‰€ä»¥è¦å°½é‡é¿å…Major GCã€‚jvmè°ƒä¼˜çš„è¿‡ç¨‹ä¸­ï¼Œå¾ˆå¤§ä¸€éƒ¨åˆ†å·¥ä½œå°±æ˜¯å‡å°‘Full GCçš„æ¬¡æ•°ã€‚



### GCå›æ”¶åˆ¤æ–­

#### ~~å¼•ç”¨è®¡æ•°æ³•~~

#### å¯è¾¾æ€§åˆ†æ

#### GC Rootsæ ¹

javaçš„åƒåœ¾å›æ”¶æœºåˆ¶ä¸­ï¼Œåˆ¤æ–­1ä¸ªå¯¹è±¡æ˜¯å¦å¯è¢«å›æ”¶ï¼Œå¹¶ä¸æ˜¯çœ‹æœ‰æ²¡æœ‰å¯¹è±¡å¯¹å…¶å¼•ç”¨ï¼Œè€Œæ˜¯é€šè¿‡`å¯è¾¾æ€§åˆ†æ`ï¼Œçœ‹è¿™ä¸ªå¯¹è±¡æœ‰æ²¡æœ‰åˆ°GC Rootçš„å¼•ç”¨é“¾ç›¸è¿ã€‚

æ€ä¹ˆç†è§£è¿™æ®µè¯ï¼Ÿå°±æ˜¯è¯´ï¼Œä»GC Rootsæ ¹å‘ä¸‹æ‰¾ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½æ‰¾åˆ°ä¸€æ¡è·¯ï¼Œè¾¾åˆ°è¿™ä¸ªå¯¹è±¡ã€‚å¦‚æœæ‰¾åˆ°äº†ï¼Œè¯´æ˜æ˜¯æœ‰å¼•ç”¨é“¾ç›¸è¿çš„ã€‚

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-26-132038.png" alt="Ã¨Â¿Ã©Ã¥Ã¥Â¾Ã§Ã¦Ã¨Â¿Â°" style="zoom:50%;" />

å¯ä»¥ä½œä¸ºGC Rootsæ ¹çš„å¯¹è±¡ï¼š

- è™šæ‹Ÿæœºæ ˆï¼ˆæ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡è¡¨ï¼‰ä¸­å¼•ç”¨çš„å¯¹è±¡ï¼›ä»»æ„æ–¹æ³•é‡ŒC c = new C();
- æ–¹æ³•åŒºä¸­é™æ€å˜é‡å¼•ç”¨çš„å¯¹è±¡ï¼›static B b = new B();
- æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡ï¼› static final A a = new A();
- Nativeæ–¹æ³•å¼•ç”¨çš„å¯¹è±¡ï¼›



#### å¼•ç”¨å…³ç³»

> https://blog.csdn.net/luzhensmart/article/details/81431212

â‘´å¼ºå¼•ç”¨ï¼ˆStrongReferenceï¼‰

```
A a = new A()
```

å¼ºå¼•ç”¨æ˜¯ä½¿ç”¨æœ€æ™®éçš„å¼•ç”¨ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡å…·æœ‰å¼ºå¼•ç”¨ï¼Œé‚£åƒåœ¾å›æ”¶å™¨ç»ä¸ä¼šå›æ”¶å®ƒã€‚å½“å†…å­˜ç©ºé—´ä¸è¶³ï¼ŒJavaè™šæ‹Ÿæœºå®æ„¿æŠ›å‡ºOutOfMemoryErroré”™è¯¯ï¼Œä½¿ç¨‹åºå¼‚å¸¸ç»ˆæ­¢ï¼Œä¹Ÿä¸ä¼šé éšæ„å›æ”¶å…·æœ‰å¼ºå¼•ç”¨çš„å¯¹è±¡æ¥è§£å†³å†…å­˜ä¸è¶³çš„é—®é¢˜ã€‚

â‘µè½¯å¼•ç”¨ï¼ˆSoftReferenceï¼‰

```java
SoftReference<String> sr = new SoftReference<String>(new String("hello"));
```

å¦‚æœä¸€ä¸ªå¯¹è±¡åªå…·æœ‰è½¯å¼•ç”¨ï¼Œåˆ™å†…å­˜ç©ºé—´è¶³å¤Ÿï¼Œåƒåœ¾å›æ”¶å™¨å°±ä¸ä¼šå›æ”¶å®ƒï¼›å¦‚æœå†…å­˜ç©ºé—´ä¸è¶³äº†ï¼Œå°±ä¼šå›æ”¶è¿™äº›å¯¹è±¡çš„å†…å­˜ã€‚åªè¦åƒåœ¾å›æ”¶å™¨æ²¡æœ‰å›æ”¶å®ƒï¼Œè¯¥å¯¹è±¡å°±å¯ä»¥è¢«ç¨‹åºä½¿ç”¨ã€‚

åº”ç”¨åœºæ™¯ï¼šè½¯å¼•ç”¨å¯ç”¨æ¥æ­é…ç¼“å­˜æ¥åšï¼ŒåŒæ—¶é¿å…å†…å­˜æº¢å‡ºã€‚

â‘¶å¼±å¼•ç”¨ï¼ˆWeakReferenceï¼‰

```java
WeakReference<String> sr = new WeakReference<String>(new String("hello"));
```

å¼±å¼•ç”¨ä¸è½¯å¼•ç”¨çš„åŒºåˆ«åœ¨äºï¼šåªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡æ‹¥æœ‰æ›´çŸ­æš‚çš„ç”Ÿå‘½å‘¨æœŸã€‚åœ¨åƒåœ¾å›æ”¶å™¨çº¿ç¨‹æ‰«æå®ƒæ‰€ç®¡è¾–çš„å†…å­˜åŒºåŸŸçš„è¿‡ç¨‹ä¸­ï¼Œä¸€æ—¦å‘ç°äº†åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ï¼Œä¸ç®¡å½“å‰å†…å­˜ç©ºé—´è¶³å¤Ÿä¸å¦ï¼Œéƒ½ä¼šå›æ”¶å®ƒçš„å†…å­˜ã€‚ä¸è¿‡ï¼Œç”±äºåƒåœ¾å›æ”¶å™¨æ˜¯ä¸€ä¸ªä¼˜å…ˆçº§å¾ˆä½çš„çº¿ç¨‹ï¼Œå› æ­¤ä¸ä¸€å®šä¼šå¾ˆå¿«å‘ç°é‚£äº›åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ã€‚


#### finalizeæŠ¢æ•‘

![img](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-26-132358.png)

#### GC logåˆ†æ

å…è´¹çš„GCæ—¥å¿—å›¾å½¢åˆ†æå·¥å…·æ¨èä¸‹é¢2ä¸ªï¼š

- [GCViewer](https://juejin.im/post/[https://github.com/chewiebug/GCViewer](https://github.com/chewiebug/GCViewer))ï¼Œä¸‹è½½jaråŒ…ç›´æ¥è¿è¡Œ
- [gceasy](https://gceasy.io/)ï¼Œwebå·¥å…·ï¼Œä¸Šä¼ GCæ—¥å¿—åœ¨çº¿ä½¿ç”¨



## JMMâ€”â€”Javaå†…å­˜æ¨¡å‹

### CPUç¼“å­˜æ¨¡å‹

ç°ä»£CPUä¸ºäº†æé«˜è¿è¡Œé€Ÿåº¦ï¼Œå‡å°‘ä»å†…å­˜ä¸­è¯»å–æ•°æ®çš„æ¬¡æ•°ï¼Œå¤§å¤šè®¾è®¡äº†3å±‚ç¼“å­˜æœºåˆ¶ã€‚æ•´ä½“æ¶æ„å¦‚ä¸‹ï¼š

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-31-221627.png" alt="image-20191101061626611" style="zoom:40%;" />

ç°ä»£CPUä¸€èˆ¬éƒ½æ˜¯å¤šæ ¸CPUï¼Œæ¯ä¸€ä¸ªCPUå†…æ ¸é‡Œéƒ½æœ‰ä¸€ä¸ªå¯„å­˜å™¨ï¼Œå¯„å­˜å™¨ä¸»è¦ç”¨æ¥å­˜æ”¾å½“å‰CPUçš„æ“ä½œç¬¦ã€è®¡ç®—ç»“æœç­‰ä¿¡æ¯ã€‚å¤šä¸ªCPUå†…æ ¸é€šè¿‡æ€»çº¿æ¥ä¼ é€’ã€å…±äº«æ•°æ®ã€‚

#### 3çº§ç¼“å­˜

> https://www.jb51.net/hardware/cpu/610074.html

CPUé«˜é€Ÿç¼“å­˜çš„å‡ºç°ä¸»è¦æ˜¯ä¸ºäº†è§£å†³==CPUè¿ç®—é€Ÿåº¦==ä¸==å†…å­˜è¯»å†™é€Ÿåº¦==ä¸åŒ¹é…çš„çŸ›ç›¾ã€‚å†…å­˜çš„è¯»å–å¤ªæ…¢ï¼Œå¯¼è‡´CPUç»å¸¸éœ€è¦ç­‰å¾…ï¼Œæ— æ³•å‘æŒ¥CPUçš„é«˜é€Ÿæ•ˆæœã€‚

é€šå¸¸CPUéƒ½ä¼šè®¾è®¡3çº§ç¼“å­˜ï¼Œæ¯ä¸ªç¼“å­˜çš„å‘½ä¸­ç‡å¤§æ¦‚åœ¨80%å·¦å³ï¼Œå³80%çš„æ•°æ®å¯ä»¥ä»L1ç¼“å­˜ä¸­è¯»å–ï¼Œ20%çš„æ•°æ®åœ¨L2ç¼“å­˜é‡Œè¯»ï¼Œä¾æ¬¡ç±»æ¨ã€‚

L1çš„ç¼“å­˜å¤§å°ä¼š å°äº L2 å°äº L3ã€‚L1åˆ†2å—åŒºåŸŸï¼šL1iç”¨æ¥ç¼“å­˜æŒ‡ä»¤ï¼ŒL1dç”¨æ¥ç¼“å­˜æ•°æ®ã€‚

L3æ˜¯æ‰€æœ‰CPUå†…æ ¸å…±äº«çš„



### MESIåè®®

> https://juejin.im/post/5da33288518825646c50f18c

å¤šæ ¸cpuçš„ç¼“å­˜ä¼šå­˜åœ¨ç¼“å­˜ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œæƒ³è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæœ€å¥½çš„æ–¹æ³•å°±æ˜¯åŠ é”ï¼Œä¿è¯æ¯æ¬¡åªæœ‰ä¸€ä¸ªcpuçš„ç¼“å­˜åœ¨è¢«è¯»å–ã€‚

æ—©æœŸçš„åŠ é”ç­–ç•¥æ˜¯æŠŠæ•´ä¸ªå†…å­˜æ€»çº¿é”å®šäº†èµ·æ¥ï¼Œè¿™æ ·é”å®šæœŸé—´ï¼Œæ‰€æœ‰å…¶ä»–çš„CPUæ— æ³•å»ä¿®æ”¹å†…å­˜ä¸­çš„åœ°å€ï¼Œä½†æ˜¯é€ æˆçš„é—®é¢˜å°±æ˜¯æ€§èƒ½å¾ˆæ…¢ã€‚

ç°åœ¨çš„æ–¹æ¡ˆéƒ½æ˜¯é€šè¿‡MESIåè®®æ¥è§£å†³ã€‚

MESIåè®®æ•´ä½“æ¶æ„å¦‚ä¸‹ï¼š

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-31-225407.png" alt="image-20191101065406793" style="zoom:40%;" />



MESIå®šä¹‰äº†**ç¼“å­˜è¡Œ**çš„4ç§ç¼“å­˜çŠ¶æ€ï¼š

> ç¼“å­˜è¡Œï¼šç¼“å­˜çš„åŸºæœ¬æ•°æ®å•ä½ï¼Œåœ¨Intelçš„CPUä¸Šä¸€èˆ¬æ˜¯64å­—èŠ‚

| çŠ¶æ€           | æè¿°                                    |
| -------------- | --------------------------------------- |
| Mï¼ˆModifiedï¼‰  | å½“å‰ç¼“å­˜æœ‰æ•ˆï¼Œä¸”å€¼è¢«ä¿®æ”¹äº†              |
| Eï¼ˆExculsiveï¼‰ | å½“å‰ç¼“å­˜æœ‰æ•ˆï¼Œåªå­˜åœ¨å½“å‰CPUå†…æ ¸çš„ç¼“å­˜é‡Œ |
| Sï¼ˆSharedï¼‰    | å½“å‰ç¼“å­˜æœ‰æ•ˆï¼Œå­˜åœ¨äºå¤šä¸ªCPUçš„ç¼“å­˜ä¸­     |
| Iï¼ˆInvalidï¼‰   | å½“å‰å­˜å‚¨æ— æ•ˆ                            |

**è¯»å–è§„åˆ™**ï¼š

æ¯ä¸ªCPUä¸Šé¢éƒ½ç»´æŠ¤äº†æŸä¸€ä¸ªæ•°æ®çš„ç¼“å­˜çŠ¶æ€ã€‚

å¤„äºMçŠ¶æ€çš„ç¼“å­˜è¡Œï¼Œå¿…é¡»åœ¨å…¶ä»–CPUè¯»å– è¯¥ç¼“å­˜è¡Œå¯¹åº”çš„å†…å­˜åœ°å€ä¹‹å‰ï¼Œå°†ä¿®æ”¹çš„å€¼å†™å›ç¼“å­˜ã€‚

å¤„äºSçŠ¶æ€çš„ç¼“å­˜è¡Œï¼Œå¿…é¡»ç›‘å¬ç€è®©è¯¥ç¼“å­˜è¡Œæ— æ•ˆ æˆ– ç‹¬äº«è¯¥ç¼“å­˜è¡Œ çš„è¯·æ±‚ï¼Œå¦‚æœç›‘å¬åˆ°ä»¥åï¼ŒæŠŠç¼“å­˜è¡ŒçŠ¶æ€è®¾ç½®ä¸ºIã€‚

å¤„äºEçŠ¶æ€çš„ç¼“å­˜è¡Œï¼Œå¦‚æœç›‘å¬åˆ°å…¶ä»–è¯»å–è¯¥ç¼“å­˜è¡Œå¯¹åº”çš„å†…å­˜åœ°å€çš„æ“ä½œï¼Œéœ€è¦æŠŠè¯¥ç¼“å­˜è¡ŒçŠ¶æ€è®¾ç½®ä¸ºSã€‚

å¦‚æœç¼“å­˜è¡Œçš„ç¼“å­˜çŠ¶æ€æ˜¯Iï¼Œéœ€è¦å­˜å†…å­˜ä¸­é‡æ–°è¯»å–ï¼Œç„¶åæŠŠçŠ¶æ€æ”¹ä¸ºSã€‚



 **çŠ¶æ€æœº**

MESIåè®®å®é™…ä¸Šæ˜¯ä¸€ç§æœ‰é™çŠ¶æ€æœºï¼Œç¼“å­˜çŠ¶æ€ä¼šæ ¹æ®äº‹ä»¶è¿›è¡Œç›¸åº”çŠ¶æ€çš„æ”¹å˜ã€‚äº‹ä»¶åˆ†æˆ2ç±»ï¼Œ

`cpuå¯¹cacheçš„è¯·æ±‚äº‹ä»¶`ï¼Œ`æ€»çº¿å¯¹cacheè¯·æ±‚äº‹ä»¶`ã€‚æ‰€æœ‰çš„äº‹ä»¶éƒ½è¢«`æ€»çº¿å—…æ¢å™¨`ç›‘å¬ã€‚

cpuå¯¹cacheçš„è¯·æ±‚äº‹ä»¶ï¼š

1. PrRd: å¤„ç†å™¨è¯·æ±‚**è¯»**ä¸€ä¸ªç¼“å­˜å—
2. PrWr: å¤„ç†å™¨è¯·æ±‚**å†™**ä¸€ä¸ªç¼“å­˜å—

æ€»çº¿å¯¹cacheçš„è¯·æ±‚äº‹ä»¶:

1. BusRdï¼šæ¢å™¨ç›‘å¬åˆ° è¿™å—ç¼“å­˜å—è¢«å…¶ä»–cpuè¯»äº†
2. BusRdXï¼šå—…æ¢å™¨ç›‘å¬åˆ° è¯¥ç¼“å­˜å—è¢«åˆ«çš„cpuæ”¹äº†
3. Flushï¼šå—…æ¢å™¨é€šçŸ¥ å›å†™æ•´ä¸ªç¼“å­˜åˆ°ä¸»å†…å­˜

![image-20191101224011364](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-01-144011.png)



### JMMæ¶æ„è§„èŒƒ

JMMæ˜¯ä¸€ç§æ¶æ„ï¼Œä¹Ÿæ˜¯ä¸€å¥—è§„èŒƒã€‚å®ƒå±è”½äº†ä¸åŒCPUå†…æ ¸çš„æ¶æ„é—®é¢˜ï¼Œé€šè¿‡å®ç°MESIåè®®ï¼Œè§£å†³äº†ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ï¼ŒåŒæ—¶ä¹Ÿè§£å†³äº†å¤šå¹¶å‘ç¼–ç¨‹çš„å¯è§æ€§é—®é¢˜ã€‚

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-31-225946.png" alt="image-20191101065946596" style="zoom:45%;" />



ä»ä¸Šå›¾é‡Œå¯ä»¥çœ‹åˆ°ï¼Œå¤šçº¿ç¨‹è¯»å†™ä¸»å†…å­˜å˜é‡ç»è¿‡äº†ä¸€ç³»åˆ—æ“ä½œã€‚è¿™äº›æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ï¼Œæ˜¯JMMå°è£…çš„åŸå­æ€§æŒ‡ä»¤ï¼Œä¸»è¦å°±æ˜¯ç”¨æ¥è§£å†³å†…å­˜åŒæ­¥ã€‚

**è¯»æ“ä½œ**

readæ“ä½œï¼šä»ä¸»å†…å­˜ä¸­è¯»å–å˜é‡

loadæ“ä½œï¼šå°†è¯»å–çš„å€¼å¤åˆ¶å¹¶åŠ è½½åˆ°ç¼“å­˜ä¸­

useï¼šçº¿ç¨‹ä½¿ç”¨ç¼“å­˜ä¸­çš„å˜é‡ï¼›



**å†™æ“ä½œ**

assignï¼šä¿®æ”¹ç¼“å­˜ä¸­å˜é‡

storeï¼šå°†ä¿®æ”¹çš„å€¼ä¿å­˜åˆ°ç¼“å­˜ä¸­ï¼›

writeï¼šå°†ç¼“å­˜é‡Œé¢ä¿®æ”¹è¿‡çš„å€¼å†™å›ä¸»å†…å­˜é‡Œï¼›



**lockå’Œunlockæ“ä½œ**

lockï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼Œä½œç”¨æ˜¯æŠŠä¸€ä¸ªå…±äº«å˜é‡æ ‡è¯†ä¸ºä¸€ä¸ªçº¿ç¨‹ç‹¬å çŠ¶æ€ã€‚

unlockï¼šä½œç”¨äºä¸»å†…å­˜å˜é‡ï¼Œä½œç”¨æ˜¯æŠŠä¸€ä¸ªå¤„äºé”å®šçŠ¶æ€çš„å˜é‡é‡Šæ”¾ï¼Œç„¶åå¯ä»¥è¢«å…¶ä»–çº¿ç¨‹é”å®š

JMMä¸­é”çš„éƒ½æ˜¯ç¼“å­˜è¡Œã€‚



volatileå…³é”®åº•å±‚çš„åŸç†å°±æ˜¯é€šè¿‡ä¸Šé¢çš„æŒ‡ä»¤æ¥é€šçŸ¥çº¿ç¨‹æ›´æ–°ç¼“å­˜ã€‚



### å¹¶å‘çš„ä¸‰å¤§ç‰¹æ€§â€”â€”åŸå­æ€§ã€å¯è§æ€§ã€ä¸€è‡´æ€§



#### æœ‰åºæ€§

åœ¨Javaå†…å­˜æ¨¡å‹ä¸­ï¼Œå…è®¸ç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¯¹æŒ‡ä»¤è¿›è¡Œ**é‡æ’åº**ï¼Œä½†æ˜¯é‡æ’åºè¿‡ç¨‹ä¸ä¼šå½±å“åˆ°å•çº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œï¼Œå´ä¼šå½±å“åˆ°å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„æ­£ç¡®æ€§ã€‚

##### é‡æ’åº

> https://blog.csdn.net/liuguangqiang/article/details/52153096

![image-20191101102800175](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-01-022800.png)



è™½ç„¶JMMå…è®¸ç¼–è¯‘å™¨è¿›è¡Œé‡æ’åºï¼Œä½†æ˜¯ä¹Ÿéœ€è¦éµå¾ªå¯¹åº”çš„è§„åˆ™ï¼šhappens-beforeè§„åˆ™ã€‚

```java
1ï¼‰ç¨‹åºé¡ºåºè§„åˆ™ï¼šä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ¯ä¸ªæ“ä½œï¼Œhappens-beforeäºè¯¥çº¿ç¨‹ä¸­çš„ä»»æ„åç»­æ“ä½œã€‚
2ï¼‰ç›‘è§†å™¨é”è§„åˆ™ï¼šå¯¹ä¸€ä¸ªé”çš„è§£é”ï¼Œhappens-beforeäºéšåå¯¹è¿™ä¸ªé”çš„åŠ é”ã€‚
3ï¼‰volatileå˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ªvolatileåŸŸçš„å†™ï¼Œhappens-beforeäºä»»æ„åç»­å¯¹è¿™ä¸ªvolatileåŸŸçš„è¯»ã€‚
4ï¼‰ä¼ é€’æ€§ï¼šå¦‚æœA happens-before Bï¼Œä¸”B happens-before Cï¼Œé‚£ä¹ˆA happens-before Cã€‚
5ï¼‰start()è§„åˆ™ï¼šå¦‚æœçº¿ç¨‹Aæ‰§è¡Œæ“ä½œThreadB.start()ï¼ˆå¯åŠ¨çº¿ç¨‹Bï¼‰ï¼Œé‚£ä¹ˆAçº¿ç¨‹çš„ThreadB.start()æ“ä½œhappens-beforeäºçº¿ç¨‹Bä¸­çš„ä»»æ„æ“ä½œã€‚
6ï¼‰join()è§„åˆ™ï¼šå¦‚æœçº¿ç¨‹Aæ‰§è¡Œæ“ä½œThreadB.join()å¹¶æˆåŠŸè¿”å›ï¼Œé‚£ä¹ˆçº¿ç¨‹Bä¸­çš„ä»»æ„æ“ä½œhappens-beforeäºçº¿ç¨‹Aä»ThreadB.join()æ“ä½œæˆåŠŸè¿”å›ã€‚1ï¼‰ç¨‹åºé¡ºåºè§„åˆ™ï¼šä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ¯ä¸ªæ“ä½œï¼Œhappens-beforeäºè¯¥çº¿ç¨‹ä¸­çš„ä»»æ„åç»­æ“ä½œã€‚

```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼š

1ï¼‰å¦‚æœä¸€ä¸ªæ“ä½œhappens-beforeå¦ä¸€ä¸ªæ“ä½œï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œç»“æœå°†å¯¹ç¬¬äºŒä¸ªæ“ä½œå¯è§ï¼Œè€Œä¸”ç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œé¡ºåºæ’åœ¨ç¬¬äºŒä¸ªæ“ä½œä¹‹å‰ã€‚
2ï¼‰ä¸¤ä¸ªæ“ä½œä¹‹é—´å­˜åœ¨happens-beforeå…³ç³»ï¼Œå¹¶ä¸æ„å‘³ç€Javaå¹³å°çš„å…·ä½“å®ç°å¿…é¡»è¦æŒ‰ç…§happens-beforeå…³ç³»æŒ‡å®šçš„é¡ºåºæ¥æ‰§è¡Œã€‚==å¦‚æœé‡æ’åºä¹‹åçš„æ‰§è¡Œç»“æœï¼Œä¸æŒ‰happens-beforeå…³ç³»æ¥æ‰§è¡Œçš„ç»“æœä¸€è‡´ï¼Œé‚£ä¹ˆè¿™ç§é‡æ’åºå¹¶ä¸éæ³•ã€‚==

æ‰€ä»¥ï¼š

ä»å•ä¸ªçº¿ç¨‹çš„è§’åº¦çœ‹ï¼Œæ˜¯å¯ä»¥ä¿è¯æœ‰åºçš„ã€‚ä½†æ˜¯å¦‚æœè§‚å¯Ÿå¤šçº¿ç¨‹ï¼Œæ•´ä¸ªç¨‹åºå°±æ— æ³•ä¿è¯æœ‰åºã€‚

`volatile`å…³é”®å­—å¯ä»¥ä¿è¯ä¸€å®šçš„â€œæœ‰åºæ€§â€ï¼Œå› ä¸º`volatile`å…³é”®å­—ä¼šç¦æ­¢æŒ‡ä»¤é‡æ’ã€‚

`synchronized`å’Œ`lock`å…³é”®å­—ä¿è¯åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€æ¡çº¿ç¨‹æ“ä½œï¼Œä»è€Œä¹Ÿä¿è¯äº†æœ‰åºæ€§ã€‚







## å¤šçº¿ç¨‹

### å¤šçº¿ç¨‹åº”ç”¨åœºæ™¯



### å®ˆæŠ¤çº¿ç¨‹ä¸éå®ˆæŠ¤çº¿ç¨‹

### å¤šçº¿ç¨‹çš„å‡ ç§çŠ¶æ€

å¤šçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼š

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-19-023655.png" alt="thread_status" style="zoom:50%;" />



### ä¿è¯çº¿ç¨‹çš„æ‰§è¡Œé¡ºåº

### ä½¿ç”¨å¤šçº¿ç¨‹åˆ†æ‰¹å¤„ç†ä¿¡æ¯

### å¤šçº¿ç¨‹é€šä¿¡æ–¹å¼

- #### wait & notify

**ä½¿ç”¨åœºæ™¯**ï¼šç°åœ¨æœ‰Aã€Bä¸¤ä¸ªçº¿ç¨‹äº’æ–¥ï¼Œæˆ‘ä»¬å¸Œæœ›çº¿ç¨‹Bè¿è¡Œåˆ°æŸä¸€ä¸ªçŠ¶æ€é€šçŸ¥çº¿ç¨‹Aè¿è¡Œã€‚å¦‚æœçº¿ç¨‹Aæ‰§è¡Œæ—¶ï¼Œè¿˜æ²¡æœ‰è¾¾åˆ°é¢„æœŸçš„çŠ¶æ€ï¼Œå…ˆè®©çº¿ç¨‹Aç­‰å¾…ï¼Œç­‰çº¿ç¨‹Båˆ°è¾¾è¿™ä¸ªçŠ¶æ€åå†é€šçŸ¥çº¿ç¨‹Aè¿è¡Œã€‚

å¦‚å›¾æ‰€ç¤ºï¼š



<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-19-022618.png" alt="wait" style="zoom:30%;" />



<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-19-023209.png" alt="notify" style="zoom:30%;" />



==æ³¨==ï¼š1.notifyå”¤é†’çš„çº¿ç¨‹ä¸ä¼šåœ¨è°ƒç”¨notifyçš„ä¸€ç¬é—´å°±æ‰§è¡Œï¼Œå› ä¸ºé‚£ä¸ªæ—¶å€™ï¼Œçº¿ç¨‹çš„é”è¿˜æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œå…¶ä»–çº¿ç¨‹è¿˜æ²¡æœ‰åŠæ³•è·å–è¯¥å®ä¾‹çš„é”ã€‚

2.åªæœ‰æ‹¥æœ‰é”çš„çº¿ç¨‹æ‰èƒ½è°ƒç”¨notifyæ–¹æ³•æ¥å”¤é†’å…¶ä»–çº¿ç¨‹ï¼›



- #### CountDownLatch è®¡æ•°é—¨é—©

**åº”ç”¨åœºæ™¯**ï¼šCountDownLatchå†…éƒ¨å°±æ˜¯1ä¸ªè®¡æ•°å™¨ã€‚å½“çº¿ç¨‹Aéœ€è¦ç­‰å¾…å…¶ä»–nä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡ä¹‹åæ‰èƒ½æ‰§è¡Œæ—¶ï¼Œå¯ä»¥é€šè¿‡CountDownLatchæ¥å®ç°ã€‚

**ä½¿ç”¨ä»‹ç»**ï¼š

```java
/**
* æ„é€ æ–¹æ³•ï¼šå‚æ•°countä¸ºè®¡æ•°å€¼
*/
public CountDownLatch(int count) {  };

/**
* è°ƒç”¨await()æ–¹æ³•çš„çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œå®ƒä¼šç­‰å¾…ç›´åˆ°countå€¼ä¸º0æ‰ç»§ç»­æ‰§è¡Œ
*/
public void await() throws InterruptedException { };

/**
* å¯ä»¥ç­‰å¾…ä¸€å®šçš„æ—¶é—´ï¼Œå¦‚æœcountä¾ç„¶æ²¡å˜æˆ0ï¼Œè¿˜æ˜¯ä¼šç»§ç»­æ‰§è¡Œ
*/
public boolean await(long timeout, TimeUnit unit) throws InterruptedException { }; 

/**
* æ¯æ¬¡è°ƒç”¨éƒ½ä¼šå°†countå€¼å‡1
*/
public void countDown() { };  //
```

**å®é™…ä½¿ç”¨**ï¼š

>å¯åŠ¨2ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹1ä¸æ–­çš„addï¼Œçº¿ç¨‹2å»ç›‘å¬å®¹å™¨çš„sizeï¼Œå½“sizeå€¼=5æ—¶ï¼Œç»ˆæ­¢çº¿ç¨‹2.

```java
CountDownLatch countDownLatch = new CountDownLatch(5);
new Thread(() -> {
  try {
    System.out.println("çº¿ç¨‹2å¼€å§‹");
    countDownLatch.await();
    System.out.println("çº¿ç¨‹2ç»“æŸ");
  } catch (InterruptedException e) {
    e.printStackTrace();
  }
}, "t2").start();
new Thread(() -> {
  System.out.println("çº¿ç¨‹1å¼€å§‹");
  synchronized (lock) {
    for (int i = 0; i < 10; i++) {
      myContainer.add(String.valueOf(i));
      System.out.println("å®¹å™¨å¢åŠ ï¼š" + (i + 1));
      countDownLatch.countDown();
      try {
        Thread.sleep(100);
      } catch (InterruptedException e) {
        e.printStackTrace();
      }
    }
  }
}, "t1").start();
```



### æ€ä¹ˆåœæ­¢çº¿ç¨‹



### çº¿ç¨‹å˜é‡ThreadLocal

> å‚è€ƒæ–‡ç« ï¼šhttps://www.jianshu.com/p/22be9653df3f

#### ä½œç”¨

ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹å¼€è¾Ÿä¸€ä¸ªå•ç‹¬çš„å†…å­˜ç©ºé—´ï¼Œç”¨æ¥å­˜æ”¾çº¿ç¨‹ç‹¬äº«çš„èµ„æº

#### ä½¿ç”¨åœºæ™¯

çº¿ç¨‹éœ€è¦å­˜æ”¾å˜é‡ï¼Œä½†æ˜¯åˆä¸å¸Œæœ›åˆ«çš„çº¿ç¨‹æ¥ä¿®æ”¹è‡ªå·±çš„å˜é‡æ—¶ï¼Œå¯ä»¥ç”¨ThreadLocalæ¥å­˜å‚¨å˜é‡çš„å€¼ï¼›

#### ä½¿ç”¨æ–¹å¼

```java
private static class MyRunnable implements Runnable {
  // åˆ›å»ºçº¿ç¨‹å˜é‡      
  ThreadLocal<String> threadLocal = new ThreadLocal<>();

        @Override
        public void run() {
            String name = Thread.currentThread().getName();
            threadLocal.set(name + "çš„ThreadLocalå˜é‡");
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            System.out.println(name + ":" + threadLocal.get());
        }
    }

    public static void main(String[] args) {
        Runnable runnable = new MyRunnable();
        new Thread(runnable, "çº¿ç¨‹1").start();
        new Thread(runnable, "çº¿ç¨‹2").start();
    }
```

#### åŸç†

æ¯ä¸ªçº¿ç¨‹å®ä¾‹éƒ½ä¼šæœ‰ä¸€ä¸ªthreadLocalsçš„å˜é‡ï¼Œç”¨æ¥å­˜æ”¾å½“å‰çº¿ç¨‹çš„ThreadLocalMapï¼›

è€Œå½“ThreadLocalåˆ›å»ºæ—¶ï¼Œä¼šåˆ›å»ºå¥½ThreadLocalMapçš„å®ä¾‹ï¼Œç„¶åå…³è”åˆ°çº¿ç¨‹tçš„threadLocalså˜é‡ä¸Šï¼›

æ¯ä¸ªThreadLocalMapçš„key = å½“å‰ThreadLocalå¯¹è±¡æœ¬èº«ï¼Œvalueæ˜¯ä¸€ä¸ªä»»æ„çš„å€¼ï¼›



æ‰€ä»¥å½“ThreadLocalè®¾ç½®å€¼æ—¶ï¼Œå½“å‰çº¿ç¨‹ä¼šå…ˆæ‹¿åˆ°ThreadLocalMapï¼Œç„¶åä¸ºè¿™ä¸ªmapä¸Šè®¾ç½®å€¼ï¼›

Debugè®°å½•

çº¿ç¨‹1ï¼šThreadLocal@948

![image-20191018075648324](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-17-235649.png)

çº¿ç¨‹1ï¼šThreadLocalMap@961

![image-20191018075918341](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-17-235919.png)

![image-20191018080048039](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-18-000049.png)

çº¿ç¨‹2ï¼šå¯ä»¥çœ‹åˆ°ThreadLocalçš„å˜é‡æ˜¯åŒä¸€ä¸ªï¼Œä½†æ˜¯mapä¼šåˆ›å»ºæ–°çš„ï¼›

![image-20191018075622915](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-17-235623.png)



## å¤šçº¿ç¨‹å®‰å…¨é—®é¢˜

å…ˆçœ‹é—®é¢˜ï¼šå‡è®¾æœ‰10000å¼ ç¥¨ï¼Œå¯åŠ¨10ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å»ä¹°ç¥¨ï¼›æ‰“å°æ¯ä¸ªçº¿ç¨‹è´­ä¹°ç¥¨çš„æƒ…å†µ.



```java
/**
 * åœºæ™¯ï¼šå‡è®¾æœ‰10000å¼ ç«è½¦ç¥¨
 * å¯åŠ¨10ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å»ä¹°ç¥¨ï¼›æ‰“å°è´­ä¹°æƒ…å†µ
 *
 * @author keyang
 * æ¯”è¾ƒä¸€ä¸‹ArrayListã€Vectorã€ConcurrentLinkedQueueåŒºåˆ«
 */
public class ConcurrentQueue1 {
	
	public static void main(String[] args) {
    // æ³¨è§£1
//		List<String> tickets = new ArrayList<>();
    // æ³¨è§£2
//		Vector<String> tickets = new Vector<String>();
    // æ³¨è§£3
		ConcurrentLinkedQueue<String> tickets = new ConcurrentLinkedQueue<>();
		for (int i = 0; i < 1000; i++) {
			tickets.add("ç«è½¦ç¥¨" + i);
		}
		System.out.println(tickets.size());
		for (int i = 0; i < 10; i++) {
			Thread thread = new Thread(() -> {
//				synchronized (tickets) {
				while (tickets.size() > 0) {
					try {
						Thread.sleep(10);
					} catch (InterruptedException e) {
						e.printStackTrace();
					}
//						System.out.println(Thread.currentThread().getId() + "â€”â€”" + tickets.remove(0));
					String ticket = tickets.poll();
					if (ticket == null) {
						break;
					}
					System.out.println(Thread.currentThread().getId() + "â€”â€”" + ticket);
				}
//				}
			});
			thread.start();
		}
	}
}

```

æ³¨è§£1ï¼šå‡è®¾ç”¨ArrayListæ¥å­˜æ”¾é˜Ÿåˆ—ï¼Œé‚£ä¹ˆç¨‹åºä¼šå‡ºç°è¶Šç•Œçš„é—®é¢˜ã€‚è€Œä¸”è¿˜å¯èƒ½ä¼šå–å‡ºç©ºç¥¨ã€‚

```verilog
21â€”â€”null
19â€”â€”null
17â€”â€”null
18â€”â€”null
Exception in thread "Thread-0" Exception in thread "Thread-9" Exception in thread "Thread-3" Exception in thread "Thread-7" Exception in thread "Thread-4" Exception in thread "Thread-1" Exception in thread "Thread-6" Exception in thread "Thread-8" Exception in thread "Thread-2" java.lang.IndexOutOfBoundsException: Index 0 out of bounds for length 0
	at java.base/jdk.internal.util.Preconditions.outOfBounds(Preconditions.java:64)
	at java.base/jdk.internal.util.Preconditions.outOfBoundsCheckIndex(Preconditions.java:70)
	at java.base/jdk.internal.util.Preconditions.checkIndex(Preconditions.java:248)
	at java.base/java.util.Objects.checkIndex(Objects.java:372)
	at java.base/java.util.ArrayList.remove(ArrayList.java:535)
	at com.gs.example.concurrentdemo.ConcurrentQueue1.lambda$main$0(ConcurrentQueue1.java:36)
	at java.base/java.lang.Thread.run(Thread.java:834)
```

å› ä¸ºArrayListçš„`remove()`æ–¹æ³•æœ¬èº«å°±æ²¡æœ‰åŸå­æ€§.

æ³¨è§£2ï¼šå‡è®¾æ›´æ¢å®¹å™¨ä¸ºVectorã€‚Vectoræœ¬èº«æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œ`remove`æ–¹æ³•æ˜¯å¯ä»¥ä¿è¯åŸå­æ€§çš„ã€‚ä½†æ˜¯ç¨‹åºä¸­`size`åˆ¤æ–­å’Œ`remove`æ–¹æ³•ä¸¤ä¸ªæ“ä½œä¹‹é—´æ˜¯æ— æ³•ä¿è¯ä¸è¢«æ‰“æ–­çš„ï¼Œæ‰€ä»¥ç³»ç»Ÿä¹Ÿä¼šåˆ¤æ–­é”™è¯¯ï¼Œå‡ºç°åŒæ ·çš„è¶Šç•Œé—®é¢˜ã€‚

æ³¨è§£3ï¼šArrayListå’ŒVectorå®¹å™¨åªèƒ½é€šè¿‡ä½¿ç”¨synchronizeé”æ¥ä¿è¯çº¿ç¨‹å®‰å…¨,ï¼Œè€…ä½¿ç”¨å¹¶å‘å®¹å™¨ï¼š`ConcurrentLinkedList`.



### Synchronizedå…³é”®å­—

- #### ä½œç”¨


ä¿è¯åŒä¸€æ—¶åˆ»ï¼Œåªæœ‰1ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œè¢«Synchronizeä¿®é¥°çš„æ–¹æ³•æˆ–ä»£ç å—ï¼›

- #### ä½¿ç”¨åœºæ™¯

ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œé€šè¿‡äº’æ–¥é”ã€é˜»å¡çš„å½¢å¼è§£å†³å¹¶å‘é—®é¢˜ï¼›

- #### ä½¿ç”¨ä»‹ç»

**ä¿®é¥°ä»£ç å—**:  éœ€è¦ä¼ å…¥ä¸€ä¸ªè¢«é”çš„å¯¹è±¡ã€‚æ¯ä¸ªçº¿ç¨‹æ‰§è¡Œä»£ç å—æ—¶ï¼Œéœ€è¦è·å–åˆ°è¿™ä¸ªå¯¹è±¡çš„é”ã€‚javaçš„æ‰€æœ‰å¯¹è±¡éƒ½æœ‰1ä¸ªäº’æ–¥é”ï¼Œsynchronizeæ–¹æ³•ç»“æŸæˆ–è€…æŠ›å‡ºå¼‚å¸¸æ—¶ä¼šè‡ªåŠ¨é‡Šæ”¾é”ã€‚

**ä¿®é¥°å®ä¾‹æ–¹æ³•**ï¼šé”çš„æ˜¯å½“å‰è°ƒç”¨æ–¹æ³•çš„å®ä¾‹å¯¹è±¡ã€‚æ¯ä¸ªå®ä¾‹å¯¹è±¡æ‹¥æœ‰ä¸€æŠŠé”ï¼Œçº¿ç¨‹è°ƒç”¨æ–¹æ³•æ—¶ï¼Œå¿…é¡»è·å–è¯¥å®ä¾‹å¯¹è±¡çš„é”ã€‚â€”â€” å’Œsynchronize(this)çš„æ•ˆæœä¸€æ ·

**ä¿®é¥°ç±»çš„é™æ€æ–¹æ³•**ï¼šé”çš„æ˜¯Classç±»çš„å¯¹è±¡ã€‚æ‰€ä»¥è¯¥Classçš„å®ä¾‹å¯¹è±¡åœ¨è°ƒç”¨è¯¥é™æ€æ–¹æ³•æ—¶ï¼Œå…±ç”¨åŒä¸€æŠŠé”ã€‚å› ä¸ºç±»åªæœ‰1ä¸ªï¼Œé™æ€æ–¹æ³•åœ¨å†…å­˜ä¸­ä¹Ÿåªæœ‰1ä¸ª



**ä¸åŒé”ä¹‹é—´çš„åŒºåˆ«ï¼š**

| ç±»å‹   | é”çš„å¯¹è±¡  | é”çš„æ•°é‡                      | è¡¨ç°å½¢å¼ |
| ------ | --------- | ----------------------------- | -------- |
| å¯¹è±¡é” | å®ä¾‹å¯¹è±¡  | å¤šä¸ªï¼ˆ1ä¸ªç±»å¯ä»¥æœ‰å¤šä¸ªå®ä¾‹ï¼‰   | æ™®é€šæ–¹æ³• |
| ç±»é”   | Classå¯¹è±¡ | 1ä¸ªï¼ˆå› ä¸º1ä¸ªç±»åªæœ‰1ä¸ªç±»å¯¹è±¡ï¼‰ | é™æ€æ–¹æ³• |

**Demo**ï¼š

```java
public class Test{ 
    // å¯¹è±¡é”ï¼šå½¢å¼1(æ–¹æ³•é”) 
    public synchronized void Method1(){ 
        System.out.println("æˆ‘æ˜¯å¯¹è±¡é”ä¹Ÿæ˜¯æ–¹æ³•é”"); 
        try{ 
            Thread.sleep(500); 
        } catch (InterruptedException e){ 
            e.printStackTrace(); 
        } 
    } 
 
    // å¯¹è±¡é”ï¼šå½¢å¼2ï¼ˆä»£ç å—å½¢å¼ï¼‰ 
    public void Method2(){ 
        synchronized (this){ 
            System.out.println("æˆ‘æ˜¯å¯¹è±¡é”"); 
            try{ 
                Thread.sleep(500); 
            } catch (InterruptedException e){ 
                e.printStackTrace(); 
            } 
        } 
    } 
      
      // ç±»é”ï¼šå½¢å¼1 ï¼šé”é™æ€æ–¹æ³•
    public static synchronized void Method1(){ 
        System.out.println("æˆ‘æ˜¯ç±»é”ä¸€å·"); 
        try{ 
            Thread.sleep(500); 
        } catch (InterruptedException e){ 
            e.printStackTrace(); 
        } 
    } 
 ï½
```



### ReentraLock å¯é‡å…¥é”

#### **ä½¿ç”¨åœºæ™¯**

1.æ›¿ä»£synchronizeçš„é”çš„æ–¹æ³•ï¼›é€šè¿‡lockå’Œunlockæ¥å®ç°synchronizeçš„åŠŸèƒ½ï¼›

2.å¯ä»¥ä½¿ç”¨trylockå°è¯•è·å–é”ã€‚å½“æ²¡æœ‰è·å–åˆ°é”æ—¶ï¼Œä¸è¿›è¡Œä¸šåŠ¡é€»è¾‘å¤„ç†ï¼›

3.å¯ä»¥ä½¿ç”¨lockInterruptiblyæ–¹æ³•æ¥å“åº”çº¿ç¨‹çš„interruptæ–¹æ³•ï¼Œé¿å…çº¿ç¨‹å› ä¸ºæ— æ³•è·å–é”è€Œæ— æ³•è¢«æ‰“æ–­ï¼›

4.é€šè¿‡ç»‘å®šconditionï¼Œå¯ä»¥å®ç°å¯¹æŸä¸€ç±»çº¿ç¨‹çš„å®šå‘é€šçŸ¥ã€‚

#### ä½¿ç”¨ä»‹ç»

**lock()**:  lockæ–¹æ³•ä¼šè·å–é”ï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°å°±ä¸€ç›´ç­‰å¾…ï¼›

**tryLock()**:  tryLockä¸ä¼šç­‰å¾…ï¼Œè€Œæ˜¯å³è¿”å›è·å–é”çš„ç»“æœã€‚è·å–åˆ°é”è¿”å›trueï¼Œæ²¡æœ‰ä¼šè¿”å›falseã€‚

**lockInterruptibly()**:  è¿™ä¸ªæ–¹æ³•ä¹Ÿä¼šä¸€ç›´ç­‰å¾…é”çš„è·å–ï¼Œå’Œlockä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡thread.interruptæ–¹æ³•æ—¶ï¼Œè®©çº¿ç¨‹å“åº”ä¸­æ–­ï¼Œä¸å†ç»§ç»­ç­‰å¾…ã€‚

**unLock**():  é‡Šæ”¾é”ï¼Œ==ä½¿ç”¨lockä¸€å®šè¦æ³¨æ„æ‰‹åŠ¨é‡Šæ”¾é”==

**newCondition**():  å¯ä»¥åˆ›å»ºå¤šä¸ªconditionå¯¹è±¡ï¼Œå®ç°awaitå’Œsignalç»„åˆã€‚

#### Condition

**ä½œç”¨**ï¼šconditionå­˜åœ¨çš„æ„ä¹‰æ˜¯ä¸ºäº†å®ç°ç±»ä¼¼ object.wait()å’Œobject.notify()çš„åŠŸèƒ½ã€‚wiatå’Œnotifyæ–¹æ³•å¯ä»¥è®©çº¿ç¨‹ç­‰å¾…ã€è¢«å”¤é†’ã€‚conditionä¹Ÿä¸€æ ·ï¼Œä½†æ˜¯å®ƒå¯ä»¥æ›´åŠ æœ‰é’ˆå¯¹æ€§çš„å»è®©æŸä¸€ç±»çº¿ç¨‹è¢«å”¤é†’ã€‚

**ä½¿ç”¨ä»‹ç»**ï¼š

await():  è®©å½“å‰çº¿ç¨‹è¿›å…¥conditionçš„ç­‰å¾…é˜Ÿåˆ—

signal()ï¼šå”¤é†’conditioné˜Ÿåˆ—ä¸Šçš„æŸä¸€ä¸ªçº¿ç¨‹

signalAll(): å”¤é†’conditioné˜Ÿåˆ—ä¸Šçš„æ‰€æœ‰çº¿ç¨‹ï¼›

#### Demo

1.å®ç°å…¬å¹³é”

```java
ReentrantLock reentrantLock = new ReentrantLock(true); // å…¬å¹³é”
Runnable runnable = new Runnable() {
  @Override
  public void run() {
    for (int i = 0; i < 100; i++) {
      reentrantLock.lock();
      try {
        System.out.println("çº¿ç¨‹"  + Thread.currentThread().getName() + "è·å–é”");
      } finally {
        if (reentrantLock.isLocked()) {
          reentrantLock.unlock();
          //						System.out.println("çº¿ç¨‹" + Thread.currentThread().getName() + "é‡Šæ”¾é”");
        }
      }
    }
  }
};
new Thread(runnable, "t1").start();
new Thread(runnable, "t2").start();
```

å¦‚æœReentrantLockæ„é€ å‡½æ•°ä¼ å…¥çš„æ˜¯trueï¼Œé‚£ä¹ˆä½¿ç”¨çš„æ˜¯å…¬å¹³é”ï¼Œæ‰“å°ç»“æœä¼šå‘ˆç°çº¿ç¨‹1å’Œçº¿ç¨‹2äº¤æ›¿è·å–åˆ°é”çš„æ ·å­ï¼›

### 

2.ReentraLockå®ç°é˜»å¡é˜Ÿåˆ—çš„æ¨¡å¼ï¼š

> https://gitee.com/dendi.ke/thread-demo/blob/master/src/main/java/com/gs/example/producerandconsumer/ProducerAndConsumerDemo2.java





### å¤šçº¿ç¨‹æ­»é”

**æ­»é”çš„åŸå› **

ä¸»è¦æ˜¯å› ä¸ºçº¿ç¨‹é”çš„ç­‰å¾…ï¼šæ¯”å¦‚æœ‰2ä¸ªçº¿ç¨‹ï¼Œéƒ½éœ€è¦è·å–2æŠŠé”æ‰èƒ½æ‰§è¡Œã€‚çº¿ç¨‹1è·å–äº†é”Aï¼Œçº¿ç¨‹2è·å–åˆ°äº†é”Bã€‚é‚£ä¹ˆçº¿ç¨‹1ä¸æ–­çš„åœ¨ç­‰é”Bï¼Œçº¿ç¨‹2ä¸æ–­çš„åœ¨ç­‰é”Aï¼Œå°±ä¼šå¯¼è‡´æ­»é”ã€‚

æ¨¡æ‹Ÿçš„å¤šçº¿ç¨‹æ­»é”Demoï¼š



atomicIntegeråŸå­ç±»



çº¿ç¨‹é€šä¿¡





## å®¹å™¨çš„å¹¶å‘

>  https://juejin.im/post/5aeebd02518825672f19c546

### Map

é¦–å…ˆç¡®å®šä¸€ç‚¹ï¼ŒHashMapæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼ŒåŸå› å¯ä»¥å‚è€ƒå¦ä¸€ç¯‡HashMapçš„åŸç†åˆ†æï¼›

ConcurrentMap

ConcurrentSkipListMap 

å‡ ä¸ªjavaå¸¸è§å®¹å™¨çš„æ¯”è¾ƒ

Mapï¼š

LinkedHashMapï¼šç»§æ‰¿äºHashMapï¼Œä¸»è¦ä¸ºäº†è§£å†³HashMapè¯»å–é¡ºåºä¸èƒ½å’Œæ’å…¥é¡ºåºä¸€è‡´çš„é—®é¢˜ã€‚

HashMap



### List

ArrayListæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ­¥addï¼Œä¼šå‡ºç°æ·»åŠ ä¸¢å¤±çš„é—®é¢˜ï¼›

å› ä¸ºArrayListçš„addæ–¹æ³•ä¸æ˜¯åŸå­æ“ä½œ, å¯èƒ½ä¼šå‡ºç°æ•°ç»„è¶Šç•Œæˆ–è€…æ•°æ®é‡å¤æ”¾åœ¨ä¸€ä¸ªä½ç½®ä¸Šé—®é¢˜ï¼›

```java
public boolean add(E e) {
  ensureCapacityInternal(size + 1);
  elementData[size++] = e;
  return true;
}
```

Vectoræ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼›



ConcurrentLinkedQueueï¼šæ˜¯çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—

add() å’Œ offer() çš„åŒºåˆ«ï¼š

add()å’Œoffer()éƒ½æ˜¯å‘é˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ªå…ƒç´ ã€‚å¦‚æœä¸€ä¸ªqueueæ˜¯æœ‰å¤§å°é™åˆ¶çš„ï¼Œè°ƒç”¨addæ–¹æ³•ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œè°ƒç”¨offeræ–¹æ³•ä¼šè¿”å›falseï¼›



#### ConcurrentSkipListSetï¼šæ˜¯æ’åºçš„é˜Ÿåˆ—ï¼›









### BlockingQueue



**LinkedBlockingQueue**

```java
/**
 * éœ€æ±‚ï¼šä½¿ç”¨blockQueueï¼Œæ¨¡æ‹Ÿç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…
 * @author keyang
 */
public class LinkedBlockQueue {
	
	private static LinkedBlockingQueue<String> queue = new LinkedBlockingQueue<>();
	
	public static void main(String[] args) {
		Random random = new Random();
		for (int i = 0; i < 2; i++) {
			new Thread(() -> {
				for (int j = 0; j < 100; j++) {
					try {
						queue.put(j + "");
						Thread.sleep(random.nextInt(1000));
					} catch (InterruptedException e) {
						e.printStackTrace();
					}
				}
			}, "p" + i).start();
		}
		
		for (int i = 0; i < 5; i++) {
			new Thread(() -> {
				while(true) {
					try {
						// å¦‚æœqueueç©ºäº†ï¼Œä¼šè‡ªåŠ¨é˜»å¡ç­‰å¾…
						String str = queue.take();
						System.out.println("æ¶ˆè´¹è€…å–å‡ºäº†" + str);
					} catch (InterruptedException e) {
						e.printStackTrace();
					}
				}
			}, "c" + i).start();
		}
	}
}
```



**ArrayBlockingQueue**

> ArrayBlockingQueueæ˜¯å¯ä»¥è®¾å®šç•Œé™çš„

**æ–¹æ³•åŒºåˆ«**ï¼š

putä¼šåœ¨é˜Ÿåˆ—æ»¡çš„æ—¶å€™ï¼Œé˜»å¡é˜Ÿåˆ—çš„åŠ å…¥ã€‚

addä¼šåœ¨é˜Ÿåˆ—æ»¡çš„æ—¶å€™æŠ›å‡ºå¼‚å¸¸

offerä¼šè¿”å›åˆ°åº•æ˜¯åŠ å…¥æˆåŠŸæˆ–è€…å¤±è´¥ï¼›



**DelayQueue**

åº”ç”¨åœºæ™¯ï¼š å¤„ç†ä¸€äº›å®šæ—¶ä»»åŠ¡ã€‚æ¯”å¦‚ç”µå•†ç³»ç»Ÿä¸­çš„è¶…æ—¶è®¢å•è‡ªåŠ¨å…³é—­ï¼›

ä½¿ç”¨ä»‹ç»ï¼šDelayQueueé˜Ÿåˆ—é‡Œæ·»åŠ çš„iteméœ€è¦å®ç°Delayedæ¥å£ï¼Œå®ç°2ä¸ªæ–¹æ³•ï¼šgetDelayã€compareTo

```java
public class DelayQueueDemo {
	static BlockingQueue<MyTask> queue = new DelayQueue<>();
	private static class MyTask implements Delayed {
		private long time;
		/**
		 * è¿”å›å½“å‰çš„å»¶è¿Ÿæ—¶é—´, longç±»å‹
		 * @param timeUnit
		 * @return
		 */
		@Override
		public long getDelay(TimeUnit timeUnit) {
			return timeUnit.convert(time - System.currentTimeMillis(), TimeUnit.MILLISECONDS);
		}
		/**
		 * æ¯”è¾ƒä¸¤ä¸ªtaskçš„è¶…æ—¶æ—¶é—´
		 * @param delayed
		 * @return
		 */
		@Override
		public int compareTo(Delayed delayed) {
			return (int) (this.getDelay(TimeUnit.MILLISECONDS) - delayed.getDelay(TimeUnit.MILLISECONDS));
		}
		public MyTask(long time) {
			this.time = time;
		}
		@Override
		public String toString() {
			return time + "";
		}
	}
}
```

DelayQueueæ˜¯ä¸€ä¸ªå­˜æ”¾å®ç°Delayedæ¥å£çš„æ•°æ®çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œåªæœ‰å½“æ•°æ®å¯¹è±¡çš„å»¶æ—¶æ—¶é—´è¾¾åˆ°æ—¶æ‰èƒ½æ’å…¥åˆ°é˜Ÿåˆ—è¿›è¡Œå­˜å‚¨ã€‚å¦‚æœå½“å‰æ‰€æœ‰çš„æ•°æ®éƒ½è¿˜æ²¡æœ‰è¾¾åˆ°åˆ›å»ºæ—¶æ‰€æŒ‡å®šçš„å»¶æ—¶æœŸï¼Œåˆ™é˜Ÿåˆ—æ²¡æœ‰é˜Ÿå¤´ï¼Œå¹¶ä¸”çº¿ç¨‹é€šè¿‡pollç­‰æ–¹æ³•è·å–æ•°æ®å…ƒç´ åˆ™è¿”å›nullã€‚

> é™„ï¼šå…¶ä»–çš„å®šæ—¶ä»»åŠ¡è§£å†³æ–¹æ¡ˆï¼›
>
> 1. ä½¿ç”¨æ•°æ®åº“å®šæ—¶ä»»åŠ¡ï¼Œæ¯éš”å‡ ç§’æ‰«æè®¢å•è¡¨ï¼Œæ‰¾å‡ºè¶…æ—¶è®¢å•åå…³é—­ã€‚
> 2. ä½¿ç”¨springçš„@Scheduledæ³¨è§£å¯åŠ¨å®šæ—¶ä»»åŠ¡æˆ–è€…ä½¿ç”¨Quartzä»»åŠ¡ç®¡ç†å™¨ï¼Œå®šæ—¶è§¦å‘ä»»åŠ¡ï¼Œå¤„ç†è¶…æ—¶è®¢å•ã€‚
> 3. ä½¿ç”¨æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œé€šè¿‡mqæä¾›çš„å»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸‹å•åå¾€å»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—ä¸­å‘æ¶ˆæ¯ï¼Œè¶…æ—¶åï¼Œæ¶ˆè´¹ç«¯ä¼šæ¥æ”¶åˆ°ä¸€æ¡å»¶è¿Ÿçš„è®¢å•æ¶ˆæ¯ï¼Œå¹¶åšç›¸åº”å¤„ç†ã€‚
> 4. æŒ‰éœ€å¤„ç†ã€‚åœ¨ç”¨æˆ·æŸ¥è¯¢çš„æ—¶å€™ï¼Œæ£€æµ‹è®¢å•æ˜¯å¦è¶…æ—¶ï¼Œè‹¥è¶…æ—¶ï¼Œåˆ™å…³é—­è®¢å•



**LinkedTransferQueue**

transferæ–¹æ³•å¿…é¡»ç›´æ¥ä¼ é€’ç»™æ¶ˆè´¹è€…ï¼Œå¦åˆ™æ–¹æ³•ä¼šé˜»å¡ä½ã€‚

takeæ–¹æ³•å¦‚æœæ²¡æœ‰å–å‡ºæ•°æ®ä¹Ÿä¼šè¢«é˜»å¡ã€‚

```java
TransferQueue<String> queue = new LinkedTransferQueue<String>();
		new Thread(() -> {
			try {
				System.out.println(queue.take());
			} catch (InterruptedException e) {
				e.printStackTrace();
			}
		}, "t1").start();
		try {
//			boolean a = queue.tryTransfer("transfer demo", 2, TimeUnit.SECONDS);
			queue.transfer("transfer demo");
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
	}
```



**SynchronousQueue**

> è¿™ä¸ªé˜»å¡é˜Ÿåˆ—çš„å®¹é‡æ˜¯0ï¼›éœ€è¦å…ˆå¯åŠ¨æ¶ˆè´¹è€…ï¼Œ
>
> takeæ–¹æ³•ä¼šé˜»å¡;
>
> putæ–¹æ³•éœ€è¦é©¬ä¸Šè¢«æ‹¿èµ°ï¼Œå¦åˆ™è¿›å…¥é˜»å¡çŠ¶æ€ã€‚åº•å±‚ä¹Ÿæ˜¯ç”¨TransferQueueæ¥å®ç°çš„;

```java
public class SynchronousQueueDemo {
	
	static SynchronousQueue<String> queue = new SynchronousQueue<>();
	
	public static void main(String[] args) {
		new Thread(() -> {
			try {
				System.out.println(queue.take());
			} catch (InterruptedException e) {
				e.printStackTrace();
			}
		}, "t1").start();
		try {
//			queue.put("SynchronousQueue");
			boolean offered = queue.offer("SynchronousQueue", 2, TimeUnit.SECONDS);
			System.out.println(offered);
		} catch (Exception e) {
			e.printStackTrace();
		}
	}
}
```







## çº¿ç¨‹æ± 

### 1.çº¿ç¨‹æ± æ¦‚è¿°

**çº¿ç¨‹æ± ä½œç”¨**ï¼šå¯ä»¥é¿å…çº¿ç¨‹çš„é¢‘ç¹çš„åˆ›å»ºå›æ”¶ï¼Œå‡å°‘ç³»ç»Ÿçš„å¼€é”€ï¼›

**APIä»‹ç»**ï¼šThreadPoolExecutor

**æ ¸å¿ƒå‚æ•°**ï¼š

| å‚æ•°            | æ„ä¹‰                     | è¯´æ˜                                   |
| --------------- | ------------------------ | -------------------------------------- |
| corePoolSize    | æ ¸å¿ƒçº¿ç¨‹æ•°é‡             | é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸»çº¿ç¨‹ä¸€ç›´å­˜åœ¨             |
| maximumPoolSize | æœ€å¤§çº¿ç¨‹æ•°é‡             | å½“çº¿ç¨‹è¾¾åˆ°æœ€å¤§æ•°é‡åï¼Œåç»­ä»»åŠ¡ä¼šè¢«é˜»å¡ |
| keepAliveTime   | çº¿ç¨‹ç©ºé—²æ—¶é—´             | è¶…è¿‡è¿™ä¸ªæ—¶é—´ï¼Œéä¸»çº¿ç¨‹ä¼šè¢«å›æ”¶         |
| unit            | ç©ºé—²æ—¶é—´å•ä½             |                                        |
| workQueue       | ä»»åŠ¡é˜Ÿåˆ—                 | ç”¨æ¥å­˜å‚¨executeä¼ å…¥çš„ä»»åŠ¡              |
| threadFactory   | çº¿ç¨‹å·¥å‚                 | ç”¨æ¥åˆ›å»ºçº¿ç¨‹ä»»åŠ¡ï¼Œå¯ä»¥æŒ‡å®šçº¿ç¨‹å       |
| rejectHandler   | RejectedExecutionHandler | å½“çº¿ç¨‹è¢«æ‹’ç»æ—¶ï¼Œæ”¾å…¥çš„é˜Ÿåˆ—ï¼›           |

```java
/**
 * çº¿ç¨‹æ± ç®¡ç†å™¨
 * @author keyang
 *
 */
public final class ThreadPoolManager {
 
 static ThreadPoolManager threadPoolManager = new ThreadPoolManager();
 
 static final int CORE_POOL_SIZE = 4;
 static final int MAX_POOL_SIZE = 5;
 static final int KEEP_ALIVE_TIME = 5;
 private static final int SIZE_WORK_QUEUE = 1;
 
 
 private ThreadPoolManager() {
 }
 
 public static ThreadPoolManager getInstance() {
  return threadPoolManager;
 }
 
 /**
  * ç”¨æ¥å­˜æ”¾æ’é˜Ÿçš„ä»»åŠ¡
  */
 private Queue<Runnable> mTaskQueue = new LinkedBlockingQueue<>();
 
 private final RejectedExecutionHandler myRejectHandler = new RejectedExecutionHandler() {
  
  @Override
  public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) {
   mTaskQueue.offer(r);
  }
 };
 
 private ScheduledExecutorService scheduledThreadPool = Executors.newScheduledThreadPool(1);
 
 /**
  * å®šæ—¶ä»æ’é˜Ÿä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡
  */
 private ScheduledFuture<?> scheduledFuture = scheduledThreadPool.scheduleAtFixedRate(new Runnable() {
  @Override
  public void run() {
   if (!mTaskQueue.isEmpty()) {
    threadPoolExecutor.execute(mTaskQueue.poll());
   }
  }
 }, 0, 5, TimeUnit.SECONDS);
 
 ThreadFactory namedThreadFactory = new ThreadFactoryBuilder().setNameFormat("Kyçº¿ç¨‹-%d").build();
 
 private final ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor(CORE_POOL_SIZE, MAX_POOL_SIZE, KEEP_ALIVE_TIME, TimeUnit.SECONDS, new ArrayBlockingQueue<Runnable>(SIZE_WORK_QUEUE),
  namedThreadFactory, myRejectHandler);
 
 public void addExecuteTask(Runnable task) {
  if (threadPoolExecutor != null) {
   threadPoolExecutor.execute(task);
  }
 }
 
 protected int getPoolSize() {
  return threadPoolExecutor.getPoolSize();
 }
 
 public void shutdown() {
  mTaskQueue.clear();
  scheduledThreadPool.shutdown();
  threadPoolExecutor.shutdown();
 }
}
```





### 2.åˆ›å»ºçº¿ç¨‹æ± çš„æ–¹å¼

JDKæä¾›äº†å¾ˆå¤šç§åˆ›å»ºçº¿ç¨‹æ± çš„æ–¹å¼, éƒ½æ˜¯é€šè¿‡Executorsçš„é™æ€æ–¹æ³•æ¥å®ç°ã€‚

#### FixedThreadPool

ç‰¹ç‚¹ï¼šåªæœ‰æ ¸å¿ƒçº¿ç¨‹æ•°é‡ï¼Œçº¿ç¨‹ä¸ä¼šè¢«å›æ”¶ï¼Œçº¿ç¨‹æ•°é‡æ˜¯å›ºå®šçš„ï¼Œä»»åŠ¡é˜Ÿåˆ—æ²¡æœ‰å¤§å°é™åˆ¶

ä½¿ç”¨åœºæ™¯ï¼šæ§åˆ¶çº¿ç¨‹çš„å¹¶å‘é‡



#### ScheduledThreadPool

ç‰¹ç‚¹ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°é‡å›ºå®šï¼Œéæ ¸å¿ƒçº¿ç¨‹æ•°é‡æ— é™åˆ¶

ä½¿ç”¨åœºæ™¯ï¼šæ‰§è¡Œå®šæœŸçš„ä»»åŠ¡

å†…éƒ¨é˜Ÿåˆ—æ˜¯DelayedWorkQueue



#### CachedThreadPool

ç‰¹ç‚¹ï¼šçº¿ç¨‹æ± å†…åªæœ‰éæ ¸å¿ƒçº¿ç¨‹ï¼Œçº¿ç¨‹æœ€å¤§æ•°é‡æ²¡æœ‰é™åˆ¶ï¼Œçº¿ç¨‹è¶…è¿‡ç©ºé—²æ—¶é—´åä¼šå› ä¸ºé—²ç½®è¢«å›æ”¶ã€‚ä»»åŠ¡é˜Ÿåˆ—é‡‡ç”¨çš„æ˜¯SynchronousQueueï¼ŒåŠ å…¥çš„ä»»åŠ¡ä¼šé©¬ä¸Šè¢«æ‰§è¡Œã€‚

ä½¿ç”¨åœºæ™¯ï¼šæ‰§è¡Œå¤§é‡ã€è€—æ—¶å°‘çš„ä»»åŠ¡



#### SingleThreadPool

ç‰¹ç‚¹ï¼šåªæœ‰ä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹ï¼Œä¿è¯çº¿ç¨‹ä»»åŠ¡æŒ‰ç…§é¡ºåºæ‰§è¡Œã€‚ä»»åŠ¡é˜Ÿåˆ—é‡‡ç”¨çš„æ˜¯LinkedBlockingQueueï¼Œåˆåªæœ‰1ä¸ªæ ¸å¿ƒçº¿ç¨‹å¤„ç†ï¼Œæ‰€ä»¥æ— éœ€å¤„ç†çº¿ç¨‹åŒæ­¥é—®é¢˜ï¼›

ä½¿ç”¨åœºæ™¯ï¼šå¤šä¸ªä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œã€‚



è¿™4ç§çº¿ç¨‹æ± åº•å±‚çš„åŸç†éƒ½æ˜¯é€šè¿‡ThreadPoolExecutorç±»æ¥å®ç°çš„ï¼›

å¦å¤–è¿˜æœ‰ä¸€äº›ç‰¹æ®Šçš„çº¿ç¨‹æ± ï¼š

#### ForkJoinPool

ç‰¹ç‚¹ï¼šä»–çš„æ ¸å¿ƒç†å¿µæ˜¯åˆ†è€Œæ²»ä¹‹ï¼Œä»–çš„ä½œç”¨å°±æ˜¯å°†ä¸€ä¸ªå¤§ä»»åŠ¡é€šè¿‡å¤šçº¿ç¨‹æ¥æ‹†åˆ†æˆå¤šå­ä»»åŠ¡ï¼›

ä½¿ç”¨åœºæ™¯ï¼šé€‚åˆåš1ä¸ªå¤§æ•°çš„è®¡ç®—ï¼›

```java
public class ForkJoinPoolDemo {

	static int MAX = 5000;
	
	private static class MyTask extends RecursiveAction {
		private int start;
		private int end;
		public MyTask(int start, int end) {
			this.start = start;
			this.end = end;
		}
		@Override
		protected void compute() {
			if ((end - start) < MAX) {
				System.out.println(Thread.currentThread().getName() + "ä»" + start + "åˆ°" + end + " = " + getSum(start, end));
			} else {
				MyTask task1 = new MyTask(start, (end + start) / 2);
				MyTask task2 = new MyTask((end + start) / 2 + 1, end);
//				task1.fork();
//				task2.fork();
				invokeAll(task1, task2);//æ‰§è¡Œç»™å®šçš„ä»»åŠ¡
				
			}
		}
	}
	
	private static class MyRecursiveTask extends RecursiveTask<Integer> {
		
		private int start;
		private int end;
		public MyRecursiveTask(int start, int end) {
			this.start = start;
			this.end = end;
		}
		@Override
		protected Integer compute() {
			if ((end - start) < MAX) {
				return getSum(start, end);
			} else {
				MyRecursiveTask task1 = new MyRecursiveTask(start, (end + start) / 2);
				MyRecursiveTask task2 = new MyRecursiveTask((end + start) / 2, end);
				task1.fork();
				task2.fork();
				return task1.join() + task2.join();
			}
		}
	}
	
	private static int getSum(int start, int end) {
		int sum = 0;
		for (int i = start; i < end; i++) {
			sum += i;
		}
		return sum;
	}
	public static void main(String[] args) {
		
		System.out.println(getSum(0, 100000));
		
		ForkJoinPool forkJoinPool = new ForkJoinPool();
//		MyTask myTask = new MyTask(0, 100000);
//		forkJoinPool.execute(myTask);
		
		MyRecursiveTask myRecursiveTask = new MyRecursiveTask(0, 100000);
		Future<Integer> future = forkJoinPool.submit(myRecursiveTask);
		try {
			System.out.println("å¤šçº¿ç¨‹æ‰§è¡Œç»“æœï¼š"+future.get());
			System.in.read();
		} catch (IOException | InterruptedException | ExecutionException e) {
			e.printStackTrace();
		}
	}
}
```

**ä½¿ç”¨ä»‹ç»**ï¼šForkJoinPoolå®ä¾‹æœ‰ä¸¤ç§æ–¹æ³•ï¼šsubmitå’Œexecuteï¼Œä¼ å…¥çš„å‚æ•°ç±»å‹éƒ½æ˜¯ForkJoinTaskï¼›

ä½†æ˜¯executeæ–¹æ³•æ— è¿”å›å€¼ï¼Œè€Œsubmitæ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªFutureç±»çš„å®ä¾‹ã€‚

ForkJoinTaskæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒæœ‰2ä¸ªå­ç±»ï¼Œç‰¹ç‚¹ä¹Ÿæ˜¯å’Œsubmitå’Œexecuteæ–¹æ³•å¯¹åº”ã€‚

RecursiveAction çš„computeæ–¹æ³•æ˜¯æ— è¿”å›å€¼çš„

RecursiveTask çš„computeæ–¹æ³•æœ‰è¿”å›å€¼

**é«˜çº§ä½¿ç”¨**ï¼š

ä½¿ç”¨ForkJoinçš„æ€æƒ³æ¥å®ç°ä¸€ä¸ªå¿«é€Ÿæ’åº

https://gitee.com/dendi.ke/thread-demo/blob/master/src/main/java/com/gs/example/threadpool/ForkJoinPoolDemo2.java

â€‹	



### 3.çº¿ç¨‹æ± åŸç†åˆ†æ

**çº¿ç¨‹æ± é€»è¾‘**

![utf-8' '944365-90cfd4951a587ebd](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-14-112114.png)

å…ˆåˆ¤æ–­`çº¿ç¨‹æ•°é‡`æ˜¯å¦è¾¾åˆ°`æ ¸å¿ƒçº¿ç¨‹æ± æ•°é‡`æœ€å¤§é™åˆ¶ï¼›

å†åˆ¤æ–­çº¿ç¨‹çš„`ä»»åŠ¡é˜Ÿåˆ—æ•°é‡`æ˜¯å¦å·²æ»¡

æœ€åå†åˆ¤æ–­`çº¿ç¨‹æ•°é‡`æ˜¯å¦æ»¡è¶³`æœ€å¤§çº¿ç¨‹æ•°é‡`é™åˆ¶

**ä»»åŠ¡ä¸¢å¼ƒç­–ç•¥**
handlerï¼šè¡¨ç¤ºå½“æ‹’ç»å¤„ç†ä»»åŠ¡æ—¶çš„ç­–ç•¥ï¼Œæœ‰ä»¥ä¸‹å››ç§å–å€¼ï¼š 
ThreadPoolExecutor.AbortPolicy:ä¸¢å¼ƒä»»åŠ¡å¹¶æŠ›å‡ºRejectedExecutionExceptionå¼‚å¸¸ã€‚ 
ThreadPoolExecutor.DiscardPolicyï¼šä¹Ÿæ˜¯ä¸¢å¼ƒä»»åŠ¡ï¼Œä½†æ˜¯ä¸æŠ›å‡ºå¼‚å¸¸ã€‚ 
ThreadPoolExecutor.DiscardOldestPolicyï¼šä¸¢å¼ƒé˜Ÿåˆ—æœ€å‰é¢çš„ä»»åŠ¡ï¼Œç„¶åé‡æ–°å°è¯•æ‰§è¡Œä»»åŠ¡ï¼ˆé‡å¤æ­¤è¿‡ç¨‹ï¼‰ 
ThreadPoolExecutor.CallerRunsPolicyï¼šç”±è°ƒç”¨çº¿ç¨‹å¤„ç†è¯¥ä»»åŠ¡

**çº¿ç¨‹æ± å®¹é‡çš„åŠ¨æ€è°ƒæ•´**
ThreadPoolExecutoræä¾›äº†åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å®¹é‡å¤§å°çš„æ–¹æ³•ï¼šsetCorePoolSize()å’ŒsetMaximumPoolSize()ï¼Œ 
setCorePoolSizeï¼šè®¾ç½®æ ¸å¿ƒæ± å¤§å° 
setMaximumPoolSizeï¼šè®¾ç½®çº¿ç¨‹æ± æœ€å¤§èƒ½åˆ›å»ºçš„çº¿ç¨‹æ•°ç›®å¤§å° 
å½“ä¸Šè¿°å‚æ•°ä»å°å˜å¤§æ—¶ï¼ŒThreadPoolExecutorè¿›è¡Œçº¿ç¨‹èµ‹å€¼ï¼Œè¿˜å¯èƒ½ç«‹å³åˆ›å»ºæ–°çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚

**çº¿ç¨‹æ± å…³é—­åŸç†**ï¼š

a. éå†çº¿ç¨‹æ± ä¸­çš„æ‰€æœ‰å·¥ä½œçº¿ç¨‹
b. é€ä¸ªè°ƒç”¨çº¿ç¨‹çš„interrupt() ä¸­æ–­çº¿ç¨‹ï¼ˆæ³¨ï¼šæ— æ³•å“åº”ä¸­æ–­çš„ä»»åŠ¡å¯èƒ½æ°¸è¿œæ— æ³•ç»ˆæ­¢ï¼‰



**å…³é—­çº¿ç¨‹æ± æ–¹æ³•**ï¼š

- shutdownï¼ˆï¼‰

- shutdownNowï¼ˆï¼‰

**äºŒè€…åŒºåˆ«**ï¼š

- shutdownï¼šè®¾ç½® çº¿ç¨‹æ± çš„çŠ¶æ€ ä¸º SHUTDOWNï¼Œç„¶å**ä¸­æ–­**æ‰€æœ‰æ²¡æœ‰æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ã€‚å®ƒä¸ä¼šç«‹å³ç»ˆæ­¢çº¿ç¨‹æ± ï¼Œä½†æ˜¯å†ä¹Ÿä¸ä¼šæ¥å—æ–°çš„ä»»åŠ¡ 

- shutdownNowï¼šè®¾ç½® çº¿ç¨‹æ± çš„çŠ¶æ€ ä¸º STOPï¼Œç„¶åå°è¯•**æ‰“æ–­**æ‰€æœ‰çš„æ­£åœ¨æ‰§è¡Œæˆ–æš‚åœä»»åŠ¡çš„çº¿ç¨‹ï¼Œå¹¶ä¸”æ¸…ç©ºä»»åŠ¡ç¼“å­˜é˜Ÿåˆ—ï¼Œ**è¿”å›ç­‰å¾…æ‰§è¡Œä»»åŠ¡çš„åˆ—è¡¨**ã€‚


**ä½¿ç”¨å»ºè®®**ï¼š

ä¸€èˆ¬è°ƒç”¨shutdownï¼Œæ­£å¸¸çš„å…³é—­çº¿ç¨‹æ± ï¼Œ

è‹¥ä»»åŠ¡ä¸ä¸€å®šè¦æ‰§è¡Œå®Œï¼Œåˆ™è°ƒç”¨shutdownNow()



### 4.çº¿ç¨‹æ± åˆç†æ•°é‡é…ç½®
éµå¾ªä¸¤åŸåˆ™ï¼š 

1ã€å¦‚æœæ˜¯[CPUå¯†é›†å‹ä»»åŠ¡](#CPUå¯†é›†å‹ï¼ˆCPU-boundï¼‰)ï¼Œå°±éœ€è¦å°½é‡å‹æ¦¨CPUï¼Œå‚è€ƒå€¼å¯ä»¥è®¾ä¸º NCPU+1 
2ã€å¦‚æœæ˜¯[IOå¯†é›†å‹ä»»åŠ¡](#IOå¯†é›†å‹ï¼ˆI/O boundï¼‰)ï¼Œå‚è€ƒå€¼å¯ä»¥è®¾ç½®ä¸º2*NCPU 

å½“ç„¶ï¼Œè¿™åªæ˜¯ä¸€ä¸ªå‚è€ƒå€¼ï¼Œå…·ä½“çš„è®¾ç½®è¿˜éœ€è¦æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œè°ƒæ•´ï¼Œæ¯”å¦‚å¯ä»¥å…ˆå°†çº¿ç¨‹æ± å¤§å°è®¾ç½®ä¸ºå‚è€ƒå€¼ï¼Œå†è§‚å¯Ÿä»»åŠ¡è¿è¡Œæƒ…å†µå’Œç³»ç»Ÿè´Ÿè½½ã€èµ„æºåˆ©ç”¨ç‡æ¥è¿›è¡Œé€‚å½“è°ƒæ•´ã€‚




### 5.ExecutorServiceè§£æ

![ScheduledThreadPoolExecutorç±»çš„UMLå›¾.png](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-12-11-054840.png)

#### Executoræ¥å£

```java
package java.util.concurrent;

public interface Executor {
  // æ‰§è¡Œä»»åŠ¡
  void execute(Runnable var1);
}
```

é¡¶å±‚æ¥å£ï¼Œå¯ä»¥è°ƒç”¨execute(Runnable r)çš„æ–¹æ³•ã€‚



#### ExecutorServiceæ¥å£



#### Callableæ¥å£

ç±»ä¼¼äºRunnableæ¥å£ï¼ŒåŒºåˆ«æ˜¯Callableé‡Œé¢æ˜¯call() æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªæ³›å‹ã€‚Runnableé‡Œé¢è¯•run()æ–¹æ³•ï¼Œæ²¡æœ‰è¿”å›ã€‚



### 6.Executors

Executors æ˜¯ä¸€ä¸ªJavaä¸­çš„å·¥å…·ç±»ã€‚æä¾›å·¥å‚æ–¹æ³•æ¥åˆ›å»ºä¸åŒç±»å‹çš„çº¿ç¨‹æ± ã€‚

![img](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-12-11-034954.jpg)ï¿¼

ä»ä¸Šå›¾ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºï¼ŒExecutorsçš„åˆ›å»ºçº¿ç¨‹æ± çš„æ–¹æ³•ï¼Œåˆ›å»ºå‡ºæ¥çš„çº¿ç¨‹æ± éƒ½å®ç°äº†ExecutorServiceæ¥å£ã€‚å¸¸ç”¨æ–¹æ³•æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š

`newFiexedThreadPool(int Threads)`ï¼šåˆ›å»ºå›ºå®šæ•°ç›®çº¿ç¨‹çš„çº¿ç¨‹æ± ã€‚

`newCachedThreadPool()`ï¼šåˆ›å»ºä¸€ä¸ªå¯ç¼“å­˜çš„çº¿ç¨‹æ± ï¼Œè°ƒç”¨execute å°†é‡ç”¨ä»¥å‰æ„é€ çš„çº¿ç¨‹ï¼ˆå¦‚æœçº¿ç¨‹å¯ç”¨ï¼‰ã€‚å¦‚æœæ²¡æœ‰å¯ç”¨çš„çº¿ç¨‹ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹å¹¶æ·»åŠ åˆ°æ± ä¸­ã€‚ç»ˆæ­¢å¹¶ä»ç¼“å­˜ä¸­ç§»é™¤é‚£äº›å·²æœ‰ 60 ç§’é’Ÿæœªè¢«ä½¿ç”¨çš„çº¿ç¨‹ã€‚

`newSingleThreadExecutor()`åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹åŒ–çš„Executorã€‚

`newScheduledThreadPool(int corePoolSize)`åˆ›å»ºä¸€ä¸ªæ”¯æŒå®šæ—¶åŠå‘¨æœŸæ€§çš„ä»»åŠ¡æ‰§è¡Œçš„çº¿ç¨‹æ± ï¼Œå¤šæ•°æƒ…å†µä¸‹å¯ç”¨æ¥æ›¿ä»£Timerç±»ã€‚

ç±»çœ‹èµ·æ¥åŠŸèƒ½è¿˜æ˜¯æ¯”è¾ƒå¼ºå¤§çš„ï¼Œåˆç”¨åˆ°äº†å·¥å‚æ¨¡å¼ã€åˆæœ‰æ¯”è¾ƒå¼ºçš„æ‰©å±•æ€§ï¼Œé‡è¦çš„æ˜¯ç”¨èµ·æ¥è¿˜æ¯”è¾ƒæ–¹ä¾¿ï¼Œå¦‚ï¼š

```text
ExecutorService executor = Executors.newFixedThreadPool(nThreads) ;
```

å³å¯åˆ›å»ºä¸€ä¸ªå›ºå®šå¤§å°çš„çº¿ç¨‹æ± ã€‚

ä½†æ˜¯Alibabaç¦æ­¢ä½¿ç”¨Executorsæ¥åˆ›å»ºçº¿ç¨‹æ± ï¼›

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-12-11-035540.jpg" alt="img" style="zoom: 25%;" />

å¯ä»¥çœ‹åˆ°ï¼Œæ‰‹å†Œä¸­æåˆ°Executorsåˆ›å»ºçš„çº¿ç¨‹æ± ä¼šé€ æˆOOMï¼ˆOut of Memoryï¼‰ã€‚

ä¸ºä»€ä¹ˆä¼šé€ æˆOOMå‘¢ï¼Ÿä¸ºäº†ç†è§£è¿™ä¸ªæ–‡æ¡£ï¼Œå†™äº†ä¸ªä¾‹å­ï¼š

```java
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

@SuppressWarnings("AlibabaThreadPoolCreation")
public class OOMDemo {
  // LinkedBlockingQueue
  private ExecutorService executorService1 = Executors.newFixedThreadPool(15);
  // LinkedBlockingQueue
  private ExecutorService executorService2 = Executors.newSingleThreadExecutor();
  
  // SynchronousQueue
  private ExecutorService executorService3 = Executors.newCachedThreadPool();
  // DelayedWorkQueue
  private ExecutorService executorService4 = Executors.newScheduledThreadPool(15);
  
  public static void main(String[] args) {
    
    new OOMDemo().createThread();
  }
  
  public void createThread() {
    for (int i = 0; i < Integer.MAX_VALUE; i++) {
      executorService1.execute(new Runnable() {
        @Override
        public void run() {
          try {
            Thread.sleep(10000);
          } catch (InterruptedException e) {
            e.printStackTrace();
          }
        }
      });
    }
  }
}

```
è¿è¡Œæ—¶è®¾ç½®jvmå‚æ•°ï¼š-Xmx8m -Xms8m 

![image-20191211135706201](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-12-11-055706.png)









## çº¿ç¨‹é”

>å‚è€ƒï¼šhttps://zhuanlan.zhihu.com/p/71156910?utm_source=wechat_session&utm_medium=social&utm_oi=722156590005776384

javaé‡Œé¢é”ä¸»è¦çš„ä½œç”¨å°±æ˜¯è§£å†³å¤šçº¿ç¨‹çš„å®‰å…¨æ€§é—®é¢˜ï¼›javaé‡Œæœ‰2ç§åŠ é”çš„æ–¹å¼ï¼š

1.synchronizeå…³é”®å­—ã€‚è¿™ç§æ–¹å¼å†™ä»£ç å¾ˆç®€å•ï¼Œä½†ç›¸å¯¹çš„ï¼Œå®ƒä½¿ç”¨é”çš„çº§åˆ«ä¹Ÿå¾ˆé«˜ï¼›å¦‚æœå¯¹æ€§èƒ½æ²¡æœ‰è¦æ±‚ï¼Œé‚£ä¹ˆä¸€èˆ¬éƒ½ä¼šç”¨synchronizeå…³é”®æ¥åŠ é”

2.Lockå®ç°ç±»ã€‚å¦ä¸€ç§æ–¹å¼å°±æ˜¯ç”¨javaçš„`Lock`ã€‚Lockæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¥¹çš„å®ç°ç±»åœ¨ä»£ç å±‚é¢å®ç°äº†é”çš„åŠŸèƒ½ã€‚å¸¸ç”¨çš„å®ç°ç±»å¦‚ä¸‹ï¼š

ReentrantLockç±»ï¼ŒReadLockç±»ï¼ŒWriteLockç±»ï¼›



![v2-ddb71ab0b68d65ae70244bfdeb0d6704_hd](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-16-133806.jpg)



### Synchronized  å’Œ lockçš„åŒºåˆ«

synchronizeæ˜¯javaçš„å…³é”®å­—ï¼Œå¯ä»¥ç”¨æ¥ä¿®é¥°æ–¹æ³•ã€ä»£ç å—ç­‰ã€‚ä¸»è¦ç›®çš„æ˜¯ä¿è¯æ–¹æ³•æˆ–è€…æ–¹æ³•å—æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

lockæ˜¯javaæä¾›çš„ä¸€ä¸ªæ¥å£ï¼Œä»–æœ‰å¾ˆå¤šå®ç°ç±»ã€å¸¸ç”¨åˆ°çš„æ¯”å¦‚ReentantLockã€ReentraReadWriteLockç­‰ã€‚å®ƒä»¬å¯ä»¥çµæ´»çš„ä½¿ç”¨ï¼Œä¸»è¦ä¹Ÿæ˜¯ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

æ‰‹åŠ¨ä½¿ç”¨lockéœ€è¦æ³¨æ„å‡ ç‚¹ï¼š

1.lockå¿…é¡»æ‰‹åŠ¨é‡Šæ”¾unlockï¼Œè€Œsynchronizeä¼šè‡ªåŠ¨é‡Šæ”¾é”ï¼›

2.lockå¯ä»¥å®ç°å…¬å¹³é”ï¼Œè€Œsynchronizeæ˜¯éå…¬å¹³çš„

3.lockçš„è·å–å¯ä»¥çµæ´»åˆ¤æ–­ï¼Œsynchronizeçš„é”è·å–åªèƒ½ä¸€ç›´ç­‰å¾…ã€‚



### æ‚²è§‚é”&ä¹è§‚é”

é”çš„ä¸€ç§å®è§‚åˆ†ç±»æ–¹å¼ã€‚æ˜¯æŒ‡åœ¨å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œä¸¤ç§ç­–ç•¥ï¼›

**æ‚²è§‚é”**ï¼šå½“å¤šä¸ªçº¿ç¨‹æœ‰ç«äº‰å…³ç³»æ—¶ï¼Œæˆ‘ä»¬æ€»æ˜¯è®¤ä¸ºæŸä¸ªå…±äº«æ•°æ®ä¼šè¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼ˆ**å¾ˆæ‚²è§‚**ï¼‰ï¼›æ‰€ä»¥éœ€è¦ç”¨åˆ°å…±äº«æ•°æ®çš„çº¿ç¨‹å°±å»æŠŠæ•°æ®åŠ ä¸€æŠŠé”ï¼Œè¿™æ ·åˆ«çš„çº¿ç¨‹å°±åªèƒ½ç­‰å¾…å½“å‰çº¿ç¨‹é‡Šæ”¾é”åæ‰èƒ½ä½¿ç”¨ï¼›

**ä¹è§‚é”**ï¼šå½“çº¿ç¨‹ä¿®æ”¹æŸä¸€ä¸ªæ•°æ®æ—¶ï¼Œæ€»è®¤ä¸ºå½“å‰æ•°æ®ä¸ä¼šè¢«åˆ«çš„çº¿ç¨‹ä¿®æ”¹ï¼Œæ‰€ä»¥ä¸ä¼šå»åŠ é”ï¼ˆ**å¾ˆä¹è§‚**ï¼‰ã€‚å¦‚æœçº¿ç¨‹éœ€è¦æ›´æ–°æ•°æ®ï¼Œä¼šå»æ£€æŸ¥ä»æ•°æ®è¯»å–åˆ°æ›´æ–°è¿™æ®µæ—¶é—´ç±»ï¼Œæ•°æ®æœ‰æ²¡æœ‰å‘ç”Ÿä¿®æ”¹ã€‚å¦‚æœè¿™æœŸé—´æ•°æ®æ²¡æœ‰å˜åŒ–ï¼Œé‚£ä¹ˆå°±æ‰§è¡Œæ›´æ–°æ“ä½œï¼›å¦åˆ™å›æ»šæ“ä½œï¼Œé‡æ–°è¯»å–æ›´æ–°ä¸€éï¼Œå¹¶é‡å¤ä¸Šæ¬¡æ£€æŸ¥ï¼›

**ä½¿ç”¨åœºæ™¯æ¯”è¾ƒ**ï¼š

ä¹è§‚é”ä¸€èˆ¬é€‚ç”¨äº**å†™æ¯”è¾ƒå°‘**çš„æƒ…å†µä¸‹ï¼Œè¿™æ ·çº¿ç¨‹å†²çªçœŸçš„å¾ˆå°‘å‘ç”Ÿï¼Œå¯ä»¥çœå»åŠ é”çš„å¼€é”€ï¼›

æ‚²è§‚é”åˆ™æ¯”è¾ƒé€‚åˆå†²çªè¾ƒå¤šçš„æƒ…å†µï¼›



### CASæ— é”æœºåˆ¶

ä¹è§‚é”çš„åº•å±‚æœºåˆ¶å°±æ˜¯CASæœºåˆ¶ï¼š**Compare and Set**

1. é¦–å…ˆæ¯”è¾ƒå€¼ã€‚æ¯”å¦‚è¯»å–åˆ°ä¸€ä¸ªå€¼ä¸ºAï¼Œå¦‚æœåœ¨å°†Aæ›´æ–°ä¸ºBçš„è¿‡ç¨‹ä¸­ï¼Œæ£€æŸ¥Aæ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ã€‚
2. å¦‚æœç›¸åŒï¼Œé‚£ä¹ˆæ‰§è¡Œsetæ“ä½œï¼Œå°†å€¼æ›´æ–°ä¸ºBï¼›å¦åˆ™ä¸æ‰§è¡Œæ“ä½œï¼Œé‡æ–°è¯»å–å€¼ï¼›

ä¸Šé¢ä¸¤æ­¥æ˜¯åŸå­æ€§çš„ï¼Œåœ¨CPUçœ‹æ¥æ˜¯ä¸€æ­¥æ“ä½œï¼›

ä¹è§‚é”çš„æœºåˆ¶å°±æ˜¯CASçš„é‡è¯•ç®—æ³•ï¼Œæ•´ä¸ªè¿‡ç¨‹æ²¡æœ‰â€œåŠ é”â€å’Œâ€œè§£é”â€æ“ä½œï¼Œæ‰€ä»¥ä¹è§‚é”ç­–ç•¥ä¹Ÿè¢«ç§°ä¸º**æ— é”ç¼–ç¨‹**ã€‚

```java
// ä¼ªä»£ç 
	public volatile int value;

    public int getValue() {
        return value;
    }

    public final int getAndIncrement() {
        for(;;) {
            int current = getValue();
            int next = current + 1;
            // CASæ“ä½œ
            if (compareAndSet(current, next)) {
                return current;
            }
        }
    }

    public final int getAndDecrement() {
        for (;;) {
            int current = getValue();
            int next = current - 1;
            if (compareAndSet(current, next)) {
                return current;
            }
        }
    }
```



### è‡ªæ—‹é”

å½“çº¿ç¨‹å ç”¨æŸä¸€ä¸ªé”æ—¶ï¼Œå…¶ä»–çš„çº¿ç¨‹ä¼šä¸€ç›´ä¸æ–­çš„å¾ªç¯è·å–é”ï¼›æ€ä¹ˆç†è§£è¿™ä¸ªæ¦‚å¿µï¼Ÿéœ€è¦å…ˆäº†è§£ä¸€ä¸‹javaçš„synchronizeé”å‡çº§æœºåˆ¶ï¼š

#### synchronizedé”å‡çº§ï¼šåå‘é” â†’ è½»é‡çº§é” â†’ é‡é‡çº§é”

åˆæ¬¡æ‰§è¡Œåˆ°synchronizeä»£ç å—æ—¶ï¼Œä½¿ç”¨çš„æ˜¯åå‘é”ã€‚

å½“å…¶ä»–çº¿ç¨‹ä¹Ÿè¿›å…¥åˆ°synchronizeä»£ç å—æ—¶ï¼Œå¦‚æœè·å–ä¸åˆ°é”ï¼Œå°±ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚é”ä¼šå‡çº§ä¸ºè½»é‡çº§é”ï¼Œä¹Ÿå°±æ˜¯`è‡ªæ—‹é”`

è‡ªæ—‹é”ä¹Ÿæœ‰é™åˆ¶ï¼Œå› ä¸ºçº¿ç¨‹ä¸æ–­çš„ç©ºå¾ªç¯ä¹Ÿä¼šæ¶ˆè€—æ€§èƒ½ã€‚æ‰€ä»¥å½“çº¿ç¨‹å¾ªç¯çš„æ¬¡æ•°è¶…è¿‡ä¸€å®šæ¬¡æ•°ï¼Œçº¿ç¨‹ä¼šè¿›å…¥æŒ‚èµ·çŠ¶æ€ç­‰å¾…è¢«å”¤é†’ï¼Œè‡ªæ—‹é”ä¼šå‡çº§ä¸ºé‡é‡çº§é”ã€‚åé¢çš„çº¿ç¨‹å½“å‘ç°é”çº§åˆ«æ˜¯é‡é‡çº§é”æ—¶ï¼Œç›´æ¥æŒ‚èµ·ã€‚



### å¯é‡å…¥é”

> å¯ä»¥é‡å¤è·å–çš„é”ï¼›

synchronizeæ˜¯å¯é‡å…¥é”ã€‚å½“1ä¸ªçº¿ç¨‹æ‰§è¡ŒæŸä¸€ä¸ªsynchronizeä»£ç å—æ—¶ï¼Œå®ƒä¼šå…ˆè·å–åˆ°å¯¹è±¡çš„é”ã€‚å¦‚æœåœ¨è¿™ä¸ªä»£ç å—ä¸­è¿˜è°ƒç”¨äº†å¦ä¸€ä¸ªsynchronizeçš„æ–¹æ³•ï¼Œè¯¥çº¿ç¨‹å°±éœ€è¦å†æ¬¡ç”³è¯·è¿™ä¸ªå¯¹è±¡çš„é”ã€‚javaé‡Œæ˜¯å…è®¸è¿ç»­ä¸¤æ¬¡ç”³è¯·synchronizeé”ï¼Œé‡Šæ”¾é”æ—¶ä¹Ÿæ˜¯ä¾æ¬¡é‡Šæ”¾ï¼›

Javaè¿˜æä¾›äº†ä¸€ä¸ªReerantLockçš„å®ç°ç±»ï¼š`java.util.concurrent.locks.ReentrantLock`



### å¯ä¸­æ–­é”



### è¯»å†™é”

è¯»å†™é”æ˜¯ä¸€å¯¹å„¿é”ã€‚ä¸€ä¸ª`è¯»é”`å’Œä¸€ä¸ª`å†™é”`

**è¯»é”**ï¼šå…±äº«é”ï¼›

**å†™é”**ï¼šäº’æ–¥é”ï¼›

çº¿ç¨‹è¯»å–æ•°æ®æ—¶å€™ï¼ŒçŸ¥é“è‡ªå·±æ˜¯éœ€è¦åš==æ›´æ–°æ“ä½œ==è¿˜æ˜¯åš==åªè¯»æ“ä½œ==ã€‚å½“éœ€è¦æ›´æ–°æ—¶ï¼ŒåŠ å†™é”ï¼Œè¿™æ ·åˆ«çš„çº¿ç¨‹**æ— è®ºæ˜¯è¯»å–è¿˜æ˜¯å†™å…¥éƒ½ä¼šé˜»å¡**ã€‚å½“éœ€è¦è¯»å–æ—¶ï¼ŒåŠ è¯»é”ï¼Œå…¶ä»–çº¿ç¨‹å¦‚æœä¹Ÿè¦åŠ è¯»é”ï¼Œä¸éœ€è¦ç­‰å¾…ï¼Œå¯ä»¥ç›´æ¥è·å–ï¼Œä½†æ˜¯**è¯»é”è®¡æ•°å™¨è¦+1**ã€‚





## å¤šçº¿ç¨‹è®¾è®¡æ¨¡å¼

### çº¿ç¨‹å®‰å…¨çš„Singleton

```java
/**
 * çº¿ç¨‹å®‰å…¨çš„å•ä¾‹æ¨¡å¼
 * @author keyang
 */
public class SingletonDemo {
	
	private static SingletonDemo singletonDemo = null;
	
	private SingletonDemo() {
	
	}
	
	public static SingletonDemo getInstance() {
		
		if (singletonDemo == null) {
			synchronized (SingletonDemo.class) {
//			singletonDemo = new SingletonDemo();
				try {
					Thread.sleep(10000);
				} catch (InterruptedException e) {
					e.printStackTrace();
				}
			}
		}
		return singletonDemo;
	}
	
	public static void main(String[] args) {
		for (int i = 0; i < 1000; i++) {
			new Thread(() -> {
				SingletonDemo singletonDemo = SingletonDemo.getInstance();
				System.out.println(singletonDemo.hashCode());
			}).start();
		}
	}
}
```



å¤šçº¿ç¨‹æ¡†æ¶

aqs



#### CPUå¯†é›†å‹ï¼ˆCPU-boundï¼‰

CPUå¯†é›†å‹ä¹Ÿå«è®¡ç®—å¯†é›†å‹ï¼ŒæŒ‡çš„æ˜¯ç³»ç»Ÿçš„ç¡¬ç›˜ã€å†…å­˜æ€§èƒ½ç›¸å¯¹CPUè¦å¥½å¾ˆå¤šï¼Œæ­¤æ—¶ï¼Œç³»ç»Ÿè¿ä½œå¤§éƒ¨åˆ†çš„çŠ¶å†µæ˜¯CPU Loading 100%ï¼ŒCPUè¦è¯»/å†™I/O(ç¡¬ç›˜/å†…å­˜)ï¼ŒI/Oåœ¨å¾ˆçŸ­çš„æ—¶é—´å°±å¯ä»¥å®Œæˆï¼Œè€ŒCPUè¿˜æœ‰è®¸å¤šè¿ç®—è¦å¤„ç†ï¼ŒCPU Loadingå¾ˆé«˜ã€‚

åœ¨å¤šé‡ç¨‹åºç³»ç»Ÿä¸­ï¼Œå¤§éƒ¨ä»½æ—¶é—´ç”¨æ¥åšè®¡ç®—ã€é€»è¾‘åˆ¤æ–­ç­‰CPUåŠ¨ä½œçš„ç¨‹åºç§°ä¹‹CPU boundã€‚ä¾‹å¦‚ä¸€ä¸ªè®¡ç®—åœ†å‘¨ç‡è‡³å°æ•°ç‚¹ä¸€åƒä½ä»¥ä¸‹çš„ç¨‹åºï¼Œåœ¨æ‰§è¡Œçš„è¿‡ç¨‹å½“ä¸­ç»å¤§éƒ¨ä»½æ—¶é—´ç”¨åœ¨ä¸‰è§’å‡½æ•°å’Œå¼€æ ¹å·çš„è®¡ç®—ï¼Œä¾¿æ˜¯å±äºCPU boundçš„ç¨‹åºã€‚

CPU boundçš„ç¨‹åºä¸€èˆ¬è€Œè¨€CPUå ç”¨ç‡ç›¸å½“é«˜ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºä»»åŠ¡æœ¬èº«ä¸å¤ªéœ€è¦è®¿é—®I/Oè®¾å¤‡ï¼Œä¹Ÿå¯èƒ½æ˜¯å› ä¸ºç¨‹åºæ˜¯å¤šçº¿ç¨‹å®ç°å› æ­¤å±è”½æ‰äº†ç­‰å¾…I/Oçš„æ—¶é—´ã€‚

#### IOå¯†é›†å‹ï¼ˆI/O boundï¼‰

IOå¯†é›†å‹æŒ‡çš„æ˜¯ç³»ç»Ÿçš„CPUæ€§èƒ½ç›¸å¯¹ç¡¬ç›˜ã€å†…å­˜è¦å¥½å¾ˆå¤šï¼Œæ­¤æ—¶ï¼Œç³»ç»Ÿè¿ä½œï¼Œå¤§éƒ¨åˆ†çš„çŠ¶å†µæ˜¯CPUåœ¨ç­‰I/O (ç¡¬ç›˜/å†…å­˜) çš„è¯»/å†™æ“ä½œï¼Œæ­¤æ—¶CPU Loadingå¹¶ä¸é«˜ã€‚

I/O boundçš„ç¨‹åºä¸€èˆ¬åœ¨è¾¾åˆ°æ€§èƒ½æé™æ—¶ï¼ŒCPUå ç”¨ç‡ä»ç„¶è¾ƒä½ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºä»»åŠ¡æœ¬èº«éœ€è¦å¤§é‡I/Oæ“ä½œï¼Œè€Œpipelineåšå¾—ä¸æ˜¯å¾ˆå¥½ï¼Œæ²¡æœ‰å……åˆ†åˆ©ç”¨å¤„ç†å™¨èƒ½åŠ›ã€‚

#### CPUå¯†é›†å‹ vs IOå¯†é›†å‹

æˆ‘ä»¬å¯ä»¥æŠŠä»»åŠ¡åˆ†ä¸ºè®¡ç®—å¯†é›†å‹å’ŒIOå¯†é›†å‹ã€‚

è®¡ç®—å¯†é›†å‹ä»»åŠ¡çš„ç‰¹ç‚¹æ˜¯è¦è¿›è¡Œå¤§é‡çš„è®¡ç®—ï¼Œæ¶ˆè€—CPUèµ„æºï¼Œæ¯”å¦‚è®¡ç®—åœ†å‘¨ç‡ã€å¯¹è§†é¢‘è¿›è¡Œé«˜æ¸…è§£ç ç­‰ç­‰ï¼Œå…¨é CPUçš„è¿ç®—èƒ½åŠ›ã€‚è¿™ç§è®¡ç®—å¯†é›†å‹ä»»åŠ¡è™½ç„¶ä¹Ÿå¯ä»¥ç”¨å¤šä»»åŠ¡å®Œæˆï¼Œä½†æ˜¯ä»»åŠ¡è¶Šå¤šï¼ŒèŠ±åœ¨ä»»åŠ¡åˆ‡æ¢çš„æ—¶é—´å°±è¶Šå¤šï¼ŒCPUæ‰§è¡Œä»»åŠ¡çš„æ•ˆç‡å°±è¶Šä½ï¼Œæ‰€ä»¥ï¼Œè¦æœ€é«˜æ•ˆåœ°åˆ©ç”¨CPUï¼Œè®¡ç®—å¯†é›†å‹ä»»åŠ¡åŒæ—¶è¿›è¡Œçš„æ•°é‡åº”å½“ç­‰äºCPUçš„æ ¸å¿ƒæ•°ã€‚

è®¡ç®—å¯†é›†å‹ä»»åŠ¡ç”±äºä¸»è¦æ¶ˆè€—CPUèµ„æºï¼Œå› æ­¤ï¼Œä»£ç è¿è¡Œæ•ˆç‡è‡³å…³é‡è¦ã€‚Pythonè¿™æ ·çš„è„šæœ¬è¯­è¨€è¿è¡Œæ•ˆç‡å¾ˆä½ï¼Œå®Œå…¨ä¸é€‚åˆè®¡ç®—å¯†é›†å‹ä»»åŠ¡ã€‚å¯¹äºè®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Œæœ€å¥½ç”¨Cè¯­è¨€ç¼–å†™ã€‚

ç¬¬äºŒç§ä»»åŠ¡çš„ç±»å‹æ˜¯IOå¯†é›†å‹ï¼Œæ¶‰åŠåˆ°ç½‘ç»œã€ç£ç›˜IOçš„ä»»åŠ¡éƒ½æ˜¯IOå¯†é›†å‹ä»»åŠ¡ï¼Œè¿™ç±»ä»»åŠ¡çš„ç‰¹ç‚¹æ˜¯CPUæ¶ˆè€—å¾ˆå°‘ï¼Œä»»åŠ¡çš„å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨ç­‰å¾…IOæ“ä½œå®Œæˆï¼ˆå› ä¸ºIOçš„é€Ÿåº¦è¿œè¿œä½äºCPUå’Œå†…å­˜çš„é€Ÿåº¦ï¼‰ã€‚å¯¹äºIOå¯†é›†å‹ä»»åŠ¡ï¼Œä»»åŠ¡è¶Šå¤šï¼ŒCPUæ•ˆç‡è¶Šé«˜ï¼Œä½†ä¹Ÿæœ‰ä¸€ä¸ªé™åº¦ã€‚å¸¸è§çš„å¤§éƒ¨åˆ†ä»»åŠ¡éƒ½æ˜¯IOå¯†é›†å‹ä»»åŠ¡ï¼Œæ¯”å¦‚Webåº”ç”¨ã€‚



# æ–‡ä»¶å¥æŸ„

ä»€ä¹ˆæ˜¯æ–‡ä»¶å¥æŸ„ï¼Ÿ



# æ³¨è§£

1.æ³¨è§£æ¦‚è¿°

2.è‡ªå®šä¹‰æ³¨è§£

3.ä½¿ç”¨æ³¨è§£å®ç°ORMæ¡†æ¶(å¯¹è±¡å…³ç³»æ˜ å°„)



# è®¾è®¡æ¨¡å¼

1.loader

åœ¨å…¬å¸é‡Œé¢ï¼Œå› ä¸ºåå°çš„ä¸šåŠ¡æ¥å£é‡Œé¢æœ‰å¾ˆå¤šå…³è”æŸ¥è¯¢æ²¡æœ‰å¸¦å‡ºæ¥nameå­—æ®µï¼›

æ‰€ä»¥ä¸­é—´å±‚è¿™è¾¹è®¾è®¡äº†ä¸€ä¸ªç¼“å­˜æœºåˆ¶ï¼Œå°†å¾ˆå¤šnameç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚å½“å‰ç«¯æœåŠ¡éœ€è¦ç”¨åˆ°nameæ—¶å€™ï¼Œé€šè¿‡ç¼“å­˜å»è¿‡æ»¤åŠ¨æ€è®¾ç½®è¿™äº›nameã€‚

è¿™é‡Œæƒ³æ€»ç»“çš„ä¸æ˜¯ç¼“å­˜æœºåˆ¶ï¼Œè€Œæ˜¯åŠ è½½ç¼“å­˜ä»¥åŠæ›´æ–°ç¼“å­˜çš„ä¸€ç§è®¾è®¡ã€‚

é¦–å…ˆä¸Šå›¾ï¼š



æœåŠ¡ç«¯å¯åŠ¨æ—¶å€™ï¼Œå…ˆåŠ è½½å‡ºæœ‰å¤šå°‘loaderï¼Œæ¯ä¸ªloaderéƒ½ä»£è¡¨ç€éœ€è¦ç¼“å­˜çš„ç±»ã€‚æ¯ä¸ªç±»é‡Œé¢çš„executeæ–¹æ³•å„è‡ªå»å®ç°äº†è‡ªå·±åŠ è½½ç¼“å­˜çš„é€»è¾‘ã€‚

éœ€è¦æ›´æ–°ç¼“å­˜çš„è¯ï¼Œå…ˆé€šè¿‡mqæˆ–è€…redisçš„æ¶ˆæ¯è®¢é˜…æ¶ˆæ¯ï¼Œç„¶åæ¥é€šçŸ¥loaderå»é‡æ–°åŠ è½½ç¼“å­˜ã€‚

è¿™å¥—æ¨¡å¼å¯ä»¥ç”¨åœ¨åˆ†å¸ƒå¼çš„æ¶æ„é‡Œï¼Œå› ä¸ºæ¶ˆæ¯ä¸­é—´ä»¶å¾ˆå¥½çš„è§£è€¦äº†é€šçŸ¥æ¶ˆæ¯çš„ã€‚



é¥¿æ±‰å¼å†™æ³•

å·¥å‚æ¨¡å¼

ä»£ç†æ¨¡å¼

é™æ€ä»£ç†

JDKåŠ¨æ€ä»£ç†

CGLIBåŠ¨æ€ä»£ç†



# ç½‘ç»œç¼–ç¨‹

> https://gitee.com/dendi.ke/thread-demo/tree/master/src/main/java/com/gs/example/udp



## 1.ç½‘ç»œç¼–ç¨‹æ¦‚è¿°

ç½‘ç»œç¼–ç¨‹åº•å±‚å°±æ˜¯å­—èŠ‚çš„ä¼ è¾“

### **åŸºç¡€æ•°æ®ç»“æ„**

`byte`æ˜¯ç½‘ç»œä¼ è¾“ä¸­æœ€åŸºæœ¬çš„æ•°æ®ç±»å‹

1byteå `8ä½`2è¿›åˆ¶æ•°ï¼Œå¤§å°èŒƒå›´æ˜¯ -127 ~ 127.  (2^7 -1)  



charå’Œbyteå¯ä»¥ç›¸å…³è½¬æ¢

1short = 2byte

boolean=1byte

int = 4byte

long = 8byte

float = 4byte

double=8byte

stringå­—ç¬¦é•¿åº¦å¯å˜



### æºç ã€è¡¥ç ã€åç 

> http://ckjava.com/2018/05/03/java-byte-0XFF/

åœ¨ç½‘ç»œç¼–ç¨‹çš„è¿‡ç¨‹ä¸­ï¼Œå‡ºç°äº†ä¸€äº›`ä½æ“ä½œ`ï¼Œè¿˜åŒ…æ‹¬äº†ä¸€äº›ä¸ã€æˆ–æ“ä½œï¼Œæ‰€ä»¥åœ¨è¿™é‡Œåšä¸€äº›ç¬”è®°ã€‚

#### 1. åŸç 

åŸç å°±æ˜¯ç¬¦å·ä½åŠ ä¸ŠçœŸå€¼çš„ç»å¯¹å€¼, å³ç”¨ç¬¬ä¸€ä½è¡¨ç¤ºç¬¦å·, å…¶ä½™ä½è¡¨ç¤ºå€¼. æ¯”å¦‚å¦‚æœæ˜¯8ä½äºŒè¿›åˆ¶:

```
[+1]åŸ = 0000 0001
[-1]åŸ = 1000 0001
```

ç¬¬ä¸€ä½æ˜¯ç¬¦å·ä½. å› ä¸ºç¬¬ä¸€ä½æ˜¯ç¬¦å·ä½, æ‰€ä»¥8ä½äºŒè¿›åˆ¶æ•°çš„å–å€¼èŒƒå›´å°±æ˜¯:

```
[1111 1111 , 0111 1111]
```

å³

```
[-127 , 127]
```

#### 2. åç 

åç çš„è¡¨ç¤ºæ–¹æ³•æ˜¯:

æ­£æ•°çš„åç æ˜¯å…¶æœ¬èº«

è´Ÿæ•°çš„åç æ˜¯åœ¨å…¶åŸç çš„åŸºç¡€ä¸Š, ç¬¦å·ä½ä¸å˜ï¼Œå…¶ä½™å„ä¸ªä½å–å.

```
[+1] = [00000001]åŸ = [00000001]å
[-1] = [10000001]åŸ = [11111110]å
```

å¯è§å¦‚æœä¸€ä¸ªåç è¡¨ç¤ºçš„æ˜¯è´Ÿæ•°, äººè„‘æ— æ³•ç›´è§‚çš„çœ‹å‡ºæ¥å®ƒçš„æ•°å€¼. é€šå¸¸è¦å°†å…¶è½¬æ¢æˆåŸç å†è®¡ç®—.

#### 3. è¡¥ç 

è¡¥ç çš„è¡¨ç¤ºæ–¹æ³•æ˜¯:

æ­£æ•°çš„è¡¥ç å°±æ˜¯å…¶æœ¬èº«

è´Ÿæ•°çš„è¡¥ç æ˜¯åœ¨å…¶åŸç çš„åŸºç¡€ä¸Š, ç¬¦å·ä½ä¸å˜, å…¶ä½™å„ä½å–å, æœ€å+1. (å³åœ¨åç çš„åŸºç¡€ä¸Š+1)

è¡¥ç è½¬æ¢ä¸ºåŸç ï¼šç¬¦å·ä½ä¸å˜ï¼Œæ•°å€¼ä½æŒ‰ä½å–å,æœ«ä½å†åŠ 1ã€‚(è¡¥ç çš„è¡¥ç å°±æ˜¯æºç )

```
[+1] = [00000001]åŸ = [00000001]å = [00000001]è¡¥
[-1] = [10000001]åŸ = [11111110]å = [11111111]è¡¥
```

ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°, å¯¹äºæ­£æ•°: åŸç , åç , è¡¥ç éƒ½æ˜¯ä¸€æ ·çš„, å¯¹äºè´Ÿæ•°:åŸç , åç , è¡¥ç éƒ½ä¸ä¸€æ ·.



#### ä¸ºä½•è¦ä½¿ç”¨åŸç , åç å’Œè¡¥ç 

é¦–å…ˆ, å› ä¸ºäººè„‘å¯ä»¥çŸ¥é“ç¬¬ä¸€ä½æ˜¯ç¬¦å·ä½, åœ¨è®¡ç®—çš„æ—¶å€™æˆ‘ä»¬ä¼šæ ¹æ®ç¬¦å·ä½, é€‰æ‹©å¯¹çœŸå€¼åŒºåŸŸçš„åŠ å‡.

 ä½†æ˜¯å¯¹äºè®¡ç®—æœº, åŠ å‡ä¹˜æ•°å·²ç»æ˜¯æœ€åŸºç¡€çš„è¿ç®—, è¦è®¾è®¡çš„å°½é‡ç®€å•. è®¡ç®—æœºè¾¨åˆ«"ç¬¦å·ä½"æ˜¾ç„¶ä¼šè®©è®¡ç®—æœºçš„åŸºç¡€ç”µè·¯è®¾è®¡å˜å¾—ååˆ†å¤æ‚! 

äºæ˜¯äººä»¬æƒ³å‡ºäº†å°†ç¬¦å·ä½ä¹Ÿå‚ä¸è¿ç®—çš„æ–¹æ³•. æˆ‘ä»¬çŸ¥é“, æ ¹æ®è¿ç®—æ³•åˆ™å‡å»ä¸€ä¸ªæ­£æ•°ç­‰äºåŠ ä¸Šä¸€ä¸ªè´Ÿæ•°, å³: 1-1 = 1 + (-1) = 0 , æ‰€ä»¥æœºå™¨å¯ä»¥åªæœ‰åŠ æ³•è€Œæ²¡æœ‰å‡æ³•, è¿™æ ·è®¡ç®—æœºè¿ç®—çš„è®¾è®¡å°±æ›´ç®€å•äº†.

äºæ˜¯äººä»¬å¼€å§‹æ¢ç´¢ å°†ç¬¦å·ä½å‚ä¸è¿ç®—, å¹¶ä¸”åªä¿ç•™åŠ æ³•çš„æ–¹æ³•. é¦–å…ˆæ¥çœ‹åŸç :

è®¡ç®—åè¿›åˆ¶çš„è¡¨è¾¾å¼: 1-1=0

> 1 - 1 = 1 + (-1) = [00000001]åŸ + [10000001]åŸ = [10000010]åŸ = -2

å¦‚æœç”¨åŸç è¡¨ç¤º, è®©ç¬¦å·ä½ä¹Ÿå‚ä¸è®¡ç®—, æ˜¾ç„¶å¯¹äºå‡æ³•æ¥è¯´, ç»“æœæ˜¯ä¸æ­£ç¡®çš„.è¿™ä¹Ÿå°±æ˜¯ä¸ºä½•è®¡ç®—æœºå†…éƒ¨ä¸ä½¿ç”¨åŸç è¡¨ç¤ºä¸€ä¸ªæ•°.

ä¸ºäº†è§£å†³åŸç åšå‡æ³•çš„é—®é¢˜, å‡ºç°äº†åç :

è®¡ç®—åè¿›åˆ¶çš„è¡¨è¾¾å¼: 1-1=0

> 1 - 1 = 1 + (-1) = [0000 0001]åŸ + [1000 0001]åŸ= [0000 0001]å + [1111 1110]å = [1111 1111]å = [1000 0000]åŸ = -0

å‘ç°ç”¨åç è®¡ç®—å‡æ³•, ç»“æœçš„çœŸå€¼éƒ¨åˆ†æ˜¯æ­£ç¡®çš„. è€Œå”¯ä¸€çš„é—®é¢˜å…¶å®å°±å‡ºç°åœ¨"0"è¿™ä¸ªç‰¹æ®Šçš„æ•°å€¼ä¸Š. è™½ç„¶äººä»¬ç†è§£ä¸Š+0å’Œ-0æ˜¯ä¸€æ ·çš„, ä½†æ˜¯0å¸¦ç¬¦å·æ˜¯æ²¡æœ‰ä»»ä½•æ„ä¹‰çš„. è€Œä¸”ä¼šæœ‰[0000 0000]åŸå’Œ[1000 0000]åŸä¸¤ä¸ªç¼–ç è¡¨ç¤º0.

äºæ˜¯è¡¥ç çš„å‡ºç°, è§£å†³äº†0çš„ç¬¦å·ä»¥åŠä¸¤ä¸ªç¼–ç çš„é—®é¢˜:

> 1-1 = 1 + (-1) = [0000 0001]åŸ + [1000 0001]åŸ = [0000 0001]è¡¥ + [1111 1111]è¡¥ = [0000 0000]è¡¥=[0000 0000]åŸ

è¿™æ ·0ç”¨[0000 0000]è¡¨ç¤º, è€Œä»¥å‰å‡ºç°é—®é¢˜çš„-0åˆ™ä¸å­˜åœ¨äº†.è€Œä¸”å¯ä»¥ç”¨[1000 0000]è¡¨ç¤º-128:

> (-1) + (-127) = [1000 0001]åŸ + [1111 1111]åŸ = [1111 1111]è¡¥ + [1000 0001]è¡¥ = [1000 0000]è¡¥

-1-127çš„ç»“æœåº”è¯¥æ˜¯-128, åœ¨ç”¨è¡¥ç è¿ç®—çš„ç»“æœä¸­, [1000 0000]è¡¥ å°±æ˜¯-128. ä½†æ˜¯æ³¨æ„å› ä¸ºå®é™…ä¸Šæ˜¯ä½¿ç”¨ä»¥å‰çš„-0çš„è¡¥ç æ¥è¡¨ç¤º-128, æ‰€ä»¥-128å¹¶æ²¡æœ‰åŸç å’Œåç è¡¨ç¤º.(å¯¹-128çš„è¡¥ç è¡¨ç¤º[1000 0000]è¡¥ç®—å‡ºæ¥çš„åŸç æ˜¯[0000 0000]åŸ, è¿™æ˜¯**ä¸æ­£ç¡®**çš„)

ä½¿ç”¨è¡¥ç , ä¸ä»…ä»…ä¿®å¤äº†0çš„ç¬¦å·ä»¥åŠå­˜åœ¨ä¸¤ä¸ªç¼–ç çš„é—®é¢˜, è€Œä¸”è¿˜èƒ½å¤Ÿå¤šè¡¨ç¤ºä¸€ä¸ªæœ€ä½æ•°. è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ8ä½äºŒè¿›åˆ¶, ä½¿ç”¨åŸç æˆ–åç è¡¨ç¤ºçš„èŒƒå›´ä¸º[-127, +127], è€Œä½¿ç”¨è¡¥ç è¡¨ç¤ºçš„èŒƒå›´ä¸º[-128, 127].

å› ä¸ºæœºå™¨ä½¿ç”¨è¡¥ç , æ‰€ä»¥å¯¹äºç¼–ç¨‹ä¸­å¸¸ç”¨åˆ°çš„32ä½intç±»å‹, å¯ä»¥è¡¨ç¤ºèŒƒå›´æ˜¯: [-2^31, 2^31-1] å› ä¸ºç¬¬ä¸€ä½è¡¨ç¤ºçš„æ˜¯ç¬¦å·ä½.è€Œä½¿ç”¨è¡¥ç è¡¨ç¤ºæ—¶åˆå¯ä»¥å¤šä¿å­˜ä¸€ä¸ªæœ€å°å€¼.



### å…³äº`&ä¸`è¿ç®—

`&`è¿ç®—æ˜¯äºŒè¿›åˆ¶æ•°æ®çš„è®¡ç®—æ–¹å¼, ä¸¤ä¸ªæ“ä½œä½éƒ½ä¸º1ï¼Œç»“æœæ‰ä¸º1ï¼Œå¦åˆ™ç»“æœä¸º0. 

**ä¸ºä½•è¦ & 0xffï¼Ÿ**

å…¶æœ¬è´¨åŸå› å°±æ˜¯æƒ³ä¿æŒäºŒè¿›åˆ¶è¡¥ç çš„ä¸€è‡´æ€§ã€‚

åœ¨è®¡ç®—æœºä¸­ï¼Œæ•°æ®éƒ½æ˜¯ä»¥è¡¥ç çš„æ–¹å¼ä¿å­˜çš„ã€‚byteæœ‰8ä½ï¼Œè€Œintæœ‰32ä½ã€‚å½“byteè½¬æ¢ä¸ºintçš„æ—¶å€™ï¼Œè®¡ç®—æœºä¼šè‡ªåŠ¨è¿›è¡Œè¡¥ä½ã€‚ 

å¦‚æœæ˜¯è´Ÿæ•°ï¼Œé«˜ä½éƒ½ä¼šè¡¥1ï¼Œå¦‚æœæ˜¯æ­£æ•°ï¼Œé«˜ä½éƒ½ä¼šè¡¥0ï¼›

ä¸¾ä¸ªä¾‹å­ï¼š

> å½“å°†-127èµ‹å€¼ç»™a[0]æ—¶å€™ï¼Œa[0]ä½œä¸ºä¸€ä¸ªbyteç±»å‹ï¼Œå…¶è®¡ç®—æœºå­˜å‚¨çš„è¡¥ç æ˜¯10000001ï¼ˆ8ä½ï¼‰ã€‚

> å°†a[0] ä½œä¸ºintç±»å‹å‘æ§åˆ¶å°è¾“å‡ºçš„æ—¶å€™ï¼Œè®¡ç®—æœºåšäº†ä¸€ä¸ªè¡¥ä½çš„å¤„ç†ï¼Œå› ä¸ºintç±»å‹æ˜¯32ä½æ‰€ä»¥è¡¥ä½åçš„è¡¥ç å°±æ˜¯11111111 11111111 11111111 10000001ï¼ˆ32ä½ï¼‰ï¼Œè¿™ä¸ª32ä½äºŒè¿›åˆ¶è¡¥ç è¡¨ç¤ºçš„ä¹Ÿæ˜¯-127.

è™½ç„¶byte->intè®¡ç®—æœºèƒŒåå­˜å‚¨çš„äºŒè¿›åˆ¶è¡¥ç ç”±10000001ï¼ˆ8ä½ï¼‰è½¬åŒ–æˆäº†11111111 11111111 11111111 10000001ï¼ˆ32ä½ï¼‰å¾ˆæ˜¾ç„¶è¿™ä¸¤ä¸ªè¡¥ç è¡¨ç¤ºçš„åè¿›åˆ¶æ•°å­—ä¾ç„¶æ˜¯ç›¸åŒçš„ã€‚

ä½†æ˜¯è®¡ç®—æœºçš„äºŒè¿›åˆ¶ä¸ä»…ä»…åªç”¨æ¥è¡¨ç¤ºåè¿›åˆ¶æ•°ï¼Œåè¿›åˆ¶æ•°åªæ˜¯å®ƒçš„æ•°å€¼ï¼ŒäºŒè¿›åˆ¶æ‰ä»£è¡¨äº†è®¡ç®—æœºçœŸæ­£çš„æ•°æ®æ€§ã€‚

æˆ‘ä»¬å‘ç°ï¼Œå¦‚æœbyteè½¬æ¢ä¸ºintï¼Œè®¡ç®—æœºä¼šæ”¹å˜å®ƒçš„æ•°æ®æ€§ï¼Œå¯¼è‡´æ•°æ®å‘ç”Ÿäº†å˜åŒ–ã€‚é‚£ä¸ºäº†ä¿è¯äº†äºŒè¿›åˆ¶æ•°æ®æ€§ï¼Œæˆ‘ä»¬éœ€è¦å°†é«˜ä½è¡¥0ï¼Œä½8ä½ä¿æŒä¸å˜ã€‚æ‰€ä»¥éœ€è¦&0xffã€‚

å…¶å®å¦‚æœbyteæ˜¯æ­£æ•°é‚£ä¹ˆæ˜¯å¦è¿›è¡Œ&0xffç»“æœéƒ½ä¸€æ ·ï¼›å¦‚æœæ˜¯è´Ÿæ•°å°±ä¸€å®šéœ€è¦&0xffã€‚



å¦‚æœb[0]ä¸º `-10`, é‚£ä¹ˆå…¶åŸç è¡¨ç¤ºä¸º

> 00000000 00000000 00000000 10001010

åç ä¸º

> 11111111 11111111 11111111 11110101

è¡¥ç ä¸º ï¼ˆè®¡ç®—æœºå­˜å‚¨çš„æ•°å€¼ï¼‰

> 11111111 11111111 11111111 11110110 

è¿™ä¸ªæ—¶å€™å¦‚æœåšä½è¿ç®—ï¼Œæ•°æ®ä¼šé”™ä¹±ã€‚æ¯”å¦‚å³ç§»>>ï¼Œå¹³ç™½å¤šå‡ºäº†å¾ˆå¤š1.

`0XFF` è¡¨ç¤º16è¿›åˆ¶çš„æ•°æ®255, åŸç , åç , è¡¥ç éƒ½æ˜¯ä¸€æ ·çš„, å…¶äºŒè¿›åˆ¶æ•°æ®ä¸º

> 00000000 00000000 00000000 11111111

`0XFF` å’Œ `-10 `è¿›è¡Œ`&`è¿ç®—åç»“æœä¸ºï¼šï¼ˆè¡¥ç è¿›è¡Œè¿ç®—ï¼‰

> 11111111 11111111 11111111 11110110 & 00000000 00000000 00000000 11111111 = 00000000 00000000 00000000 11110110

è¿™æ ·å°±å¯ä»¥ä¿è¯äºŒè¿›åˆ¶æ•°æ®ä¸å˜ã€‚





### å…³äºä½ç§»è¿ç®—

**è®¡ç®—æœºä¸­å­˜çš„éƒ½æ˜¯æ•°çš„è¡¥ç **ï¼Œæ‰€ä»¥ä½ç§»è¿ç®—éƒ½æ˜¯å¯¹è¡¥ç è€Œè¨€çš„ã€‚

**<< å·¦ç§» ä½ä½è¡¥0**

**>> å³ç§» é«˜ä½è¡¥ç¬¦å·ä½ï¼Œå³ï¼šå¦‚æœç¬¦å·ä½æ˜¯1 å°±è¡¥1ï¼Œå¦‚æœç¬¦å·ä½æ˜¯0 å°±è¡¥0**

**>>>æ— ç¬¦å·å³ç§» ï¼Œé«˜ä½ç»Ÿä¸€è¡¥0**







## 2.TCPä¸UDPåŒºåˆ«

TCPåè®®æ˜¯==é¢å‘è¿æ¥==çš„é€šè®¯åè®®ï¼›å‘é€æ¶ˆæ¯æ—¶å¿…é¡»å»ºç«‹äº†è¿æ¥ï¼ˆ3æ¬¡æ¡æ‰‹ï¼‰ï¼Œé€šè®¯å®Œæˆæ—¶éœ€è¦æ–­å¼€è¿æ¥ï¼ˆ4æ¬¡æŒ¥æ‰‹ï¼‰ï¼›

TCPæ˜¯å¯é çš„ï¼ŒåŸºäºå­—èŠ‚æµçš„ä¼ è¾“åè®®ã€‚

è€ŒUDPåè®®æ˜¯é¢å‘æ— è¿æ¥çš„é€šè®¯åè®®ï¼Œæ²¡æœ‰severã€clientä¹‹åˆ†ï¼Œåªéœ€è¦çŸ¥é“å¯¹æ–¹çš„ipåœ°å€å’Œç«¯å£å·ï¼›

åŸºäºæ•°å­—æ•°æ®æŠ¥ä¼ è¾“ï¼›

UDPå¯ä»¥å®ç°å•æ’­ã€å¹¿æ’­ã€å¤šæ’­ï¼›

## 3.UDPå‘é€æ¶ˆæ¯

UDPæ²¡æœ‰severã€clientä¹‹åˆ†ï¼Œåœ¨javaå®ç°é‡Œï¼Œé€šè¿‡`DatagramSocket`ç±»å®ç°ã€‚

### å‘é€æ¶ˆæ¯çš„æ­¥éª¤

```mermaid
graph TD
a[å£°æ˜DatagramSocketå®ä¾‹]--> b[å£°æ˜æ¥å—æ¶ˆæ¯DatagramPacketå®ä¾‹]
b --> c[ç­‰å¾…æ¶ˆæ¯ ä¼šé˜»å¡]
c --> d[æ¥æ”¶åˆ°æ¶ˆæ¯ æ‹¿åˆ°å¯¹æ–¹ipå’Œç«¯å£å·]
d --> e[å›æŠ¥æ¶ˆæ¯]

```

ä»£ç å®ä¾‹ï¼šUdpProviderç›‘å¬åœ¨2000ç«¯å£æ¥å—æ¶ˆæ¯ï¼Œæ‰“å°æ¶ˆæ¯ï¼Œå›æŠ¥æ¶ˆæ¯ï¼›UdpSearchå‘Providerå‘é€æ¶ˆæ¯ï¼Œæ‰“å°å›æŠ¥æ¶ˆæ¯ï¼›

```java
/**
 * @author keyang
 */
public class UdpProvider {
	
	public static void main(String[] args) throws IOException {
		System.out.println("UdpProvideræœåŠ¡å¯åŠ¨æˆåŠŸ");
		
		DatagramSocket datagramSocket = new DatagramSocket(2000);
		byte[] bytes = new byte[512];
		DatagramPacket datagramPacket = new DatagramPacket(bytes, bytes.length);
		
		// This method blocks until a datagram is received
		datagramSocket.receive(datagramPacket);
		byte[] receivedBytes = datagramPacket.getData();
		String message = new String(receivedBytes, 0, datagramPacket.getLength(), "utf-8");
		System.out.println("UdpProvideræ¥å—åˆ°æ¶ˆæ¯ï¼š" + message + ", å­—èŠ‚é•¿åº¦ï¼š" + datagramPacket.getLength() + "ï¼Œç«¯å£å·ï¼š" + datagramPacket.getPort());
		// å›å†™æ¶ˆæ¯ï¼›
		InetAddress inetAddress = datagramPacket.getAddress();
		int port = datagramPacket.getPort();
		String responseMsg = "response from udp";
		DatagramPacket responsePack = new DatagramPacket(responseMsg.getBytes(), responseMsg.getBytes().length);
		responsePack.setAddress(inetAddress);
		responsePack.setPort(port);
		datagramSocket.send(responsePack);
		
		System.out.println("UdpProvideræœåŠ¡å…³é—­");
		
	}
}

/**
 * @author keyang
 */
public class UdpSearcher {
	
	public static void main(String[] args) throws IOException {
		System.out.println("UdpSearcheræœåŠ¡å¯åŠ¨æˆåŠŸ");
		// æœç´¢æ–¹å¯ä»¥ç»‘å®šä»»æ„ç«¯å£
		DatagramSocket datagramSocket = new DatagramSocket();
		String sendMsg = "ä½ å¥½ï¼ŒUDP";
		DatagramPacket sendPack = new DatagramPacket(sendMsg.getBytes(), sendMsg.getBytes().length);
		sendPack.setAddress(InetAddress.getLocalHost());
		sendPack.setPort(2000);
		datagramSocket.send(sendPack);
		
		// This method blocks until a datagram is received
		byte[] bytes = new byte[512];
		DatagramPacket receiverPack = new DatagramPacket(bytes, bytes.length);
		datagramSocket.receive(receiverPack);
		byte[] receivedBytes = receiverPack.getData();
		String message = new String(receivedBytes, 0, receiverPack.getLength(), "utf-8");
		System.out.println("UdpSearcheræ¥å—åˆ°æ¶ˆæ¯ï¼š" + message + ", å­—èŠ‚é•¿åº¦ï¼š" + receiverPack.getLength() + "ï¼Œç«¯å£å·ï¼š" + receiverPack.getPort());
		
		System.out.println("UdpSearcheræœåŠ¡å…³é—­");
		
	}
}

```



### UDPå¹¿æ’­æœç´¢

udpæœ€å¤§çš„ä¼˜ç‚¹æ˜¯å¯ä»¥å¹¿æ’­ä¿¡æ¯ï¼Œåªéœ€è¦å‘å±€åŸŸç½‘å¯¹åº”çš„å¹¿æ’­åœ°å€ä¼ è¾“ä¿¡æ¯å³å¯ã€‚å¹¿æ’­åœ°å€ä¸€èˆ¬æ ¹æ®ç½‘æ®µåœ°å€å’Œé»˜è®¤ç½‘å…³è®¡ç®—å‡ºæ¥ï¼Œå¤§éƒ¨åˆ†çš„å¹¿æ’­åœ°å€æ˜¯`255.255.255.255`;

**ä»£ç å®ä¾‹**ï¼šhttps://gitee.com/dendi.ke/thread-demo/blob/master/src/main/java/com/gs/example/udp/UdpProvider.java

udpSearchå‘å¹¿æ’­åœ°å€å‘é€2000ç«¯å£çš„æ¶ˆæ¯ï¼ŒudpProviderç›‘å¬2000ç«¯å£çš„ä¿¡æ¯ï¼Œæ¥æ”¶åˆ°æ¶ˆæ¯åå›æŠ¥ç»™udpSearchè‡ªèº«çš„ä¿¡æ¯ã€‚

```java

public class UdpProvider {
	
	public static void main(String[] args) throws IOException {
		System.out.println("UdpProvideræœåŠ¡å¯åŠ¨æˆåŠŸ");
		String sn = UUID.randomUUID().toString();
		ProviderThread providerThread = new ProviderThread(sn);
		providerThread.start();
		System.in.read();
		providerThread.close();
		System.out.println("UdpProvideræœåŠ¡å…³é—­");
	}
	
	private static class ProviderThread extends Thread {
		private boolean done;
		private final String sn;
		public ProviderThread(String sn) {
			super();
			this.sn = sn;
			this.done = false;
		}
		
		@Override
		public void run() {
			super.run();
			while (!done) {
				DatagramSocket datagramSocket = null;
				try {
					datagramSocket = new DatagramSocket(2000);
					byte[] bytes = new byte[512];
					DatagramPacket datagramPacket = new DatagramPacket(bytes, bytes.length);
					// This method blocks until a datagram is received
					datagramSocket.receive(datagramPacket);
					byte[] receivedBytes = datagramPacket.getData();
					String message = new String(receivedBytes, 0, datagramPacket.getLength(), "utf-8");
					System.out.println("UdpProvideræ¥å—åˆ°æ¶ˆæ¯ï¼š" + message + ", å­—èŠ‚é•¿åº¦ï¼š" + datagramPacket.getLength() + "ï¼Œç«¯å£å·ï¼š" + datagramPacket.getPort());
					// å›å†™æ¶ˆæ¯ï¼›
					InetAddress inetAddress = datagramPacket.getAddress();
					int port = MessageFactory.parsePort(message);
					String responseMsg = MessageFactory.generateString(sn);
					DatagramPacket responsePack = new DatagramPacket(responseMsg.getBytes(), responseMsg.getBytes().length);
					responsePack.setAddress(inetAddress);
					responsePack.setPort(port);
					datagramSocket.send(responsePack);
				} catch (SocketException e) {
					e.printStackTrace();
				} catch (UnsupportedEncodingException e) {
					e.printStackTrace();
				} catch (IOException e) {
					e.printStackTrace();
				} finally {
					datagramSocket.close();
				}
			}
		}
		
		void close() {
			done = true;
		}
	}
  
  public class UdpSearcher {
	
	private static int PORT = 3000;
	
	public static void main(String[] args) throws IOException, InterruptedException {
		System.out.println("UdpSearcheræœåŠ¡å¯åŠ¨æˆåŠŸ");
		SeacherThread listener = listen();
		search();
		// é˜»å¡ä¸»çº¿ç¨‹
		System.in.read();
		List<String> sns = listener.getSns();
		System.out.println("ç»„ç»‡è§£æ•£äº†ï¼Œç‰¹å·¥ä¸€å…±æœ‰ï¼š" + Arrays.toString(sns.toArray()));
		listener.close();
		System.out.println("UdpSearcheræœåŠ¡å…³é—­");
		
	}
	
	private static SeacherThread listen() throws InterruptedException {
		CountDownLatch countDownLatch = new CountDownLatch(1);
		SeacherThread seacherThread = new SeacherThread(countDownLatch);
		seacherThread.start();
		// ç­‰å¾…ç›‘å¬æœåŠ¡å¯åŠ¨å¥½
		countDownLatch.await();
		return seacherThread;
	}
	
	private static void search() throws IOException {
		// æœç´¢æ–¹å¯ä»¥ç»‘å®šä»»æ„ç«¯å£
		System.out.println("UDPSearcher sendBroadcast started.");
		DatagramSocket datagramSocket = new DatagramSocket();
		String sendMsg = MessageFactory.generatePort(PORT);
		DatagramPacket sendPack = new DatagramPacket(sendMsg.getBytes(), sendMsg.getBytes().length);
		sendPack.setAddress(InetAddress.getByName("255.255.255.255"));
		sendPack.setPort(2000);
		datagramSocket.send(sendPack);
		datagramSocket.close();
		System.out.println("UDPSearcher sendBroadcast end.");
	}
	
	private static class SeacherThread extends Thread {
		
		private boolean done;
		private final List<String> sns = new ArrayList<>();
		private final CountDownLatch countDownLatch;
		private DatagramSocket datagramSocket = null;
		
		public SeacherThread(CountDownLatch countDownLatch) {
			super();
			this.countDownLatch = countDownLatch;
			this.done = false;
		}
		
		@Override
		public void run() {
			System.out.println("UdpSearcher ç›‘å¬æœåŠ¡å¯åŠ¨æˆåŠŸ");
			countDownLatch.countDown();
			try {
				datagramSocket = new DatagramSocket(PORT);
				while (!done) {
					// This method blocks until a datagram is received
					byte[] bytes = new byte[512];
					DatagramPacket receiverPack = new DatagramPacket(bytes, bytes.length);
					datagramSocket.receive(receiverPack);
					byte[] receivedBytes = receiverPack.getData();
					String message = new String(receivedBytes, 0, receiverPack.getLength(), "utf-8");
					System.out.println("UdpSearcheræ¥å—åˆ°æ¶ˆæ¯ï¼š" + message + ", å­—èŠ‚é•¿åº¦ï¼š" + receiverPack.getLength() + "ï¼Œç«¯å£å·ï¼š" + receiverPack.getPort());
					String sn = MessageFactory.parseSn(message);
					if (sn != null) {
						sns.add(sn);
					}
				}
				System.out.println("UdpSearcher ç›‘å¬æœåŠ¡åœæ­¢");
			} catch (Exception ignored) {
			} finally {
				close();
			}
		}
		void close() {
			done = true;
			if (datagramSocket != null) {
				datagramSocket.close();
				datagramSocket = null;
			}
		}
		public List<String> getSns() {
			return sns;
		}
	}
  
```





## 4.TCP ï¼ˆTransmission Control Protocolï¼‰

**æ¦‚å¿µ**ï¼šåŸºäºè¿æ¥çš„ã€å¯é çš„ä¼ è¾“æ§åˆ¶åè®®ã€‚

**åº”ç”¨åœºæ™¯**ï¼š

- æ¶ˆæ¯ä¼ è¾“ã€æ¨é€ï¼›
- å•äººè¯­éŸ³ã€è§†é¢‘æ¶ˆæ¯ï¼›

- ä½†å¯ä»¥å®ç°udpæ‰€æœ‰çš„åŠŸèƒ½ï¼Œä½†æ˜¯æ— æ³•è¿›è¡Œå¹¿æ’­ã€å¤šæ’­ï¼›

### ä¸‰æ¬¡æ¡æ‰‹

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-05-134119.png" alt="image-20191105214118317" style="zoom:30%;" />

### å››æ¬¡æŒ¥æ‰‹

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-05-140334.png" alt="image-20191105220334062" style="zoom:30%;" />

ACKï¼šç¡®è®¤åºå·æœ‰æ•ˆã€‚ 

SYNï¼šå‘èµ·ä¸€ä¸ªæ–°è¿æ¥ã€‚

 FINï¼šé‡Šæ”¾ä¸€ä¸ªè¿æ¥ã€‚









### TCPå‘é€æ¶ˆæ¯ ï¼ˆå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ï¼‰

```mermaid
graph TD
subgraph å®¢æˆ·ç«¯
1[åˆ›å»ºsocket] --> 2[ç»‘å®šæœ¬åœ°ç«¯å£]
2 --> 3[connectè¿æ¥è¿œç¨‹å¥—æ¥å­—]
3 --> 31[send å‘é€æ¶ˆæ¯]
31 --> 32[receive æ¥æ”¶å›æŠ¥æ¶ˆæ¯]
32 --> 33[close å…³é—­è¿æ¥]
end
subgraph æœåŠ¡ç«¯
3 --> 6
31 --> 7
8 --> 32
4[åˆ›å»ºæœåŠ¡socket] --> 5[ç»‘å®šç›‘å¬ç«¯å£]
5 --> 6[Acceptç­‰å¾…æ¶ˆæ¯]
6 --> 7[Receiveæ¥æ”¶æ¶ˆæ¯]
7 --> 8[sendå›æŠ¥æ¶ˆæ¯]
end
```

TCP**çš„è¿æ¥å¯é æ€§åŸç†**

- 3æ¬¡æ¡æ‰‹â€”â€”ä¸ºä»€ä¹ˆæ˜¯3æ¬¡æ¡æ‰‹ï¼Ÿ

  ä¸‰æ¬¡æ¡æ‰‹ä¸»è¦æ˜¯ä¿è¯å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½èƒ½ç¡®è®¤ **è‡ªå·±çš„æ¶ˆæ¯èƒ½è¢«å¯¹æ–¹æ¥å—ï¼Œå¹¶ä¸”åˆ«äººçš„æ¶ˆæ¯èƒ½è¢«å¯¹æ–¹æ¥å—**ï¼›

  

- 4æ¬¡æŒ¥æ‰‹â€”â€”ä¸ºä»€ä¹ˆæ˜¯4æ¬¡æŒ¥æ‰‹ï¼Ÿ

  

  å››æ¬¡æŒ¥æ‰‹çš„ç¬¬äºŒæ¬¡å’Œç¬¬ä¸‰æ¬¡ä¹‹æ‰€ä»¥åˆ†å¼€ï¼Œå…¶å®æ˜¯å› ä¸ºæœ‰å¯èƒ½æœåŠ¡ç«¯æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„FINè¯·æ±‚æ—¶ï¼ŒæœåŠ¡ç«¯æ•°æ®å¹¶æ²¡æœ‰å‘é€å®Œï¼Œæˆ–è€…è¯´ä¸èƒ½é©¬ä¸Šå‘é€æœªå®Œæˆçš„æ•°æ®ã€‚è¿™ä¸ªæ—¶å€™å¹¶ä¸èƒ½ä¿è¯æœåŠ¡ç«¯èƒ½ç«‹é©¬å›å¤å®¢æˆ·ç«¯çš„FINä¿¡å·ï¼Œå› æ­¤æ¥æ”¶æ–¹çš„`ACKæ¶ˆæ¯`å’Œ`FINæ¶ˆæ¯`ä¸€èˆ¬åˆ†å¼€å‘é€ï¼Œæ‰€ä»¥æ˜¯4æ¬¡æŒ¥æ‰‹ã€‚

  > 2019.12.1 æ—¥è¡¥å……ï¼š

  TCPæ˜¯å…¨åŒå·¥æ¨¡å¼ï¼Œæ„å‘³ç€å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„å‘é€ã€æ¥æ”¶æ˜¯åˆ†å¼€çš„ï¼Œå› æ­¤æ¯ä¸ªæ–¹å‘çš„è¿æ¥éƒ½å¿…é¡»å•ç‹¬è¿›è¡Œå…³é—­ã€‚å®¢æˆ·ç«¯å‘èµ·ä¸»åŠ¨å…³é—­åï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯ä¸å†æœ‰æ•°æ®éœ€è¦å‘é€ï¼Œä½†æ˜¯å®¢æˆ·ç«¯ä»ç„¶å¯ä»¥æ¥æ”¶æœåŠ¡ç«¯çš„æ¶ˆæ¯ï¼›

  





- ä¸ºä»€ä¹ˆTIME_WAITçŠ¶æ€éœ€è¦ç»è¿‡2MSL(æœ€å¤§æŠ¥æ–‡æ®µç”Ÿå­˜æ—¶é—´)æ‰èƒ½è¿”å›åˆ°CLOSEçŠ¶æ€ï¼Ÿ

  ç­”ï¼šå› ä¸ºClientæœ€åçš„ACKå¯èƒ½ä¼šè¢«ä¸¢å¤±ï¼ŒServerå¦‚æœæ²¡æœ‰æ”¶åˆ°ACKï¼Œå°†ä¸æ–­é‡å¤å‘é€FINç‰‡æ®µã€‚æ‰€ä»¥Clientä¸èƒ½ç«‹å³å…³é—­ï¼Œå®ƒå¿…é¡»ç¡®è®¤Serveræ¥æ”¶åˆ°äº†è¯¥ACKã€‚

  æ‰€ä»¥TIME_WAITçŠ¶æ€å°±æ˜¯ç”¨æ¥é‡å‘å¯èƒ½ä¸¢å¤±çš„ACKæŠ¥æ–‡ã€‚

  Clientä¼šè®¾ç½®ä¸€ä¸ªè®¡æ—¶å™¨ï¼Œç­‰å¾…2MSLçš„æ—¶é—´ã€‚å¦‚æœåœ¨è¯¥æ—¶é—´å†…å†æ¬¡æ”¶åˆ°FINï¼Œé‚£ä¹ˆClientä¼šé‡å‘ACKå¹¶å†æ¬¡ç­‰å¾…2MSLã€‚æ‰€è°“çš„2MSLæ˜¯ä¸¤å€çš„MSL(Maximum Segment Lifetime)ã€‚MSLæŒ‡ä¸€ä¸ªç‰‡æ®µåœ¨ç½‘ç»œä¸­æœ€å¤§çš„å­˜æ´»æ—¶é—´ï¼Œ2MSLå°±æ˜¯ä¸€ä¸ªå‘é€å’Œä¸€ä¸ªå›å¤æ‰€éœ€çš„æœ€å¤§æ—¶é—´ã€‚å¦‚æœç›´åˆ°2MSLï¼ŒClientéƒ½æ²¡æœ‰å†æ¬¡æ”¶åˆ°FINï¼Œé‚£ä¹ˆClientæ¨æ–­ACKå·²ç»è¢«æˆåŠŸæ¥æ”¶ï¼Œåˆ™ç»“æŸTCPè¿æ¥ã€‚

  

TCP**çš„ä¼ è¾“å¯é æ€§åŸç†**

- æ’åºã€é¡ºåºå‘é€ã€é¡ºåºç»„è£…

  æ•°æ®åŒ…ä¼šè¢«åˆ†ç‰‡ï¼Œæ¥æ”¶æ–¹æ¥å—çš„é¡ºåºå¯èƒ½å’Œå‘é€é¡ºåºä¸åŒï¼Œæ‰€ä»¥æ¥å—ç«¯ä¼šå¯¹æ¥å—åˆ°çš„æ¶ˆæ¯é‡æ–°æ’åºï¼›

- ä¸¢å¼ƒã€è¶…æ—¶

  å½“æ•°æ®åŒ…å‡ºç°äº†ä¸¢åŒ…ï¼Œæˆ–è€…è¿æ¥è¢«æ–­å¼€çš„æƒ…å†µï¼Œtcpä¼šç»è¿‡ä¸€å®šçš„æ—¶é—´è¿›è¡Œé‡å‘ï¼›

- å®šæ—¶é‡å‘

  linuxçš„åˆ¤æ–­æ—¶é—´30sï¼Œå¦‚æœè¶…è¿‡30sæ²¡æœ‰å¾—åˆ°å›åº”ï¼Œå‘é€ç«¯ä¼šè®¤ä¸ºæ•°æ®ä¸¢å¤±äº†ï¼Œé‡æ–°å‘é€ï¼›

  



**ä½¿ç”¨ByteBufferæ¥å‘é€å„ç§ç±»å‹çš„æ¶ˆæ¯**

**TCPæ¡ˆä¾‹**

```java
// server
public class MySocketServer {
	public static final int PORT = 20000;
	public static void main(String[] args) throws UnknownHostException {
		try {
			ServerSocket server = new ServerSocket();
			initSocketServer(server);
			server.bind(new InetSocketAddress(InetAddress.getLocalHost(),PORT));
			System.out.println("æœåŠ¡ç«¯å¯åŠ¨å°±ç»ªï¼Œç­‰å¾…è¿æ¥");
			while(true) {
				Socket client = server.accept();
				ClientHandleThread clientHandleThread = new ClientHandleThread(client);
				clientHandleThread.start();
			}
		} catch (IOException e) {
			e.printStackTrace();
		}
	}
	
	private static void initSocketServer(ServerSocket server) throws SocketException {
			server.setSoTimeout(60 * 1000);
			server.setReuseAddress(true);
			// bufferSize: é»˜è®¤æ˜¯8kbyte = 8*1024
			server.setReceiveBufferSize(64 * 1024 * 1024);
	}
	
	private static class ClientHandleThread extends Thread{
		private final Socket client;
		public ClientHandleThread(Socket client) {
			this.client = client;
		}
		@Override
		public void run() {
			super.run();
			System.out.println("å®¢æˆ·ç«¯è¿æ¥æˆåŠŸ");
			
			InputStream inputStream = null;
			try {
				inputStream = client.getInputStream();
				byte[] buffer = new byte[256];
				int size = inputStream.read(buffer);
				ByteBuffer byteBuffer = ByteBuffer.wrap(buffer);
				// æŒ‰é¡ºåºè·å–æ•°æ®
				byte byteMsg = byteBuffer.get();
				char charMsg = byteBuffer.getChar();
				short shortMsg = byteBuffer.getShort();
				int intMsg = byteBuffer.getInt();
				long longMsg = byteBuffer.getLong();
				String stringMsg = new String(buffer, byteBuffer.position(), size - byteBuffer.position() - 1);
				System.out.println("æœåŠ¡ç«¯æ¥æ”¶åˆ°ï¼š" + byteMsg);
				System.out.println("æœåŠ¡ç«¯æ¥æ”¶åˆ°ï¼š" + charMsg);
				System.out.println("æœåŠ¡ç«¯æ¥æ”¶åˆ°ï¼š" + shortMsg);
				System.out.println("æœåŠ¡ç«¯æ¥æ”¶åˆ°ï¼š" + intMsg);
				System.out.println("æœåŠ¡ç«¯æ¥æ”¶åˆ°ï¼š" + longMsg);
				System.out.println("æœåŠ¡ç«¯æ¥æ”¶åˆ°ï¼š" + stringMsg);
				
			} catch (IOException e) {
				e.printStackTrace();
			} finally {
				if (inputStream != null) {
					try {
						inputStream.close();
					} catch (IOException e) {
						e.printStackTrace();
					}
				}
			}
			System.out.println("å®¢æˆ·ç«¯è¿æ¥æ–­å¼€");
		}
	}
}

// client
public class MySocketClient {
	private static final int CLIENT_PORT = 20001;
	
	public static void main(String[] args) throws IOException {
		Socket socket = new Socket();
		
		initClientSocket(socket);
		socket.connect(new InetSocketAddress(InetAddress.getLocalHost(), MySocketServer.PORT));
		System.out.println("å®¢æˆ·ç«¯è¿æ¥æˆåŠŸ");
		try {
			sendMessage(socket);
			// é‡Šæ”¾èµ„æº
			socket.close();
			System.out.println("å®¢æˆ·ç«¯å·²é€€å‡ºï½");
		} catch (Exception e) {
			e.printStackTrace();
			System.out.println("å®¢æˆ·ç«¯å¼‚å¸¸é€€å‡ºï½");
		}
	}
	
	private static void sendMessage(Socket socket) throws IOException {
		// å‘æœåŠ¡å™¨å‘é€æ•°æ®
		byte[] buffer = new byte[256];
		OutputStream outputStream = socket.getOutputStream();
		// ä½¿ç”¨ByteBuffer
		ByteBuffer byteBuffer = ByteBuffer.wrap(buffer);
		byte byteMsg = 125;
		char charMsg = 'a';
		short shortMsg = 4343;
		int intMsg = 34343243;
		long longMsg = 3234827524L;
		byteBuffer.put(byteMsg);
		byteBuffer.putChar(charMsg);
		byteBuffer.putShort(shortMsg);
		byteBuffer.putInt(intMsg);
		byteBuffer.putLong(longMsg);
		String msg = "ä½ å¥½ï¼ŒæœåŠ¡ç«¯";
		byteBuffer.put(msg.getBytes());
		outputStream.write(buffer, 0, byteBuffer.position() + 1);
	
		// æ¥æ”¶æœåŠ¡å™¨è¿”å›
		InputStream inputStream = socket.getInputStream();
		int read = inputStream.read(buffer);
		System.out.println("æ”¶åˆ°æ•°é‡ï¼š" + read);
		inputStream.close();
		outputStream.close();
	}
	
	private static void initClientSocket(Socket socket) throws IOException {
		socket.setKeepAlive(true);
		socket.setSoTimeout(5000);
//		socket.setSendBufferSize(64*1024*1024);
		socket.bind(new InetSocketAddress(InetAddress.getLocalHost(), CLIENT_PORT));	
	}
}
```



## 5.UDPè¾…åŠ©TCPè¿›è¡ŒæœåŠ¡å‘ç°

**å®ç°æ–¹æ¡ˆ**ï¼š

1. é¦–å…ˆï¼ŒæœåŠ¡ç«¯å®šä¹‰ç»Ÿä¸€çš„æœåŠ¡å‘ç°ç«¯å£ï¼š`PROVIDER_PORT`. æ¯”å¦‚è¯´æ˜¯ 30010ã€‚

2. æœåŠ¡ç«¯å¯åŠ¨server-socketæœåŠ¡ã€‚ç„¶åå¯åŠ¨UDP-DatagramSocketï¼Œç›‘å¬åœ¨`PROVIDER_PORT`ç«¯å£ä¸Š, å½“ç›‘å¬åˆ°å®¢æˆ·ç«¯å‘è¿™ä¸ªç«¯å£å¹¿æ’­çš„æ¶ˆæ¯ï¼Œå›é€æœåŠ¡ç«¯server-socketåœ°å€ï¼›
3. å®¢æˆ·ç«¯searcheré€šè¿‡udpå¹¿æ’­æ¥æœç´¢æœåŠ¡ã€‚å®ƒå‘å½“å‰å±€åŸŸç½‘å¹¿æ’­åœ°å€çš„30010ç«¯å£ä¸Šå¹¿æ’­æ¶ˆæ¯ï¼›
4. æœåŠ¡ç«¯æ¥å—åˆ°å¹¿æ’­æ¶ˆæ¯åï¼Œè§£ææ¶ˆæ¯ä½“ã€‚å¦‚æœæ˜¯ä¹‹å‰çº¦å®šå¥½çš„æ¶ˆæ¯æ ¼å¼ï¼Œé‚£ä¹ˆå°±é€šè¿‡udpåè®®ï¼Œå‘å‘é€è€…å›é€ä¸€æ¡æ¶ˆæ¯ï¼Œä¼ é€è‡ªå·±çš„tcpæœåŠ¡åœ°å€å’Œç«¯å£ï¼›
5. æœåŠ¡Searcheræ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œè§£æå‡ºæœåŠ¡åœ°å€å’Œç«¯å£ï¼Œé€šè¿‡æœ¬åœ°tcpå®¢æˆ·ç«¯å»è¿›è¡Œè¿æ¥ï¼Œä¿æŒé€šä¿¡ï¼›

**ä»£ç ç¤ºä¾‹**ï¼š

https://gitee.com/dendi.ke/thread-demo/tree/2795f1429ab5431f5b05c88268b41c033a58450b/src/main/java/com/gs/example/servicefind	

**æ€»ç»“**ï¼š

â€‹	udpçš„DatagramSocketè¯»å–å’Œå‘é€éƒ½æ˜¯é€šè¿‡DatagramPacketçš„å¯¹è±¡æ¥è¿›è¡Œï¼ŒPacketå¾—åˆ°çš„æ•°æ®éƒ½æ˜¯byte[], å¯ä»¥ç”¨ByteBufferåŒ…è£…ä¸€å±‚ã€‚

â€‹	socketçš„æ•°æ®è¯»å–å¯ä»¥é€šè¿‡BufferReaderæ¥åŒ…è£…socketçš„outputStreamï¼›

â€‹	socketçš„æ•°æ®å‘é€ï¼Œå¯ä»¥é€šè¿‡PrintStreamæ¥åŒ…è£…socketçš„inputStream;



- #### ä¼˜åŒ–æ”¹è¿›ï¼šä½¿ç”¨å¤šçº¿ç¨‹ï¼Œæ¥åŒæ—¶å¤„ç†æœåŠ¡ç«¯çš„å‘é€å’Œä¿¡æ¯è¯»å–

å®ç°æ–¹æ¡ˆï¼š

```mermaid
graph TD
1[æœåŠ¡ç«¯å¯åŠ¨socketSeverå&nbspä¸»çº¿ç¨‹é˜»å¡ç­‰å¾…å‘½ä»¤è¡Œè¾“å…¥] --> 2[å¯åŠ¨ç›‘å¬çº¿ç¨‹&nbspç›‘å¬å®¢æˆ·ç«¯è¿æ¥]
2 --> 3[å®¢æˆ·ç«¯æ¥å…¥&nbspåˆ›å»ºclientHandler]
subgraph ReadThread
3 --> 4[clientHandlerå¯åŠ¨readThread]
4 --> 4.1[è¯»å–ä¿¡æ¯å¹¶æ‰“å°æ¶ˆæ¯]
4.1 --> 6{readlineæ˜¯å¦ä¸ºnull}
6 -->|æ˜¯|8[è‡ªå·±é€€å‡º]
6 -->|å¦|4.1
end
subgraph WriteThread é€šè¿‡çº¿ç¨‹æ± æ¥è¾“å‡º
3 --> 5[clientHandlerå¯åŠ¨writeThread&nbspå‘é€å‘½ä»¤è¡Œè¾“å…¥æ¶ˆæ¯]
5 --> 7{æ¶ˆæ¯æ˜¯å¦ä¸ºexit}
7 -->|å¦|7.1[OutputStreamå‘é€æ¶ˆæ¯]
7 -->|æ˜¯|7.2[é€€å‡º]
end

```



**ä»£ç è·¯å¾„**ï¼šhttps://gitee.com/dendi.ke/thread-demo/commit/1c8b87ab45b6ce38956d27bd3e32738023b11228





## 6.BIOä¸NIO

> èƒŒæ™¯ï¼šæœåŠ¡ç«¯å½±å“æ€§èƒ½çš„æœ€å¤§ç“¶é¢ˆåœ¨äºIOçš„å¤„ç†ã€‚å•çº¯çš„ä½¿ç”¨çº¿ç¨‹å¹¶å‘å¤„ç†ï¼Œå½“å®¢æˆ·ç«¯è¿æ¥è¿‡å¤šæ—¶ï¼Œåˆ›å»ºçš„çº¿ç¨‹æ•°é‡è¿‡å¤šï¼Œå¯¼è‡´cpué¢‘ç¹è°ƒåº¦çº¿ç¨‹ï¼ŒåŒæ ·ä¼šå½±å“æ€§èƒ½ã€‚

### **ç½‘ç»œæ¨¡å‹**ï¼š**BIO**

åŸºäºæµçš„ä¼ è¾“

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-10-120806.png" alt="image-20191110200805834" style="zoom:40%;" />

1.æœåŠ¡ç«¯å¯åŠ¨ç›‘å¬çº¿ç¨‹ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ï¼›

2.å®¢æˆ·ç«¯å‘é€è¿æ¥è¯·æ±‚ã€‚

3.å®¢æˆ·ç«¯é€šè¿‡åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼ï¼Œå¤„ç†å®¢æˆ·ç«¯çš„è¯»ã€å†™æ“ä½œï¼›

4.æœåŠ¡ç«¯çº¿ç¨‹ä¸æ–­ç­‰å¾…å®¢æˆ·ç«¯çš„æ¶ˆæ¯ï¼›

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-10-120843.png" alt="image-20191110200842632" style="zoom:50%;" />

**ç¼ºç‚¹**ï¼šBIOæœ€å¤§çš„é—®é¢˜åœ¨äºï¼Œå½“å®¢æˆ·ç«¯è¿æ¥è¿‡å¤šæ—¶ï¼ŒæœåŠ¡ç«¯ä¼šå»ºç«‹è¿‡å¤šçš„çº¿ç¨‹ï¼Œå¯¼è‡´æœåŠ¡å™¨ç«¯æ— æ³•æ‰¿å—å‹åŠ›è€Œå´©æºƒã€‚ï¼›



### **ç½‘ç»œæ¨¡å‹ï¼šNIO**

NIOæ˜¯é¢å‘bufferçš„ä¼ è¾“ï¼›

NIOæ ¸å¿ƒæ€æƒ³ï¼šNIOæä¾›å•çº¿ç¨‹çš„selectorï¼Œå¤šè·¯å¤ç”¨ï¼Œç”¨æ¥æ³¨å†Œäº‹ä»¶å’Œç›‘å¬äº‹ä»¶ï¼›selectorå¾ªç¯æ£€æµ‹ï¼Œå½“æ³¨å†Œçš„channelçŠ¶æ€å˜åŒ–æ—¶ï¼Œå†é€šçŸ¥å„ä¸ªchannelè¿›è¡Œå¯¹åº”å¤„ç†ï¼›

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-10-123127.png" alt="image-20191110203126332" style="zoom:50%;" />

1.é¦–å…ˆåœ¨selectorä¸Šæ³¨å†Œç›‘å¬å®¢æˆ·ç«¯è¿æ¥äº‹ä»¶ï¼›

2.å®¢æˆ·ç«¯å‘é€è¿æ¥è¯·æ±‚ï¼›

3.selectoré€šçŸ¥å¯åŠ¨çº¿ç¨‹ï¼Œå¤„ç†å®¢æˆ·ç«¯è¿æ¥ï¼Œå¹¶ä¸”å»ºç«‹ä¸å®¢æˆ·ç«¯çš„è¿æ¥ï¼›

4.åŒæ—¶å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯è¿æ¥çš„socketå‘selectoræ³¨å†Œç›‘å¬â€œsocketå¯è¯»â€äº‹ä»¶

5.å®¢æˆ·ç«¯å‘é€æ•°æ®ï¼Œselectoré€šçŸ¥äº‹ä»¶ï¼Œå¯åŠ¨çº¿ç¨‹ï¼ˆæ¯”å¦‚æ˜¯çº¿ç¨‹æ± ï¼‰ï¼Œå¤„ç†å®¢æˆ·ç«¯çš„è¯»å†™æ“ä½œï¼Œå“åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼›

6.æœ€åï¼Œè¿™ä¸ªçº¿ç¨‹ä¹Ÿä¼šå‘selectoræ³¨å†Œâ€œsokcetå¯å†™â€äº‹ä»¶ï¼›



**NIOçš„ä¼˜ç‚¹**ï¼šæ‰€æœ‰çš„é˜»å¡æ“ä½œéƒ½æ˜¯é›†ä¸­åœ¨selectorä¸Šã€‚å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„å¤„ç†çº¿ç¨‹éƒ½å‡ ä¹æ˜¯éé˜»å¡çš„ï¼Œä¸éœ€è¦å»ç­‰å¾…è¿æ¥ï¼Œç­‰å¾…è¯»å–ã€‚å¤§å¤§å‡å°‘äº†æœåŠ¡ç«¯çš„çº¿ç¨‹æ•°é‡ï¼›





### NIOçš„ç›¸å…³æ¦‚å¿µ

#### Selector

> Selectoræ˜¯Java NIOæ ¸å¿ƒç»„ä»¶ä¸­çš„ä¸€ä¸ªï¼Œç”¨äºæ£€æŸ¥ä¸€ä¸ªæˆ–å¤šä¸ªNIO Channelçš„çŠ¶æ€æ˜¯å¦å¤„äºå¯è¯»ã€å¯å†™ï¼›

**SelectionKey**

- Connect, è¿æ¥äº‹ä»¶(TCP è¿æ¥), å¯¹åº”äºSelectionKey.OP_CONNECT

- Accept, ç¡®è®¤äº‹ä»¶, å¯¹åº”äºSelectionKey.OP_ACCEPT

- Read, è¯»äº‹ä»¶, å¯¹åº”äºSelectionKey.OP_READã€‚

  - å½“ä¸€ä¸ª`channel`**å‡†å¤‡**å¥½å¯ä»¥è¢«è¯»å–(æ¯”å¦‚socketå·²ç»è¯»åˆ°äº†æ–°çš„å­—èŠ‚ï¼Œå…¶Read Bufferæœ‰å°šæœªè¢«åº”ç”¨è¯»å–çš„æ•°æ®ï¼Œå¯é€šçŸ¥åº”ç”¨ç¨‹åºä»è¯»å–ç¼“å†²åŒºè¿›è¡Œè¯»å–ï¼‰ï¼›

  - å·²ç»åˆ°è¾¾æ•°æ®æµçš„ç»“å°¾

  - è¿œç¨‹å¦ä¸€ç«¯å·²ç»å…³é—­æˆ–è€…å‘ç”Ÿé”™è¯¯æ—¶ï¼Œéƒ½ä¼šå°†è¯¥äº‹ä»¶åŠ å…¥åˆ°è¯¥`key`çš„`ready set`ä¸­ï¼Œå¹¶å°†è¯¥`key`åŠ å…¥åˆ°`selected-key set`ä¸­ã€‚

- Write, å†™äº‹ä»¶, å¯¹åº”äºSelectionKey.OP_WRITEã€‚

  - å½“ä¸€ä¸ª`channel` **å‡†å¤‡**å¥½è¿›è¡Œå†™å…¥æ“ä½œï¼ˆæ¯”å¦‚åŸå…ˆsocketå†™å…¥ç¼“å†²å·²æ»¡ï¼Œç°åœ¨å·²ç»å‘é€äº†éƒ¨åˆ†æ•°æ®ï¼Œå†™å…¥ç¼“å†²è…¾å‡ºäº†ä¸€äº›ç©ºé—´ï¼Œå°±ä¼šé€šçŸ¥åº”ç”¨ç¨‹åºè¿›è¡Œå†™å…¥ï¼‰
  - è¿œç¨‹å¦ä¸€ç«¯å·²ç»å…³é—­æˆ–è€…å‘ç”Ÿé”™è¯¯æ—¶ï¼Œéƒ½ä¼šå°†è¯¥äº‹ä»¶åŠ å…¥åˆ°è¯¥`key`çš„`ready set`ä¸­ï¼Œå¹¶å°†è¯¥`key`åŠ å…¥åˆ°`selected-key set`ä¸­ã€‚ 

  

**ç›¸å…³æ“ä½œ**

openï¼š åˆ›å»ºä¸€ä¸ªselectorï¼Œselectorç”±ç³»ç»Ÿå±‚é¢çš„æ–¹æ³•è°ƒç”¨ï¼›

wakeup: å¯ä»¥ä»éselectè°ƒç”¨çš„çº¿ç¨‹å»å”¤é†’é˜»å¡åœ¨selectè°ƒç”¨ä¸Šçš„çº¿ç¨‹

selectï¼šå½“æ³¨å†Œçš„äº‹ä»¶åˆ°è¾¾æ—¶ï¼Œè¿”å›ã€‚å¦åˆ™ï¼Œä¼šä¸€ç›´é˜»å¡ï¼›



#### SelectionKey

`interesté›†åˆ`: keyå…³è”çš„channelæ‰€é€‰æ‹©çš„æ„Ÿå…´è¶£çš„äº‹ä»¶é›†åˆã€‚å¯ä»¥é€šè¿‡SelectionKeyè¯»å†™interesté›†åˆã€‚

`readyé›†åˆ`ï¼šé€šé“å·²ç»å‡†å¤‡å°±ç»ªçš„æ“ä½œçš„é›†åˆã€‚åœ¨ä¸€æ¬¡é€‰æ‹©(Selection)ä¹‹åï¼Œä½ ä¼šé¦–å…ˆè®¿é—®è¿™ä¸ªready setã€‚

#### Channel

ServerSocketChannel: æœåŠ¡ç«¯socket channelã€‚ä¸€èˆ¬åªæ³¨å†ŒAcceptäº‹ä»¶ï¼›

SocketChannelï¼šå®¢æˆ·ç«¯socket channelã€‚ä¸€èˆ¬è¿æ¥åï¼Œæ³¨å†Œconnectäº‹ä»¶ã€‚



**æ³¨æ„**ï¼š

æ³¨å†Œäº‹ä»¶åªæ˜¯å‘Šè¯‰`selector`åœ¨æ£€æµ‹åˆ°å„ç§äº‹ä»¶å‡†å¤‡å¥½å¯ä»¥æ‰§è¡Œæ—¶å‘Šè¯‰åº”ç”¨ï¼Œåº”ç”¨å¯ä»¥æ‰§è¡Œç›¸åº”çš„äº‹ä»¶ï¼Œä½†æ˜¯æ³¨å†Œæ„Ÿå…´è¶£çš„äº‹ä»¶**å¹¶ä¸æ˜¯å¿…é¡»çš„**ï¼ï¼æ²¡æœ‰æ³¨å†Œäº‹ä»¶ä¾ç„¶å¯ä»¥è¿›è¡Œè¯»å–ã€å†™å…¥æ“ä½œã€‚

æ¯”å¦‚è¯»å–æ“ä½œï¼Œå¦‚æœä¸æ³¨å†Œ`OP_READ`äº‹ä»¶ï¼Œåº”ç”¨ç¨‹åºä¾ç„¶å¯ä»¥éšæ—¶å°è¯•ä»`channel`ä¸­è¯»å–æ•°æ®ï¼Œä½†æ˜¯å¹¶ä¸èƒ½ä¿è¯è¯»å–æˆåŠŸï¼Œå› ä¸ºå¯èƒ½`socket`è¯»å–ç¼“å†²åŒºä¸­å¯èƒ½å¹¶ä¸å­˜åœ¨æ•°æ®ã€‚ä½†æ˜¯å¦‚æœæ³¨å†Œäº†`OP_READ`äº‹ä»¶ï¼Œåœ¨`selector`æ£€æµ‹åˆ°è¯¥äº‹ä»¶å‡†å¤‡å¥½äº†å†å»è¯»å–ï¼Œåˆ™å¯ä»¥æœ€å¤§ç¨‹åº¦ä¸Šçš„ä¿è¯å¯ä»¥è¯»åˆ°æ•°æ®ã€‚

å†™å…¥ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ï¼Œä¸æ³¨å†Œ`OP_WRITE`åº”ç”¨ç¨‹åºä¹Ÿå¯ä»¥éšæ—¶è¿›è¡Œå†™å…¥ï¼Œåªæ˜¯å¯èƒ½å› ä¸ºç¼“å†²åŒºæ»¡è€Œå†™å…¥å¤±è´¥ã€‚æ³¨å†Œ`OP_WRITE`äº‹ä»¶ï¼Œåœ¨`selector`æ£€æµ‹åˆ°è¯¥äº‹ä»¶æ—¶å†è¿›è¡Œå†™å…¥ï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦ä¸Šä¿è¯å†™å…¥æˆåŠŸã€‚





#### Buffer

> Bufferæ˜¯å”¯ä¸€æ“ä½œchannelçš„æ–¹å¼ï¼Œæ˜¯ç”¨æˆ·æ•°æ®å¤„ç†çš„åŸºç¡€å•å…ƒã€‚
>
> http://blog.ztgreat.cn/article/43

4ä¸ªå…³é”®å±æ€§ï¼š

- capacity å®¹é‡
- position å½“å‰ä½ç½®
- limit é™åˆ¶
- mark æ ‡è®°ä½ç½®

è¯»å†™åˆ‡æ¢æ—¶ï¼špositionä¼šé‡ç½®ä¸º0ï¼Œlimitä¼šåˆ‡æ¢ä¸ºå†™çš„ä½ç½®ï¼›

è¯»æ¨¡å¼ï¼šæ¯æ¬¡getåï¼Œpositionéƒ½ä¼šåç§»ä¸€ä½ï¼›

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-13-131220.png" alt="image-20191113211219895" style="zoom:50%;" />

å†™æ¨¡å¼ï¼š

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-13-131233.png" alt="image-20191113211233163" style="zoom:50%;" />

flipæ“ä½œï¼šflipä¼šè¿›è¡Œç¿»è½¬ï¼ŒæŠŠlimitè®¾ç½®ä¸ºå½“å‰positionä½ç½®ï¼ŒæŠŠpositionå˜ä¸º0ï¼Œå¯ä»¥ä»åˆå§‹ä½ç½®å¼€å§‹è¿›è¡Œè¯»æ“ä½œï¼›

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-13-131422.png" alt="image-20191113211421721" style="zoom:50%;" />



resetæ“ä½œï¼šå¯ä»¥ç”¨markæ–¹æ³•å¯ä»¥å½“å‰æ ‡è®°ä½ç½®ï¼Œresetåå›åˆ°æ ‡è®°ä½ç½®ï¼›



#### Zero-Copy

> https://mp.weixin.qq.com/s?__biz=MzU0MzQ5MDA0Mw==&mid=2247483913&idx=1&sn=2da53737b8e8908cf3efdae9621c9698&chksm=fb0be89dcc7c618b0d5a1ba8ac654295454cfc2fa81fbae5a6de49bf0a91a305ca707e9864fc&scene=21#wechat_redirect

æ¦‚è¿°ï¼š

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-11-232613.png" alt="image-20191112072612350" style="zoom:40%;" />

ä¼ ç»Ÿçš„IOè¯»å†™ä¸­ï¼Œç³»ç»Ÿè¯»å†™æ–‡ä»¶æ—¶ï¼Œç»å†äº†ä»¥ä¸‹æ­¥éª¤ï¼š

1.ä»IOè®¾å¤‡æ‹·è´åˆ°kernel spaceã€‚

2.ä»kernel space copy åˆ° user space

3.æ¥ä¸‹æ¥ï¼Œå¦‚æœç³»ç»Ÿéœ€è¦å¯¹æ–‡ä»¶è¿›è¡Œwriteæ“ä½œï¼Œç³»ç»Ÿä¼šå†æŠŠuser spaceçš„å†…å®¹æ‹·è´åˆ°kernel spaceä¸­ï¼Œæœ€åå†å¾€å¯¹æ–¹çš„sockå‘é€è¿™äº›æ•°æ®ã€‚

æ•´ä¸ªè¿‡ç¨‹æ€»å…±å‘ç”Ÿäº†å››æ¬¡æ‹·è´ã€‚å¹¶ä¸”å‘ç”Ÿäº†å››æ¬¡çš„ç”¨æˆ·æ€å’Œå†…æ ¸æ€åˆ‡æ¢ã€‚

ä½†æ˜¯æˆ‘ä»¬å¯ä»¥å‘ç°ä¸€ä¸ªé—®é¢˜

*ä¸ºä»€ä¹ˆIOéœ€è¦å°†æ•°æ®ä»kernelï¼ˆç³»ç»Ÿå†…æ ¸æ€ï¼‰æ‹·è´åˆ°userï¼ˆç”¨æˆ·æ€ï¼‰ï¼Œå†æ‹·è´å›kernelæ€ï¼Ÿ*

å¸¦ç€è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æå‡ºä»¥ä¸‹æ”¹è¿›



æ”¹è¿›1ï¼šå¯ä»¥å¾ˆå®¹æ˜“çš„å‘ç°ï¼Œ2ï¼Œ3çš„copyæ“ä½œå®é™…ä¸Šæ˜¯æµªè´¹èµ„æºï¼Œå¯ä»¥çœç•¥ã€‚

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-11-233840.png" alt="image-20191112073839594" style="zoom:40%;" />

1. é¦–å…ˆï¼ˆé€šè¿‡DMAï¼‰å°†æ•°æ®ä»ç£ç›˜è¯»å–åˆ°kernel bufferä¸­ï¼›
2. ç„¶åå°†kernel bufferæ‹·è´åˆ°socket bufferä¸­ï¼›
3. æœ€åå°†socket bufferä¸­çš„æ•°æ®copyåˆ°ç½‘å¡è®¾å¤‡ï¼ˆprotocol engineï¼‰ä¸­å‘é€

ä½†è¿™å¹¶ä¸æ˜¯`zero-copy`ï¼Œå› ä¸ºç¬¬2æ­¥çš„copyå…¶å®ä¹Ÿæ˜¯æ²¡æœ‰å¿…è¦çš„ã€‚



æ”¹è¿›2ï¼š

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-11-234408.png" alt="image-20191112074407565" style="zoom:40%;" />

1. å°†æ–‡ä»¶æ‹·è´åˆ°kernel bufferä¸­ï¼›
2. å‘socket bufferä¸­è¿½åŠ å½“å‰è¦å‘ç”Ÿçš„æ•°æ®åœ¨kernel bufferä¸­çš„ä½ç½®å’Œåç§»é‡ï¼›
3. æ ¹æ®socket bufferä¸­çš„ä½ç½®å’Œåç§»é‡ç›´æ¥å°†kernel bufferçš„æ•°æ®copyåˆ°ç½‘å¡è®¾å¤‡ï¼ˆprotocol engineï¼‰ä¸­ï¼›

å®é™…ä¸Šï¼Œä¸Šé¢çš„æ“ä½œå°±æ˜¯çœŸæ­£çš„NIOåŸç†



### NIOçš„ç›¸å…³æ“ä½œ

#### 1.è¯»å–SocketChannel

```java
ByteBuffer buf = ByteBuffer.allocate(48);

int bytesRead = socketChannel.read(buf);
```

1. åˆ†é…bufferï¼Œç”¨æ¥ä¿å­˜socketchannelè¯»å–åˆ°çš„æ•°æ®
2. è°ƒç”¨readæ–¹æ³•ï¼Œå°† `SocketChannel`çš„æ•°æ®è¯»å–åˆ° `Buffer`ã€‚è¿”å›çš„`int`å€¼å‘Šè¯‰æˆ‘ä»¬æœ‰å¤šå°‘å­—èŠ‚å†™åˆ°äº†Bufferé‡Œï¼Œå¦‚æœè¿”å›äº†-1ï¼Œè¡¨ç¤ºå·²ç»è¿æ¥å·²å…³é—­ï¼Œåˆ°äº†æ•°æ®æµç»“å°¾

#### 2. å†™å…¥SocketChannel

```java
String newData = "New String to write to file..." + System.currentTimeMillis();

ByteBuffer buf = ByteBuffer.allocate(48);
buf.clear();
buf.put(newData.getBytes());

buf.flip();

while(buf.hasRemaining()) {
    channel.write(buf);
}
```

æ³¨æ„ `SocketChannel.write()` æ–¹æ³•æ˜¯åœ¨å¾ªç¯é‡Œè¢«è°ƒç”¨çš„ã€‚ç”±äºæ— æ³•ä¿è¯æ¯æ¬¡æœ‰å¤šå°‘æ•°æ®è¢«è¯»å–åˆ°äº†SocketChannelé‡Œï¼Œå› æ­¤éœ€è¦é‡å¤è°ƒç”¨write()æ–¹æ³•ç›´åˆ°`Buffer`é‡Œä¸å†æœ‰å­—èŠ‚è¾“å‡ºã€‚





**è¸©å‘è®°å½•**1ï¼š

åˆå­¦çš„æ—¶å€™ï¼Œç»å¸¸å‚»ä¹ä¹çš„åœ¨å»ºç«‹è¿æ¥åé©¬ä¸Šæ³¨å†ŒWriteç­‰äº‹ä»¶ï¼ŒæœŸå¾…ç­‰å†™äº‹ä»¶é€šçŸ¥åˆ°å†å»å‘é€æ•°æ®ã€‚å®é™…ä¸Šå¯¹è¿™äº›ç‰¹åˆ«ä¸ç†è§£ï¼›

å†™æ“ä½œçš„å°±ç»ªæ¡ä»¶ä¸ºåº•å±‚ç¼“å†²åŒºæœ‰ç©ºé—²ç©ºé—´ï¼Œè€Œå†™ç¼“å†²åŒºç»å¤§éƒ¨åˆ†æ—¶é—´éƒ½æ˜¯æœ‰ç©ºé—²ç©ºé—´çš„ï¼Œæ‰€ä»¥å½“ä½ æ³¨å†Œå†™äº‹ä»¶åï¼Œå†™æ“ä½œä¸€ç›´æ˜¯å°±ç»ªçš„ï¼Œé€‰æ‹©å¤„ç†çº¿ç¨‹å…¨å ç”¨æ•´ä¸ªCPUèµ„æºã€‚

æœ€å¥½çš„æ–¹æ³•æ˜¯ï¼Œå½“ä½ ç¡®å®æœ‰æ•°æ®è¦å†™æ—¶ï¼Œå†æ³¨å†Œå†™æ“ä½œï¼Œå¹¶åœ¨å†™å®Œä»¥åé©¬ä¸Šå–æ¶ˆæ³¨å†Œã€‚



æˆ–è€…**ä¸å»æ³¨å†Œå†™äº‹ä»¶**ï¼Œæœ‰è¦å†™çš„æ•°æ®åˆ™ç›´æ¥å†™æ•°æ®è‡³`Channel`å³å¯ï¼Œå†™å…¥å¤±è´¥åˆ™è¡¨ç¤º`Channel`æš‚æ—¶æ²¡æœ‰å‡†å¤‡å¥½è¢«å†™å…¥ï¼Œæ­¤æ—¶åº”ç”¨å¯ä»¥å‘`Channel`æ³¨å†Œå†™äº‹ä»¶ï¼Œè®©`Channel`åœ¨å‡†å¤‡å¥½æ¥æ”¶å†™äº‹ä»¶æ—¶å‘Šè¯‰åº”ç”¨ï¼Œä½†æ˜¯ä¸€æ—¦åº”ç”¨å†™å®Œæ‰€æœ‰çš„æ•°æ®ï¼Œåˆ™ä¸€èˆ¬ä¼šå–æ¶ˆæ³¨å†Œçš„å†™äº‹ä»¶ï¼Œå› ä¸ºå¦‚æœæ•°æ®å†™å®Œäº†ï¼Œä½†æ˜¯æ²¡æœ‰å–æ¶ˆæ³¨å†Œçš„å†™äº‹ä»¶ï¼Œ`Selector.select`æ–¹æ³•å¯èƒ½ä¼šç»å¸¸å› ä¸ºæœ‰å†™äº‹ä»¶å‡†å¤‡å®Œæ¯•è€Œè¿”å›ï¼Œä½†æ˜¯åº”ç”¨å´æ— æ•°æ®éœ€è¦å†™ã€‚



**è¸©å‘è®°å½•**2ï¼š

èµ·åˆå¯¹`OP_CONNECT`äº‹ä»¶è¿˜æœ‰`finishConnect`ä¸ç†è§£ï¼Œ`OP_CONNECT`äº‹ä»¶ä½•æ—¶è§¦å‘ï¼Œç‰¹åˆ«æ˜¯ä¸ºä»€ä¹ˆè¦åœ¨`key.isConnectable()`åˆ†æ”¯é‡Œè°ƒç”¨`finishConnect`æ–¹æ³•åæ‰èƒ½è¿›è¡Œè¯»å†™æ“ä½œã€‚

é¦–å…ˆï¼Œåœ¨`non-blocking`æ¨¡å¼ä¸‹è°ƒç”¨`socketChannel.connect(new InetSocketAddress("127.0.0.1",8080));`è¿æ¥è¿œç¨‹ä¸»æœºï¼Œå¦‚æœè¿æ¥èƒ½ç«‹å³å»ºç«‹å°±åƒæœ¬åœ°è¿æ¥ä¸€æ ·ï¼Œè¯¥æ–¹æ³•ä¼šç«‹å³è¿”å›`true`ï¼Œå¦åˆ™è¯¥æ–¹æ³•ä¼šç«‹å³è¿”å›`false`,ç„¶åç³»ç»Ÿåº•å±‚è¿›è¡Œä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥ã€‚è¿æ¥æœ‰ä¸¤ç§ç»“æœï¼Œä¸€ç§æ˜¯æˆåŠŸè¿æ¥ï¼Œç¬¬äºŒç§æ˜¯å¼‚å¸¸ï¼Œä½†æ˜¯`connect`æ–¹æ³•å·²ç»è¿”å›ï¼Œæ— æ³•é€šè¿‡è¯¥æ–¹æ³•çš„è¿”å›å€¼æˆ–è€…æ˜¯å¼‚å¸¸æ¥é€šçŸ¥ç”¨æˆ·ç¨‹åºå»ºç«‹è¿æ¥çš„æƒ…å†µï¼Œæ‰€ä»¥ç”±`OP_CONNECT`äº‹ä»¶å’Œ`finishConnect`æ–¹æ³•æ¥é€šçŸ¥ç”¨æˆ·ç¨‹åºã€‚ä¸ç®¡ç³»ç»Ÿåº•å±‚ä¸‰æ¬¡è¿æ¥æ˜¯å¦æˆåŠŸï¼Œ`selector`éƒ½ä¼šè¢«å”¤é†’ç»§è€Œè§¦å‘`OP_CONNECT`äº‹ä»¶ï¼Œå¦‚æœæ¡æ‰‹æˆåŠŸï¼Œå¹¶ä¸”è¯¥è¿æ¥æœªè¢«å…¶ä»–çº¿ç¨‹å…³é—­ï¼Œ`finishConnect`ä¼šè¿”å›`true`ï¼Œç„¶åå°±å¯ä»¥é¡ºåˆ©çš„è¿›è¡Œ`channle`è¯»å†™ã€‚å¦‚æœç½‘ç»œæ•…éšœï¼Œæˆ–è€…è¿œç¨‹ä¸»æœºæ•…éšœï¼Œæ¡æ‰‹ä¸æˆåŠŸï¼Œç”¨æˆ·ç¨‹åºå¯ä»¥é€šè¿‡`finishConnect`æ–¹æ³•è·å¾—åº•å±‚çš„å¼‚å¸¸é€šçŸ¥ï¼Œè¿›è€Œå¤„ç†å¼‚å¸¸ã€‚



**è¸©å‘è®°å½•3ï¼šå¤„ç†OP_WRITE**
OP_WRITEå¤„ç†ä¸å½“å¾ˆå®¹æ˜“å¯¼è‡´CPU 100%
**OP_WRITEè§¦å‘æ¡ä»¶**ï¼š
  å‰æ: interestäº†OP_WRITE
  **è§¦å‘æ¡ä»¶**:

-  socketå‘é€ç¼“å†²åŒºå¯å†™    

- è¿œç«¯å…³é—­
- æœ‰é”™è¯¯å‘ç”Ÿ

**æ­£ç¡®çš„å¤„ç†æ–¹å¼**ï¼š

-   ä»…åœ¨å·²ç»è¿æ¥çš„channelä¸Šæ³¨å†Œ
-   ä»…åœ¨æœ‰æ•°æ®å¯å†™çš„æ—¶å€™æ‰æ³¨å†Œ
-   è§¦å‘ä¹‹åç«‹å³å–æ¶ˆæ³¨å†Œï¼Œå¦åˆ™ä¼šç»§ç»­è§¦å‘å¯¼è‡´å¾ªç¯
-   å¤„ç†å®Œæˆåè§†æƒ…å†µå†³å®šæ˜¯å¦ç»§ç»­æ³¨å†Œï¼Œ
     å¦‚æœæ²¡æœ‰å®Œå…¨å†™å…¥ï¼Œç»§ç»­æ³¨å†Œ
     å¦‚æœå…¨éƒ¨å†™å…¥ï¼Œæ— éœ€æ³¨å†Œ



eg: æœ‰å†™æ•°æ®éœ€æ±‚æ—¶è®¢é˜…OP_WRITEäº‹ä»¶,æ•°æ®å‘é€å®Œæˆå–æ¶ˆè®¢é˜….

[https://tech.fenxiangz.com/topic/77/nio-%E5%90%84%E7%A7%8D%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E7%82%B9](https://tech.fenxiangz.com/topic/77/nio-å„ç§ä½¿ç”¨æ³¨æ„ç‚¹)





## 7.NIOå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯

### NIOå®ç°CSæ¨¡å‹çš„æµç¨‹

#### æœåŠ¡ç«¯

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-19-221145.png" alt="image-20191120061144474" style="zoom:50%;" />

#### å®¢æˆ·ç«¯

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-19-221910.png" alt="image-20191120061909011" style="zoom:50%;" />

#### ä»£ç å®ä¾‹

ç›‘å¬å®¢æˆ·ç«¯çš„åˆ°è¾¾ï¼›

```java
Selector selector = Selector.open();
ServerSocketChannel serverChannel = ServerSocketChannel.open();
serverChannel.configureBlocking(false);
serverChannel.bind(new InetSocketAddress(InetAddress.getLocalHost(), 8000));
// ç›‘å¬
serverChannel.register(selector, SelectionKey.OP_ACCEPT);
System.out.println("æœåŠ¡ç«¯åœ°å€:" + serverChannel.getLocalAddress());

while(true) {
  int length = selector.select();
  if (length >= 0) {
    Set<SelectionKey> selectionKeys = selector.selectedKeys();
    Iterator<SelectionKey> selectionKeyIterator = selectionKeys.iterator();
    while (selectionKeyIterator.hasNext()) {
      SelectionKey selectionKey = selectionKeyIterator.next();
      // ç§»é™¤key
      selectionKeyIterator.remove();
      if (selectionKey.isAcceptable()) {
        ServerSocketChannel serverSocketChannel = (ServerSocketChannel) selectionKey.channel();
        // ä¸€å®šå¯ä»¥æ‹¿åˆ°å®¢æˆ·ç«¯
        SocketChannel clientChannel = serverSocketChannel.accept();
        clientChannel.configureBlocking(false);
        new ClientHandler(clientChannel).start();
      }
    }
  }
}
```



æ¥å—å®¢æˆ·ç«¯æ•°æ®ï¼š

```java
readSelector = Selector.open();
				socketChannel.register(readSelector, SelectionKey.OP_READ);
				while(true) {
					int readCount = readSelector.select();
					if (readCount > 0) {
						Set<SelectionKey> selectionKeys = readSelector.selectedKeys();
						Iterator<SelectionKey> selectionKeyIterator = selectionKeys.iterator();
						while (selectionKeyIterator.hasNext()) {
							SelectionKey selectionKey = selectionKeyIterator.next();
							// ç§»é™¤key
							selectionKeyIterator.remove();
							if (selectionKey.isReadable()) {
								SocketChannel socketChannel = (SocketChannel) selectionKey.channel();
								ByteBuffer byteBuffer = ByteBuffer.allocate(256);
								socketChannel.read(byteBuffer);
								String receiveData = new String(byteBuffer.array(), 0, byteBuffer.position());
//							String receiveData= Charset.forName("UTF-8").decode(byteBuffer).toString();
								System.out.println("æœåŠ¡ç«¯æ¥æ”¶åˆ°æ•°æ®ï¼š" + receiveData);
								// å›é€å®¢æˆ·ç«¯æ•°æ®
                writeBuffer.clear();
								writeBuffer.put(("æœåŠ¡ç«¯æ¥æ”¶åˆ°æ•°æ®ï¼š" + receiveData).getBytes());
								writeBuffer.flip();
								while(writeBuffer.hasRemaining()){
									int len = socketChannel.write(writeBuffer);
									if (len > 0) {
										System.out.println("å†™å…¥æ•°æ®:" + len);
									} else {
										System.out.println("å®¢æˆ·ç«¯å·²æ— æ³•å‘é€æ•°æ®ï¼");
										break;
									}
								}
							}
						}
					}
				}
```



å®¢æˆ·ç«¯ç›‘å¬è¿æ¥æˆåŠŸï¼š

```java
Selector selector = Selector.open();
			SocketChannel socketChannel = SocketChannel.open();
			socketChannel.configureBlocking(false);
			boolean connected = socketChannel.connect(new InetSocketAddress(InetAddress.getLocalHost(), 2000));
			if (connected) {
				socketChannel.register(selector, SelectionKey.OP_READ);
				byte[] req = "ä½ å¥½ï¼ŒnioæœåŠ¡ç«¯342".getBytes();
				//ä¸ºå­—èŠ‚ç¼“å†²åŒºåˆ†é…æŒ‡å®šå­—èŠ‚å¤§å°çš„å®¹é‡
				ByteBuffer writeBuffer = ByteBuffer.allocate(req.length);
				//å°†å†…å®¹å†™å…¥ç¼“å†²åŒº
				writeBuffer.put(req);
				//åè½¬ç¼“å†²åŒº
				writeBuffer.flip();
				//è¾“å‡ºæ‰“å°ç¼“å†²åŒºçš„å¯è¯»å¤§å°
				System.out.println(writeBuffer.remaining());
				//å°†å†…å®¹å†™å…¥ç®¡é“ä¸­
				socketChannel.write(writeBuffer);
				if (!writeBuffer.hasRemaining()) {
					System.out.println("Send 2 server succeed.");
				}
			} else {
				socketChannel.register(selector, SelectionKey.OP_CONNECT);
			}
			System.out.println("å®¢æˆ·ç«¯å¯åŠ¨æˆåŠŸ");
			System.out.println("æœåŠ¡å™¨ä¿¡æ¯ï¼š" + socketChannel.getRemoteAddress().toString());
			// æ‹¿åˆ°å®¢æˆ·ç«¯æ•°æ®
			while (true) {
				int length = selector.select();
				if (length > 0) {
					Set<SelectionKey> selectionKeys = selector.selectedKeys();
					Iterator<SelectionKey> selectionKeyIterator = selectionKeys.iterator();
					while (selectionKeyIterator.hasNext()) {
						SelectionKey selectionKey = selectionKeyIterator.next();
						selectionKeyIterator.remove();
						if (selectionKey.isConnectable()) {
							SocketChannel channel = (SocketChannel) selectionKey.channel();
							if (channel.finishConnect()) {
								channel.register(selector, SelectionKey.OP_READ);
								ByteBuffer byteBuffer = ByteBuffer.allocate(256);
								byteBuffer.clear();
								byteBuffer.put("ä½ å¥½ï¼ŒnioæœåŠ¡ç«¯23432".getBytes());
								byteBuffer.flip();
								while (byteBuffer.hasRemaining()) {
									int len = channel.write(byteBuffer);
									if (len >= 0) {
										System.out.println("å†™å…¥æ•°æ®:" + len);
									} else {
										System.out.println("å®¢æˆ·ç«¯å·²æ— æ³•å‘é€æ•°æ®ï¼");
										break;
									}
								}
							}
						}
						if (selectionKey.isReadable()) {
							selectionKey.interestOps(selectionKey.interestOps() | ~SelectionKey.OP_READ);
							SocketChannel channel = (SocketChannel) selectionKey.channel();
							ByteBuffer buffer = ByteBuffer.allocate(256);
							buffer.clear();
							channel.read(buffer);
							buffer.flip();
							String msg = Charset.forName("utf-8").decode(buffer).toString();
							System.out.println("å®¢æˆ·ç«¯æ¥æ”¶åˆ°è¿”å›æ•°æ®[" + msg + "]");
						}
					}
				}
			}
```



### æ¶ˆæ¯åˆ°è¾¾é‡å¤è§¦å‘äº‹ä»¶

selecotrç›‘å¬åˆ°readäº‹ä»¶åï¼Œéœ€è¦å–æ¶ˆç»§ç»­å¯¹keyOpsçš„ç›‘å¬ã€‚

![image-20191120072613024](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-19-232613.png)

å¦åˆ™ï¼Œselectorä¸‹æ¬¡selectçš„æ—¶å€™ï¼Œä¾ç„¶èƒ½å¤ŸæŸ¥è¯¢åˆ°æœ‰selection-key



## 8.ç²˜åŒ…ä¸æ‹†åŒ…

### 8.1åŸºæœ¬æ¦‚å¿µ

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-16-131559.jpg" alt="img" style="zoom: 67%;" />

tcpæ˜¯é¢å‘è¿æ¥ã€ä¾é å­—èŠ‚æµä¼ è¾“çš„åè®®ã€‚

tcpæœ¬èº«åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œæ˜¯æœ‰åºçš„ä¸”å¯é çš„ã€‚

tcpåœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¸å­˜åœ¨ç²˜åŒ…æˆ–æ‹†åŒ…çš„è¯´æ³•ã€‚ç²˜åŒ…å’Œæ‹†åˆ†ä¸»è¦æ˜¯ç«™åœ¨ä¸Šå±‚ï¼ˆåº”ç”¨åœºæ™¯ã€ä¸šåŠ¡é€»è¾‘ï¼‰çš„è§’åº¦æ¥è¯´çš„ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-16-131714.jpg" alt="img" style="zoom:50%;" />

å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯ä¼ è¾“2ä¸ªæ•°æ®åŒ…ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼ŒæœåŠ¡ç«¯æ¥å—åˆ°çš„ä¹Ÿæ˜¯2ä¸ªæ•°æ®åŒ…ã€‚

ä½†æ˜¯å®¢æˆ·ç«¯åœ¨å‘é€è¿‡ç¨‹ä¸­ï¼Œç”±äºç¼“å­˜çš„åŸå› ï¼Œä¸¤ä¸ªæ•°æ®åŒ…åŒæ—¶åˆ°è¾¾ã€‚é‚£ä¹ˆæœåŠ¡ç«¯æ¥å—çš„æƒ…å†µå°±å˜æˆäº†ï¼š

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-16-131849.jpg" alt="img" style="zoom:53%;" />



è¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œç”±äºæœåŠ¡ç«¯çš„æ¥æ”¶ç¼“å­˜æ¯”è¾ƒå°ï¼Œè™½ç„¶å®¢æˆ·ç«¯å‘é€äº†1ä¸ªæ•°æ®åŒ…ï¼Œä½†æ˜¯æœåŠ¡ç«¯å¿…é¡»é€šè¿‡ä¸¤æ¬¡æ¥æ¥æ”¶ï¼Œè¿™æ ·å°±å¿…é¡»æ‹†åŒ…ï¼š

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-16-132611.png" alt="image-20191116212610271" style="zoom: 25%;" />



### 8.2è§£å†³æ–¹æ¡ˆ

ç”±äºç²˜åŒ…å’Œæ‹†åŒ…çš„ç°è±¡äº§ç”Ÿï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„æ•°æ®ä¼ è¾“ä¼šå‡ºç°ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š

a.ä¼ è¾“å­—ç¬¦ä¸²æ—¶ï¼Œå­—ç¬¦ä¸²è‡ªåŠ¨æ‹¼æ¥åœ¨ä¸€èµ·ï¼Œé€ æˆè§£æé”™è¯¯ï¼›ï¼ˆç²˜åŒ…é—®é¢˜ï¼‰

b.ä¼ é€’é•¿å­—ç¬¦ä¸²æ—¶ï¼Œè‡ªåŠ¨æ‹†åˆ†æˆäº†å¤šä¸ªå°çš„å­—ç¬¦ä¸²ï¼Œç”šè‡³è¿˜ä¼šè‡ªåŠ¨ä¸¢å¼ƒä¸­é—´çš„å­—ç¬¦ä¸²ã€‚ï¼ˆæ‹†åŒ…é—®é¢˜ï¼‰

ä¸€èˆ¬è§£å†³æ–¹æ¡ˆæœ‰ä»¥ä¸‹å‡ ç§ï¼š

a.åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ ‡è®°å¼€å§‹å’Œç»“æŸä½ç½®ï¼Œæ¯”å¦‚é€šè¿‡æ¢è¡Œç¬¦æ¥åˆ¤æ–­æ˜¯å¦ç»“æŸï¼›

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-20-131030.png" alt="image-20191120211029655" style="zoom:15%;" />

b.æ•°æ®ä¼ è¾“æ—¶ï¼Œä½¿ç”¨å›ºå®šçš„å¤´éƒ¨ï¼Œåœ¨æ¶ˆæ¯å¤´ä¸­æŒ‡æ˜æ¶ˆæ¯çš„é•¿åº¦ï¼›

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-20-131100.png" alt="image-20191120211100306" style="zoom:15%;" />

c.æ··åˆæ¨¡å¼ï¼šé€šè¿‡å›ºå®šå¤´éƒ¨ä¿¡æ¯ï¼Œå¹¶ä¸”åŠ ä¸Šæ•°æ®æè¿°ï¼Œæœ€åå¯¹æ•°æ®è¿›è¡ŒåŠ å¯†ï¼›



### 8.3ä»£ç å®ä¾‹

é¦–å…ˆæ¥çœ‹ä¸€ä¸‹å¼‚å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„æ¶ˆæ¯æ˜¯æ€ä¹ˆæ ·çš„ä¸€ä¸ªå½¢å¼ã€‚

**ç²˜åŒ…**ï¼šæˆ‘ä»¬å…ˆè¿ç»­å‘é€å¤šä¸ªæ¶ˆæ¯

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-20-125648.png" alt="image-20191120205648416" style="zoom:50%;" />

ç»“æœæ§åˆ¶å°æ‰“å°çš„æ¶ˆæ¯ä¸ºï¼šæœåŠ¡ç«¯æ¥æ”¶åˆ°æ•°æ®:test1test2test3test4



**æ‹†åŒ…**ï¼šæˆ‘ä»¬å°†è¯»å–çš„bufferè®¾ç½®ä¸º4ï¼Œç„¶åçœ‹æœåŠ¡ç«¯æ¥æ”¶çš„æƒ…å†µã€‚

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-20-125855.png" alt="image-20191120205854860" style="zoom:50%;" />

å¯ä»¥çœ‹å‡ºï¼ŒæœåŠ¡ç«¯æ¥å—åˆ°çš„æ•°æ®æ—¶æ‹†åˆ†å¼€çš„ï¼Œå¯¼è‡´æ•°æ®é”™ä¹±äº†ã€‚



é‚£ä¹ˆå¦‚ä½•å¯¹æ•°æ®è¿›è¡Œå°åŒ…å’Œæ‹†åŒ…å‘¢ï¼Ÿ

**ä»£ç æ¶æ„**

> https://www.processon.com/diagraming/5dcbff07e4b0754822a4b47b

æ€è·¯é‡‡ç”¨äº†[ä¸Šæ–‡](#8.2è§£å†³æ–¹æ¡ˆ)ä¸­çš„bæ–¹æ¡ˆï¼Œå®šä¹‰å›ºå®šçš„å¤´éƒ¨ä¿¡æ¯ã€‚å¹¶ä¸”åœ¨headeré‡Œå®šä¹‰äº†æ•°æ®çš„å¤§å°ä»¥åŠå‘é€ç±»å‹ã€‚ç±»å‹å¯ä»¥æ˜¯byteã€stringæˆ–è€…fileç­‰ã€‚

**ä»£ç åœ°å€**

> https://gitee.com/dendi.ke/thread-demo/tree/master/socket-packet



## 9.åˆ†ç‰‡æ•°æ®å‘é€

ä¹‹å‰å‘é€æ•°æ®æ—¶ï¼Œæ— è®ºæ˜¯å­—ç¬¦ä¸²æˆ–è€…æ˜¯æ–‡ä»¶ï¼Œéƒ½æ˜¯å…ˆè¯»å–åˆ°å†…å­˜ä¸­ï¼Œä»¥byte[]æ•°ç»„çš„å½¢å¼å­˜å‚¨ã€‚å½“éœ€è¦å‘é€æ—¶ï¼Œå†å°†byte[]å†™å…¥ByteBufferé‡Œï¼Œäº¤ç»™channelå‘é€å‡ºå»ã€‚

ä½†æ˜¯å¦‚æœå‘é€çš„æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤§çš„æ–‡ä»¶ï¼Œè¯»å–åˆ°å†…å­˜ä¸­å»å°±ä¼šå ç”¨å¤ªå¤šå†…å­˜ï¼Œè¿™æ ·æœåŠ¡å™¨çš„æ€§èƒ½å°±å¾ˆå·®ã€‚

æ‰€ä»¥æˆ‘é‡‡å–äº†æ–‡ä»¶åˆ†ç‰‡çš„æ–¹æ¡ˆï¼Œå°†ä¸€ä¸ªæ–‡ä»¶åˆ†æˆå¤šä¸ªæ•°æ®åŒ…åˆ†å¼€å‘é€ã€‚

### 9.1 åŸºæœ¬æ–¹æ¡ˆ



ç»è¿‡äº†æ•´æ•´2å‘¨æ—¶é—´ï¼Œæˆ‘å‚è€ƒç€æ•™ç¨‹å®ç°äº†socketç¼–ç¨‹

## 9.Socketå¹¶å‘

### å®¢æˆ·ç«¯æœåŠ¡å™¨è¿æ¥æ•°é‡é™åˆ¶

49152 ~ 65535 ç«¯å£å·æ˜¯ä¸å…è®¸è¢«å ç”¨çš„ï¼Œæ˜¯åŠ¨æ€åˆ†é…çš„ã€‚

ç³»ç»Ÿå•è¿›ç¨‹â€œ**[æ–‡ä»¶å¥æŸ„](#æ–‡ä»¶å¥æŸ„)**â€æœ€å¤§é™åˆ¶



### 







## HTTP

httpæ˜¯å¦‚æœè¯†åˆ«è¯·æ±‚çš„ï¼Ÿ

httpæ˜¯å¦‚æœæ¥å—æ•°æ®åŒ…çš„ï¼Ÿ

httpæ˜¯å¦‚ä½•åˆ¤æ–­è¯·æ±‚æ•°æ®æ¥æ”¶åˆ°åº•çš„ï¼Ÿ



1.xå’Œ2.xçš„åŒºåˆ«





# Nettyæ¡†æ¶ (æ¸¸æˆæœåŠ¡å™¨)

NetttyæœåŠ¡ç«¯

Nettyå®¢æˆ·ç«¯



é•¿è¿æ¥ä¸çŸ­è¿æ¥åŒºåˆ«

æ¶ˆæ¯åºåˆ—åŒ–







## æ•°æ®åº“

mysqlå®‰è£…

> https://www.jianshu.com/p/4fc53d7d7620



mysqlæ¦‚è¿°

mysqlä¼˜åŒ–æ–¹æ¡ˆ

æ•°æ®åº“ä¸‰å¤§èŒƒå¼

åˆ†åº“åˆ†è¡¨

æ°´å¹³åˆ†å‰²å–æ¨¡ç®—æ³•

ç´¢å¼•æ¦‚è¿°

ç´¢å¼•åº•å±‚å®ç°åŸç†

æ™®é€šç´¢å¼•&å”¯ä¸€ç´¢å¼•åŒºåˆ«

sqlè¯­å¥ä¼˜åŒ–

mysqlé«˜å¯ç”¨

mysqlä¸»ä»å¤åˆ¶åŸç†

mysqlè¯»å†™åˆ†ç¦»æ¦‚è¿°

mycatè¯»å†™åˆ†ç¦»



## äº‹ç‰©

äº‹ç‰©æ¦‚è¿°

äº‹ç‰©åº•å±‚åŸç†

äº‹ç‰©ä¼ æ’­è¡Œä¸º

åˆ†å¸ƒå¼äº‹ç‰©



# Redis

## Redis-Desktop-Managerå®‰è£…

> https://github.com/qishibo/AnotherRedisDesktopManager



### Redis5ç§åŸºæœ¬ç±»å‹

> String, Hash, List, Set,  ZSet

#### String

é‡è¦ç”¨æ³•1ï¼š**`Expire Key`**

> **åº”ç”¨åœºæ™¯**

1ã€é™æ—¶çš„ä¼˜æƒ æ´»åŠ¨ä¿¡æ¯

2ã€ç½‘ç«™æ•°æ®ç¼“å­˜ï¼ˆå¯¹äºä¸€äº›éœ€è¦å®šæ—¶æ›´æ–°çš„æ•°æ®ï¼Œä¾‹å¦‚ï¼šç§¯åˆ†æ’è¡Œæ¦œï¼‰

3ã€æ‰‹æœºéªŒè¯ç 

4ã€é™åˆ¶ç½‘ç«™è®¿å®¢è®¿é—®é¢‘ç‡ï¼ˆä¾‹å¦‚ï¼š1åˆ†é’Ÿæœ€å¤šè®¿é—®10æ¬¡ï¼‰  



é‡è¦ç”¨æ³•2ï¼š**`SETNX key value` **

> **åº”ç”¨åœºæ™¯**

1ã€åˆ†å¸ƒå¼é”



é‡è¦ç”¨æ³•3ï¼š**`INCR KEY_Name`**

> **åº”ç”¨åœºæ™¯**

1.è®¡æ•°å™¨

å‡å¦‚ï¼Œåœ¨æŸç§åœºæ™¯ä¸‹æœ‰3ä¸ªå®¢æˆ·ç«¯åŒæ—¶è¯»å–äº†mynumçš„å€¼ï¼ˆå€¼ä¸º2ï¼‰ï¼Œç„¶åå¯¹å…¶åŒæ—¶è¿›è¡Œäº†åŠ 1çš„æ“ä½œï¼Œé‚£ä¹ˆï¼Œæœ€åmynumçš„å€¼ä¸€å®šæ˜¯5ã€‚



**Keyçš„å‘½åå»ºè®®**

> rediså•ä¸ªkey å­˜å…¥512Må¤§å°

1.keyä¸è¦å¤ªé•¿ï¼Œå°½é‡ä¸è¦è¶…è¿‡1024å­—èŠ‚ï¼Œè¿™ä¸ä»…æ¶ˆè€—å†…å­˜ï¼Œè€Œä¸”ä¼šé™ä½æŸ¥æ‰¾çš„æ•ˆç‡ï¼›

 2.keyä¹Ÿä¸è¦å¤ªçŸ­ï¼Œå¤ªçŸ­çš„è¯ï¼Œkeyçš„å¯è¯»æ€§ä¼šé™ä½ï¼› 

3.åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œkeyæœ€å¥½ä½¿ç”¨ç»Ÿä¸€çš„å‘½åæ¨¡å¼ï¼Œä¾‹å¦‚user:123:password; 

4.keyåç§°åŒºåˆ†å¤§å°å†™



#### Hash

> åº”ç”¨åœºæ™¯

1ã€å­˜å‚¨ä¸€ä¸ªå¯¹è±¡

hashå­˜å‚¨å¯¹è±¡å’Œstringå­˜å‚¨çš„åŒºåˆ«

- stirngå­˜å‚¨ä¸»è¦æœ‰2ç§æ–¹æ¡ˆï¼šä¸€ç§æ˜¯ç”¨å¯¹è±¡çš„idä½œä¸ºkeyï¼Œç”¨å¯¹è±¡çš„jsonåºåˆ—åŒ–ä½œä¸ºvalueã€‚è¿˜æœ‰ä¸€ç§æ˜¯ç”¨å¯¹è±¡çš„id+å±æ€§åä½œä¸ºkeyï¼Œç”¨å¯¹è±¡å±æ€§å€¼ä½œä¸ºvalueã€‚

  ç¬¬ä¸€ç§çš„ç¼ºç‚¹æ˜¯æ¯æ¬¡ä¿®æ”¹å±æ€§ä¸æ–¹ä¾¿ï¼Œå¿…é¡»å°†å¯¹è±¡ååºåˆ—åŒ–å‡ºæ¥å†æ’å…¥è¿›å»ã€‚è€Œä¸”éœ€è¦è€ƒè™‘å¹¶å‘é—®é¢˜ï¼›

  ç¬¬äºŒç§ç¡®å®šæ˜¯keyå¤ªå¤šï¼Œé€ æˆå­˜å‚¨ç©ºé—´è¿‡å¤§ï¼›

- Redisæä¾›çš„Hashå¾ˆå¥½çš„è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼ŒRedisçš„Hashå®é™…æ˜¯å†…éƒ¨å­˜å‚¨çš„Valueä¸ºä¸€ä¸ªHashMapï¼Œå¹¶æä¾›äº†ç›´æ¥å­˜å–è¿™ä¸ªMapæˆå‘˜çš„æ¥å£



#### List

> åº”ç”¨åœºæ™¯

1ã€å®ç°é˜Ÿåˆ— lpush rpop 

2ã€å®ç°å †æ ˆ lpush lpop

3ã€å®ç°åˆ†é¡µ lrange start stop

â€‹		å¤§æ•°æ®é‡çš„åˆ†é¡µ

4ã€å¯¹å¤§æ•°æ®è¿›è¡Œåˆ å‡ã€æ˜¾ç¤º

â€‹		å¦‚ï¼šå…³æ³¨åˆ—è¡¨ã€ç²‰ä¸åˆ—è¡¨ã€ç•™è¨€è¯„ä»·ç­‰;

5ã€ä»»åŠ¡é˜Ÿåˆ—



#### Set

> åº”ç”¨åœºæ™¯

1ã€å¸¸ç”¨äºå¯¹ä¸¤ä¸ªé›†åˆé—´çš„æ•°æ®åšäº¤é›†ã€å¹¶é›†ã€å·®é›†è¿ç®—ï¼š

â€‹	æ¯”å¦‚å¾®ä¿¡æŸ¥çœ‹2ä¸ªäººçš„å…±åŒå¥½å‹ï¼›

â€‹	æ¯”å¦‚å¾®åšæŸ¥çœ‹å…±åŒå…³æ³¨çš„äººï¼›

â€‹	å†é«˜çº§ä¸€ç‚¹ï¼Œæ¨èä½ å…³æ³¨çš„äººå…³æ³¨äº†è°ï¼›	

2ã€åˆ©ç”¨å”¯ä¸€æ€§ï¼Œç»Ÿè®¡ç½‘ç«™çš„è®¿é—®IPï¼›



#### ZSet

> åº”ç”¨åœºæ™¯

1ã€æ’è¡Œæ¦œï¼Œå¦‚æŸ¥çœ‹æ’åå‰10çš„äººï¼Œæˆ–è€…æŸ¥çœ‹æ‰€æœ‰äººçš„æ’åï¼Œæˆ–è€…æŸ¥çœ‹æŸä¸€ä¸ªåˆ†æ•°æ®µçš„äººï¼›

```java
System.out.println("       å…¨éƒ¨ç©å®¶æ’è¡Œæ¦œ                    ");
		Set<ZSetOperations.TypedTuple<String>> allPlayerList = redisTemplate.opsForZSet().reverseRangeWithScores(key, 0, -1);
		Iterator<ZSetOperations.TypedTuple<String>> iterator = allPlayerList.iterator();
		while(iterator.hasNext()) {
			ZSetOperations.TypedTuple<String> item = iterator.next();
			System.out.println("ç©å®¶IDï¼š"+item.getValue()+"ï¼Œ ç©å®¶å¾—åˆ†:"+Double.valueOf(item.getScore()).intValue());
		}

// reverseRangeWithScores
// reverseRangeByScoreWithScores
```



### Rediså®ç°åˆ†å¸ƒå¼é”

æ–¹æ¡ˆ1ï¼šé€šè¿‡setnxè¿™ä¸ªå‘½ä»¤ï¼Œåœ¨æ¯æ¬¡è¦æ‰§è¡Œredisæ“ä½œæ—¶åŠ ä¸€ä¸ªé”ï¼›å¦‚æœèƒ½æ‹¿åˆ°è¿™ä¸ªé”ï¼Œå°±ç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™ç­‰å¾…ã€‚

```java
String lockKey = "product_100_stock";
String stockStr = stringRedisTemplate.opsForValue().get("stock");
// å®ç°å…³é”®æ˜¯ç”¨åˆ°äº†setnxè¿™ä¸ªå‘½ä»¤
boolean result = stringRedisTemplate.opsForValue().setIfAbsent(lockKey, "20");
if (!result) {
  return "locked";
}
int stock = Integer.parseInt(stockStr);
if (stock > 0) {
  stock--;
  stringRedisTemplate.opsForValue().set("stock", String.valueOf(stock));
} else {
  return "error";
}
stringRedisTemplate.delete(lockKey);
return "success";
```

å¸¸è§çš„å‘ï¼š

1.å¦‚æœç¨‹åºè¿è¡Œä¸­æ­»æœºäº†æ€ä¹ˆå¤„ç†ï¼Ÿ

- åœ¨ä»£ç å—ä¸­åŠ try finallyï¼Œåˆ é™¤é”
- å¢åŠ é”çš„è¶…æ—¶æ—¶é—´ï¼Œé¿å…ç¨‹åºå¼‚å¸¸æ— æ³•é‡Šæ”¾é”ï¼›

2.è¶…æ—¶æ—¶é—´æ€ä¹ˆå»å®šæ¯”è¾ƒåˆç†ï¼Ÿä¸ä¼šæå‰æ¸…é™¤é”ï¼Œä»è€Œé€ æˆ`åˆ†å¸ƒå¼é”`é‡Šæ”¾é”™è¯¯ã€‚

- è€ƒè™‘åœ¨ä¸»çº¿ç¨‹é‡Œï¼Œå¼€å¯ä¸€ä¸ªå­çº¿ç¨‹ï¼Œå»ä¸æ–­çš„å®šæ—¶è½®è¯¢å»¶è¿Ÿé”çš„æ—¶é—´ã€‚ä¸»çº¿ç¨‹ç»“æŸåï¼Œç»“æŸå­çº¿ç¨‹ï¼›

3.å¦‚ä½•é¿å…è¯¯åˆ é”ï¼Ÿå¤šä¸ªçº¿ç¨‹å¤„ç†ï¼Œå¾ˆæœ‰å¯èƒ½ä¸€ä¸ªçº¿ç¨‹åˆ é™¤äº†å¦ä¸€ä¸ªçº¿ç¨‹çš„é”ï¼›

â€‹	line4:åœ¨è®¾ç½®é”çš„valueçš„æ—¶å€™ï¼Œè®¾ç½®ä¸€ä¸ªéšæœºå€¼ï¼Œä¿è¯ä¸åŒçš„æœºå™¨å¤„ç†çš„é”åä¸ç›¸åŒï¼›

â€‹	åˆ é™¤é”æ—¶ï¼Œå…ˆæ¯”è¾ƒå€¼ï¼Œå†å»åˆ é™¤é”ï¼› 



æ–¹æ¡ˆ2ï¼šredissionæ¡†æ¶äº†æä¾›äº†ä¸€ä¸ªåˆ†å¸ƒå¼é”çš„è§£å†³æ–¹æ¡ˆ

```
RLock rLock = redisson.getLock(lockKey);
```

1.å¦‚æœæ˜¯master-slaveræ¨¡å¼çš„redisæ¶æ„ï¼Œä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Ÿ

- redissionå†™æ˜¯ç”¨masterï¼Œè¯»æ˜¯ç”¨slaverã€‚å¦‚æœå†™çš„æ—¶å€™ï¼ŒmasteræŒ‚æ‰ï¼Œè¯»å–çš„slaverä¾ç„¶å¯ä»¥ç”¨ï¼Œä¼šå¯¼è‡´é”ä¸€ç›´æ— æ³•é‡Šæ”¾ï¼Œä»è€Œå¯¼è‡´æ­»é”ã€‚ 

2.redisåˆ†å¸ƒå¼é”æ€ä¹ˆæ”¯æŒé«˜å¹¶å‘ï¼Ÿ

**Redlockç®—æ³•ï¼š**

å‡è®¾æœ‰Nä¸ªç›¸åŒçš„redisèŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„redisæ¨¡å¼ä¸€æ ·ï¼Œä½†æ˜¯äº’ä¸å…³è”ã€‚

1.è®°å½•æ—¶é—´æˆ³ï¼›

2.ä¸ºæ¯ä¸ªredisèŠ‚ç‚¹è®¾ç½®çš„è¶…æ—¶æ—¶é—´ï¼Œä»¥åŠé”è¿‡æœŸæ—¶é—´ã€‚ é¿å…æœåŠ¡å™¨æŒ‚æ‰åï¼Œå®¢æˆ·ç«¯ä»ç„¶å»ç­‰å¾…æœåŠ¡å™¨å“åº”ï¼›(æ¯”å¦‚5ms)

3.å½“è®¾ç½®é”æ—¶ï¼Œå‘æ¯ä¸ªredisèŠ‚ç‚¹ä¸Šéƒ½è®¾ç½®ä¸€æ¬¡ï¼›

4.è®°å½•æˆåŠŸçš„èŠ‚ç‚¹æ•°ï¼Œä»¥åŠç´¯è®¡çš„ç”¨æ—¶æ—¶é—´ï¼›

5.å¦‚æœç´¯è®¡æ—¶é—´ä¸è¶…è¿‡é”è¿‡æœŸæ—¶é—´ï¼Œå¹¶ä¸”æˆåŠŸèŠ‚ç‚¹æ•°å¤§äºæ€»ç»“ç‚¹æ•°çš„ä¸€åŠæ•°é‡ï¼›

6.å¦‚æœç´¯è®¡æ—¶é—´è¶…è¿‡äº†é”çš„è¿‡æœŸæ—¶é—´ï¼Œé‚£ä¹ˆé”å¯èƒ½å·²ç»å¤±æ•ˆäº†ã€‚æˆ–è€…è·å–äº†å°äº3ä¸ªé”ï¼Œå¿…é¡»é‡Šæ”¾ï¼Œå¦åˆ™å½±å“å…¶ä»–clientè·å–é”ã€‚



```mermaid
graph TD
A(è®°å½•å¼€å§‹æ—¶é—´)-->B(ä¾æ¬¡è®¾ç½®redisèŠ‚ç‚¹é”Næ¬¡)
B-->C(è®°å½•è®¾ç½®æ—¶é—´)
B-->D(è®°å½•æˆåŠŸè®¾ç½®redisé”çš„èŠ‚ç‚¹æ•° R)
D-->E{R > N/2+1?}
C-->F{é”æœ‰æ•ˆæœŸ > è®¾ç½®æ—¶é—´}
F-->|æ˜¯|H
F-->|å¦|G
E-->|æ˜¯|H(è·å–é”æˆåŠŸ)
E-->|å¦|G(è·å–é”å¤±è´¥ )

```





### Redisäº‹ç‰©

#### ä¸¤ç±»é”™è¯¯

- è¯­æ³•é”™è¯¯

  å›æ»šæ“ä½œâ€”â€”discard

- æ‰§è¡Œé”™è¯¯

  è·³è¿‡é”™è¯¯ç»§ç»­æ‰§è¡Œ

  

redisTemplateæ‰§è¡Œ

```java
SessionCallback sessionCallback = new SessionCallback() {
  @Override
  public Object execute(RedisOperations redisOperations) throws DataAccessException {
    redisOperations.multi();
    redisTemplate.opsForValue().set(key, "1");
    redisTemplate.opsForValue().decrement(key);
    redisTemplate.opsForValue().set(key, "2");
    redisTemplate.opsForValue().set(key, "6");
    return redisOperations.exec();
  }
};
redisTemplate.execute(sessionCallback);
```





### Redisç¼“å­˜ä¸€è‡´æ€§

1.å¼ºä¸€è‡´æ€§â€”â€”å®æ—¶åŒæ­¥

æŸ¥è¯¢ç¼“å­˜ï¼Œç¼“å­˜ä¸å­˜åœ¨æŸ¥è¯¢DBï¼Œä¿å­˜åˆ°ç¼“å­˜ã€‚

æ›´æ–°ç¼“å­˜æ—¶ï¼Œå…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†å°†ç¼“å­˜çš„æ•°æ®è®¾ç½®ä¸ºè¿‡æœŸï¼›

æ³¨æ„ç‚¹ï¼š

**ç¼“å­˜ç©¿é€**

> æ¯æ¬¡æŸ¥è¯¢çš„æ—¶å€™ï¼Œæ•°æ®åº“éƒ½è¿”å›ç©ºï¼Œæ¯æ¬¡éƒ½æ²¡ç¼“å­˜æ•°æ®ï¼Œç»“æœæ¯æ¬¡éƒ½ä»æ•°æ®åº“ä¸­æŸ¥è¯¢

è§£å†³æ–¹æ¡ˆ
ä»ç¼“å­˜å–ä¸åˆ°çš„æ•°æ®ï¼Œåœ¨æ•°æ®åº“ä¸­ä¹Ÿæ²¡æœ‰å–åˆ°ï¼Œè¿™æ—¶ä¹Ÿå¯ä»¥å°†key-valueå¯¹å†™ä¸ºkey-nullï¼Œç¼“å­˜æœ‰æ•ˆæ—¶é—´å¯ä»¥è®¾ç½®çŸ­ç‚¹ï¼Œå¦‚30ç§’ï¼ˆè®¾ç½®å¤ªé•¿ä¼šå¯¼è‡´æ­£å¸¸æƒ…å†µä¹Ÿæ²¡æ³•ä½¿ç”¨ï¼‰ã€‚è¿™æ ·å¯ä»¥é˜²æ­¢æ”»å‡»ç”¨æˆ·åå¤ç”¨åŒä¸€ä¸ªidæš´åŠ›æ”»å‡»

**ç¼“å­˜å‡»ç©¿**

> æŸä¸€ä¸ªçƒ­ç‚¹Keyï¼Œåœ¨æŸä¸€ä¸ªæ—¶é—´é‡Œï¼Œç¼“å­˜å¤±æ•ˆäº†ã€‚è¿™æ—¶ç”±äºå¹¶å‘ç”¨æˆ·ç‰¹åˆ«å¤šï¼ŒåŒæ—¶è¯»ç¼“å­˜æ²¡è¯»åˆ°æ•°æ®ï¼ŒåˆåŒæ—¶å»æ•°æ®åº“å»å–æ•°æ®ï¼Œå¼•èµ·æ•°æ®åº“å‹åŠ›ç¬é—´å¢å¤§ï¼Œé€ æˆè¿‡å¤§å‹åŠ›

è§£å†³æ–¹æ¡ˆ

1. è®¾ç½®çƒ­ç‚¹æ•°æ®æ°¸è¿œä¸è¿‡æœŸï¼›
2. åŠ äº’æ–¥é”ï¼Œåªæœ‰1ä¸ªå»æ•°æ®åº“æŸ¥è¯¢ï¼›

**ç¼“å­˜é›ªå´©**

> ç¼“å­˜ä¸­æ•°æ®å¤§æ‰¹é‡åˆ°è¿‡æœŸæ—¶é—´ï¼Œè€ŒæŸ¥è¯¢æ•°æ®é‡å·¨å¤§ï¼Œå¼•èµ·æ•°æ®åº“å‹åŠ›è¿‡å¤§ç”šè‡³downæœºã€‚å’Œç¼“å­˜å‡»ç©¿ä¸åŒçš„æ˜¯ï¼Œç¼“å­˜å‡»ç©¿æŒ‡å¹¶å‘æŸ¥åŒä¸€æ¡æ•°æ®ï¼Œç¼“å­˜é›ªå´©æ˜¯ä¸åŒæ•°æ®éƒ½è¿‡æœŸäº†ï¼Œå¾ˆå¤šæ•°æ®éƒ½æŸ¥ä¸åˆ°ä»è€ŒæŸ¥æ•°æ®åº“ã€‚

è§£å†³æ–¹æ¡ˆï¼š

1.è®¾ç½®ä¸åŒçš„è¿‡æœŸæ—¶é—´ï¼›

2.çƒ­ç‚¹è®¾ç½®ä¸è¿‡æœŸ



### Redisä¸»ä»å¤åˆ¶

masterä¸»èŠ‚ç‚¹ç”¨æ¥å†™å…¥æ•°æ®ï¼Œslaverå­èŠ‚ç‚¹ç”¨æ¥è¯»å–æ•°æ®ï¼Œ`ä¸»èŠ‚ç‚¹`å®šæœŸæŠŠæ•°æ®åŒæ­¥åˆ°`ä»èŠ‚ç‚¹`æ¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚

#### ä¸»ä»å¤åˆ¶æ¶æ„

**a)  ä¸€ä¸»ä¸€ä»**ï¼šå½“`ä¸»èŠ‚ç‚¹`çš„â€œå†™â€å‘½ä»¤å¹¶å‘é«˜ä¸”éœ€è¦æŒä¹…åŒ–æ—¶ï¼Œå¯ä»¥åªåœ¨`ä»èŠ‚ç‚¹`å¼€å¯AOFï¼ˆä¸»èŠ‚ç‚¹ä¸éœ€è¦ï¼‰ã€‚

 <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-031252.png" width="150" align="center"/>



**b) ä¸€ä¸»å¤šä»**ï¼šå½“å¯¹"è¯»"çš„è¦æ±‚æ¯”è¾ƒå¤§æ—¶ï¼Œè¿™ç§ç»“æ„æ¯”è¾ƒåˆé€‚ã€‚ä¸»èŠ‚ç‚¹åªè´Ÿè´£å†™å…¥ï¼Œç„¶ååŒæ­¥åˆ°ä»èŠ‚ç‚¹ã€‚ä½†æ˜¯å¯¹ä¸»èŠ‚ç‚¹çš„å½±å“æ¯”è¾ƒå¤§ï¼Œå› ä¸º`ä¸»èŠ‚ç‚¹`ä¼šåŒæ­¥åˆ°å¤šä¸ª`ä»èŠ‚ç‚¹`ï¼Œä¼šæ¶ˆè€—å¸¦å®½å’Œå†…å­˜ã€‚

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-032919.png" width="450" />



c) **æ ‘å½¢ç»“æ„**ï¼šå¯ä»¥è§£å†³ä¸Šé¢ä¸€ä¸»å¤šä»ï¼Œä¸»èŠ‚ç‚¹å‹åŠ›è¿‡å¤§çš„é—®é¢˜ï¼›



#### æ•°æ®åŒæ­¥

a) å…¨é‡å¤åˆ¶ï¼šä¸€èˆ¬ç”¨äºåˆæ¬¡å¤åˆ¶åœºæ™¯ï¼ˆç¬¬ä¸€æ¬¡å»ºç«‹SLAVEåå…¨é‡ï¼‰
b) éƒ¨åˆ†å¤åˆ¶ï¼šç½‘ç»œå‡ºç°é—®é¢˜ï¼Œä»èŠ‚ç‚¹å†æ¬¡è¿æ¥ä¸»èŠ‚ç‚¹æ—¶ï¼Œä¸»èŠ‚ç‚¹è¡¥å‘ç¼ºå°‘çš„æ•°æ®ï¼Œæ¯æ¬¡æ•°æ®å¢é‡åŒæ­¥
c) å¿ƒè·³ï¼šä¸»ä»æœ‰é•¿è¿æ¥å¿ƒè·³ï¼Œä¸»èŠ‚ç‚¹é»˜è®¤æ¯10Så‘ä»èŠ‚ç‚¹å‘pingå‘½ä»¤ï¼Œrepl-ping-slave-periodæ§åˆ¶å‘é€é¢‘ç‡

#### ä¸»ä»çš„ç¼ºç‚¹

**a)** è‹¥ä¸»èŠ‚ç‚¹å‡ºç°é—®é¢˜ï¼Œåˆ™ä¸èƒ½æä¾›æœåŠ¡ï¼Œéœ€è¦äººå·¥ä¿®æ”¹é…ç½®å°†ä»å˜ä¸»ã€‚
**b)** `ä¸»èŠ‚ç‚¹`çš„å†™èƒ½åŠ›å•æœºï¼Œèƒ½åŠ›æœ‰é™
**c)** å•æœºèŠ‚ç‚¹çš„å­˜å‚¨èƒ½åŠ›ä¹Ÿæœ‰é™



### å“¨å…µæœºåˆ¶(Sentinel)

> ä¸»è¦æ˜¯ä¸ºäº†è§£å†³ä¸»ä»å¤åˆ¶çš„ç¼ºç‚¹ï¼Œè‡ªåŠ¨å¯¹èŠ‚ç‚¹è¿›è¡Œç›‘æ§ã€‚å½“ä¸»èŠ‚ç‚¹ä¸å¯ç”¨æ—¶ï¼Œè‡ªåŠ¨å°†ä¸»èŠ‚ç‚¹çš„å­èŠ‚ç‚¹è½¬æ¢ä¸ºä¸»èŠ‚ç‚¹ï¼Œå¹¶ä¸”é€šçŸ¥å®¢æˆ·ç«¯ã€‚

#### 1.**é«˜å¯ç”¨**

å½“ä¸»èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶ï¼Œç”±sentinelè‡ªåŠ¨å®Œæˆæ•…éšœå‘ç°å’Œè½¬ç§»ï¼Œå¹¶ä¸”é€šçŸ¥åº”ç”¨ã€‚

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-065139.png" width="300"/>



**ç›‘æ§åŸç†**ï¼š

1ï¼šæ¯10sé’Ÿï¼Œå“¨å…µå‘masterèŠ‚ç‚¹è·å–ä¸€ä¸‹ä¿¡æ¯ï¼Œæ¥ç¡®è®¤ä¸»ä»èŠ‚ç‚¹çš„æ‹“æ‰‘å…³ç³»ï¼›

![1227483-20180201113518031-1426392070](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-081111.png)

2ï¼šæ¯2sé’Ÿï¼Œæ¯ä¸ªå“¨å…µä¼šå‘masterèŠ‚ç‚¹çš„å›ºå®šé¢‘é“ä¸Šå‘é€ä¸»æ¨æ¶ˆæ¯(å“¨å…µå¯¹masterèŠ‚ç‚¹çš„åˆ¤æ–­ã€å“¨å…µè·å–åˆ°çš„èŠ‚ç‚¹ä¿¡æ¯)ã€‚åŒæ—¶ï¼Œæ¯ä¸ªå“¨å…µä¹Ÿä¼šå»è®¢é˜…è¿™ä¸ªå›ºå®šé¢‘é“ï¼Œäº†è§£å…¶ä»–å“¨å…µå¯¹è¿™ä¸ªèŠ‚ç‚¹çš„åˆ¤æ–­ã€‚

![1227483-20180201113623921-1930278582](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-081103.png)

3ï¼šæ¯sé’Ÿï¼Œæ¯ä¸ªå“¨å…µä¹Ÿä¼šå‘å…¶ä»–å“¨å…µä»¥åŠä¸»ã€ä»èŠ‚ç‚¹å‘é€pingå‘½ä»¤ï¼›ç”¨æ¥ç¡®å®šèŠ‚ç‚¹æ˜¯å¦æ­£å¸¸ï¼›

![1227483-20180201115230609-828804435](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-081055.png)



**ä¸‹çº¿çŠ¶æ€**

1.ä¸»è§‚ä¸‹çº¿ï¼š

å“¨å…µæ¯éš”1så‘å…¶ä»–èŠ‚ç‚¹å‘é€pingå‘½ä»¤ï¼Œåœ¨down-after-millisecondsæœ‰æ•ˆæœŸå†…ï¼Œå¦‚æœæ²¡æœ‰å“åº”ï¼Œå°±ä¼šä¸»è§‚çš„å°†è¿™ä¸ªèŠ‚ç‚¹ä¸‹çº¿ï¼›å¹¶ä¸”å‘å…¶ä»–èŠ‚ç‚¹ç¡®è®¤æ˜¯å¦éƒ½æ˜¯ä¸»è§‚ä¸‹çº¿çš„ã€‚![1227483-20180201121656031-220411144](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-102223.png)

2.å®¢è§‚ä¸‹çº¿ï¼š

å½“ä¸»è§‚ä¸‹çº¿çš„å®¢æˆ·æ•°é‡è¶…è¿‡quorumï¼ˆquorum = (èŠ‚ç‚¹æ•°é‡/2) + 1ï¼‰æ—¶ï¼Œåˆ™è®¤ä¸ºèŠ‚ç‚¹æ˜¯å®¢è§‚ä¸‹çº¿çŠ¶æ€ã€‚

å½“èŠ‚ç‚¹è¢«å“¨å…µå®¢è§‚ä¸‹çº¿ä»¥åï¼Œå“¨å…µä¼šé€šè¿‡é€‰ä¸¾ç®—æ³•ï¼Œé€‰å‡ºä¸€ä¸ªå“¨å…µæ¥è´Ÿè´£è¿›è¡Œæ•…éšœè½¬ç§»ã€‚ æ¯ä¸ªå‘ç°èŠ‚ç‚¹å®¢è§‚ä¸‹çº¿çš„å“¨å…µéƒ½æœ‰æƒé™ç”³è¯·æˆä¸ºæ•…éšœè½¬ç§»çš„å“¨å…µï¼›é€‰ä¸¾å…ˆåˆ°å…ˆå¾—ï¼Œæˆä¸ºæ•…éšœè½¬ç§»çš„å“¨å…µä¼šé€‰æ‹©ä¸€ä¸ªä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ä½œä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼›

![1227483-20180201115626875-1938202974](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-102151.png)



**æ•…éšœè½¬ç§»æµç¨‹**

1.é€‰ä¸¾æ–°çš„ä¸»èŠ‚ç‚¹

```mermaid
graph TD
A(ç½‘ç»œè¿æ¥æ­£å¸¸)-->B(5ç§’å†…å›å¤è¿‡INFOå‘½ä»¤)
B --> C(10*down-after-millsecondså†…æœ‰è¿æ¥è¿‡ä¸»æœº)
C --> D(æœåŠ¡å™¨ä¼˜å…ˆçº§)
D --> E(å¤åˆ¶åç§»é‡å¤§çš„)
E --> F(è¿è¡Œidè¾ƒå°)
F --> G(æ–°çš„master)

```

2.å°†å…¶ä»–èŠ‚ç‚¹è®¾ç½®ä¸º`æ–°ä¸»èŠ‚ç‚¹`çš„ä»èŠ‚ç‚¹

![1227483-20180201121911671-2038984859](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-102239.png)

3ã€é€šçŸ¥å®¢æˆ·ç«¯ï¼Œæ–°çš„ä¸»èŠ‚ç‚¹çš„ipã€portç­‰ä¿¡æ¯ï¼›



### RedisæŒä¹…åŒ–

#### RDBå­˜å‚¨

> é»˜è®¤æŒä¹…åŒ–æœºåˆ¶

rdbç›¸å½“äºå¿«ç…§ï¼Œå°†å†…å­˜ä¸­çš„æ•°æ®ä»¥å¿«ç…§çš„æ–¹å¼ä¿å­˜åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œé»˜è®¤æ–‡ä»¶åä¸ºdump.rdb;

ä¼˜ç‚¹ï¼š

â€‹	ä¿å­˜å¿«ï¼Œè¯»å–æ¢å¤å¿«ï¼›

ç¼ºç‚¹ï¼š

â€‹	åšå¿«ç…§çš„æ—¶å€™ï¼Œå ç”¨å†…å­˜é«˜ï¼›	

#### AOF

> Append of fileï¼Œå°†redisçš„**å†™å…¥å‘½ä»¤**è¿½åŠ åˆ°æ–‡ä»¶ä¸­ï¼›

ä¸‰ç§aofæ–¹å¼ï¼š

- â€‹	æ¯æ¬¡å†™å…¥è¿½åŠ æ–‡ä»¶ appendfsync always 

ç¼ºç‚¹ï¼šæœ‰æ—¶æˆ‘ä»¬åªå…³æ³¨ç»“æœï¼Œå¹¶ä¸æƒ³å…³æ³¨æ¯æ¬¡å†™å…¥çš„è¿‡ç¨‹ï¼›

- â€‹	æ¯ç§’é’Ÿè¿½åŠ æ–‡ä»¶ appendfsync everysec

ç¼ºç‚¹ï¼šé¢‘ç‡å¤ªé«˜ï¼Œå®¹æ˜“å ç”¨ç£ç›˜å¤ªå¤šï¼›

- â€‹	æ°¸è¿œä¸è¿½åŠ  appendfsync no

ç¼ºç‚¹: å®¹æ˜“ä¸¢å¤±ï¼›





## Nginx

```nginx
server {
    listen 80;
    server_name ~^(manage|om|broker|risk|sms)\.pre\.gsoms\.top$;

    #æ ¹æ®regex(æ­£åˆ™è¡¨è¾¾å¼)æ¥åŒ¹é…å†…å®¹è·³è½¬åˆ°replacement

    if ($http_host ~ ^(.*)) {
        set $domain $1;
       rewrite ^(.*) https://$domain break; #å°†æ‰€æœ‰è¯·æ±‚éƒ½é‡å®šå‘åˆ°https
  }
}
```





nginxå®‰å…¨ä½“ç³»æ¶æ„

nginxæ­å»ºé›†ç¾¤

nginxè´Ÿè½½å‡è¡¡ç­–ç•¥

æœåŠ¡å™¨å®•æœºå®¹é”™æœºåˆ¶

nginxæ­å»ºä¼ä¸šAPIæ¥å£



åˆ†å¸ƒå¼ä¸é›†ç¾¤çš„åŒºåˆ«

Keepalivedé«˜å¯ç”¨æ¦‚å¿µ

nginx+keepalivedé«˜å¯ç”¨

sessionå…±äº«è§£å†³æ–¹æ¡ˆ

é«˜å¹¶å‘è§£å†³æ–¹æ¡ˆ



# MQæ¶ˆæ¯ä¸­é—´ä»¶

### ä½¿ç”¨åœºæ™¯

1.è§£è€¦

å½“AæœåŠ¡éœ€è¦è¢«å¤šä¸ªæœåŠ¡å¼•ç”¨æ—¶ï¼Œä¸éœ€è¦é¢‘ç¹çš„ä¿®æ”¹AæœåŠ¡çš„æ¥å£ï¼Œåªéœ€è¦å¯¹å¤–æä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œéœ€è¦ç”¨åˆ°çš„æœåŠ¡å»è®¢é˜…è¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å°±å¯ä»¥ï¼›

2.å¼‚æ­¥å¤„ç†è¯·æ±‚

æœ‰ä¸€äº›ä¸šåŠ¡åœºæ™¯ï¼šæ¯”å¦‚å‘é€é‚®ä»¶ã€å‘é€çŸ­ä¿¡ç­‰ã€‚å¦‚æœæ˜¯åŒæ­¥çš„æƒ…å†µï¼Œéœ€è¦ç­‰é‚®ä»¶å‘é€åå†è¿”å›è¯·æ±‚ï¼›é‚£å¦‚æœæ˜¯å¼‚æ­¥çš„è¯ï¼Œå°±å¯ä»¥å°†å‘é€é‚®ä»¶ã€å‘é€çŸ­ä¿¡çš„ä»»åŠ¡åŠ å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç›´æ¥è¿”å›å“åº”ç»“æœï¼›

3.å‰Šå³°

åœºæ™¯: ç§’æ€æ´»åŠ¨ï¼Œä¸€èˆ¬ä¼šå› ä¸ºæµé‡è¿‡å¤§ï¼Œå¯¼è‡´åº”ç”¨æŒ‚æ‰ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸€èˆ¬ä¼šå°†è¯·æ±‚åŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—ã€‚ 

1.ç”¨æˆ·çš„è¯·æ±‚,æœåŠ¡å™¨æ”¶åˆ°ä¹‹å,é¦–å…ˆå†™å…¥æ¶ˆæ¯é˜Ÿåˆ—,åŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—é•¿åº¦è¶…è¿‡æœ€å¤§å€¼,åˆ™ç›´æ¥æŠ›å¼ƒç”¨æˆ·è¯·æ±‚æˆ–è·³è½¬åˆ°é”™è¯¯é¡µé¢. 

2.ç§’æ€ä¸šåŠ¡æ ¹æ®æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„è¯·æ±‚ä¿¡æ¯ï¼Œå†åšåç»­å¤„ç†.



### MQå®‰è£…éƒ¨ç½²

MQå®‰è£…

> https://www.jianshu.com/p/60c358235705

MQå¯åŠ¨

```
âœ  ~ sudo rabbitmq-server -detached
```

MQç®¡ç†ç«¯

```
http://localhost:15672/
guest
guest
```




### MQé€šä¿¡æ–¹å¼

**é€šä¿¡åè®®**ï¼š`amqpåè®®`



### æ¶ˆæ¯é˜Ÿåˆ—

#### ç®€å•æ¶ˆæ¯é˜Ÿåˆ—

<img src="https://www.rabbitmq.com/img/tutorials/python-one.png" />

```java
// ç”Ÿäº§è€… -- Producer.java
connection = connectionFactory.newConnection();
channel = connection.createChannel();
// å£°æ˜é€šé“é˜Ÿåˆ—
channel.queueDeclare(QUEUE_NAME, false, false, false, null);
String message = "Hello World";
channel.basicPublish("", QUEUE_NAME, null, message.getBytes());
System.out.println(" [x] Sent '" + message + "'");

// æ¶ˆè´¹è€… -- Receiver.java
Consumer consumer = new Consumer() {
  @Override
  public void handleDelivery(String s, Envelope envelope, AMQP.BasicProperties basicProperties, byte[] bytes) throws IOException {
    String message = new String(bytes, "UTF-8");
    System.out.println("[X] recived" + message);
  }
};
channel.basicConsume(TASK_QUEUE_NAME, autoAck, consumer);
```



ç¼ºç‚¹ï¼š1.è€¦åˆæ€§é«˜ï¼Œç”Ÿäº§è€…1-1å¯¹åº”æ¶ˆè´¹è€…ã€‚æ— æ³•ç”¨å¤šä¸ªæ¶ˆè´¹è€…å»å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—ï¼›

2.é˜Ÿåˆ—åå˜æ›´æ—¶ï¼Œéœ€è¦åŒæ—¶å˜æ›´ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„ä»£ç ï¼›



#### Work Queues(æ¶ˆæ¯åˆ†å‘)



![image-20190927183530447](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-27-103531.png)

ä¸€ä¸ªé˜Ÿåˆ—å¯ä»¥åˆ†é…ç»™å¤šä¸ªæ¶ˆè´¹è€…

##### Round-robin dispatching (è½®è¯¢åˆ†å‘)

> æ¶ˆæ¯å®¢æˆ·ç«¯å¹³å‡åˆ†é…æ‰€æœ‰çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ— è®ºæ¶ˆè´¹è€…çš„å¤„ç†èƒ½åŠ›å¦‚ä½•ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…éƒ½ä¼šè½®æµå¤„ç†ä¸€ä¸ªæ¶ˆæ¯ï¼›
>
> æ¶ˆæ¯å‘é€åä¼šè‡ªåŠ¨åˆ é™¤é˜Ÿåˆ—çš„æ¶ˆæ¯ï¼›

```java
// consumer.java æ¶ˆè´¹è€…
try {
	Connection connection = connectionFactory.newConnection();
  Channel channel = connection.createChannel();
  // å£°æ˜é˜Ÿåˆ—
  channel.queueDeclare(TASK_QUEUE_NAME, true, false, false, null);
  DeliverCallback deliverCallback = (tag, delivery) -> {
    String message = new String(delivery.getBody(), "UTF-8");
    try {
      doWork(message);
      System.out.println("[X] recived" + message);
    } finally {
    }
  };
  // è‡ªåŠ¨å‘é€ç¡®è®¤å›æ‰§
  boolean autoAck = true;
  channel.basicConsume(TASK_QUEUE_NAME, autoAck, deliverCallback, consumerTag -> {
  });
} catch (Exception e) {
  e.printStackTrace();
}
```



##### Fair dispatching (å…¬å¹³åˆ†å‘)

> é™åˆ¶æ¯æ¬¡æ¶ˆæ¯å‘é€è€…åªå‘é€1ä¸ªæ¶ˆæ¯ï¼Œå¹¶ä¸”ç­‰å¾…æ¶ˆè´¹è€…å‘é€æ¶ˆæ¯ç¡®è®¤ackï¼Œæ‰ä¼šå»åˆ é™¤æ¶ˆæ¯é˜Ÿåˆ—ï¼›
>
> æ³¨ï¼šéœ€è¦å…³é—­è‡ªåŠ¨Ack, å¹¶ä¸”å½“æ¶ˆè´¹è€…å¤„ç†å®Œæ¶ˆæ¯åï¼Œæ‰‹åŠ¨è¿”å›Ackç¡®è®¤ã€‚

**å…³é”®è®¾ç½®**ï¼šqos

åœ¨éè‡ªåŠ¨ç¡®è®¤æ¶ˆæ¯çš„å‰æä¸‹ï¼Œå¦‚æœä¸€å®šæ•°é‡çš„æ¶ˆæ¯æœªè¢«ç¡®è®¤ï¼Œä¸è¿›è¡Œæ–°çš„æ¶ˆæ¯æ¶ˆè´¹ï¼›

- void BasicQos(uint prfetchSize,ushort prefetchCount,bool global);

**å‚æ•°è§£é‡Šï¼š**
*prefetchSize*: æ¶ˆæ¯çš„é™åˆ¶å¤§å°ï¼Œæ¶ˆæ¯å¤šå°‘å…†ã€‚ä¸€èˆ¬ä¸åšé™åˆ¶ï¼Œè®¾ç½®ä¸º0

*prefetchCount*: ä¼šå‘Šè¯‰RabbitMQä¸è¦åŒæ—¶ç»™ä¸€ä¸ªæ¶ˆè´¹è€…æ¨é€å¤šäºNä¸ªæ¶ˆæ¯ï¼Œå³ä¸€æ—¦æœ‰Nä¸ªæ¶ˆæ¯è¿˜æ²¡æœ‰ackï¼Œåˆ™è¯¥consumerå°†blockæ‰ï¼Œç›´åˆ°æœ‰æ¶ˆæ¯ackã€‚ä¸€èˆ¬è®¾ç½®ä¸º1

*global*:  true\false æ˜¯å¦å°†ä¸Šé¢è®¾ç½®åº”ç”¨äºchannelã€‚true è¡¨ç¤ºchannelçº§åˆ«ï¼Œfalseè¡¨ç¤ºåœ¨consumerçº§åˆ«

```java
// Consumer.java
Connection connection = connectionFactory.newConnection();
Channel channel = connection.createChannel();
// å£°æ˜é˜Ÿåˆ—
channel.queueDeclare(TASK_QUEUE_NAME, true, false, false, null);
// qos(æœåŠ¡è´¨é‡ä¿è¯)åŠŸèƒ½
channel.basicQos(1);
DeliverCallback deliverCallback = (tag, delivery) -> {
  String message = new String(delivery.getBody(), "UTF-8");
  System.out.println("[X] recived" + message);
  try {
    doWork(message);
  } finally {
    // æ‰‹åŠ¨ç¡®è®¤ï¼Œå¦‚æœå¿˜è®°ï¼Œæ¶ˆæ¯ä¸€ç›´æ— æ³•ç¡®è®¤ï¼Œä¼šå†…å­˜æº¢å‡º
    channel.basicAck(delivery.getEnvelope().getDeliveryTag(), false);
  }
};
// å–æ¶ˆè‡ªåŠ¨å‘é€ç¡®è®¤å›æ‰§
boolean autoAck = false;
channel.basicConsume(TASK_QUEUE_NAME, autoAck, deliverCallback, consumerTag -> {
});
```

å¦‚æœå¿˜äº†ç¡®è®¤æ¶ˆæ¯ï¼Œé‚£ä¹ˆä¼šå µå¡ä½ï¼š

![image-20191002094429036](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-02-014430.png)

##### 



#### MQå‘å¸ƒè®¢é˜…

##### Exchangeæ¶ˆæ¯äº¤æ¢æœº

> Exchangeä¸»è¦ç”¨æ¥å°†æ¶ˆæ¯è½¬å‘åˆ°ä¸åŒçš„é˜Ÿåˆ—

- directæ¨¡å¼ï¼šå¤„ç†routing key.

  `Direct`è¦æ±‚è¯¥æ¶ˆæ¯çš„è·¯ç”±é”®**å®Œå…¨åŒ¹é…**ã€‚

![174578-20180524175810062-1941410843](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-28-031932.png)

- topicæ¨¡å¼ï¼šé€šé…ç¬¦æ¥åŒ¹é…routing key

![174578-20180524175844359-92574693](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-28-031950.png)

- fanout: ä¸å¤„ç†routing key, æ‰€æœ‰æ¶ˆæ¯éƒ½ä¼šé€šè¿‡exchangeè½¬å‘åˆ°ç»‘å®šçš„queue

![174578-20180524175832191-777772730](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-28-031943.png)



##### Fanoutæ¨¡å¼

æ‰€æœ‰çš„æ¶ˆæ¯éƒ½ä¼šè½¬å‘åˆ°æ‰€æœ‰ç»‘å®šçš„é˜Ÿåˆ—ä¸Šå»

<img src="https://www.rabbitmq.com/img/tutorials/python-three-overall.png" />

1.ä¸€ä¸ªç”Ÿäº§è€…å¯¹åº”å¤šä¸ªæ¶ˆè´¹è€…

2.æ¯ä¸ªæ¶ˆè´¹è€…æœ‰è‡ªå·±çš„æ¶ˆæ¯é˜Ÿåˆ—

3.ç”Ÿäº§è€…çš„æ¶ˆæ¯ä¸ç›´æ¥å‘å¾€é˜Ÿåˆ—ï¼Œè€Œæ˜¯é€šè¿‡äº¤æ¢æœº(exchange)æ¥å‘é€

4.æ¯ä¸ªé˜Ÿåˆ—çš„è¦å’Œäº¤æ¢æœºç»‘å®š

```java
//Publisher.java
// å£°æ˜äº¤æ¢æœº
 channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.FANOUT);
 channel.basicPublish(EXCHANGE_NAME, "", null, message.getBytes());
  
// Sub.java
// å£°æ˜exchange
channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.FANOUT);
String queueName = channel.queueDeclare().getQueue();
// ç»‘å®šexchange
channel.queueBind(queueName, EXCHANGE_NAME, "");
DeliverCallback deliverCallback = (consumerTag, delivery) -> {
  String message = new String (delivery.getBody(), "UTF-8");
  System.out.println(" [x] Receive '" + message + "'");
};
channel.basicConsume(queueName, true, deliverCallback, consumerTag -> {});
```

æ§åˆ¶å°ç•Œé¢ï¼š

![image-20190928110243950](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-28-030244.png)

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-28-025845.png" alt="image-20190928105844979" style="zoom:50%;" />



##### Routingæ¨¡å¼

> Routingä¹Ÿæ˜¯è®¢é˜…-å‘å¸ƒæ¨¡å¼ä¸€ç§ï¼Œåªä¸è¿‡å¢åŠ äº†ä¸€å±‚ `routing-key`å’Œ`æ¶ˆæ¯-key`çš„ç»‘å®šå…³ç³»

![image-20190928112840060](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-28-032840.png)

```java
// Publishe.java
try {
  connrection = connectionFactory.newConnection();
  channel = connection.createChannel();
  // å£°æ˜äº¤æ¢æœºç±»å‹
  channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);
  channel.basicPublish(EXCHANGE_NAME, routingKey, null, message.getBytes());
} catch (Exception e) {
  e.printStackTrace();
}

// Subscriber.java
try {
  connection = connectionFactory.newConnection();
  channel = connection.createChannel();
  // å£°æ˜exchange
  channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);
  String queueName = channel.queueDeclare("queue_info", false, false, false, null)
    .getQueue();
  // ç»‘å®šexchangeï¼Œæœ€åå‚æ•°æ˜¯routing-key
  channel.queueBind(queueName, EXCHANGE_NAME, "info");
  channel.queueBind(queueName, EXCHANGE_NAME, "error");
  channel.queueBind(queueName, EXCHANGE_NAME, "warning");

  DeliverCallback deliverCallback = (consumerTag, delivery) -> {
    String message = new String (delivery.getBody(), "UTF-8");
    System.out.println(" [x] Receive '" + message + "'");
  };
  channel.basicConsume(queueName, true, deliverCallback, consumerTag -> {});
} catch (Exception e) {
  e.printStackTrace();
}

```

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-28-035111.png" height="300"/>





##### Topicæ¨¡å¼

å°†routing-keyå’Œbingd-keyç”¨é€šé…ç¬¦çš„æ¨¡å¼è®¢é˜…

- \* (star) èƒ½åŒ¹é…ä»»æ„1ä¸ªè¯.
- \# (hash) å¯ä»¥åŒ¹é…0æˆ–è€…å¤šä¸ªè¯.

![image-20190928121435095](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-28-041435.png)

```java
// Publisher.java
try {
  connection = connectionFactory.newConnection();
  channel = connection.createChannel();
  // å£°æ˜äº¤æ¢æœº
  channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.TOPIC);
  channel.basicPublish(EXCHANGE_NAME, type, null, message.getBytes());
  System.out.println(" [x] Sent '" + message + "'");
} catch (Exception e) {
  e.printStackTrace();
}

// Sub.java
try {
  connection = connectionFactory.newConnection();
  channel = connection.createChannel();
  // å£°æ˜exchange
  channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.TOPIC);
  String queueName = channel.queueDeclare("queue_kern.*", false, false, false, null)
    .getQueue();
  // ç»‘å®šexchange
  channel.queueBind(queueName, EXCHANGE_NAME, "kern.*");

  DeliverCallback deliverCallback = (consumerTag, delivery) -> {
    String message = new String (delivery.getBody(), "UTF-8");
    System.out.println(" [x] Receive '" + message + "'");
  };
  channel.basicConsume(queueName, true, deliverCallback, consumerTag -> {});
} catch (Exception e) {
  e.printStackTrace();
}
```



### æ¶ˆæ¯æŒä¹…åŒ–ä¸æ¶ˆæ¯ç¡®è®¤æœºåˆ¶

>  é—®é¢˜ï¼šä¸ºä»€ä¹ˆè¦æ¶ˆæ¯æŒä¹…åŒ–ï¼Ÿ
>
>  MQæ¥æ”¶åˆ°æ¶ˆæ¯åï¼ŒBindingå¯ä»¥æœ¬åœ°æŒä¹…åŒ–æ¶ˆæ¯ï¼Œè¿™æ ·å¯ä»¥é¿å…å› ä¸ºæœåŠ¡å™¨å®•æœºå¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±ã€‚
>
>  é—®é¢˜ï¼šä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯ç¡®è®¤ï¼Ÿ
>
>  å› ä¸ºæˆ‘ä»¬æ— æ³•ä¿è¯æ¶ˆæ¯å‘å¸ƒè€…åœ¨å°†æ¶ˆæ¯å‘å¸ƒå‡ºå»åï¼Œæ¶ˆæ¯èƒ½å¤Ÿæ­£ç¡®åˆ°è¾¾æ¶ˆæ¯é˜Ÿåˆ—é‡Œã€‚æ¶ˆæ¯ç¡®è®¤çš„æœ€ä¸»è¦çš„ç›®çš„å°±æ˜¯ä¸ºäº†ç¡®ä¿æ¶ˆæ¯è¦100%ä¼ é€’åˆ°MQä¸­ï¼Œé¿å…æ¶ˆæ¯åœ¨åˆ°è¾¾MQçš„é˜¶æ®µå·²ç»ä¸¢å¤±ã€‚

å¦‚ä½•ç¡®ä¿æ¶ˆæ¯100%æŠ•é€’æˆåŠŸï¼Ÿ

- ä¿éšœæ¶ˆæ¯çš„æˆåŠŸå‘å‡º

- ä¿éšœMQèŠ‚ç‚¹çš„æˆåŠŸæ¥æ”¶
- å‘é€ç«¯æ”¶åˆ°MQèŠ‚ç‚¹ï¼ˆBrokerï¼‰ç¡®è®¤åº”ç­”
- å®Œå–„çš„æ¶ˆæ¯è¿›è¡Œè¡¥å¿æœºåˆ¶

å› ä¸ºå‰3æ­¥åˆ†åˆ«ä»ç”Ÿäº§è€…ã€æ¶ˆæ¯é˜Ÿåˆ—ã€æ¶ˆè´¹è€…3ä¸ªç¯èŠ‚è¿›è¡Œç¡®è®¤ï¼Œä½†æ˜¯éƒ½ä¸èƒ½100%ä¿è¯æ¶ˆæ¯æŠ•é€’æˆåŠŸï¼Œå› æ­¤éœ€è¦åŠ ä¸Šç¬¬4æ­¥ã€‚

ä¸€èˆ¬çš„è¡¥å¿æœºåˆ¶æ–¹æ¡ˆå¦‚ä¸‹ï¼š

æ–¹æ¡ˆ1ï¼š`æ¶ˆæ¯è½åº“`

![image-20190930114011178](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-30-034012.png)

åœ¨äº’è”ç½‘å¤§å‚ï¼Œä¸€èˆ¬éƒ½ä¼šé‡‡ç”¨`æ¶ˆæ¯è½åº“`çš„æ–¹æ¡ˆï¼Œæ¥è¿›è¡Œæ¶ˆæ¯è¡¥å¿ï¼Œé¿å…æ¶ˆæ¯ä¸¢å¤±ã€‚

- æ¶ˆæ¯çŠ¶æ€åˆ†ä¸º3ç§ï¼Œ`æœªå‘é€`ã€`å·²å‘é€`ã€`å·²é€è¾¾`ã€‚å‘é€æ¶ˆæ¯çš„åŒæ—¶ï¼Œå°†æ¶ˆæ¯æŒä¹…åŒ–åˆ°æ•°æ®åº“ä¸­ï¼Œå¹¶ä¸”ç»™æ¶ˆæ¯è®¾ç½®å¥½çŠ¶æ€`å·²å‘é€`ã€‚å½“æ¶ˆæ¯çŠ¶æ€å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œå°†æ•°æ®åº“ä¸­çš„æ¶ˆæ¯çŠ¶æ€åŒæ­¥å˜æ›´ã€‚

- å¯¹äºå·²å‘é€æœªåˆ°è¾¾çš„æ¶ˆæ¯ï¼Œä¼šå®šæ—¶å»åšè½®è¯¢æ“ä½œï¼Œè°ƒç”¨ç”Ÿäº§è€…é‡æ–°å‘é€ã€‚ä½†æ˜¯é‡æ–°å‘é€çš„æ¬¡æ•°ä¹Ÿéœ€è¦åšä¸ªé™åˆ¶ï¼Œä¿æŒåœ¨3-5æ¬¡ã€‚

è¿™ä¸ªæ–¹æ¡ˆä¸»è¦ç¼ºç‚¹æœ‰2ä¸ªï¼š

- æ€§èƒ½ç“¶é¢ˆï¼šæ¶ˆæ¯è½åº“ã€ä»¥åŠæ¶ˆæ¯çŠ¶æ€å˜æ›´éƒ½ä¼šè½åº“ï¼Œä¼šé€ æˆæ•°æ®åº“å‹åŠ›è¿‡å¤§ï¼›

- äº‹ç‰©ä¸€è‡´æ€§ï¼šå‘é€æ¶ˆæ¯ã€æ¶ˆæ¯è½åº“2ä¸ªåŠ¨ä½œéœ€è¦æœ‰äº‹ç‰©æœºåˆ¶ä¿æŠ¤ï¼Œè¿™ç‚¹ä¹Ÿä¼šé€ æˆæ€§èƒ½ä¸‹é™ï¼›

  

æ–¹æ¡ˆ2ï¼š å»¶è¿Ÿç¡®è®¤

![image-20190930121108552](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-30-041109.png)

- ç¬¬ä¸€æ­¥ï¼Œç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—
- ç¬¬äºŒæ­¥ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ç›‘å¬æ¶ˆè´¹è€…æ¶ˆæ¯ç¡®è®¤
- ç¬¬ä¸‰æ­¥ï¼Œæ¶ˆè´¹è€…å‘é€æ¶ˆæ¯ç¡®è®¤ä¿¡æ¯
- ç¬¬å››æ­¥ï¼Œcallbackç›‘å¬mqçš„æ¶ˆæ¯ç¡®è®¤
- ç¬¬äº”æ­¥ï¼Œæ›´æ–°æ¶ˆæ¯çŠ¶æ€ï¼Œç¡®å®šæ¶ˆæ¯å‘é€æˆåŠŸï¼›
- ==åœ¨ç¬¬ä¸€æ­¥ä¸­ï¼Œç”Ÿäº§è€…å‘é€æ¶ˆæ¯åï¼Œå¯ä»¥è®¾ç½®å»¶è¿Ÿ2-5åˆ†é’Ÿï¼Œå†æ¬¡å‘é€æ¶ˆæ¯ï¼Œç¡®è®¤ä¸Šæ¬¡å‘é€çš„æ¶ˆæ¯å¦å·²ç»é€è¾¾==
- ==callbackä¼šå»ç›‘å¬mqçš„è¿™ä¸ªç¡®è®¤æ¶ˆæ¯ï¼Œå¹¶å¯¹éœ€è¦ç¡®è®¤çš„æ¶ˆæ¯è¿›è¡Œæ£€æŸ¥ï¼›==
- ==å¦‚æœæ¶ˆæ¯å·²ç»å‘é€æˆåŠŸï¼Œä¸åšå¤„ç†ï¼›å¦‚æœæ¶ˆæ¯æ²¡æœ‰æˆåŠŸï¼Œä¼šè¿œç¨‹è°ƒç”¨ç”Ÿäº§è€…æœåŠ¡å†æ¬¡å‘é€æ¶ˆæ¯==ï¼›



### æ¶ˆæ¯Returnæœºåˆ¶

> æ¶ˆæ¯é‡å›æœºåˆ¶æ˜¯ä¸ºäº†å¯¹æ²¡æœ‰å¤„ç†æˆåŠŸçš„æ¶ˆæ¯ï¼ŒæŠŠæ¶ˆæ¯é‡æ–°ä¼ é€’ç»™MQ Brokerã€‚
>
> Return Listenerå°±æ˜¯ç”¨æ¥å®ç°è¿™ä¸€æœºåˆ¶çš„ï¼›

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-01-090144.png" width="400"/>

å½“ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼ŒMQæ‰¾ä¸åˆ°ä»»ä½•åŒ¹é…çš„æ¶ˆæ¯Exchangeï¼Œæˆ–è€…åŒ¹é…åˆ°äº†Exchangeå´æ— æ³•æ‰¾åˆ°å¯¹åº”`Routing-Key`çš„æ¶ˆè´¹é˜Ÿåˆ—Queueã€‚

é‚£ä¹ˆMQæ— æ³•å¤„ç†è¿™äº›æ¶ˆæ¯ï¼Œæ‰€ä»¥éœ€è¦è¿˜ç»™ç”Ÿäº§è€…é‡æ–°å¤„ç†è¿™äº›æ¶ˆæ¯ï¼ˆæ¯”å¦‚é‡æ–°å‘é€ï¼‰ï¼›

å› æ­¤MQ Brokeræä¾›äº†è¿™ç§Returnæœºåˆ¶ï¼Œé€šè¿‡è®¾ç½®Return Listeneræ¥å»å¤„ç†è¿™äº›ä¸å¯é€è¾¾çš„æ¶ˆæ¯ã€‚

```java
// Producer.java
Connection connection = connectionFactory.newConnection();
Channel channel = connection.createChannel();
String exchange = "return_true_exchange";
String routingKey = "all";
String routingKeyError = "all-error";
channel.exchangeDeclare(exchange, BuiltinExchangeType.DIRECT);
channel.addReturnListener((int replyCode, String replyText, String exchange1, String routingKey1, AMQP.BasicProperties properties, byte[] body) -> {
  String txt = new String(body, "UTF-8");
  System.out.format("æ¶ˆæ¯è¢«è¿”å›%s, exhcange: %s, routingKey: %s\n",txt, exchange1, routingKey1);
});
// å½“routingKeyåŒ¹é…ä¸ä¸Šçš„æ—¶å€™ï¼Œmqä¼šé€šè¿‡ReturnListeneræ¥è‡ªåŠ¨è¿”å›æ¶ˆæ¯ï¼›
if (isReturn) {
  channel.basicPublish(exchange, routingKeyError, true, null, message.getBytes());
} else {
  channel.basicPublish(exchange, routingKey, true, null, message.getBytes());
}
```



### æ¶ˆæ¯äº‹ç‰©

äº‹åŠ¡ä¸»è¦æ˜¯ä¿è¯æ¶ˆæ¯è¦å‘é€åˆ°Brokerå½“ä¸­ã€‚

- amqpåè®®è‡ªå¸¦æ”¯æŒçš„äº‹ç‰©

  > - txSelect() å°†å½“å‰channelè®¾ç½®æˆtransactionæ¨¡å¼
  > - txCommit() æäº¤äº‹åŠ¡
  > - txRollback() å›æ»šäº‹åŠ¡

  ```java
  // Producer.java
  connection = connectionFactory.newConnection();
  channel = connection.createChannel();
  // å£°æ˜äº¤æ¢æœº
  channel.queueDeclare(QUEUE_NAME, false, false, false, null);
  channel.txSelect();
  String message = "this result is: ";
  channel.basicPublish("", QUEUE_NAME, null, message.getBytes());
  double count = dividend / divisor;
  channel.basicPublish("", QUEUE_NAME, null, String.valueOf(count).getBytes());
  channel.txCommit();
  System.out.println(" [x] Sent '" + message + "'");
  ```

  

- confirmæ¨¡å¼

  - ä¸²è¡Œç¡®è®¤æ¨¡å¼

    ```java
  // Producer.java
    // å•ä¸ªç¡®è®¤
    connection = connectionFactory.newConnection();
    channel = connection.createChannel();
    channel.queueDeclare(QUEUE_NAME, false, false, false, null);
    channel.confirmSelect();
    long start = System.nanoTime();
    for (int i = 0; i < MESSAGE_COUNT; i++) {
      String body = String.valueOf(i);
      channel.basicPublish("", QUEUE_NAME, null, body.getBytes());
      channel.waitForConfirmsOrDie(5_000);
    }
    long end = System.nanoTime();
    
    =============
      // æ‰¹é‡ç¡®è®¤
    connection = connectionFactory.newConnection();
    channel = connection.createChannel();
    channel.queueDeclare(QUEUE_NAME, false, false, false, null);
    channel.confirmSelect();
    connection = connectionFactory.newConnection();
    for (int i = 0; i < MESSAGE_COUNT; i++) {
      String body = String.valueOf(i);
      channel.basicPublish("", QUEUE_NAME, null, body.getBytes());
    }
    channel.waitForConfirmsOrDie(5_000);
    long end = System.nanoTime();
    ```
  
    

  - å¼‚æ­¥ç¡®è®¤æ¨¡å¼

    ```java
  connection = connectionFactory.newConnection();
    channel = connection.createChannel();
    channel.queueDeclare(QUEUE_NAME, false, false, false, null);
    // å¼€å¯ç¡®è®¤æ¨¡å¼
    channel.confirmSelect();
    ConcurrentNavigableMap<Long, String> outstandingConfirms = new ConcurrentSkipListMap<>();
    // æˆåŠŸçš„å¤„ç†
    ConfirmCallback cleanOutstandingConfirms = (sequenceNumber, multiple) -> {
      if (multiple) {
        ConcurrentNavigableMap<Long, String> confirmed = outstandingConfirms.headMap(sequenceNumber, true);
        confirmed.clear();
      } else {
        outstandingConfirms.remove(sequenceNumber);
      }
      System.out.println("æ¶ˆæ¯å‘é€æˆåŠŸï¼š" + sequenceNumber);
    };
    // æ·»åŠ ç¡®è®¤ç›‘å¬å™¨listener
    channel.addConfirmListener(cleanOutstandingConfirms, (sequenceNumber, multiple) -> {
      // å¤±è´¥çš„å¤„ç†
      String body = outstandingConfirms.get(sequenceNumber);
      System.err.format(
        "Message with body %s has been nack-ed. Sequence number: %d, multiple: %b%n",
        body, sequenceNumber, multiple
      );
      // å¤±è´¥äº†ï¼Œäº¤ç»™cleanOutstandingConfirmså†æ¬¡å¤„ç†
      cleanOutstandingConfirms.handle(sequenceNumber, multiple);
    });
    long start = System.nanoTime();
    for (int i = 0; i < MESSAGE_COUNT; i++) {
      String body = String.valueOf(i);
      outstandingConfirms.put(channel.getNextPublishSeqNo(), body);
      channel.basicPublish("", QUEUE_NAME, null, body.getBytes());
    }
    long end = System.nanoTime();
    System.out.format("Published %,d messages and handled confirms asynchronously in %,d ms%n", MESSAGE_COUNT, Duration.ofNanos(end - start).toMillis());
    ```



> ä¸åŒæ¨¡å¼çš„è¿è¡Œæ•ˆæœï¼š
>
> Published 50,000 messages individually in 13,080 ms
>
> Published 50,000 messages in batch in 2,935 ms
>
> Published 50,000 messages and handled confirms asynchronously in 3,446 ms
>
> å¯ä»¥çœ‹å‡ºæ¥ï¼Œå•ä¸ªè¿è¡Œçš„æ•ˆç‡æ¯”è¾ƒæ…¢ï¼Œæ‰¹é‡ç¡®è®¤ä»¥åŠå¼‚æ­¥ç¡®è®¤çš„æ¨¡å¼æ•ˆç‡è¾ƒé«˜ï¼›





## é›†æˆSpring

> https://gitee.com/dendi.ke/thread-demo/blob/master/pom.xml

ç›¸å…³ä¾èµ–

```xml
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-amqp</artifactId>
</dependency>
```

Springé…ç½®æ–‡ä»¶

```properties
#rabbitmq
spring.rabbitmq.username=user
spring.rabbitmq.password=Abc123123
spring.rabbitmq.addresses=127.0.0.1
spring.rabbitmq.port=5672
spring.rabbitmq.publisher-confirms=true
spring.rabbitmq.virtual-host=/
```

MqConfig.java

å¯ä»¥å•ç‹¬å£°æ˜ä¸€ä¸ªç±»ï¼Œä½œä¸ºmqçš„é…ç½®ç±»ã€‚è¿™ä¸ªç±»é‡Œé¢å¯ä»¥å®šä¹‰æ¯”å¦‚MqFactoryã€RabbitAdminç­‰å·¥å‚ç±»ã€‚

```java
/**
 * @Author: Coda
 * @Create Date: 2019-09-29 14:35
 * @Update Date: 2019-09-29 14:35
 */
@Configuration
public class RabbitMqConfig {

	@Value("${spring.rabbitmq.addresses}")
	private String host;

	@Value("${spring.rabbitmq.port}")
	private int port;

	@Value("${spring.rabbitmq.username}")
	private String username;

	@Value("${spring.rabbitmq.password}")
	private String password;

	@Value("${spring.rabbitmq.virtual-host}")
	private String virtualHost;

	@Value("${spring.rabbitmq.publisher-confirms}")
	private boolean publisherConfirms;

	@Bean
	public ConnectionFactory connectionFactory() {
		CachingConnectionFactory cachingConnectionFactory = new CachingConnectionFactory();
		cachingConnectionFactory.setHost(host);
		cachingConnectionFactory.setPort(port);
		cachingConnectionFactory.setUsername(username);
		cachingConnectionFactory.setPassword(password);
		cachingConnectionFactory.setVirtualHost(virtualHost);
		cachingConnectionFactory.setPublisherConfirms(publisherConfirms);
		cachingConnectionFactory.setPublisherReturns(true);
		return cachingConnectionFactory;
	}

	@Bean
	public RabbitAdmin rabbitAdmin(ConnectionFactory connectionFactory) {
		RabbitAdmin rabbitAdmin = new RabbitAdmin(connectionFactory);
		rabbitAdmin.setAutoStartup(true);
		return rabbitAdmin;
	}


	@Bean
	@Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE)
	public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) {
		RabbitTemplate rabbitTemplate = new RabbitTemplate(connectionFactory);
		return rabbitTemplate;
	}
}
```





#### RabbitAdmin

> RabbitAdminç±»å¯ä»¥å¾ˆå¥½çš„æ”¯æŒRabbitMQ, åœ¨Springä¸­ç›´æ¥è¿›è¡Œæ³¨å…¥å³å¯
>
> - autoStartUpå¿…é¡»è¦è®¾ç½®ä¸ºtrue,å¦åˆ™Springå®¹å™¨ä¸ä¼šåŠ è½½RabbitAdminç±»
> - RabbitAdminåº•å±‚å®ç°å°±æ˜¯ä»Springå®¹å™¨ä¸­è·å–Exchangeã€Bingdingã€RoutingKeyä»¥åŠQueueçš„@Beanå£°æ˜

RabbitAdminçš„ä½¿ç”¨ï¼šé€šè¿‡@Autowiredå¯¼å…¥åˆ°ç±»é‡Œï¼Œç„¶ååˆ©ç”¨rabbitAdminæ¥å®šä¹‰é˜Ÿåˆ—

```java
//ç›´è¿ç›‘å¬
rabbitAdmin.declareExchange(new DirectExchange("test.direct", false, false));

rabbitAdmin.declareExchange(new TopicExchange("test.topic", false, false));

rabbitAdmin.declareExchange(new FanoutExchange("test.fanout", false, false));

rabbitAdmin.declareQueue(new Queue("test.direct.queue", false));

rabbitAdmin.declareQueue(new Queue("test.topic.queue", false));

rabbitAdmin.declareQueue(new Queue("test.fanout.queue", false));

//ç¬¬ä¸€ä¸ªå‚æ•°ï¼šå…·ä½“çš„é˜Ÿåˆ— ç¬¬äºŒä¸ªå‚æ•°ï¼šç»‘å®šçš„ç±»å‹ ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šäº¤æ¢æœº ç¬¬å››ä¸ªå‚æ•°ï¼šè·¯ç”±key ç¬¬äº”ä¸ªå‚æ•°ï¼šarguments å‚æ•°
rabbitAdmin.declareBinding(new Binding("test.direct.queue",
                                       Binding.DestinationType.QUEUE,
                                       "test.direct", "direct", new HashMap<>()));

//BindingBuilder é“¾å¼ç¼–ç¨‹
rabbitAdmin.declareBinding(
  BindingBuilder
                .bind(new Queue("test.topic.queue", false))     //ç›´æ¥åˆ›å»ºé˜Ÿåˆ—
                .to(new TopicExchange("test.topic", false, false))  //ç›´æ¥åˆ›å»ºäº¤æ¢æœº å»ºç«‹å…³è”å…³ç³»
                .with("user.#"));   //æŒ‡å®šè·¯ç”±Key


rabbitAdmin.declareBinding(
          BindingBuilder
                .bind(new Queue("test.fanout.queue", false))        
          .to(new FanoutExchange("test.fanout", false, false)));

//æ¸…ç©ºé˜Ÿåˆ—æ•°æ®
rabbitAdmin.purgeQueue("test.topic.queue", false);
```



#### å£°æ˜æ¶ˆæ¯é˜Ÿåˆ—



#### RabbitTemplate

> æ¶ˆæ¯æ¨¡æ¿
>
> è¯¥ç±»æä¾›äº†ä¸°å¯Œçš„å‘é€æ¶ˆæ¯æ–¹æ³•ï¼ŒåŒ…æ‹¬å¯é æ€§æŠ•é€’æ¶ˆæ¯æ–¹æ³•ã€å›è°ƒç›‘å¬æ¶ˆæ¯æ¥å£ConfirmCallbackã€è¿”å›å€¼ç¡®è®¤æ¥å£ReturnCallbackç­‰ç­‰ã€‚åŒæ ·æˆ‘ä»¬éœ€è¦è¿›è¡Œæ³¨å…¥åˆ°Springå®¹å™¨ä¸­ï¼Œç„¶åç›´æ¥ä½¿ç”¨ã€‚



#### SimpleMessageListenerContainer

**ç®€å•æ¶ˆæ¯ç›‘å¬å®¹å™¨**

- ç›‘å¬é˜Ÿåˆ—(å¤šä¸ªé˜Ÿåˆ—)ã€è‡ªåŠ¨å¯åŠ¨ã€è‡ªåŠ¨å£°æ˜åŠŸèƒ½
- è®¾ç½®äº‹åŠ¡ç‰¹æ€§ã€äº‹åŠ¡ç®¡ç†å™¨ã€äº‹åŠ¡å±æ€§ã€äº‹åŠ¡å®¹å™¨(å¹¶å‘)ã€æ˜¯å¦å¼€å¯äº‹åŠ¡ã€å›æ»šæ¶ˆæ¯ç­‰
- è®¾ç½®æ¶ˆè´¹è€…æ•°é‡ã€æœ€å°æœ€å¤§æ•°é‡ã€æ‰¹é‡æ¶ˆè´¹
- è®¾ç½®æ¶ˆæ¯ç¡®è®¤å’Œè‡ªåŠ¨ç¡®è®¤æ¨¡å¼ã€æ˜¯å¦é‡å›é˜Ÿåˆ—ã€å¼‚å¸¸æ•æ‰handlerå‡½æ•°
- è®¾ç½®æ¶ˆè´¹è€…æ ‡ç­¾ç”Ÿæˆç­–ç•¥ã€æ˜¯å¦ç‹¬å æ¨¡å¼ã€æ¶ˆè´¹è€…å±æ€§ç­‰
- è®¾ç½®å…·ä½“çš„ç›‘å¬å™¨ã€æ¶ˆæ¯è½¬æ¢å™¨ç­‰ç­‰ã€‚

```java
@Bean
	public SimpleMessageListenerContainer messageListenerContainer(ConnectionFactory connectionFactory) {
		SimpleMessageListenerContainer container = new SimpleMessageListenerContainer(connectionFactory);
		container.setQueues(queue1());
		container.setConcurrentConsumers(1);
		container.setMaxConcurrentConsumers(5);
		container.setDefaultRequeueRejected(false);
		container.setAcknowledgeMode(AcknowledgeMode.AUTO);
		container.setExposeListenerChannel(true);
		container.setConsumerTagStrategy(queue ->  queue + "_" + UUID.randomUUID().toString());
    // è®¾ç½®å…·ä½“çš„ç›‘å¬å™¨
		container.setMessageListener(message -> {
				String msg = new String(message.getBody());
				System.err.println("----------æ¶ˆè´¹è€…: " + msg);
		});
}
```



#### MessageListenerAdapter æ¶ˆæ¯ç›‘å¬é€‚é…å™¨

**é»˜è®¤handleMessage**

```java
// åŒæ ·åœ¨SimpleMessageListenerContainer è¿™ä¸ªæ–¹æ³•é‡Œ
MessageListenerAdapter adapter = new MessageListenerAdapter(new MessageDelegate());
container.setMessageListener(adapter);

// MessageDelegateç±»
public class MessageDelegate {
    public void handleMessage(byte[] messageBody) {
        System.err.println("é»˜è®¤æ–¹æ³•, æ¶ˆæ¯å†…å®¹:" + new String(messageBody));
    }
}
```

MessageDelegateç±»ä¸­ï¼Œæ–¹æ³•åä¸å‚æ•°`handleMessage(byte[] messageBody)`æ˜¯å›ºå®šçš„ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

**MessageListenerAdapteræºç åˆ†æ**

æˆ‘ä»¬æ¥çœ‹ä¸‹MessageListenerAdapteråº•å±‚ä»£ç 

![image-20190929181504955](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-29-101505.png)é»˜è®¤æ–¹æ³•åå°±æ˜¯å«handleMessageï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è‡ªå·±å»æŒ‡å®šè®¾ç½®

**è‡ªå®šä¹‰æ–¹æ³•å**

```java
MessageListenerAdapter adapter = new MessageListenerAdapter(new MessageDelegate());
adapter.setDefaultListenerMethod("consumeMessage");
container.setMessageListener(adapter);

//å¯¹åº”ä¹Ÿè¦ä¿®æ”¹MessageDelegateç±»
public class MessageDelegate {
    public void consumeMessage(byte[] messageBody) {
        System.err.println("å­—èŠ‚æ•°ç»„æ–¹æ³•, æ¶ˆæ¯å†…å®¹:" + new String(messageBody));
    }
}
```



#### MessageConverteræ¶ˆæ¯è½¬æ¢å™¨

æˆ‘ä»¬åœ¨è¿›è¡Œå‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œæ­£å¸¸æƒ…å†µä¸‹æ¶ˆæ¯ä½“ä¸ºäºŒè¿›åˆ¶çš„æ•°æ®æ–¹å¼è¿›è¡Œä¼ è¾“ã€‚å¯¹åº”çš„adapterçš„æ–¹æ³•å…¥å‚ä¹Ÿæ˜¯äºŒè¿›åˆ¶æ•°ç»„ã€‚å¦‚æœå¸Œæœ›è¿›è¡Œè½¬æ¢ï¼ŒæŒ‡å®šè‡ªå®šä¹‰çš„è½¬æ¢å™¨ï¼Œå°±éœ€è¦ç”¨åˆ°MessageConverter

- è‡ªå®šä¹‰å¸¸ç”¨è½¬æ¢å™¨ï¼šMessageConverterï¼Œä¸€èˆ¬æ¥è®²éƒ½éœ€è¦å®ç°è¿™ä¸ªæ¥å£
- é‡å†™ä¸‹é¢ä¸¤ä¸ªæ–¹æ³•ï¼š
  `toMessage`: javaå¯¹è±¡è½¬æ¢ä¸ºMessage
  `fromMessage`: Messageå¯¹è±¡è½¬æ¢ä¸ºjavaå¯¹è±¡
- Jsonè½¬æ¢å™¨ï¼šJackson2JsonMessageConverter:å¯ä»¥è¿›è¡ŒJavaå¯¹è±¡çš„è½¬æ¢åŠŸèƒ½
- DefaultJackson2JavaTypeMapperæ˜ å°„å™¨ï¼šå¯ä»¥è¿›è¡Œjavaå¯¹è±¡çš„æ˜ å°„å…³ç³»
- è‡ªå®šä¹‰äºŒè¿›åˆ¶è½¬æ¢å™¨ï¼šæ¯”å¦‚å›¾ç‰‡ç±»å‹ã€PDFã€PPTã€æµåª’ä½“

```java
// æ–‡å­—è½¬åŒ–å™¨
public class TextMessageConverter implements MessageConverter {

    @Override
    public Message toMessage(Object object, MessageProperties messageProperties) throws MessageConversionException {
        return new Message(object.toString().getBytes(), messageProperties);
    }

    @Override
    public Object fromMessage(Message message) throws MessageConversionException {
        String contentType = message.getMessageProperties().getContentType();
        if(null != contentType && contentType.contains("text")) {
            return new String(message.getBody());
        }
        return message.getBody();
    }

}
```



### æ¶ˆæ¯çš„å¹‚ç­‰æ€§

> å¹‚ç­‰ï¼ˆidempotentã€idempotenceï¼‰æ˜¯ä¸€ä¸ªæ•°å­¦ä¸è®¡ç®—æœºå­¦æ¦‚å¿µï¼Œå¸¸è§äºæŠ½è±¡ä»£æ•°ä¸­ï¼Œå³f(f(x)) = f(x)ã€‚ç®€å•çš„æ¥è¯´å°±æ˜¯**ä¸€ä¸ªæ“ä½œå¤šæ¬¡æ‰§è¡Œäº§ç”Ÿçš„ç»“æœä¸ä¸€æ¬¡æ‰§è¡Œäº§ç”Ÿçš„ç»“æœä¸€è‡´**ã€‚

**å†¥ç­‰æ€§çš„ä½œç”¨**ï¼š

åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œä¼šæœ‰å¤§é‡çš„æ¶ˆæ¯åˆ°è¾¾MQï¼Œæ¶ˆè´¹ç«¯ä¼šæ¥å—åˆ°å¤§é‡çš„æ¶ˆæ¯ã€‚è¿™æ ·çš„æƒ…å†µä¸‹ï¼Œéš¾å…ä¼šå‡ºç°æ¶ˆæ¯çš„é‡å¤æŠ•é€’ï¼Œç½‘ç»œå¼‚å¸¸ç­‰æƒ…å†µã€‚å¦‚æœä¸å»åšå¹‚ç­‰å¤„ç†ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šå‡ºç°æ¶ˆæ¯çš„**é‡å¤æ¶ˆè´¹**ã€‚

**å¹‚ç­‰æ€§çš„æ–¹æ¡ˆ**ï¼š

- å”¯ä¸€ID+æŒ‡çº¹ç æœºåˆ¶ï¼Œåˆ©ç”¨æ•°æ®åº“ä¸»é”®å»é‡
- åˆ©ç”¨Redisçš„åŸå­æ€§å®ç°



### TTL ç”Ÿå­˜æ—¶é—´

- TTLæ˜¯Time To Liveçš„ç¼©å†™ï¼Œä¹Ÿå°±æ˜¯ç”Ÿå­˜æ—¶é—´
- RabbitMQæ”¯æŒæ¶ˆæ¯çš„è¿‡æœŸæ—¶é—´ï¼Œåœ¨æ¶ˆæ¯å‘é€æ—¶å¯ä»¥è¿›è¡ŒæŒ‡å®šç”Ÿå­˜æ—¶é—´ï¼›ä»æ¶ˆæ¯è¿›å…¥é˜Ÿåˆ—å¼€å§‹è®¡ç®—ï¼Œåªè¦è¶…è¿‡äº†é˜Ÿåˆ—çš„æ—¶é—´é…ç½®ï¼Œæ¶ˆæ¯ä¼šè‡ªåŠ¨åˆ é™¤ï¼›



```java
// TTL Demo
String exchangName = "demo_ttl_exchange";
String queueName = "demo_ttl_queue";
// åˆ é™¤é˜Ÿåˆ—
rabbitAdmin.deleteQueue(queueName);
// åˆ é™¤Exchange
rabbitAdmin.deleteExchange(exchangName);
Map<String, Object> arguments = new HashMap<>();
arguments.put("x-message-ttl", 10000);
arguments.put("x-max-length", 1);
Queue queue = new Queue(queueName, true, false, false, arguments);
rabbitAdmin.declareExchange(new TopicExchange(exchangName));
rabbitAdmin.declareQueue(queue);
rabbitAdmin.declareBinding(new Binding(queueName, Binding.DestinationType.QUEUE, exchangName, "ttl.#", null));
org.springframework.amqp.core.MessageProperties messageProperties = new org.springframework.amqp.core.MessageProperties();
Message messageObj = new Message(message.getBytes(), messageProperties);
rabbitTemplate.convertAndSend(exchangName, "ttl.message", messageObj);

```





### æ­»ä¿¡é˜Ÿåˆ— DLX

>å½“æ¶ˆæ¯è¢«æ‹’æ”¶(basic.reject / basic.nack) å¹¶ä¸”requeue = falseæ—¶
>
>æˆ–è€…å½“æ¶ˆæ¯TTLåˆ°æœŸ
>
>æˆ–è€…å½“æ¶ˆæ¯é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§çš„é•¿åº¦
>
>è¿™äº›æ¶ˆæ¯èƒ½å¤Ÿé‡æ–°å‘é€åˆ°ä¸€ä¸ªExchangeé‡Œï¼Œè¿™ä¸ªExchangeå°±æ˜¯DLX

**Demo**

å£°æ˜ä¸€ä¸ªæ­»ä¿¡é˜Ÿåˆ—å’ŒRoutingKey

> Exchange: dlx.exchange; (Exchangeåç§°éšæ„)ï¼›
>
> RoutingKey: dlx (RoutingKeyåç§°éšæ„ï¼Œåªéœ€è¦å’Œé˜Ÿåˆ—èƒ½æ¥å—åˆ°å³å¯)

æ­£å¸¸å£°æ˜ Exchangeã€Queueã€RoutingKeyï¼Œå¹¶ä¸”è®¾ç½®Queueå‚æ•°ï¼š("x-dead-letter-exchange","dlx.exchange");

è¿™æ ·æ¶ˆæ¯åœ¨TTLè¿‡æœŸã€æˆ–è€…å½“é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦æ—¶ï¼Œæ¶ˆæ¯å°±å¯ä»¥ç›´æ¥è·¯ç”±åˆ°æ­»ä¿¡é˜Ÿåˆ—ï¼

![image-20191003163250278](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-03-083251.png)

![image-20191003163316561](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-03-083317.png)

```java
// RabbitMqConfig.java
@Bean
public Exchange dlxExchange() {
  return new DirectExchange(DEAD_EXCHANGE_NAME);
}

@Bean
public Queue dlxQueue() {
  Queue queue = new Queue(QUEUE_NAME);
  return queue;
}

@Bean
public Binding bindDlxQueue(Queue dlxQueue, Exchange dlxExchange) {
  return BindingBuilder.bind(dlxQueue).to(dlxExchange).with("dlx").noargs();
}

// Producer.java
String exchangeName = "test_dlx_exchange";
String queueName = "test_dlx_queue";
String routingKey = "demo_dlx";
String message = "Hello RabbitMQ DLX Message";
Map<String, Object> args = new HashMap<>(2);
args.put("x-dead-letter-exchange", "dlx_exchange");
args.put("x-dead-letter-routing-key", "dlx");
rabbitAdmin.declareQueue(new Queue(queueName, true, false, false, args));
rabbitAdmin.declareExchange(new TopicExchange(exchangeName));
rabbitAdmin.declareBinding(new Binding(queueName, Binding.DestinationType.QUEUE, exchangeName, routingKey, null));
for(int i = 0; i< 1; i ++){
  MessageProperties messageProperties = new MessageProperties();
  messageProperties.setDeliveryMode(MessageProperties.DEFAULT_DELIVERY_MODE);
  messageProperties.setExpiration("10000");
  Message msg = new Message((message + i).getBytes(), messageProperties);
  rabbitTemplate.convertAndSend(exchangeName, routingKey, msg);
}
```

æ³¨ï¼š`test_dlx_queue`å£°æ˜äº†å‚æ•°ï¼Œè®¾ç½®äº†æ­»ä¿¡exchangeä¸º`dlx_exchange`

å½“`test_dlx_queue`æ¶ˆæ¯å˜æˆæ­»ä¿¡æ—¶ï¼Œæ¶ˆæ¯ä¼šè‡ªåŠ¨è½¬å‘`dlx_exchange` -> `dlx_queue`;



## ä»»åŠ¡è°ƒåº¦

ä»»åŠ¡è°ƒåº¦æ¦‚è¿°

ä½¿ç”¨Quartzå®ç°

åˆ†å¸ƒå¼ä»»åŠ¡å¦‚ä½•è§£å†³"å¹‚ç­‰æ€§"

XX-JOBç¯å¢ƒ

åˆ†å¸ƒå¼ä»»åŠ¡å¹³å°æ‰§è¡ŒåŸç†

ä»»åŠ¡è°ƒåº¦å¹³å°æ‰§è¡Œå™¨è¿è¡Œ

ä»»åŠ¡è°ƒåº¦å¹³å°è·¯ç”±ç­–ç•¥



## åˆ†å¸ƒå¼äº‹ç‰©

åˆ†å¸ƒå¼äº‹ç‰©äº§ç”ŸåŸå› 

åˆ†å¸ƒå¼äº‹ç‰©è§£å†³æ–¹æ¡ˆ

CPAä¸Baseç†è®º

2PC-ä¸¤æ®µæäº¤åè®®

ä½¿ç”¨MQè§£å†³åˆ†å¸ƒå¼äº‹ç‰©

LCNæ¡†æ¶æ¦‚è¿°

LCNæ¡†æ¶åŸç†

LCNæ¡†æ¶æµç¨‹

å¯åŠ¨tx-mananger

æ¼”ç¤ºåˆ†å¸ƒå¼äº‹ç‰©äº§æ™¯

ä½¿ç”¨LCNæ¡†æ¶è§£å†³åˆ†å¸ƒå¼äº‹ç‰©



## åˆ†å¸ƒå¼æ¡†æ¶1

SpringCloudæ¦‚è¿°

æœåŠ¡æ³¨å†Œä¸æœåŠ¡å‘ç°

æ­å»ºEurekaæ³¨å†Œä¸­å¿ƒ(æœåŠ¡å‘ç°)

å‘å¸ƒæœåŠ¡ä¼šå‘˜æä¾›è€…

æ¶ˆè´¹ä¼šå‘˜æœåŠ¡

springcloudè°ƒç”¨æœåŠ¡åŸç†

springcloudæœåŠ¡è´Ÿè½½å‡è¡¡å®ç°åŸç†

ä½¿ç”¨Ribbonæ­å»ºå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨

ä»€ä¹ˆæ˜¯æ¥å£ç½‘å…³

ä½¿ç”¨Zuulæ­å»ºæœåŠ¡æ¥å£ç½‘å…³ (æ™ºèƒ½è·¯ç”±)

ä½¿ç”¨Zuulç½‘å…³æ‹¦æˆªå‚æ•°

åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒæ¦‚è¿°

ä½¿ç”¨feginå®¢æˆ·ç«¯

æœåŠ¡é›ªå´©æ•ˆåº”äº§ç”ŸåŸå› 

é›ªå´©æ•ˆåº”è§£å†³æ–¹æ¡ˆ

ä½¿ç”¨hystrixå®ç°æœåŠ¡é™çº§

ä½¿ç”¨hystrixè§£å†³æœåŠ¡é›ªå´©åŸå› 



## åˆ†å¸ƒå¼æ¡†æ¶2

Dubboæ¶æ„åŸç†

Dubboåº”ç”¨åœºæ™¯

Dubboåˆ›å»ºé¡¹ç›®æ¶æ„æ¨¡å¼

å‘å¸ƒä¼šå‘˜æœåŠ¡

è®¢å•æ¶ˆè´¹æœåŠ¡

Dubbo-Admin

Dubboå®ç°è´Ÿè½½å‡è¡¡ã€å®¹é”™

Dubbxä½¿ç”¨



## Zookeeper

Zookeeperæ¦‚è¿°

Zookeeperåº”ç”¨åœºæ™¯

Zookeeperä¸´æ—¶èŠ‚ç‚¹

Watcheräº‹ä»¶é€šçŸ¥

Zookeeperå®ç°åˆ†å¸ƒå¼é”

è§£å†³ç”Ÿäº§è®¢å•å·çº¿ç¨‹å®‰å…¨é—®é¢˜

Zookeeperå®ç°åˆ†å¸ƒå¼é”è§£å†³æ–¹æ¡ˆ

Zookeeperå®ç°è´Ÿè½½å‡è¡¡åŸç†

å¦‚ä½•å®ç°è´Ÿè½½å‡è¡¡ç­–ç•¥

å¦‚ä½•å®ç°è´Ÿè½½å‡è¡¡è½®è®­ç®—æ³•

å¦‚ä½•ä½¿ç”¨Zookeeperå®ç°é€‰ä¸¾ç­–ç•¥



# ç§»åŠ¨ç«¯è§£å†³æ–¹æ¡ˆ

ç§»åŠ¨APPç™»å½•

ä½¿ç”¨Tokenç™»å½•

ä½¿ç”¨tokenæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯



ç§»åŠ¨ç«¯æ¸²æŸ“

å‡å°‘CPUã€GPUçš„è®¡ç®—æ—¶é—´ã€‚

å‡å°‘é‡ç»˜æ—¶é—´ã€æ¸²æŸ“æ¬¡æ•°

è¾ƒå°‘IOä¼ è¾“æ—¶é—´ï¼Œå¢åŠ ç¼“å­˜å†…å­˜ï¼›





# UMLç±»å›¾

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-11-02-001939.png" alt="image-20191102081938225" style="zoom:50%;" />









# æ’®åˆç³»ç»Ÿ

## è®¢å•æ¨¡å—

ç”¨æˆ·è®¢å•é€šè¿‡ç½‘å…³è¿›å…¥åˆ°ç³»ç»Ÿï¼›

ç³»ç»Ÿæ¥æ”¶åˆ°è®¢å•åï¼Œç”Ÿæˆè®¢å•ç¼–å·ï¼ŒåŠ å…¥åˆ°å‘é€é˜Ÿåˆ—ä¸­ï¼›

å‘é€è€…å•ç‹¬å¯åŠ¨çº¿ç¨‹ï¼Œå‘mqé˜Ÿåˆ—ä¸­å‘é€æ¶ˆæ¯ï¼›

mqæ¶ˆè´¹è€…ç›‘å¬é˜Ÿåˆ—æ¶ˆæ¯ï¼Œä¸€éƒ¨åˆ†æ¶ˆè´¹è€…å°†è®¢å•è½åº“ï¼Œè¿˜æœ‰ä¸€éƒ¨åˆ†æ¶ˆè´¹è€…æŒ‰symbolæ¥è®¢é˜…è®¢å•ï¼›

è®¢å•ç³»ç»Ÿä¸»è¦å·¥ä½œå®Œæˆï¼›

## æ’®åˆæ¨¡å—

æ’®åˆæ¨¡å—é‡Œæœ‰2å—æœåŠ¡ï¼Œ1ä¸ªæœåŠ¡ç›‘å¬mqçš„é˜Ÿåˆ—ï¼Œç”¨æ’®åˆç®—æ³•è¿›è¡Œè®¡ç®—ï¼Œè®¡ç®—å®Œä»¥åï¼ŒæŒ‰å¸å¯¹ã€æ’åºåä¿å­˜åˆ°å†…å­˜ä¸­ï¼›

å¦‚æœ

æ’®åˆé€»è¾‘ï¼š

æœ‰ä¸€ç¬”æ–°çš„è®¢å•è¿›å…¥ç³»ç»Ÿï¼Œåˆ¤æ–­è®¢å•æ˜¯å¦æ˜¯æ’¤å•ï¼Ÿå¦‚æœæ˜¯æ’¤å•ï¼Œå°†è®¢å•ä»å†…å­˜ä¸­åˆ é™¤ã€‚

å¦åˆ™çš„è¯å…ˆåˆ¤æ–­ä¹°å–æ–¹å‘

å†åˆ¤æ–­è®¢å•ç±»å‹

å¦‚æœæ˜¯ä¹°å•ï¼Œå…ˆå–å–å•çš„ç¬¬ä¸€ä¸ªè®¢å•ï¼Œæ¯”è¾ƒä»·æ ¼ï¼Œå¦‚æœä¹°å•ä»·æ ¼å¤§äºç­‰äºå–å•ä»·æ ¼ï¼Œæˆäº¤ä¸¤ä¸ªè®¢å•ä¸­è¾ƒå°çš„ä¸€ä¸ªã€‚

ç”Ÿæˆå¹¶æ¨é€æˆäº¤ä¿¡æ¯åˆ°mqé‡Œã€‚

åˆ é™¤å†…å­˜é˜Ÿåˆ—é‡Œçš„è®¢å•

ç„¶ååˆ¤æ–­è¿™æ¯”ä¹°å•æ˜¯å¦å®Œæˆï¼Œå¦‚æœæ²¡æœ‰å®Œæˆï¼Œç»§ç»­å–ä¸‹ä¸€ä¸ªè®¢å•ã€‚

 **é˜Ÿåˆ—è‚¯å®šè¦åŠ é”ï¼Œé˜²æ­¢åˆ é™¤é”™è¯¯ï¼Œæˆ–è€…è¯»å–è„æ•°æ®**

å¦‚æœåˆ¤æ–­ä¸æ»¡è¶³æ¡ä»¶ï¼Œå‘ä¹°æ–¹é˜Ÿåˆ—é‡ŒåŠ å…¥è®¢å•ï¼Œå¹¶ä¸”é‡æ–°æ’åºã€‚



## æ•°æ®è¡¨è®¾è®¡

### è®¢å•ç±»å‹

é™ä»·å•

å¸‚ä»·å•

æ­¢ç›ˆæ­¢æŸ

### è®¢å•é˜Ÿåˆ—

è®¢å•é˜Ÿåˆ—æ’åº

ä»·æ ¼ä¼˜å…ˆ: ä¹°å•ä»é«˜å¾€ä½ï¼Œå–å•ä»ä½å¾€é«˜

åŒç­‰ä»·æ ¼æ—¶é—´ä¼˜å…ˆ

æ’®åˆé¡ºåºï¼š



### è‡ªåŠ¨æˆäº¤

æ’®åˆè®¢å•

ç”Ÿæˆäº¤æ˜“è®°å½•



### æ’®åˆç®—æ³•

å…¬å¹³æ€§ã€

é«˜æ•ˆæ€§

æ‰©å±•æ€§



éš¾ç‚¹:

1. åˆ†å¸ƒå¼å…¨å±€å”¯ä¸€idã€‚æ¯ä¸ªè®¢å•åº”è¯¥æœ‰ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„å®šåºçš„idï¼Œä¸èƒ½ç”¨æ—¶é—´æˆ³ï¼Œä¸æ–¹ä¾¿é˜…è¯»ï¼Œè€Œä¸”å¯èƒ½å­˜åœ¨å¤šä¸ªç›¸åŒçš„ã€‚







