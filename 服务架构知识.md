## å¾®æœåŠ¡æ¶æ„

### å¾®æœåŠ¡æ¶æ„æ¦‚è¿°

![image-20190915095352570](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-15-015353.png)

æ¯ä¸ªå¾®æœåŠ¡å›¢é˜Ÿèƒ½å¤Ÿé€‰æ‹©è‡ªå·±æ“…é•¿çš„æŠ€æœ¯æ ˆï¼›





Q1:ç‹¬ç«‹éƒ¨ç½²ç»™ä¸šåŠ¡å¸¦æ¥ä»€ä¹ˆå¥½å¤„ï¼Ÿ

A1:æœåŠ¡å¯ä»¥æ ¹æ®ä¸šåŠ¡åˆ’åˆ†ï¼Œä¸åŒä¸šåŠ¡ä¹‹é—´å¯ä»¥ç‹¬ç«‹å¼€å‘ï¼Œåˆ†å¼€ä¸Šçº¿ã€‚å’Œé›†ä¸­åŒ–éƒ¨ç½²ç›¸æ¯”ï¼Œä¸ä¼šä¾èµ–äºæ•´ä½“ä¸šåŠ¡å¼€å‘å®Œæˆæ‰èƒ½ä¸Šçº¿ï¼Œä¸šåŠ¡æ‹“å±•èƒ½åŠ›æ¯”è¾ƒå¼ºã€‚å¯ä»¥é¢‘ç¹å‘å¸ƒä¸åŒçš„æœåŠ¡ï¼ŒåŒæ—¶ä¿æŒç³»ç»Ÿå…¶ä»–éƒ¨åˆ†å¯ç”¨ã€‚

Q2:ç‹¬ç«‹æ•°æ®æºç»™å¾®æœåŠ¡å¸¦æ¥ä»€ä¹ˆæŒ‘æˆ˜ï¼Ÿ



### å¾®æœåŠ¡ä¸SOAçš„åŒºåˆ«

**SOA**ï¼šé¢å‘æœåŠ¡çš„æ¶æ„ã€‚æœåŠ¡ä¹‹é—´é€šè¿‡ç›¸äº’ä¾èµ–æœ€ç»ˆæä¾›ä¸€ç³»åˆ—çš„åŠŸèƒ½ã€‚æ¯ä¸ªæœåŠ¡ç‹¬ç«‹å­˜åœ¨äºç³»ç»Ÿä¹‹ä¸­ï¼Œå„ä¸ªæœåŠ¡ä¹‹é—´é€šè¿‡ç½‘ç»œè°ƒç”¨ã€‚

**å¾®æœåŠ¡**ï¼šå®ƒå’ŒSOAç±»ä¼¼ï¼Œæ˜¯åœ¨SOAçš„åŸºç¡€ä¸Šåšçš„å‡åã€‚ä½†å¾®æœåŠ¡æ¶æ„å¼ºè°ƒçš„é‡ç‚¹æ˜¯==ä¸šåŠ¡éœ€è¦å½»åº•çš„ç»„ä»¶åŒ–å’ŒæœåŠ¡åŒ–==ã€‚ä¸šåŠ¡éœ€è¦æ›´ç»†ç²’åº¦çš„æ‹†åˆ†æˆå¯ä»¥ç‹¬ç«‹å¼€å‘ã€è¿è¡Œã€éƒ¨ç½²çš„å°åº”ç”¨ã€‚



ä¸»è¦åŒºåˆ«

| åŒºåˆ«ç‚¹           | SOA          | å¾®æœåŠ¡                     |
| ---------------- | ------------ | -------------------------- |
| **æ‹†åˆ†ä¾æ®**     | å¤§å—ä¸šåŠ¡é€»è¾‘ | å•ç‹¬ä»»åŠ¡ã€å°å—ä¸šåŠ¡é€»è¾‘     |
| **è€¦åˆ**         | é€šå¸¸æ˜¯æ¾è€¦åˆ | æ€»æ˜¯æ¾è€¦åˆï¼Œé«˜å†…èš         |
| **é€‚ç”¨å…¬å¸æ¶æ„** | ä»»ä½•ç±»å‹     | å°å‹ã€ä¸“æ³¨äºåŠŸèƒ½äº¤å‰çš„å›¢é˜Ÿ |
| **æœåŠ¡ç®¡ç†**     | é›†ä¸­ç®¡ç†     | åˆ†æ•£ç®¡ç†                   |



### å¾®æœåŠ¡çš„åˆ©ä¸å¼Š

**åˆ©**

- å¯ä»¥ç”¨å¾®æœåŠ¡çš„æ¨¡å¼æ¥æ¨¡å—åŒ–å¼€å‘ä¸šåŠ¡ï¼Œè®©æ¯ä¸ªå›¢é˜Ÿçš„è¾¹ç•Œéƒ½å¾ˆæ¸…æ™°ï¼Œç›¸äº’è°ƒç”¨ï¼›
- å¯ä»¥ç‹¬ç«‹éƒ¨ç½²æœåŠ¡
- æŠ€æœ¯å¯ä»¥å¤šæ ·æ€§ï¼Œæ¯ä¸ªå›¢é˜Ÿå¯ä»¥ç”¨è‡ªå·±æ“…é•¿çš„æŠ€æœ¯ï¼›

**å¼Š**

- åˆ†å¸ƒå¼æœåŠ¡ä¸€èˆ¬éƒ½å¾ˆå¤æ‚ï¼›
- æµ‹è¯•å¤æ‚æ€§å¾ˆé«˜ï¼›
- æœ€ç»ˆä¸€è‡´æ€§:  æ¯ä¸ªå›¢é˜Ÿå¼€å‘çš„æœåŠ¡ï¼Œæ•°æ®éœ€è¦ä¿è¯ä¸€è‡´ï¼Œæ‰€ä»¥éœ€è¦åŒæ­¥ã€‚
- è¿ç»´éƒ¨ç½²å¾ˆå¤æ‚ï¼Œç»´æŠ¤ç¨³å®šæ€§ä¹Ÿå¾ˆå›°éš¾ï¼Œå¯¹è¿ç»´çš„è¦æ±‚ä¹Ÿå¾ˆé«˜ã€‚è¦æœ‰å›ºå®šçš„dockerå®¹å™¨ï¼Œä¹Ÿè¦æœ‰æ•…éšœæ¼”ç»ƒï¼›



### **ä¼ä¸šä½•æ—¶å¼•å…¥å¾®æœåŠ¡æ¶æ„ï¼Ÿ**

> å¥½çš„å¾®æœåŠ¡æ¶æ„æ˜¯æ¼”å˜å‡ºæ¥çš„ï¼Œä¸æ˜¯è®¾è®¡å‡ºæ¥çš„ï¼›
>
> åº”è¯¥è®¾è®¡ä¸€ä¸ªåˆç†çš„æ¡†æ¶ï¼Œåœ¨è¿™ä¸ªæ¡†æ¶ä¸‹å¯ä»¥æ…¢æ…¢æ¼”å˜å‡ºæ­£ç¡®çš„ç³»ç»Ÿï¼›

**å‰æœŸä¸å»ºè®®ç›´æ¥ä¸Šæ‰‹å¾®æœåŠ¡**ï¼š

1.æ˜¯å‰æœŸå¯¹ä¸šåŠ¡ç†è§£ä¸æ·±ï¼Œä¸šåŠ¡ä¸å¥½æ‹†åˆ†ï¼Œè€Œä¸”ç³»ç»Ÿä¸€å¼€å§‹ä¹Ÿä¸ä¼šå¾ˆå¤æ‚ï¼›

2.æ˜¯å‰æœŸå¾®æœåŠ¡æŠ•å…¥æˆæœ¬è¿‡é«˜ï¼Œç”šè‡³ä¸šåŠ¡æ¨¡å¼éƒ½æ²¡è¢«å•†ä¸šè®¤è¯ï¼Œå¯èƒ½å¼€å‘å‡ºæ¥éƒ½ä¸ä¼šè¢«å¸‚åœºæ¥å—ï¼Œé‡‡ç”¨å¾®æœåŠ¡ä»£ä»·å¤ªå¤§ã€‚

3.å‰æœŸå¾®æœåŠ¡å¤æ‚åº¦é«˜ï¼Œç”Ÿäº§åŠ›å¹¶ä¸é«˜ï¼Œåº”è¯¥åœ¨ä¸šåŠ¡å‘å±•çš„è¿‡ç¨‹ä¸­ï¼Œæ‰¾åˆ°ä¸€ä¸ªç‚¹å»åˆ‡æ¢å¾®æœåŠ¡ï¼›

**ä¸­æœŸé€æ¸è½¬åŒ–æˆå¾®æœåŠ¡**ï¼š

1.ä¸šåŠ¡åŠ¡ä¸æ–­æ‹“å±•ï¼Œå¤æ‚åº¦å¢åŠ ï¼Œäº§å“æœ¬èº«çš„ç”Ÿäº§åŠ›ä¼šä¸‹é™

2.å›¢é˜Ÿè§„æ¨¡ä¸æ–­æ‰©å¤§ï¼Œå¯ä»¥æœ‰æ›´å¤šçš„äººæŠ•å…¥åˆ°å¾®æœåŠ¡ä¸Šï¼›

**æ€»ç»“ï¼š**

è¿‡æ—©çš„å°†ä¸€ä¸ªç³»ç»Ÿåˆ’åˆ†æˆä¸ºå¾®æœåŠ¡çš„ä»£ä»·éå¸¸é«˜ï¼Œå°¤å…¶æ˜¯é¢å¯¹æ–°é¢†åŸŸçš„æ—¶å€™ã€‚å¾ˆå¤šæ—¶å€™ï¼Œå°†ä¸€ä¸ªå·²æœ‰çš„ç³»ç»Ÿåˆ’åˆ†æˆä¸ºå¾®æœåŠ¡ï¼Œè¦æ¯”ä»å¤´å¼€å§‹æ„å»ºå¾®æœåŠ¡ç®€å•çš„å¤šï¼›



### æ¼”è¿›å¼æ¶æ„å¸ˆåº”è¯¥æ‰¿æ‹…çš„èŒè´£

- æ„¿æ™¯

  ç¡®ä¿åœ¨ç³»ç»Ÿçº§æœ‰ä¸€ä¸ªç»è¿‡å……åˆ†æ²Ÿé€šçš„æŠ€æœ¯æ„¿æ™¯ï¼Œè¿™ä¸ªæ„¿æ™¯åº”è¯¥å¯ä»¥å¸®åŠ©ä½ æ»¡è¶³å®¢æˆ·å’Œç»„ç»‡çš„éœ€æ±‚ï¼›

- åŒç†å¿ƒ

  ç†è§£ä½ æ‰€åšçš„å†³å®šå¯¹å®¢æˆ·å’ŒåŒäº‹å¸¦æ¥çš„å½±å“ï¼›

- åˆä½œ

  å’Œå°½é‡å¤šçš„åŒäº‹è¿›è¡Œæ²Ÿé€šï¼Œä»è€Œæ›´å¥½åœ°å¯¹æ„¿æ™¯è¿›è¡Œå®šä¹‰ã€ä¿®è®¢ä»¥åŠæ‰§è¡Œ

- é€‚åº”æ€§

  ç¡®ä¿åœ¨ä½ çš„å®¢æˆ·å’Œç»„ç»‡éœ€è¦çš„æ—¶å€™ï¼Œè°ƒæ•´åŸºæ•°æ„¿æ™¯

- è‡ªæ²»æ€§

  åœ¨æ ‡å‡†åŒ–å’Œå›¢é˜Ÿè‡ªæ²»ä¹‹é—´å¯»æ‰¾ä¸€ä¸ªæ­£ç¡®çš„å¹³è¡¡ç‚¹

- æ²»ç†

  ç¡®ä¿ç³»ç»ŸæŒ‰ç…§æŠ€æœ¯æ„¿æ™¯çš„è¦æ±‚å®ç°

æˆåŠŸè¦é ä¸æ–­çš„å–èˆæ¥å®ç°ã€‚æ€»ä¼šæœ‰ä¸€äº›åŸå› éœ€è¦ä½ æ”¹å˜å·¥ä½œçš„æ–¹å¼ï¼Œä½†æ˜¯å…·ä½“åšå“ªäº›æ”¹å˜å°±åªèƒ½ä¾èµ–äºè‡ªå·±çš„ç»éªŒäº†ã€‚



### å¾®æœåŠ¡çš„ç»„ç»‡æ¶æ„

> åº·å¨æ³•åˆ™: è®¾è®¡ç³»ç»Ÿçš„ç»„ç»‡ä»¥åŠæ‰€äº§ç”Ÿçš„æ¶æ„ï¼Œç­‰ä»·äºä¼ä¸šçš„ç»„ç»‡æ¶æ„ï¼›

~~ä¼ ç»Ÿçš„ç»„ç»‡æ¶æ„ï¼šäº§å“éƒ¨é—¨ã€ç”¨æˆ·ä½“éªŒéƒ¨é—¨ã€ç ”å‘éƒ¨é—¨ã€æµ‹è¯•éƒ¨é—¨ã€ã€‚ã€‚ã€‚è¿ç»´éƒ¨é—¨ç­‰ï¼›~~

å¾®æœåŠ¡ç»„ç»‡æ¶æ„ï¼šè·¨èŒèƒ½å¾®æœåŠ¡äº§å“å›¢é˜Ÿ 

å¾®æœåŠ¡æ¶æ„å®é™…ä¸Šæ˜¯ç»„ç»‡æ¶æ„çš„ä¸€ç§é‡ç»„ï¼šä»ä»¥å‰çš„èŒèƒ½éƒ¨é—¨ï¼Œè½¬æ¢æˆè·¨èŒèƒ½éƒ¨é—¨çš„ç»„ç»‡æ¶æ„ï¼›

å›¢é˜Ÿäººå‘˜ä¸å†åªæ˜¯"å›´ç»•é¡¹ç›®å»ºç«‹ï¼Œå½“é¡¹ç›®ç»“æŸä»¥åå°±å›åˆ°èŒèƒ½éƒ¨é—¨â€ï¼›è€Œæ˜¯å›´ç»•ç€å¾®æœåŠ¡æ¥å»ºç«‹å›¢é˜Ÿï¼Œä¸æ–­çš„å¼€å‘è¿­ä»£ï¼Œä»è€Œæä¾›ä¸€ä¸ªAPIã€å¹³å°äº§å“ã€‚

![246c7f96401297282f4a5e7574d81c71_403x359](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-19-122414.png)

å¾®æœåŠ¡æ ¸å¿ƒæ¦‚å¿µï¼š**ç«¯åˆ°ç«¯ ï¼ˆEnd to End** **Ownership**ï¼‰å›¢é˜Ÿå†…éƒ¨ä¹‹é—´èƒ½å¤Ÿå½¢æˆä¸€ä¸ªé—­ç¯ã€‚

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-16-124506.jpg" width="300"/>

æ¯ä¸ªå›¢é˜Ÿè‡ªè¡Œè´Ÿè´£äº§å“çš„è®¾è®¡ï¼Œæ¶æ„ï¼Œå¼€å‘ï¼Œæ„å»ºï¼Œéƒ¨ç½²ï¼Œè¿ç»´ï¼Œæ”¯æŒã€‚å›¢é˜Ÿå„è‡ªå‘å¸ƒè‡ªå·±çš„æ¨¡å—ï¼Œå›¢é˜Ÿé—´æ¨¡å—è§£è€¦ï¼Œå‡çº§æ—¶å‘ä¸‹ç‰ˆæœ¬å…¼å®¹ï¼Œäº’ä¸å½±å“ã€‚ä¸€ä¸ªå›¢é˜Ÿè§„æ¨¡å¤§è‡´12äººå·¦å³ã€‚





### ä¸­å°æˆ˜ç•¥

ä¸­å°æ¦‚å¿µçš„ç”±æ¥ï¼š2013å¹´ï¼Œé©¬äº‘å¸¦é¢†é˜¿é‡Œçš„é«˜ç®¡ï¼Œå‚è§‚äº†supercellã€‚ä¸€å®¶ä½äºèŠ¬å…°çš„ç§»åŠ¨æ¸¸æˆå…¬å¸ã€‚å‘ç°ä»–ä»¬å…¬å¸çš„è™½ç„¶å›¢é˜Ÿç‰¹åˆ«å°ï¼Œä½†æ˜¯å±…ç„¶èƒ½å¤Ÿåœ¨å‡ å‘¨æ—¶é—´å†…å°±åšå‡ºä¸€æ¬¾æ¸¸æˆã€‚å…¶ä¸­é™¤äº†æ•æ·å¼€å‘ã€å¿«é€Ÿè¯•é”™ä»¥å¤–ï¼Œå…¶æˆåŠŸè¿˜æœ‰ä¸€ä¸ªæœ€å…³é”®çš„è¦ç´ å°±æ˜¯supercellçš„ä¸­å°èƒ½åŠ›ã€‚supercellçš„ä¸­å°æ¶æ„æ¨¡å¼ç»™é˜¿é‡Œé«˜ç®¡å¾ˆå¤§çš„éœ‡æ’¼ï¼Œè¿™ä¹Ÿå‚¬ç”Ÿäº†é˜¿é‡Œå·´å·´çš„ä¸­å°æˆ˜ç•¥ã€‚

é˜¿é‡Œä¸­å°æˆ˜ç•¥ï¼š"å¤§ä¸­å°ã€è½»å‰å°"ã€‚é€šè¿‡åšå®çš„ä¸­å°æ¶æ„ï¼Œæ¥å‘å‰å°è¾“é€å¼¹è¯ã€‚è®©å‰å°ä¸šåŠ¡æ›´åŠ çµæ´»ï¼Œå¹¶ä¸”èƒ½å¿«é€Ÿé€‚åº”å¸‚åœºçš„éœ€æ±‚ã€‚

![ä¸­å°æ¶æ„](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-08-24-060308.png)

ä¸­å°ï¼š

æœ€åæ¨èä¸€ç¯‡æ–‡ç« ï¼šäº’è”ç½‘å…¬å¸ä¸­æ‰€è°“ä¸­å°æ˜¯æ€ä¹ˆå®šä¹‰çš„ï¼Ÿ -  çŸ¥ä¹
https://www.zhihu.com/question/57717433/answer/719218827





### ä¸€ä¸ªæ¸…æ™°ç®€æ´çš„å¾®æœåŠ¡åˆ†å±‚

![5a7a5ed7818d8bb427548f493b3d3924_1193x541](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-19-124422.png)

ä»ä¸šåŠ¡é€»è¾‘ä¸Šï¼šæˆ‘ä»¬æŠŠæœåŠ¡åˆ†ä¸º`èšåˆæœåŠ¡`å’Œ`åŸºç¡€æœåŠ¡`ä¸¤å±‚ï¼›

`åŸºç¡€æœåŠ¡`ä¸»è¦æä¾›æ¯”è¾ƒåŸºç¡€çš„ã€é€šç”¨çš„æ¥å£æœåŠ¡ã€‚è¿™äº›æœåŠ¡ä¸€èˆ¬éƒ½æ˜¯æ ¸å¿ƒä¸šåŠ¡ï¼Œæ¯”å¦‚æ¸¯ç››çš„è®¢å•æœåŠ¡ã€è´¦æˆ·æœåŠ¡

èšåˆæœåŠ¡ï¼Œä¸€èˆ¬ä¹Ÿå«é€‚é…æœåŠ¡ï¼ŒBFFã€‚æ ¹æ®ä¸šåŠ¡éœ€è¦ï¼Œå°†å¤šä¸ªåŸºç¡€æœåŠ¡ç»„åˆåœ¨ä¸€èµ·ï¼Œæˆ–è€…å¯¹æœåŠ¡çš„è¿”å›æ•°æ®è¿›è¡Œç›¸åº”è£å‰ªã€‚ä»¥å‡å°‘åŸºç¡€æœåŠ¡çš„é‡å¤å¼€å‘ï¼Œä¹Ÿé¿å…äº†å®¢æˆ·ç«¯è¿‡å¤šçš„è¯·æ±‚è°ƒç”¨ï¼Œå‡å°‘å¼€é”€ã€‚



### å¾®æœåŠ¡çš„æŠ€æœ¯æ¶æ„æ¨¡å‹

6å±‚æ¶æ„æ¨¡å‹

![e7e9618ee6bd013513ffc85a67b5da26_1468x881](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-19-130113.png)



kubernetsï¼šèµ„æºè°ƒåº¦å¹³å°

dockerï¼šé•œåƒæ²»ç†





### æœåŠ¡å‘ç°æœºåˆ¶

> æ¶ˆè´¹è€…å‘ç°ç”Ÿäº§è€…æœåŠ¡

1. **ä¼ ç»Ÿæ¨¡å¼ï¼šåŸºäºLB**

![image-20190915101129140](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-15-021129.png)

æœåŠ¡ä¸Šçº¿æ—¶ï¼Œå‘è¿ç»´ç”³è¯·åŸŸåï¼Œè¿ç»´äººå‘˜æ ¹æ®åŸŸåé…ç½®è´Ÿè½½å‡è¡¡ï¼Œç„¶åæä¾›åŸŸåç»™å®¢æˆ·ç«¯å»è°ƒç”¨ï¼›

å®¢æˆ·ç«¯é€šè¿‡åŸŸåDNSè§£æåˆ°è´Ÿè½½å‡è¡¡æœåŠ¡å™¨ä¸Šï¼Œä»è€Œè°ƒç”¨æœåŠ¡ï¼›

**ç¼ºç‚¹ï¼š**

- éœ€è¦è¿ç»´äººå·¥ä»‹å…¥ï¼Œæ¯åŠ ä¸€ä¸ªæœåŠ¡ï¼Œéƒ½éœ€è¦å»é…ç½®ä¸€ä¸‹ï¼›

- è´Ÿè½½å‡è¡¡å™¨å¾ˆå¯èƒ½æ˜¯å•èŠ‚ç‚¹çš„ï¼Œå¦‚æœ LBæŒ‚äº†ï¼Œæ‰€æœ‰çš„æœåŠ¡éƒ½å¯èƒ½æ— æ³•è®¿é—®ï¼›
- æ€§èƒ½ä¼šæœ‰æŸå¤±, å› ä¸ºå®¢æˆ·ç«¯æ‰€æœ‰éœ€è¦è®¿é—®çš„æœåŠ¡éƒ½å¿…é¡»ç©¿é€LBã€‚



2. **è¿›ç¨‹å†…LBæ¨¡å¼**

![775cf00315d405b94adae2d1ed717319_599x318](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-30-082551.png)

`æœåŠ¡æä¾›æ–¹(Service Provider)`é€šè¿‡æœåŠ¡æ³¨å†Œæ–¹å¼(æœåŠ¡æ³¨å†Œè¡¨)å‘å¤–å‘å¸ƒæœåŠ¡ï¼Œå¹¶ä¸”å®šæœŸå‘é€å¿ƒè·³ï¼Œå‘Šè¯‰æœåŠ¡æ³¨å†Œè¡¨æˆ‘è¿˜æ´»ç€

`æœåŠ¡æ¶ˆè´¹è€…Consumer`è‡ªå¸¦LB, ç”¨æ¥æ”¯æŒæœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚LBå‘ç°å¹¶è°ƒç”¨åå°æœåŠ¡ï¼ŒåŒæ—¶å®šæœŸå»åŒæ­¥æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„æœåŠ¡ï¼›

å¥½å¤„ï¼š

1. è§£å†³äº†å•ç‚¹çš„é—®é¢˜ï¼Œæ²¡æœ‰é›†ä¸­LBã€‚

2. åŒæ—¶è§£å†³äº†LBæ¶ˆè€—æ€§èƒ½çš„é—®é¢˜ï¼Œå› ä¸ºéƒ½æ˜¯è¿›ç¨‹å†…æœåŠ¡ï¼›

ç¼ºç‚¹ï¼š

1.æ¯ä¸ªè¿›ç¨‹å†…æœ‰ä¸€ä¸ªç‹¬ç«‹LBï¼Œé‚£ä¹ˆLBéœ€è¦å¼€å‘ä¸åŒçš„è¯­è¨€ç‰ˆæœ¬ï¼Œæ”¯æŒå¤šç§å¼€å‘è¯­è¨€ï¼›

2.å‡çº§ç»´æŠ¤å¾ˆéº»çƒ¦ï¼›



3. **ä¸»æœºç‹¬ç«‹LB**

![f8a5f8babc09866d8f4117f214c00336_597x262](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-30-082631.png)

æŠŠLBä»¥ç‹¬ç«‹è¿›ç¨‹éƒ¨ç½², å’Œæ¶ˆè´¹è€…æ”¾åœ¨ä¸€ä¸ªä¸»æœºä¸Šï¼›LBå¯ä»¥æ”¯æŒå¤šè¯­è¨€ã€‚

å¯ä»¥ç”¨å®¹å™¨çš„æ–¹å¼æ¥éƒ¨ç½²æœåŠ¡+LBï¼›

> é—®é¢˜ï¼šä»¥å®¹å™¨çš„æ–¹å¼æ¥éƒ¨ç½²ï¼Œæ˜¯å°†LBéƒ¨ç½²åœ¨å®¹å™¨ä¸Šï¼Œå®¹å™¨å†…æœåŠ¡å…±äº«ï¼Ÿè¿˜æ˜¯éƒ¨ç½²åœ¨å®¹å™¨ä¸»æœºä¸Šï¼Œæ‰€æœ‰å®¹å™¨å…±äº«ï¼Ÿ

å®¹å™¨éƒ¨ç½²çš„è¯ï¼Œå»ºè®®æ¯ä¸ªå®¹å™¨éƒ¨ç½²ä¸€ä¸ªç‹¬ç«‹è¿›ç¨‹LBï¼ˆå¦‚Service Meshï¼‰ï¼Œè¿™æ ·éš”ç¦»æ€§æ›´å¥½ï¼Œå®¹å™¨å†…çš„LBæŒ‚äº†ï¼Œåªå½±å“é‚£ä¸ªå®¹å™¨ï¼Œä¸»æœºä¸Šå…¶å®ƒå®¹å™¨ä¸å—å½±å“ã€‚

å¦‚æœå®¹å™¨å…±äº«ä¸»æœºä¸Šçš„ç‹¬ç«‹è¿›ç¨‹LBçš„è¯ï¼Œåˆ™å¦‚æœä¸»æœºä¸Šçš„LBæŒ‚äº†ï¼Œåˆ™æ•´ä¸ªä¸»æœºä¸Šçš„å®¹å™¨å…¨éƒ¨å—å½±å“ã€‚





### Service Mesh

> Service Mesh/æœåŠ¡ç½‘æ ¼ï¼Œæ˜¯ä¸€ä¸ªåŸºç¡€å±‚è®¾æ–½ï¼ŒåŠŸèƒ½åœ¨äºå¤„ç†æœåŠ¡é—´çš„é€šä¿¡ï¼ŒèŒè´£æ˜¯è´Ÿè´£å®ç°è¯·æ±‚çš„å¯é ä¼ é€’ï¼›



#### SideCar

é¦–å…ˆéœ€è¦äº†è§£ä¸€ä¸‹`SideCar/è¾¹è½¦`çš„è®¾è®¡æ¨¡å¼ã€‚ä»–ä¸»è¦çš„ä½œç”¨æ˜¯ç”¨æ¥å‘ç°æœåŠ¡ï¼Œè½¬å‘å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œè°ƒç”¨æœåŠ¡ã€‚

ä»–çš„è®¾è®¡çµæ„Ÿæœ‰ç‚¹ç±»ä¼¼äºæ‘©æ‰˜è½¦çš„è¾¹è½¦ï¼Œå®ƒä¸ä¸€å®šåº”ç”¨ç¨‹åºä¸­çš„ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯å¯ä»¥è¿æ¥æœåŠ¡çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿå¯ä»¥æ”¾åœ¨æœåŠ¡ç¨‹åºçš„ä»»æ„ä¸€ä¸ªä½ç½®ã€‚

çœ‹ä¸€ä¸‹Service Meshä¸­SideCarçš„æ¶æ„ï¼š

![5a5491d2835ec](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-01-073337.jpg)

å®¢æˆ·ç«¯é€šè¿‡ç®€å•RCPï¼Œæ¥è¿æ¥åˆ°SidecaræœåŠ¡ï¼ŒSidecarå†é€šè¿‡æœåŠ¡æ³¨å†Œä¸­å¿ƒå‘ç°æœåŠ¡ï¼Œæœ€åå°†å®¢æˆ·ç«¯è¯·æ±‚ä»£ç†è½¬å‘åˆ°æœ€ç»ˆçš„ç›®æ ‡æœåŠ¡ï¼›

è¿™é‡Œçš„Sidecarå¹¶ä¸æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„Sidecarï¼Œè€Œæ˜¯Service Meshå•åº”ç”¨åœºæ™¯ä¸‹çš„è¡¨ç°å½¢å¼ï¼›

Sidecarå’ŒService Meshçš„åŒºåˆ«ä¸»è¦æœ‰ä¸‰ç‚¹ï¼š

|          | Sidecar              | Service Mesh        |
| -------- | -------------------- | ------------------- |
| æ•´ä½“æ€§   | å•ç»„ä»¶               | å¼ºè°ƒæ•´ä½“çš„ç½‘ç»œ      |
| é€‚ç”¨æ€§   | åªèƒ½é€‚ç”¨äºç‰¹å®šçš„æ¡†æ¶ | å¯ä»¥é€šç”¨é€‚é…        |
| å¯é€‰æ‹©æ€§ | å¯é€‰çš„ï¼Œå…è®¸ç›´è¿     | å¿…é¡»ç»è¿‡ServiceMesh |



å¤šä¸ªå¾®æœåŠ¡è°ƒç”¨çš„ç»“æ„ï¼š

![5a54921232d1a](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-01-074011.jpg)

Service Meshåœ¨æ‰€æœ‰çš„æœåŠ¡ä¸‹é¢ï¼Œè´Ÿè´£å¤„ç†æ‰€æœ‰çš„æœåŠ¡è¿æ¥ï¼Œè¿™ä¸€å±‚ä¹Ÿç§°ä¸ºï¼š`æœåŠ¡é—´é€šè®¯ä¸“ç”¨åŸºç¡€è®¾æ–½å±‚`

å¦‚æœæœ‰å¤§é‡çš„æœåŠ¡è¿æ¥ï¼Œå‘ˆç°å‡ºæ¥çš„å°±æ˜¯ä¸€ä¸ªç½‘æ ¼çŠ¶(Service Mesh)ã€‚ç»¿è‰²éƒ¨åˆ†ä»£è¡¨åº”ç”¨ï¼Œè“è‰²éƒ¨åˆ†ä»£è¡¨SideCarã€‚

![5a5492269b895](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-01-074320.jpg)

å¤§é‡æœåŠ¡è¿æ¥çš„ç½‘æ ¼é‡Œï¼ŒServiceMeshä¸å†è¢«è§†ä¸ºå•ä¸ªè¿›ç¨‹ï¼Œè€Œæ˜¯å¼ºè°ƒæ•´ä¸ªä»£ç†è¿æ¥å½¢æˆçš„ç½‘ç»œï¼›è¿™ä¹Ÿæ˜¯å®ƒå’ŒSidecarçš„ä¸åŒç‚¹ã€‚



#### Service Meshçš„æ¼”å˜

![9ef38cc2efaa4d7cb16a4cce3110864f](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-01-080131.jpg)

![d8f1b8d7e1f54b91a6d56ee622c0e9d3](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-01-080208.jpg)

ä¼¼ä¹æ¡†æ¶å±‚å¸®æˆ‘ä»¬è§£å†³äº†å¾®æœåŠ¡çš„å¾ˆå¤šé—®é¢˜ï¼šè´Ÿè½½å‡è¡¡ï¼Œé™æµç†”æ–­ï¼Œå®‰å…¨é™åˆ¶ç­‰ç­‰ã€‚ä½†æ˜¯æ¯ä¸ªå¾®æœåŠ¡éƒ½éœ€è¦è¿™äº›åŸºç¡€çš„åŠŸèƒ½ï¼Œè€Œå¾®æœåŠ¡å¼€å‘çš„è¯­è¨€å¯èƒ½åˆå¤§ä¸ç›¸åŒï¼Œå¹¶ä¸”ç±»ä¼¼äºSpringCloudã€Dubboè¿™äº›å¾®æœåŠ¡æ¡†æ¶ä¹Ÿä¼šé€ æˆå¾ˆå¤šç—›ç‚¹ã€‚

**ç—›ç‚¹1**ï¼šé—¨æ§›é«˜ã€‚æ¡†æ¶çš„å­¦ä¹ é—¨æ§›æ¯”è¾ƒé«˜ï¼Œç®€å•å…¥é—¨æ¯”è¾ƒå®¹æ˜“ï¼Œä½†æ˜¯ç†Ÿç»ƒåº”ç”¨å’Œæ·±å…¥äº†è§£éœ€è¦å¤§é‡çš„æ—¶é—´ã€‚è€Œä¸šåŠ¡å›¢é˜Ÿçš„ä¼˜åŠ¿å¾€å¾€ä¸æ˜¯æŠ€æœ¯ï¼Œè€Œæ˜¯ä¸šåŠ¡çš„ç†è§£å’Œå¯¹ç³»ç»Ÿçš„äº†è§£ã€‚

**ç—›ç‚¹2**ï¼šåŠŸèƒ½ä¸å…¨![b456e3c0500f4e6ead2730a9eb639b9d](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-01-081040.jpg)

ä¼ ç»Ÿçš„Spring Cloudã€Dubboæ¡†æ¶æä¾›çš„åŠŸèƒ½æœ‰é™ï¼Œä¸å…·å¤‡ä¸€æ•´å¥—ç”Ÿæ€ç³»ç»Ÿï¼›åŸºäºSpring Cloudçš„åŸºç¡€ç‰ˆæœ¬åšå®Œæ•´è¡¥å……ã€æ‰©å±•ã€åŠ å¼ºéœ€è¦å·¨å¤§çš„ç²¾åŠ›ï¼›

**ç—›ç‚¹3**: è·¨è¯­è¨€

å¾®æœåŠ¡å¯ä»¥é‡‡ç”¨æœ€é€‚åˆçš„è¯­è¨€æ¥ç¼–å†™ã€‚ç†è®ºä¸Šè¯´ï¼Œä¸åŒçš„å›¢é˜Ÿï¼Œä¸åŒçš„å¾®æœåŠ¡ï¼Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©å›¢é˜Ÿæœ€æ“…é•¿ï¼Œæˆ–è€…æœ€é€‚åˆå½“å‰åº”ç”¨çš„ç¼–ç¨‹è¯­è¨€ã€‚ä½†æ˜¯è¿™æ ·å°±è¦æä¾›ä¸åŒè¯­è¨€çš„æ¡†æ¶ï¼Œå®é™…éœ€è¦é¢ä¸´å·¨å¤§çš„å¼€å‘å·¥ä½œé‡ï¼Œä»£ä»·æé«˜ï¼›

**ç—›ç‚¹4**ï¼šå‡çº§å›°éš¾

å½“æœåŠ¡ç«¯æ•°ä»¥ç™¾è®¡èµ·ï¼Œå®¢æˆ·ç«¯æ•°ä»¥åƒè®¡èµ·æ—¶ã€‚æœåŠ¡ç«¯å‡çº§ï¼Œå®¢æˆ·ç«¯å¯èƒ½ä¸ä¼šé€‰æ‹©å‡çº§ï¼Œé‚£ä¹ˆå°±å¿…é¡»å»å…¼å®¹æ¯ä¸ªç‰ˆæœ¬ï¼Œå†åŠ ä¸Šä¸åŒçš„è¯­è¨€ç‰ˆæœ¬ï¼Œè¯•æƒ³ä¸‹éœ€è¦æ¶ˆè€—å¤šå¤§çš„ç²¾åŠ›ï¼ŒæŠ•å…¥å¤šå°‘å·¥ä½œé‡ï¼



![b4209fab90db42cbb8893e38782442b2](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-01-081815.jpg)

å€Ÿé‰´å½“å¹´TCP/IPçš„æ€è·¯ï¼Œå¯¹äºæœåŠ¡é—´é€šè®¯ï¼Œåœ¨ä¼ ç»Ÿçš„ä¾µå…¥å¼æ¡†æ¶å¤–ï¼Œå‡ºç°äº†å¦å¤–ä¸€ç§æ€è·¯ï¼š

æ—¢ç„¶æˆ‘ä»¬å¯ä»¥æŠŠç½‘ç»œé€šè®¯çš„æŠ€æœ¯æ ˆå‰¥ç¦»å¹¶ä¸‹æ²‰ä¸ºTCPï¼Œæˆ‘ä»¬æ˜¯å¦ä¹Ÿå¯ä»¥ç”¨ç±»ä¼¼çš„æ–¹å¼æ¥å¤„ç†å¾®æœåŠ¡ä¸­æœåŠ¡é—´é€šè®¯çš„æŠ€æœ¯æ ˆã€‚äºæ˜¯å‡ºç°äº†ä¸Šé¢çš„æ¼”å˜æ–¹æ¡ˆï¼Œé€šè¿‡é…ç½®æ–‡ä»¶æ¥å®ç°åå‘ä»£ç†ï¼Œå°†è¯·æ±‚è·¯ç”±åˆ°æœåŠ¡ï¼›

è™½ç„¶è¿™ä¸ªæ–¹æ¡ˆå¾ˆç®€é™‹ï¼Œä½†æ˜¯ä¾ç„¶æœ‰å€¼å¾—å€Ÿé‰´çš„åœ°æ–¹ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯åº”è¯¥éš”ç¦»ï¼Œéƒ¨åˆ†åŠŸèƒ½ä¸‹æ²‰åˆ°ä¸­é—´å±‚æ¥å®ç°è¯·æ±‚è½¬å‘ã€‚

![ed2a3bf738dc4b868cb9bf3d9e65d885](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-01-082242.jpg)

Sidecarå€Ÿé‰´äº†Proxyçš„æ¨¡å¼ï¼Œä½†æ˜¯ä»–çš„è®¾è®¡å±€é™æ€§å¾ˆå¼ºï¼Œè¡¨ç°ä¸º**ä¸ºç‰¹å®šçš„åŸºç¡€è®¾æ–½è€Œè®¾è®¡**ã€‚åªé€‚ç”¨äºç‰¹å®šçš„æ¡†æ¶æˆ–è€…éœ€æ±‚åœºæ™¯ï¼Œå¾ˆéš¾å¯¹å¤–æ¨å¹¿ã€‚



**ç¬¬ä¸€ä»£Service Mesh**

![52055434dac2409dba020b102f22136c](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-01-082602.jpg)



**ç¬¬äºŒä»£Service Mesh**

![d71ab7aaf1eb446b848d215a9dce8130](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-01-082802.jpg)

**æ€»ç»“**

Service Mesåº”éœ€è€Œç”Ÿï¼Œè§£å†³äº†ä¼ ç»Ÿå¾®æœåŠ¡æ¡†æ¶å¸¦æ¥çš„4ä¸ªç—›ç‚¹ï¼š

å†…å®¹é«˜ï¼Œé—¨æ§›å¤šï¼›â€”â€”> äº¤ç»™Service Meshï¼Œåº”ç”¨åªéœ€è¦å…³æ³¨ä¸ä¸šåŠ¡é€»è¾‘ï¼›

æœåŠ¡æ²»ç†åŠŸèƒ½ä¸é½å…¨ï¼› â€”â€”> Service MeshåŠŸèƒ½é½å…¨

å‡çº§å›°éš¾ï¼› â€”â€”> å¯å•ç‹¬å‡çº§

è·¨è¯­è¨€ï¼› â€”â€”> å®¢æˆ·ç«¯ç®€åŒ–ï¼Œé€šè¿‡restæˆ–å…¶ä»–ç®€å•è¿œç¨‹è°ƒç”¨æ–¹å¼ï¼›æœåŠ¡ç«¯åªéœ€è¦åšæœåŠ¡æ³¨å†Œçš„äº‹æƒ…ï¼›





### APIç½‘å…³

> ä¸ºä»€ä¹ˆè¦ä½¿ç”¨APIç½‘å…³ï¼Ÿ
>
> APIç½‘å…³æ˜¯ä¸€ä¸ªç³»ç»Ÿä¸å¤–ç•Œè¿æ¥çš„å…¥å£ã€‚å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªä¼ä¸šçš„å¤§é—¨ï¼Œç”¨æ¥åšå®‰å…¨é˜²æŠ¤ï¼Œé™åˆ¶è®¿é—®ï¼Œè¯·æ±‚è·¯ç”±ç­‰å·¥ä½œï¼›

![3912920-df6b13ad41a9ce3d](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-15-043623.png)

ç½‘å…³çš„ä½œç”¨ï¼š

ç½‘å…³æœåŠ¡æœ€ä¸»è¦çš„ä½œç”¨ï¼Œæ˜¯ä¸ºå†…éƒ¨æœåŠ¡æä¾›ç»Ÿä¸€çš„å¯¹å¤–å‡ºå£ï¼Œå‘å¤–éƒ¨è®¿é—®è€…æä¾›ç»Ÿä¸€çš„æœåŠ¡å…¥å£ã€‚å¯ä»¥å±è”½å†…éƒ¨çš„æœåŠ¡ç»†èŠ‚ã€‚

ç½‘å…³å¯ä»¥å¯¹å¤–ç•Œè®¿é—®åšä¸€ä¸ªå®‰å…¨é˜²æŠ¤ï¼Œæ¯”å¦‚é™åˆ¶å¤–éƒ¨è®¿é—®ã€ç»Ÿä¸€é‰´æƒã€ç†”æ–­ç­‰ã€‚

![13e53557b2a76cb69144c23a8fa7db36_851x449](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-16-012506.png)



æœ€ä¸Šå±‚æ˜¯ç”¨æˆ·æ¥å…¥è®¾å¤‡

é€šè¿‡è´Ÿè½½å‡è¡¡å™¨ï¼ˆä¸€èˆ¬ç½‘å…³æœåŠ¡éƒ½æ˜¯æ— çŠ¶æ€æœåŠ¡ï¼Œæ— è®ºé€šè¿‡å“ªä¸€ä¸ªç½‘å…³æœåŠ¡ï¼Œéƒ½å¯ä»¥æä¾›åŒæ ·çš„æœåŠ¡ã€‚æ‰€ä»¥åšäº†ä¸€å±‚è´Ÿè½½å‡è¡¡ï¼Œé¿å…å•ç‚¹æ•…éšœï¼‰

è½¬å‘åˆ°ç½‘å…³æœåŠ¡ï¼Œä»è€Œæœ€ç»ˆè¯·æ±‚å„ä¸ªå¾®æœåŠ¡ã€‚

- **åå‘è·¯ç”±**ï¼šå°†å†…éƒ¨çš„æœåŠ¡è½¬åŒ–æˆä¸ºå¯¹å¤–æœåŠ¡
- å®‰å…¨è®¤è¯ï¼šç”¨äºæ£€æµ‹è¯·æ±‚ï¼Œè¯†åˆ«èº«ä»½
- é™æµç†”æ–­ï¼šé˜²æ­¢å¤§æµé‡çš„è®¿é—®
- æ—¥å¿—ç›‘æ§ï¼šè®°å½•æ—¥å¿—

#### æ— çŠ¶æ€æœåŠ¡VSæœ‰çŠ¶æ€æœåŠ¡

æ— çŠ¶æ€æœåŠ¡ï¼šå¯¹äºå•æ¬¡çš„è¯·æ±‚ï¼Œä¸ä¾èµ–äºå…¶ä»–è¯·æ±‚æ•°æ®å°±èƒ½å®Œæˆã€‚ä¹Ÿå°±æ˜¯ï¼Œå®¢æˆ·ç«¯æ¯æ¬¡å‘è¿‡æ¥çš„è¯·æ±‚ï¼ŒæœåŠ¡ç«¯åªéœ€è¦æ ¹æ®è¿™æ¬¡è¯·æ±‚ä¼ å…¥çš„ä¿¡æ¯ï¼Œå¯èƒ½å†åŠ ä¸Šä¸€äº›å¤–éƒ¨çš„ä¾èµ–æœåŠ¡ï¼ˆå¦‚æ•°æ®åº“ï¼‰ï¼Œå°±å¯ä»¥å®Œæˆå¯¹è¯·æ±‚å¤„ç†ï¼ŒæœåŠ¡æœ¬èº«ä¸å­˜å‚¨ä»»ä½•ä¿¡æ¯ã€‚

æœ‰çŠ¶æ€æœåŠ¡ï¼šåœ¨æœåŠ¡ç«¯ä¿å­˜äº†ä¸€äº›æ•°æ®ä¿¡æ¯ï¼Œè¯·æ±‚çš„å…ˆåé¡ºåºæœ‰ä¸€å®šçš„å…³è”æ€§ã€‚æ¯”å¦‚å‘é€éªŒè¯ç å’Œæ ¡éªŒéªŒè¯ç ï¼›



### Zuulç½‘å…³æ¶æ„

![18adb3e66cedfa991acbead83c8ae970_1150x832](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-30-084646.png)



æ¡†æ¶çš„æ ¸å¿ƒç‰¹ç‚¹ï¼š

â€‹	1. 3å±‚Filterï¼›

â€‹	2. å¯æ’æ‹”Filteré…ç½®ï¼›

â€‹	Zuulçš„Filterå¯ä»¥å¾ˆçµæ´»çš„é…ç½®ã€‚å¼€å‘è€…å¼€å‘å®ŒFilterè¿‡æ»¤å™¨åã€‚

â€‹	a. é¦–å…ˆé€šè¿‡publisherå­˜å‚¨åœ¨`Filter Database`ä¸­ï¼Œ

â€‹	b. é€šè¿‡pollerè½®è®­ä¸Šä¼ åˆ°`Filter Directories`é‡Œã€‚

â€‹	c. ä¸Šå±‚çš„`Filter File Manager`ä¼šå®šæœŸæ‰«æ`Filter Directories`ï¼Œ

â€‹	4. æœ€åé€šçŸ¥loaderå°†FilteråŠ è½½åˆ°Runneré‡Œï¼Œåº”ç”¨èµ·æ¥ï¼›



![0fc714c1ce4966d8f095075b9162d860_1498x905](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-16-061425.png)

æ ¸å¿ƒæ¨¡å—ï¼š

â€‹	Pre Filterså‰ç½®è·¯ç”±ï¼šè¯·æ±‚è¿›æ¥ï¼Œå…ˆç»è¿‡`Pre Filters`, ä¾‹å¦‚å¯ä»¥åšæ—¥å¿—è®°å½•ï¼›

â€‹	Routing Filtersè·¯ç”±ï¼šä¸»è¦ä½œç”¨å°±æ˜¯è·¯ç”±å¹¶æ‰¾åˆ°å…·ä½“çš„å¾®æœåŠ¡ï¼Œè¯·æ±‚æœåŠ¡ï¼›

â€‹	Post Filtersåç½®è·¯ç”±ï¼šä¸»è¦æ˜¯å¤„ç†éœ€è¦è¿”å›ç»™å®¢æˆ·çš„æ¶ˆæ¯;

â€‹	Error Filters: æ‰€æœ‰è·¯ç”±æ‹¦æˆªçš„è¿‡ç¨‹ä¸­å‡ºç°çš„é”™è¯¯ï¼Œéƒ½å¯ä»¥æŠ›ç»™Error Filteræ¥ç»Ÿä¸€å¤„ç†ï¼Œæœ€åäº¤ç»™Post Filtersæ¥è¿”å›ï¼›





### Netflixçš„å¾®æœåŠ¡è·¯ç”±å‘ç°æœºåˆ¶

![050291d25a274c5611651e1a27f21c02_1726x906](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-16-073056.png)

NetflixæœåŠ¡æ³¨å†Œä¸­å¿ƒç»„ä»¶ï¼š Eureka

Netflixç½‘å…³ç»„ä»¶ï¼šZuul

ä¸¤ä¸ªç»„ä»¶æ”¯æ’‘äº†æ•´ä¸ªnetflixçš„è·¯ç”±å‘ç°ä½“ç³»ï¼š

ç¬¬ä¸€å±‚æœåŠ¡å‘ç°æœºåˆ¶ï¼š

åŸºç¡€æœåŠ¡å¯åŠ¨æ—¶ï¼Œä¼šå‘Eurekaæ³¨å†ŒæœåŠ¡ï¼Œå†…éƒ¨çš„èšåˆæœåŠ¡éœ€è¦ç”¨åˆ°åŸºç¡€æœåŠ¡æ—¶ï¼Œé€šè¿‡`æœåŠ¡æ³¨å†Œä¸­å¿ƒ`æ¥å‘ç°æœåŠ¡ã€‚

ç¬¬äºŒå±‚æœåŠ¡å‘ç°æœºåˆ¶ï¼š

èšåˆæœåŠ¡ä¹Ÿä¼šå‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡ï¼Œç½‘å…³å±‚ä½œä¸ºå®¢æˆ·çš„ç»Ÿä¸€æ¥å…¥ç‚¹ï¼Œä¼šé€šè¿‡æ³¨å†Œä¸­å¿ƒçš„è·¯ç”±è¡¨ï¼Œæ¥æ‰¾åˆ°å¯¹åº”çš„èšåˆæœåŠ¡ã€‚

> é—®é¢˜ï¼šç°åœ¨å¸‚é¢ä¸Šæœ‰å¾ˆå¤šç»„ä»¶ï¼Œæ¯”å¦‚Zookeeper,Consul,è¿˜æœ‰nginxç­‰ç­‰ã€‚é‚£ä¹ˆç”¨è¿™äº›ç»„ä»¶, è¯¥å¦‚ä½•åšå¾®æœåŠ¡å‘ç°æœºåˆ¶å‘¢?



### é…ç½®ä¸­å¿ƒ

> é—®é¢˜ï¼šé—®ä»€ä¹ˆéœ€è¦é…ç½®ä¸­å¿ƒï¼Ÿ

å¤§éƒ¨åˆ†æ—¶å€™ï¼Œæˆ‘ä»¬çš„é…ç½®éƒ½æ˜¯å†™åœ¨é…ç½®æ–‡ä»¶ä¸­çš„ã€‚ä¼šæœ‰ä¸€äº›ç¼ºç‚¹æˆ–è€…ä¼šé€ æˆä¸€äº›é—®é¢˜ï¼š

1. é…ç½®ä¸æ ‡å‡†, æ ¼å¼ä¸ç»Ÿä¸€
2. ç”Ÿæ•ˆå‘¨æœŸé•¿
3. é…ç½®è¢«ä¿®æ”¹äº†å¹¶ä¸çŸ¥é“ï¼Œå¾€å¾€éƒ¨ç½²åˆ°çº¿ä¸Šäº†æ‰å‘ç°ï¼›
4. è€Œä¸”æ²¡æœ‰å®¡è®¡åŠŸèƒ½,  å¾ˆéš¾è¿½æº¯è°è°ƒæ•´çš„ï¼Œåªèƒ½æŸ¥çœ‹ä»£ç è®°å½•ï¼›

> ä¸€èˆ¬æœ‰å“ªäº›å¯ä»¥é…ç½®çš„é¡¹ï¼Ÿ

- æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
- è¶…æ—¶å‚æ•°
- ä¸šåŠ¡å¼€å…³
- åŠŸèƒ½å¼€å…³ç­‰

#### åŸºæœ¬åŸç†

![img](https://box.kancloud.cn/bf8bfc8f9d97b6f978d250f43651a7b9_1662x734.png)

å¼€å‘äººå‘˜å¯ä»¥å¯¹é…ç½®ä¸­å¿ƒæ›´æ”¹é…ç½®, ç„¶åæœåŠ¡å¯ä»¥å®æ—¶æ›´æ”¹è‡ªå·±é…ç½®ã€‚
2ç§è¯»å–é…ç½®çš„æ–¹å¼ï¼š(å„æœ‰ä¼˜åŠ£)

1. è‡ªå·±ä¸æ–­çš„å»æ‹‰,ç„¶åæ›´æ–°è‡ªå·±(è¿™ä¸ªå¯ä»¥ä¿è¯æ‹‰åˆ°,è¿™æ¬¡æ²¡æ‹‰åˆ°,ä¸‹æ¬¡å†æ‹‰)
2. é…ç½®ä¸­å¿ƒè‡ªå·±ä¸»åŠ¨æ¨é€(è¿™ä¸ªå¯ä»¥å®æ—¶,ä½†æ˜¯æ²¡æ¨æˆåŠŸ,å°±ä¸æ˜¯å®æ—¶)



#### Apolloé…ç½®ä¸­å¿ƒæ¶æ„

![164492343a4d7c4fc78c336a9c901c72_1597x782](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-30-091437.png)



### RPC VS REST

|             | RPC                                                  | REST                                      |
| ----------- | ---------------------------------------------------- | ----------------------------------------- |
| è€¦åˆæ€§      | å¼ºè€¦åˆ                                               | æ¾æ•£è€¦åˆ                                  |
| æ¶ˆæ¯åè®®    | äºŒè¿›åˆ¶åè®®                                           | JSON ã€XMLæ–‡æœ¬åè®®                        |
| é€šè®¯åè®®    | TCP                                                  | HTTP/HTTP2                                |
| æ€§èƒ½        | é«˜                                                   | ä½äºRPC                                   |
| æ¥å£å¥‘çº¦    | thriftã€profobuf                                     | Swagger æ¥å£å®šä¹‰                          |
| å®¢æˆ·ç«¯      | å¼ºç±»å‹å®¢æˆ·ç«¯ï¼Œå¯ä»¥æ”¯æŒå¤šè¯­è¨€å®¢æˆ·ç«¯                   | ä¸€èˆ¬http clientå¯è®¿é—®ï¼Œæ”¯æŒå¤šå®¢æˆ·ç«¯è¯­è¨€ã€‚ |
| æ¡ˆä¾‹ - æ¡†æ¶ | Dubbo, motan, Tars, grpc, thrift                     | SpringMVC, SpringBoot, jax-rs, dropwizard |
| å¼€å‘è€…å‹å¥½  | å®¢æˆ·ç«¯æ¯”è¾ƒæ–¹ä¾¿ï¼Œä½†æ˜¯äºŒè¿›åˆ¶æ¶ˆæ¯ä¸å¯è¯»ã€‚è°ƒè¯•æ¯”è¾ƒéº»çƒ¦ï¼› | æ–‡æœ¬å¯è¯»ï¼Œé€šè¿‡æµè§ˆå™¨å¯è®¿é—®                |
| å¯¹å¤–å¼€æ”¾    | å¯¹å¤–æš´éœ²æ—¶ï¼Œä¸€èˆ¬éœ€è¦è½¬æ¢æˆRESTåè®®çš„å½¢å¼             | ç›´æ¥å¯¹å¤–å¼€æ”¾                              |

Dubbo â€”â€” é˜¿é‡Œ

grpc â€”â€” google



### å¾®æœåŠ¡æ²»ç†

> æœåŠ¡æ²»ç†ä¸€èˆ¬åŒ…å«å“ªäº›å†…å®¹ï¼Ÿ

![ebe8f11b112897e58ff36732b222ce40_1709x867](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-30-104025.png)

- **æœåŠ¡å‘ç°**ï¼šå¥½çš„å¾®æœåŠ¡æ¡†æ¶éœ€è¦èƒ½å¤Ÿæœ‰æœåŠ¡å‘ç°æœºåˆ¶ï¼›

- **è´Ÿè½½å‡è¡¡**ï¼šå¤§è§„æ¨¡çš„æœåŠ¡å‘å¸ƒéœ€è¦è´Ÿè½½å‡è¡¡ï¼Œä¿è¯æœåŠ¡ä¸ä¼šå•ç‚¹æ•…éšœï¼›ä¹Ÿå¯ä»¥åº”ç”¨åˆ°æœåŠ¡å‡çº§ä¸Šï¼Œè“ç»¿å‡çº§ã€‚

- **ç›‘æ§**

  - **æ—¥å¿—ç›‘æ§**ï¼šæ—¥å¿—ç›‘æ§ã€æ—¥å¿—æŸ¥çœ‹ç”¨æ¥æ’æŸ¥çº¿ä¸Šé—®é¢˜ï¼›
  - **Metrics**ï¼šå¤šè§’åº¦å»ç›‘æ§æœåŠ¡
  - **è°ƒç”¨é“¾ç›‘æ§**ï¼šåœ¨é”™ç»¼å¤æ‚çš„å¾®æœåŠ¡ç³»ç»Ÿä¸­ï¼Œè°ƒç”¨é€»è¾‘å¾€å¾€å¾ˆå¤æ‚ï¼Œéœ€è¦é€šè¿‡è°ƒç”¨é“¾ç›‘æ§ç³»ç»ŸæŸ¥çœ‹å…·ä½“å“ªä¸ªç¯èŠ‚å‡ºç°é—®é¢˜ï¼›

- **ç†”æ–­é™æµ**ï¼šé«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œä»»æ„ä¸€ä¸ªæœåŠ¡å´©æºƒéƒ½ä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿçš„å´©æºƒï¼›æ‰€ä»¥éœ€è¦åŠ å…¥é™æµç†”æ–­ï¼Œé¿å…é«˜é¢‘ç‡çš„è®¿é—®ï¼›

- **å®‰å…¨**&**è®¿é—®æ§åˆ¶**ï¼šç½‘å…³çš„åŸºç¡€åŠŸèƒ½ï¼Œé™åˆ¶åŠŸèƒ½è®¿é—®ï¼›

- **REST**/**RPC**: æ”¯æŒä¸¤ç§åè®®çš„è®¿é—®ï¼›

- **ç»Ÿä¸€å¼‚å¸¸å¤„ç†**ï¼šç»Ÿä¸€è§„èŒƒé”™è¯¯æ¨¡å¼ï¼Œæ–¹ä¾¿æŸ¥çœ‹æ—¥å¿—ã€‚

- **æ–‡æ¡£**ï¼šå¯¹å¤–å¯¹å†…çš„APIæ–‡æ¡£è¾“å‡ºï¼Œæœ€å¥½èƒ½è‡ªåŠ¨ç”Ÿæˆï¼›

- **é…ç½®é›†æˆ**ï¼šé€šè¿‡é…ç½®ä¸­å¿ƒï¼Œæ¥å®ç°åŠ¨æ€ä¿®æ”¹é…ç½®ï¼Œå®æ—¶å‘å¸ƒæœåŠ¡ï¼›

  

### æœåŠ¡ç›‘æ§ä½“ç³»

![4a9f578da1eace0ca6c0666acae5e17f_1757x909](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-18-221431.png)

> 5ä¸ªå±‚æ¬¡ï¼Œä»ä¸‹å¾€ä¸Šä¾æ¬¡ä¸º

**åŸºç¡€è®¾æ–½ç›‘æ§**: ä¸€èˆ¬éƒ½æ˜¯æœåŠ¡è¿è¥å•†å»è¿›è¡Œç›‘æ§ï¼›

**ç³»ç»Ÿå±‚ç›‘æ§**ï¼šä¸»è¦ç›‘æ§å¯¹è±¡ä¸ºç‰©ç†æœºã€è™šæ‹Ÿæœºã€æ“ä½œç³»ç»Ÿï¼Œç›‘æ§æŒ‡æ ‡ä¸€èˆ¬æ˜¯cpuã€å†…å­˜ã€ç½‘ç»œã€ç¡¬ç›˜ç­‰ï¼›

**åº”ç”¨å±‚ç›‘æ§**ï¼šåº”ç”¨å±‚ä¸€èˆ¬é’ˆå¯¹æœåŠ¡è¿›è¡Œç›‘æ§ï¼Œä¸»è¦å…³å¿ƒ`æœåŠ¡æ¥å£`æ˜¯å¦å¯ç”¨ã€å¹³å‡å“åº”æ—¶é—´ã€ï¼ˆqbsï¼‰æ¯ç§’é’Ÿå¤„ç†è¯·æ±‚æ•°é‡ã€æ˜¯å¦å­˜åœ¨æ…¢æŸ¥è¯¢ç­‰ç­‰ã€‚

**ä¸šåŠ¡ç›‘æ§**ï¼šä¸»è¦ç›‘æ§æ ¸å¿ƒä¸šåŠ¡ï¼Œæ¯”å¦‚çœ‹ä¸‹ä¸‹å•æƒ…å†µã€æ³¨å†Œç™»å½•æƒ…å†µã€‚äº§å“éƒ¨é—¨ä¼šé’ˆå¯¹ä¸šåŠ¡å±‚çš„ç›‘æ§æ•°æ®è¿›è¡Œåˆ†æï¼Œæ¥åˆ¤æ–­äº§å“æ˜¯å¦æ»¡è¶³å¸‚åœºéœ€æ±‚ã€æ¨å¹¿çš„æ•ˆæœæ˜¯å¦ç¬¦åˆé¢„æœŸç­‰ï¼›

**ç«¯ç”¨æˆ·ä½“éªŒç›‘æ§**ï¼šè¿™ä¸ªä¸€èˆ¬å°±æ˜¯é’ˆå¯¹å®¢æˆ·ç«¯è¿›è¡Œç›‘æ§ã€‚æ¯”å¦‚å¯¹å®¢æˆ·ç«¯ç‰ˆæœ¬è¿›è¡Œç›‘æ§ï¼Œæ¥å…¥çš„è¿è¥å•†æ˜¯ç§»åŠ¨è¿˜æ˜¯ç”µä¿¡ç­‰ç­‰ã€‚ç”¨æˆ·ä½“éªŒç›‘æ§ä¸»è¦æ˜¯äº§å“ç»ç†æ¯”è¾ƒå…³å¿ƒçš„åœ°æ–¹ï¼›



#### ç›‘æ§å†…å®¹

- å¥åº·æ£€æŸ¥
- å‘Šè­¦ç³»ç»Ÿ
- è°ƒç”¨é“¾ç›‘æ§
- æ—¥å¿—ç›‘æ§
- Metricsç›‘æ§



#### ç›‘æ§æ–¹æ¡ˆ

![1bfb36ddd14d2375188465288b87b226_1704x866](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-18-120908.png)



**æ–¹æ¡ˆç†è§£ï¼š**

å¾®æœåŠ¡ä¸€èˆ¬ä¼šåœ¨è¿›ç¨‹å†…éƒ¨æˆ–è€…ä¸»æœºä¸ŠåŠ ä¸€ä¸ª`agentï¼ˆä»£ç†ï¼‰`ï¼Œè¿™ä¸ªä»£ç†ä¼šå»æ”¶é›†å¹¶åˆ†å‘æ—¥å¿—

å¦‚æœæ—¥å¿—é‡è¿‡å¤§ï¼Œå¯ä»¥é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆKafkaï¼‰åšä¸€ä¸ªç¼“å†²ï¼Œ

æ‰€æœ‰çš„æ—¥å¿—ä¼šé€šè¿‡`ELK`æ–¹æ¡ˆï¼Œè¿›è¡Œå…¨æ–‡æœç´¢åˆ†æï¼›

åŒæ—¶ä¼šé€šè¿‡`Metrics`æ¥ç›‘æ§`åº¦é‡`ï¼Œå°†ä¸åŒç»´åº¦çš„åº¦é‡æ•°æ®å­˜å‚¨åœ¨`InfluxDB` çš„æ—¶é—´åºåˆ—æ•°æ®åº“ä¸­ï¼ŒGrafanaé’ˆå¯¹æ•°æ®è¿›è¡Œå¯è§†åŒ–å±•ç¤ºã€‚

æœ€åé€šè¿‡ä¸€ä¸ª`å¥åº·æ£€æŸ¥æœºåˆ¶`sensu/Nagios/Kubernetesï¼Œæ¥å»æ£€æŸ¥å¾®æœåŠ¡çš„ç›‘æ§æƒ…å†µ

**æ–¹æ¡ˆæŠ€æœ¯æ¡†æ¶**

> `ELK`æ˜¯Elasticsearch + logstash + kibanaä¸‰ä¸ªç»“åˆåœ¨èµ·ä¸€èµ·ç¼©å†™ï¼›
>
> Elasticsearchæ˜¯å®æ—¶å…¨æ–‡æœç´¢å’Œå¼•æ“åˆ†æ
>
> logstashæ˜¯ç”¨æ¥æœé›†ã€åˆ†æã€è¿‡æ»¤æ—¥å¿—çš„å·¥å…·
>
> kibanaæ˜¯åŸºäºwebçš„å›¾å½¢ç•Œé¢ï¼Œç”¨äºæœç´¢ã€åˆ†æå’Œå¯è§†åŒ–æ•°æ®



### è°ƒç”¨é“¾ç›‘æ§

> è°ƒç”¨é“¾ç›‘æ§æ¥æºäºgoogleçš„ä¸€ç¯‡è®ºæ–‡ï¼šGoogle Dapper

![323d71a2e7c3f4d8df325d12d51f037c_1505x853](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-18-123359.png)

å¦‚å›¾æ‰€ç¤ºï¼šhttpè¯·æ±‚ ç»è¿‡ web å®¹å™¨ï¼Œå†åœ¨å†…éƒ¨ç»è¿‡ä¸€äº›åˆ—æœåŠ¡è½¬æ¢ï¼Œè¿›å…¥service1 ï¼Œå†åˆ° DB å†è¿”å›ï¼›

æ¯ä¸ªè¯·æ±‚ç»è¿‡ä¸€å±‚è°ƒç”¨ï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ª`span`;

æ¯ä¸ªspanï¼Œä¼šç”Ÿæˆè‡ªå·±çš„trace_idï¼Œspan_id, å¹¶ä¸”å…³è”ä¸Šå±‚çš„parent_id. è¿™æ ·ï¼Œé€šè¿‡è¿™3ä¸ªidçš„å…³ç³»ï¼Œæ¥ç”Ÿæˆè°ƒç”¨é“¾ï¼›

#### ç›‘æ§æ¡†æ¶å·¥å…·ï¼š

![f53e7bdf7fa23d869f741aa8aca76df5_1825x852](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-18-123723.png)



### ç†”æ–­é™æµ

#### Hystrixæ¡†æ¶



å°è£…è¯·æ±‚ï¼šç†”æ–­ã€éš”ç¦»ã€é™æµã€é™çº§

å¦‚æœæ‰“å¼€äº†é™æµæªæ–½ï¼Œç›´æ¥çŸ­è·¯ã€‚

å¦‚æœçº¿ç¨‹æ»¡äº†

å¦‚æœè¿è¡Œè¶…æ—¶ï¼šé™çº§ï¼›



### å®¹å™¨æŠ€æœ¯



### è“ç»¿éƒ¨ç½²å’Œç°åº¦å‘å¸ƒ

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-18-125511.png" width="500" />



è“ç»¿éƒ¨ç½²ï¼šè“è‰²ä»£è¡¨æ˜¯è€ç‰ˆæœ¬ï¼Œç»¿è‰²ä»£è¡¨æ˜¯æ–°ç‰ˆæœ¬ï¼›

ç°åº¦å‘å¸ƒï¼šä¸æ˜¯ä¸€æ¬¡æ€§æŠŠæµé‡å…¨éƒ¨åˆ‡æ¢åˆ°æ–°ç‰ˆæœ¬ä¸Šï¼Œè€Œæ˜¯å…ˆåˆ‡ä¸€éƒ¨åˆ†æµé‡ï¼Œç¡®ä¿æ²¡é—®é¢˜åï¼Œå†å…¨éƒ¨åˆ‡æ¢åˆ°æ–°ç‰ˆæœ¬ä¸Šã€‚





å¾®æœåŠ¡ 

Mesosçš„æœåŠ¡æ¡†æ¶

Master - Slaver æ¨¡å¼ï¼›



------



# JVM

> https://www.processon.com/view/5c749debe4b0f9fba6921d15?fromnew=1

### JDKã€JREã€JVMçš„åŒºåˆ«

JDKåŒ…å«JREï¼ŒJREåŒ…å«JVMã€‚

JDKæ˜¯Javaå¼€å‘çš„å·¥å…·åŒ…ï¼ˆJava Develop Kitï¼‰

JREæä¾›äº†Javaè¿è¡Œçš„ç¯å¢ƒï¼ˆJava Runtime Enviorment)

JVMåˆ™æ˜¯ä¸€å°è™šæ‹Ÿæœºï¼Œä»–ä»è½¯ä»¶çš„å±‚é¢ä¸Šï¼Œåœ¨è™šæ‹Ÿæœºå†…éƒ¨å¸®æˆ‘ä»¬æŠŠJDKç¼–è¯‘å‡ºæ¥çš„classæ–‡ä»¶ï¼Œè½¬æ¢ä¸ºå¯ä»¥è¢«å½“å‰æ“ä½œç³»ç»Ÿè¯†åˆ«çš„æœºå™¨ç ã€‚æ¢å¥è¯è¯´ï¼Œä»–å†…éƒ¨å¸®åŠ©æˆ‘ä»¬å±è”½äº†ä¸€äº›æ“ä½œç³»ç»Ÿå±‚é¢ä¸Šçš„åŒºåˆ«ï¼Œè®©æˆ‘ä»¬çš„ç¨‹åºèƒ½å¤Ÿ**è·¨å¹³å°è¿è¡Œ**ã€‚

JVMåŒ…å«äº†3ä¸ªéƒ¨åˆ†ï¼šç±»åŠ è½½å™¨å­ç³»ç»Ÿã€è¿è¡Œæ—¶æ•°æ®åŒºã€æ‰§è¡Œå¼•æ“ã€‚

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-26-071216.png" alt="image-20191026151216502" style="zoom:50%;" />

### JVMå†…å­˜åŒºåŸŸ

è¿è¡Œæ—¶æ•°æ®åŒºæ˜¯JVMçš„æ ¸å¿ƒï¼Œæ•´ä½“çš„ç»“æ„å¦‚ä¸‹ï¼š



<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-26-042632.png" alt="image-20191026122631783" style="zoom:50%;" />

**Javaæ ˆ**ï¼ˆè™šæ‹Ÿæœºæ ˆï¼‰ï¼šJavaä¼šç»™æ¯ä¸€ä¸ªè¿è¡Œçš„çº¿ç¨‹åˆ†é…ä¸€ä¸ªæ ˆï¼Œè¿™ä¸ªæ ˆæ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚

â€‹	**æ ˆé’ˆ**ï¼šåœ¨æ ˆé‡Œé¢ï¼Œå­˜æ”¾æœ‰å¾ˆå¤šæ ˆå¸§ï¼Œæ¯ä¸ªæ–¹æ³•è¿è¡Œæ—¶éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ ˆå¸§å…¥æ ˆï¼Œä¿è¯æ¯ä¸ªæ–¹æ³•æœ‰è‡ªå·±ç‹¬ç«‹çš„ä½œç”¨åŸŸï¼›æ ˆå¸§é‡Œå­˜å‚¨äº†javaæ–¹æ³•è¿è¡Œæ—¶çš„ç›¸å…³ä¿¡æ¯ï¼ˆå±€éƒ¨å˜é‡è¡¨ï¼Œæ“ä½œæ•°æ ˆï¼ŒåŠ¨æ€é“¾æ¥ï¼Œæ–¹æ³•å‡ºå£ç­‰ï¼‰

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-26-063421.png" alt="image-20191026143421183" style="zoom:50%;" />



â€‹	**å±€éƒ¨å˜é‡è¡¨**ï¼šä¿å­˜æ–¹æ³•å†…éƒ¨çš„ä¸´æ—¶å˜é‡ï¼Œæ¯”å¦‚ï¼ša=1;b=2;c=new Math()`ç­‰

â€‹	**æ“ä½œæ•°æ ˆ**ï¼šjvmæ‰§è¡Œå¼•æ“ä¼šç”¨åˆ°ï¼Œå­˜æ”¾ä¸€äº›æ“ä½œç¬¦è¿ç®—ï¼›

**æœ¬åœ°æ–¹æ³•æ ˆ**ï¼šå’ŒJavaæ ˆçš„æ¦‚å¿µç±»ä¼¼ï¼Œä¹Ÿæ˜¯æ¯ä¸ªçº¿ç¨‹ç§æœ‰ã€‚å®ƒé‡Œé¢å­˜æ”¾çš„éƒ½æ˜¯ä¸€äº›nativeçš„æ–¹æ³•ä¿¡æ¯ã€‚

**ç¨‹åºè®¡æ•°å™¨ï¼š**ä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰ï¼Œä½œç”¨ä¸»è¦æ˜¯ä¸ºäº†è®°å½•å½“å‰çº¿ç¨‹è¿è¡Œåˆ°å“ªä¸€è¡Œä»£ç ã€‚å› ä¸ºæ¯ä¸ªçº¿ç¨‹çš„æ‰§è¡Œéƒ½ä¾èµ–äºCPUçš„è°ƒåº¦ï¼Œæ˜¯éœ€è¦æŠ¢å CPUèµ„æºçš„ï¼Œæ‰€ä»¥çº¿ç¨‹ç»å¸¸ä¼šå› ä¸ºå¤±å»CPUèµ„æºè€Œè¢«æŒ‚èµ·ã€‚å½“çº¿ç¨‹é‡å¯è·å–åˆ°è¿è¡Œèµ„æºæ—¶ï¼Œå°±è¦æ ¹æ®ç¨‹åºè®¡æ•°å™¨æ¥ç»§ç»­æ‰§è¡Œã€‚

**å †**: å †å†…å­˜æ˜¯çº¿ç¨‹å…±äº«çš„ï¼Œç”¨æ¥å­˜æ”¾javaè¿è¡Œæ—¶åˆ›å»ºå‡ºæ¥çš„å¯¹è±¡ï¼Œå¯¹è±¡çš„â€œå†…å­˜åœ°å€â€å­˜æ”¾åœ¨æ ˆå±€éƒ¨å˜é‡è¡¨é‡Œé¢ã€‚

â€‹	å †å†…å­˜ç»“æ„åŒ…æ‹¬ï¼šæ–°ç”Ÿä»£ã€formã€toã€æ°¸ä¹…ä»£ï¼›

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-26-084454.png" alt="image-20191026164453593" style="zoom:60%;" />

**æ–¹æ³•åŒº**ï¼šæ–¹æ³•åŒºé‡Œå­˜æ”¾çš„æ˜¯ç±»å…ƒä¿¡æ¯ã€é™æ€å˜é‡ã€å¸¸é‡ç­‰ã€‚

â€‹	é™æ€å˜é‡

â€‹	å¸¸é‡ï¼š static finalçš„

â€‹	ç±»å…ƒä¿¡æ¯ï¼šä¸€ä¸ªç±»çš„ç»„æˆä¿¡æ¯ã€‚ï¼ˆç±»åã€ç±»ä¿®é¥°ç¬¦ã€æ–¹æ³•åç­‰ï¼‰



### GCåƒåœ¾å›æ”¶æœºåˆ¶

Javaåƒåœ¾å›æ”¶åˆ†ä¸ºminorå›æ”¶å’Œmajorå›æ”¶ï¼Œä¸¤ç§å›æ”¶çš„æœºåˆ¶ä¸åŒï¼Œå›æ”¶çš„å¯¹è±¡ä¸»ä½“åœ¨å †å†…å­˜æ¨¡å‹ä¸­ä¹Ÿä¸ä¸€æ ·ã€‚

ğŸ‘†Javaå †å†…å­˜æ¨¡å‹åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼š

æ–°ç”Ÿä»£å¤§æ¦‚å å †å†…å­˜çš„1/3ï¼Œè€å¹´ä»£å å†…å­˜çš„2/3ã€‚

**æ–°ç”Ÿä»£**ï¼š

ç”±Edenå’ŒSurvior Spaceç»„æˆã€‚åˆå§‹å¤§å°ç”±-Xmnå‚æ•°è®¾å®šã€‚

å·¥ä½œæœºåˆ¶ï¼š

EdenåŒºå¤§çº¦å æ–°ç”Ÿä»£å†…å­˜ç©ºé—´çš„8/10ï¼Œjava newå‡ºæ¥çš„å¯¹è±¡éƒ½ä¼šå…ˆæ”¾å…¥åˆ°EdenåŒºï¼›å½“Edenå†…å­˜ä¸å¤Ÿæ—¶ï¼Œjvmä¼šå¯åŠ¨ä¸€æ¬¡minor gcã€‚Minor GCä¼šæŠŠé‚£äº›å†…å­˜ä¸­ä¸å†æœ‰å¼•ç”¨çš„å¯¹è±¡éƒ½å›æ”¶ï¼ˆå›æ”¶ç®—æ³•ä¸‹é¢ä¼šè®²åˆ°ï¼‰ï¼Œè€Œé‚£äº›æœ‰ç”¨çš„å¯¹è±¡ä¼šè¢«å…¨éƒ¨ç§»åŠ¨åˆ°`S0 Space`ã€‚ç¬¬äºŒæ¬¡gcçš„æ—¶å€™ï¼Œä¼šæŠŠEdenåŒºå’ŒS0 Spaceé‡Œå­˜æ´»çš„å¯¹è±¡ä¸€èµ·ç§»åŠ¨åˆ°S1 Spaceã€‚

å¯¹è±¡åœ¨s0 spaceå’Œs1 spaceæ¥å›ç§»åŠ¨ï¼Œæ¯æ¬¡è½¬ç§»æ—¶ï¼Œè¿™äº›å¯¹è±¡éƒ½ä¼šæ›´æ–°gcçš„å¹´é¾„æ ‡å¿—ã€‚å½“gcå¹´é¾„è¾¾åˆ°15æ—¶ï¼Œä¼šå°†è¯¥å¯¹è±¡ç§»åŠ¨åˆ°è€å¹´ä»£ã€‚

å¦‚æœs0å’Œs1çš„å†…å­˜åŒºåŸŸæ”¾ä¸ä¸‹å­˜æ´»çš„å¯¹è±¡æ—¶ï¼Œä¼šå»è€å¹´ä»£å†…å­˜ä¸­å€Ÿç”¨å†…å­˜ï¼Œç­‰ä¸‹ä¸€æ¬¡gcåå†è¿˜ç»™è€å¹´ä»£ã€‚è€Œè€å¹´ä»£ä¹Ÿä¼šä¸ºäº†ç¡®ä¿minor gcæ“ä½œèƒ½å®Œæˆï¼Œé¢„ç•™äº†ä¸€éƒ¨åˆ†å†…å­˜ä½œä¸ºä¿ç•™åŒºåŸŸã€‚è¿™ç§è¡Œä¸ºæˆä¸ºï¼š`æ–°ç”Ÿä»£æœé›†æ‹…ä¿`ã€‚å¦‚æœé¢„ç•™æ“ä½œæ— æ³•å®Œæˆï¼Œä¹Ÿä¼šè§¦å‘Major GCã€‚

**è€å¹´ä»£**ï¼š

è€å¹´ä»£åŒºåŸŸä¸­çš„å¯¹è±¡å­˜æ´»ç‡å¾ˆé«˜ï¼Œä¸€èˆ¬å›æ”¶çš„å‘¨æœŸå¾ˆé•¿ã€‚

Major GCå› ä¸ºè¦å¯¹æ‰€æœ‰çš„å¯¹è±¡è¿›è¡Œå›æ”¶ï¼Œå¾ˆæ¶ˆè€—æ—¶é—´ï¼Œæ‰€ä»¥è¦å°½é‡é¿å…Major GCã€‚jvmè°ƒä¼˜çš„è¿‡ç¨‹ä¸­ï¼Œå¾ˆå¤§ä¸€éƒ¨åˆ†å·¥ä½œå°±æ˜¯å‡å°‘Full GCçš„æ¬¡æ•°ã€‚



### GCå›æ”¶åˆ¤æ–­

#### ~~å¼•ç”¨è®¡æ•°æ³•~~

#### å¯è¾¾æ€§åˆ†æ

#### GC Rootsæ ¹

javaçš„åƒåœ¾å›æ”¶æœºåˆ¶ä¸­ï¼Œåˆ¤æ–­1ä¸ªå¯¹è±¡æ˜¯å¦å¯è¢«å›æ”¶ï¼Œå¹¶ä¸æ˜¯çœ‹æœ‰æ²¡æœ‰å¯¹è±¡å¯¹å…¶å¼•ç”¨ï¼Œè€Œæ˜¯é€šè¿‡`å¯è¾¾æ€§åˆ†æ`ï¼Œçœ‹è¿™ä¸ªå¯¹è±¡æœ‰æ²¡æœ‰åˆ°GC Rootsçš„å¼•ç”¨é“¾ç›¸è¿ã€‚æ€ä¹ˆç†è§£è¿™æ®µè¯ï¼Ÿå°±æ˜¯è¯´ï¼Œä»GC Rootsæ ¹å‘ä¸‹æ‰¾ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½æ‰¾åˆ°ä¸€æ¡è·¯ï¼Œè¾¾åˆ°è¿™ä¸ªå¯¹è±¡ã€‚å¦‚æœæ‰¾åˆ°äº†ï¼Œè¯´æ˜æ˜¯æœ‰å¼•ç”¨é“¾ç›¸è¿çš„ã€‚

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-26-132038.png" alt="Ã¨Â¿Ã©Ã¥Ã¥Â¾Ã§Ã¦Ã¨Â¿Â°" style="zoom:50%;" />

å¯ä»¥ä½œä¸ºGC Rootsæ ¹çš„å¯¹è±¡ï¼š

- è™šæ‹Ÿæœºæ ˆï¼ˆæ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡è¡¨ï¼‰ä¸­å¼•ç”¨çš„å¯¹è±¡ï¼›ä»»æ„æ–¹æ³•é‡ŒC c = new C();
- æ–¹æ³•åŒºä¸­é™æ€å˜é‡å¼•ç”¨çš„å¯¹è±¡ï¼›static B b = new B();
- æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡ï¼› static final A a = new A();
- Nativeæ–¹æ³•å¼•ç”¨çš„å¯¹è±¡ï¼›



#### finalizeæŠ¢æ•‘

![img](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-26-132358.png)

#### GC logåˆ†æ

å…è´¹çš„GCæ—¥å¿—å›¾å½¢åˆ†æå·¥å…·æ¨èä¸‹é¢2ä¸ªï¼š

- [GCViewer](https://juejin.im/post/[https://github.com/chewiebug/GCViewer](https://github.com/chewiebug/GCViewer))ï¼Œä¸‹è½½jaråŒ…ç›´æ¥è¿è¡Œ
- [gceasy](https://gceasy.io/)ï¼Œwebå·¥å…·ï¼Œä¸Šä¼ GCæ—¥å¿—åœ¨çº¿ä½¿ç”¨





# JMM



# å¤šçº¿ç¨‹

### å¤šçº¿ç¨‹åº”ç”¨åœºæ™¯



### å®ˆæŠ¤çº¿ç¨‹ä¸éå®ˆæŠ¤çº¿ç¨‹

### å¤šçº¿ç¨‹çš„å‡ ç§çŠ¶æ€

å¤šçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼š

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-19-023655.png" alt="thread_status" style="zoom:50%;" />



### ä¿è¯çº¿ç¨‹çš„æ‰§è¡Œé¡ºåº

### ä½¿ç”¨å¤šçº¿ç¨‹åˆ†æ‰¹å¤„ç†ä¿¡æ¯

### å¤šçº¿ç¨‹é€šä¿¡æ–¹å¼

- #### wait & notify

**ä½¿ç”¨åœºæ™¯**ï¼šç°åœ¨æœ‰Aã€Bä¸¤ä¸ªçº¿ç¨‹äº’æ–¥ï¼Œæˆ‘ä»¬å¸Œæœ›çº¿ç¨‹Bè¿è¡Œåˆ°æŸä¸€ä¸ªçŠ¶æ€é€šçŸ¥çº¿ç¨‹Aè¿è¡Œã€‚å¦‚æœçº¿ç¨‹Aæ‰§è¡Œæ—¶ï¼Œè¿˜æ²¡æœ‰è¾¾åˆ°é¢„æœŸçš„çŠ¶æ€ï¼Œå…ˆè®©çº¿ç¨‹Aç­‰å¾…ï¼Œç­‰çº¿ç¨‹Båˆ°è¾¾è¿™ä¸ªçŠ¶æ€åå†é€šçŸ¥çº¿ç¨‹Aè¿è¡Œã€‚

å¦‚å›¾æ‰€ç¤ºï¼š



<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-19-022618.png" alt="wait" style="zoom:30%;" />



<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-19-023209.png" alt="notify" style="zoom:30%;" />



==æ³¨==ï¼š1.notifyå”¤é†’çš„çº¿ç¨‹ä¸ä¼šåœ¨è°ƒç”¨notifyçš„ä¸€ç¬é—´å°±æ‰§è¡Œï¼Œå› ä¸ºé‚£ä¸ªæ—¶å€™ï¼Œçº¿ç¨‹çš„é”è¿˜æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œå…¶ä»–çº¿ç¨‹è¿˜æ²¡æœ‰åŠæ³•è·å–è¯¥å®ä¾‹çš„é”ã€‚

2.åªæœ‰æ‹¥æœ‰é”çš„çº¿ç¨‹æ‰èƒ½è°ƒç”¨notifyæ–¹æ³•æ¥å”¤é†’å…¶ä»–çº¿ç¨‹ï¼›



- #### CountDownLatch è®¡æ•°é—¨é—©

**åº”ç”¨åœºæ™¯**ï¼šCountDownLatchå†…éƒ¨å°±æ˜¯1ä¸ªè®¡æ•°å™¨ã€‚å½“çº¿ç¨‹Aéœ€è¦ç­‰å¾…å…¶ä»–nä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡ä¹‹åæ‰èƒ½æ‰§è¡Œæ—¶ï¼Œå¯ä»¥é€šè¿‡CountDownLatchæ¥å®ç°ã€‚

**ä½¿ç”¨ä»‹ç»**ï¼š

```java
/**
* æ„é€ æ–¹æ³•ï¼šå‚æ•°countä¸ºè®¡æ•°å€¼
*/
public CountDownLatch(int count) {  };

/**
* è°ƒç”¨await()æ–¹æ³•çš„çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œå®ƒä¼šç­‰å¾…ç›´åˆ°countå€¼ä¸º0æ‰ç»§ç»­æ‰§è¡Œ
*/
public void await() throws InterruptedException { };

/**
* å¯ä»¥ç­‰å¾…ä¸€å®šçš„æ—¶é—´ï¼Œå¦‚æœcountä¾ç„¶æ²¡å˜æˆ0ï¼Œè¿˜æ˜¯ä¼šç»§ç»­æ‰§è¡Œ
*/
public boolean await(long timeout, TimeUnit unit) throws InterruptedException { }; 

/**
* æ¯æ¬¡è°ƒç”¨éƒ½ä¼šå°†countå€¼å‡1
*/
public void countDown() { };  //
```

**å®é™…ä½¿ç”¨**ï¼š

>å¯åŠ¨2ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹1ä¸æ–­çš„addï¼Œçº¿ç¨‹2å»ç›‘å¬å®¹å™¨çš„sizeï¼Œå½“sizeå€¼=5æ—¶ï¼Œç»ˆæ­¢çº¿ç¨‹2.

```java
CountDownLatch countDownLatch = new CountDownLatch(5);
new Thread(() -> {
  try {
    System.out.println("çº¿ç¨‹2å¼€å§‹");
    countDownLatch.await();
    System.out.println("çº¿ç¨‹2ç»“æŸ");
  } catch (InterruptedException e) {
    e.printStackTrace();
  }
}, "t2").start();
new Thread(() -> {
  System.out.println("çº¿ç¨‹1å¼€å§‹");
  synchronized (lock) {
    for (int i = 0; i < 10; i++) {
      myContainer.add(String.valueOf(i));
      System.out.println("å®¹å™¨å¢åŠ ï¼š" + (i + 1));
      countDownLatch.countDown();
      try {
        Thread.sleep(100);
      } catch (InterruptedException e) {
        e.printStackTrace();
      }
    }
  }
}, "t1").start();
```



### æ€ä¹ˆåœæ­¢çº¿ç¨‹



### çº¿ç¨‹å˜é‡ThreadLocal

> å‚è€ƒæ–‡ç« ï¼šhttps://www.jianshu.com/p/22be9653df3f

#### ä½œç”¨

ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹å¼€è¾Ÿä¸€ä¸ªå•ç‹¬çš„å†…å­˜ç©ºé—´ï¼Œç”¨æ¥å­˜æ”¾çº¿ç¨‹ç‹¬äº«çš„èµ„æº

#### ä½¿ç”¨åœºæ™¯

çº¿ç¨‹éœ€è¦å­˜æ”¾å˜é‡ï¼Œä½†æ˜¯åˆä¸å¸Œæœ›åˆ«çš„çº¿ç¨‹æ¥ä¿®æ”¹è‡ªå·±çš„å˜é‡æ—¶ï¼Œå¯ä»¥ç”¨ThreadLocalæ¥å­˜å‚¨å˜é‡çš„å€¼ï¼›

#### ä½¿ç”¨æ–¹å¼

```java
private static class MyRunnable implements Runnable {
  // åˆ›å»ºçº¿ç¨‹å˜é‡      
  ThreadLocal<String> threadLocal = new ThreadLocal<>();

        @Override
        public void run() {
            String name = Thread.currentThread().getName();
            threadLocal.set(name + "çš„ThreadLocalå˜é‡");
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            System.out.println(name + ":" + threadLocal.get());
        }
    }

    public static void main(String[] args) {
        Runnable runnable = new MyRunnable();
        new Thread(runnable, "çº¿ç¨‹1").start();
        new Thread(runnable, "çº¿ç¨‹2").start();
    }
```

#### åŸç†

æ¯ä¸ªçº¿ç¨‹å®ä¾‹éƒ½ä¼šæœ‰ä¸€ä¸ªthreadLocalsçš„å˜é‡ï¼Œç”¨æ¥å­˜æ”¾å½“å‰çº¿ç¨‹çš„ThreadLocalMapï¼›

è€Œå½“ThreadLocalåˆ›å»ºæ—¶ï¼Œä¼šåˆ›å»ºå¥½ThreadLocalMapçš„å®ä¾‹ï¼Œç„¶åå…³è”åˆ°çº¿ç¨‹tçš„threadLocalså˜é‡ä¸Šï¼›

æ¯ä¸ªThreadLocalMapçš„key = å½“å‰ThreadLocalå¯¹è±¡æœ¬èº«ï¼Œvalueæ˜¯ä¸€ä¸ªä»»æ„çš„å€¼ï¼›



æ‰€ä»¥å½“ThreadLocalè®¾ç½®å€¼æ—¶ï¼Œå½“å‰çº¿ç¨‹ä¼šå…ˆæ‹¿åˆ°ThreadLocalMapï¼Œç„¶åä¸ºè¿™ä¸ªmapä¸Šè®¾ç½®å€¼ï¼›

Debugè®°å½•

çº¿ç¨‹1ï¼šThreadLocal@948

![image-20191018075648324](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-17-235649.png)

çº¿ç¨‹1ï¼šThreadLocalMap@961

![image-20191018075918341](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-17-235919.png)

![image-20191018080048039](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-18-000049.png)

çº¿ç¨‹2ï¼šå¯ä»¥çœ‹åˆ°ThreadLocalçš„å˜é‡æ˜¯åŒä¸€ä¸ªï¼Œä½†æ˜¯mapä¼šåˆ›å»ºæ–°çš„ï¼›

![image-20191018075622915](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-17-235623.png)



## å¤šçº¿ç¨‹å®‰å…¨é—®é¢˜

å…ˆçœ‹é—®é¢˜ï¼šå‡è®¾æœ‰10000å¼ ç¥¨ï¼Œå¯åŠ¨10ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å»ä¹°ç¥¨ï¼›æ‰“å°æ¯ä¸ªçº¿ç¨‹è´­ä¹°ç¥¨çš„æƒ…å†µ.



```java
/**
 * åœºæ™¯ï¼šå‡è®¾æœ‰10000å¼ ç«è½¦ç¥¨
 * å¯åŠ¨10ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å»ä¹°ç¥¨ï¼›æ‰“å°è´­ä¹°æƒ…å†µ
 *
 * @author keyang
 * æ¯”è¾ƒä¸€ä¸‹ArrayListã€Vectorã€ConcurrentLinkedQueueåŒºåˆ«
 */
public class ConcurrentQueue1 {
	
	public static void main(String[] args) {
    // æ³¨è§£1
//		List<String> tickets = new ArrayList<>();
    // æ³¨è§£2
//		Vector<String> tickets = new Vector<String>();
    // æ³¨è§£3
		ConcurrentLinkedQueue<String> tickets = new ConcurrentLinkedQueue<>();
		for (int i = 0; i < 1000; i++) {
			tickets.add("ç«è½¦ç¥¨" + i);
		}
		System.out.println(tickets.size());
		for (int i = 0; i < 10; i++) {
			Thread thread = new Thread(() -> {
//				synchronized (tickets) {
				while (tickets.size() > 0) {
					try {
						Thread.sleep(10);
					} catch (InterruptedException e) {
						e.printStackTrace();
					}
//						System.out.println(Thread.currentThread().getId() + "â€”â€”" + tickets.remove(0));
					String ticket = tickets.poll();
					if (ticket == null) {
						break;
					}
					System.out.println(Thread.currentThread().getId() + "â€”â€”" + ticket);
				}
//				}
			});
			thread.start();
		}
	}
}

```

æ³¨è§£1ï¼šå‡è®¾ç”¨ArrayListæ¥å­˜æ”¾é˜Ÿåˆ—ï¼Œé‚£ä¹ˆç¨‹åºä¼šå‡ºç°è¶Šç•Œçš„é—®é¢˜ã€‚è€Œä¸”è¿˜å¯èƒ½ä¼šå–å‡ºç©ºç¥¨ã€‚

```verilog
21â€”â€”null
19â€”â€”null
17â€”â€”null
18â€”â€”null
Exception in thread "Thread-0" Exception in thread "Thread-9" Exception in thread "Thread-3" Exception in thread "Thread-7" Exception in thread "Thread-4" Exception in thread "Thread-1" Exception in thread "Thread-6" Exception in thread "Thread-8" Exception in thread "Thread-2" java.lang.IndexOutOfBoundsException: Index 0 out of bounds for length 0
	at java.base/jdk.internal.util.Preconditions.outOfBounds(Preconditions.java:64)
	at java.base/jdk.internal.util.Preconditions.outOfBoundsCheckIndex(Preconditions.java:70)
	at java.base/jdk.internal.util.Preconditions.checkIndex(Preconditions.java:248)
	at java.base/java.util.Objects.checkIndex(Objects.java:372)
	at java.base/java.util.ArrayList.remove(ArrayList.java:535)
	at com.gs.example.concurrentdemo.ConcurrentQueue1.lambda$main$0(ConcurrentQueue1.java:36)
	at java.base/java.lang.Thread.run(Thread.java:834)
```

å› ä¸ºArrayListçš„`remove()`æ–¹æ³•æœ¬èº«å°±æ²¡æœ‰åŸå­æ€§.

æ³¨è§£2ï¼šå‡è®¾æ›´æ¢å®¹å™¨ä¸ºVectorã€‚Vectoræœ¬èº«æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œ`remove`æ–¹æ³•æ˜¯å¯ä»¥ä¿è¯åŸå­æ€§çš„ã€‚ä½†æ˜¯ç¨‹åºä¸­`size`åˆ¤æ–­å’Œ`remove`æ–¹æ³•ä¸¤ä¸ªæ“ä½œä¹‹é—´æ˜¯æ— æ³•ä¿è¯ä¸è¢«æ‰“æ–­çš„ï¼Œæ‰€ä»¥ç³»ç»Ÿä¹Ÿä¼šåˆ¤æ–­é”™è¯¯ï¼Œå‡ºç°åŒæ ·çš„è¶Šç•Œé—®é¢˜ã€‚

æ³¨è§£3ï¼šArrayListå’ŒVectorå®¹å™¨åªèƒ½é€šè¿‡ä½¿ç”¨synchronizeé”æ¥ä¿è¯çº¿ç¨‹å®‰å…¨,ï¼Œè€…ä½¿ç”¨å¹¶å‘å®¹å™¨ï¼š`ConcurrentLinkedList`.



### Synchronizedå…³é”®å­—

- #### ä½œç”¨


ä¿è¯åŒä¸€æ—¶åˆ»ï¼Œåªæœ‰1ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œè¢«Synchronizeä¿®é¥°çš„æ–¹æ³•æˆ–ä»£ç å—ï¼›

- #### ä½¿ç”¨åœºæ™¯

ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œé€šè¿‡äº’æ–¥é”ã€é˜»å¡çš„å½¢å¼è§£å†³å¹¶å‘é—®é¢˜ï¼›

- #### ä½¿ç”¨ä»‹ç»

**ä¿®é¥°ä»£ç å—**:  éœ€è¦ä¼ å…¥ä¸€ä¸ªè¢«é”çš„å¯¹è±¡ã€‚æ¯ä¸ªçº¿ç¨‹æ‰§è¡Œä»£ç å—æ—¶ï¼Œéœ€è¦è·å–åˆ°è¿™ä¸ªå¯¹è±¡çš„é”ã€‚javaçš„æ‰€æœ‰å¯¹è±¡éƒ½æœ‰1ä¸ªäº’æ–¥é”ï¼Œsynchronizeæ–¹æ³•ç»“æŸæˆ–è€…æŠ›å‡ºå¼‚å¸¸æ—¶ä¼šè‡ªåŠ¨é‡Šæ”¾é”ã€‚

**ä¿®é¥°å®ä¾‹æ–¹æ³•**ï¼šé”çš„æ˜¯å½“å‰è°ƒç”¨æ–¹æ³•çš„å®ä¾‹å¯¹è±¡ã€‚æ¯ä¸ªå®ä¾‹å¯¹è±¡æ‹¥æœ‰ä¸€æŠŠé”ï¼Œçº¿ç¨‹è°ƒç”¨æ–¹æ³•æ—¶ï¼Œå¿…é¡»è·å–è¯¥å®ä¾‹å¯¹è±¡çš„é”ã€‚â€”â€” å’Œsynchronize(this)çš„æ•ˆæœä¸€æ ·

**ä¿®é¥°ç±»çš„é™æ€æ–¹æ³•**ï¼šé”çš„æ˜¯Classç±»çš„å¯¹è±¡ã€‚æ‰€ä»¥è¯¥Classçš„å®ä¾‹å¯¹è±¡åœ¨è°ƒç”¨è¯¥é™æ€æ–¹æ³•æ—¶ï¼Œå…±ç”¨åŒä¸€æŠŠé”ã€‚å› ä¸ºç±»åªæœ‰1ä¸ªï¼Œé™æ€æ–¹æ³•åœ¨å†…å­˜ä¸­ä¹Ÿåªæœ‰1ä¸ª



**ä¸åŒé”ä¹‹é—´çš„åŒºåˆ«ï¼š**

| ç±»å‹   | é”çš„å¯¹è±¡  | é”çš„æ•°é‡                      | è¡¨ç°å½¢å¼ |
| ------ | --------- | ----------------------------- | -------- |
| å¯¹è±¡é” | å®ä¾‹å¯¹è±¡  | å¤šä¸ªï¼ˆ1ä¸ªç±»å¯ä»¥æœ‰å¤šä¸ªå®ä¾‹ï¼‰   | æ™®é€šæ–¹æ³• |
| ç±»é”   | Classå¯¹è±¡ | 1ä¸ªï¼ˆå› ä¸º1ä¸ªç±»åªæœ‰1ä¸ªç±»å¯¹è±¡ï¼‰ | é™æ€æ–¹æ³• |

**Demo**ï¼š

```java
public class Test{ 
    // å¯¹è±¡é”ï¼šå½¢å¼1(æ–¹æ³•é”) 
    public synchronized void Method1(){ 
        System.out.println("æˆ‘æ˜¯å¯¹è±¡é”ä¹Ÿæ˜¯æ–¹æ³•é”"); 
        try{ 
            Thread.sleep(500); 
        } catch (InterruptedException e){ 
            e.printStackTrace(); 
        } 
    } 
 
    // å¯¹è±¡é”ï¼šå½¢å¼2ï¼ˆä»£ç å—å½¢å¼ï¼‰ 
    public void Method2(){ 
        synchronized (this){ 
            System.out.println("æˆ‘æ˜¯å¯¹è±¡é”"); 
            try{ 
                Thread.sleep(500); 
            } catch (InterruptedException e){ 
                e.printStackTrace(); 
            } 
        } 
    } 
      
      // ç±»é”ï¼šå½¢å¼1 ï¼šé”é™æ€æ–¹æ³•
    public static synchronized void Method1(){ 
        System.out.println("æˆ‘æ˜¯ç±»é”ä¸€å·"); 
        try{ 
            Thread.sleep(500); 
        } catch (InterruptedException e){ 
            e.printStackTrace(); 
        } 
    } 
 ï½
```



### ReentraLock å¯é‡å…¥é”

#### **ä½¿ç”¨åœºæ™¯**

1.æ›¿ä»£synchronizeçš„é”çš„æ–¹æ³•ï¼›é€šè¿‡lockå’Œunlockæ¥å®ç°synchronizeçš„åŠŸèƒ½ï¼›

2.å¯ä»¥ä½¿ç”¨trylockå°è¯•è·å–é”ã€‚å½“æ²¡æœ‰è·å–åˆ°é”æ—¶ï¼Œä¸è¿›è¡Œä¸šåŠ¡é€»è¾‘å¤„ç†ï¼›

3.å¯ä»¥ä½¿ç”¨lockInterruptiblyæ–¹æ³•æ¥å“åº”çº¿ç¨‹çš„interruptæ–¹æ³•ï¼Œé¿å…çº¿ç¨‹å› ä¸ºæ— æ³•è·å–é”è€Œæ— æ³•è¢«æ‰“æ–­ï¼›

4.é€šè¿‡ç»‘å®šconditionï¼Œå¯ä»¥å®ç°å¯¹æŸä¸€ç±»çº¿ç¨‹çš„å®šå‘é€šçŸ¥ã€‚

#### ä½¿ç”¨ä»‹ç»

**lock()**:  lockæ–¹æ³•ä¼šè·å–é”ï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°å°±ä¸€ç›´ç­‰å¾…ï¼›

**tryLock()**:  tryLockä¸ä¼šç­‰å¾…ï¼Œè€Œæ˜¯å³è¿”å›è·å–é”çš„ç»“æœã€‚è·å–åˆ°é”è¿”å›trueï¼Œæ²¡æœ‰ä¼šè¿”å›falseã€‚

**lockInterruptibly()**:  è¿™ä¸ªæ–¹æ³•ä¹Ÿä¼šä¸€ç›´ç­‰å¾…é”çš„è·å–ï¼Œå’Œlockä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡thread.interruptæ–¹æ³•æ—¶ï¼Œè®©çº¿ç¨‹å“åº”ä¸­æ–­ï¼Œä¸å†ç»§ç»­ç­‰å¾…ã€‚

**unLock**():  é‡Šæ”¾é”ï¼Œ==ä½¿ç”¨lockä¸€å®šè¦æ³¨æ„æ‰‹åŠ¨é‡Šæ”¾é”==

**newCondition**():  å¯ä»¥åˆ›å»ºå¤šä¸ªconditionå¯¹è±¡ï¼Œå®ç°awaitå’Œsignalç»„åˆã€‚

#### Condition

**ä½œç”¨**ï¼šconditionå­˜åœ¨çš„æ„ä¹‰æ˜¯ä¸ºäº†å®ç°ç±»ä¼¼ object.wait()å’Œobject.notify()çš„åŠŸèƒ½ã€‚wiatå’Œnotifyæ–¹æ³•å¯ä»¥è®©çº¿ç¨‹ç­‰å¾…ã€è¢«å”¤é†’ã€‚conditionä¹Ÿä¸€æ ·ï¼Œä½†æ˜¯å®ƒå¯ä»¥æ›´åŠ æœ‰é’ˆå¯¹æ€§çš„å»è®©æŸä¸€ç±»çº¿ç¨‹è¢«å”¤é†’ã€‚

**ä½¿ç”¨ä»‹ç»**ï¼š

await():  è®©å½“å‰çº¿ç¨‹è¿›å…¥conditionçš„ç­‰å¾…é˜Ÿåˆ—

signal()ï¼šå”¤é†’conditioné˜Ÿåˆ—ä¸Šçš„æŸä¸€ä¸ªçº¿ç¨‹

signalAll(): å”¤é†’conditioné˜Ÿåˆ—ä¸Šçš„æ‰€æœ‰çº¿ç¨‹ï¼›

#### Demo

1.å®ç°å…¬å¹³é”

```java
ReentrantLock reentrantLock = new ReentrantLock(true); // å…¬å¹³é”
Runnable runnable = new Runnable() {
  @Override
  public void run() {
    for (int i = 0; i < 100; i++) {
      reentrantLock.lock();
      try {
        System.out.println("çº¿ç¨‹"  + Thread.currentThread().getName() + "è·å–é”");
      } finally {
        if (reentrantLock.isLocked()) {
          reentrantLock.unlock();
          //						System.out.println("çº¿ç¨‹" + Thread.currentThread().getName() + "é‡Šæ”¾é”");
        }
      }
    }
  }
};
new Thread(runnable, "t1").start();
new Thread(runnable, "t2").start();
```

å¦‚æœReentrantLockæ„é€ å‡½æ•°ä¼ å…¥çš„æ˜¯trueï¼Œé‚£ä¹ˆä½¿ç”¨çš„æ˜¯å…¬å¹³é”ï¼Œæ‰“å°ç»“æœä¼šå‘ˆç°çº¿ç¨‹1å’Œçº¿ç¨‹2äº¤æ›¿è·å–åˆ°é”çš„æ ·å­ï¼›

### 

2.ReentraLockå®ç°é˜»å¡é˜Ÿåˆ—çš„æ¨¡å¼ï¼š

> https://gitee.com/dendi.ke/thread-demo/blob/master/src/main/java/com/gs/example/producerandconsumer/ProducerAndConsumerDemo2.java





### å¤šçº¿ç¨‹æ­»é”

**æ­»é”çš„åŸå› **

ä¸»è¦æ˜¯å› ä¸ºçº¿ç¨‹é”çš„ç­‰å¾…ï¼šæ¯”å¦‚æœ‰2ä¸ªçº¿ç¨‹ï¼Œéƒ½éœ€è¦è·å–2æŠŠé”æ‰èƒ½æ‰§è¡Œã€‚çº¿ç¨‹1è·å–äº†é”Aï¼Œçº¿ç¨‹2è·å–åˆ°äº†é”Bã€‚é‚£ä¹ˆçº¿ç¨‹1ä¸æ–­çš„åœ¨ç­‰é”Bï¼Œçº¿ç¨‹2ä¸æ–­çš„åœ¨ç­‰é”Aï¼Œå°±ä¼šå¯¼è‡´æ­»é”ã€‚

æ¨¡æ‹Ÿçš„å¤šçº¿ç¨‹æ­»é”Demoï¼š





javaå†…å­˜æ¨¡å‹

volatileå¯è§æ€§

atomicIntegeråŸå­ç±»



çº¿ç¨‹é€šä¿¡





## å¹¶å‘å®¹å™¨

### Map

HashMapæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„

ConcurrentMapã€ConcurrentSkipListMap 



é˜Ÿåˆ—ï¼šConcurrentLinkedQueue



### List

ArrayListæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ­¥addï¼Œä¼šå‡ºç°æ·»åŠ ä¸¢å¤±çš„é—®é¢˜ï¼›

å› ä¸ºArrayListçš„addæ–¹æ³•ä¸æ˜¯åŸå­æ“ä½œ, å¯èƒ½ä¼šå‡ºç°æ•°ç»„è¶Šç•Œæˆ–è€…æ•°æ®é‡å¤æ”¾åœ¨ä¸€ä¸ªä½ç½®ä¸Šé—®é¢˜ï¼›

```java
public boolean add(E e) {
  ensureCapacityInternal(size + 1);
  elementData[size++] = e;
  return true;
}
```

Vectoræ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼›



### é˜»å¡Queue

**LinkedBlockingQueue**

```java
/**
 * éœ€æ±‚ï¼šä½¿ç”¨blockQueueï¼Œæ¨¡æ‹Ÿç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…
 * @author keyang
 */
public class LinkedBlockQueue {
	
	private static LinkedBlockingQueue<String> queue = new LinkedBlockingQueue<>();
	
	public static void main(String[] args) {
		Random random = new Random();
		for (int i = 0; i < 2; i++) {
			new Thread(() -> {
				for (int j = 0; j < 100; j++) {
					try {
						queue.put(j + "");
						Thread.sleep(random.nextInt(1000));
					} catch (InterruptedException e) {
						e.printStackTrace();
					}
				}
			}, "p" + i).start();
		}
		
		for (int i = 0; i < 5; i++) {
			new Thread(() -> {
				while(true) {
					try {
						// å¦‚æœqueueç©ºäº†ï¼Œä¼šè‡ªåŠ¨é˜»å¡ç­‰å¾…
						String str = queue.take();
						System.out.println("æ¶ˆè´¹è€…å–å‡ºäº†" + str);
					} catch (InterruptedException e) {
						e.printStackTrace();
					}
				}
			}, "c" + i).start();
		}
	}
}
```



**ArrayBlockingQueue**

> ArrayBlockingQueueæ˜¯å¯ä»¥è®¾å®šç•Œé™çš„

**æ–¹æ³•åŒºåˆ«**ï¼š

putä¼šåœ¨é˜Ÿåˆ—æ»¡çš„æ—¶å€™ï¼Œé˜»å¡é˜Ÿåˆ—çš„åŠ å…¥ã€‚

addä¼šåœ¨é˜Ÿåˆ—æ»¡çš„æ—¶å€™æŠ›å‡ºå¼‚å¸¸

offerä¼šè¿”å›åˆ°åº•æ˜¯åŠ å…¥æˆåŠŸæˆ–è€…å¤±è´¥ï¼›



**DelayQueue**

åº”ç”¨åœºæ™¯ï¼š å¤„ç†ä¸€äº›å®šæ—¶ä»»åŠ¡ã€‚æ¯”å¦‚ç”µå•†ç³»ç»Ÿä¸­çš„è¶…æ—¶è®¢å•è‡ªåŠ¨å…³é—­ï¼›

ä½¿ç”¨ä»‹ç»ï¼šDelayQueueé˜Ÿåˆ—é‡Œæ·»åŠ çš„iteméœ€è¦å®ç°Delayedæ¥å£ï¼Œå®ç°2ä¸ªæ–¹æ³•ï¼šgetDelayã€compareTo

```java
public class DelayQueueDemo {
	static BlockingQueue<MyTask> queue = new DelayQueue<>();
	private static class MyTask implements Delayed {
		private long time;
		/**
		 * è¿”å›å½“å‰çš„å»¶è¿Ÿæ—¶é—´, longç±»å‹
		 * @param timeUnit
		 * @return
		 */
		@Override
		public long getDelay(TimeUnit timeUnit) {
			return timeUnit.convert(time - System.currentTimeMillis(), TimeUnit.MILLISECONDS);
		}
		/**
		 * æ¯”è¾ƒä¸¤ä¸ªtaskçš„è¶…æ—¶æ—¶é—´
		 * @param delayed
		 * @return
		 */
		@Override
		public int compareTo(Delayed delayed) {
			return (int) (this.getDelay(TimeUnit.MILLISECONDS) - delayed.getDelay(TimeUnit.MILLISECONDS));
		}
		public MyTask(long time) {
			this.time = time;
		}
		@Override
		public String toString() {
			return time + "";
		}
	}
}
```



> é™„ï¼šå…¶ä»–çš„å®šæ—¶ä»»åŠ¡è§£å†³æ–¹æ¡ˆï¼›
>
> 1. ä½¿ç”¨æ•°æ®åº“å®šæ—¶ä»»åŠ¡ï¼Œæ¯éš”å‡ ç§’æ‰«æè®¢å•è¡¨ï¼Œæ‰¾å‡ºè¶…æ—¶è®¢å•åå…³é—­ã€‚
> 2. ä½¿ç”¨springçš„@Scheduledæ³¨è§£å¯åŠ¨å®šæ—¶ä»»åŠ¡æˆ–è€…ä½¿ç”¨Quartzä»»åŠ¡ç®¡ç†å™¨ï¼Œå®šæ—¶è§¦å‘ä»»åŠ¡ï¼Œå¤„ç†è¶…æ—¶è®¢å•ã€‚
> 3. ä½¿ç”¨æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œé€šè¿‡mqæä¾›çš„å»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸‹å•åå¾€å»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—ä¸­å‘æ¶ˆæ¯ï¼Œè¶…æ—¶åï¼Œæ¶ˆè´¹ç«¯ä¼šæ¥æ”¶åˆ°ä¸€æ¡å»¶è¿Ÿçš„è®¢å•æ¶ˆæ¯ï¼Œå¹¶åšç›¸åº”å¤„ç†ã€‚
> 4. æŒ‰éœ€å¤„ç†ã€‚åœ¨ç”¨æˆ·æŸ¥è¯¢çš„æ—¶å€™ï¼Œæ£€æµ‹è®¢å•æ˜¯å¦è¶…æ—¶ï¼Œè‹¥è¶…æ—¶ï¼Œåˆ™å…³é—­è®¢å•



**LinkedTransferQueue**

transferæ–¹æ³•å¿…é¡»ç›´æ¥ä¼ é€’ç»™æ¶ˆè´¹è€…ï¼Œå¦åˆ™æ–¹æ³•ä¼šé˜»å¡ä½ã€‚

takeæ–¹æ³•å¦‚æœæ²¡æœ‰å–å‡ºæ•°æ®ä¹Ÿä¼šè¢«é˜»å¡ã€‚

```java
TransferQueue<String> queue = new LinkedTransferQueue<String>();
		new Thread(() -> {
			try {
				System.out.println(queue.take());
			} catch (InterruptedException e) {
				e.printStackTrace();
			}
		}, "t1").start();
		try {
//			boolean a = queue.tryTransfer("transfer demo", 2, TimeUnit.SECONDS);
			queue.transfer("transfer demo");
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
	}
```



**SynchronousQueue**

> è¿™ä¸ªé˜»å¡é˜Ÿåˆ—çš„å®¹é‡æ˜¯0ï¼›éœ€è¦å…ˆå¯åŠ¨æ¶ˆè´¹è€…ï¼Œ
>
> takeæ–¹æ³•ä¼šé˜»å¡;
>
> putæ–¹æ³•éœ€è¦é©¬ä¸Šè¢«æ‹¿èµ°ï¼Œå¦åˆ™è¿›å…¥é˜»å¡çŠ¶æ€ã€‚åº•å±‚ä¹Ÿæ˜¯ç”¨TransferQueueæ¥å®ç°çš„;

```java
public class SynchronousQueueDemo {
	
	static SynchronousQueue<String> queue = new SynchronousQueue<>();
	
	public static void main(String[] args) {
		new Thread(() -> {
			try {
				System.out.println(queue.take());
			} catch (InterruptedException e) {
				e.printStackTrace();
			}
		}, "t1").start();
		try {
//			queue.put("SynchronousQueue");
			boolean offered = queue.offer("SynchronousQueue", 2, TimeUnit.SECONDS);
			System.out.println(offered);
		} catch (Exception e) {
			e.printStackTrace();
		}
	}
}
```





## çº¿ç¨‹æ± 

### 1.çº¿ç¨‹æ± æ¦‚è¿°

**çº¿ç¨‹æ± ä½œç”¨**ï¼šå¯ä»¥é¿å…çº¿ç¨‹çš„é¢‘ç¹çš„åˆ›å»ºå›æ”¶ï¼Œå‡å°‘ç³»ç»Ÿçš„å¼€é”€ï¼›

**APIä»‹ç»**ï¼šThreadPoolExecutor

**æ ¸å¿ƒå‚æ•°**ï¼š

| å‚æ•°            | æ„ä¹‰                     | è¯´æ˜                                   |
| --------------- | ------------------------ | -------------------------------------- |
| corePoolSize    | æ ¸å¿ƒçº¿ç¨‹æ•°é‡             | é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸»çº¿ç¨‹ä¸€ç›´å­˜åœ¨             |
| maximumPoolSize | æœ€å¤§çº¿ç¨‹æ•°é‡             | å½“çº¿ç¨‹è¾¾åˆ°æœ€å¤§æ•°é‡åï¼Œåç»­ä»»åŠ¡ä¼šè¢«é˜»å¡ |
| keepAliveTime   | çº¿ç¨‹ç©ºé—²æ—¶é—´             | è¶…è¿‡è¿™ä¸ªæ—¶é—´ï¼Œéä¸»çº¿ç¨‹ä¼šè¢«å›æ”¶         |
| unit            | ç©ºé—²æ—¶é—´å•ä½             |                                        |
| workQueue       | ä»»åŠ¡é˜Ÿåˆ—                 | ç”¨æ¥å­˜å‚¨executeä¼ å…¥çš„ä»»åŠ¡              |
| threadFactory   | çº¿ç¨‹å·¥å‚                 | ç”¨æ¥åˆ›å»ºçº¿ç¨‹ä»»åŠ¡ï¼Œå¯ä»¥æŒ‡å®šçº¿ç¨‹å       |
| rejectHandler   | RejectedExecutionHandler | å½“çº¿ç¨‹è¢«æ‹’ç»æ—¶ï¼Œæ”¾å…¥çš„é˜Ÿåˆ—ï¼›           |

```java
/**
 * çº¿ç¨‹æ± ç®¡ç†å™¨
 * @author keyang
 *
 */
public final class ThreadPoolManager {
 
 static ThreadPoolManager threadPoolManager = new ThreadPoolManager();
 
 static final int CORE_POOL_SIZE = 4;
 static final int MAX_POOL_SIZE = 5;
 static final int KEEP_ALIVE_TIME = 5;
 private static final int SIZE_WORK_QUEUE = 1;
 
 
 private ThreadPoolManager() {
 }
 
 public static ThreadPoolManager getInstance() {
  return threadPoolManager;
 }
 
 /**
  * ç”¨æ¥å­˜æ”¾æ’é˜Ÿçš„ä»»åŠ¡
  */
 private Queue<Runnable> mTaskQueue = new LinkedBlockingQueue<>();
 
 private final RejectedExecutionHandler myRejectHandler = new RejectedExecutionHandler() {
  
  @Override
  public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) {
   mTaskQueue.offer(r);
  }
 };
 
 private ScheduledExecutorService scheduledThreadPool = Executors.newScheduledThreadPool(1);
 
 /**
  * å®šæ—¶ä»æ’é˜Ÿä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡
  */
 private ScheduledFuture<?> scheduledFuture = scheduledThreadPool.scheduleAtFixedRate(new Runnable() {
  @Override
  public void run() {
   if (!mTaskQueue.isEmpty()) {
    threadPoolExecutor.execute(mTaskQueue.poll());
   }
  }
 }, 0, 5, TimeUnit.SECONDS);
 
 ThreadFactory namedThreadFactory = new ThreadFactoryBuilder().setNameFormat("Kyçº¿ç¨‹-%d").build();
 
 private final ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor(CORE_POOL_SIZE, MAX_POOL_SIZE, KEEP_ALIVE_TIME, TimeUnit.SECONDS, new ArrayBlockingQueue<Runnable>(SIZE_WORK_QUEUE),
  namedThreadFactory, myRejectHandler);
 
 public void addExecuteTask(Runnable task) {
  if (threadPoolExecutor != null) {
   threadPoolExecutor.execute(task);
  }
 }
 
 protected int getPoolSize() {
  return threadPoolExecutor.getPoolSize();
 }
 
 public void shutdown() {
  mTaskQueue.clear();
  scheduledThreadPool.shutdown();
  threadPoolExecutor.shutdown();
 }
}
```





### 2.åˆ›å»ºçº¿ç¨‹æ± çš„æ–¹å¼

Javaæä¾›äº†4ç§åˆ›å»ºçº¿ç¨‹æ± çš„æ–¹å¼, éƒ½æ˜¯é€šè¿‡Executorsçš„é™æ€æ–¹æ³•ï¼š

#### FixedThreadPool

ç‰¹ç‚¹ï¼šåªæœ‰æ ¸å¿ƒçº¿ç¨‹æ•°é‡ï¼Œçº¿ç¨‹ä¸ä¼šè¢«å›æ”¶ï¼Œçº¿ç¨‹æ•°é‡æ˜¯å›ºå®šçš„ï¼Œä»»åŠ¡é˜Ÿåˆ—æ²¡æœ‰å¤§å°é™åˆ¶

ä½¿ç”¨åœºæ™¯ï¼šæ§åˆ¶çº¿ç¨‹çš„å¹¶å‘é‡



#### ScheduledThreadPool

ç‰¹ç‚¹ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°é‡å›ºå®šï¼Œéæ ¸å¿ƒçº¿ç¨‹æ•°é‡æ— é™åˆ¶

ä½¿ç”¨åœºæ™¯ï¼šæ‰§è¡Œå®šæœŸçš„ä»»åŠ¡

å†…éƒ¨é˜Ÿåˆ—æ˜¯DelayedWorkQueue



#### CachedThreadPool

ç‰¹ç‚¹ï¼šçº¿ç¨‹æ± å†…åªæœ‰éæ ¸å¿ƒçº¿ç¨‹ï¼Œçº¿ç¨‹æœ€å¤§æ•°é‡æ²¡æœ‰é™åˆ¶ï¼Œçº¿ç¨‹è¶…è¿‡ç©ºé—²æ—¶é—´åä¼šå› ä¸ºé—²ç½®è¢«å›æ”¶ã€‚ä»»åŠ¡é˜Ÿåˆ—é‡‡ç”¨çš„æ˜¯SynchronousQueueï¼ŒåŠ å…¥çš„ä»»åŠ¡ä¼šé©¬ä¸Šè¢«æ‰§è¡Œã€‚

ä½¿ç”¨åœºæ™¯ï¼šæ‰§è¡Œå¤§é‡ã€è€—æ—¶å°‘çš„ä»»åŠ¡



#### SingleThreadPool

ç‰¹ç‚¹ï¼šåªæœ‰ä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹ï¼Œä¿è¯çº¿ç¨‹ä»»åŠ¡æŒ‰ç…§é¡ºåºæ‰§è¡Œã€‚ä»»åŠ¡é˜Ÿåˆ—é‡‡ç”¨çš„æ˜¯LinkedBlockingQueueï¼Œåˆåªæœ‰1ä¸ªæ ¸å¿ƒçº¿ç¨‹å¤„ç†ï¼Œæ‰€ä»¥æ— éœ€å¤„ç†çº¿ç¨‹åŒæ­¥é—®é¢˜ï¼›

ä½¿ç”¨åœºæ™¯ï¼šå¤šä¸ªä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œã€‚



è¿™4ç§çº¿ç¨‹æ± åº•å±‚çš„åŸç†éƒ½æ˜¯é€šè¿‡ThreadPoolExecutorç±»æ¥å®ç°çš„ï¼›

å¦å¤–è¿˜æœ‰ä¸€äº›ç‰¹æ®Šçš„çº¿ç¨‹æ± ï¼š

#### ForkJoinPool

ç‰¹ç‚¹ï¼šä»–çš„æ ¸å¿ƒç†å¿µæ˜¯åˆ†è€Œæ²»ä¹‹ï¼Œä»–çš„ä½œç”¨å°±æ˜¯å°†ä¸€ä¸ªå¤§ä»»åŠ¡é€šè¿‡å¤šçº¿ç¨‹æ¥æ‹†åˆ†æˆå¤šå­ä»»åŠ¡ï¼›

ä½¿ç”¨åœºæ™¯ï¼šé€‚åˆåš1ä¸ªå¤§æ•°çš„è®¡ç®—ï¼›

```java
public class ForkJoinPoolDemo {

	static int MAX = 5000;
	
	private static class MyTask extends RecursiveAction {
		private int start;
		private int end;
		public MyTask(int start, int end) {
			this.start = start;
			this.end = end;
		}
		@Override
		protected void compute() {
			if ((end - start) < MAX) {
				System.out.println(Thread.currentThread().getName() + "ä»" + start + "åˆ°" + end + " = " + getSum(start, end));
			} else {
				MyTask task1 = new MyTask(start, (end + start) / 2);
				MyTask task2 = new MyTask((end + start) / 2 + 1, end);
//				task1.fork();
//				task2.fork();
				invokeAll(task1, task2);//æ‰§è¡Œç»™å®šçš„ä»»åŠ¡
				
			}
		}
	}
	
	private static class MyRecursiveTask extends RecursiveTask<Integer> {
		
		private int start;
		private int end;
		public MyRecursiveTask(int start, int end) {
			this.start = start;
			this.end = end;
		}
		@Override
		protected Integer compute() {
			if ((end - start) < MAX) {
				return getSum(start, end);
			} else {
				MyRecursiveTask task1 = new MyRecursiveTask(start, (end + start) / 2);
				MyRecursiveTask task2 = new MyRecursiveTask((end + start) / 2, end);
				task1.fork();
				task2.fork();
				return task1.join() + task2.join();
			}
		}
	}
	
	private static int getSum(int start, int end) {
		int sum = 0;
		for (int i = start; i < end; i++) {
			sum += i;
		}
		return sum;
	}
	public static void main(String[] args) {
		
		System.out.println(getSum(0, 100000));
		
		ForkJoinPool forkJoinPool = new ForkJoinPool();
//		MyTask myTask = new MyTask(0, 100000);
//		forkJoinPool.execute(myTask);
		
		MyRecursiveTask myRecursiveTask = new MyRecursiveTask(0, 100000);
		Future<Integer> future = forkJoinPool.submit(myRecursiveTask);
		try {
			System.out.println("å¤šçº¿ç¨‹æ‰§è¡Œç»“æœï¼š"+future.get());
			System.in.read();
		} catch (IOException | InterruptedException | ExecutionException e) {
			e.printStackTrace();
		}
	}
}
```

**ä½¿ç”¨ä»‹ç»**ï¼šForkJoinPoolå®ä¾‹æœ‰ä¸¤ç§æ–¹æ³•ï¼šsubmitå’Œexecuteï¼Œä¼ å…¥çš„å‚æ•°ç±»å‹éƒ½æ˜¯ForkJoinTaskï¼›

ä½†æ˜¯executeæ–¹æ³•æ— è¿”å›å€¼ï¼Œè€Œsubmitæ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªFutureç±»çš„å®ä¾‹ã€‚

ForkJoinTaskæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒæœ‰2ä¸ªå­ç±»ï¼Œç‰¹ç‚¹ä¹Ÿæ˜¯å’Œsubmitå’Œexecuteæ–¹æ³•å¯¹åº”ã€‚

RecursiveAction çš„computeæ–¹æ³•æ˜¯æ— è¿”å›å€¼çš„

RecursiveTask çš„computeæ–¹æ³•æœ‰è¿”å›å€¼

**é«˜çº§ä½¿ç”¨**ï¼š

ä½¿ç”¨ForkJoinçš„æ€æƒ³æ¥å®ç°ä¸€ä¸ªå¿«é€Ÿæ’åº

https://gitee.com/dendi.ke/thread-demo/blob/master/src/main/java/com/gs/example/threadpool/ForkJoinPoolDemo2.java





### 3.çº¿ç¨‹æ± åŸç†åˆ†æ

**çº¿ç¨‹æ± é€»è¾‘**

![utf-8' '944365-90cfd4951a587ebd](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-14-112114.png)

å…ˆåˆ¤æ–­`çº¿ç¨‹æ•°é‡`æ˜¯å¦è¾¾åˆ°`æ ¸å¿ƒçº¿ç¨‹æ± æ•°é‡`æœ€å¤§é™åˆ¶ï¼›

å†åˆ¤æ–­çº¿ç¨‹çš„`ä»»åŠ¡é˜Ÿåˆ—æ•°é‡`æ˜¯å¦å·²æ»¡

æœ€åå†åˆ¤æ–­`çº¿ç¨‹æ•°é‡`æ˜¯å¦æ»¡è¶³`æœ€å¤§çº¿ç¨‹æ•°é‡`é™åˆ¶





**çº¿ç¨‹æ± å…³é—­åŸç†**ï¼š

a. éå†çº¿ç¨‹æ± ä¸­çš„æ‰€æœ‰å·¥ä½œçº¿ç¨‹
b. é€ä¸ªè°ƒç”¨çº¿ç¨‹çš„interrupt() ä¸­æ–­çº¿ç¨‹ï¼ˆæ³¨ï¼šæ— æ³•å“åº”ä¸­æ–­çš„ä»»åŠ¡å¯èƒ½æ°¸è¿œæ— æ³•ç»ˆæ­¢ï¼‰



**å…³é—­çº¿ç¨‹æ± æ–¹æ³•**ï¼š

- shutdownï¼ˆï¼‰

- shutdownNowï¼ˆï¼‰

**äºŒè€…åŒºåˆ«**ï¼š

- shutdownï¼šè®¾ç½® çº¿ç¨‹æ± çš„çŠ¶æ€ ä¸º SHUTDOWNï¼Œç„¶å**ä¸­æ–­**æ‰€æœ‰æ²¡æœ‰æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹

- shutdownNowï¼šè®¾ç½® çº¿ç¨‹æ± çš„çŠ¶æ€ ä¸º STOPï¼Œç„¶åå°è¯•**åœæ­¢**æ‰€æœ‰çš„æ­£åœ¨æ‰§è¡Œæˆ–æš‚åœä»»åŠ¡çš„çº¿ç¨‹ï¼Œå¹¶è¿”å›ç­‰å¾…æ‰§è¡Œä»»åŠ¡çš„åˆ—è¡¨


**ä½¿ç”¨å»ºè®®**ï¼š

ä¸€èˆ¬è°ƒç”¨shutdownï¼Œæ­£å¸¸çš„å…³é—­çº¿ç¨‹æ± ï¼Œ

è‹¥ä»»åŠ¡ä¸ä¸€å®šè¦æ‰§è¡Œå®Œï¼Œåˆ™è°ƒç”¨shutdownNow()



### 4.çº¿ç¨‹æ± åˆç†æ•°é‡é…ç½®



### 5.ExecutorServiceè§£æ

#### Executoræ¥å£

```java
package java.util.concurrent;

public interface Executor {
  // æ‰§è¡Œä»»åŠ¡
  void execute(Runnable var1);
}
```

é¡¶å±‚æ¥å£ï¼Œå¯ä»¥è°ƒç”¨execute(Runnable r)çš„æ–¹æ³•ã€‚



#### ExecutorServiceæ¥å£



#### Callableæ¥å£

ç±»ä¼¼äºRunnableæ¥å£ï¼ŒåŒºåˆ«æ˜¯Callableé‡Œé¢æ˜¯call() æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªæ³›å‹ã€‚Runnableé‡Œé¢è¯•run()æ–¹æ³•ï¼Œæ²¡æœ‰è¿”å›ã€‚









## çº¿ç¨‹é”

>å‚è€ƒï¼šhttps://zhuanlan.zhihu.com/p/71156910?utm_source=wechat_session&utm_medium=social&utm_oi=722156590005776384

javaé‡Œé¢é”ä¸»è¦çš„ä½œç”¨å°±æ˜¯è§£å†³å¤šçº¿ç¨‹çš„å®‰å…¨æ€§é—®é¢˜ï¼›javaé‡Œæœ‰2ç§åŠ é”çš„æ–¹å¼ï¼š

1.synchronizeå…³é”®å­—ã€‚è¿™ç§æ–¹å¼å†™ä»£ç å¾ˆç®€å•ï¼Œä½†ç›¸å¯¹çš„ï¼Œå®ƒä½¿ç”¨é”çš„çº§åˆ«ä¹Ÿå¾ˆé«˜ï¼›å¦‚æœå¯¹æ€§èƒ½æ²¡æœ‰è¦æ±‚ï¼Œé‚£ä¹ˆä¸€èˆ¬éƒ½ä¼šç”¨synchronizeå…³é”®æ¥åŠ é”

2.Lockå®ç°ç±»ã€‚å¦ä¸€ç§æ–¹å¼å°±æ˜¯ç”¨javaçš„`Lock`ã€‚Lockæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¥¹çš„å®ç°ç±»åœ¨ä»£ç å±‚é¢å®ç°äº†é”çš„åŠŸèƒ½ã€‚å¸¸ç”¨çš„å®ç°ç±»å¦‚ä¸‹ï¼š

ReentrantLockç±»ï¼ŒReadLockç±»ï¼ŒWriteLockç±»ï¼›



![v2-ddb71ab0b68d65ae70244bfdeb0d6704_hd](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-16-133806.jpg)



### Synchronized  å’Œ lockçš„åŒºåˆ«

synchronizeæ˜¯javaçš„å…³é”®å­—ï¼Œå¯ä»¥ç”¨æ¥ä¿®é¥°æ–¹æ³•ã€ä»£ç å—ç­‰ã€‚ä¸»è¦ç›®çš„æ˜¯ä¿è¯æ–¹æ³•æˆ–è€…æ–¹æ³•å—æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

lockæ˜¯javaæä¾›çš„ä¸€ä¸ªæ¥å£ï¼Œä»–æœ‰å¾ˆå¤šå®ç°ç±»ã€å¸¸ç”¨åˆ°çš„æ¯”å¦‚ReentantLockã€ReentraReadWriteLockç­‰ã€‚å®ƒä»¬å¯ä»¥çµæ´»çš„ä½¿ç”¨ï¼Œä¸»è¦ä¹Ÿæ˜¯ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

æ‰‹åŠ¨ä½¿ç”¨lockéœ€è¦æ³¨æ„å‡ ç‚¹ï¼š

1.lockå¿…é¡»æ‰‹åŠ¨é‡Šæ”¾unlockï¼Œè€Œsynchronizeä¼šè‡ªåŠ¨é‡Šæ”¾é”ï¼›

2.lockå¯ä»¥å®ç°å…¬å¹³é”ï¼Œè€Œsynchronizeæ˜¯éå…¬å¹³çš„

3.lockçš„è·å–å¯ä»¥çµæ´»åˆ¤æ–­ï¼Œsynchronizeçš„é”è·å–åªèƒ½ä¸€ç›´ç­‰å¾…ã€‚



### æ‚²è§‚é”&ä¹è§‚é”

é”çš„ä¸€ç§å®è§‚åˆ†ç±»æ–¹å¼ã€‚æ˜¯æŒ‡åœ¨å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œä¸¤ç§ç­–ç•¥ï¼›

**æ‚²è§‚é”**ï¼šå½“å¤šä¸ªçº¿ç¨‹æœ‰ç«äº‰å…³ç³»æ—¶ï¼Œæˆ‘ä»¬æ€»æ˜¯è®¤ä¸ºæŸä¸ªå…±äº«æ•°æ®ä¼šè¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼ˆ**å¾ˆæ‚²è§‚**ï¼‰ï¼›æ‰€ä»¥éœ€è¦ç”¨åˆ°å…±äº«æ•°æ®çš„çº¿ç¨‹å°±å»æŠŠæ•°æ®åŠ ä¸€æŠŠé”ï¼Œè¿™æ ·åˆ«çš„çº¿ç¨‹å°±åªèƒ½ç­‰å¾…å½“å‰çº¿ç¨‹é‡Šæ”¾é”åæ‰èƒ½ä½¿ç”¨ï¼›

**ä¹è§‚é”**ï¼šå½“çº¿ç¨‹ä¿®æ”¹æŸä¸€ä¸ªæ•°æ®æ—¶ï¼Œæ€»è®¤ä¸ºå½“å‰æ•°æ®ä¸ä¼šè¢«åˆ«çš„çº¿ç¨‹ä¿®æ”¹ï¼Œæ‰€ä»¥ä¸ä¼šå»åŠ é”ï¼ˆ**å¾ˆä¹è§‚**ï¼‰ã€‚å¦‚æœçº¿ç¨‹éœ€è¦æ›´æ–°æ•°æ®ï¼Œä¼šå»æ£€æŸ¥ä»æ•°æ®è¯»å–åˆ°æ›´æ–°è¿™æ®µæ—¶é—´ç±»ï¼Œæ•°æ®æœ‰æ²¡æœ‰å‘ç”Ÿä¿®æ”¹ã€‚å¦‚æœè¿™æœŸé—´æ•°æ®æ²¡æœ‰å˜åŒ–ï¼Œé‚£ä¹ˆå°±æ‰§è¡Œæ›´æ–°æ“ä½œï¼›å¦åˆ™å›æ»šæ“ä½œï¼Œé‡æ–°è¯»å–æ›´æ–°ä¸€éï¼Œå¹¶é‡å¤ä¸Šæ¬¡æ£€æŸ¥ï¼›

**ä½¿ç”¨åœºæ™¯æ¯”è¾ƒ**ï¼š

ä¹è§‚é”ä¸€èˆ¬é€‚ç”¨äº**å†™æ¯”è¾ƒå°‘**çš„æƒ…å†µä¸‹ï¼Œè¿™æ ·çº¿ç¨‹å†²çªçœŸçš„å¾ˆå°‘å‘ç”Ÿï¼Œå¯ä»¥çœå»åŠ é”çš„å¼€é”€ï¼›

æ‚²è§‚é”åˆ™æ¯”è¾ƒé€‚åˆå†²çªè¾ƒå¤šçš„æƒ…å†µï¼›



### CASæ— é”æœºåˆ¶

ä¹è§‚é”çš„åº•å±‚æœºåˆ¶å°±æ˜¯CASæœºåˆ¶ï¼š**Compare and Set**

1. é¦–å…ˆæ¯”è¾ƒå€¼ã€‚æ¯”å¦‚è¯»å–åˆ°ä¸€ä¸ªå€¼ä¸ºAï¼Œå¦‚æœåœ¨å°†Aæ›´æ–°ä¸ºBçš„è¿‡ç¨‹ä¸­ï¼Œæ£€æŸ¥Aæ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ã€‚
2. å¦‚æœç›¸åŒï¼Œé‚£ä¹ˆæ‰§è¡Œsetæ“ä½œï¼Œå°†å€¼æ›´æ–°ä¸ºBï¼›å¦åˆ™ä¸æ‰§è¡Œæ“ä½œï¼Œé‡æ–°è¯»å–å€¼ï¼›

ä¸Šé¢ä¸¤æ­¥æ˜¯åŸå­æ€§çš„ï¼Œåœ¨CPUçœ‹æ¥æ˜¯ä¸€æ­¥æ“ä½œï¼›

ä¹è§‚é”çš„æœºåˆ¶å°±æ˜¯CASçš„é‡è¯•ç®—æ³•ï¼Œæ•´ä¸ªè¿‡ç¨‹æ²¡æœ‰â€œåŠ é”â€å’Œâ€œè§£é”â€æ“ä½œï¼Œæ‰€ä»¥ä¹è§‚é”ç­–ç•¥ä¹Ÿè¢«ç§°ä¸º**æ— é”ç¼–ç¨‹**ã€‚

```java
// ä¼ªä»£ç 
	public volatile int value;

    public int getValue() {
        return value;
    }

    public final int getAndIncrement() {
        for(;;) {
            int current = getValue();
            int next = current + 1;
            // CASæ“ä½œ
            if (compareAndSet(current, next)) {
                return current;
            }
        }
    }

    public final int getAndDecrement() {
        for (;;) {
            int current = getValue();
            int next = current - 1;
            if (compareAndSet(current, next)) {
                return current;
            }
        }
    }
```



### è‡ªæ—‹é”

å½“çº¿ç¨‹å ç”¨æŸä¸€ä¸ªé”æ—¶ï¼Œå…¶ä»–çš„çº¿ç¨‹ä¼šä¸€ç›´ä¸æ–­çš„å¾ªç¯è·å–é”ï¼›æ€ä¹ˆç†è§£è¿™ä¸ªæ¦‚å¿µï¼Ÿéœ€è¦å…ˆäº†è§£ä¸€ä¸‹javaçš„synchronizeé”å‡çº§æœºåˆ¶ï¼š

#### synchronizedé”å‡çº§ï¼šåå‘é” â†’ è½»é‡çº§é” â†’ é‡é‡çº§é”

åˆæ¬¡æ‰§è¡Œåˆ°synchronizeä»£ç å—æ—¶ï¼Œä½¿ç”¨çš„æ˜¯åå‘é”ã€‚

å½“å…¶ä»–çº¿ç¨‹ä¹Ÿè¿›å…¥åˆ°synchronizeä»£ç å—æ—¶ï¼Œå¦‚æœè·å–ä¸åˆ°é”ï¼Œå°±ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚é”ä¼šå‡çº§ä¸ºè½»é‡çº§é”ï¼Œä¹Ÿå°±æ˜¯`è‡ªæ—‹é”`

è‡ªæ—‹é”ä¹Ÿæœ‰é™åˆ¶ï¼Œå› ä¸ºçº¿ç¨‹ä¸æ–­çš„ç©ºå¾ªç¯ä¹Ÿä¼šæ¶ˆè€—æ€§èƒ½ã€‚æ‰€ä»¥å½“çº¿ç¨‹å¾ªç¯çš„æ¬¡æ•°è¶…è¿‡ä¸€å®šæ¬¡æ•°ï¼Œçº¿ç¨‹ä¼šè¿›å…¥æŒ‚èµ·çŠ¶æ€ç­‰å¾…è¢«å”¤é†’ï¼Œè‡ªæ—‹é”ä¼šå‡çº§ä¸ºé‡é‡çº§é”ã€‚åé¢çš„çº¿ç¨‹å½“å‘ç°é”çº§åˆ«æ˜¯é‡é‡çº§é”æ—¶ï¼Œç›´æ¥æŒ‚èµ·ã€‚



### å¯é‡å…¥é”

> å¯ä»¥é‡å¤è·å–çš„é”ï¼›

synchronizeæ˜¯å¯é‡å…¥é”ã€‚å½“1ä¸ªçº¿ç¨‹æ‰§è¡ŒæŸä¸€ä¸ªsynchronizeä»£ç å—æ—¶ï¼Œå®ƒä¼šå…ˆè·å–åˆ°å¯¹è±¡çš„é”ã€‚å¦‚æœåœ¨è¿™ä¸ªä»£ç å—ä¸­è¿˜è°ƒç”¨äº†å¦ä¸€ä¸ªsynchronizeçš„æ–¹æ³•ï¼Œè¯¥çº¿ç¨‹å°±éœ€è¦å†æ¬¡ç”³è¯·è¿™ä¸ªå¯¹è±¡çš„é”ã€‚javaé‡Œæ˜¯å…è®¸è¿ç»­ä¸¤æ¬¡ç”³è¯·synchronizeé”ï¼Œé‡Šæ”¾é”æ—¶ä¹Ÿæ˜¯ä¾æ¬¡é‡Šæ”¾ï¼›

Javaè¿˜æä¾›äº†ä¸€ä¸ªReerantLockçš„å®ç°ç±»ï¼š`java.util.concurrent.locks.ReentrantLock`



### å¯ä¸­æ–­é”



### è¯»å†™é”

è¯»å†™é”æ˜¯ä¸€å¯¹å„¿é”ã€‚ä¸€ä¸ª`è¯»é”`å’Œä¸€ä¸ª`å†™é”`

**è¯»é”**ï¼šå…±äº«é”ï¼›

**å†™é”**ï¼šäº’æ–¥é”ï¼›

çº¿ç¨‹è¯»å–æ•°æ®æ—¶å€™ï¼ŒçŸ¥é“è‡ªå·±æ˜¯éœ€è¦åš==æ›´æ–°æ“ä½œ==è¿˜æ˜¯åš==åªè¯»æ“ä½œ==ã€‚å½“éœ€è¦æ›´æ–°æ—¶ï¼ŒåŠ å†™é”ï¼Œè¿™æ ·åˆ«çš„çº¿ç¨‹**æ— è®ºæ˜¯è¯»å–è¿˜æ˜¯å†™å…¥éƒ½ä¼šé˜»å¡**ã€‚å½“éœ€è¦è¯»å–æ—¶ï¼ŒåŠ è¯»é”ï¼Œå…¶ä»–çº¿ç¨‹å¦‚æœä¹Ÿè¦åŠ è¯»é”ï¼Œä¸éœ€è¦ç­‰å¾…ï¼Œå¯ä»¥ç›´æ¥è·å–ï¼Œä½†æ˜¯**è¯»é”è®¡æ•°å™¨è¦+1**ã€‚





## å¤šçº¿ç¨‹è®¾è®¡æ¨¡å¼

### çº¿ç¨‹å®‰å…¨çš„Singleton

```java
/**
 * çº¿ç¨‹å®‰å…¨çš„å•ä¾‹æ¨¡å¼
 * @author keyang
 */
public class SingletonDemo {
	
	private static SingletonDemo singletonDemo = null;
	
	private SingletonDemo() {
	
	}
	
	public static SingletonDemo getInstance() {
		
		if (singletonDemo == null) {
			synchronized (SingletonDemo.class) {
//			singletonDemo = new SingletonDemo();
				try {
					Thread.sleep(10000);
				} catch (InterruptedException e) {
					e.printStackTrace();
				}
			}
		}
		return singletonDemo;
	}
	
	public static void main(String[] args) {
		for (int i = 0; i < 1000; i++) {
			new Thread(() -> {
				SingletonDemo singletonDemo = SingletonDemo.getInstance();
				System.out.println(singletonDemo.hashCode());
			}).start();
		}
	}
}
```





# æ³¨è§£

1.æ³¨è§£æ¦‚è¿°

2.è‡ªå®šä¹‰æ³¨è§£

3.ä½¿ç”¨æ³¨è§£å®ç°ORMæ¡†æ¶(å¯¹è±¡å…³ç³»æ˜ å°„)

è®¾è®¡æ¨¡å¼

é¥¿æ±‰å¼å†™æ³•

å·¥å‚æ¨¡å¼

ä»£ç†æ¨¡å¼

é™æ€ä»£ç†

JDKåŠ¨æ€ä»£ç†

CGLIBåŠ¨æ€ä»£ç†



# ç½‘ç»œé€šä¿¡

1.ç½‘ç»œé€šä¿¡æ¦‚è¿°

2.TCPä¸UDPåŒºåˆ«

3.UDPå‘é€æ¶ˆæ¯

4.TCPä¸‰æ¬¡æ¡æ‰‹

5.TCPåè®®å‘é€å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯

6.ä½¿ç”¨å¤šçº¿ç¨‹æ”¯æŒå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®



â€‹	

IOä¸NIOçš„åŒºåˆ«

Bufferçš„æ•°æ®å­˜å‚¨

makeä¸restç”¨æ³•

ç›´æ¥ç¼“å†²åŒºä¸éç¼“å†²åŒºåŒºåˆ«

åˆ†æ•£è¯»å–èšé›†å†™å…¥

ç¼–ç æ ¼å¼



é˜»å¡IOä¸éé˜»å¡IOçš„åŒºåˆ«

NIOå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯



# Nettyæ¡†æ¶ (æ¸¸æˆæœåŠ¡å™¨)

NetttyæœåŠ¡ç«¯

Nettyå®¢æˆ·ç«¯



é•¿è¿æ¥ä¸çŸ­è¿æ¥åŒºåˆ«

ç²˜åŒ…ä¸æ‹†åŒ…

åºåˆ—åŒ–



## å†…å­˜

å†…å­˜ç»“æ„â€”â€”java

å †æº¢å‡º

æ ˆæº¢å‡º

å†…å­˜æº¢å‡ºä¸å†…å­˜æ³„éœ²çš„åŒºåˆ«



## HTTP



## æ•°æ®åº“

mysqlæ¦‚è¿°

mysqlä¼˜åŒ–æ–¹æ¡ˆ

æ•°æ®åº“ä¸‰å¤§èŒƒå¼

åˆ†åº“åˆ†è¡¨

æ°´å¹³åˆ†å‰²å–æ¨¡ç®—æ³•

ç´¢å¼•æ¦‚è¿°

ç´¢å¼•åº•å±‚å®ç°åŸç†

æ™®é€šç´¢å¼•&å”¯ä¸€ç´¢å¼•åŒºåˆ«

sqlè¯­å¥ä¼˜åŒ–

mysqlé«˜å¯ç”¨

mysqlä¸»ä»å¤åˆ¶åŸç†

mysqlè¯»å†™åˆ†ç¦»æ¦‚è¿°

mycatè¯»å†™åˆ†ç¦»



## äº‹ç‰©

äº‹ç‰©æ¦‚è¿°

äº‹ç‰©åº•å±‚åŸç†

äº‹ç‰©ä¼ æ’­è¡Œä¸º

åˆ†å¸ƒå¼äº‹ç‰©



# Redis

### Redis5ç§åŸºæœ¬ç±»å‹

> String, Hash, List, Set,  ZSet

#### String

é‡è¦ç”¨æ³•1ï¼š**`Expire Key`**

> **åº”ç”¨åœºæ™¯**

1ã€é™æ—¶çš„ä¼˜æƒ æ´»åŠ¨ä¿¡æ¯

2ã€ç½‘ç«™æ•°æ®ç¼“å­˜ï¼ˆå¯¹äºä¸€äº›éœ€è¦å®šæ—¶æ›´æ–°çš„æ•°æ®ï¼Œä¾‹å¦‚ï¼šç§¯åˆ†æ’è¡Œæ¦œï¼‰

3ã€æ‰‹æœºéªŒè¯ç 

4ã€é™åˆ¶ç½‘ç«™è®¿å®¢è®¿é—®é¢‘ç‡ï¼ˆä¾‹å¦‚ï¼š1åˆ†é’Ÿæœ€å¤šè®¿é—®10æ¬¡ï¼‰  



é‡è¦ç”¨æ³•2ï¼š**`SETNX key value` **

> **åº”ç”¨åœºæ™¯**

1ã€åˆ†å¸ƒå¼é”



é‡è¦ç”¨æ³•3ï¼š**`INCR KEY_Name`**

> **åº”ç”¨åœºæ™¯**

1.è®¡æ•°å™¨

å‡å¦‚ï¼Œåœ¨æŸç§åœºæ™¯ä¸‹æœ‰3ä¸ªå®¢æˆ·ç«¯åŒæ—¶è¯»å–äº†mynumçš„å€¼ï¼ˆå€¼ä¸º2ï¼‰ï¼Œç„¶åå¯¹å…¶åŒæ—¶è¿›è¡Œäº†åŠ 1çš„æ“ä½œï¼Œé‚£ä¹ˆï¼Œæœ€åmynumçš„å€¼ä¸€å®šæ˜¯5ã€‚



**Keyçš„å‘½åå»ºè®®**

> rediså•ä¸ªkey å­˜å…¥512Må¤§å°

1.keyä¸è¦å¤ªé•¿ï¼Œå°½é‡ä¸è¦è¶…è¿‡1024å­—èŠ‚ï¼Œè¿™ä¸ä»…æ¶ˆè€—å†…å­˜ï¼Œè€Œä¸”ä¼šé™ä½æŸ¥æ‰¾çš„æ•ˆç‡ï¼›

 2.keyä¹Ÿä¸è¦å¤ªçŸ­ï¼Œå¤ªçŸ­çš„è¯ï¼Œkeyçš„å¯è¯»æ€§ä¼šé™ä½ï¼› 

3.åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œkeyæœ€å¥½ä½¿ç”¨ç»Ÿä¸€çš„å‘½åæ¨¡å¼ï¼Œä¾‹å¦‚user:123:password; 

4.keyåç§°åŒºåˆ†å¤§å°å†™



#### Hash

> åº”ç”¨åœºæ™¯

1ã€å­˜å‚¨ä¸€ä¸ªå¯¹è±¡

hashå­˜å‚¨å¯¹è±¡å’Œstringå­˜å‚¨çš„åŒºåˆ«

- stirngå­˜å‚¨ä¸»è¦æœ‰2ç§æ–¹æ¡ˆï¼šä¸€ç§æ˜¯ç”¨å¯¹è±¡çš„idä½œä¸ºkeyï¼Œç”¨å¯¹è±¡çš„jsonåºåˆ—åŒ–ä½œä¸ºvalueã€‚è¿˜æœ‰ä¸€ç§æ˜¯ç”¨å¯¹è±¡çš„id+å±æ€§åä½œä¸ºkeyï¼Œç”¨å¯¹è±¡å±æ€§å€¼ä½œä¸ºvalueã€‚

  ç¬¬ä¸€ç§çš„ç¼ºç‚¹æ˜¯æ¯æ¬¡ä¿®æ”¹å±æ€§ä¸æ–¹ä¾¿ï¼Œå¿…é¡»å°†å¯¹è±¡ååºåˆ—åŒ–å‡ºæ¥å†æ’å…¥è¿›å»ã€‚è€Œä¸”éœ€è¦è€ƒè™‘å¹¶å‘é—®é¢˜ï¼›

  ç¬¬äºŒç§ç¡®å®šæ˜¯keyå¤ªå¤šï¼Œé€ æˆå­˜å‚¨ç©ºé—´è¿‡å¤§ï¼›

- Redisæä¾›çš„Hashå¾ˆå¥½çš„è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼ŒRedisçš„Hashå®é™…æ˜¯å†…éƒ¨å­˜å‚¨çš„Valueä¸ºä¸€ä¸ªHashMapï¼Œå¹¶æä¾›äº†ç›´æ¥å­˜å–è¿™ä¸ªMapæˆå‘˜çš„æ¥å£



#### List

> åº”ç”¨åœºæ™¯

1ã€å®ç°é˜Ÿåˆ— lpush rpop 

2ã€å®ç°å †æ ˆ lpush lpop

3ã€å®ç°åˆ†é¡µ lrange start stop

â€‹		å¤§æ•°æ®é‡çš„åˆ†é¡µ

4ã€å¯¹å¤§æ•°æ®è¿›è¡Œåˆ å‡ã€æ˜¾ç¤º

â€‹		å¦‚ï¼šå…³æ³¨åˆ—è¡¨ã€ç²‰ä¸åˆ—è¡¨ã€ç•™è¨€è¯„ä»·ç­‰;

5ã€ä»»åŠ¡é˜Ÿåˆ—



#### Set

> åº”ç”¨åœºæ™¯

1ã€å¸¸ç”¨äºå¯¹ä¸¤ä¸ªé›†åˆé—´çš„æ•°æ®åšäº¤é›†ã€å¹¶é›†ã€å·®é›†è¿ç®—ï¼š

â€‹	æ¯”å¦‚å¾®ä¿¡æŸ¥çœ‹2ä¸ªäººçš„å…±åŒå¥½å‹ï¼›

â€‹	æ¯”å¦‚å¾®åšæŸ¥çœ‹å…±åŒå…³æ³¨çš„äººï¼›

â€‹	å†é«˜çº§ä¸€ç‚¹ï¼Œæ¨èä½ å…³æ³¨çš„äººå…³æ³¨äº†è°ï¼›	

2ã€åˆ©ç”¨å”¯ä¸€æ€§ï¼Œç»Ÿè®¡ç½‘ç«™çš„è®¿é—®IPï¼›



#### ZSet

> åº”ç”¨åœºæ™¯

1ã€æ’è¡Œæ¦œï¼Œå¦‚æŸ¥çœ‹æ’åå‰10çš„äººï¼Œæˆ–è€…æŸ¥çœ‹æ‰€æœ‰äººçš„æ’åï¼Œæˆ–è€…æŸ¥çœ‹æŸä¸€ä¸ªåˆ†æ•°æ®µçš„äººï¼›

```java
System.out.println("       å…¨éƒ¨ç©å®¶æ’è¡Œæ¦œ                    ");
		Set<ZSetOperations.TypedTuple<String>> allPlayerList = redisTemplate.opsForZSet().reverseRangeWithScores(key, 0, -1);
		Iterator<ZSetOperations.TypedTuple<String>> iterator = allPlayerList.iterator();
		while(iterator.hasNext()) {
			ZSetOperations.TypedTuple<String> item = iterator.next();
			System.out.println("ç©å®¶IDï¼š"+item.getValue()+"ï¼Œ ç©å®¶å¾—åˆ†:"+Double.valueOf(item.getScore()).intValue());
		}

// reverseRangeWithScores
// reverseRangeByScoreWithScores
```



### Rediså®ç°åˆ†å¸ƒå¼é”

æ–¹æ¡ˆ1ï¼š

```java
String lockKey = "product_100_stock";
String stockStr = stringRedisTemplate.opsForValue().get("stock");
// å®ç°å…³é”®æ˜¯ç”¨åˆ°äº†setnxè¿™ä¸ªå‘½ä»¤
boolean result = stringRedisTemplate.opsForValue().setIfAbsent(lockKey, "20");
if (!result) {
  return "locked";
}
int stock = Integer.parseInt(stockStr);
if (stock > 0) {
  stock--;
  stringRedisTemplate.opsForValue().set("stock", String.valueOf(stock));
} else {
  return "error";
}
stringRedisTemplate.delete(lockKey);
return "success";
```

1.å¦‚æœç¨‹åºè¿è¡Œä¸­æ­»æœºäº†æ€ä¹ˆå¤„ç†ï¼Ÿ

- åœ¨ä»£ç å—ä¸­åŠ try finallyï¼Œåˆ é™¤é”
- å¢åŠ é”çš„è¶…æ—¶æ—¶é—´ï¼›

2.è¶…æ—¶æ—¶é—´æ€ä¹ˆå»å®šæ¯”è¾ƒåˆç†ï¼Ÿä¸ä¼šæå‰æ¸…é™¤é”ï¼Œä»è€Œé€ æˆ`åˆ†å¸ƒå¼é”`é‡Šæ”¾é”™è¯¯ã€‚

- è€ƒè™‘åœ¨ä¸»çº¿ç¨‹é‡Œï¼Œå¼€å¯ä¸€ä¸ªå­çº¿ç¨‹ï¼Œå»ä¸æ–­çš„å®šæ—¶è½®è¯¢å»¶è¿Ÿé”çš„æ—¶é—´ã€‚ä¸»çº¿ç¨‹ç»“æŸåï¼Œç»“æŸå­çº¿ç¨‹ï¼›

3.å¦‚ä½•é¿å…è¯¯åˆ é”ï¼Ÿ

â€‹	line4:åœ¨è®¾ç½®é”çš„valueçš„æ—¶å€™ï¼Œè®¾ç½®ä¸€ä¸ªéšæœºå€¼ï¼›åˆ é™¤é”æ—¶ï¼Œå…ˆæ¯”è¾ƒå€¼ï¼Œå†å»åˆ é™¤é”ï¼› 



æ–¹æ¡ˆ2ï¼šredission

```
RLock rLock = redisson.getLock(lockKey);
```

1.å¦‚æœæ˜¯master-slaveræ¨¡å¼çš„redisæ¶æ„ï¼Œä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Ÿ

- redissionå†™æ˜¯ç”¨masterï¼Œè¯»æ˜¯ç”¨slaverã€‚å¦‚æœå†™çš„æ—¶å€™ï¼ŒmasteræŒ‚æ‰ï¼Œè¯»å–çš„slaverä¾ç„¶å¯ä»¥ç”¨ï¼Œä¼šå¯¼è‡´é”ä¸€ç›´æ— æ³•é‡Šæ”¾ï¼Œä»è€Œå¯¼è‡´æ­»é”ã€‚ 

2.redisåˆ†å¸ƒå¼é”æ€ä¹ˆæ”¯æŒé«˜å¹¶å‘ï¼Ÿ

Redlockç®—æ³•ï¼š

å‡è®¾æœ‰Nä¸ªç›¸åŒçš„redisèŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„redisæ¨¡å¼ä¸€æ ·ï¼Œä½†æ˜¯äº’ä¸å…³è”ã€‚

1.è®°å½•æ—¶é—´æˆ³ï¼›

2.ä¸ºæ¯ä¸ªredisèŠ‚ç‚¹è®¾ç½®çš„è¶…æ—¶æ—¶é—´ï¼Œä»¥åŠé”è¿‡æœŸæ—¶é—´ã€‚ é¿å…æœåŠ¡å™¨æŒ‚æ‰åï¼Œå®¢æˆ·ç«¯ä»ç„¶å»ç­‰å¾…æœåŠ¡å™¨å“åº”ï¼›(æ¯”å¦‚5ms)

3.å½“è®¾ç½®é”æ—¶ï¼Œå‘æ¯ä¸ªredisèŠ‚ç‚¹ä¸Šéƒ½è®¾ç½®ä¸€æ¬¡ï¼›

4.è®°å½•æˆåŠŸçš„èŠ‚ç‚¹æ•°ï¼Œä»¥åŠç´¯è®¡çš„ç”¨æ—¶æ—¶é—´ï¼›

5.å¦‚æœç´¯è®¡æ—¶é—´ä¸è¶…è¿‡é”è¿‡æœŸæ—¶é—´ï¼Œå¹¶ä¸”æˆåŠŸèŠ‚ç‚¹æ•°å¤§äºæ€»ç»“ç‚¹æ•°çš„ä¸€åŠæ•°é‡ï¼›

6.å¦‚æœç´¯è®¡æ—¶é—´è¶…è¿‡äº†é”çš„è¿‡æœŸæ—¶é—´ï¼Œé‚£ä¹ˆé”å¯èƒ½å·²ç»å¤±æ•ˆäº†ã€‚æˆ–è€…è·å–äº†å°äº3ä¸ªé”ï¼Œå¿…é¡»é‡Šæ”¾ï¼Œå¦åˆ™å½±å“å…¶ä»–clientè·å–é”ã€‚



```mermaid
graph TD
A(è®°å½•å¼€å§‹æ—¶é—´)-->B(ä¾æ¬¡è®¾ç½®redisèŠ‚ç‚¹é”Næ¬¡)
B-->C(è®°å½•è®¾ç½®æ—¶é—´)
B-->D(è®°å½•æˆåŠŸè®¾ç½®redisé”çš„èŠ‚ç‚¹æ•° R)
D-->E{R > N/2+1?}
C-->F{é”æœ‰æ•ˆæœŸ > è®¾ç½®æ—¶é—´}
F-->|æ˜¯|H
F-->|å¦|G
E-->|æ˜¯|H(è·å–é”æˆåŠŸ)
E-->|å¦|G(è·å–é”å¤±è´¥ )

```





### Redisäº‹ç‰©

#### ä¸¤ç±»é”™è¯¯

- è¯­æ³•é”™è¯¯

  å›æ»šæ“ä½œâ€”â€”discard

- æ‰§è¡Œé”™è¯¯

  è·³è¿‡é”™è¯¯ç»§ç»­æ‰§è¡Œ

  

redisTemplateæ‰§è¡Œ

```java
SessionCallback sessionCallback = new SessionCallback() {
  @Override
  public Object execute(RedisOperations redisOperations) throws DataAccessException {
    redisOperations.multi();
    redisTemplate.opsForValue().set(key, "1");
    redisTemplate.opsForValue().decrement(key);
    redisTemplate.opsForValue().set(key, "2");
    redisTemplate.opsForValue().set(key, "6");
    return redisOperations.exec();
  }
};
redisTemplate.execute(sessionCallback);
```





### Redisç¼“å­˜ä¸€è‡´æ€§

1.å¼ºä¸€è‡´æ€§â€”â€”å®æ—¶åŒæ­¥

æŸ¥è¯¢ç¼“å­˜ï¼Œç¼“å­˜ä¸å­˜åœ¨æŸ¥è¯¢DBï¼Œä¿å­˜åˆ°ç¼“å­˜ã€‚

æ›´æ–°ç¼“å­˜æ—¶ï¼Œå…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†å°†ç¼“å­˜çš„æ•°æ®è®¾ç½®ä¸ºè¿‡æœŸï¼›

æ³¨æ„ç‚¹ï¼š

**ç¼“å­˜ç©¿é€**

> æ¯æ¬¡æŸ¥è¯¢çš„æ—¶å€™ï¼Œæ•°æ®åº“éƒ½è¿”å›ç©ºï¼Œæ¯æ¬¡éƒ½æ²¡ç¼“å­˜æ•°æ®ï¼Œç»“æœæ¯æ¬¡éƒ½ä»æ•°æ®åº“ä¸­æŸ¥è¯¢

è§£å†³æ–¹æ¡ˆ
ä»ç¼“å­˜å–ä¸åˆ°çš„æ•°æ®ï¼Œåœ¨æ•°æ®åº“ä¸­ä¹Ÿæ²¡æœ‰å–åˆ°ï¼Œè¿™æ—¶ä¹Ÿå¯ä»¥å°†key-valueå¯¹å†™ä¸ºkey-nullï¼Œç¼“å­˜æœ‰æ•ˆæ—¶é—´å¯ä»¥è®¾ç½®çŸ­ç‚¹ï¼Œå¦‚30ç§’ï¼ˆè®¾ç½®å¤ªé•¿ä¼šå¯¼è‡´æ­£å¸¸æƒ…å†µä¹Ÿæ²¡æ³•ä½¿ç”¨ï¼‰ã€‚è¿™æ ·å¯ä»¥é˜²æ­¢æ”»å‡»ç”¨æˆ·åå¤ç”¨åŒä¸€ä¸ªidæš´åŠ›æ”»å‡»

**ç¼“å­˜å‡»ç©¿**

> æŸä¸€ä¸ªçƒ­ç‚¹Keyï¼Œåœ¨æŸä¸€ä¸ªæ—¶é—´é‡Œï¼Œç¼“å­˜å¤±æ•ˆäº†ã€‚è¿™æ—¶ç”±äºå¹¶å‘ç”¨æˆ·ç‰¹åˆ«å¤šï¼ŒåŒæ—¶è¯»ç¼“å­˜æ²¡è¯»åˆ°æ•°æ®ï¼ŒåˆåŒæ—¶å»æ•°æ®åº“å»å–æ•°æ®ï¼Œå¼•èµ·æ•°æ®åº“å‹åŠ›ç¬é—´å¢å¤§ï¼Œé€ æˆè¿‡å¤§å‹åŠ›

è§£å†³æ–¹æ¡ˆ

1. è®¾ç½®çƒ­ç‚¹æ•°æ®æ°¸è¿œä¸è¿‡æœŸï¼›
2. åŠ äº’æ–¥é”ï¼Œåªæœ‰1ä¸ªå»æ•°æ®åº“æŸ¥è¯¢ï¼›

**ç¼“å­˜é›ªå´©**

> ç¼“å­˜ä¸­æ•°æ®å¤§æ‰¹é‡åˆ°è¿‡æœŸæ—¶é—´ï¼Œè€ŒæŸ¥è¯¢æ•°æ®é‡å·¨å¤§ï¼Œå¼•èµ·æ•°æ®åº“å‹åŠ›è¿‡å¤§ç”šè‡³downæœºã€‚å’Œç¼“å­˜å‡»ç©¿ä¸åŒçš„æ˜¯ï¼Œç¼“å­˜å‡»ç©¿æŒ‡å¹¶å‘æŸ¥åŒä¸€æ¡æ•°æ®ï¼Œç¼“å­˜é›ªå´©æ˜¯ä¸åŒæ•°æ®éƒ½è¿‡æœŸäº†ï¼Œå¾ˆå¤šæ•°æ®éƒ½æŸ¥ä¸åˆ°ä»è€ŒæŸ¥æ•°æ®åº“ã€‚

è§£å†³æ–¹æ¡ˆï¼š

1.è®¾ç½®ä¸åŒçš„è¿‡æœŸæ—¶é—´ï¼›

2.çƒ­ç‚¹è®¾ç½®ä¸è¿‡æœŸ



### Redisä¸»ä»å¤åˆ¶

masterä¸»èŠ‚ç‚¹ç”¨æ¥å†™å…¥æ•°æ®ï¼Œslaverå­èŠ‚ç‚¹ç”¨æ¥è¯»å–æ•°æ®ï¼Œ`ä¸»èŠ‚ç‚¹`å®šæœŸæŠŠæ•°æ®åŒæ­¥åˆ°`ä»èŠ‚ç‚¹`æ¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚

#### ä¸»ä»å¤åˆ¶æ¶æ„

**a)  ä¸€ä¸»ä¸€ä»**ï¼šå½“`ä¸»èŠ‚ç‚¹`çš„â€œå†™â€å‘½ä»¤å¹¶å‘é«˜ä¸”éœ€è¦æŒä¹…åŒ–æ—¶ï¼Œå¯ä»¥åªåœ¨`ä»èŠ‚ç‚¹`å¼€å¯AOFï¼ˆä¸»èŠ‚ç‚¹ä¸éœ€è¦ï¼‰ã€‚

 <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-031252.png" width="150" align="center"/>



**b) ä¸€ä¸»å¤šä»**ï¼šå½“å¯¹"è¯»"çš„è¦æ±‚æ¯”è¾ƒå¤§æ—¶ï¼Œè¿™ç§ç»“æ„æ¯”è¾ƒåˆé€‚ã€‚ä¸»èŠ‚ç‚¹åªè´Ÿè´£å†™å…¥ï¼Œç„¶ååŒæ­¥åˆ°ä»èŠ‚ç‚¹ã€‚ä½†æ˜¯å¯¹ä¸»èŠ‚ç‚¹çš„å½±å“æ¯”è¾ƒå¤§ï¼Œå› ä¸º`ä¸»èŠ‚ç‚¹`ä¼šåŒæ­¥åˆ°å¤šä¸ª`ä»èŠ‚ç‚¹`ï¼Œä¼šæ¶ˆè€—å¸¦å®½å’Œå†…å­˜ã€‚

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-032919.png" width="450" />



c) **æ ‘å½¢ç»“æ„**ï¼šå¯ä»¥è§£å†³ä¸Šé¢ä¸€ä¸»å¤šä»ï¼Œä¸»èŠ‚ç‚¹å‹åŠ›è¿‡å¤§çš„é—®é¢˜ï¼›



#### æ•°æ®åŒæ­¥

a) å…¨é‡å¤åˆ¶ï¼šä¸€èˆ¬ç”¨äºåˆæ¬¡å¤åˆ¶åœºæ™¯ï¼ˆç¬¬ä¸€æ¬¡å»ºç«‹SLAVEåå…¨é‡ï¼‰
b) éƒ¨åˆ†å¤åˆ¶ï¼šç½‘ç»œå‡ºç°é—®é¢˜ï¼Œä»èŠ‚ç‚¹å†æ¬¡è¿æ¥ä¸»èŠ‚ç‚¹æ—¶ï¼Œä¸»èŠ‚ç‚¹è¡¥å‘ç¼ºå°‘çš„æ•°æ®ï¼Œæ¯æ¬¡æ•°æ®å¢é‡åŒæ­¥
c) å¿ƒè·³ï¼šä¸»ä»æœ‰é•¿è¿æ¥å¿ƒè·³ï¼Œä¸»èŠ‚ç‚¹é»˜è®¤æ¯10Så‘ä»èŠ‚ç‚¹å‘pingå‘½ä»¤ï¼Œrepl-ping-slave-periodæ§åˆ¶å‘é€é¢‘ç‡

#### ä¸»ä»çš„ç¼ºç‚¹

**a)** è‹¥ä¸»èŠ‚ç‚¹å‡ºç°é—®é¢˜ï¼Œåˆ™ä¸èƒ½æä¾›æœåŠ¡ï¼Œéœ€è¦äººå·¥ä¿®æ”¹é…ç½®å°†ä»å˜ä¸»ã€‚
**b)** `ä¸»èŠ‚ç‚¹`çš„å†™èƒ½åŠ›å•æœºï¼Œèƒ½åŠ›æœ‰é™
**c)** å•æœºèŠ‚ç‚¹çš„å­˜å‚¨èƒ½åŠ›ä¹Ÿæœ‰é™



### å“¨å…µæœºåˆ¶(Sentinel)

> ä¸»è¦æ˜¯ä¸ºäº†è§£å†³ä¸»ä»å¤åˆ¶çš„ç¼ºç‚¹ï¼Œè‡ªåŠ¨å¯¹èŠ‚ç‚¹è¿›è¡Œç›‘æ§ã€‚å½“ä¸»èŠ‚ç‚¹ä¸å¯ç”¨æ—¶ï¼Œè‡ªåŠ¨å°†ä¸»èŠ‚ç‚¹çš„å­èŠ‚ç‚¹è½¬æ¢ä¸ºä¸»èŠ‚ç‚¹ï¼Œå¹¶ä¸”é€šçŸ¥å®¢æˆ·ç«¯ã€‚

#### 1.**é«˜å¯ç”¨**

å½“ä¸»èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶ï¼Œç”±sentinelè‡ªåŠ¨å®Œæˆæ•…éšœå‘ç°å’Œè½¬ç§»ï¼Œå¹¶ä¸”é€šçŸ¥åº”ç”¨ã€‚

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-065139.png" width="300"/>



**ç›‘æ§åŸç†**ï¼š

1ï¼šæ¯10sé’Ÿï¼Œå“¨å…µå‘masterèŠ‚ç‚¹è·å–ä¸€ä¸‹ä¿¡æ¯ï¼Œæ¥ç¡®è®¤ä¸»ä»èŠ‚ç‚¹çš„æ‹“æ‰‘å…³ç³»ï¼›

![1227483-20180201113518031-1426392070](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-081111.png)

2ï¼šæ¯2sé’Ÿï¼Œæ¯ä¸ªå“¨å…µä¼šå‘masterèŠ‚ç‚¹çš„å›ºå®šé¢‘é“ä¸Šå‘é€ä¸»æ¨æ¶ˆæ¯(å“¨å…µå¯¹masterèŠ‚ç‚¹çš„åˆ¤æ–­ã€å“¨å…µè·å–åˆ°çš„èŠ‚ç‚¹ä¿¡æ¯)ã€‚åŒæ—¶ï¼Œæ¯ä¸ªå“¨å…µä¹Ÿä¼šå»è®¢é˜…è¿™ä¸ªå›ºå®šé¢‘é“ï¼Œäº†è§£å…¶ä»–å“¨å…µå¯¹è¿™ä¸ªèŠ‚ç‚¹çš„åˆ¤æ–­ã€‚

![1227483-20180201113623921-1930278582](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-081103.png)

3ï¼šæ¯sé’Ÿï¼Œæ¯ä¸ªå“¨å…µä¹Ÿä¼šå‘å…¶ä»–å“¨å…µä»¥åŠä¸»ã€ä»èŠ‚ç‚¹å‘é€pingå‘½ä»¤ï¼›ç”¨æ¥ç¡®å®šèŠ‚ç‚¹æ˜¯å¦æ­£å¸¸ï¼›

![1227483-20180201115230609-828804435](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-081055.png)



**ä¸‹çº¿çŠ¶æ€**

1.ä¸»è§‚ä¸‹çº¿ï¼š

å“¨å…µæ¯éš”1så‘å…¶ä»–èŠ‚ç‚¹å‘é€pingå‘½ä»¤ï¼Œåœ¨down-after-millisecondsæœ‰æ•ˆæœŸå†…ï¼Œå¦‚æœæ²¡æœ‰å“åº”ï¼Œå°±ä¼šä¸»è§‚çš„å°†è¿™ä¸ªèŠ‚ç‚¹ä¸‹çº¿ï¼›å¹¶ä¸”å‘å…¶ä»–èŠ‚ç‚¹ç¡®è®¤æ˜¯å¦éƒ½æ˜¯ä¸»è§‚ä¸‹çº¿çš„ã€‚![1227483-20180201121656031-220411144](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-102223.png)

2.å®¢è§‚ä¸‹çº¿ï¼š

å½“ä¸»è§‚ä¸‹çº¿çš„å®¢æˆ·æ•°é‡è¶…è¿‡quorumï¼ˆquorum = (èŠ‚ç‚¹æ•°é‡/2) + 1ï¼‰æ—¶ï¼Œåˆ™è®¤ä¸ºèŠ‚ç‚¹æ˜¯å®¢è§‚ä¸‹çº¿çŠ¶æ€ã€‚

å½“èŠ‚ç‚¹è¢«å“¨å…µå®¢è§‚ä¸‹çº¿ä»¥åï¼Œå“¨å…µä¼šé€šè¿‡é€‰ä¸¾ç®—æ³•ï¼Œé€‰å‡ºä¸€ä¸ªå“¨å…µæ¥è´Ÿè´£è¿›è¡Œæ•…éšœè½¬ç§»ã€‚ æ¯ä¸ªå‘ç°èŠ‚ç‚¹å®¢è§‚ä¸‹çº¿çš„å“¨å…µéƒ½æœ‰æƒé™ç”³è¯·æˆä¸ºæ•…éšœè½¬ç§»çš„å“¨å…µï¼›é€‰ä¸¾å…ˆåˆ°å…ˆå¾—ï¼Œæˆä¸ºæ•…éšœè½¬ç§»çš„å“¨å…µä¼šé€‰æ‹©ä¸€ä¸ªä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ä½œä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼›

![1227483-20180201115626875-1938202974](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-102151.png)



**æ•…éšœè½¬ç§»æµç¨‹**

1.é€‰ä¸¾æ–°çš„ä¸»èŠ‚ç‚¹

```mermaid
graph TD
A(ç½‘ç»œè¿æ¥æ­£å¸¸)-->B(5ç§’å†…å›å¤è¿‡INFOå‘½ä»¤)
B --> C(10*down-after-millsecondså†…æœ‰è¿æ¥è¿‡ä¸»æœº)
C --> D(æœåŠ¡å™¨ä¼˜å…ˆçº§)
D --> E(å¤åˆ¶åç§»é‡å¤§çš„)
E --> F(è¿è¡Œidè¾ƒå°)
F --> G(æ–°çš„master)

```

2.å°†å…¶ä»–èŠ‚ç‚¹è®¾ç½®ä¸º`æ–°ä¸»èŠ‚ç‚¹`çš„ä»èŠ‚ç‚¹

![1227483-20180201121911671-2038984859](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-26-102239.png)

3ã€é€šçŸ¥å®¢æˆ·ç«¯ï¼Œæ–°çš„ä¸»èŠ‚ç‚¹çš„ipã€portç­‰ä¿¡æ¯ï¼›



### RedisæŒä¹…åŒ–

#### RDBå­˜å‚¨

> é»˜è®¤æŒä¹…åŒ–æœºåˆ¶

rdbç›¸å½“äºå¿«ç…§ï¼Œå°†å†…å­˜ä¸­çš„æ•°æ®ä»¥å¿«ç…§çš„æ–¹å¼ä¿å­˜åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œé»˜è®¤æ–‡ä»¶åä¸ºdump.rdb;

ä¼˜ç‚¹ï¼š

â€‹	ä¿å­˜å¿«ï¼Œè¯»å–æ¢å¤å¿«ï¼›

ç¼ºç‚¹ï¼š

â€‹	åšå¿«ç…§çš„æ—¶å€™ï¼Œå ç”¨å†…å­˜é«˜ï¼›	

#### AOF

> Append of fileï¼Œå°†redisçš„**å†™å…¥å‘½ä»¤**è¿½åŠ åˆ°æ–‡ä»¶ä¸­ï¼›

ä¸‰ç§aofæ–¹å¼ï¼š

- â€‹	æ¯æ¬¡å†™å…¥è¿½åŠ æ–‡ä»¶ appendfsync always 

ç¼ºç‚¹ï¼šæœ‰æ—¶æˆ‘ä»¬åªå…³æ³¨ç»“æœï¼Œå¹¶ä¸æƒ³å…³æ³¨æ¯æ¬¡å†™å…¥çš„è¿‡ç¨‹ï¼›

- â€‹	æ¯ç§’é’Ÿè¿½åŠ æ–‡ä»¶ appendfsync everysec

ç¼ºç‚¹ï¼šé¢‘ç‡å¤ªé«˜ï¼Œå®¹æ˜“å ç”¨ç£ç›˜å¤ªå¤šï¼›

- â€‹	æ°¸è¿œä¸è¿½åŠ  appendfsync no

ç¼ºç‚¹: å®¹æ˜“ä¸¢å¤±ï¼›





## Nginx

nginxå®‰å…¨ä½“ç³»æ¶æ„

nginxæ­å»ºé›†ç¾¤

nginxè´Ÿè½½å‡è¡¡ç­–ç•¥

æœåŠ¡å™¨å®•æœºå®¹é”™æœºåˆ¶

nginxæ­å»ºä¼ä¸šAPIæ¥å£



åˆ†å¸ƒå¼ä¸é›†ç¾¤çš„åŒºåˆ«

Keepalivedé«˜å¯ç”¨æ¦‚å¿µ

nginx+keepalivedé«˜å¯ç”¨

sessionå…±äº«è§£å†³æ–¹æ¡ˆ

é«˜å¹¶å‘è§£å†³æ–¹æ¡ˆ



## MQæ¶ˆæ¯ä¸­é—´ä»¶

### ä½¿ç”¨åœºæ™¯

1.è§£è€¦

å½“AæœåŠ¡éœ€è¦è¢«å¤šä¸ªæœåŠ¡å¼•ç”¨æ—¶ï¼Œä¸éœ€è¦é¢‘ç¹çš„ä¿®æ”¹AæœåŠ¡çš„æ¥å£ï¼Œåªéœ€è¦å¯¹å¤–æä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œéœ€è¦ç”¨åˆ°çš„æœåŠ¡å»è®¢é˜…è¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å°±å¯ä»¥ï¼›

2.å¼‚æ­¥å¤„ç†è¯·æ±‚

æœ‰ä¸€äº›ä¸šåŠ¡åœºæ™¯ï¼šæ¯”å¦‚å‘é€é‚®ä»¶ã€å‘é€çŸ­ä¿¡ç­‰ã€‚å¦‚æœæ˜¯åŒæ­¥çš„æƒ…å†µï¼Œéœ€è¦ç­‰é‚®ä»¶å‘é€åå†è¿”å›è¯·æ±‚ï¼›é‚£å¦‚æœæ˜¯å¼‚æ­¥çš„è¯ï¼Œå°±å¯ä»¥å°†å‘é€é‚®ä»¶ã€å‘é€çŸ­ä¿¡çš„ä»»åŠ¡åŠ å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç›´æ¥è¿”å›å“åº”ç»“æœï¼›

3.å‰Šå³°

åœºæ™¯: ç§’æ€æ´»åŠ¨ï¼Œä¸€èˆ¬ä¼šå› ä¸ºæµé‡è¿‡å¤§ï¼Œå¯¼è‡´åº”ç”¨æŒ‚æ‰ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸€èˆ¬ä¼šå°†è¯·æ±‚åŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—ã€‚ 

1.ç”¨æˆ·çš„è¯·æ±‚,æœåŠ¡å™¨æ”¶åˆ°ä¹‹å,é¦–å…ˆå†™å…¥æ¶ˆæ¯é˜Ÿåˆ—,åŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—é•¿åº¦è¶…è¿‡æœ€å¤§å€¼,åˆ™ç›´æ¥æŠ›å¼ƒç”¨æˆ·è¯·æ±‚æˆ–è·³è½¬åˆ°é”™è¯¯é¡µé¢. 

2.ç§’æ€ä¸šåŠ¡æ ¹æ®æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„è¯·æ±‚ä¿¡æ¯ï¼Œå†åšåç»­å¤„ç†.




### MQé€šä¿¡æ–¹å¼

**é€šä¿¡åè®®**ï¼š`amqpåè®®`



### æ¶ˆæ¯é˜Ÿåˆ—

#### ç®€å•æ¶ˆæ¯é˜Ÿåˆ—

<img src="https://www.rabbitmq.com/img/tutorials/python-one.png" />

```java
// ç”Ÿäº§è€… -- Producer.java
connection = connectionFactory.newConnection();
channel = connection.createChannel();
// å£°æ˜é€šé“é˜Ÿåˆ—
channel.queueDeclare(QUEUE_NAME, false, false, false, null);
String message = "Hello World";
channel.basicPublish("", QUEUE_NAME, null, message.getBytes());
System.out.println(" [x] Sent '" + message + "'");

// æ¶ˆè´¹è€… -- Receiver.java
Consumer consumer = new Consumer() {
  @Override
  public void handleDelivery(String s, Envelope envelope, AMQP.BasicProperties basicProperties, byte[] bytes) throws IOException {
    String message = new String(bytes, "UTF-8");
    System.out.println("[X] recived" + message);
  }
};
channel.basicConsume(TASK_QUEUE_NAME, autoAck, consumer);
```



ç¼ºç‚¹ï¼š1.è€¦åˆæ€§é«˜ï¼Œç”Ÿäº§è€…1-1å¯¹åº”æ¶ˆè´¹è€…ã€‚æ— æ³•ç”¨å¤šä¸ªæ¶ˆè´¹è€…å»å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—ï¼›

2.é˜Ÿåˆ—åå˜æ›´æ—¶ï¼Œéœ€è¦åŒæ—¶å˜æ›´ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„ä»£ç ï¼›



#### Work Queues(æ¶ˆæ¯åˆ†å‘)



![image-20190927183530447](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-27-103531.png)

ä¸€ä¸ªé˜Ÿåˆ—å¯ä»¥åˆ†é…ç»™å¤šä¸ªæ¶ˆè´¹è€…

##### Round-robin dispatching (è½®è¯¢åˆ†å‘)

> æ¶ˆæ¯å®¢æˆ·ç«¯å¹³å‡åˆ†é…æ‰€æœ‰çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ— è®ºæ¶ˆè´¹è€…çš„å¤„ç†èƒ½åŠ›å¦‚ä½•ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…éƒ½ä¼šè½®æµå¤„ç†ä¸€ä¸ªæ¶ˆæ¯ï¼›
>
> æ¶ˆæ¯å‘é€åä¼šè‡ªåŠ¨åˆ é™¤é˜Ÿåˆ—çš„æ¶ˆæ¯ï¼›

```java
// consumer.java æ¶ˆè´¹è€…
try {
	Connection connection = connectionFactory.newConnection();
  Channel channel = connection.createChannel();
  // å£°æ˜é˜Ÿåˆ—
  channel.queueDeclare(TASK_QUEUE_NAME, true, false, false, null);
  DeliverCallback deliverCallback = (tag, delivery) -> {
    String message = new String(delivery.getBody(), "UTF-8");
    try {
      doWork(message);
      System.out.println("[X] recived" + message);
    } finally {
    }
  };
  // è‡ªåŠ¨å‘é€ç¡®è®¤å›æ‰§
  boolean autoAck = true;
  channel.basicConsume(TASK_QUEUE_NAME, autoAck, deliverCallback, consumerTag -> {
  });
} catch (Exception e) {
  e.printStackTrace();
}
```



##### Fair dispatching (å…¬å¹³åˆ†å‘)

> é™åˆ¶æ¯æ¬¡æ¶ˆæ¯å‘é€è€…åªå‘é€1ä¸ªæ¶ˆæ¯ï¼Œå¹¶ä¸”ç­‰å¾…æ¶ˆè´¹è€…å‘é€æ¶ˆæ¯ç¡®è®¤ackï¼Œæ‰ä¼šå»åˆ é™¤æ¶ˆæ¯é˜Ÿåˆ—ï¼›
>
> æ³¨ï¼šéœ€è¦å…³é—­è‡ªåŠ¨Ack, å¹¶ä¸”å½“æ¶ˆè´¹è€…å¤„ç†å®Œæ¶ˆæ¯åï¼Œæ‰‹åŠ¨è¿”å›Ackç¡®è®¤ã€‚

**å…³é”®è®¾ç½®**ï¼šqos

åœ¨éè‡ªåŠ¨ç¡®è®¤æ¶ˆæ¯çš„å‰æä¸‹ï¼Œå¦‚æœä¸€å®šæ•°é‡çš„æ¶ˆæ¯æœªè¢«ç¡®è®¤ï¼Œä¸è¿›è¡Œæ–°çš„æ¶ˆæ¯æ¶ˆè´¹ï¼›

- void BasicQos(uint prfetchSize,ushort prefetchCount,bool global);

**å‚æ•°è§£é‡Šï¼š**
*prefetchSize*: æ¶ˆæ¯çš„é™åˆ¶å¤§å°ï¼Œæ¶ˆæ¯å¤šå°‘å…†ã€‚ä¸€èˆ¬ä¸åšé™åˆ¶ï¼Œè®¾ç½®ä¸º0

*prefetchCount*: ä¼šå‘Šè¯‰RabbitMQä¸è¦åŒæ—¶ç»™ä¸€ä¸ªæ¶ˆè´¹è€…æ¨é€å¤šäºNä¸ªæ¶ˆæ¯ï¼Œå³ä¸€æ—¦æœ‰Nä¸ªæ¶ˆæ¯è¿˜æ²¡æœ‰ackï¼Œåˆ™è¯¥consumerå°†blockæ‰ï¼Œç›´åˆ°æœ‰æ¶ˆæ¯ackã€‚ä¸€èˆ¬è®¾ç½®ä¸º1

*global*:  true\false æ˜¯å¦å°†ä¸Šé¢è®¾ç½®åº”ç”¨äºchannelã€‚true è¡¨ç¤ºchannelçº§åˆ«ï¼Œfalseè¡¨ç¤ºåœ¨consumerçº§åˆ«

```java
// Consumer.java
Connection connection = connectionFactory.newConnection();
Channel channel = connection.createChannel();
// å£°æ˜é˜Ÿåˆ—
channel.queueDeclare(TASK_QUEUE_NAME, true, false, false, null);
// qos(æœåŠ¡è´¨é‡ä¿è¯)åŠŸèƒ½
channel.basicQos(1);
DeliverCallback deliverCallback = (tag, delivery) -> {
  String message = new String(delivery.getBody(), "UTF-8");
  System.out.println("[X] recived" + message);
  try {
    doWork(message);
  } finally {
    // æ‰‹åŠ¨ç¡®è®¤ï¼Œå¦‚æœå¿˜è®°ï¼Œæ¶ˆæ¯ä¸€ç›´æ— æ³•ç¡®è®¤ï¼Œä¼šå†…å­˜æº¢å‡º
    channel.basicAck(delivery.getEnvelope().getDeliveryTag(), false);
  }
};
// å–æ¶ˆè‡ªåŠ¨å‘é€ç¡®è®¤å›æ‰§
boolean autoAck = false;
channel.basicConsume(TASK_QUEUE_NAME, autoAck, deliverCallback, consumerTag -> {
});
```

å¦‚æœå¿˜äº†ç¡®è®¤æ¶ˆæ¯ï¼Œé‚£ä¹ˆä¼šå µå¡ä½ï¼š

![image-20191002094429036](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-02-014430.png)

##### 



#### MQå‘å¸ƒè®¢é˜…

##### Exchangeæ¶ˆæ¯äº¤æ¢æœº

> Exchangeä¸»è¦ç”¨æ¥å°†æ¶ˆæ¯è½¬å‘åˆ°ä¸åŒçš„é˜Ÿåˆ—

- directæ¨¡å¼ï¼šå¤„ç†routing key.

  `Direct`è¦æ±‚è¯¥æ¶ˆæ¯çš„è·¯ç”±é”®**å®Œå…¨åŒ¹é…**ã€‚

![174578-20180524175810062-1941410843](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-28-031932.png)

- topicæ¨¡å¼ï¼šé€šé…ç¬¦æ¥åŒ¹é…routing key

![174578-20180524175844359-92574693](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-28-031950.png)

- fanout: ä¸å¤„ç†routing key, æ‰€æœ‰æ¶ˆæ¯éƒ½ä¼šé€šè¿‡exchangeè½¬å‘åˆ°ç»‘å®šçš„queue

![174578-20180524175832191-777772730](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-28-031943.png)



##### Fanoutæ¨¡å¼

æ‰€æœ‰çš„æ¶ˆæ¯éƒ½ä¼šè½¬å‘åˆ°æ‰€æœ‰ç»‘å®šçš„é˜Ÿåˆ—ä¸Šå»

<img src="https://www.rabbitmq.com/img/tutorials/python-three-overall.png" />

1.ä¸€ä¸ªç”Ÿäº§è€…å¯¹åº”å¤šä¸ªæ¶ˆè´¹è€…

2.æ¯ä¸ªæ¶ˆè´¹è€…æœ‰è‡ªå·±çš„æ¶ˆæ¯é˜Ÿåˆ—

3.ç”Ÿäº§è€…çš„æ¶ˆæ¯ä¸ç›´æ¥å‘å¾€é˜Ÿåˆ—ï¼Œè€Œæ˜¯é€šè¿‡äº¤æ¢æœº(exchange)æ¥å‘é€

4.æ¯ä¸ªé˜Ÿåˆ—çš„è¦å’Œäº¤æ¢æœºç»‘å®š

```java
//Publisher.java
// å£°æ˜äº¤æ¢æœº
 channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.FANOUT);
 channel.basicPublish(EXCHANGE_NAME, "", null, message.getBytes());
  
// Sub.java
// å£°æ˜exchange
channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.FANOUT);
String queueName = channel.queueDeclare().getQueue();
// ç»‘å®šexchange
channel.queueBind(queueName, EXCHANGE_NAME, "");
DeliverCallback deliverCallback = (consumerTag, delivery) -> {
  String message = new String (delivery.getBody(), "UTF-8");
  System.out.println(" [x] Receive '" + message + "'");
};
channel.basicConsume(queueName, true, deliverCallback, consumerTag -> {});
```

æ§åˆ¶å°ç•Œé¢ï¼š

![image-20190928110243950](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-28-030244.png)

![image-20190928105844979](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-28-025845.png)



##### Routingæ¨¡å¼

> Routingä¹Ÿæ˜¯è®¢é˜…-å‘å¸ƒæ¨¡å¼ä¸€ç§ï¼Œåªä¸è¿‡å¢åŠ äº†ä¸€å±‚ `routing-key`å’Œ`æ¶ˆæ¯-key`çš„ç»‘å®šå…³ç³»

![image-20190928112840060](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-28-032840.png)

```java
// Publishe.java
try {
  connrection = connectionFactory.newConnection();
  channel = connection.createChannel();
  // å£°æ˜äº¤æ¢æœºç±»å‹
  channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);
  channel.basicPublish(EXCHANGE_NAME, routingKey, null, message.getBytes());
} catch (Exception e) {
  e.printStackTrace();
}

// Subscriber.java
try {
  connection = connectionFactory.newConnection();
  channel = connection.createChannel();
  // å£°æ˜exchange
  channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);
  String queueName = channel.queueDeclare("queue_info", false, false, false, null)
    .getQueue();
  // ç»‘å®šexchangeï¼Œæœ€åå‚æ•°æ˜¯routing-key
  channel.queueBind(queueName, EXCHANGE_NAME, "info");
  channel.queueBind(queueName, EXCHANGE_NAME, "error");
  channel.queueBind(queueName, EXCHANGE_NAME, "warning");

  DeliverCallback deliverCallback = (consumerTag, delivery) -> {
    String message = new String (delivery.getBody(), "UTF-8");
    System.out.println(" [x] Receive '" + message + "'");
  };
  channel.basicConsume(queueName, true, deliverCallback, consumerTag -> {});
} catch (Exception e) {
  e.printStackTrace();
}

```

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-28-035111.png" height="300"/>





##### Topicæ¨¡å¼

å°†routing-keyå’Œbingd-keyç”¨é€šé…ç¬¦çš„æ¨¡å¼è®¢é˜…

- \* (star) èƒ½åŒ¹é…ä»»æ„1ä¸ªè¯.
- \# (hash) å¯ä»¥åŒ¹é…0æˆ–è€…å¤šä¸ªè¯.

![image-20190928121435095](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-28-041435.png)

```java
// Publisher.java
try {
  connection = connectionFactory.newConnection();
  channel = connection.createChannel();
  // å£°æ˜äº¤æ¢æœº
  channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.TOPIC);
  channel.basicPublish(EXCHANGE_NAME, type, null, message.getBytes());
  System.out.println(" [x] Sent '" + message + "'");
} catch (Exception e) {
  e.printStackTrace();
}

// Sub.java
try {
  connection = connectionFactory.newConnection();
  channel = connection.createChannel();
  // å£°æ˜exchange
  channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.TOPIC);
  String queueName = channel.queueDeclare("queue_kern.*", false, false, false, null)
    .getQueue();
  // ç»‘å®šexchange
  channel.queueBind(queueName, EXCHANGE_NAME, "kern.*");

  DeliverCallback deliverCallback = (consumerTag, delivery) -> {
    String message = new String (delivery.getBody(), "UTF-8");
    System.out.println(" [x] Receive '" + message + "'");
  };
  channel.basicConsume(queueName, true, deliverCallback, consumerTag -> {});
} catch (Exception e) {
  e.printStackTrace();
}
```



### æ¶ˆæ¯æŒä¹…åŒ–ä¸æ¶ˆæ¯ç¡®è®¤æœºåˆ¶

>  é—®é¢˜ï¼šä¸ºä»€ä¹ˆè¦æ¶ˆæ¯æŒä¹…åŒ–ï¼Ÿ
>
>  MQæ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œå¯ä»¥æœ¬åœ°æŒä¹…åŒ–æ¶ˆæ¯ï¼Œè¿™æ ·å¯ä»¥é¿å…å› ä¸ºæœåŠ¡å™¨å®•æœºå¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±ã€‚
>
>  é—®é¢˜ï¼šä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯ç¡®è®¤ï¼Ÿ
>
>  å› ä¸ºæˆ‘ä»¬æ— æ³•ä¿è¯æ¶ˆæ¯å‘å¸ƒè€…åœ¨å°†æ¶ˆæ¯å‘å¸ƒå‡ºå»åï¼Œæ¶ˆæ¯èƒ½å¤Ÿæ­£ç¡®åˆ°è¾¾æ¶ˆæ¯é˜Ÿåˆ—é‡Œã€‚æ¶ˆæ¯ç¡®è®¤çš„æœ€ä¸»è¦çš„ç›®çš„å°±æ˜¯ä¸ºäº†ç¡®ä¿æ¶ˆæ¯è¦100%ä¼ é€’åˆ°MQä¸­ï¼Œé¿å…æ¶ˆæ¯åœ¨åˆ°è¾¾MQçš„é˜¶æ®µå·²ç»ä¸¢å¤±ã€‚

å¦‚ä½•ç¡®ä¿æ¶ˆæ¯100%æŠ•é€’æˆåŠŸï¼Ÿ

- ä¿éšœæ¶ˆæ¯çš„æˆåŠŸå‘å‡º

- ä¿éšœMQèŠ‚ç‚¹çš„æˆåŠŸæ¥æ”¶
- å‘é€ç«¯æ”¶åˆ°MQèŠ‚ç‚¹ï¼ˆBrokerï¼‰ç¡®è®¤åº”ç­”
- å®Œå–„çš„æ¶ˆæ¯è¿›è¡Œè¡¥å¿æœºåˆ¶

å› ä¸ºå‰3æ­¥åˆ†åˆ«ä»ç”Ÿäº§è€…ã€æ¶ˆæ¯é˜Ÿåˆ—ã€æ¶ˆè´¹è€…3ä¸ªç¯èŠ‚è¿›è¡Œç¡®è®¤ï¼Œä½†æ˜¯éƒ½ä¸èƒ½100%ä¿è¯æ¶ˆæ¯æŠ•é€’æˆåŠŸï¼Œå› æ­¤éœ€è¦åŠ ä¸Šç¬¬4æ­¥ã€‚

ä¸€èˆ¬çš„è¡¥å¿æœºåˆ¶æ–¹æ¡ˆå¦‚ä¸‹ï¼š

æ–¹æ¡ˆ1ï¼š`æ¶ˆæ¯è½åº“`

![image-20190930114011178](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-30-034012.png)

åœ¨äº’è”ç½‘å¤§å‚ï¼Œä¸€èˆ¬éƒ½ä¼šé‡‡ç”¨`æ¶ˆæ¯è½åº“`çš„æ–¹æ¡ˆï¼Œæ¥è¿›è¡Œæ¶ˆæ¯è¡¥å¿ï¼Œé¿å…æ¶ˆæ¯ä¸¢å¤±ã€‚

- æ¶ˆæ¯çŠ¶æ€åˆ†ä¸º3ç§ï¼Œ`æœªå‘é€`ã€`å·²å‘é€`ã€`å·²é€è¾¾`ã€‚å‘é€æ¶ˆæ¯çš„åŒæ—¶ï¼Œå°†æ¶ˆæ¯æŒä¹…åŒ–åˆ°æ•°æ®åº“ä¸­ï¼Œå¹¶ä¸”ç»™æ¶ˆæ¯è®¾ç½®å¥½çŠ¶æ€`å·²å‘é€`ã€‚å½“æ¶ˆæ¯çŠ¶æ€å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œå°†æ•°æ®åº“ä¸­çš„æ¶ˆæ¯çŠ¶æ€åŒæ­¥å˜æ›´ã€‚

- å¯¹äºå·²å‘é€æœªåˆ°è¾¾çš„æ¶ˆæ¯ï¼Œä¼šå®šæ—¶å»åšè½®è¯¢æ“ä½œï¼Œè°ƒç”¨ç”Ÿäº§è€…é‡æ–°å‘é€ã€‚ä½†æ˜¯é‡æ–°å‘é€çš„æ¬¡æ•°ä¹Ÿéœ€è¦åšä¸ªé™åˆ¶ï¼Œä¿æŒåœ¨3-5æ¬¡ã€‚

è¿™ä¸ªæ–¹æ¡ˆä¸»è¦ç¼ºç‚¹æœ‰2ä¸ªï¼š

- æ€§èƒ½ç“¶é¢ˆï¼šæ¶ˆæ¯è½åº“ã€ä»¥åŠæ¶ˆæ¯çŠ¶æ€å˜æ›´éƒ½ä¼šè½åº“ï¼Œä¼šé€ æˆæ•°æ®åº“å‹åŠ›è¿‡å¤§ï¼›

- äº‹ç‰©ä¸€è‡´æ€§ï¼šå‘é€æ¶ˆæ¯ã€æ¶ˆæ¯è½åº“2ä¸ªåŠ¨ä½œéœ€è¦æœ‰äº‹ç‰©æœºåˆ¶ä¿æŠ¤ï¼Œè¿™ç‚¹ä¹Ÿä¼šé€ æˆæ€§èƒ½ä¸‹é™ï¼›

  

æ–¹æ¡ˆ2ï¼š å»¶è¿Ÿç¡®è®¤

![image-20190930121108552](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-30-041109.png)

- ç¬¬ä¸€æ­¥ï¼Œç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—
- ç¬¬äºŒæ­¥ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ç›‘å¬æ¶ˆè´¹è€…æ¶ˆæ¯ç¡®è®¤
- ç¬¬ä¸‰æ­¥ï¼Œæ¶ˆè´¹è€…å‘é€æ¶ˆæ¯ç¡®è®¤ä¿¡æ¯
- ç¬¬å››æ­¥ï¼Œcallbackç›‘å¬mqçš„æ¶ˆæ¯ç¡®è®¤
- ç¬¬äº”æ­¥ï¼Œæ›´æ–°æ¶ˆæ¯çŠ¶æ€ï¼Œç¡®å®šæ¶ˆæ¯å‘é€æˆåŠŸï¼›
- ==åœ¨ç¬¬ä¸€æ­¥ä¸­ï¼Œç”Ÿäº§è€…å‘é€æ¶ˆæ¯åï¼Œå¯ä»¥è®¾ç½®å»¶è¿Ÿ2-5åˆ†é’Ÿï¼Œå†æ¬¡å‘é€æ¶ˆæ¯ï¼Œç¡®è®¤ä¸Šæ¬¡å‘é€çš„æ¶ˆæ¯å¦å·²ç»é€è¾¾==
- ==callbackä¼šå»ç›‘å¬mqçš„è¿™ä¸ªç¡®è®¤æ¶ˆæ¯ï¼Œå¹¶å¯¹éœ€è¦ç¡®è®¤çš„æ¶ˆæ¯è¿›è¡Œæ£€æŸ¥ï¼›==
- ==å¦‚æœæ¶ˆæ¯å·²ç»å‘é€æˆåŠŸï¼Œä¸åšå¤„ç†ï¼›å¦‚æœæ¶ˆæ¯æ²¡æœ‰æˆåŠŸï¼Œä¼šè¿œç¨‹è°ƒç”¨ç”Ÿäº§è€…æœåŠ¡å†æ¬¡å‘é€æ¶ˆæ¯==ï¼›



### æ¶ˆæ¯Returnæœºåˆ¶

> æ¶ˆæ¯é‡å›æœºåˆ¶æ˜¯ä¸ºäº†å¯¹æ²¡æœ‰å¤„ç†æˆåŠŸçš„æ¶ˆæ¯ï¼ŒæŠŠæ¶ˆæ¯é‡æ–°ä¼ é€’ç»™MQ Brokerã€‚
>
> Return Listenerå°±æ˜¯ç”¨æ¥å®ç°è¿™ä¸€æœºåˆ¶çš„ï¼›

<img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-01-090144.png" width="400"/>

å½“ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼ŒMQæ‰¾ä¸åˆ°ä»»ä½•åŒ¹é…çš„æ¶ˆæ¯Exchangeï¼Œæˆ–è€…åŒ¹é…åˆ°äº†Exchangeå´æ— æ³•æ‰¾åˆ°å¯¹åº”`Routing-Key`çš„æ¶ˆè´¹é˜Ÿåˆ—Queueã€‚

é‚£ä¹ˆMQæ— æ³•å¤„ç†è¿™äº›æ¶ˆæ¯ï¼Œæ‰€ä»¥éœ€è¦è¿˜ç»™ç”Ÿäº§è€…é‡æ–°å¤„ç†è¿™äº›æ¶ˆæ¯ï¼ˆæ¯”å¦‚é‡æ–°å‘é€ï¼‰ï¼›

å› æ­¤MQ Brokeræä¾›äº†è¿™ç§Returnæœºåˆ¶ï¼Œé€šè¿‡è®¾ç½®Return Listeneræ¥å»å¤„ç†è¿™äº›ä¸å¯é€è¾¾çš„æ¶ˆæ¯ã€‚

```java
// Producer.java
Connection connection = connectionFactory.newConnection();
Channel channel = connection.createChannel();
String exchange = "return_true_exchange";
String routingKey = "all";
String routingKeyError = "all-error";
channel.exchangeDeclare(exchange, BuiltinExchangeType.DIRECT);
channel.addReturnListener((int replyCode, String replyText, String exchange1, String routingKey1, AMQP.BasicProperties properties, byte[] body) -> {
  String txt = new String(body, "UTF-8");
  System.out.format("æ¶ˆæ¯è¢«è¿”å›%s, exhcange: %s, routingKey: %s\n",txt, exchange1, routingKey1);
});
// å½“routingKeyåŒ¹é…ä¸ä¸Šçš„æ—¶å€™ï¼Œmqä¼šé€šè¿‡ReturnListeneræ¥è‡ªåŠ¨è¿”å›æ¶ˆæ¯ï¼›
if (isReturn) {
  channel.basicPublish(exchange, routingKeyError, true, null, message.getBytes());
} else {
  channel.basicPublish(exchange, routingKey, true, null, message.getBytes());
}
```



### æ¶ˆæ¯äº‹ç‰©

äº‹åŠ¡ä¸»è¦æ˜¯ä¿è¯æ¶ˆæ¯è¦å‘é€åˆ°Brokerå½“ä¸­ã€‚

- amqpåè®®è‡ªå¸¦æ”¯æŒçš„äº‹ç‰©

  > - txSelect() å°†å½“å‰channelè®¾ç½®æˆtransactionæ¨¡å¼
  > - txCommit() æäº¤äº‹åŠ¡
  > - txRollback() å›æ»šäº‹åŠ¡

  ```java
  // Producer.java
  connection = connectionFactory.newConnection();
  channel = connection.createChannel();
  // å£°æ˜äº¤æ¢æœº
  channel.queueDeclare(QUEUE_NAME, false, false, false, null);
  channel.txSelect();
  String message = "this result is: ";
  channel.basicPublish("", QUEUE_NAME, null, message.getBytes());
  double count = dividend / divisor;
  channel.basicPublish("", QUEUE_NAME, null, String.valueOf(count).getBytes());
  channel.txCommit();
  System.out.println(" [x] Sent '" + message + "'");
  ```

  

- confirmæ¨¡å¼

  - ä¸²è¡Œç¡®è®¤æ¨¡å¼

    ```java
  // Producer.java
    // å•ä¸ªç¡®è®¤
    connection = connectionFactory.newConnection();
    channel = connection.createChannel();
    channel.queueDeclare(QUEUE_NAME, false, false, false, null);
    channel.confirmSelect();
    long start = System.nanoTime();
    for (int i = 0; i < MESSAGE_COUNT; i++) {
      String body = String.valueOf(i);
      channel.basicPublish("", QUEUE_NAME, null, body.getBytes());
      channel.waitForConfirmsOrDie(5_000);
    }
    long end = System.nanoTime();
    
    =============
      // æ‰¹é‡ç¡®è®¤
    connection = connectionFactory.newConnection();
    channel = connection.createChannel();
    channel.queueDeclare(QUEUE_NAME, false, false, false, null);
    channel.confirmSelect();
    connection = connectionFactory.newConnection();
    for (int i = 0; i < MESSAGE_COUNT; i++) {
      String body = String.valueOf(i);
      channel.basicPublish("", QUEUE_NAME, null, body.getBytes());
    }
    channel.waitForConfirmsOrDie(5_000);
    long end = System.nanoTime();
    ```
  
    

  - å¼‚æ­¥ç¡®è®¤æ¨¡å¼

    ```java
  connection = connectionFactory.newConnection();
    channel = connection.createChannel();
    channel.queueDeclare(QUEUE_NAME, false, false, false, null);
    // å¼€å¯ç¡®è®¤æ¨¡å¼
    channel.confirmSelect();
    ConcurrentNavigableMap<Long, String> outstandingConfirms = new ConcurrentSkipListMap<>();
    // æˆåŠŸçš„å¤„ç†
    ConfirmCallback cleanOutstandingConfirms = (sequenceNumber, multiple) -> {
      if (multiple) {
        ConcurrentNavigableMap<Long, String> confirmed = outstandingConfirms.headMap(sequenceNumber, true);
        confirmed.clear();
      } else {
        outstandingConfirms.remove(sequenceNumber);
      }
      System.out.println("æ¶ˆæ¯å‘é€æˆåŠŸï¼š" + sequenceNumber);
    };
    // æ·»åŠ ç¡®è®¤ç›‘å¬å™¨listener
    channel.addConfirmListener(cleanOutstandingConfirms, (sequenceNumber, multiple) -> {
      // å¤±è´¥çš„å¤„ç†
      String body = outstandingConfirms.get(sequenceNumber);
      System.err.format(
        "Message with body %s has been nack-ed. Sequence number: %d, multiple: %b%n",
        body, sequenceNumber, multiple
      );
      // å¤±è´¥äº†ï¼Œäº¤ç»™cleanOutstandingConfirmså†æ¬¡å¤„ç†
      cleanOutstandingConfirms.handle(sequenceNumber, multiple);
    });
    long start = System.nanoTime();
    for (int i = 0; i < MESSAGE_COUNT; i++) {
      String body = String.valueOf(i);
      outstandingConfirms.put(channel.getNextPublishSeqNo(), body);
      channel.basicPublish("", QUEUE_NAME, null, body.getBytes());
    }
    long end = System.nanoTime();
    System.out.format("Published %,d messages and handled confirms asynchronously in %,d ms%n", MESSAGE_COUNT, Duration.ofNanos(end - start).toMillis());
    ```



> ä¸åŒæ¨¡å¼çš„è¿è¡Œæ•ˆæœï¼š
>
> Published 50,000 messages individually in 13,080 ms
>
> Published 50,000 messages in batch in 2,935 ms
>
> Published 50,000 messages and handled confirms asynchronously in 3,446 ms
>
> å¯ä»¥çœ‹å‡ºæ¥ï¼Œå•ä¸ªè¿è¡Œçš„æ•ˆç‡æ¯”è¾ƒæ…¢ï¼Œæ‰¹é‡ç¡®è®¤ä»¥åŠå¼‚æ­¥ç¡®è®¤çš„æ¨¡å¼æ•ˆç‡è¾ƒé«˜ï¼›





### é›†æˆSpring

#### RabbitAdmin

> RabbitAdminç±»å¯ä»¥å¾ˆå¥½çš„æ”¯æŒRabbitMQ, åœ¨Springä¸­ç›´æ¥è¿›è¡Œæ³¨å…¥å³å¯
>
> - autoStartUpå¿…é¡»è¦è®¾ç½®ä¸ºtrue,å¦åˆ™Springå®¹å™¨ä¸ä¼šåŠ è½½RabbitAdminç±»
> - RabbitAdminåº•å±‚å®ç°å°±æ˜¯ä»Springå®¹å™¨ä¸­è·å–Exchangeã€Bingdingã€RoutingKeyä»¥åŠQueueçš„@Beanå£°æ˜

```java
//ç›´è¿ç›‘å¬
rabbitAdmin.declareExchange(new DirectExchange("test.direct", false, false));

rabbitAdmin.declareExchange(new TopicExchange("test.topic", false, false));

rabbitAdmin.declareExchange(new FanoutExchange("test.fanout", false, false));

rabbitAdmin.declareQueue(new Queue("test.direct.queue", false));

rabbitAdmin.declareQueue(new Queue("test.topic.queue", false));

rabbitAdmin.declareQueue(new Queue("test.fanout.queue", false));

//ç¬¬ä¸€ä¸ªå‚æ•°ï¼šå…·ä½“çš„é˜Ÿåˆ— ç¬¬äºŒä¸ªå‚æ•°ï¼šç»‘å®šçš„ç±»å‹ ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šäº¤æ¢æœº ç¬¬å››ä¸ªå‚æ•°ï¼šè·¯ç”±key ç¬¬äº”ä¸ªå‚æ•°ï¼šarguments å‚æ•°
rabbitAdmin.declareBinding(new Binding("test.direct.queue",
                                       Binding.DestinationType.QUEUE,
                                       "test.direct", "direct", new HashMap<>()));

//BindingBuilder é“¾å¼ç¼–ç¨‹
rabbitAdmin.declareBinding(
  BindingBuilder
                .bind(new Queue("test.topic.queue", false))     //ç›´æ¥åˆ›å»ºé˜Ÿåˆ—
                .to(new TopicExchange("test.topic", false, false))  //ç›´æ¥åˆ›å»ºäº¤æ¢æœº å»ºç«‹å…³è”å…³ç³»
                .with("user.#"));   //æŒ‡å®šè·¯ç”±Key


rabbitAdmin.declareBinding(
          BindingBuilder
                .bind(new Queue("test.fanout.queue", false))        
          .to(new FanoutExchange("test.fanout", false, false)));

//æ¸…ç©ºé˜Ÿåˆ—æ•°æ®
rabbitAdmin.purgeQueue("test.topic.queue", false);
```



#### RabbitTemplate

> æ¶ˆæ¯æ¨¡æ¿
>
> è¯¥ç±»æä¾›äº†ä¸°å¯Œçš„å‘é€æ¶ˆæ¯æ–¹æ³•ï¼ŒåŒ…æ‹¬å¯é æ€§æŠ•é€’æ¶ˆæ¯æ–¹æ³•ã€å›è°ƒç›‘å¬æ¶ˆæ¯æ¥å£ConfirmCallbackã€è¿”å›å€¼ç¡®è®¤æ¥å£ReturnCallbackç­‰ç­‰ã€‚åŒæ ·æˆ‘ä»¬éœ€è¦è¿›è¡Œæ³¨å…¥åˆ°Springå®¹å™¨ä¸­ï¼Œç„¶åç›´æ¥ä½¿ç”¨ã€‚



#### SimpleMessageListenerContainer

**ç®€å•æ¶ˆæ¯ç›‘å¬å®¹å™¨**

- ç›‘å¬é˜Ÿåˆ—(å¤šä¸ªé˜Ÿåˆ—)ã€è‡ªåŠ¨å¯åŠ¨ã€è‡ªåŠ¨å£°æ˜åŠŸèƒ½
- è®¾ç½®äº‹åŠ¡ç‰¹æ€§ã€äº‹åŠ¡ç®¡ç†å™¨ã€äº‹åŠ¡å±æ€§ã€äº‹åŠ¡å®¹å™¨(å¹¶å‘)ã€æ˜¯å¦å¼€å¯äº‹åŠ¡ã€å›æ»šæ¶ˆæ¯ç­‰
- è®¾ç½®æ¶ˆè´¹è€…æ•°é‡ã€æœ€å°æœ€å¤§æ•°é‡ã€æ‰¹é‡æ¶ˆè´¹
- è®¾ç½®æ¶ˆæ¯ç¡®è®¤å’Œè‡ªåŠ¨ç¡®è®¤æ¨¡å¼ã€æ˜¯å¦é‡å›é˜Ÿåˆ—ã€å¼‚å¸¸æ•æ‰handlerå‡½æ•°
- è®¾ç½®æ¶ˆè´¹è€…æ ‡ç­¾ç”Ÿæˆç­–ç•¥ã€æ˜¯å¦ç‹¬å æ¨¡å¼ã€æ¶ˆè´¹è€…å±æ€§ç­‰
- è®¾ç½®å…·ä½“çš„ç›‘å¬å™¨ã€æ¶ˆæ¯è½¬æ¢å™¨ç­‰ç­‰ã€‚

```java
@Bean
	public SimpleMessageListenerContainer messageListenerContainer(ConnectionFactory connectionFactory) {
		SimpleMessageListenerContainer container = new SimpleMessageListenerContainer(connectionFactory);
		container.setQueues(queue1());
		container.setConcurrentConsumers(1);
		container.setMaxConcurrentConsumers(5);
		container.setDefaultRequeueRejected(false);
		container.setAcknowledgeMode(AcknowledgeMode.AUTO);
		container.setExposeListenerChannel(true);
		container.setConsumerTagStrategy(queue ->  queue + "_" + UUID.randomUUID().toString());
    // è®¾ç½®å…·ä½“çš„ç›‘å¬å™¨
		container.setMessageListener(message -> {
				String msg = new String(message.getBody());
				System.err.println("----------æ¶ˆè´¹è€…: " + msg);
		});
}
```



#### MessageListenerAdapter æ¶ˆæ¯ç›‘å¬é€‚é…å™¨

**é»˜è®¤handleMessage**

```java
// åŒæ ·åœ¨SimpleMessageListenerContainer è¿™ä¸ªæ–¹æ³•é‡Œ
MessageListenerAdapter adapter = new MessageListenerAdapter(new MessageDelegate());
container.setMessageListener(adapter);

// MessageDelegateç±»
public class MessageDelegate {
    public void handleMessage(byte[] messageBody) {
        System.err.println("é»˜è®¤æ–¹æ³•, æ¶ˆæ¯å†…å®¹:" + new String(messageBody));
    }
}
```

MessageDelegateç±»ä¸­ï¼Œæ–¹æ³•åä¸å‚æ•°`handleMessage(byte[] messageBody)`æ˜¯å›ºå®šçš„ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

**MessageListenerAdapteræºç åˆ†æ**

æˆ‘ä»¬æ¥çœ‹ä¸‹MessageListenerAdapteråº•å±‚ä»£ç 

![image-20190929181504955](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-09-29-101505.png)é»˜è®¤æ–¹æ³•åå°±æ˜¯å«handleMessageï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è‡ªå·±å»æŒ‡å®šè®¾ç½®

**è‡ªå®šä¹‰æ–¹æ³•å**

```java
MessageListenerAdapter adapter = new MessageListenerAdapter(new MessageDelegate());
adapter.setDefaultListenerMethod("consumeMessage");
container.setMessageListener(adapter);

//å¯¹åº”ä¹Ÿè¦ä¿®æ”¹MessageDelegateç±»
public class MessageDelegate {
    public void consumeMessage(byte[] messageBody) {
        System.err.println("å­—èŠ‚æ•°ç»„æ–¹æ³•, æ¶ˆæ¯å†…å®¹:" + new String(messageBody));
    }
}
```



#### MessageConverteræ¶ˆæ¯è½¬æ¢å™¨

æˆ‘ä»¬åœ¨è¿›è¡Œå‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œæ­£å¸¸æƒ…å†µä¸‹æ¶ˆæ¯ä½“ä¸ºäºŒè¿›åˆ¶çš„æ•°æ®æ–¹å¼è¿›è¡Œä¼ è¾“ã€‚å¯¹åº”çš„adapterçš„æ–¹æ³•å…¥å‚ä¹Ÿæ˜¯äºŒè¿›åˆ¶æ•°ç»„ã€‚å¦‚æœå¸Œæœ›è¿›è¡Œè½¬æ¢ï¼ŒæŒ‡å®šè‡ªå®šä¹‰çš„è½¬æ¢å™¨ï¼Œå°±éœ€è¦ç”¨åˆ°MessageConverter

- è‡ªå®šä¹‰å¸¸ç”¨è½¬æ¢å™¨ï¼šMessageConverterï¼Œä¸€èˆ¬æ¥è®²éƒ½éœ€è¦å®ç°è¿™ä¸ªæ¥å£
- é‡å†™ä¸‹é¢ä¸¤ä¸ªæ–¹æ³•ï¼š
  `toMessage`: javaå¯¹è±¡è½¬æ¢ä¸ºMessage
  `fromMessage`: Messageå¯¹è±¡è½¬æ¢ä¸ºjavaå¯¹è±¡
- Jsonè½¬æ¢å™¨ï¼šJackson2JsonMessageConverter:å¯ä»¥è¿›è¡ŒJavaå¯¹è±¡çš„è½¬æ¢åŠŸèƒ½
- DefaultJackson2JavaTypeMapperæ˜ å°„å™¨ï¼šå¯ä»¥è¿›è¡Œjavaå¯¹è±¡çš„æ˜ å°„å…³ç³»
- è‡ªå®šä¹‰äºŒè¿›åˆ¶è½¬æ¢å™¨ï¼šæ¯”å¦‚å›¾ç‰‡ç±»å‹ã€PDFã€PPTã€æµåª’ä½“

```java
// æ–‡å­—è½¬åŒ–å™¨
public class TextMessageConverter implements MessageConverter {

    @Override
    public Message toMessage(Object object, MessageProperties messageProperties) throws MessageConversionException {
        return new Message(object.toString().getBytes(), messageProperties);
    }

    @Override
    public Object fromMessage(Message message) throws MessageConversionException {
        String contentType = message.getMessageProperties().getContentType();
        if(null != contentType && contentType.contains("text")) {
            return new String(message.getBody());
        }
        return message.getBody();
    }

}
```



### æ¶ˆæ¯çš„å¹‚ç­‰æ€§

> å¹‚ç­‰ï¼ˆidempotentã€idempotenceï¼‰æ˜¯ä¸€ä¸ªæ•°å­¦ä¸è®¡ç®—æœºå­¦æ¦‚å¿µï¼Œå¸¸è§äºæŠ½è±¡ä»£æ•°ä¸­ï¼Œå³f(f(x)) = f(x)ã€‚ç®€å•çš„æ¥è¯´å°±æ˜¯**ä¸€ä¸ªæ“ä½œå¤šæ¬¡æ‰§è¡Œäº§ç”Ÿçš„ç»“æœä¸ä¸€æ¬¡æ‰§è¡Œäº§ç”Ÿçš„ç»“æœä¸€è‡´**ã€‚

**å†¥ç­‰æ€§çš„ä½œç”¨**ï¼š

åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œä¼šæœ‰å¤§é‡çš„æ¶ˆæ¯åˆ°è¾¾MQï¼Œæ¶ˆè´¹ç«¯ä¼šæ¥å—åˆ°å¤§é‡çš„æ¶ˆæ¯ã€‚è¿™æ ·çš„æƒ…å†µä¸‹ï¼Œéš¾å…ä¼šå‡ºç°æ¶ˆæ¯çš„é‡å¤æŠ•é€’ï¼Œç½‘ç»œå¼‚å¸¸ç­‰æƒ…å†µã€‚å¦‚æœä¸å»åšå¹‚ç­‰å¤„ç†ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šå‡ºç°æ¶ˆæ¯çš„**é‡å¤æ¶ˆè´¹**ã€‚

**å¹‚ç­‰æ€§çš„æ–¹æ¡ˆ**ï¼š

- å”¯ä¸€ID+æŒ‡çº¹ç æœºåˆ¶ï¼Œåˆ©ç”¨æ•°æ®åº“ä¸»é”®å»é‡
- åˆ©ç”¨Redisçš„åŸå­æ€§å®ç°



### TTL ç”Ÿå­˜æ—¶é—´

- TTLæ˜¯Time To Liveçš„ç¼©å†™ï¼Œä¹Ÿå°±æ˜¯ç”Ÿå­˜æ—¶é—´
- RabbitMQæ”¯æŒæ¶ˆæ¯çš„è¿‡æœŸæ—¶é—´ï¼Œåœ¨æ¶ˆæ¯å‘é€æ—¶å¯ä»¥è¿›è¡ŒæŒ‡å®šç”Ÿå­˜æ—¶é—´ï¼›ä»æ¶ˆæ¯è¿›å…¥é˜Ÿåˆ—å¼€å§‹è®¡ç®—ï¼Œåªè¦è¶…è¿‡äº†é˜Ÿåˆ—çš„æ—¶é—´é…ç½®ï¼Œæ¶ˆæ¯ä¼šè‡ªåŠ¨åˆ é™¤ï¼›



```java
// TTL Demo
String exchangName = "demo_ttl_exchange";
String queueName = "demo_ttl_queue";
// åˆ é™¤é˜Ÿåˆ—
rabbitAdmin.deleteQueue(queueName);
// åˆ é™¤Exchange
rabbitAdmin.deleteExchange(exchangName);
Map<String, Object> arguments = new HashMap<>();
arguments.put("x-message-ttl", 10000);
arguments.put("x-max-length", 1);
Queue queue = new Queue(queueName, true, false, false, arguments);
rabbitAdmin.declareExchange(new TopicExchange(exchangName));
rabbitAdmin.declareQueue(queue);
rabbitAdmin.declareBinding(new Binding(queueName, Binding.DestinationType.QUEUE, exchangName, "ttl.#", null));
org.springframework.amqp.core.MessageProperties messageProperties = new org.springframework.amqp.core.MessageProperties();
Message messageObj = new Message(message.getBytes(), messageProperties);
rabbitTemplate.convertAndSend(exchangName, "ttl.message", messageObj);

```





### æ­»ä¿¡é˜Ÿåˆ— DLX

>å½“æ¶ˆæ¯è¢«æ‹’æ”¶(basic.reject / basic.nack) å¹¶ä¸”requeue = falseæ—¶
>
>æˆ–è€…å½“æ¶ˆæ¯TTLåˆ°æœŸ
>
>æˆ–è€…å½“æ¶ˆæ¯é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§çš„é•¿åº¦
>
>è¿™äº›æ¶ˆæ¯èƒ½å¤Ÿé‡æ–°å‘é€åˆ°ä¸€ä¸ªExchangeé‡Œï¼Œè¿™ä¸ªExchangeå°±æ˜¯DLX

**Demo**

å£°æ˜ä¸€ä¸ªæ­»ä¿¡é˜Ÿåˆ—å’ŒRoutingKey

> Exchange: dlx.exchange; (Exchangeåç§°éšæ„)ï¼›
>
> RoutingKey: dlx (RoutingKeyåç§°éšæ„ï¼Œåªéœ€è¦å’Œé˜Ÿåˆ—èƒ½æ¥å—åˆ°å³å¯)

æ­£å¸¸å£°æ˜ Exchangeã€Queueã€RoutingKeyï¼Œå¹¶ä¸”è®¾ç½®Queueå‚æ•°ï¼š("x-dead-letter-exchange","dlx.exchange");

è¿™æ ·æ¶ˆæ¯åœ¨TTLè¿‡æœŸã€æˆ–è€…å½“é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦æ—¶ï¼Œæ¶ˆæ¯å°±å¯ä»¥ç›´æ¥è·¯ç”±åˆ°æ­»ä¿¡é˜Ÿåˆ—ï¼

![image-20191003163250278](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-03-083251.png)

![image-20191003163316561](https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-10-03-083317.png)

```java
// RabbitMqConfig.java
@Bean
public Exchange dlxExchange() {
  return new DirectExchange(DEAD_EXCHANGE_NAME);
}

@Bean
public Queue dlxQueue() {
  Queue queue = new Queue(QUEUE_NAME);
  return queue;
}

@Bean
public Binding bindDlxQueue(Queue dlxQueue, Exchange dlxExchange) {
  return BindingBuilder.bind(dlxQueue).to(dlxExchange).with("dlx").noargs();
}

// Producer.java
String exchangeName = "test_dlx_exchange";
String queueName = "test_dlx_queue";
String routingKey = "demo_dlx";
String message = "Hello RabbitMQ DLX Message";
Map<String, Object> args = new HashMap<>(2);
args.put("x-dead-letter-exchange", "dlx_exchange");
args.put("x-dead-letter-routing-key", "dlx");
rabbitAdmin.declareQueue(new Queue(queueName, true, false, false, args));
rabbitAdmin.declareExchange(new TopicExchange(exchangeName));
rabbitAdmin.declareBinding(new Binding(queueName, Binding.DestinationType.QUEUE, exchangeName, routingKey, null));
for(int i = 0; i< 1; i ++){
  MessageProperties messageProperties = new MessageProperties();
  messageProperties.setDeliveryMode(MessageProperties.DEFAULT_DELIVERY_MODE);
  messageProperties.setExpiration("10000");
  Message msg = new Message((message + i).getBytes(), messageProperties);
  rabbitTemplate.convertAndSend(exchangeName, routingKey, msg);
}
```

æ³¨ï¼š`test_dlx_queue`å£°æ˜äº†å‚æ•°ï¼Œè®¾ç½®äº†æ­»ä¿¡exchangeä¸º`dlx_exchange`

å½“`test_dlx_queue`æ¶ˆæ¯å˜æˆæ­»ä¿¡æ—¶ï¼Œæ¶ˆæ¯ä¼šè‡ªåŠ¨è½¬å‘`dlx_exchange` -> `dlx_queue`;



## ä»»åŠ¡è°ƒåº¦

ä»»åŠ¡è°ƒåº¦æ¦‚è¿°

ä½¿ç”¨Quartzå®ç°

åˆ†å¸ƒå¼ä»»åŠ¡å¦‚ä½•è§£å†³"å¹‚ç­‰æ€§"

XX-JOBç¯å¢ƒ

åˆ†å¸ƒå¼ä»»åŠ¡å¹³å°æ‰§è¡ŒåŸç†

ä»»åŠ¡è°ƒåº¦å¹³å°æ‰§è¡Œå™¨è¿è¡Œ

ä»»åŠ¡è°ƒåº¦å¹³å°è·¯ç”±ç­–ç•¥



## åˆ†å¸ƒå¼äº‹ç‰©

åˆ†å¸ƒå¼äº‹ç‰©äº§ç”ŸåŸå› 

åˆ†å¸ƒå¼äº‹ç‰©è§£å†³æ–¹æ¡ˆ

CPAä¸Baseç†è®º

2PC-ä¸¤æ®µæäº¤åè®®

ä½¿ç”¨MQè§£å†³åˆ†å¸ƒå¼äº‹ç‰©

LCNæ¡†æ¶æ¦‚è¿°

LCNæ¡†æ¶åŸç†

LCNæ¡†æ¶æµç¨‹

å¯åŠ¨tx-mananger

æ¼”ç¤ºåˆ†å¸ƒå¼äº‹ç‰©äº§æ™¯

ä½¿ç”¨LCNæ¡†æ¶è§£å†³åˆ†å¸ƒå¼äº‹ç‰©



## åˆ†å¸ƒå¼æ¡†æ¶1

SpringCloudæ¦‚è¿°

æœåŠ¡æ³¨å†Œä¸æœåŠ¡å‘ç°

æ­å»ºEurekaæ³¨å†Œä¸­å¿ƒ(æœåŠ¡å‘ç°)

å‘å¸ƒæœåŠ¡ä¼šå‘˜æä¾›è€…

æ¶ˆè´¹ä¼šå‘˜æœåŠ¡

springcloudè°ƒç”¨æœåŠ¡åŸç†

springcloudæœåŠ¡è´Ÿè½½å‡è¡¡å®ç°åŸç†

ä½¿ç”¨Ribbonæ­å»ºå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨

ä»€ä¹ˆæ˜¯æ¥å£ç½‘å…³

ä½¿ç”¨Zuulæ­å»ºæœåŠ¡æ¥å£ç½‘å…³ (æ™ºèƒ½è·¯ç”±)

ä½¿ç”¨Zuulç½‘å…³æ‹¦æˆªå‚æ•°

åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒæ¦‚è¿°

ä½¿ç”¨feginå®¢æˆ·ç«¯

æœåŠ¡é›ªå´©æ•ˆåº”äº§ç”ŸåŸå› 

é›ªå´©æ•ˆåº”è§£å†³æ–¹æ¡ˆ

ä½¿ç”¨hystrixå®ç°æœåŠ¡é™çº§

ä½¿ç”¨hystrixè§£å†³æœåŠ¡é›ªå´©åŸå› 



## åˆ†å¸ƒå¼æ¡†æ¶2

Dubboæ¶æ„åŸç†

Dubboåº”ç”¨åœºæ™¯

Dubboåˆ›å»ºé¡¹ç›®æ¶æ„æ¨¡å¼

å‘å¸ƒä¼šå‘˜æœåŠ¡

è®¢å•æ¶ˆè´¹æœåŠ¡

Dubbo-Admin

Dubboå®ç°è´Ÿè½½å‡è¡¡ã€å®¹é”™

Dubbxä½¿ç”¨



## Zookeeper

Zookeeperæ¦‚è¿°

Zookeeperåº”ç”¨åœºæ™¯

Zookeeperä¸´æ—¶èŠ‚ç‚¹

Watcheräº‹ä»¶é€šçŸ¥

Zookeeperå®ç°åˆ†å¸ƒå¼é”

è§£å†³ç”Ÿäº§è®¢å•å·çº¿ç¨‹å®‰å…¨é—®é¢˜

Zookeeperå®ç°åˆ†å¸ƒå¼é”è§£å†³æ–¹æ¡ˆ

Zookeeperå®ç°è´Ÿè½½å‡è¡¡åŸç†

å¦‚ä½•å®ç°è´Ÿè½½å‡è¡¡ç­–ç•¥

å¦‚ä½•å®ç°è´Ÿè½½å‡è¡¡è½®è®­ç®—æ³•

å¦‚ä½•ä½¿ç”¨Zookeeperå®ç°é€‰ä¸¾ç­–ç•¥



# ç§»åŠ¨ç«¯è§£å†³æ–¹æ¡ˆ

ç§»åŠ¨APPç™»å½•

ä½¿ç”¨Tokenç™»å½•

ä½¿ç”¨tokenæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯



ç§»åŠ¨ç«¯æ¸²æŸ“

å‡å°‘CPUã€GPUçš„è®¡ç®—æ—¶é—´ã€‚

å‡å°‘é‡ç»˜æ—¶é—´ã€æ¸²æŸ“æ¬¡æ•°

è¾ƒå°‘IOä¼ è¾“æ—¶é—´ï¼Œå¢åŠ ç¼“å­˜å†…å­˜ï¼›



# æ’®åˆç³»ç»Ÿ

## è®¢å•æ¨¡å—

### è®¢å•ç±»å‹

é™ä»·å•

å¸‚ä»·å•

æ­¢ç›ˆæ­¢æŸ

### è®¢å•é˜Ÿåˆ—

è®¢å•é˜Ÿåˆ—æ’åº

ä»·æ ¼ä¼˜å…ˆ: ä¹°å•ä»é«˜å¾€ä½ï¼Œå–å•ä»ä½å¾€é«˜

åŒç­‰ä»·æ ¼æ—¶é—´ä¼˜å…ˆ

æ’®åˆé¡ºåºï¼š



### è‡ªåŠ¨æˆäº¤

æ’®åˆè®¢å•

ç”Ÿæˆäº¤æ˜“è®°å½•



### æ’®åˆç®—æ³•

å…¬å¹³æ€§ã€

é«˜æ•ˆæ€§

æ‰©å±•æ€§











