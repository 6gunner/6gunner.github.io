<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>解决方案 | Coda的博客</title>
    <meta name="generator" content="VuePress 1.5.1">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="闲着无聊？那就读书吧">
    <link rel="preload" href="/assets/css/0.styles.c3659042.css" as="style"><link rel="preload" href="/assets/js/app.3bcc0bcc.js" as="script"><link rel="preload" href="/assets/js/2.c5c14eb8.js" as="script"><link rel="preload" href="/assets/js/58.c90127f4.js" as="script"><link rel="prefetch" href="/assets/js/10.53889524.js"><link rel="prefetch" href="/assets/js/11.bded85d3.js"><link rel="prefetch" href="/assets/js/12.bde1e69c.js"><link rel="prefetch" href="/assets/js/13.216bacd3.js"><link rel="prefetch" href="/assets/js/14.2a3abe69.js"><link rel="prefetch" href="/assets/js/15.3d9c6b68.js"><link rel="prefetch" href="/assets/js/16.18276b87.js"><link rel="prefetch" href="/assets/js/17.0f0df718.js"><link rel="prefetch" href="/assets/js/18.55d8b011.js"><link rel="prefetch" href="/assets/js/19.c0045a3e.js"><link rel="prefetch" href="/assets/js/20.d9d49e93.js"><link rel="prefetch" href="/assets/js/21.93d2a403.js"><link rel="prefetch" href="/assets/js/22.a2a0af85.js"><link rel="prefetch" href="/assets/js/23.d172675f.js"><link rel="prefetch" href="/assets/js/24.e1e1691d.js"><link rel="prefetch" href="/assets/js/25.e2b132b3.js"><link rel="prefetch" href="/assets/js/26.ced2a385.js"><link rel="prefetch" href="/assets/js/27.e4e7fdda.js"><link rel="prefetch" href="/assets/js/28.39009050.js"><link rel="prefetch" href="/assets/js/29.ca40ed0c.js"><link rel="prefetch" href="/assets/js/3.b842b953.js"><link rel="prefetch" href="/assets/js/30.a94da205.js"><link rel="prefetch" href="/assets/js/31.74f35770.js"><link rel="prefetch" href="/assets/js/32.05011607.js"><link rel="prefetch" href="/assets/js/33.f02fbb83.js"><link rel="prefetch" href="/assets/js/34.739ed5c6.js"><link rel="prefetch" href="/assets/js/35.1dc1d512.js"><link rel="prefetch" href="/assets/js/36.fc766dde.js"><link rel="prefetch" href="/assets/js/37.a2e0b62b.js"><link rel="prefetch" href="/assets/js/38.361aaee8.js"><link rel="prefetch" href="/assets/js/39.c7281005.js"><link rel="prefetch" href="/assets/js/4.c4955446.js"><link rel="prefetch" href="/assets/js/40.90c4a1d2.js"><link rel="prefetch" href="/assets/js/41.c8e4d5a9.js"><link rel="prefetch" href="/assets/js/42.f5c2bf1b.js"><link rel="prefetch" href="/assets/js/43.a5512bd6.js"><link rel="prefetch" href="/assets/js/44.bb54c1b5.js"><link rel="prefetch" href="/assets/js/45.009766aa.js"><link rel="prefetch" href="/assets/js/46.a2ea99d9.js"><link rel="prefetch" href="/assets/js/47.2a2b2056.js"><link rel="prefetch" href="/assets/js/48.69595edc.js"><link rel="prefetch" href="/assets/js/49.6ebebd68.js"><link rel="prefetch" href="/assets/js/5.790d3fc0.js"><link rel="prefetch" href="/assets/js/50.69fff158.js"><link rel="prefetch" href="/assets/js/51.226ec71a.js"><link rel="prefetch" href="/assets/js/52.d8eac68c.js"><link rel="prefetch" href="/assets/js/53.19d0927d.js"><link rel="prefetch" href="/assets/js/54.ac06f4fe.js"><link rel="prefetch" href="/assets/js/55.6d82b994.js"><link rel="prefetch" href="/assets/js/56.ccf19bf4.js"><link rel="prefetch" href="/assets/js/57.594e7b17.js"><link rel="prefetch" href="/assets/js/59.5d591b9e.js"><link rel="prefetch" href="/assets/js/6.720e350f.js"><link rel="prefetch" href="/assets/js/60.c8e17510.js"><link rel="prefetch" href="/assets/js/61.b037e070.js"><link rel="prefetch" href="/assets/js/62.ed4aab00.js"><link rel="prefetch" href="/assets/js/63.5c708a2a.js"><link rel="prefetch" href="/assets/js/64.0ebd4f2f.js"><link rel="prefetch" href="/assets/js/65.22c3784d.js"><link rel="prefetch" href="/assets/js/66.d00a221f.js"><link rel="prefetch" href="/assets/js/67.9be23755.js"><link rel="prefetch" href="/assets/js/68.49dae0b9.js"><link rel="prefetch" href="/assets/js/69.a46cc89a.js"><link rel="prefetch" href="/assets/js/7.9f6e7a1c.js"><link rel="prefetch" href="/assets/js/70.4ebb514e.js"><link rel="prefetch" href="/assets/js/71.da1fad39.js"><link rel="prefetch" href="/assets/js/72.d98a09aa.js"><link rel="prefetch" href="/assets/js/73.5efdf4d6.js"><link rel="prefetch" href="/assets/js/74.1e949167.js"><link rel="prefetch" href="/assets/js/75.39449fd3.js"><link rel="prefetch" href="/assets/js/76.fe85b9d0.js"><link rel="prefetch" href="/assets/js/77.6ad893e5.js"><link rel="prefetch" href="/assets/js/78.c0ba6cbe.js"><link rel="prefetch" href="/assets/js/79.dc93fed9.js"><link rel="prefetch" href="/assets/js/8.c6c4c9d5.js"><link rel="prefetch" href="/assets/js/80.0ebd0a9a.js"><link rel="prefetch" href="/assets/js/81.20ea5db3.js"><link rel="prefetch" href="/assets/js/9.75d01cd2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c3659042.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Coda的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/服务端/" class="nav-link">
  服务端
</a></div><div class="nav-item"><a href="/前端/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/android/" class="nav-link">
  android
</a></div><div class="nav-item"><a href="/DevOps/" class="nav-link">
  devOps
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/服务端/" class="nav-link">
  服务端
</a></div><div class="nav-item"><a href="/前端/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/android/" class="nav-link">
  android
</a></div><div class="nav-item"><a href="/DevOps/" class="nav-link">
  devOps
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>解决方案</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/%E5%89%8D%E7%AB%AF/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_1-前端可配置化logo的设计方案" class="sidebar-link">1.前端可配置化logo的设计方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#需求背景" class="sidebar-link">需求背景</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#解决方案-2" class="sidebar-link">解决方案</a></li></ul></li><li><a href="/%E5%89%8D%E7%AB%AF/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_2-nodejs进行服务的转发代理" class="sidebar-link">2.nodejs进行服务的转发代理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#需求背景-2" class="sidebar-link">需求背景</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#方案" class="sidebar-link">方案</a></li></ul></li><li><a href="/%E5%89%8D%E7%AB%AF/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_3-实现一个大文件上传" class="sidebar-link">3.实现一个大文件上传</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#需求背景-3" class="sidebar-link">需求背景</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#解决方案-3" class="sidebar-link">解决方案</a></li></ul></li><li><a href="/%E5%89%8D%E7%AB%AF/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_4-前端excel导出数据功能" class="sidebar-link">4.前端Excel导出数据功能</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E5%89%8D%E7%AB%AF/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_5-前端实现大文件下载" class="sidebar-link">5.前端实现大文件下载</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#需求背景-4" class="sidebar-link">需求背景</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/%E5%89%8D%E7%AB%AF%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#解决方案-4" class="sidebar-link">解决方案</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="解决方案"><a href="#解决方案" class="header-anchor">#</a> 解决方案</h1> <h2 id="_1-前端可配置化logo的设计方案"><a href="#_1-前端可配置化logo的设计方案" class="header-anchor">#</a> 1.前端可配置化logo的设计方案</h2> <blockquote><p>这个方案是在工作当中运用到的最小化、最简易版的设计方案</p></blockquote> <h3 id="需求背景"><a href="#需求背景" class="header-anchor">#</a> 需求背景</h3> <p>给公司做了一个基于sass服务的运营——管理端界面。因为是给客户使用的，有一些客户希望能用自己的公司的logo、海报背景等等。相当于个性化定制。</p> <p>所以需要把一些配置提炼出来，作为可配置化的功能。</p> <h3 id="解决方案-2"><a href="#解决方案-2" class="header-anchor">#</a> 解决方案</h3> <blockquote><p>一、方案思路</p></blockquote> <p>首先定义一个配置文件，可以是.json的后缀，也可以是.js的后缀。配置的内容主要就是需要配置的各种logo、title等信息。</p> <p>通过后台的相关接口，知道引入哪一个配置文件。</p> <p>根据接口，引入这个配置文件，可以是通过ajax来请求这个json，又或者是动态import这个js文件，取决于你的文件格式。</p> <blockquote><p>二、关键代码</p></blockquote> <p><strong>配置文件格式</strong></p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;default&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;loginBg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/static/img/default/login-bg.png&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;footerLogo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/static/img/default/footer-logo.png&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;logo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/static/img/default/logo.png&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;welcome&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/static/img/default/welcome-bg.png&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;favicon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/static/img/default/favicon.ico&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>这里就简单举个例子，“default”就是配置的唯一id，不同的配置会分配一个id给他。</p> <p>default下面的key就是配置项。</p> <p><strong>设置为全局变量</strong></p> <div class="language-html extra-class"><pre class="language-html"><code> &lt;% if (process.env.NODE_ENV === 'production') { %&gt;
      window.__config = {
        #if ($third_type)
          thirdType: '&lt;%= &quot;$!third_type&quot; %&gt;',
        #else
          thirdType: 'default',
        #end
        #if ($title)
          title: '&lt;%= &quot;$!title&quot; %&gt;',
        #else
          title: '管理平台',
        #end
      }
   &lt;% } %&gt;
</code></pre></div><p>这里其实用到了模板语言，<code>&lt;% if (process.env.NODE_ENV === 'production') { %&gt;</code>是ejs的语法。node打包编译完成后，需要将它放到服务端，从服务端直接那边返回页面。</p> <p>这段话的意思是，从服务端渲染的时候，读取third_type的变量信息，然后直接设置为全局window.__config.thirdType这个变量。 这个变量的意思就是具体需要用到哪个配置文件的意思。</p> <p><strong>view使用</strong></p> <p>先读取配置信息</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> images <span class="token keyword">from</span> <span class="token string">'../assets/img/images.json'</span><span class="token punctuation">;</span>
<span class="token comment">// 中间省略</span>
<span class="token operator">...</span>
<span class="token comment">// vue的data对象</span>
<span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
		images<span class="token operator">:</span> images<span class="token punctuation">[</span>window<span class="token punctuation">.</span>__config<span class="token punctuation">.</span>thirdType<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>再在用到的地方，使用data变量来替换。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>header-logo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  用到图片的地方
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">:src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>images.logo<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>header-logo-img<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
 </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span></code></pre></div><blockquote><p>三、方案的优缺点</p></blockquote> <p><strong>优点</strong>：</p> <ol><li>最小化的解决了个性化配置的问题。只需要后台配合域名或者机构号，来设置好thirdType参数，再返回给前端即可。</li> <li>从页面渲染加载时，就可以确认thirdType，不会出现闪屏的问题；</li></ol> <p><strong>缺点</strong>：</p> <ol><li>配置不灵活，需要手动写配置文件，而且替换图片也需要开发人员进行打包升级，不能做到立即生效；</li></ol> <blockquote><p>四、待改进点</p></blockquote> <ol><li>因为我们产品以及后台都没有规划好这块的功能设计，所以其实最大的改进就是将这些配置本身就做成功能。</li> <li>其次，import json文件，实际上会把json代码打包到整个代码里面去，导致文件臃肿。最好是从服务端加载。</li> <li>图片都是本地图片，最好也可以从远端读取图片，减少打包的大小；</li></ol> <blockquote><p>五、源码地址</p></blockquote> <h2 id="_2-nodejs进行服务的转发代理"><a href="#_2-nodejs进行服务的转发代理" class="header-anchor">#</a> 2.nodejs进行服务的转发代理</h2> <h3 id="需求背景-2"><a href="#需求背景-2" class="header-anchor">#</a> 需求背景</h3> <p>这个之前项目里想到用这个方案做一些请求的透传，改变host和cookie，达到跨域的效果。</p> <h3 id="方案"><a href="#方案" class="header-anchor">#</a> 方案</h3> <p>开发时，前端如果需要proxy进行代理请求，webpackDevServer提供了一个很好的API。</p> <p>生产环境如果也需要做中间件透传，那么可以去参考webpackDevServer去做。</p> <h2 id="_3-实现一个大文件上传"><a href="#_3-实现一个大文件上传" class="header-anchor">#</a> 3.实现一个大文件上传</h2> <h3 id="需求背景-3"><a href="#需求背景-3" class="header-anchor">#</a> 需求背景</h3> <p>本来是在做一个运维工具，用来测试我们对外的user api接口。由于是nodejs写的，而node对FormData的支持不是很好，所以提交文件就很麻烦。</p> <p>后面衍生出了两种问题：</p> <p>1、怎么用nodejs去模拟浏览器的request去上传文件</p> <p>2、怎么进行大文件上传</p> <h3 id="解决方案-3"><a href="#解决方案-3" class="header-anchor">#</a> 解决方案</h3> <blockquote><p>问题分析</p></blockquote> <p>首先，在http请求里，如果是普通的form表单提交，会以<code>application/x-www-form-urlencoded</code>的形式传输. 但如果是传输文件的格式,需要设置header为是<code>multipart/form-data</code>.</p> <p>来看一个文件上传的http报文：</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token request-line"><span class="token property">POST</span> /file/v1/upload HTTP/1.1</span>
<span class="token header-name keyword">Host:</span> localhost:8081
<span class="token header-name keyword">Content-Length:</span> 100460
<span class="token header-name keyword">Content-Type:</span> multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

----WebKitFormBoundary7MA4YWxkTrZu0gW
<span class="token header-name keyword">Content-Disposition:</span> form-data; name=&quot;file&quot;; filename=&quot;v2-f7139f8763b996ebfa28486e160f6378_r.jpg&quot;
<span class="token header-name keyword">Content-Type:</span> image/jpeg

(data)
----WebKitFormBoundary7MA4YWxkTrZu0gW--

</code></pre></div><p>上面4行是request的headers</p> <p>中间有一行空行，空行下面是FormData</p> <p>可以看出来：FormData是以<code>----WebKitFormBoundary${random_str}</code>开始，以<code>----WebKitFormBoundary${random_str}--</code>结尾。并且这个值和headers里面Content-Type的boundary一致。</p> <p>所以第一个问题很好解决，只需要模拟这种请求的格式，应该就能发送一个文件到服务端。</p> <blockquote><p>实现代码：</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> boundary <span class="token operator">=</span> <span class="token string">'001373272605314343826714'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> filePath <span class="token operator">=</span> <span class="token string">'/Users/keyang/Desktop/v2-f7139f8763b996ebfa28486e160f6378_r.jpg'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token string">'method'</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
	<span class="token string">'hostname'</span><span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
	<span class="token string">'port'</span><span class="token operator">:</span> <span class="token number">61470</span><span class="token punctuation">,</span>
	<span class="token string">'path'</span><span class="token operator">:</span> <span class="token string">'/file/v1/upload'</span><span class="token punctuation">,</span>
	<span class="token string">'headers'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'multipart/form-data; boundary=------------------------WebKitFormBoundary7MA4YWxkTrZu0gW'</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">const</span> req <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> chunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">var</span> body <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>chunks<span class="token punctuation">)</span><span class="token punctuation">;</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> postData <span class="token operator">=</span> <span class="token string">'------------------------'</span> <span class="token operator">+</span> boundary <span class="token operator">+</span> <span class="token string">'\r\n'</span>
	<span class="token operator">+</span> <span class="token string">'Content-Disposition:form-data; name=&quot;file&quot;; filename=&quot;v2-f7139f8763b996ebfa28486e160f6378_r.jpg&quot;\r\n'</span>
	<span class="token operator">+</span> <span class="token string">'Content-Type: image/jpeg\r\n\r\n'</span>
<span class="token keyword">const</span> endData <span class="token operator">=</span> <span class="token string">'\r\n------------------------'</span> <span class="token operator">+</span> boundary <span class="token operator">+</span> <span class="token string">'--\r\n'</span><span class="token punctuation">;</span>


fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	req<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'multipart/form-data; boundary=------------------------'</span> <span class="token operator">+</span> boundary<span class="token punctuation">)</span><span class="token punctuation">;</span>
	req<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Length'</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">byteLength</span><span class="token punctuation">(</span>postData<span class="token punctuation">)</span> <span class="token operator">+</span> Buffer<span class="token punctuation">.</span><span class="token function">byteLength</span><span class="token punctuation">(</span>endData<span class="token punctuation">)</span> <span class="token operator">+</span> stats<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	req<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>postData<span class="token punctuation">)</span><span class="token punctuation">;</span>
	req<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span>
	req<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>endData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>第二部分上传大文件的思路：</p> <p>1.客户端分片；使用Blob.prototype.slice方法。将大文件分成小的文件，确保每个文件不会超过1048576字节的大小。</p> <p>2.服务端合并：先接受客户端传输的分片文件，按顺序保存。上传完成后，利用对分片传输的文件进行合并。</p> <p>分片文件的发送大致如下：</p> <div class="language-html extra-class"><pre class="language-html"><code>POST /test.html HTTP/1.1
Host: example.org
Content-Type: multipart/form-data;boundary=&quot;boundary&quot;

--boundary
Content-Disposition: form-data; name=&quot;chunk&quot;; filename=&quot;blob&quot;
Content-Type: application/octet-stream

(binary)
--boundary
Content-Disposition: form-data; name=&quot;hash&quot;

value1
--boundary
Content-Disposition: form-data; name=&quot;filename&quot;

value2
--boundary--
</code></pre></div><p>利用hash值来标识文件顺序，利用chunk来传输文件</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-18-030935.png" alt="image-20200113154533606"></p> <blockquote><p>代码实现</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code># interview<span class="token operator">-</span>learn
<span class="token comment">//https://juejin.im/post/5dff8a26e51d4558105420ed?utm_source=gold_browser_extension#heading-13</span>
</code></pre></div><h2 id="_4-前端excel导出数据功能"><a href="#_4-前端excel导出数据功能" class="header-anchor">#</a> 4.前端Excel导出数据功能</h2> <p>有一些报表的数据，客户希望通过导出成为excel的方式去查看。而这些数据都已经通过后台接口返回回来了，那么单纯的通过前端就可以进行excel导出功能。</p> <blockquote><p>使用说明</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 声明导出excel的header名称</span>
<span class="token keyword">const</span> tHeader <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.initDate'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.coName'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.pdName'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.assetAccoName'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.exchgroupName'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.exchName'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.currencyPair'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.orderDir'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.strikeAVGPrice'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.strikeQty'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.strikeAmount'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.fee'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 处理数据</span>
<span class="token keyword">const</span> filterVal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'init_date'</span><span class="token punctuation">,</span> <span class="token string">'co_name'</span><span class="token punctuation">,</span> <span class="token string">'pd_name'</span><span class="token punctuation">,</span> <span class="token string">'asset_acco_name'</span><span class="token punctuation">,</span> <span class="token string">'exch_group_name'</span><span class="token punctuation">,</span> <span class="token string">'exch_name'</span><span class="token punctuation">,</span> <span class="token string">'stock_name'</span><span class="token punctuation">,</span> <span class="token string">'order_dir'</span><span class="token punctuation">,</span> <span class="token string">'strike_aver_price'</span><span class="token punctuation">,</span> <span class="token string">'bs_crncy_strike_qty'</span><span class="token punctuation">,</span> <span class="token string">'qt_crncy_strike_qty'</span><span class="token punctuation">,</span> <span class="token string">'strike_fee'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tableData<span class="token punctuation">;</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> filterVal<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'strike_aver_price'</span> <span class="token operator">||</span> key <span class="token operator">===</span> <span class="token string">'bs_crncy_strike_qty'</span> <span class="token operator">||</span> key <span class="token operator">===</span> <span class="token string">'qt_crncy_strike_qty'</span> <span class="token operator">||</span> key <span class="token operator">===</span> <span class="token string">'strike_fee'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'number'</span><span class="token punctuation">,</span> <span class="token string">'$0'</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'order_dir'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">translateDict</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> item<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> item<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> currentDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> excelName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.exchgroupStrike'</span><span class="token punctuation">)</span> <span class="token operator">+</span> currentDate<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'yyyyMMdd'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> excelSheetName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$t</span><span class="token punctuation">(</span><span class="token string">'table.exchgroupStrike'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 交给工具方法去导出数据</span>
<span class="token function">export_json_to_excel</span><span class="token punctuation">(</span>tHeader<span class="token punctuation">,</span> data<span class="token punctuation">,</span> excelSheetName<span class="token punctuation">,</span> excelName<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_5-前端实现大文件下载"><a href="#_5-前端实现大文件下载" class="header-anchor">#</a> 5.前端实现大文件下载</h2> <h3 id="需求背景-4"><a href="#需求背景-4" class="header-anchor">#</a> 需求背景</h3> <p>火币项目里，有一个导出数据的需求。数据量特别大，按照传统做法，会很卡顿。后台如果是把所有数据查询回来在一次性返回，压力也很大。</p> <h3 id="解决方案-4"><a href="#解决方案-4" class="header-anchor">#</a> 解决方案</h3> <p>和后台商定，采用文件流的传输模式。后台直接以stream的形式传输数据，前端采用stream模式下载。</p> <p>来分析一下这个response headers:</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-03-18-035546.png" alt="image-20200318115358676"></p> <p>第一点：<code>application/octet-stream</code></p> <p><code>content-type</code>是<code>application/otcet-stream</code>，查看MDN的文档可以知道:</p> <p>这是应用程序文件的默认值。意思是 *未知的应用程序文件 ，*浏览器一般不会自动执行或询问执行。浏览器会像对待 设置了HTTP头<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Disposition" target="_blank" rel="noopener noreferrer"><code>Content-Disposition</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 值为 <code>attachment</code> 的文件一样来对待这类文件。</p> <p>第二点：<code>content-disposition</code></p> <p><code>attachment</code>（意味着消息体应该被下载到本地；大多数浏览器会呈现一个“保存为”的对话框，将<code>filename</code>的值预填为下载后的文件名，假如它存在的话）。</p> <p>前端核心代码，主要是处理的逻辑：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 核心代码</span>
axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
	data<span class="token operator">:</span> params<span class="token punctuation">,</span>
	responseType<span class="token operator">:</span> <span class="token string">'arraybuffer'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">resp</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> contentDisposition <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'content-disposition'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> fileName <span class="token operator">=</span> contentDisposition<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token comment">// 创建一个虚拟click标签，触发下载。</span>
	<span class="token keyword">const</span> $link <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> url <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>resp<span class="token punctuation">.</span>data<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
		type<span class="token operator">:</span> <span class="token string">'application/openxmlformats-officedocument.spreadsheetml.sheet;charset=utf-8'</span><span class="token comment">//文件类型,这里是csv</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  $link<span class="token punctuation">.</span>href <span class="token operator">=</span> url<span class="token punctuation">;</span>
	$link<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token string">'_blank'</span><span class="token punctuation">;</span>
	$link<span class="token punctuation">.</span>download <span class="token operator">=</span> fileName<span class="token punctuation">;</span>
	document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>$link<span class="token punctuation">)</span><span class="token punctuation">;</span>
	$link<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>$link<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">revokeObjectURL</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.3bcc0bcc.js" defer></script><script src="/assets/js/2.c5c14eb8.js" defer></script><script src="/assets/js/58.c90127f4.js" defer></script>
  </body>
</html>
