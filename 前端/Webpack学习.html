<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Webpack 学习 | Coda的博客</title>
    <meta name="generator" content="VuePress 1.5.1">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="闲着无聊？那就读书吧">
    <link rel="preload" href="/assets/css/0.styles.c3659042.css" as="style"><link rel="preload" href="/assets/js/app.037033ca.js" as="script"><link rel="preload" href="/assets/js/2.c5c14eb8.js" as="script"><link rel="preload" href="/assets/js/39.a74c60d6.js" as="script"><link rel="prefetch" href="/assets/js/10.53889524.js"><link rel="prefetch" href="/assets/js/11.bded85d3.js"><link rel="prefetch" href="/assets/js/12.bde1e69c.js"><link rel="prefetch" href="/assets/js/13.216bacd3.js"><link rel="prefetch" href="/assets/js/14.2a3abe69.js"><link rel="prefetch" href="/assets/js/15.3d9c6b68.js"><link rel="prefetch" href="/assets/js/16.18276b87.js"><link rel="prefetch" href="/assets/js/17.14218967.js"><link rel="prefetch" href="/assets/js/18.998f2171.js"><link rel="prefetch" href="/assets/js/19.2012aed8.js"><link rel="prefetch" href="/assets/js/20.6509a17b.js"><link rel="prefetch" href="/assets/js/21.72f41dcc.js"><link rel="prefetch" href="/assets/js/22.782c04f8.js"><link rel="prefetch" href="/assets/js/23.181ee4bf.js"><link rel="prefetch" href="/assets/js/24.097bb6e9.js"><link rel="prefetch" href="/assets/js/25.1452f3e8.js"><link rel="prefetch" href="/assets/js/26.a1233076.js"><link rel="prefetch" href="/assets/js/27.4b6663f2.js"><link rel="prefetch" href="/assets/js/28.2b290d01.js"><link rel="prefetch" href="/assets/js/29.f80d4218.js"><link rel="prefetch" href="/assets/js/3.528f2ac2.js"><link rel="prefetch" href="/assets/js/30.e73c5725.js"><link rel="prefetch" href="/assets/js/31.bd920829.js"><link rel="prefetch" href="/assets/js/32.864042c4.js"><link rel="prefetch" href="/assets/js/33.3edc8ef9.js"><link rel="prefetch" href="/assets/js/34.ad325ab1.js"><link rel="prefetch" href="/assets/js/35.b1002ebc.js"><link rel="prefetch" href="/assets/js/36.f2521692.js"><link rel="prefetch" href="/assets/js/37.b6426d8e.js"><link rel="prefetch" href="/assets/js/38.d0a0ee87.js"><link rel="prefetch" href="/assets/js/4.c4955446.js"><link rel="prefetch" href="/assets/js/40.b342667c.js"><link rel="prefetch" href="/assets/js/41.81de64ab.js"><link rel="prefetch" href="/assets/js/42.80b27fdb.js"><link rel="prefetch" href="/assets/js/43.4370c74d.js"><link rel="prefetch" href="/assets/js/44.9715bcb9.js"><link rel="prefetch" href="/assets/js/45.68d22b79.js"><link rel="prefetch" href="/assets/js/46.972dae6d.js"><link rel="prefetch" href="/assets/js/47.14b3927b.js"><link rel="prefetch" href="/assets/js/48.cabec895.js"><link rel="prefetch" href="/assets/js/49.1456c681.js"><link rel="prefetch" href="/assets/js/5.790d3fc0.js"><link rel="prefetch" href="/assets/js/50.5471688c.js"><link rel="prefetch" href="/assets/js/51.b85b96b7.js"><link rel="prefetch" href="/assets/js/52.8037c738.js"><link rel="prefetch" href="/assets/js/53.fe832dc9.js"><link rel="prefetch" href="/assets/js/54.c92dd35c.js"><link rel="prefetch" href="/assets/js/55.db406913.js"><link rel="prefetch" href="/assets/js/56.80434b26.js"><link rel="prefetch" href="/assets/js/57.2652e0b8.js"><link rel="prefetch" href="/assets/js/58.f74654e5.js"><link rel="prefetch" href="/assets/js/59.27ca7e50.js"><link rel="prefetch" href="/assets/js/6.720e350f.js"><link rel="prefetch" href="/assets/js/60.a9d93256.js"><link rel="prefetch" href="/assets/js/61.bea15a28.js"><link rel="prefetch" href="/assets/js/62.838e0a58.js"><link rel="prefetch" href="/assets/js/63.7c78c5b7.js"><link rel="prefetch" href="/assets/js/64.48e36f39.js"><link rel="prefetch" href="/assets/js/65.3a608204.js"><link rel="prefetch" href="/assets/js/66.71f6e06b.js"><link rel="prefetch" href="/assets/js/67.2beb93e9.js"><link rel="prefetch" href="/assets/js/68.67274a5d.js"><link rel="prefetch" href="/assets/js/69.667a0e02.js"><link rel="prefetch" href="/assets/js/7.9f6e7a1c.js"><link rel="prefetch" href="/assets/js/70.5487a9cd.js"><link rel="prefetch" href="/assets/js/71.b538a7ae.js"><link rel="prefetch" href="/assets/js/72.d7a3947f.js"><link rel="prefetch" href="/assets/js/73.4a4ba375.js"><link rel="prefetch" href="/assets/js/74.5b60d7cc.js"><link rel="prefetch" href="/assets/js/75.0de72575.js"><link rel="prefetch" href="/assets/js/76.20533abb.js"><link rel="prefetch" href="/assets/js/77.2739103a.js"><link rel="prefetch" href="/assets/js/78.5c7ecb4e.js"><link rel="prefetch" href="/assets/js/79.a9b54f8a.js"><link rel="prefetch" href="/assets/js/8.c6c4c9d5.js"><link rel="prefetch" href="/assets/js/9.75d01cd2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c3659042.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Coda的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/服务端/" class="nav-link">
  服务端
</a></div><div class="nav-item"><a href="/前端/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/android/" class="nav-link">
  android
</a></div><div class="nav-item"><a href="/DevOps/" class="nav-link">
  devOps
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/服务端/" class="nav-link">
  服务端
</a></div><div class="nav-item"><a href="/前端/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/android/" class="nav-link">
  android
</a></div><div class="nav-item"><a href="/DevOps/" class="nav-link">
  devOps
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Webpack 学习</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#一、基本指南" class="sidebar-link">一、基本指南</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#_1-loader" class="sidebar-link">1. loader</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#_2-plugins" class="sidebar-link">2. plugins</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#devtool-的配置" class="sidebar-link">devtool 的配置</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#webpackdevserver" class="sidebar-link">webpackDevServer</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#babel-配置" class="sidebar-link">babel 配置</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#treeshaking" class="sidebar-link">treeshaking</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#externals" class="sidebar-link">externals</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#output" class="sidebar-link">output</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#resolve" class="sidebar-link">Resolve</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#代码分离-代码分割" class="sidebar-link">代码分离/代码分割</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#shimming-垫片" class="sidebar-link">shimming 垫片</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#打包-library" class="sidebar-link">打包 library</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#打包-typescript" class="sidebar-link">打包 typescript</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#结合-eslint-配置" class="sidebar-link">结合 eslint 配置</a></li></ul></li><li><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#二、案例" class="sidebar-link">二、案例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#项目配置优化" class="sidebar-link">项目配置优化</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#优化打包" class="sidebar-link">优化打包</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#webpack-转化未模块化的-js-库" class="sidebar-link">webpack 转化未模块化的 js 库</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#项目支持-hmr" class="sidebar-link">项目支持 HMR</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#webpackhtmlplugin-打包多页面" class="sidebar-link">WebpackHtmlPlugin 打包多页面</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#create-react-app-支持-hmr" class="sidebar-link">create-react-app 支持 HMR</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#懒加载-lazyloading-preloading-prefetching" class="sidebar-link">懒加载 lazyLoading + preloading + prefetching</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#create-react-app-配置分析" class="sidebar-link">create-react-app 配置分析</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#vue-cl-配置分析" class="sidebar-link">vue-cl 配置分析</a></li></ul></li><li><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#三、原理分析" class="sidebar-link">三、原理分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF/Webpack%E5%AD%A6%E4%B9%A0.html#实现一个简单的-webpack" class="sidebar-link">实现一个简单的 webpack</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="webpack-学习"><a href="#webpack-学习" class="header-anchor">#</a> Webpack 学习</h1> <h2 id="一、基本指南"><a href="#一、基本指南" class="header-anchor">#</a> 一、基本指南</h2> <blockquote><p>什么是 webpack？</p></blockquote> <p>webpack 是一个模块打包工具</p> <p>webpack 的配置文件：webpack.config.js</p> <h3 id="_1-loader"><a href="#_1-loader" class="header-anchor">#</a> 1. loader</h3> <blockquote><h4 id="loader-的作用"><a href="#loader-的作用" class="header-anchor">#</a> loader 的作用</h4> <p>https://webpack.docschina.org/loaders/</p></blockquote> <p>webpack 无法处理.js 后缀之外的文件，所以需要 loader 来进行处理文件。</p> <h4 id="样式处理-loader"><a href="#样式处理-loader" class="header-anchor">#</a> 样式处理 loader</h4> <ul><li><a href="https://webpack.docschina.org/loaders/style-loader" target="_blank" rel="noopener noreferrer"><code>style-loader</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 将 css 模块导出，最终通过<code>&lt;style&gt;</code>标签的形式添加到 DOM 中。</li> <li><a href="https://webpack.docschina.org/loaders/css-loader" target="_blank" rel="noopener noreferrer"><code>css-loader</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 会去解析 @import 和 url() 引入的 CSS 文件，将他们当做 import 和 require 一样去加载进来进行处理。</li> <li><a href="https://webpack.docschina.org/loaders/less-loader" target="_blank" rel="noopener noreferrer"><code>less-loader</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 加载和转译 LESS 文件</li> <li><a href="https://webpack.docschina.org/loaders/sass-loader" target="_blank" rel="noopener noreferrer"><code>sass-loader</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 加载和转译 SASS/SCSS 文件</li> <li><a href="https://webpack.docschina.org/loaders/postcss-loader" target="_blank" rel="noopener noreferrer"><code>postcss-loader</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 使用 <a href="http://postcss.org/" target="_blank" rel="noopener noreferrer">PostCSS<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 加载和转译 CSS/SSS 文件</li> <li><a href="https://github.com/shama/stylus-loader" target="_blank" rel="noopener noreferrer"><code>stylus-loader</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 加载和转译 Stylus 文件</li></ul> <blockquote><h5 id="基础配置"><a href="#基础配置" class="header-anchor">#</a> 基础配置</h5></blockquote> <p>首先，假如项目里用到了最简单的 css，需要配置成如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  test<span class="token operator">:</span> <span class="token regex">/\.(css)$/i</span><span class="token punctuation">,</span>
  use<span class="token operator">:</span> <span class="token punctuation">[</span>
  	<span class="token string">'style-loader'</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      loader<span class="token operator">:</span> <span class="token string">'css-loader'</span><span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
      	modules<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    	<span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><h5 id="小疑问：为什么需要这么多-loader-连起来用？"><a href="#小疑问：为什么需要这么多-loader-连起来用？" class="header-anchor">#</a> 小疑问：为什么需要这么多 loader 连起来用？</h5></blockquote> <p>webpack 一般建议<code>style-loader</code>和<code>css-loader</code>结合使用。我的理解是：<code>css-loader</code>可以对<code>.css后缀</code>的文件进行解析处理，然后交给<code>style-loader</code>编译成对应的 style 样式文件。</p> <p>之前看到过一种配置方案：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex">/\.link\.css$/i</span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span> loader<span class="token operator">:</span> <span class="token string">&quot;style-loader&quot;</span><span class="token punctuation">,</span> options<span class="token operator">:</span> <span class="token punctuation">{</span> injectType<span class="token operator">:</span> <span class="token string">&quot;linkTag&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> loader<span class="token operator">:</span> <span class="token string">&quot;file-loader&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>这种配置方案，css 文件被当做 file 来进行处理，他不会被解析，而是直接通过 style-loader 生成了 style 标签，动态插入到了 dom 里；</p> <blockquote><h5 id="css-loader-importloaders"><a href="#css-loader-importloaders" class="header-anchor">#</a> css-loader#importLoaders</h5></blockquote> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex">/\.css$/i</span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token string">&quot;style-loader&quot;</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            loader<span class="token operator">:</span> <span class="token string">&quot;css-loader&quot;</span><span class="token punctuation">,</span>
            options<span class="token operator">:</span> <span class="token punctuation">{</span>
              importLoaders<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
              <span class="token comment">// 0 =&gt; no loaders (default);</span>
              <span class="token comment">// 1 =&gt; postcss-loader;</span>
              <span class="token comment">// 2 =&gt; postcss-loader, sass-loader</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">&quot;postcss-loader&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;sass-loader&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>importLoaders 这个属性其实挺关键，这里备注一下：他的作用主要是针对样式文件里@import 的样式的处理；</p> <p>当我们在 css 里面@import 了其他样式后，默认是不会被其他 loader 处理的。指定了这个配置后，就会去走其他 loader。</p> <blockquote><h5 id="样式模块化"><a href="#样式模块化" class="header-anchor">#</a> 样式模块化</h5></blockquote> <p>模块化的概念其实就是：各个页面组件里的样式作用域只会在当前模块里起作用，而不会影响到全局样式。这样写样式时就可以放心定义类名。</p> <p>模块化配置首先要在 webpack.config.js 里配置好<code>modules: true</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  test<span class="token operator">:</span> <span class="token regex">/\.(css)$/i</span><span class="token punctuation">,</span>
  use<span class="token operator">:</span> <span class="token punctuation">[</span>
  	<span class="token string">'style-loader'</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      loader<span class="token operator">:</span> <span class="token string">'css-loader'</span><span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
      modules<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其次，引入样式时，需要将样式 import 为一个对象，然后去使用这个的属性。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// import './index.css';</span>
<span class="token keyword">import</span> style <span class="token keyword">from</span> <span class="token string">&quot;./index.css&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> img1 <span class="token operator">=</span> <span class="token function">appendImg</span><span class="token punctuation">(</span>imgPath1<span class="token punctuation">)</span><span class="token punctuation">;</span>
img1<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>avatar<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>可以理解为，如果是模块化，webpack 会将样式处理为一个 js 对象，然后在页面是使用样式就是使用对象的某一个属性。</p> <blockquote><h5 id="预处理框架"><a href="#预处理框架" class="header-anchor">#</a> 预处理框架</h5></blockquote> <p><strong>什么是 CSS 预处理技术？</strong></p> <p>CSS 预处理技术，是指用一种新语言用来为 CSS 增加可编程的的特性，无需考虑浏览器的兼容性问题。你可以在 CSS 中使用变量、简单的程序逻辑、函数等等在编程语言中的一些基本技巧，可以让你的 CSS 更见简洁，适应性更强。</p> <p><strong>Stylus &amp; Less &amp; Sass</strong></p> <p><a href="https://juejin.im/post/5c9b17cbf265da60c95b7c3a#heading-4" target="_blank" rel="noopener noreferrer">Sass、LESS 和 Stylus 区别总结<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>Stylus：提供一个高效、动态、和使用表达方式来生成 CSS，以供浏览器使用。默认使用 .styl 的作为文件扩展名，支持多样性的 CSS 语法。</p> <p>Less：一种动态样式语言，默认使用.less，</p> <p>Sass：一种动态样式语言，默认使用.sass 作为扩展名，也支持.scss 类型。</p> <p>sass 基于严格的语法，是严格要求缩进，而且是不能有<code>{}</code>、<code>;</code>等符号的。</p> <p>scss 就和 css 的写法类似，没有那么严格的要求。</p> <p><strong>CSS 后处理 PostCss</strong></p> <p>PostCSS 是目前流行的一个对 CSS 进行处理的工具（平台）。</p> <p>它负责把 CSS 代码解析成抽象语法树结构（Abstract Syntax Tree，AST），再交由插件来进行处理。插件基于 CSS 代码的 AST 所能进行的操作是多种多样的，比如可以支持变量和混入（mixin），增加浏览器相关的声明前缀，或是把使用将来的 CSS 规范的样式规则转译（transpile）成当前的 CSS 规范支持的格式。</p> <p>从这个角度来说，PostCSS 的强大之处在于其不断发展的插件体系。目前 PostCSS 已经有 200 多个功能各异的插件。开发人员也可以根据项目的需要，开发出自己的 PostCSS 插件。</p> <blockquote><p>postcss-loader</p></blockquote> <p>postcss-loader 专门用来进行 postcss 配置的处理；</p> <p>它可以通过 postcss.config.js 或者 postcss-loader 的 options 来配置 PostCss。附上<a href="https://github.com/postcss/postcss-loader" target="_blank" rel="noopener noreferrer">文档地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <blockquote><h5 id="create-react-app-里用到的样式"><a href="#create-react-app-里用到的样式" class="header-anchor">#</a> create-react-app 里用到的样式</h5></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
      test<span class="token operator">:</span> <span class="token regex">/\.scss$/</span><span class="token punctuation">,</span>
      use<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token comment">// 开发环境使用'style-loader',</span>
          <span class="token comment">// 生产环境使用MiniCssExtractPlugin.loader</span>
          loader<span class="token operator">:</span> MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span>
          options<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          loader<span class="token operator">:</span> <span class="token string">'css-loader'</span><span class="token punctuation">,</span>
          options<span class="token operator">:</span> <span class="token punctuation">{</span>
            importLoaders<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
            modules<span class="token operator">:</span> <span class="token boolean">true</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token comment">// Options for PostCSS as we reference these options twice</span>
          <span class="token comment">// Adds vendor prefixing based on your specified browser support in</span>
          <span class="token comment">// package.json</span>
          loader<span class="token operator">:</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'postcss-loader'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          options<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// Necessary for external CSS imports to work</span>
            <span class="token comment">// https://github.com/facebook/create-react-app/issues/2677</span>
            ident<span class="token operator">:</span> <span class="token string">'postcss'</span><span class="token punctuation">,</span>
            <span class="token function-variable function">plugins</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
              <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'postcss-flexbugs-fixes'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'postcss-preset-env'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                autoprefixer<span class="token operator">:</span> <span class="token punctuation">{</span>
                  flexbox<span class="token operator">:</span> <span class="token string">'no-2009'</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                stage<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token comment">// Adds PostCSS Normalize as the reset css with default options,</span>
              <span class="token comment">// so that it honors browserslist config in package.json</span>
              <span class="token comment">// which in turn let's users customize the target behavior as per their needs.</span>
              <span class="token function">postcssNormalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            sourceMap<span class="token operator">:</span> <span class="token boolean">false</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          loader<span class="token operator">:</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'resolve-url-loader'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          options<span class="token operator">:</span> <span class="token punctuation">{</span>
            sourceMap<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          loader<span class="token operator">:</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'sass-loader'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          options<span class="token operator">:</span> <span class="token punctuation">{</span>
            sourceMap<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      sideEffects<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">CleanWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// Options similar to the same options in webpackOptions.output</span>
      <span class="token comment">// both options are optional</span>
      filename<span class="token operator">:</span> <span class="token string">'static/css/[name].[contenthash:8].css'</span><span class="token punctuation">,</span>
      chunkFilename<span class="token operator">:</span> <span class="token string">'static/css/[name].[contenthash:8].chunk.css'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="文件处理-loader"><a href="#文件处理-loader" class="header-anchor">#</a> 文件处理 loader</h4> <blockquote><h4 id="file-loader-vs-url-loader"><a href="#file-loader-vs-url-loader" class="header-anchor">#</a> file-loader vs url-loader</h4></blockquote> <p>url-loader 可以把图片打包到 js 文件里去，以 base64 的格式来存放。</p> <p>file-loader 是把图片独立打包出来，形成静态资源。当然 file-loader 还可以处理字体 otf、svg 等后缀的静态资源。</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token operator">:</span> <span class="token punctuation">{</span>
  rules<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      test<span class="token operator">:</span> <span class="token regex">/\.(png|jpe?g)$/i</span><span class="token punctuation">,</span>
      use<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          loader<span class="token operator">:</span> <span class="token string">&quot;url-loader&quot;</span><span class="token punctuation">,</span>
          options<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// 10kb;</span>
            limit<span class="token operator">:</span> <span class="token number">10240</span><span class="token punctuation">,</span>
            name<span class="token operator">:</span> <span class="token string">&quot;[name].[ext]?[contenthash]&quot;</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token comment">/*{
            test: /\.(png|jpe?g)$/i,
            use: [{
                loader: 'file-loader',
                options: {
                    name: '[name].[ext]?[contenthash]',
                    publicPath: '/some/path/',
                    outputPath: '/some/path/',
                    postTransformPublicPath: (p) =&gt; `__webpack_public_path__ + ${p}`,
                }
            }]
        }*/</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>url-loader 有一个==limit==的 options 可以配置。当图片超过了 limit 的大小，就不会将图片转化为 base64, 默认会使用 file-loader 进行处理。但是这里有一个容易进入的误区：我之前以为需要配置再配置一个 file-loader，让 url-loader 去执行 file-loader 的配置。实际上不需要再单独配置一个 file-loader，url-loader 自带了 file-loader 各个配置。</p> <p>####如何编写一个 loader？</p> <p>编写 loader 其实很简单，只需要要返回一个 function，接收 source 参数即可。</p> <p>webpack 会去在执行这个 function 时，会将代码通过 source 参数传递进来，同事将 this 变量内置很多参数和方法，开发者只需要通过 this 对象来对 source 进行处理。</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// todo 处理source</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>编写好 loader 后怎么使用？</p> <p>在 webpack 里面指明需要使用的 loader 路径。</p> <div class="language-diff extra-class"><pre class="language-diff"><code>module: {
<span class="token unchanged">    rules: [
      {
        test: /\.js$/,
        exclude: /node_modules/,
        use: 'babel-loader',
</span><span class="token deleted-sign deleted">-     }
</span><span class="token inserted-sign inserted">+     },
+     {
+        test: /\.js$/,
+        exclude: /node_modules/,
+        use: path.resolve(__dirname, 'src/loader/my-loader.js'),
+     }
</span><span class="token unchanged">    ],
  },
</span></code></pre></div><h3 id="_2-plugins"><a href="#_2-plugins" class="header-anchor">#</a> 2. plugins</h3> <h4 id="plugins-的作用"><a href="#plugins-的作用" class="header-anchor">#</a> plugins 的作用</h4> <p>plugins 可以帮助 webpack，在打包的不同生命周期中，做不同的处理；</p> <p>比如在打包之前，做清空处理，使用<code>CleanWebpackPlugin</code>。</p> <h4 id="常用插件"><a href="#常用插件" class="header-anchor">#</a> <a href="./webpack%E5%B8%B8%E7%94%A8plugins">常用插件</a></h4> <h4 id="怎么写-plugins？"><a href="#怎么写-plugins？" class="header-anchor">#</a> 怎么写 plugins？</h4> <blockquote><p>https://www.webpackjs.com/contribute/writing-a-plugin/</p></blockquote> <blockquote><p>plugin 基本架构</p></blockquote> <ol><li>编写一个函数，在函数原型上提供<code>apply方法</code>。</li> <li><code>apply方法</code>接收一个<code>compiler</code>对象，通过 compiler 的钩子函数来实现各种功能。</li> <li>通过<code>compiler</code>的钩子函数来实现各种功能。</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">MyWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token class-name">MyWebpackPlugin</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">apply</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;done&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;stats&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> MyWebpackPlugin<span class="token punctuation">;</span>
</code></pre></div><ol start="3"><li>在 webpack.config.js 中使用该插件：</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> MyWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./MyWebpackPlugin.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>export <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
	plugins<span class="token operator">:</span><span class="token punctuation">[</span>
		<span class="token keyword">new</span> <span class="token class-name">MyWebpackPlugin</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token operator">...</span>
	<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="compiler-和-compiler-钩子"><a href="#compiler-和-compiler-钩子" class="header-anchor">#</a> compiler 和 compiler 钩子</h5> <ul><li><code>compiler</code> 对象代表了完整的 webpack 环境配置。这个对象在启动 webpack 时被一次性建立，并配置好所有可操作的设置，包括 options，loader 和 plugin。当 webpack 调用插件时，会把这个 compiler 对象传给 plugin 的 apply 方法。</li></ul> <p>compiler 里面有很多钩子函数，表示有很多时刻。比如<code>emit</code>会在生成资源到 output 目录之前触发，而且是一个异步的钩子；</p> <blockquote><p>钩子的调用方式：</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code>compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>someHook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
</code></pre></div><p>不同的钩子类型调用的方式也不一样，也可以在某些钩子上访问 <code>tapAsync</code> 和 <code>tapPromise</code>。</p> <blockquote><p>3 种 tap 的理解</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code>compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;emit&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;资源要被打包了.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>run<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">&quot;run&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;以异步方式触及 run 钩子。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 需要callback</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>run<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">&quot;MyWebpackPlugin&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;以具有延迟的异步方式触及 run 钩子。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>run<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">&quot;MyWebpackPlugin&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;以具有延迟的异步方式触及 run 钩子。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="compilation-和-compilation-hooks"><a href="#compilation-和-compilation-hooks" class="header-anchor">#</a> compilation 和 compilation hooks</h5> <ul><li><code>compilation</code> 对象代表了一次资源版本构建。</li> <li>webpack 基于模块的，模块经历 loaded，sealed，optimized， chunked，hashed，restored。每次文件变化时，webpack 重新创建一个 compilation 对象。</li> <li>一个 compilation 对象表现了当前的模块资源、编译生成资源、变化的文件、以及被跟踪依赖的状态信息。</li></ul> <h5 id="plugins-调试"><a href="#plugins-调试" class="header-anchor">#</a> plugins 调试</h5> <blockquote><p>chrome 来调试</p></blockquote> <p>从 Node v6.3.0+ 开始，开发人员可以使用内置的 <code>--inspect</code> 标记，来通过 DevTools 调试 Node.js 应用程序。</p> <p>先打开 chrome 的 expirement 模式 chrome://flags/#enable-devtools-experiments.</p> <p>2.开启模式后，在 setting 里开启 nodejs 的调试，似乎高级版本的 chrome 不需要上面这 2 步。</p> <p>3.最后在 package.json 里面配置命令如下：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;debug&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node --inspect --inspect-brk ./node_modules/webpack/bin/webpack.js&quot;</span>
</code></pre></div><h3 id="devtool-的配置"><a href="#devtool-的配置" class="header-anchor">#</a> devtool 的配置</h3> <blockquote><p>参考博客 https://juejin.im/post/58293502a0bb9f005767ba2f</p></blockquote> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-01-08-230716.png" alt="image-20191230202323229"></p> <blockquote><h4 id="最佳实践"><a href="#最佳实践" class="header-anchor">#</a> 最佳实践</h4></blockquote> <p>开发环境：cheap-module-eval-source-map</p> <p>线上环境：cheap-module-source-map</p> <blockquote><h4 id="几个-mode-配置的比较"><a href="#几个-mode-配置的比较" class="header-anchor">#</a> 几个 mode 配置的比较</h4></blockquote> <p><strong>source-map</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// import style from './index.css';</span>

<span class="token keyword">const</span> img1 <span class="token operator">=</span> <span class="token function">Object</span><span class="token punctuation">(</span>_appendImg__WEBPACK_IMPORTED_MODULE_2__<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_images_avatar_jpeg__WEBPACK_IMPORTED_MODULE_0__<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// img1.classList.add(style.avatar);</span>
<span class="token keyword">const</span> img2 <span class="token operator">=</span> <span class="token function">Object</span><span class="token punctuation">(</span>_appendImg__WEBPACK_IMPORTED_MODULE_2__<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_images_test_png__WEBPACK_IMPORTED_MODULE_1__<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

consele<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>img2<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">/***/</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">/******/</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//# sourceMappingURL=main.js.map</span>
</code></pre></div><p>打包代码的同时生成一个 sourcemap 文件，并在打包文件的末尾添加<code>//# souceURL</code>，注释会告诉 JS 引擎原始文件位置。</p> <div class="language- extra-class"><pre class="language-text"><code>{
  &quot;version&quot;: 3,
  &quot;sources&quot;: [
    &quot;webpack:///webpack/bootstrap&quot;,
    &quot;webpack:///./src/index.css&quot;,
    &quot;webpack:///./node_modules/style-loader/dist/runtime/injectStylesIntoLinkTag.js&quot;,
    &quot;webpack:///./src/appendImg.js&quot;,
    &quot;webpack:///./src/images/avatar.jpeg&quot;,
    &quot;webpack:///./src/images/test.png&quot;,
    &quot;webpack:///./src/index.css?b1aa&quot;,
    &quot;webpack:///./src/index.js&quot;
  ],
  &quot;names&quot;: [],
  &quot;mappings&quot;: &quot;;xxxx&quot;,
  &quot;file&quot;: &quot;main.js&quot;,
  &quot;sourcesContent&quot;: [xxxxxxx],
  &quot;sourceRoot&quot;: &quot;&quot;
}
</code></pre></div><p><strong>hidden-source-map</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// import style from './index.css';</span>
<span class="token keyword">const</span> img1 <span class="token operator">=</span> <span class="token function">Object</span><span class="token punctuation">(</span>_appendImg__WEBPACK_IMPORTED_MODULE_2__<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_images_avatar_jpeg__WEBPACK_IMPORTED_MODULE_0__<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// img1.classList.add(style.avatar);</span>
<span class="token keyword">const</span> img2 <span class="token operator">=</span> <span class="token function">Object</span><span class="token punctuation">(</span>_appendImg__WEBPACK_IMPORTED_MODULE_2__<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_images_test_png__WEBPACK_IMPORTED_MODULE_1__<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
consele<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>img2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/***/</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">/******/</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>去除了末尾的<code>//# souceURL</code></p> <p><strong>inline-source-map</strong></p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-12-30-233220.png" alt="image-20191231073219616" style="zoom:40%;"> <p><strong>eval</strong></p> <div class="language- extra-class"><pre class="language-text"><code>webpackJsonp([1],[
  function(module,exports,__webpack_require__){
    eval(
      ...
      //# sourceURL=webpack:///./src/js/index.js?'
    )
  },
  function(module,exports,__webpack_require__){
    eval(
      ...
      //# sourceURL=webpack:///./src/static/css/app.less?./~/.npminstall/css-loader/0.23.1/css-loader!./~/.npminstall/postcss-loader/1.1.1/postcss-loader!./~/.npminstall/less-loader/2.2.3/less-loader'
    )
  },
  function(module,exports,__webpack_require__){
    eval(
      ...
      //# sourceURL=webpack:///./src/tmpl/appTemplate.tpl?&quot;
    )
  },
...])
</code></pre></div><p><strong>eval-source-map</strong></p> <div class="language- extra-class"><pre class="language-text"><code>webpackJsonp([1],[
  function(module,exports,__webpack_require__){
    eval(
      ...
      //# sourceMappingURL=data:application/json;charset=utf-8;base64,...
    )
  },
  function(module,exports,__webpack_require__){
    eval(
      ...
      //# sourceMappingURL=data:application/json;charset=utf-8;base64,...
    )
  },
  function(module,exports,__webpack_require__){
    eval(
      ...
      //# sourceMappingURL=data:application/json;charset=utf-8;base64,...
    )
  },
  ...
]);
</code></pre></div><p>eval-source-map 和 eval 的区别在于，source-map 将注释里面的内容换成了 dataurl.</p> <p><strong>cheap-source-map</strong></p> <p><strong>cheap-module-source-map</strong></p> <p>网上说 module 会带上 loader 的源码，但是我比较过两个的结果，并没有什么不同。可能是我代码本身没什么需要 loader 转化的。 后期再比较这个。</p> <p><strong>总结</strong></p> <p>source-map：打包错误提示信息最全；</p> <p>inline-source-map：是将源码合并到打包文件中去，以 DataUrl 的形式写到打包文件里；</p> <p>cheap-source-map 的意思是生成一个没有列信息的 sourceMap 文件，只会告诉哪一行出错，而不会告诉是哪一列出错。而且不包含 loader 的 sourcemap</p> <p>module：的意思是，会打包那些被 loader 加载的模块源码，不加 module 只会处理业务逻辑代码；</p> <p>eval：打包后模块会通过 eval 的方式来执行，速度最快；</p> <h4 id="todo-sourcemap-原理"><a href="#todo-sourcemap-原理" class="header-anchor">#</a> //todo SourceMap 原理</h4> <h3 id="webpackdevserver"><a href="#webpackdevserver" class="header-anchor">#</a> webpackDevServer</h3> <blockquote><h4 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h4></blockquote> <div class="language- extra-class"><pre class="language-text"><code>npm install --save-dev webpack-dev-server
</code></pre></div><blockquote><h4 id="contentbase"><a href="#contentbase" class="header-anchor">#</a> contentBase</h4></blockquote> <p>告诉服务器，从哪里去读取静态文件。它和<code>publicPath</code>的区别是,<code>publicPath</code>用于确定从哪里提供 bundler。默认情况下，使用当前工作目录作为提供内容的目录。</p> <p>可以修改为其他目录：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 推荐使用绝对路径</span>
contentBase<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;public&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>也可以从多个目录提供内容：</p> <div class="language-js extra-class"><pre class="language-js"><code>contentBase<span class="token operator">:</span> <span class="token punctuation">[</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;public&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;assets&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>禁用 contentBase：</p> <div class="language-js extra-class"><pre class="language-js"><code>contentBase<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="devserver-一些常用配置项"><a href="#devserver-一些常用配置项" class="header-anchor">#</a> devServer 一些常用配置项</h4> <h4 id="devserver-proxy-代理配置"><a href="#devserver-proxy-代理配置" class="header-anchor">#</a> devServer.proxy 代理配置</h4> <div class="language- extra-class"><pre class="language-text"><code>devServer: {
    proxy: {
      '/api': 'http://localhost:3000'
    }
  }
</code></pre></div><p><code>/api/users</code>会被代理到<code>http://localhost:3000/api/users</code></p> <blockquote><h5 id="如果想要重写路径"><a href="#如果想要重写路径" class="header-anchor">#</a> 如果想要重写路径</h5></blockquote> <div class="language- extra-class"><pre class="language-text"><code>devServer: {
  proxy: {
    '/api': {
    target: 'http://localhost:3000',
  	pathRewrite: {'^/api' : ''}
  	}
	}
}
</code></pre></div><p><code>/api/users</code>会被代理到<code>http://localhost:3000/users</code></p> <blockquote><p>如果不是所有都代理，可以传一个 function</p></blockquote> <ul><li>返回 null 或者 undefined 会继续通过代理</li> <li>返回 false 会直接 404</li> <li>返回一个路径，会当做<code>express server</code>来直接返回.</li></ul> <blockquote><h5 id="踩坑：405-错误"><a href="#踩坑：405-错误" class="header-anchor">#</a> 踩坑：405 错误</h5></blockquote> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-01-08-230717.png" alt="image-20191227140841502"></p> <p>proxy 配置的优先级默认是从上往下的，只要上面的 proxy 匹配上了请求规则，就不会继续向下找了。即使下面的匹配更完全。</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2019-12-27-230628.png" alt="image-20191228070627938" style="zoom:30%;"> <p>图 1 出现的问题就是因为我们把配置写成了 123 的顺序。导致/ajax/api 的请求全部代理到了 www。改成 321 的顺序即可。</p> <h4 id="热重载-live-reload-和热更新-hmr"><a href="#热重载-live-reload-和热更新-hmr" class="header-anchor">#</a> 热重载 live reload 和热更新 HMR</h4> <blockquote><p>1.概念介绍</p></blockquote> <p><strong>热重载</strong>是当代码更新时，webpack 自动编译并且刷新页面，这样不用开发者自己手动刷新页面。但是也带来一个问题：页面的状态会丢失。</p> <p><strong>热更新</strong>可以动态更新代码，浏览器不会进行刷新页面，而是运行时对模块进行热替换，保证了应用状态不会丢失。</p> <blockquote><p>2.原理</p> <p>https://juejin.im/post/5e3a28e6e51d4526f76ea753?utm_source=gold_browser_extension</p> <p>https://zhuanlan.zhihu.com/p/30669007</p> <p>最简版本的 hmr</p> <p>https://github.com/Jocs/webpack-HMR-demo/blob/master/webpack.config.js</p></blockquote> <p><strong>更新流程</strong>：</p> <ol><li><p>应用程序要求 HMR runtime 检查更新</p></li> <li><p>HMR runtime 异步下载更新</p></li> <li><p>HMR runtime 应用更新</p></li> <li><p>HMR 同步应用更新</p></li></ol> <p><strong>内部原理</strong>:</p> <p>webpack 监听着文件的变化。当我们修改文件时，webpack-dev-server 通过 webpack-dev-middleware 拿到了 webpack 各个生命周期的打包文件，并且生成 socketjs 的长连接来推送到 webpack-dev-server/client(浏览器客户端)。客户端拿到这些更新文件，通过 webpack/hot/dev-server 来判断是进行何种模式的更新。</p> <p>HMR runtime 是整个 HMR 的中区，它接收到更新的消息后，它接收到上一步传递给他的新模块的 hash 值，它通过 JsonpMainTemplate.runtime 向 server 端发送 Ajax 请求，服务端返回一个 json，该 json 包含了所有要更新的 chunk 模块的 hash 值，获取到更新列表后，该模块再次通过 jsonp 请求，获取到最新的模块代码，并且将这些模块进行更新。这就是图中 7、8、9 步骤。</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-02-07-104221.jpg" alt="preview" style="zoom:50%;"> <blockquote><p>开启 HMR 的配置</p></blockquote> <ol><li>通过 webpack 配置文件开启 hmr 设置</li></ol> <p>在 devServer 里配置 hot:true，来让 Webpack-dev-server 支持 hot 模式。</p> <div class="language-diff extra-class"><pre class="language-diff"><code>devServer: {
	contentBase: './dist',
<span class="token inserted-sign inserted">+	hot: true,
</span>},
plugins: [
	new CleanWebpackPlugin(),
	new HtmlWebpackPlugin({
		template: './src/index.html'
	}),
	// 这个是关键
<span class="token inserted-sign inserted">+	new webpack.HotModuleReplacementPlugin(),
</span>]
</code></pre></div><p>需要注意的是，并不是配置了 hmr 前端就能看到效果了，还需要实现对应的<a href="https://webpack.docschina.org/api/hot-module-replacement" target="_blank" rel="noopener noreferrer">api 接口<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>好在有很多 plugin 和 loader 都帮助我们解决了这些问题，比如 vue-loader.</p> <ol start="2"><li>还有一种开启方式，这种方式不需要依赖 webpack-dev-server, 而是通过自己写 server 设置。</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1.首先要在output里定义好webpack-hot-middleware/client</span>
entry<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token string">'webpack-hot-middleware/client?path=/__webpack_hmr&amp;timeout=20000'</span><span class="token punctuation">,</span>
  <span class="token comment">// 这是主入口</span>
  <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token comment">// 2.并且保留HotModuleReplacementPlugin</span>
plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
	<span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>HotModuleReplacementPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token comment">// 3.新建一个server.js</span>
<span class="token comment">// 通过nodejs的方式，实现一个devServer</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> webpackHotMiddleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-hot-middleware'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> webpackDevMiddleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-dev-middleware'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> compiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">webpackDevMiddleware</span><span class="token punctuation">(</span>compiler<span class="token punctuation">,</span> <span class="token punctuation">{</span>
	publicPath<span class="token operator">:</span> config<span class="token punctuation">.</span>output<span class="token punctuation">.</span>publicPath<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
	log<span class="token operator">:</span> console<span class="token punctuation">.</span>log<span class="token punctuation">,</span>
	path<span class="token operator">:</span> <span class="token string">'/__webpack_hmr'</span><span class="token punctuation">,</span>
	heartbeat<span class="token operator">:</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 通过hotMiddleware</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">webpackHotMiddleware</span><span class="token punctuation">(</span>compiler<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Example app listening on port 3000!\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>以上两种方式就可以开启一个基础的 hmr 了。</p> <blockquote><p>接受 updated module。</p></blockquote> <p>index.js</p> <div class="language-diff extra-class"><pre class="language-diff"><code><span class="token unchanged">  import _ from 'lodash';
  import printMe from './print.js';
</span>
<span class="token unchanged">  function component() {
    var element = document.createElement('div');
    var btn = document.createElement('button');
</span>
<span class="token unchanged">    element.innerHTML = _.join(['Hello', 'webpack'], ' ');
</span>
<span class="token unchanged">    btn.innerHTML = 'Click me and check the console!';
    btn.onclick = printMe;
</span>
<span class="token unchanged">    element.appendChild(btn);
</span>
<span class="token unchanged">    return element;
  }
</span>
<span class="token unchanged">  document.body.appendChild(component());
</span><span class="token inserted-sign inserted">+
+ if (module.hot) {
+   module.hot.accept('./print.js', function() {
+     console.log('Accepting the updated printMe module!');
+     printMe();
+   })
+ }
</span></code></pre></div><h4 id="hmr-加载样式"><a href="#hmr-加载样式" class="header-anchor">#</a> HMR 加载样式</h4> <p>借助于 <code>style-loader</code>，使用模块热替换来加载 CSS 实际上极其简单。此 loader 在幕后使用了 <code>module.hot.accept</code>，在 CSS 依赖模块更新之后，会将其 patch(修补) 到 <code>&lt;style&gt;</code> 标签中。</p> <h3 id="babel-配置"><a href="#babel-配置" class="header-anchor">#</a> babel 配置</h3> <p><code>@babel/preset-env</code>是用来将代码转化为 es5 的语法</p> <blockquote><p><code>@babel/polyfill</code>和<code>@babel/transform-runtime</code>的区别</p></blockquote> <p>Babel 里用到了一些公共的帮助函数<code>_extend</code>.默认情况下，它会被加到每一个需要他的函数里。这会导致大量的重复代码；</p> <p>如果直接引入<code>@babel/polyfill</code>,会导致一些内置的变量比如： <code>Promise</code>, <code>Set</code> and <code>Map</code>会污染到全局变量。 如果最终打包的应用是在浏览器里运行的，那么是可以接受的。但是如果打包出来的是 lib 库给别人使用的，那么会造成问题。</p> <p>而<code>@babel/transform-runtime</code>里的 transformer 不同，首先它引用了<code>@babel/runtime</code>模块，避免打包生产重复代码，其次他和 core-js 无缝结合，所以不需要而外引入 polyfill，也就不会造成全局变量污染；</p> <p><strong>总结</strong></p> <p>如果是写业务码，最终要在浏览器里运行的。那么在 webpack 里配置<code>preset-env</code>，同事在代码里引入@babel/polyfill 就行了；</p> <p>但是如果是写的 lib 库，最后打包成第三方类库的代码，要使用@babel/plugin-transform-runtime 进行转化。corejs 的选项一般选 2；</p> <table><thead><tr><th><code>corejs</code> option</th> <th>Install command</th></tr></thead> <tbody><tr><td><code>false</code></td> <td><code>npm install --save @babel/runtime</code></td></tr> <tr><td><code>2</code></td> <td><code>npm install --save @babel/runtime-corejs2</code></td></tr> <tr><td><code>3</code></td> <td><code>npm install --save @babel/runtime-corejs3</code></td></tr></tbody></table> <h3 id="treeshaking"><a href="#treeshaking" class="header-anchor">#</a> treeshaking</h3> <blockquote><p>配置作用</p></blockquote> <p>treeshaking 的主要作用是将那些在代码里并没有使用到的方法不要打包进来；用官方的生动形象的例子来解释：</p> <p>不用的代码就如同秋天棕色、死亡的叶子，需要摇树才能让树叶掉落下来；</p> <blockquote><p>配置步骤</p></blockquote> <ul><li><p>首先，treeshaking 只支持 esmodule 的 import 模式。</p></li> <li><p>第一步，如果 mode 是 development 模式，在 webpack 里增加 optimization 的配置；</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>mode<span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
devtool<span class="token operator">:</span> <span class="token string">'cheap-module-eval-source-map'</span><span class="token punctuation">,</span>
optimization<span class="token operator">:</span> <span class="token punctuation">{</span>
	usedExports<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>第二步，在 package.json 里配置<code>sideEffects</code>。 <code>sideEffects</code>里配置的内容代表的意思是，不需要进行 treeshaking 处理；</p> <p>一般比如 css 文件、第三方依赖文件是不需要处理的</p></li></ul> <h3 id="externals"><a href="#externals" class="header-anchor">#</a> externals</h3> <blockquote><p>配置作用</p></blockquote> <p>防止打包的时候将 import 的组件打包到 bundle 里，而是在运行时(<code>runtime</code>)再去外部获取这些扩展依赖；</p> <p>比如，我从 cdn 引入了 jquery，而不是把它打包到我的代码里。</p> <blockquote><p>配置实例</p></blockquote> <p><strong>index.html</strong></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span>
  <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>https://code.jquery.com/jquery-3.1.0.js<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">integrity</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>sha256-slogkvB1K3VOkzAI8QITxV3VzpOnkeNVsKvtkYLMjfk=<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>anonymous<span class="token punctuation">&quot;</span></span>
<span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>webpack.config.js</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>externals<span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token string">'jquery'</span><span class="token operator">:</span> <span class="token string">'jQuery'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>然后下面展示的代码还可以正常运行：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">'jquery'</span><span class="token punctuation">;</span>

<span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.my-element'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">animate</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>比较一下配置前后的打包大小：</p> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-01-12-003641.png" alt="image-20200112083641020" style="zoom:30%;float:left;"> <img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-01-12-003903.png" alt="image-20200112083902471" style="zoom:30%;float:left;"> <blockquote><p>配置语法</p></blockquote> <p><strong>string</strong> 可以配置成一个字符串的形式</p> <div class="language-js extra-class"><pre class="language-js"><code>externals<span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token string">'./a'</span><span class="token operator">:</span> <span class="token string">'a'</span><span class="token punctuation">,</span>
   jquery<span class="token operator">:</span> <span class="token string">'jQuery'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>解读一下属性：</p> <p>第一行：'./a'代表应该排除<code>import a from './a'</code>，然后需要提供一个全局的<code>a</code>变量；</p> <p>第二行：表示应该排除<code>import $ from 'jquery'</code>中的 <code>jquery</code>模块。为了替换这个模块，<code>jquery</code>的值将被用来检索一个全局的<code>jQuery</code>变量。</p> <p>换句话说，当设置为一个字符串时，它将被视为<strong>全局的</strong>，我们需要在全局变量中，找到这个字符串，才能使程序正确运行。</p> <p>也就是说，需要有一个 window.jQuery，才能正确使用。</p> <p><strong>Object</strong> 也可以配置成对象的形式</p> <blockquote><p>外部依赖的形式</p></blockquote> <ul><li><p><strong>root</strong>：可以通过一个全局变量访问 library（例如，通过 script 标签）</p></li> <li><p><strong>commonjs</strong>：意思是可以通过 commonjs 的访问来访问我这个 library，但是必须是要用我的名字来使用。</p> <p>举个例子：</p> <div class="language-json extra-class"><pre class="language-json"><code>externals<span class="token operator">:</span> <span class="token punctuation">{</span>
	lodash<span class="token operator">:</span> <span class="token punctuation">{</span>
		commonjs<span class="token operator">:</span> 'lodash'
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里可以用 CommonJS 模块访问我的 library，但是你必须是<code>const lodash = require('lodash')</code>这种写法。</p></li> <li><p><strong>commonjs2</strong>：和上面的类似，但导出的是 <code>module.exports.default</code></p></li> <li><p><strong>amd</strong>：类似于 <code>commonjs</code>，但使用 AMD 模块系统</p></li></ul> <p>结合着<a href="#output">output</a>属性来配置。</p> <h3 id="output"><a href="#output" class="header-anchor">#</a> output</h3> <blockquote><p>配置作用</p></blockquote> <p>output 用来告知 webpack 如何去输出、以及在哪里输出你的「bundle、asset 和其他你所打包或使用 webpack 载入的任何内容。</p> <h4 id="output-publicpath"><a href="#output-publicpath" class="header-anchor">#</a> <code>output.publicPath</code></h4> <p>这个配置的主要作用是，修改 webpack 打包文件的输出目录。</p> <p>默认是'';</p> <p>如果配置了路径，那么所有的资源都会以这个路径为 basePath 进行访问。</p> <p>比如，配置了’assets‘, 那么 url 资源路径就是/assets/url。</p> <p>==不知道你在干嘛就别配置这个东西，不然资源会 404 的==</p> <p>简单规则如下：<a href="https://webpack.docschina.org/configuration/output/#output-path" target="_blank" rel="noopener noreferrer"><code>output.path</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中的 URL 以 HTML 页面为基准。</p> <p><strong>webpack.config.js</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;public/assets&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    publicPath<span class="token operator">:</span> <span class="token string">&quot;https://cdn.example.com/assets/&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>对于这个配置：</p> <p><strong>webpack.config.js</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    publicPath<span class="token operator">:</span> <span class="token string">&quot;/assets/&quot;</span><span class="token punctuation">,</span>
    chunkFilename<span class="token operator">:</span> <span class="token string">&quot;[id].chunk.js&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>对于一个 chunk 请求，看起来像这样 <code>/assets/4.chunk.js</code>。</p> <p>对于一个输出 HTML 的 loader 可能会像这样输出：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/assets/spinner.gif<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><p>或者在加载 CSS 的一个图片时：</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>/assets/spinner.gif<span class="token punctuation">)</span></span><span class="token punctuation">;</span>
</code></pre></div><p>webpack-dev-server 也会默认从 <code>publicPath</code> 为基准，使用它来决定在哪个目录下启用服务，来访问 webpack 输出的文件。</p> <h3 id="resolve"><a href="#resolve" class="header-anchor">#</a> Resolve</h3> <h3 id="代码分离-代码分割"><a href="#代码分离-代码分割" class="header-anchor">#</a> 代码分离/代码分割</h3> <blockquote><h4 id="概念介绍"><a href="#概念介绍" class="header-anchor">#</a> 概念介绍</h4></blockquote> <p>代码分割: 将代码分离到不同的 bundle 里，然后按需进行加载。</p> <p>代码分离可以用于获取更小的 bundle，以及控制资源加载优先级，如果使用合理，会极大影响加载时间。</p> <blockquote><h4 id="常用方法"><a href="#常用方法" class="header-anchor">#</a> 常用方法</h4></blockquote> <p>三种常用的代码分离方法：</p> <ul><li>入口起点：使用 <a href="https://www.webpackjs.com/configuration/entry-context" target="_blank" rel="noopener noreferrer"><code>entry</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 配置手动地分离代码。</li> <li>防止重复：使用 <a href="https://www.webpackjs.com/plugins/commons-chunk-plugin" target="_blank" rel="noopener noreferrer"><code>CommonsChunkPlugin</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 去重和分离 chunk。</li> <li>动态导入：通过模块的内联函数调用来分离代码。</li></ul> <blockquote><h4 id="插件使用-splitchunkplugin-vs-commonschunkplugin"><a href="#插件使用-splitchunkplugin-vs-commonschunkplugin" class="header-anchor">#</a> 插件使用 <code>SplitChunkPlugin</code> VS <code>CommonsChunkPlugin</code></h4></blockquote> <p>CommonsChunkPlugin 能够将公共用模块统一抽取出来，形成一个新的 common 块。最终合成的文件能够在最开始的时候加载一次，便存到缓存中供后续使用。这个带来速度上的提升，因为浏览器会迅速将公共的代码从缓存中取出来，而不是每次访问一个新页面时，再去加载一个更大的文件。</p> <p>但是<strong>CommonsChunkPlugin 的痛，在于只能统一抽取模块到父模块，造成父模块过大，不易于优化</strong>。</p> <p>==从 webpack4 开始，自带了<code>SplitChunkPlugin</code>插件将代码进行，替代了<code>CommonsChunkPlugin</code>。==</p> <p><code>SplitChunksPlugin</code>它能够抽出懒加载模块之间的公共模块，并且不会抽到父级，而是会与首次用到的懒加载模块并行加载，这样我们就可以放心的使用懒加载模块了。</p> <blockquote><h4 id="splitchunkplugin介绍"><a href="#splitchunkplugin介绍" class="header-anchor">#</a> <code>SplitChunkPlugin</code>介绍</h4> <p>https://medium.com/webpack/webpack-4-code-splitting-chunk-graph-and-the-splitchunks-optimization-be739a861366</p></blockquote> <p>webpack 自带了一个 optimization 的配置项，里面可以手动配置符合自己项目情况的优化项。</p> <p>先介绍一下默认情况下，SplitChunkPlugin 的分割策略。</p> <hr> <p>情况 A:</p> <p><code>chunk-a</code>: react, react-dom, some components</p> <p><code>chunk-b</code>: react, react-dom, some other components</p> <p><code>chunk-c</code>: angular, some components</p> <p><code>chunk-d</code>: angular, some other components</p> <hr> <p>webpack 自动生成下面 2 个 vendor:</p> <p><code>vendors~chunk-a~chunk-b</code>: react, react-dom</p> <p><code>vendors~chunk-c~chunk-d</code>: angular</p> <p><code>chunk-a</code> to <code>chunk-d</code>: Only the components</p> <p>情况 B:</p> <hr> <p><code>chunk-a</code>: react, react-dom, some components</p> <p><code>chunk-b</code>: react, react-dom, lodash, some other components</p> <p><code>chunk-c</code>: react, react-dom, lodash, some components</p> <p>webpack 同样创建 2 个 vendors</p> <p><code>vendors~chunk-a~chunk-b~chunk-c</code>: react, react-dom</p> <p><code>vendors~chunk-b~chunk-c</code>: lodash</p> <p><code>chunk-a</code> to <code>chunk-c</code>: Only the components</p> <p>情况 C:</p> <hr> <p><code>chunk-a</code>: vue, some components, some shared components</p> <p><code>chunk-b</code>: vue, some other components, some shared components</p> <p><code>chunk-c</code>: vue, some more components, some shared components</p> <p>j 假设 shared components 超过 30kb, webpack 创建一个 vendors chunk 和 一个 commons chunk、</p> <p><code>vendors~chunk-a~chunk-b~chunk-c</code>: vue</p> <p><code>commons~chunk-a~chunk-b~chunk-c</code>: some shared components</p> <p><code>chunk-a</code> to <code>chunk-c</code>: Only the components</p> <p>情况 D:</p> <hr> <p><code>chunk-a</code>: react, react-dom, some components, some shared react components</p> <p><code>chunk-b</code>: react, react-dom, angular, some other components</p> <p><code>chunk-c</code>: react, react-dom, angular, some components, some shared react components, some shared angular components</p> <p><code>chunk-d</code>: angular, some other components, some shared angular components</p> <p>webpack 会创建 2 个 vendors chunks 和 2 个 commons chunks</p> <p><code>vendors~chunk-a~chunk-b~chunk-c</code>: react, react-dom</p> <p><code>vendors~chunk-b~chunk-c~chunk-d</code>: angular</p> <p><code>commons~chunk-a~chunk-c</code>: some shared react components</p> <p><code>commons~chunk-c~chunk-d</code>: some shared angular components</p> <p><code>chunk-a</code> to <code>chunk-d</code>: Only the components</p> <p>同步分割就主要依赖于<code>webpack.optimization.splitChunks</code>这一配置项。</p> <div class="language-js extra-class"><pre class="language-js"><code> optimization<span class="token operator">:</span> <span class="token punctuation">{</span>
		splitChunks<span class="token operator">:</span> <span class="token punctuation">{</span>
			chunks<span class="token operator">:</span> <span class="token string">'all'</span><span class="token punctuation">,</span> <span class="token comment">// 默认是async，意思是只分割异步代码</span>
			<span class="token comment">// 代码分割的下限</span>
			minSize<span class="token operator">:</span> <span class="token number">300000000</span><span class="token punctuation">,</span> <span class="token comment">// 300kb</span>
			maxSize<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
			minChunks<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 最小被依赖一次才进行分割</span>
			maxAsyncRequests<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
			maxInitialRequests<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
			automaticNameDelimiter<span class="token operator">:</span> <span class="token string">'~'</span><span class="token punctuation">,</span> <span class="token comment">// 自动名称连接符</span>
			name<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
			cacheGroups<span class="token operator">:</span> <span class="token punctuation">{</span>
				vendors<span class="token operator">:</span> <span class="token punctuation">{</span>
					test<span class="token operator">:</span> <span class="token regex">/[\\/]node_modules[\\/]/</span><span class="token punctuation">,</span>
					priority<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span>
					name<span class="token operator">:</span> <span class="token string">'vendors'</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
					minChunks<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
					priority<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span>
					reuseExistingChunk<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

</code></pre></div><p>在上面的配置项中，如果满足代码分割的要求，那么 webpack 会自动进入到 cacheGroups 这个配置项，找到对应的规则进行代码分割。</p> <p>比如<code>default.minChunks:2</code>这个配置，如果被依赖的次数小于 2，那么 webpack 是不会把代码打包的。</p> <blockquote><p><strong>异步代码</strong>（dynamic-import）</p></blockquote> <p>代码会自动分割</p> <p>只需要写代码时使用：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// dynamic imports</span>

<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&quot;./a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&quot;./b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>打包出来的代码会分割为独立的模块；</p> <h3 id="shimming-垫片"><a href="#shimming-垫片" class="header-anchor">#</a> shimming 垫片</h3> <p>因为 webpack 打包是基于模块的，模块与模块之间不会产生互相的影响。所以不同的包之间即使依赖相同的依赖包，也不能公用。</p> <p>这就导致一个问题：一些老的依赖 lib 里面，没有用到 es6 的 import 语法，比如很早以前的<code>jquery-ui</code>这种库，它的使用是需要全局依赖<code>jquery</code>插件的。那这种就没法在 webpack 里使用。</p> <h4 id="webpack-provideplugin"><a href="#webpack-provideplugin" class="header-anchor">#</a> webpack.ProvidePlugin</h4> <p>好在 webpack 提供了一个插件: <code>webpack.ProvidePlugin</code>，可以进行自动引入模块。</p> <blockquote><p>webpack.ProvidePlugin 使用介绍</p></blockquote> <div class="language-diff extra-class"><pre class="language-diff"><code><span class="token unchanged">  const path = require('path');
</span><span class="token inserted-sign inserted">+ const webpack = require('webpack');
</span>
<span class="token unchanged">  module.exports = {
    entry: './src/index.js',
    output: {
      filename: 'bundle.js',
      path: path.resolve(__dirname, 'dist')
</span><span class="token deleted-sign deleted">-   }
</span><span class="token inserted-sign inserted">+   },
+   plugins: [
+     new webpack.ProvidePlugin({
+       _: 'lodash'
+     })
+   ]
</span><span class="token unchanged">  };
</span></code></pre></div><p>上面配置的意思是：==如果你遇到了至少一处用到 <code>_</code> 变量的模块实例，那请你将 <code>lodash</code> package 引入进来，并将其提供给需要用到它的模块。==</p> <p>有了这个配置，在代码里就不需要引入<code>lodash</code>这个模块就能使用<code>lodash</code>的方法了。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 页面代码，不需要import _ from 'lodash';</span>
<span class="token keyword">function</span> <span class="token function">component</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  element<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;webpack&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> element<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>更细粒度的 shimming</p></blockquote> <p>有时候，我们在代码里使用到了 this 变量，期望 this 指向的是 window。但是 webpack 打包的代码里面，this 默认指向了当前模块。为了能将 this 改成 window，webpack 提供<code>imports-loader</code>进行处理。</p> <div class="language-diff extra-class"><pre class="language-diff"><code>module.exports = {
	module: {
		rules: [
			{
				test: /\.js$/,
				exclude: /node_modules/,
				use: [{
					loader: &quot;babel-loader&quot;,
					options: {
						presets: ['@babel/preset-env'],
						plugins: [
							[
								&quot;@babel/plugin-transform-runtime&quot;,
								{
									corejs: 2,
								}
							]
						]
					}
<span class="token inserted-sign inserted">+				}, {
+				  loader: 'imports-loader?this=&gt;window'
+				}]
</span>			},
		]
	},
}

</code></pre></div><blockquote><p>全局暴露变量</p></blockquote> <p>同样，假如我们写的代码里有用暴露一个全局变量，希望别人去使用这个变量。可以用<code>exports-loader</code>将全局变量导出。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// global.js</span>
<span class="token keyword">var</span> file <span class="token operator">=</span> <span class="token string">&quot;blah.txt&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> helpers <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">test</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;test something&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">parse</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;parse something&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// index.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> file<span class="token punctuation">,</span> parse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./global&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">component</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  element<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;webpack&quot;</span><span class="token punctuation">,</span> file<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> element<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-diff extra-class"><pre class="language-diff"><code>	module: {
		rules: [

<span class="token inserted-sign inserted">+			// {
+			// 	test: require.resolve('./src/shimming/index.js'),
+			// 	loader: 'imports-loader?this=&gt;window'
+			// },
+			{
+				test: require.resolve('./src/shimming/global.js'),
+				use: 'exports-loader?file,parse=helpers.parse'
+			}
+		]
</span>	},

}
</code></pre></div><h3 id="打包-library"><a href="#打包-library" class="header-anchor">#</a> 打包 library</h3> <blockquote><p>参考文档</p></blockquote> <p>https://webpack.docschina.org/guides/author-libraries</p> <blockquote><p>关键参数</p></blockquote> <h4 id="library-属性"><a href="#library-属性" class="header-anchor">#</a> library 属性</h4> <p><code>library</code> 的值的作用，取决于 <a href="#libraryTarget%E5%B1%9E%E6%80%A7">libraryTarget</a> 选项的值；</p> <blockquote><p>Example：配置多个 entry 入口</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// mode: &quot;development || &quot;production&quot;,</span>
  entry<span class="token operator">:</span> <span class="token punctuation">{</span>
    alpha<span class="token operator">:</span> <span class="token string">&quot;./alpha&quot;</span><span class="token punctuation">,</span>
    beta<span class="token operator">:</span> <span class="token string">&quot;./beta&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;dist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">&quot;MyLibrary.[name].js&quot;</span><span class="token punctuation">,</span>
    library<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;MyLibrary&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;[name]&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    libraryTarget<span class="token operator">:</span> <span class="token string">&quot;umd&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="librarytarget-属性"><a href="#librarytarget-属性" class="header-anchor">#</a> libraryTarget 属性</h4> <blockquote><p>配置作用</p></blockquote> <p><code>libraryTarget</code>用来配置暴露 library 变量的方式。</p> <blockquote><p>文档</p></blockquote> <p>https://webpack.docschina.org/configuration/output/#output-librarytarget</p> <blockquote><p>使用实例</p></blockquote> <p>举个例子，我写了一个 number.js 库，我需要支持 nodejs、umd、浏览器引用的使用方式。那么可以通过 libraryTarget 这个属性来配置。</p> <p>看一下 libraryTarget 支持哪些配置？</p> <ul><li>var(默认值)：作为一个全局变量，通过 <code>script</code> 标签来访问（<code>libraryTarget:'var'</code>）。</li> <li>this：通过 <code>this</code> 对象访问变量。this.library（<code>libraryTarget:'this'</code>）。</li> <li>window：在浏览器中通过 <code>window</code> 对象访问（<code>libraryTarget:'window'</code>）。</li> <li>global: 可以再 nodejs 里面通过<code>global</code>对象来访问；</li> <li>umd：在 AMD 或 CommonJS <code>require</code> 之后可访问（<code>libraryTarget:'umd'</code>）。</li></ul> <h4 id="引入第三方库"><a href="#引入第三方库" class="header-anchor">#</a> 引入第三方库</h4> <p>如果在我们编写的 library 里使用到了其他的第三方库，我们打包的时候不希望把这些第三方库打包进来；</p> <p>这样就可以用到<a href="#externals">externals</a>配置</p> <blockquote><p>总结</p></blockquote> <p>一般会把 libraryTarget 指明为<code>umd</code>，支持用 import、require 等方法来使用。但是不支持通过 script 标签来使用；</p> <p>然后把 library 指明通过 script 标签引入时，全局暴露的 library 名称。</p> <p>如果要用第三方依赖，</p> <h3 id="打包-typescript"><a href="#打包-typescript" class="header-anchor">#</a> 打包 typescript</h3> <h4 id="什么是typescript？"><a href="#什么是typescript？" class="header-anchor">#</a> 什么是<a href="./TypeScript">typescript</a>？</h4> <blockquote><p>webpack 配置依赖</p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">yarn</span> <span class="token function">add</span> --dev typescript ts-loader
</code></pre></div><blockquote><p>配置项</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;html-webpack-plugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> CleanWebpackPlugin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;clean-webpack-plugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token operator">:</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">,</span>
  entry<span class="token operator">:</span> <span class="token string">&quot;./src/typescript/index.ts&quot;</span><span class="token punctuation">,</span>
  devtool<span class="token operator">:</span> <span class="token string">&quot;inline-source-map&quot;</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    filename<span class="token operator">:</span> <span class="token string">&quot;bundle.js&quot;</span><span class="token punctuation">,</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;dist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex">/\.tsx?$/</span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token string">&quot;ts-loader&quot;</span><span class="token punctuation">,</span>
        exclude<span class="token operator">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  resolve<span class="token operator">:</span> <span class="token punctuation">{</span>
    extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;.tsx&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.ts&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.js&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">CleanWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      template<span class="token operator">:</span> <span class="token string">&quot;./src/index.html&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>ts 配置项</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;compilerOptions&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;outDir&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./dist/&quot;</span><span class="token punctuation">,</span>
+     <span class="token property">&quot;sourceMap&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token property">&quot;noImplicitAny&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token property">&quot;module&quot;</span><span class="token operator">:</span> <span class="token string">&quot;commonjs&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;target&quot;</span><span class="token operator">:</span> <span class="token string">&quot;es5&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;jsx&quot;</span><span class="token operator">:</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;allowJs&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>ts 代码</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> _ <span class="token keyword">from</span> <span class="token string">&quot;lodash&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Greet</span> <span class="token punctuation">{</span>
  msg<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter">msg<span class="token operator">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>msg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">greeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">join</span><span class="token punctuation">(</span>array<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>any</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">, separator: string) </span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> separator<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token plain-text">
}

const greet = new Greet(&quot;hello ts&quot;);

greet.greeting();

console.log(greet.join([&quot;a&quot;, &quot;b&quot;], &quot; &quot;));
</span></code></pre></div><h3 id="结合-eslint-配置"><a href="#结合-eslint-配置" class="header-anchor">#</a> 结合 eslint 配置</h3> <blockquote><p>配置依赖</p></blockquote> <p>首先安装 eslint 和 eslint-loader</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">yarn</span> <span class="token function">add</span> --dev eslint-loader eslint
</code></pre></div><blockquote><p>配置详情</p></blockquote> <p>eslint 的需要有一个单独的.eslintrc.js 配置文件</p> <p>这里第一步先创建好.eslintrc.js 配置文件，配置上 eslint 的规范。 可以使用<code>npx eslint --init</code>;</p> <p>然后去配置继承 airbnb 的规范.</p> <p>打开<a href="https://www.npmjs.com/package/eslint-config-airbnb-base" target="_blank" rel="noopener noreferrer">airbnb<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>插件地址，这里分 base 版本以及其他框架如 react 版本等等。</p> <p>根据需求安装好依赖后，在.eslintrc.js 里配置 extend 关系。</p> <p>依赖配置</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i eslint-config-airbnb-base --save-dev
npx install-peerdeps --dev eslint-config-airbnb-base
</code></pre></div><p>.eslintrc.js 配置</p> <p>参考 eslint 的<a href="">配置文档</a></p> <p>一般都会去参考<a href="https://www.npmjs.com/package/eslint-config-airbnb-base" target="_blank" rel="noopener noreferrer">airbnb<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的规范。</p> <div class="language-diff extra-class"><pre class="language-diff"><code>module.exports = {
	'env': {
		'browser': true,
		'es6': true
	},
<span class="token inserted-sign inserted">+	'extends': ['airbnb-base'],
</span>	'globals': {
	},
<span class="token inserted-sign inserted">+  'parser': 'babel-eslint',
</span>	'parserOptions': {
		'ecmaVersion': 2018,
		'sourceType': 'module'
	},
	'rules': {
		'indent': [
			'error',
			'tab'
		],
		'linebreak-style': [
			'error',
			'unix'
		],
		'quotes': [
			'error',
			'single'
		],
		'semi': [
			'error',
			'always'
		]
	}
};
</code></pre></div><p>webpack.config.js</p> <div class="language-diff extra-class"><pre class="language-diff"><code>module.exports = {
<span class="token unchanged">  // ...
  devServer: {
</span><span class="token inserted-sign inserted">+    overlay: true,
</span><span class="token unchanged">  },
  module: {
    rules: [
</span><span class="token inserted-sign inserted">+      {
+        test: /\.js$/,
+        exclude: /node_modules/,
+        loader: &quot;eslint-loader&quot;,
+			 }
</span><span class="token unchanged">    ]
  }
  // ...
</span>};
</code></pre></div><p>配置好之后，webpack 会在打包的时候自动进行 es-lint 的规则校验。</p> <blockquote><p>总结</p></blockquote> <p>eslint 的配置其实很简单，只需要安装好 eslint，eslint-loader，配置好对应的规则即可。</p> <p>但是在正常项目开发过程中，如果在 webpack 里配置 eslint，那么会降低打包速度（每次重新编译都要走一次 eslint 规则校验）</p> <p>所以一般不会用 webpack 进行配置，而是会在 git hook 上进行配置，在代码提交时对代码规范进行判断。</p> <p>// todo 配置 git hook</p> <h2 id="二、案例"><a href="#二、案例" class="header-anchor">#</a> 二、案例</h2> <h3 id="项目配置优化"><a href="#项目配置优化" class="header-anchor">#</a> 项目配置优化</h3> <h4 id="打包分析"><a href="#打包分析" class="header-anchor">#</a> 打包分析</h4> <p>如果我们以分离代码作为开始，那么就应该以检查模块的输出结果作为结束，对其进行分析是很有用处的。<a href="https://github.com/webpack/analyse" target="_blank" rel="noopener noreferrer">官方提供分析工具<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是一个好的初始选择。下面是一些可选择的社区支持(community-supported)工具：</p> <ul><li><p><a href="https://alexkuz.github.io/webpack-chart/" target="_blank" rel="noopener noreferrer">webpack-chart<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：webpack stats 可交互饼图。</p></li> <li><p><a href="https://chrisbateman.github.io/webpack-visualizer/" target="_blank" rel="noopener noreferrer">webpack-visualizer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：可视化并分析你的 bundle，检查哪些模块占用空间，哪些可能是重复使用的。</p></li> <li><p><a href="https://github.com/webpack-contrib/webpack-bundle-analyzer" target="_blank" rel="noopener noreferrer">webpack-bundle-analyzer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：一个 plugin 和 CLI 工具，它将 bundle 内容展示为便捷的、交互式、可缩放的树状图形式。(推荐)</p></li> <li><p><a href="https://webpack.jakoblind.no/optimize" target="_blank" rel="noopener noreferrer">webpack bundle optimize helper<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：此工具会分析你的 bundle，并为你提供可操作的改进措施建议，以减少 bundle 体积大小。</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-02-07-041248.png" alt="image-20200207121247825"></p></li></ul> <h4 id="打包优化点"><a href="#打包优化点" class="header-anchor">#</a> 打包优化点</h4> <ul><li><p>尽量使用最新的 node、npm、yarn</p></li> <li><p>loader 里面合理应用 include 和 exclude</p></li> <li><p>尽量减少使用 plugin，推荐使用官方的 plugin</p></li> <li><p>控制打包的大小</p> <ul><li><p>使用<a href="#DDLPlugin">ddl</a>来抽离出不经常变化的代码。</p></li> <li><p>通过<a href="#treeshaking">treeshaking</a>来去除没被使用的代码。</p></li> <li><p>通过 splitChunks 来动态引入代码，打包拆分为小的代码，加快打包速度。</p></li></ul></li></ul> <ul><li>开启多进程打包： thread-loader, parallel-webpack, happypack</li> <li>合理使用<a href="#devtool">sourcemap</a></li> <li>结合<a href="#%E6%89%93%E5%8C%85%E5%88%86%E6%9E%90">打包分析</a>工具</li></ul> <h3 id="优化打包"><a href="#优化打包" class="header-anchor">#</a> 优化打包</h3> <p>一开始打包完，显示如下信息</p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-04-14-023543.png" alt="image-20200414103539301"></p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-04-14-032200.png" alt="image-20200414112159488"></p> <p>问题主要是 2 块：</p> <p>app.css 太大</p> <p>bundle.js 太大</p> <h4 id="优化步骤："><a href="#优化步骤：" class="header-anchor">#</a> 优化步骤：</h4> <p><strong>1.先解决 js 的问题。</strong></p> <p>首先，想到的是将公共的模块抽离出来。所以我手动加了一个 entry。</p> <div class="language-diff extra-class"><pre class="language-diff"><code>entry: {
		app: './src/main.js',
<span class="token inserted-sign inserted">+		common: './src/common.js'
</span>},
</code></pre></div><p>并且在 common 里加入了公共的模块</p> <div class="language- extra-class"><pre class="language-text"><code>import $ from 'zepto';
import html2canvas from 'html2canvas';
import TWEEN from '@tweenjs/tween.js';
import QRCode from 'qrcode';
</code></pre></div><p>但是这个手动加入的 entry 和 app 会重复，所以需要将重复的剥离出来，于是，再配置一下 optimization</p> <div class="language-diff extra-class"><pre class="language-diff"><code>optimization: {
<span class="token inserted-sign inserted">+		splitChunks: {
+			chunks: 'all',
+		},
</span>		minimizer: [new UglifyJsPlugin(), new OptimizeCssAssetsWebpackPlugin({})],
},
</code></pre></div><p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-04-14-031756.png" alt="image-20200414111755986"></p> <p>上面的虽然能够将公共的抽离出来，但是多加载了一个 common.js。没有什么必要</p> <p><strong>2.通过 dll 来解决 bundle 太大的问题。</strong></p> <p><strong>配置前：</strong></p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-04-20-090738.png" alt="image-20200420170738351"></p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-04-20-090142.png" alt="image-20200420170142007"></p> <p><strong>配置后：</strong></p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-04-20-091314.png" alt="image-20200420171313445"></p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-04-20-091247.png" alt="image-20200420171247295"></p> <p>很奇怪，vendors 和 app 并没有减小。原因是因为 context 配置的问题</p> <blockquote><p>修正后的效果：</p></blockquote> <p>配置前</p> <div class="language- extra-class"><pre class="language-text"><code>Hash: ec7cc07aa4de537ede18
Version: webpack 4.42.1
Time: 2940ms
Built at: 04/20/2020 6:35:00 PM

</code></pre></div><p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-04-20-232245.png" alt="image-20200420183537776"></p> <p>配置后</p> <div class="language- extra-class"><pre class="language-text"><code>Hash: 6433381ed503ccc7b79b
Version: webpack 4.42.1
Time: 2044ms
Built at: 04/20/2020 6:36:48 PM
</code></pre></div><p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-04-20-232244.png" alt="image-20200420183444555"></p> <h3 id="webpack-转化未模块化的-js-库"><a href="#webpack-转化未模块化的-js-库" class="header-anchor">#</a> webpack 转化未模块化的 js 库</h3> <h4 id="项目需求"><a href="#项目需求" class="header-anchor">#</a> 项目需求</h4> <p>依赖 zepto，但是 zepto 不支持模块化</p> <p>如果不是自己修改过的代码，可以直接在 webpack 里加 externals，然后再 index.html 里引入 script.</p> <div class="language- extra-class"><pre class="language-text"><code>externals: {
	'webpack-zepto': '$'
},
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>anonymous<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>https://xxx.cdn/zepto.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">&quot;webpack-zepto&quot;</span><span class="token punctuation">;</span> <span class="token comment">// scripts标签提供了$变量，所以这行使用ok。</span>
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>


如果是修改过的zepto代码，尤其是模块做过修改的。就没办法用上面的了，因为webpack-zepto返回的`$`对象没有对应的功能，开发过程会出错。

需要用`script-loader exports-loader`

#### **zepto.js 自定义模块打包步骤如下：**

1、从 github 上 down 一份下来（https://github.com/madrobby/zepto）

2、安装 nodejs 环境以及 npm 包管理器

3、运行，编辑目录下的 make 文件，找到 **modules = (env['MODULES'] || 'zepto event ajax form ie').split(' ')** 这一行。我标红的部分就是要引入打包的模块名，以空格符隔开，在当中加入你需要用到的模块名，然后保存。（当然，也可以减少模块，核心模块 zepto 别删掉就行了）

4、回到命令行，输入 npm install 回车安装构建 zepto.js 所需的 node 模块。安装好后，再输入 npm run-script dist 命令，然后回车，开始打包构建。

5、如果没有报错的话，就ok了。可以看到 zepto 目录下 多出一个 dist 目录，里面可以看到生成的三个文件：原始文件 zepto.js，压缩后的 zepto.min.js，gzip 后的 zepto.min.gz。生产环境使用 zepto.min.js 就行了。

这样zepto.js自定义模块打包就完成了



#### 安装依赖

#### webpack配置

​```js
resolve: {
  alias: {
      'zepto': path.resolve(__dirname, './src/js/lib/zepto.min.js')
  }
}
rules: [{
	test: require.resolve('zepto'),
	loader: 'exports-loader?window.Zepto!script-loader'
}],
...
plugins: [
	new webpack.ProvidePlugin({
			$: 'zepto',
			Zepto: 'zepto',
		}),
]
</code></pre></div><p>webpack.ProvidePlugin 的配置是说：如果项目里用到了<code>$</code>或者<code>Zepto</code>，那么 webpack 会自动去引入 zepto，不用我去手动引入。</p> <p>rules 的配置是说：当我引入<code>zepto</code>的时候，会把对象暴露给 window.Zepto。</p> <p>script-loader 把我们指定的模块 JS 文件转成纯字符串，exports-loader 将需要的 js 对象 module.exports 导出，以支持 import 或 require 导入</p> <p>它两结合，可以处理一个 <em>&quot;可以 npm 安装，但又不符合 webpack 模块化规范&quot;</em> 的库“，处理后可以直接 import xx from XX 后使用。</p> <p>resolve 里的 alias 将自己本地的代码，配置了一个别名，这样就可以通过 zepto 找到本地的 js 文件。</p> <h3 id="项目支持-hmr"><a href="#项目支持-hmr" class="header-anchor">#</a> 项目支持 HMR</h3> <div class="language-diff extra-class"><pre class="language-diff"><code>'use strict'
const utils = require('./utils')
const webpack = require('webpack')
const config = require('../config')
const merge = require('webpack-merge')
const path = require('path')
const baseWebpackConfig = require('./webpack.base.conf')
const CopyWebpackPlugin = require('copy-webpack-plugin')
const HtmlWebpackPlugin = require('html-webpack-plugin')
const FriendlyErrorsPlugin = require('friendly-errors-webpack-plugin')
const apiMocker = require('webpack-api-mocker')
const portfinder = require('portfinder')

const HOST = process.env.HOST
const PORT = process.env.PORT &amp;&amp; Number(process.env.PORT)

const devWebpackConfig = merge(baseWebpackConfig, {
<span class="token unchanged">  module: {
    rules: utils.styleLoaders({ sourceMap: config.dev.cssSourceMap, usePostCSS: true })
  },
  // cheap-module-eval-source-map is faster for development
  devtool: config.dev.devtool,
</span>
<span class="token unchanged">  // these devServer options should be customized in /config/index.js.bak
  devServer: {
    before(app) {
      apiMocker(app, path.resolve('./mock/index.js'), {
        changeHost: true,
      })
    },
    clientLogLevel: 'warning',
    historyApiFallback: {
      rewrites: [
        { from: /.*/, to: path.posix.join(config.dev.assetsPublicPath, 'index.html') },
      ],
    },
</span><span class="token inserted-sign inserted">+    hot: true,
</span><span class="token unchanged">    disableHostCheck: true,
    contentBase: false, // since we use CopyWebpackPlugin.
    compress: true,
    host: HOST || config.dev.host,
    port: PORT || config.dev.port,
    open: config.dev.autoOpenBrowser,
    overlay: config.dev.errorOverlay
      ? { warnings: false, errors: true }
      : false,
    publicPath: config.dev.assetsPublicPath,
    proxy: config.dev.proxyTable,
    quiet: true, // necessary for FriendlyErrorsPlugin
    watchOptions: {
      poll: config.dev.poll,
    }
  },
  plugins: [
    new webpack.DefinePlugin({
      'process.env': require('../config/dev.env')
    }),
</span><span class="token inserted-sign inserted">+    new webpack.HotModuleReplacementPlugin(),
</span><span class="token unchanged">    new webpack.NamedModulesPlugin(), // HMR shows correct file names in console on update.
    new webpack.NoEmitOnErrorsPlugin(),
    // https://github.com/ampedandwired/html-webpack-plugin
    new HtmlWebpackPlugin({
      filename: 'index.html',
      template: 'index.html',
      inject: true
    }),
    // copy custom static assets
    new CopyWebpackPlugin([
      {
        from: path.resolve(__dirname, '../static'),
        to: config.dev.assetsSubDirectory,
        ignore: ['.*']
      }
    ])
  ]
</span>})

module.exports = new Promise((resolve, reject) =&gt; {
<span class="token unchanged">  portfinder.basePort = process.env.PORT || config.dev.port
  portfinder.getPort((err, port) =&gt; {
    if (err) {
      reject(err)
    } else {
      // publish the new Port, necessary for e2e tests
      process.env.PORT = port
      // add port to devServer config
      devWebpackConfig.devServer.port = port
</span>
<span class="token unchanged">      // Add FriendlyErrorsPlugin
      devWebpackConfig.plugins.push(new FriendlyErrorsPlugin({
        compilationSuccessInfo: {
          messages: [`Your application is running here: http://${devWebpackConfig.devServer.host}:${port}`],
        },
        onErrors: config.dev.notifyOnErrors
        ? utils.createNotifierCallback()
        : undefined
      }))
</span>
<span class="token unchanged">      resolve(devWebpackConfig)
    }
  })
</span>})

</code></pre></div><h3 id="webpackhtmlplugin-打包多页面"><a href="#webpackhtmlplugin-打包多页面" class="header-anchor">#</a> WebpackHtmlPlugin 打包多页面</h3> <h3 id="create-react-app-支持-hmr"><a href="#create-react-app-支持-hmr" class="header-anchor">#</a> create-react-app 支持 HMR</h3> <p>之前项目里发现一个情况，create-reacta-app eject 后创建的项目，虽然是支持 hmr 的，但是只有 css 是支持 HMR 的，每次修改 js 代码依然需要刷新页面才能生效。</p> <p>那如何去支持 js 也支持 hmr 呢？</p> <p>通过 react-hot-loader</p> <p>https://github.com/gaearon/react-hot-loader</p> <ol><li>Install React Hot Loader (<code>npm install --save-dev react-hot-loader</code>)</li> <li>在<code>config/webpack.config.dev.js</code>里添加 <code>'react-hot-loader/babel'</code> plugin . The loader should now look like:</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token punctuation">{</span>
    test<span class="token operator">:</span> <span class="token regex">/\.(js|jsx)$/</span><span class="token punctuation">,</span>
    include<span class="token operator">:</span> paths<span class="token punctuation">.</span>appSrc<span class="token punctuation">,</span>
    loader<span class="token operator">:</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'babel-loader'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    options<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// This is a feature of `babel-loader` for webpack (not Babel itself).</span>
      <span class="token comment">// It enables caching results in ./node_modules/.cache/babel-loader/</span>
      <span class="token comment">// directory for faster rebuilds.</span>
      cacheDirectory<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'react-hot-loader/babel'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>Mark your App (<code>src/App.js</code>) as <em>hot-exported</em>:</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ./containers/App.js</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> hot <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-hot-loader&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Hello World<span class="token operator">!</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">hot</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="懒加载-lazyloading-preloading-prefetching"><a href="#懒加载-lazyloading-preloading-prefetching" class="header-anchor">#</a> 懒加载 lazyLoading + preloading + prefetching</h3> <blockquote><p>思想</p></blockquote> <p>在做前端代码优化时，把核心放到如何增加 code coverage 上来思考。</p> <p>要通过异步加载或者懒加载去减少页面首页的加载时间</p> <p>如果担心懒加载影响体验，可以使用 preload 或 prefetching 来在页面空闲时提前加载代码。</p> <blockquote><p>实践</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* index.js */</span>
<span class="token keyword">import</span> _ <span class="token keyword">from</span> <span class="token string">&quot;lodash&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  element<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;webpack&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;button&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  button<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">&quot;Click me and look at the console!&quot;</span><span class="token punctuation">;</span>
  button<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">import</span><span class="token punctuation">(</span>
      <span class="token comment">/* webpackPrefetch: true */</span> <span class="token comment">/* webpackChunkName: 'print' */</span> <span class="token string">&quot;./print&quot;</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> print <span class="token operator">=</span> module<span class="token punctuation">.</span>default<span class="token punctuation">;</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  element<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> element<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>prefetch 效果</p></blockquote> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-01-30-020349.png" alt="image-20200130100349008"></p> <blockquote><p>preload 效果</p></blockquote> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-01-30-025412.png" alt="image-20200130105412163"></p> <div class="language-js extra-class"><pre class="language-js"><code>button<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">import</span><span class="token punctuation">(</span>
    <span class="token comment">/* webpackPrefetch: false, webpackPreload: true, webpackChunkName: 'print' */</span> <span class="token string">&quot;./print&quot;</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> print <span class="token operator">=</span> module<span class="token punctuation">.</span>default<span class="token punctuation">;</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>仅仅在引入时配置这个无效，我是手动在 index.html 里加了<code>&lt;link rel=&quot;preload&quot; as=&quot;script&quot; href=&quot;/print.js&quot;&gt;</code> . 先看了看效果，原因还没查出来；</p> <blockquote><p>疑问</p></blockquote> <p><strong>Q:为什么 prefetch 会在浏览器空闲的时候去下载 js，但是实际上这个 js 没有被使用上去，等到实际业务逻辑用到时又去下载了一次 js？</strong></p> <p><img src="https://ipic-coda.oss-cn-beijing.aliyuncs.com/2020-01-30-020816.png" alt="image-20200130100815935"></p> <p>参考答案：prefetch 预取是在浏览器空闲时预先去请求模块，放到缓存里，等到真正要用时，预期的 chunk 已经在 http 的缓存中，浏览器就可以话费最小的时间从最近的缓存区获取数据。</p> <p><strong>Q:可以不可以对每一个模块都预取？</strong></p> <p>参考答案：会浪费了很多带宽。 有选择地将它用于很可能被访问的 import()也更有益。 不要浪费带宽。</p> <p><strong>Q: prefetch 和 preload 有啥区别？</strong></p> <p>参考答案：preload 的使用场景不多。他的意思是，这些资源在本页面里面必须要有，只是在之后才被用到，浏览器先去给他一起下载下来，省的后面要一次性下载一堆文件。</p> <p>prefetch 的意思是，这些资源在未来某一个页面会被用到。浏览器通常会在空闲状态取得这些资源，在取得资源之后搁在 HTTP 缓存以便于实现将来的请求。</p> <p>prefetch 会占用额外的带宽，因为 prefetch 去下载的资源未来可能根本不会去使用。</p> <p>Preload 用于更早地发现资源，并避免发起类似瀑布一样的请求。</p> <h3 id="create-react-app-配置分析"><a href="#create-react-app-配置分析" class="header-anchor">#</a> create-react-app 配置分析</h3> <p>首先用<code>create-react-app</code>脚手架创建好工程，然后执行脚本<code>npm run eject</code>将 webpack 等相关的配置显示出来。</p> <p>当前版本对应如下</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;@babel/core&quot;</span><span class="token operator">:</span> <span class="token string">&quot;7.8.4&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;@svgr/webpack&quot;</span><span class="token operator">:</span> <span class="token string">&quot;4.3.3&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;@testing-library/jest-dom&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.2.4&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;@testing-library/react&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^9.3.2&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;@testing-library/user-event&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^7.1.2&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;@typescript-eslint/eslint-plugin&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.10.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;@typescript-eslint/parser&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.10.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;babel-eslint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10.0.3&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;babel-jest&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^24.9.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;babel-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;8.0.6&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;babel-plugin-named-asset-import&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.3.6&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;babel-preset-react-app&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^9.1.1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;camelcase&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.3.1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;case-sensitive-paths-webpack-plugin&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2.3.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;css-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3.4.2&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dotenv&quot;</span><span class="token operator">:</span> <span class="token string">&quot;8.2.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dotenv-expand&quot;</span><span class="token operator">:</span> <span class="token string">&quot;5.1.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;eslint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.6.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;eslint-config-react-app&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.2.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;eslint-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3.0.3&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;eslint-plugin-flowtype&quot;</span><span class="token operator">:</span> <span class="token string">&quot;4.6.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;eslint-plugin-import&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2.20.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;eslint-plugin-jsx-a11y&quot;</span><span class="token operator">:</span> <span class="token string">&quot;6.2.3&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;eslint-plugin-react&quot;</span><span class="token operator">:</span> <span class="token string">&quot;7.18.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;eslint-plugin-react-hooks&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.6.1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;file-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;4.3.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;fs-extra&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^8.1.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;html-webpack-plugin&quot;</span><span class="token operator">:</span> <span class="token string">&quot;4.0.0-beta.11&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;identity-obj-proxy&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;jest&quot;</span><span class="token operator">:</span> <span class="token string">&quot;24.9.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;jest-environment-jsdom-fourteen&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;jest-resolve&quot;</span><span class="token operator">:</span> <span class="token string">&quot;24.9.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;jest-watch-typeahead&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.4.2&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;mini-css-extract-plugin&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.9.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;optimize-css-assets-webpack-plugin&quot;</span><span class="token operator">:</span> <span class="token string">&quot;5.0.3&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;pnp-webpack-plugin&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.6.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;postcss-flexbugs-fixes&quot;</span><span class="token operator">:</span> <span class="token string">&quot;4.1.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;postcss-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;postcss-normalize&quot;</span><span class="token operator">:</span> <span class="token string">&quot;8.0.1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;postcss-preset-env&quot;</span><span class="token operator">:</span> <span class="token string">&quot;6.7.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;postcss-safe-parser&quot;</span><span class="token operator">:</span> <span class="token string">&quot;4.0.1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;react&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^16.12.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;react-app-polyfill&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.0.6&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;react-dev-utils&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^10.2.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;react-dom&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^16.12.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;resolve&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.15.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;resolve-url-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3.1.1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;sass-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;8.0.2&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;semver&quot;</span><span class="token operator">:</span> <span class="token string">&quot;6.3.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;style-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.23.1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;terser-webpack-plugin&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2.3.4&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;ts-pnp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.1.5&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;url-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2.3.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;webpack&quot;</span><span class="token operator">:</span> <span class="token string">&quot;4.41.5&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;webpack-dev-server&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3.10.2&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;webpack-manifest-plugin&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2.2.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;workbox-webpack-plugin&quot;</span><span class="token operator">:</span> <span class="token string">&quot;4.3.1&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>先看一下 scripts/build.js 用来进行生产环境打包脚本</p> <p>核心的 webpack 配置存在 webpack.config.js</p> <h3 id="vue-cl-配置分析"><a href="#vue-cl-配置分析" class="header-anchor">#</a> vue-cl 配置分析</h3> <p>vue-cli 是官方提供的脚手架工具。~2.0 版本会自动创建 webpack 的很多配置项。 ~3.0 版本做了很大改动，封装了所有的 webpack 配置项，开发如果需要更改配置，需在项目里创建一个 vue.config.js 文件，根据文档进行配置。</p> <h4 id="vue-cli-2-0-loader-部分"><a href="#vue-cli-2-0-loader-部分" class="header-anchor">#</a> vue-cli@2.0 loader 部分</h4> <blockquote><p>css-loader</p></blockquote> <p>vue-cli2 创建的 webpack 配置里，自动创建了很多处理样式的 loader，这里截取下来学习下。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// vue-loader.config.js的css-loader</span>
<span class="token punctuation">{</span>
  css<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;vue-style-loader&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      loader<span class="token operator">:</span> <span class="token string">&quot;css-loader&quot;</span><span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
        sourceMap<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      loader<span class="token operator">:</span> <span class="token string">&quot;postcss-loader&quot;</span><span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
        sourceMap<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  less<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;vue-style-loader&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      loader<span class="token operator">:</span> <span class="token string">&quot;css-loader&quot;</span><span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
        sourceMap<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      loader<span class="token operator">:</span> <span class="token string">&quot;postcss-loader&quot;</span><span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
        sourceMap<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      loader<span class="token operator">:</span> <span class="token string">&quot;less-loader&quot;</span><span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
        sourceMap<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  sass<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;vue-style-loader&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      loader<span class="token operator">:</span> <span class="token string">&quot;css-loader&quot;</span><span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
        sourceMap<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      loader<span class="token operator">:</span> <span class="token string">&quot;postcss-loader&quot;</span><span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
        sourceMap<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      loader<span class="token operator">:</span> <span class="token string">&quot;sass-loader&quot;</span><span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
        indentedSyntax<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        sourceMap<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  scss<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;vue-style-loader&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      loader<span class="token operator">:</span> <span class="token string">&quot;css-loader&quot;</span><span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
        sourceMap<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      loader<span class="token operator">:</span> <span class="token string">&quot;postcss-loader&quot;</span><span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
        sourceMap<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      loader<span class="token operator">:</span> <span class="token string">&quot;sass-loader&quot;</span><span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
        sourceMap<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  styl<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;vue-style-loader&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      loader<span class="token operator">:</span> <span class="token string">&quot;css-loader&quot;</span><span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
        sourceMap<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      loader<span class="token operator">:</span> <span class="token string">&quot;postcss-loader&quot;</span><span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
        sourceMap<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      loader<span class="token operator">:</span> <span class="token string">&quot;stylus-loader&quot;</span><span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
        sourceMap<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看出来，基本上 loader 的配置顺序为 <code>vue-style-loader</code> -&gt; <code>css-loader</code> -&gt; <code>postcss-loader</code> -&gt; <code>各自预处理框架的loader</code>；</p> <p>除了.vue 里写样式之外，一些单独存放的样式文件的处理 loader 也配置如下。因为基本重复，这里就不贴所有的配置项了。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//生成结果</span>
<span class="token punctuation">[</span>
  <span class="token operator">...</span>
  <span class="token punctuation">{</span>
    test<span class="token operator">:</span> <span class="token regex">/\.sass$/</span>
    use<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;vue-style-loader&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        loader<span class="token operator">:</span> <span class="token string">&quot;css-loader&quot;</span><span class="token punctuation">,</span>
        options<span class="token operator">:</span> <span class="token punctuation">{</span>
          sourceMap<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        loader<span class="token operator">:</span> <span class="token string">&quot;postcss-loader&quot;</span><span class="token punctuation">,</span>
        options<span class="token operator">:</span> <span class="token punctuation">{</span>
          sourceMap<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        loader<span class="token operator">:</span> <span class="token string">&quot;sass-loader&quot;</span><span class="token punctuation">,</span>
        options<span class="token operator">:</span> <span class="token punctuation">{</span>
          indentedSyntax<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          sourceMap<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><h4 id="vue-cli-3-0-配置"><a href="#vue-cli-3-0-配置" class="header-anchor">#</a> vue-cli@3.0 配置</h4> <blockquote><p>官方文档
https://cli.vuejs.org/zh/config/#baseurl</p></blockquote> <h2 id="三、原理分析"><a href="#三、原理分析" class="header-anchor">#</a> 三、原理分析</h2> <h3 id="实现一个简单的-webpack"><a href="#实现一个简单的-webpack" class="header-anchor">#</a> 实现一个简单的 webpack</h3> <blockquote><p>https://juejin.im/post/5de099886fb9a071562facad#heading-5</p> <p>本例自己实现了简单的 webpack，对 es6 的代码进行编译和分析，将依赖文件打包在一起，生成可执行的代码。</p></blockquote> <p>关键代码讲解</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">generateCode</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">entry</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> graph <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token function">makeDependenciesGraph</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 我们来构造exports和require函数，这两个函数在浏览器里面是不存在的</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    (function(graph){
      // require方法第二次传入的是'./message.js', 需要转化为'./src/message.js', 否则无法找到
     function require(module) {
        const exports = {};
        function innerRequire(relativePath) {
          // 将代码里写的相对路径转化为绝对路径后，调用外部真正的require方法
          const absolutePath = graph[module].dependencies[relativePath];
          return require(absolutePath);
        }
        // 写闭包避免变量互相影响, 传入innerRequire作为require，这样内部调用的require方法便是innerRequire
       (function(exports, require, code) {
        eval(code)
       })(exports, innerRequire, graph[module].code)
       return exports;
     }
     require('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>entry<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">')
    })(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>graph<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>生成的 code 为：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">graph</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// require方法第二次传入的是'./message.js', 需要转化为'./src/message.js', 否则无法找到</span>
  <span class="token keyword">function</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">innerRequire</span><span class="token punctuation">(</span><span class="token parameter">relativePath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 将代码里写的相对路径转化为绝对路径后，调用外部真正的require方法</span>
      <span class="token keyword">const</span> absolutePath <span class="token operator">=</span> graph<span class="token punctuation">[</span>module<span class="token punctuation">]</span><span class="token punctuation">.</span>dependencies<span class="token punctuation">[</span>relativePath<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span>absolutePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 写闭包避免变量互相影响, 传入innerRequire作为require，这样内部调用的require方法便是innerRequire</span>
    <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">eval</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> innerRequire<span class="token punctuation">,</span> graph<span class="token punctuation">[</span>module<span class="token punctuation">]</span><span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> exports<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">&quot;./src/index.js&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    dependencies<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;./message.js&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./src/message.js&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    code<span class="token operator">:</span>
      <span class="token string">'&quot;use strict&quot;;\n\nvar _message = _interopRequireDefault(require(&quot;./message.js&quot;));\n\nfunction _interopRequireDefault(obj) { return obj &amp;&amp; obj.__esModule ? obj : { &quot;default&quot;: obj }; }\n\nconsole.log(_message[&quot;default&quot;]);'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;./src/message.js&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    dependencies<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    code<span class="token operator">:</span>
      <span class="token string">'&quot;use strict&quot;;\n\nObject.defineProperty(exports, &quot;__esModule&quot;, {\n  value: true\n});\nexports[&quot;default&quot;] = void 0;\nvar message = &quot;Mock Webpack&quot;;\nvar _default = message;\nexports[&quot;default&quot;] = _default;'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.037033ca.js" defer></script><script src="/assets/js/2.c5c14eb8.js" defer></script><script src="/assets/js/39.a74c60d6.js" defer></script>
  </body>
</html>
